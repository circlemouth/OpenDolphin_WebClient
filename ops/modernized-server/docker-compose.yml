services:
  db:
    extends:
      file: ../base/docker-compose.yml
      service: db

  server-modernized:
    build:
      context: ../..
      dockerfile: ./docker/Dockerfile
    container_name: opendolphin-server-modernized
    depends_on:
      db:
        condition: service_healthy
    environment:
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: ${POSTGRES_DB:-opendolphin}
      DB_USER: ${POSTGRES_USER:-opendolphin}
      DB_PASSWORD: ${POSTGRES_PASSWORD:-opendolphin}
      DB_SSLMODE: ${DB_SSLMODE:-prefer}
      DB_SSLROOTCERT: ${DB_SSLROOTCERT:-}
      PLIVO_AUTH_ID: ${PLIVO_AUTH_ID:-}
      PLIVO_AUTH_TOKEN: ${PLIVO_AUTH_TOKEN:-}
      PLIVO_SOURCE_NUMBER: ${PLIVO_SOURCE_NUMBER:-}
      PLIVO_BASE_URL: ${PLIVO_BASE_URL:-https://api.plivo.com/v1/}
      PLIVO_ENVIRONMENT: ${PLIVO_ENVIRONMENT:-production}
      PLIVO_LOG_LEVEL: ${PLIVO_LOG_LEVEL:-NONE}
      PLIVO_LOG_MESSAGE_CONTENT: ${PLIVO_LOG_MESSAGE_CONTENT:-false}
      PLIVO_DEFAULT_COUNTRY: ${PLIVO_DEFAULT_COUNTRY:-+81}
      TZ: Asia/Tokyo
    ports:
      - "${APP_HTTP_PORT:-8080}:8080"
      - "${APP_ADMIN_PORT:-9990}:9990"
    healthcheck:
      test:
        - CMD-SHELL
        - >-
          curl -sf -H "userName: ${SYSAD_USER_NAME:-1.3.6.1.4.1.9414.10.1:dolphin}" -H "password: ${SYSAD_PASSWORD:-36cdf8b887a5cffc78dcd5c08991b993}" http://localhost:8080/openDolphin/resources/dolphin || exit 1
      interval: 30s
      timeout: 10s
      retries: 5
