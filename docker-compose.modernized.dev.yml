services:
  db-modernized:
    image: postgres:14
    container_name: opendolphin-postgres-modernized
    environment:
      POSTGRES_DB: ${MODERNIZED_POSTGRES_DB:-opendolphin_modern}
      POSTGRES_USER: ${MODERNIZED_POSTGRES_USER:-opendolphin}
      POSTGRES_PASSWORD: ${MODERNIZED_POSTGRES_PASSWORD:-opendolphin}
      POSTGRES_HOST_AUTH_METHOD: ${MODERNIZED_POSTGRES_HOST_AUTH_METHOD:-md5}
      POSTGRES_INITDB_ARGS: ${MODERNIZED_POSTGRES_INITDB_ARGS:---auth-host=md5 --auth-local=trust}
      TZ: Asia/Tokyo
    ports:
      - "${MODERNIZED_POSTGRES_PORT:-55432}:5432"
    volumes:
      - postgres-data-modernized:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER"]
      interval: 10s
      timeout: 5s
      retries: 5

  server-modernized-dev:
    build:
      context: .
      dockerfile: ops/modernized-server/docker/Dockerfile
    container_name: opendolphin-server-modernized-dev
    depends_on:
      db-modernized:
        condition: service_healthy
      minio:
        condition: service_started
    environment:
      DB_HOST: ${MODERNIZED_DB_HOST:-db-modernized}
      DB_PORT: ${MODERNIZED_DB_PORT:-5432}
      DB_NAME: ${MODERNIZED_POSTGRES_DB:-opendolphin_modern}
      DB_USER: ${MODERNIZED_POSTGRES_USER:-opendolphin}
      DB_PASSWORD: ${MODERNIZED_POSTGRES_PASSWORD:-opendolphin}
      # ↑ 開発向けの代替値。本番で未上書きの場合、DB 接続が拒否され起動失敗となるため必ず Secrets から供給する。
      DB_SSLMODE: ${MODERNIZED_DB_SSLMODE:-prefer}
      DB_SSLROOTCERT: ${MODERNIZED_DB_SSLROOTCERT:-}
      PLIVO_AUTH_ID: ${PLIVO_AUTH_ID:-}
      PLIVO_AUTH_TOKEN: ${PLIVO_AUTH_TOKEN:-}
      PLIVO_SOURCE_NUMBER: ${PLIVO_SOURCE_NUMBER:-}
      PLIVO_BASE_URL: ${PLIVO_BASE_URL:-https://api.plivo.com/v1/}
      PLIVO_ENVIRONMENT: ${PLIVO_ENVIRONMENT:-production}
      PLIVO_LOG_LEVEL: ${PLIVO_LOG_LEVEL:-NONE}
      PLIVO_LOG_MESSAGE_CONTENT: ${PLIVO_LOG_MESSAGE_CONTENT:-false}
      PLIVO_DEFAULT_COUNTRY: ${PLIVO_DEFAULT_COUNTRY:-+81}
      LOGFILTER_HEADER_AUTH_ENABLED: ${LOGFILTER_HEADER_AUTH_ENABLED:-true}
      OPENDOLPHIN_SCHEMA_ACTION: ${OPENDOLPHIN_SCHEMA_ACTION:-none}
      MODERNIZED_STORAGE_MODE: ${MODERNIZED_STORAGE_MODE:-database}
      ATTACHMENT_STORAGE_CONFIG_PATH: ${ATTACHMENT_STORAGE_CONFIG_PATH:-/opt/jboss/config/attachment-storage.yaml}
      ATTACHMENT_S3_ENDPOINT: ${ATTACHMENT_S3_ENDPOINT:-http://minio:9000}
      ATTACHMENT_S3_ACCESS_KEY: ${ATTACHMENT_S3_ACCESS_KEY:-opendolphin}
      ATTACHMENT_S3_SECRET_KEY: ${ATTACHMENT_S3_SECRET_KEY:-opendolphin-secret}
      ATTACHMENT_S3_BUCKET: ${ATTACHMENT_S3_BUCKET:-opendolphin-attachments}
      ATTACHMENT_S3_REGION: ${ATTACHMENT_S3_REGION:-ap-northeast-1}
      ATTACHMENT_S3_BASE_PATH: ${ATTACHMENT_S3_BASE_PATH:-clinics/$${FACILITY_ID}}
      ATTACHMENT_S3_FORCE_PATH_STYLE: ${ATTACHMENT_S3_FORCE_PATH_STYLE:-true}
      ATTACHMENT_S3_SERVER_SIDE_ENCRYPTION: ${ATTACHMENT_S3_SERVER_SIDE_ENCRYPTION:-AES256}
      ATTACHMENT_S3_KMS_KEY_ID: ${ATTACHMENT_S3_KMS_KEY_ID:-}
      ATTACHMENT_S3_MULTIPART_THRESHOLD_MB: ${ATTACHMENT_S3_MULTIPART_THRESHOLD_MB:-64}
      PHR_EXPORT_SIGNING_SECRET: ${PHR_EXPORT_SIGNING_SECRET:-dev-phr-signing-secret}
      PHR_EXPORT_TOKEN_TTL_SECONDS: ${PHR_EXPORT_TOKEN_TTL_SECONDS:-300}
      PHR_EXPORT_STORAGE_TYPE: ${PHR_EXPORT_STORAGE_TYPE:-filesystem}
      PHR_EXPORT_STORAGE_FILESYSTEM_BASE_PATH: ${PHR_EXPORT_STORAGE_FILESYSTEM_BASE_PATH:-/var/opendolphin/phr-export}
      PHR_EXPORT_S3_BUCKET: ${PHR_EXPORT_S3_BUCKET:-opendolphin-phr-export}
      PHR_EXPORT_S3_REGION: ${PHR_EXPORT_S3_REGION:-ap-northeast-1}
      PHR_EXPORT_S3_PREFIX: ${PHR_EXPORT_S3_PREFIX:-facility/{facilityId}/jobs/}
      PHR_EXPORT_S3_ENDPOINT: ${PHR_EXPORT_S3_ENDPOINT:-http://minio:9000}
      PHR_EXPORT_S3_FORCE_PATH_STYLE: ${PHR_EXPORT_S3_FORCE_PATH_STYLE:-true}
      PHR_EXPORT_S3_ACCESS_KEY: ${PHR_EXPORT_S3_ACCESS_KEY:-opendolphin}
      PHR_EXPORT_S3_SECRET_KEY: ${PHR_EXPORT_S3_SECRET_KEY:-opendolphin-secret}
      # Secrets (本番必須項目)。未設定のまま本番デプロイすると WildFly が `IllegalStateException` で停止する。
      FACTOR2_AES_KEY_B64: ${FACTOR2_AES_KEY_B64:-b3BlbmRvbHBoaW4tZGV2LWZhY3RvcjIta2V5LTMyYnl0ZXM=}
      FIDO2_RP_ID: ${FIDO2_RP_ID:-localhost}
      FIDO2_RP_NAME: ${FIDO2_RP_NAME:-OpenDolphin Dev}
      FIDO2_ALLOWED_ORIGINS: ${FIDO2_ALLOWED_ORIGINS:-https://localhost:8443,http://localhost:9080}
      TZ: Asia/Tokyo
    ports:
      - "${MODERNIZED_APP_HTTP_PORT:-9080}:8080"
      - "${MODERNIZED_APP_ADMIN_PORT:-9995}:9990"
    volumes:
      - ./ops/modernized-server/config/attachment-storage.dev.yaml:/opt/jboss/config/attachment-storage.yaml:ro
    networks:
      - default
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -sf -H \"userName: ${SYSAD_USER_NAME:-1.3.6.1.4.1.9414.10.1:dolphin}\" -H \"password: ${SYSAD_PASSWORD:-36cdf8b887a5cffc78dcd5c08991b993}\" http://localhost:8080/openDolphin/resources/dolphin || exit 1"
        ]
      interval: 30s
      timeout: 10s
      retries: 5

  minio:
    image: minio/minio:latest
    container_name: opendolphin-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-opendolphin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-opendolphin-secret}
    ports:
      - "${MINIO_API_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5

  minio-mc:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-opendolphin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-opendolphin-secret}
      ATTACHMENT_S3_BUCKET: ${ATTACHMENT_S3_BUCKET:-opendolphin-attachments}
    entrypoint: ["/bin/sh", "-c"]
    command: |
      mc alias set local http://minio:9000 "$$MINIO_ROOT_USER" "$$MINIO_ROOT_PASSWORD" && \
      mc mb -p local/"$$ATTACHMENT_S3_BUCKET" >/dev/null 2>&1 || true && \
      mc anonymous set none local/"$$ATTACHMENT_S3_BUCKET" >/dev/null 2>&1 || true && \
      tail -f /dev/null

  helper:
    image: mcr.microsoft.com/devcontainers/base:jammy
    profiles:
      - modernized-dev
    working_dir: /workspace
    command: sleep infinity
    volumes:
      - .:/workspace

volumes:
  postgres-data-modernized:
  minio-data:
