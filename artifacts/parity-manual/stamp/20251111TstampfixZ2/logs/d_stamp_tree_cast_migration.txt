# Verified on 2025-11-11 (JST)
# Purpose: confirm whether d_stamp_tree.treebytes requires additional OID casting before parity run.

## Legacy DB (container: opendolphin-postgres, database: opendolphin)
# docker exec -e PGPASSWORD=opendolphin opendolphin-postgres \
#   psql -U opendolphin -d opendolphin -c "\\d+ d_stamp_tree"
# Result: treebytes column is "oid" with NOT NULL constraint; no ALTER executed.

## Modernized DB (container: opendolphin-postgres-modernized, database: opendolphin_modern)
# docker exec -e PGPASSWORD=opendolphin opendolphin-postgres-modernized \
#   psql -U opendolphin -d opendolphin_modern -c "\\d+ d_stamp_tree"
# Result: treebytes column is "oid" with NOT NULL constraint; already aligned with Legacy. No schema change applied for this run.

# Pending follow-up: if future bytea rollback is required, reuse the 20251111TstampfixZ log for ALTER statements.

## 2025-11-11T06:35Z follow-up (RUN_ID=20251111TstampfixZ2)
# Issue: Modernized PUT /stamp/tree failed with `column "treebytes" is of type oid but expression is of type bytea` because `bytea_to_oid` helper was missing.
# Action: Re-created helper function & implicit cast on both DBs.
# Legacy:
docker exec -i -e PGPASSWORD=opendolphin opendolphin-postgres psql -U opendolphin -d opendolphin <<'SQL'
CREATE OR REPLACE FUNCTION bytea_to_oid(bytea) RETURNS oid AS $$
  SELECT lo_from_bytea(0, $1);
$$ LANGUAGE sql STRICT;
DROP CAST IF EXISTS (bytea AS oid);
CREATE CAST (bytea AS oid) WITH FUNCTION bytea_to_oid(bytea) AS IMPLICIT;
SQL
# Modernized:
docker exec -i -e PGPASSWORD=opendolphin opendolphin-postgres-modernized psql -U opendolphin -d opendolphin_modern <<'SQL'
CREATE OR REPLACE FUNCTION bytea_to_oid(bytea) RETURNS oid AS $$
  SELECT lo_from_bytea(0, $1);
$$ LANGUAGE sql STRICT;
DROP CAST IF EXISTS (bytea AS oid);
CREATE CAST (bytea AS oid) WITH FUNCTION bytea_to_oid(bytea) AS IMPLICIT;
SQL
