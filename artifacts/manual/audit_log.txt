# Audit Log Manual Capture (2025-11-07)
作業者: Worker（Codex CLI）

## 0. 実行環境とブロッカー
- `psql`/`docker`/`postgresql` をローカルへインストール済みだが、`dockerd` は `iptables` 権限不足で起動不可。
- `server-modernized/tools/flyway/sql/V0001__baseline_tag.sql` がプレースホルダのため、`d_audit_event` などのスキーマ/初期データを再現できず、WildFly/サーバーを起動できない。
- `psql` で `SELECT 1 FROM d_audit_event` を実行すると以下の通りテーブル欠損となる。
  ```bash
  PGPASSWORD=opendolphin psql -U opendolphin -d opendolphin -c "SELECT 1 FROM d_audit_event LIMIT 1;"
  # -> ERROR:  relation "d_audit_event" does not exist
  ```
- サーバー未起動のため `ops/tools/send_parallel_request.sh` は両エンドポイントとも `curl: (7) Failed to connect` で終了。

## 1. ケース選定
1. `POST /20/adm/factor2/totp/registration` (ID: `factor2_totp_registration`)
2. `POST /20/adm/factor2/totp/verification` (ID: `factor2_totp_verification`)
3. `POST /20/adm/factor2/fido2/assertion/finish` (ID: `factor2_fido2_assert_finish`)

## 2. API 実行状況と監査ログ採取メモ
### Case 1: POST /20/adm/factor2/totp/registration
- 期待される監査イベント: `TOTP_REGISTER_INIT`（`d_audit_event.action`）。
- 送信方法: `BASE_URL_MODERN=http://localhost:18080 PARITY_HEADER_FILE=ops/tests/api-smoke-test/headers/adm20-admin.headers` を指定し、`ops/tools/send_parallel_request.sh POST /20/adm/factor2/totp/registration factor2_totp_registration` を実行。
- 結果: レガシー/モダナイズ双方とも `curl: (7) Failed to connect to localhost port 8080/18080`。`artifacts/parity-manual/factor2_totp_registration/<legacy|modern>/meta.json` に `status_code=000 / exit_code=7` として記録。
- `psql` 採取: `d_audit_event` 未作成のためダンプ不可（上記ブロッカー参照）。
- Evidence: 取得なし。再試行には `server-modernized` ベースライン DDL の復旧と WildFly 起動が必要。

### Case 2: POST /20/adm/factor2/totp/verification
- 期待される監査イベント: `TOTP_REGISTER_COMPLETE`、`d_factor2_credential` 更新。
- `ops/tools/send_parallel_request.sh POST /20/adm/factor2/totp/verification factor2_totp_verification` を実行したが、上記と同じく `curl: (7)` で失敗（証跡: `artifacts/parity-manual/factor2_totp_verification/.../meta.json`）。
- `psql` 採取: Case1 と同理由でテーブル参照不可。
- Evidence: 取得無し。`Factor2SecretProtector` 初期化に必要な `FACTOR2_AES_KEY_B64` も Secrets 未整備のため確認できず。

### Case 3: POST /20/adm/factor2/fido2/assertion/finish
- 期待される監査イベント: `FIDO2_ASSERT_COMPLETE`。`d_factor2_challenge` / `d_factor2_credential.sign_count` 等を確認予定。
- `PARITY_BODY_FILE=tmp/manual-audit/fido_assert_finish.json` で実行した結果、レガシー/モダナイズとも `exit_code=7`（`artifacts/parity-manual/factor2_fido2_assert_finish/.../meta.json`）。`artifacts/parity-manual/.../response.json` には空ファイルのみ出力。
- `psql` 採取: 前述のとおり `d_audit_event` / `d_factor2_challenge` 等が未作成でダンプ不能。

## 3. 次アクション候補
- Docker ではなくローカル WildFly + Postgres で `server-modernized` を起動する場合、外部保管のベースライン DDL（`server-modernized/db-baseline/`）を取得する必要がある。
- 2FA 機能に必須の Secrets (`FACTOR2_AES_KEY_B64`, `FIDO2_*`) を `.env` または Vault から復旧し、`ops/modernized-server/docker/configure-wildfly.cli` 相当の設定を手動で適用する。
- 環境が整い次第、本ファイルへ `d_audit_event` 出力と `trace_id` を追記し、`docs/server-modernization/phase2/notes/test-data-inventory.md` の「監査ログ・外部副作用テスト設計」節に証跡保存パスを紐付ける。
