# 06 性能指標と負荷計画

- RUN_ID: 20260127T205604Z
- 作業日: 2026-01-27
- 期間: 2026-02-03 09:00 - 2026-02-04 09:00
- 優先度: medium
- 緊急度: medium
- YAML ID: src/orca_preprod_issue_catalog_resolution_20260123/09_test_data_validation/06_性能指標と負荷計画.md
- 対象IC: IC-67
- 作業ディレクトリ: /Users/Hayato/Documents/GitHub/OpenDolphin_WebClient/.worktrees/task-1769547284822-529af8
- 前提ドキュメント:
  - docs/preprod/implementation-issue-inventory/issue-catalog-resolution-prerequisites-20260123.md
  - src/charts_production_outpatient/quality/54_リリース前チェックリストとDOC_STATUS更新.md
  - src/charts_production_outpatient/quality/53_障害注入_タイムアウト_スキーマ不一致.md
  - src/charts_production_outpatient/foundation/14_パフォーマンス予算と計測導入.md

## 目的
- SLA 判断に必要な p95/p99 指標と負荷試験計画を「実施可能な粒度」で定義する。
- UI 体感、API レイテンシ、キュー遅延、監査ログ負荷の指標を揃え、負荷試験の入口を固定する。

## 成果物
- 本ドキュメントを「性能指標定義書」として採用する。

## 性能指標（SLI/SLO の定義）
### 1) UI 体感 SLI（Charts 主要フロー）
`src/charts_production_outpatient/foundation/14_パフォーマンス予算と計測導入.md` の P95 を基準とし、P99 を SLA 判定の上限に設定する。

| フロー | 測定区間 | P95 目標 | P99 上限 | 備考 |
| --- | --- | --- | --- | --- |
| 初回オープン | `charts:init_start` → `charts:first_paint` | ≤ 2.0s | ≤ 3.0s | 既定は P95。P99 は許容上限（暫定）。 |
| 患者切替 | `charts:patient_switch_start` → `charts:patient_ready` | ≤ 1.0s | ≤ 1.6s | 同一セッション内切替。 |
| タイムライン更新 | `charts:timeline_refresh_start` → `charts:timeline_ready` | ≤ 1.2s | ≤ 1.8s | 再取得/自動更新共通。 |

- `missingMaster=true` / `fallbackUsed=true` は除外（ガード優先）。
- `dataSourceTransition='snapshot'` は別カテゴリで集計（SLA 判定外）。

### 2) API レイテンシ SLI（主要 API）
UI 体感のボトルネックになりやすい API を対象に、p95/p99 を測定する。

| 区分 | API 例 | P95 目標 | P99 上限 | 備考 |
| --- | --- | --- | --- | --- |
| 読取系 | `/orca/appointments/list`, `/orca/visits/list`, `/orca/medical/records`, `/orca/master/*` | ≤ 800ms | ≤ 1500ms | 画面描画の基盤。 |
| 更新系 | `/orca/patient/mutation`, `/orca/disease*`, `/orca/order/bundles`, `/orca/claim/outpatient` | ≤ 1500ms | ≤ 2500ms | 更新系は ORCA 往復が多く遅延許容を緩める。 |
| キュー系 | `/api/orca/queue`, `/api/admin/delivery` | ≤ 800ms | ≤ 1500ms | 監視/再送に影響。 |

- ORCA 実環境/Trial の応答は外部要因が大きいため、**実測値を別途記録し、上限値の妥当性を再評価** する。

### 3) エラー率・再試行 SLI
| 指標 | 目標 | SLA 判定 |
| --- | --- | --- |
| HTTP 5xx/timeout 率 | < 1.0% | ≥ 1.0% で違反 |
| リトライ回数 | 1 回以内 | 連続リトライ 2 回以上は警告 |
| schema mismatch | 0 件 | 1 件以上で調査対象 |

### 4) キュー遅延 SLI
`src/charts_production_outpatient/quality/53_障害注入_タイムアウト_スキーマ不一致.md` の滞留判定（5 分超過）を基準にする。

| 指標 | 目標 | SLA 判定 |
| --- | --- | --- |
| queue 遅延（lastDispatchAt 差分） | P95 ≤ 60s / P99 ≤ 300s | 5 分超で滞留扱い |

### 5) 監査ログ性能 SLI
| 指標 | 目標 | SLA 判定 |
| --- | --- | --- |
| auditEvent 書き込み遅延 | P95 ≤ 500ms | P99 ≥ 1000ms で警告 |
| auditEvent 欠落率 | 0% | 1 件でも調査対象 |

## 負荷試験計画
### 対象シナリオ（負荷の再現単位）
1. **Reception 一覧 + 患者選択**: 受付一覧取得 → 患者選択 → Charts 遷移
2. **Charts 主要フロー**: 初回オープン → タイムライン更新 → 患者切替
3. **更新系 API**: 病名/処方/オーダー更新、patient mutation
4. **キュー監視**: `/api/orca/queue` の定期ポーリング

### 負荷レベル（同時セッション）
`docs/preprod/implementation-issue-inventory/test-performance-resilience.md` の基準に合わせ、同時セッション数を 5 / 10 / 30 とする。

| レベル | 同時セッション | 目的 | 実行時間 |
| --- | --- | --- | --- |
| Baseline | 5 | 基準値 | 15 分 |
| Peak | 10 | 受付集中を再現 | 15 分 |
| Stress | 30 | 上限耐性の確認 | 10 分 |
| Soak | 10 | 長時間劣化確認 | 60 分 |

### 実施環境
- **MSW ON**: UI/ロジックの純粋負荷（ベースライン計測）
- **Modernized + ORCA stub**: API 実測（外部制約を避ける）
- **ORCA Trial/実環境**: 最小回数で実測し、上限値の妥当性確認（認証/機微情報は `ORCA_CERTIFICATION_ONLY.md` を遵守）

### 計測・証跡
- RUN_ID で統一保存: `artifacts/performance/<RUN_ID>/`
  - `api/` (p95/p99 計測ログ)
  - `ui/` (HAR/trace/スクリーンショット)
  - `summary.md` (結果と SLA 判定)
- 監査/テレメトリ: runId/traceId を必ず採取し、UI と API を突合。

### 実行ツール（候補）
- API 負荷: `ops/tools/send_parallel_request.sh` をベースに同時実行数を変える。
- UI 負荷: Playwright を `--repeat-each` で複数同時に回し、HAR/trace を保存。
- 監査ログ: `server-modernized` の auditEvent ログと UI runId を突合。

## 判定基準（SLA 判断材料）
- UI 体感 SLI（init/患者切替/タイムライン更新）の P95/P99 が表の上限内。
- 主要 API の P95/P99 が表の上限内（ORCA 実測は別集計）。
- キュー遅延が P95 ≤ 60s / P99 ≤ 300s、滞留 5 分超が 0 件。
- auditEvent 欠落 0、p99 書き込み遅延が 1s 未満。

## 未決事項 / 追加確認
- P99 上限値は暫定。Stage/Preview の実測後に再評価する。
- ORCA 実環境の負荷試験は機微情報を含む可能性があるため、運用側の許可と手順を必須とする。
- 負荷試験実行スクリプトの整備（k6/Artillery など）は次タスクで具体化する。

## 完了条件
- p95/p99 指標（UI/API/キュー/監査）が定義済み。
- 負荷試験のシナリオ/レベル/環境/判定基準が明確。
- SLA 判断に必要な「指標 + 計画」が揃っている。

## 更新ファイル
- src/orca_preprod_issue_catalog_resolution_20260123/09_test_data_validation/06_性能指標と負荷計画.md
