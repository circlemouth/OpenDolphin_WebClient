# 07 回復性テスト計画

- RUN_ID: 20260127T210320Z
- 作業日: 2026-01-27
- 期間: 2026-02-03 09:00 - 2026-02-04 09:00
- 優先度: high
- 緊急度: medium
- YAML ID: src/orca_preprod_issue_catalog_resolution_20260123/09_test_data_validation/07_回復性テスト計画.md
- 対象IC: IC-68
- 作業ディレクトリ: /Users/Hayato/Documents/GitHub/OpenDolphin_WebClient/.worktrees/task-1769547605074-beebb9
- 前提ドキュメント:
  - docs/preprod/implementation-issue-inventory/issue-catalog-resolution-prerequisites-20260123.md
  - src/charts_production_outpatient/quality/53_障害注入_タイムアウト_スキーマ不一致.md
  - src/charts_production_outpatient/quality/54_リリース前チェックリストとDOC_STATUS更新.md

## 目的
- DB/ORCA/MinIO の障害注入シナリオを定義し、復旧手順の検証が可能な計画を確立する。
- 障害時に UI が落ちず、再取得導線・再送導線・証跡収集が機能することを確認する。
- 復旧後に状態が正常化し、再実行で整合性が保たれることを証明する。

## 対象範囲
- DB: `server-modernized` の永続化層（PostgreSQL / Flyway / read/write 経路）
- ORCA: WebORCA Trial（XML/UTF-8 + Basic）/ dev proxy 経路
- MinIO: 監査/証跡/帳票/エビデンス保存ストレージ

## 基本方針
- **障害注入→観測→復旧→再取得** の 4 フェーズで統一する。
- 注入は **MSW とインフラ障害を分離** し、MSW は UI エラー導線確認に限定する。
- 影響範囲の切り分けができるよう、各シナリオは **単独で実行** する。
- すべての試験で **RUN_ID/traceId/ログ/スクリーンショット** を保存する。

## 事前準備
- 起動: `WEB_CLIENT_MODE=npm ./setup-modernized-env.sh`
- ORCA 接続: `docs/server-modernization/operations/ORCA_CERTIFICATION_ONLY.md` の手順を厳守
- 証跡保存: `artifacts/validation/resilience/<RUN_ID>/` に統一
- worktree 専用コンテナを作成し、他 worktree のコンテナは操作しない

## 障害注入シナリオ一覧
| ID | 対象 | 注入内容 | 目的 | 期待される UI/挙動 | 復旧の確認ポイント |
| --- | --- | --- | --- | --- | --- |
| DB-1 | DB | 接続断（DB コンテナ停止 or ネットワーク遮断） | DB 不可時のハンドリング | 画面が白くならず、再取得導線が表示される | DB 復旧後に再取得で正常表示へ回復 |
| DB-2 | DB | 遅延（netem で 3〜5s 追加） | タイムアウト時の導線 | timeout 表示 + 再試行/再取得ボタン | 遅延解除後に再取得で成功 |
| DB-3 | DB | 一時的な 500（アプリ側で DB 例外） | 失敗時の説明文言・監査 | 失敗内容が説明され、runId が表示/記録 | 再試行で正常化し整合性が保たれる |
| ORCA-1 | ORCA | dev proxy 無効化（接続先遮断） | ORCA 不達時の導線 | ORCA 取得失敗の説明 + 再取得導線 | proxy 復旧後に再取得成功 |
| ORCA-2 | ORCA | 認証失敗（資格情報を一時的に誤設定） | 認証エラーの通知・ログ | 認証エラーを説明し、失敗が証跡に残る | 正しい資格情報へ戻して成功 |
| ORCA-3 | ORCA | 応答遅延（proxy 側で遅延） | 待機/タイムアウト時の導線 | timeout 表示 + 再試行導線 | 遅延解除後に再取得成功 |
| MINIO-1 | MinIO | バケット不可（MinIO 停止） | 証跡保存失敗の検出 | UI は継続、保存失敗ログが残る | 復旧後に再保存で成功 |
| MINIO-2 | MinIO | 403/401（誤った access key） | 認可失敗時の記録 | 失敗ログと再送導線 | 正常 key へ戻して再送成功 |

## シナリオ別の共通手順
1. **RUN_ID 採番**: `RUN_ID=$(date -u +%Y%m%dT%H%M%SZ)`
2. **障害注入**: 対象シナリオの注入操作を実施
3. **影響確認**:
   - UI が白画面にならない
   - 失敗内容が説明される
   - `runId/traceId` が表示/ログ/監査に残る
4. **復旧操作**: 障害を解除
5. **再取得/再送**: UI の導線を使って再取得・再送
6. **正常化確認**: 画面・ログ・監査が正常化
7. **証跡保存**: HAR/スクショ/ログを保存

## 障害注入の具体例（案）
### DB
- コンテナ停止: `docker compose stop <worktree-db-container>`
- ネットワーク遮断: `docker network disconnect <network> <container>`
- 遅延: `tc qdisc add dev eth0 root netem delay 3000ms`

### ORCA
- dev proxy 停止: proxy コンテナ停止
- 認証失敗: Basic 認証情報を一時的に誤設定
- 応答遅延: proxy で遅延導入（nginx/mitm など）

### MinIO
- MinIO 停止: `docker compose stop <worktree-minio-container>`
- 認証失敗: access key / secret key を一時的に誤設定

※ 実行時は worktree 専用コンテナ名を使用すること。

## 観測ポイント（必須）
- UI が白画面にならない（例外で停止しない）
- 失敗の種類が UI 上で説明される
- `runId/traceId` が UI / ログ / 監査イベントに残る
- 復旧後、再取得/再送で正常化する
- 保存失敗時も UI が継続し、再送導線でリカバリ可能

## 証跡（保存先）
- `artifacts/validation/resilience/<RUN_ID>/`
  - `har/` (API 失敗の再現)
  - `screenshots/` (UI の状態)
  - `logs/` (server-modernized / web-client)

## 完了条件
- DB/ORCA/MinIO の障害注入シナリオが定義されている。
- 復旧手順が明文化され、検証手順が再現可能である。
- 証跡保存の標準パスが定義されている。

## 更新ファイル
- src/orca_preprod_issue_catalog_resolution_20260123/09_test_data_validation/07_回復性テスト計画.md
