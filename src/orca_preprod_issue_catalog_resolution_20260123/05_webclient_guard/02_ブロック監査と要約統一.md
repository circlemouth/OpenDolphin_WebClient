# 02_ブロック監査と要約統一

- RUN_ID: 20260125T084523Z
- 作業日: 2026-01-25
- YAML ID: src/orca_preprod_issue_catalog_resolution_20260123/05_webclient_guard/02_ブロック監査と要約統一.md
- 対象IC: IC-39 / IC-40 / IC-41 / IC-42
- 前提ドキュメント:
  - docs/preprod/implementation-issue-inventory/issue-catalog-resolution-prerequisites-20260123.md
  - src/charts_production_outpatient/foundation/11_監査ログauditEvent統一.md
  - docs/web-client/architecture/future-web-client-design.md
  - docs/web-client/architecture/web-client-api-mapping.md

## 実施内容
- Patients 保存ブロック時に監査イベントを送出し、blocked 理由を details.blockedReasons / message に統一。
- Charts PatientsTab の編集ガード（role/status/master/tone 等）で auditEvent を送出。
- Reception の Charts 新規タブ遷移失敗（patientId 欠損）で監査イベント + UI 通知（toast）を追加。
- AuditSummaryInline を Reception / Administration / Debug（Legacy REST/ORCA API）ヘッダへ配置し、要約表示を統一。

## 監査イベント方針
- Patients: action=PATIENT_SAVE_BLOCKED, outcome=blocked, details.blockedReasons にガード種別を付与。
- Charts: action=CHARTS_PATIENT_EDIT_GUARD, outcome=blocked, details.blockedReasons を付与。
- Reception: action=RECEPTION_OPEN_CHARTS, outcome=blocked, details.blockedReasons を付与。

## 変更ファイル
- web-client/src/features/patients/PatientsPage.tsx
- web-client/src/features/charts/PatientsTab.tsx
- web-client/src/features/charts/audit.ts
- web-client/src/features/reception/pages/ReceptionPage.tsx
- web-client/src/features/administration/AdministrationPage.tsx
- web-client/src/features/debug/LegacyRestConsolePage.tsx
- web-client/src/features/debug/OrcaApiConsolePage.tsx
- web-client/src/features/debug/legacyRestConsole.css
- web-client/src/features/debug/orcaApiConsole.css

## 検証
- 実行コマンド:
  - npm test -- PatientsPage.test.tsx
  - npm test -- LegacyRestConsolePage.test.tsx
- 結果: パス
