# 01 接続先と認証設定統一

- RUN_ID: 20260123T221843Z
- 対象 IC: IC-12 / IC-15 / IC-16 / IC-17 / IC-18
- 期間: 2026-01-24 09:00 - 2026-01-26 09:00
- 優先度: high
- 作業ディレクトリ: /Users/Hayato/Documents/GitHub/OpenDolphin_WebClient/.worktrees/task-1769206630937-f4d306
- 前提ドキュメント:
  - `docs/preprod/implementation-issue-inventory/issue-catalog.md`
  - `docs/preprod/implementation-issue-inventory/issue-catalog-resolution-prerequisites-20260123.md`
  - `setup-modernized-env.sh`
  - `docs/server-modernization/operations/ORCA_FIRECRAWL_INDEX.md`
  - `docs/server-modernization/operations/ORCA_CERTIFICATION_ONLY.md`

## 目的
- 接続先・認証設定の既定値と切替ルールを統一し、preprod/本番切替での誤接続を防ぐ。
- Basic/証明書切替とポート置換挙動を明文化し、起動ログを標準化する。

## 優先順位（ORCA_BASE_URL vs ORCA_API_HOST/PORT）
1. `ORCA_BASE_URL` を最優先（指定時はこれが採用される）
2. `ORCA_API_HOST` / `ORCA_API_PORT` / `ORCA_API_SCHEME`
3. 未指定時はスクリプト既定値

## 変更方針（決定事項）
1. **接続先の正本**
   - 非Legacy の `docs/server-modernization/operations/ORCA_CERTIFICATION_ONLY.md` を正本とする。
   - Phase2 配下は参照専用とし、実運用の参照先は上記へ移行する。
2. **切替の明示**
   - preprod/本番切替時は `ORCA_TARGET_ENV` を明示し、ホスト/ベースURLを必ず指定する。
3. **認証方式の明確化**
   - Web クライアント dev proxy は **証明書 > Basic > なし** の優先順。
   - server-modernized の ORCA API は `ORCA_API_USER/ORCA_API_PASSWORD` を基本とする（証明書は dev proxy のみ）。
4. **ポート置換の統一**
   - `ORCA_API_PORT=8000` は既定で禁止し、`ORCA_API_PORT_FALLBACK` に置換する。
   - 8000 を利用する場合は `ORCA_API_PORT_ALLOW_8000=1` を明示する。
5. **ログ標準化**
   - 接続先/認証/ポート置換の採用値とソースを `ORCA_CONFIG` 形式で出力する。
   - 認証情報（ユーザー/パスワード/証明書パス）は値を出さず、**set/unset** のみ記録する。

## 環境変数一覧（統一版）
### server-modernized 向け
| 変数 | 用途 | 既定/備考 |
| --- | --- | --- |
| `ORCA_TARGET_ENV` | 接続先の目的 (local/trial/stage/preprod/prod/custom) | preprod/prod 切替時に必須推奨 |
| `ORCA_API_SCHEME` | ORCA API の scheme | 未指定なら `http` / WebORCA の場合は `https` |
| `ORCA_API_HOST` | ORCA API の host | 未指定なら `localhost` |
| `ORCA_API_PORT` | ORCA API の port | 未指定なら 80/443 or `ORCA_API_PORT_FALLBACK` |
| `ORCA_API_PORT_FALLBACK` | 8000 置換先ポート | 既定 `18080` |
| `ORCA_API_PORT_ALLOW_8000` | 8000 使用許可 | 既定 `0` |
| `ORCA_API_USER` | ORCA Basic ユーザー | 未指定なら `ORCA_CERTIFICATION_ONLY.md` 由来 |
| `ORCA_API_PASSWORD` | ORCA Basic パスワード | 未指定なら `ORCA_CERTIFICATION_ONLY.md` 由来 |
| `ORCA_BASE_URL` | ORCA API ベース URL | 未指定なら scheme/host/port から生成 |
| `ORCA_MODE` | `weborca` / `onprem` | 未指定なら host 判定 |
| `ORCA_API_PATH_PREFIX` | WebORCA `/api` プレフィックス | 未指定なら auto (`/api` 自動付与) |
| `ORCA_API_WEBORCA` | WebORCA 強制指定 | `true/1` で WebORCA 扱い |
| `ORCA_API_RETRY_MAX` | リトライ回数 | 既定 `0` |
| `ORCA_API_RETRY_BACKOFF_MS` | リトライ間隔 | 既定 `200` |

### Web クライアント dev proxy 向け
| 変数 | 用途 | 既定/備考 |
| --- | --- | --- |
| `VITE_DEV_PROXY_TARGET` | dev proxy 先 | ローカルは `http://localhost:9080/openDolphin/resources` |
| `VITE_API_BASE_URL` | Web API ベース | 既定 `/api` |
| `VITE_DEV_USE_HTTPS` | Vite HTTPS 有効化 | 既定 `1` |
| `VITE_DISABLE_PROXY` | proxy 無効 | `1` で無効 |
| `ORCA_CERT_PATH` | mTLS 証明書(PKCS#12) | 旧 `ORCA_PROD_CERT_PATH`/`ORCA_PROD_CERT` を含む |
| `ORCA_CERT_PASS` | 証明書パスフレーズ | 旧 `ORCA_PROD_CERT_PASS` を含む |
| `ORCA_BASIC_USER` | Basic ユーザー | 旧 `ORCA_PROD_BASIC_USER` / `ORCA_API_USER` を含む |
| `ORCA_BASIC_PASSWORD` | Basic パスワード | 旧 `ORCA_PROD_BASIC_KEY` / `ORCA_API_PASSWORD` を含む |
| `ORCA_BASIC_KEY` | Basic パスワード（互換） | `ORCA_BASIC_PASSWORD` の互換名 |

> 旧変数（`ORCA_PROD_*`）は互換用に残し、**新規は `ORCA_CERT_*` / `ORCA_BASIC_*` を推奨**。

## ログ標準化（起動ログ例）
`setup-modernized-env.sh` / `setup-modernized-env.ps1` は以下の形式で出力する。

```text
[HH:MM:SS] ORCA_CONFIG target_env=preprod base_url=https://<MASKED> mode=weborca path_prefix=/api
[HH:MM:SS] ORCA_CONFIG source host=env:ORCA_API_HOST port=env:ORCA_API_PORT scheme=env:ORCA_API_SCHEME
[HH:MM:SS] ORCA_CONFIG port policy=block_8000 allow_8000=0 fallback=18080 replaced=false
[HH:MM:SS] ORCA_CONFIG auth server_basic=set web_proxy_basic=set web_proxy_cert=unset
```

- **機微情報は出力しない**（ユーザー名/パスワード/証明書パスは `set/unset` のみ）。
- `source` は env / file / default を明示する。

## 実装（本 RUN）
- `setup-modernized-env.sh` / `setup-modernized-env.ps1` の ORCA 接続情報参照先を非Legacy へ統一。
- 接続設定の採用値/ソース/ポート置換/認証方式を `ORCA_CONFIG` ログで統一出力。
- Web クライアント dev proxy の Basic/証明書 env を `ORCA_BASIC_*` / `ORCA_CERT_*` に統一（旧変数は互換）。

## 完了条件チェック
- preprod/本番切替時に `ORCA_TARGET_ENV` + 明示ホスト指定で誤接続を防止できる。
- Basic/証明書の切替が env で明示でき、ログで set/unset を確認できる。
- 8000 ポート置換の挙動がログで判別できる。

## 検証/証跡
- `docs/server-modernization/operations/logs/20260123T232856Z-orca-connection-standardization.md`

## 更新ファイル
- `setup-modernized-env.sh`
- `setup-modernized-env.ps1`
- `web-client/vite.config.ts`
- `docs/server-modernization/operations/ORCA_CERTIFICATION_ONLY.md`
