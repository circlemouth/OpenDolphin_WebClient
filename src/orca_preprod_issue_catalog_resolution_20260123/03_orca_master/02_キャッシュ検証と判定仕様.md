# 02 キャッシュ検証と判定仕様

- 期間: 2026-01-28 09:00 - 2026-01-30 09:00 / 優先度: high / 緊急度: high
- 対象IC: IC-20 / IC-21 / IC-22
- RUN_ID: 20260125T084018Z
- YAML ID: src/orca_preprod_issue_catalog_resolution_20260123/03_orca_master/02_キャッシュ検証と判定仕様.md
- 前提ドキュメント:
  - docs/preprod/implementation-issue-inventory/issue-catalog-resolution-prerequisites-20260123.md
  - docs/preprod/implementation-issue-inventory/issue-catalog.md
  - src/server_modernized_gap_20251221/02_orca08_etensu/ORCA-08_キャッシュ_監査_性能.md
  - src/server_modernized_gap_20251221/02_orca08_etensu/ORCA-08_E2E_証跡.md
- 成果物:
  - artifacts/preprod/orca-master-cache/20260125T084018Z/README.md

## 目的
- ORCA マスタの ETag/Cache-Control 実挙動を実データで確認し、cacheHit 判定を固定する。
- 空結果/404/200 の扱いを統一し、missingMaster 判定の誤作動を防止する。
- 更新トリガ（再取得条件）を明文化する。

## 実データ検証（キャッシュ/ETag）
- 200 応答の ETag/Cache-Control は ETENSU 実測ヘッダで確認済み。
  - `artifacts/api-stability/20251124T111500Z/benchmarks/20251223T104902Z/etensu-size20.headers.txt`
  - `artifacts/api-stability/20251124T111500Z/benchmarks/20251223T104902Z/etensu-size2000.headers.txt`
- 304 応答の挙動はユニットテストで検証し、If-None-Match に一致した場合のみ Not Modified を返すことを確認した。
  - `server-modernized/src/test/java/open/orca/rest/OrcaMasterResourceTest.java`
  - 実行ログ: `artifacts/preprod/orca-master-cache/20260125T084018Z/logs/mvn-test.log`

## 判定仕様（200/304/空結果/404）
### 共通キャッシュ仕様
- `Cache-Control`: `public, max-age=<TTL>, stale-while-revalidate=86400`。
- `Vary`: `userName,password`（マスタ Basic 認証単位でキャッシュを分離）。
- `ETag`: `apiRoute|masterType|dataSource|snapshotVersion|version|query` から SHA-256 で生成。
- `cacheHit` 判定:
  - `If-None-Match` が一致して 304 の場合のみ `true`。
  - 200/404/503 は `false`。
  - `/orca/master/etensu` は `X-Orca-Cache-Hit` を返却（200=false/304=true）。

### TTL
- 既定: 300 秒（5 分）。
- 例外: `orca06-address` / `orca06-hokenja` は 604800 秒（7 日）。

### 空結果/404 の取り扱い
- list 系 (`/orca/master/generic-class` など):
  - 200 + items=[] を空結果とみなす。
  - `missingMaster=false` / `fallbackUsed=false` / `emptyResult=true`。
- lookup 系（住所・点数）:
  - `/orca/master/address`: 404 + `missingMaster=true` / `fallbackUsed=true`。
  - `/orca/master/etensu`: 404 (`TENSU_NOT_FOUND`) + `missingMaster=true` / `fallbackUsed=true`。
- lookup 系（最低薬価）:
  - `/orca/master/generic-price` の未収載薬は 200 + ダミーエントリを返し、`missingMaster=true` / `fallbackUsed=true`。

### missingMaster 判定
- `DataOrigin=FALLBACK` または明示オーバーライド時のみ `true`。
- ORCA DB からの通常取得（空リスト含む）は `missingMaster=false`。
- 404 の場合は UI を readOnly 化し、再取得導線を必須とする。

## 更新トリガ（再取得条件）
1. **TTL 期限**: `max-age` を超過したら If-None-Match を付けて再検証。
2. **masterSource 切替**: `resolveMasterSource` の切替時はキャッシュ無効化し再取得。
3. **missingMaster/fallbackUsed 発火**: 直ちに再取得導線を表示し、手動再取得で 200 回復時に解除。
4. **クエリ変更**: `keyword/effective/page/size` 等の条件変更時は別キャッシュキーとして再取得。
5. **運用更新**: ORCA マスタ改定が告知された場合は対象マスタを手動で再取得する（TTL を待たない）。

## 実装参照
- `server-modernized/src/main/java/open/orca/rest/OrcaMasterResource.java`
- `server-modernized/src/main/java/open/orca/rest/OrcaMasterDao.java`

## 検証
- `mvn -pl server-modernized -Dtest=OrcaMasterResourceTest test`
  - 結果: PASS
- 実データの ETag/Cache-Control は既存ヘッダ証跡（2025-12-23）で確認済み。

## 完了条件
- 200/304/空結果/404 の判定が仕様化されている。
- cacheHit の判定が 304 に固定されている。
- missingMaster の扱いと更新トリガが定義されている。
