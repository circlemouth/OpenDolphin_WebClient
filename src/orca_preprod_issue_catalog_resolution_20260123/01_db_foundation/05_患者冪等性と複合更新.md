# 05 患者冪等性と複合更新

- RUN_ID: 20260125T112249Z
- 作業日: 2026-01-25
- YAML ID: src/orca_preprod_issue_catalog_resolution_20260123/01_db_foundation/05_患者冪等性と複合更新.md
- 対象IC: IC-06 / IC-11
- 前提ドキュメント:
  - docs/preprod/implementation-issue-inventory/issue-catalog-resolution-prerequisites-20260123.md
  - docs/server-modernization/rest-api-modernization.md
  - src/validation/入力バリデーション妥当性確認.md
  - docs/preprod/implementation-issue-inventory/data-transactions.md

## 目的
- 患者作成の再送で重複登録や 500 が起きないよう、idempotent な挙動と衝突時の扱いを確定する。
- 患者作成→Karte→病名/処方/オーダーの複合更新で部分成功が残る場合の補正/再試行ルールを定義する。

## 冪等性方針（患者作成）
### 対象API
- `/orca/patient/mutation`（operation=create）
- `/orca12/patientmodv2/outpatient`（operation=create）

### 判定ルール
1. `facilityId + patientId` で既存患者を検索する。
2. 既存患者が **見つからない** 場合のみ新規作成を実行する。
3. 既存患者が **存在** する場合は次のいずれかを返す。
   - **同一内容**（要求payloadに含まれる項目が既存と一致） → 200 + `idempotent=true`。
   - **差分あり** → 409 `patient_conflict` + `conflictFields` を返却（create では上書きしない）。

### 競合時の再送（重複回避）
- 作成レース/再送で UNIQUE 制約違反が起きた場合は再度患者を照会し、既存があれば **idempotent 成功**として返す。
- 既存が取得できない場合のみ例外を再送出する。

### 応答/監査
- idempotent 成功時は `idempotent=true` / `idempotentReason` をレスポンスと監査に記録。
- 409 の場合は `patient_conflict` を返し、監査に `conflictFields` を記録する。

## 複合更新（患者→Karte→病名/処方/オーダー）のロールバック方針
### 原則
- **患者作成 + Karte 生成**は同一トランザクション（`PatientServiceBean#addPatient`）で実行し、失敗時は全体がロールバックされる。
- **病名/処方/オーダー**は別トランザクションのため、後続が失敗しても患者作成は維持される。

### 補正/再試行ルール
1. **患者作成の再送**は常に安全（idempotent 判定で重複回避）。
2. **後続APIが 404**（patient/karte not found）の場合は患者作成を再送せず、前提データの作成/復旧を優先する。
3. **後続APIが 500**（schema/前提欠落）時は再送を止め、環境修復後に該当APIのみ再送する。
4. **409 conflict** は create の再送では解決しないため、`update` で補正するか手動確認を行う。
5. 監査ログの `runId/traceId/requestId` を用いて、部分成功の範囲を特定してから再試行する。

## 実装（idempotent 対応）
- `/orca/patient/mutation` の create は **既存照会→同一なら成功 / 差分なら 409** に変更。
- `/orca12/patientmodv2/outpatient` も同様に idempotent 判定を適用。
- 競合時に UNIQUE 例外が出た場合でも再照会で既存を返す。

### 変更ファイル
- server-modernized/src/main/java/open/dolphin/rest/orca/OrcaPatientResource.java
- server-modernized/src/main/java/open/dolphin/rest/PatientModV2OutpatientResource.java
- server-modernized/src/main/java/open/dolphin/rest/dto/orca/PatientMutationResponse.java
- server-modernized/src/test/java/open/dolphin/rest/orca/OrcaPatientResourceIdempotencyTest.java
- server-modernized/src/test/java/open/dolphin/rest/PatientModV2OutpatientResourceIdempotencyTest.java

## テスト
- 実行コマンド:
  - `mvn -pl server-modernized -Dtest=OrcaPatientResourceIdempotencyTest,PatientModV2OutpatientResourceIdempotencyTest test`
- 結果: 両テストとも成功（idempotent/409 の戻りを確認）。
