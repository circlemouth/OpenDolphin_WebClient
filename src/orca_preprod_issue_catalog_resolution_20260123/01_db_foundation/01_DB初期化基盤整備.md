# 01_DB初期化基盤整備

- RUN_ID: 20260123T221243Z
- 作業日: 2026-01-23
- YAML ID: src/orca_preprod_issue_catalog_resolution_20260123/01_db_foundation/01_DB初期化基盤整備.md
- 対象IC: IC-01 / IC-02 / IC-03
- 前提ドキュメント:
  - docs/preprod/implementation-issue-inventory/issue-catalog-resolution-prerequisites-20260123.md
  - docs/server-modernization/persistence-layer/3_4-persistence-layer-modernization.md
  - docs/server-modernization/server-modernized-code-review-20260117.md
  - setup-modernized-env.sh

## 実施内容
- legacy schema dump の必須化（未初期化 + dump 不在時は起動停止）。
- search_path を起動時に固定（opendolphin,public）。
- 必須シーケンスの自動補正 SQL を追加し、起動時に適用。
- DB 初期化ログの出力先を追加（artifacts/preprod/db-init）。

## 起動チェック
- `setup-modernized-env.sh` で以下を自動確認。
  - `d_users` / `d_audit_event`（opendolphin/public いずれか）の存在。
  - `opendolphin.hibernate_sequence` / `d_patient_seq` / `d_karte_seq` / `d_audit_event_id_seq` の存在。
  - `search_path` に `opendolphin` と `public` が含まれていること。

## 修復SQL
- `ops/db/maintenance/modernized_db_init_repair.sql`
  - opendolphin スキーマ作成。
  - search_path を `opendolphin,public` に固定。
  - 必須シーケンス作成と `setval` による自動補正。

## 初期化ログ
- `setup-modernized-env.sh` 実行時に `artifacts/preprod/db-init/db-init-<RUN_ID>.log` を出力。

## 変更ファイル
- setup-modernized-env.sh
- ops/db/maintenance/modernized_db_init_repair.sql
- docs/preprod/implementation-issue-inventory/logs/20260123T221243Z-db-init-foundation.md

## 検証
- 実行コマンド:
  `MODERNIZED_APP_HTTP_PORT=19092 MODERNIZED_APP_ADMIN_PORT=20097 MODERNIZED_POSTGRES_PORT=55540 MINIO_API_PORT=19202 MINIO_CONSOLE_PORT=19203 WEB_CLIENT_MODE=npm ./setup-modernized-env.sh`
- 結果: Modernized Server 起動・DB修復SQL適用・baseline seed・初期ユーザー登録まで完了。
- 初期化ログ: `artifacts/preprod/db-init/db-init-20260123T222356Z.log`
- 確認:
  - `/api/admin/config` は HTTP 401（500 なし）。
  - `SELECT nextval('opendolphin.d_audit_event_id_seq')` が成功。
