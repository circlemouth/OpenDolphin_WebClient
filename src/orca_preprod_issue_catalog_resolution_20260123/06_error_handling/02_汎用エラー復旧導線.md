# 02_汎用エラー復旧導線

- RUN_ID: 20260126T063842Z
- 作業日: 2026-01-26
- YAML ID: src/orca_preprod_issue_catalog_resolution_20260123/06_error_handling/02_汎用エラー復旧導線.md
- 対象IC: IC-43 / IC-44 / IC-45 / IC-46
- 前提ドキュメント:
  - docs/preprod/implementation-issue-inventory/issue-catalog-resolution-prerequisites-20260123.md
  - src/charts_production_outpatient/foundation/12_エラーハンドリングとリトライ規約.md
  - src/charts_production_outpatient/quality/53_障害注入_タイムアウト_スキーマ不一致.md

## 実施内容
- 共通エラーバナー生成ルールを拡張し、HTTP/Network 失敗の文言・トーン・次アクションを統一した。
- 401/403 は再ログイン CTA を最優先で表示し、セッション失効通知でログアウト導線へ統一した。
- 404 は info トーンの空状態メッセージとして扱い、条件変更と再取得の案内を共通化した。
- 5xx は再取得ボタンに 5 秒クールダウンを付与し、復旧までの行動指針を画面間で揃えた。
- ApiFailureBanner 経由の画面（Reception/Patients/Charts など）で上記ルールが同一になるようにした。

## 変更ファイル
- web-client/src/features/shared/apiError.ts
- web-client/src/features/shared/ApiFailureBanner.tsx
- web-client/src/features/shared/apiError.test.ts

## 検証
- 実行コマンド:
  - npm --prefix web-client test -- apiError
- 結果: パス

## 追加確認（RUN_ID=20260126T074551Z）
### 1. 対象画面の適用確認
- Reception: `web-client/src/features/reception/pages/ReceptionPage.tsx` の `appointmentErrorContext` → `ApiFailureBanner`（外来リスト取得失敗）。
- Patients: `web-client/src/features/patients/PatientsPage.tsx` の `patientsErrorContext` → `ApiFailureBanner`（患者取得失敗）。
- Charts:
  - `web-client/src/features/charts/DocumentTimeline.tsx` の claim/queue/push 失敗 → `ApiFailureBanner`。
  - `web-client/src/features/charts/MedicalOutpatientRecordPanel.tsx` の外来医療記録失敗 → `ApiFailureBanner` に移行。

### 2. 障害注入の実画面検証（MSW）
- 401/403/404/5xx/network を `x-msw-fault` で注入し、以下を確認。
  - 表示文言: `ApiFailureBanner` が `apiError.ts` の共通メッセージを表示。
  - 次アクション: 401/403=再ログイン、404=条件変更/再取得、5xx/network=再取得。
  - トーン: 401/403=warning、404=info、5xx/network=error。
  - 5秒クールダウン: 5xx の再取得ボタンに待機表示を確認。

### 3. 空状態UIの一致確認
- 404 注入時に Patients の空状態 (`患者データがありません。`) と info トーンの ApiFailureBanner を併記し、空状態として扱われることを確認。

### 4. テスト/証跡
- 実行コマンド:
  - `RUN_ID=20260126T074551Z npx playwright test tests/e2e/outpatient-generic-error-recovery.msw.spec.ts`
- 結果: パス（5 tests passed）。
- 証跡:
  - `artifacts/webclient/e2e/20260126T074551Z/msw-on/screenshots/`（各シナリオのスクリーンショット）
  - `artifacts/webclient/e2e/20260126T074551Z/msw-on/har/`（HAR）

### 5. 変更ファイル（追加）
- `web-client/src/features/charts/MedicalOutpatientRecordPanel.tsx`
- `web-client/src/mocks/handlers/outpatient.ts`
- `tests/e2e/outpatient-generic-error-recovery.msw.spec.ts`
