# 04_マスターデータ補完ブリッジ実装計画

- RUN_ID: `20251124T021734Z`
- 期間: 2025-11-26 09:00 〜 2025-11-27 09:00 (JST)
- 優先度: Medium / 緊急度: High
- エージェント: gemini cli
- YAML ID: `src/webclient_modernized_bridge/04_マスターデータ補完ブリッジ実装計画.md`
- 参照チェーン: `AGENTS.md` → `docs/web-client/README.md` → `docs/server-modernization/phase2/INDEX.md` → `docs/managerdocs/PHASE2_MANAGER_ASSIGNMENT_OVERVIEW.md` → 本ファイル
- 証跡ログ: `docs/server-modernization/phase2/operations/logs/20251124T021734Z-webclient-master-bridge-plan.md`

## ゴール
1. ORCA マスターデータ不足（ORCA-05/06/08 中心）に対し、webclient_modernized_bridge 層での補完レイヤー（取得元選択・フォールバック・キャッシュ・監査）の設計を決定する。
2. ORCA 連携手順書（`docs/server-modernization/phase2/operations/ORCA_CONNECTIVITY_VALIDATION.md`）の制約を尊重した運用案を提示し、開発/検証で使用する接続先・手順を固定する。
3. スプリント粒度に分解した実装タスクと所要時間見積り（人時）を更新し、期限 2025-11-27 09:00 (JST) に間に合うロードマップを確定する。

## 前提・制約
- Python スクリプト実行禁止。サーバー側（`server/`）や Legacy 資産（`client/` `common/` `ext_lib/`）は非改変。
- 接続先は `docs/web-client/operations/mac-dev-login.local.md` 記載の開発 ORCA のみ。WebORCA Trial や `curl --cert-type P12` は禁止。
- MSW 無効化・`VITE_DEV_PROXY_TARGET` 設定は `src/webclient_modernized_bridge/02_接続基盤セットアップ（MSW無効化とVITE_DEV_PROXY_TARGET設定）.md` に従う。接続設定変更時は監査メタ `dataSourceTransition` を送出する。
- RUN_ID=`20251124T021734Z` を DOC_STATUS/ログ/証跡で共通利用し、派生 RUN_ID は本値を親として明示する。

## 1. 追加取得が必要なマスターデータと補完方針
| マスタ種別 (ORCA ID) | 主要ユースケース | 現状 | 補完レイヤー設計（webclient_modernized_bridge） | 取得手段/エンドポイント案 |
| --- | --- | --- | --- | --- |
| 薬剤分類・最低薬価・用法・特定器材・検査分類 (ORCA-05) | Charts オーダ候補/禁忌/最低薬価チェック | REST 未提供。MSW + snapshot 依存 | (A) `data-source=mock|snapshot` を明示する警告バナーと監査メタ `missingMaster=true` を送出。<br>(B) `masterSourceResolver` で **snapshot → mock → server** の順にフェッチし、単価/用法欠落時は保存ブロック + `audit.logValidationError`。<br>(C) 同期ジョブで snapshot を 1 日 1 回差し替え、UI は `version` を監査へ送出。 | `/orca/master/generic-class` `/generic-price` `/youhou` `/material` `/kensa-sort`（提供時）<br>提供前は `artifacts/api-stability/20251123T130134Z/master-snapshots/` を継続利用。 |
| 保険者・住所 (ORCA-06) | 受付/予約 資格確認・住所補完 | REST 未提供 | (A) 最小コード定数（国保/社保/後期）を bridge 配下に同梱し `data-source=fallback` として監査へ送出。<br>(B) 保険者レスポンスが空の場合はフリーテキスト入力を許容し、送信前に `fallbackUsed=true` を必須ログ。<br>(C) 住所マスタは都道府県/市区町村スナップショットを 7 日 TTL の in-memory キャッシュで保持。 | `/orca/master/hokenja` `/orca/master/address?pref|zip`（提供時）<br>現在は `artifacts/api-stability/20251124T000000Z/master-snapshots/` の空レスポンスを検証用に使用。 |
| 電子点数表・診療行為区分 (ORCA-08) | 病名/算定・Claim 再計算 | REST 未提供、MSW のみ | (A) `WEB_ORCA_MASTER_SOURCE` フラグで MSW→server を段階切替。<br>(B) 取得結果に `tensuVersion` を付与し、算定差異は `audit.logBillingAction` へ `tensuCodeMissing` を送出。<br>(C) サーバー実装前は MSW との差分を契約テストでスナップショット化し、件数乖離時は UI で `warning` トースト。 | `/orca/tensu/ten?min&max&date`（提供時）<br>MSW フィクスチャ: `artifacts/api-stability/20251123T130134Z/schemas/` 継続。 |
| 住所/保険同期ジョブ | スタンドアロン同期で UI 更新 | 未設計 | (A) `bridge-sync` job を npm script で追加し、MSW 無効化 + `VITE_DEV_PROXY_TARGET` 既設定時のみ実行。<br>(B) 実行結果は `artifacts/api-stability/20251124T021734Z/master-sync/` へ保存し、DOC_STATUS 備考にパスを記録。<br>(C) 失敗時はロールバック（前回 snapshot を復旧）手順を明文化。 | `node scripts/bridge-sync`（※実装時は Python 禁止・Node/tsx で） |
| 監査メタ | dataSourceTransition / fallbackUsed / missingMaster | 一部未送出 | (A) fetch フック共通ミドルで強制付与し、画面ごとの audit ロガーへ透過。<br>(B) 切替・再取得時は `audit.logUiState` で `bannerVisible` を送出。 | 監査送出は既存 axios/fetch ラッパーを利用、追加実装はフロントのみ。 |

## 2. 補完レイヤーの構成案
1. **source resolver**: `webclient_modernized_bridge` 配下に `resolveMasterSource(masterType)` を追加し、`env (WEB_ORCA_MASTER_SOURCE)`・runtime flag・API reachability（health check）で `server|snapshot|mock|fallback` を決定。監査フィールド `dataSource`/`dataSourceTransition` を強制付与。
2. **fetch adapter**: masterType 別に `fetchOrcaMaster(masterType, params)` を実装し、server ルートは `/orca/master/*` など REST を呼び、snapshot/mock/fallback はローカル JSON/定数を返す。全経路でスキーマ検証を行い、欠損フィールドは `missingMaster=true` として返却。
3. **cache & versioning**: React Query で TTL=5 分、key=`[orca-master, masterType, version]`。snapshot/sync ジョブは `version` を更新し UI 再取得を促す。localStorage/IndexedDB は使用しない。
4. **validation hooks**: 保存前に `masterRequiredFields` を検証し、欠損時は UI ブロック + `audit.logValidationError` + `warning` バナー。Charts/Reception/Claim で共通ロジックを共有。
5. **observability**: TraceId を fetch レイヤーで拾い、監査/トーストに表示。`docs/web-client/ux/CHART_UI_GUIDE_INDEX.md` のトーン規約に従い `warning`/`danger` を統一。

## 3. ORCA 連携運用案（ORCA_CONNECTIVITY_VALIDATION 順守）
- 接続先: `mac-dev-login.local.md` の mac-dev ORCA のみ。Trial や本番経路は禁止。
- 手順: (1) `VITE_DISABLE_MSW=1` を設定 → (2) `VITE_DEV_PROXY_TARGET` を mac-dev URL へ設定 → (3) `npm run dev` 起動前に `./public/mockServiceWorker.js` を削除確認 → (4) `docs/server-modernization/phase2/operations/ORCA_CONNECTIVITY_VALIDATION.md` §4.3 の curl スモーク（DNS/TLS/acceptlstv2）を実行し、ログに RUN_ID を付与。
- 監査: 取得経路・fallback・警告表示をすべて `audit.logOrcaQuery` / `audit.logUiState` に記録し、データソース切替時は `dataSourceTransition` を必須化。
- 禁止事項: WebORCA Trial へのアクセス、`curl --cert-type P12`、未承認の本番経路利用、Python スクリプト実行。

## 4. スプリント別タスク & 見積り（人時）
| スプリント | 期間 | タスク | 見積り | 完了条件 |
| --- | --- | --- | --- | --- |
| SP1 設計固定 | 11/26 09:00-12:00 | source resolver / fetch adapter の API 面・監査フィールド定義、フラグ仕様確定。 | 3h | 設計メモを本ファイルに反映し、ログへ記録。 |
| SP2 実装（フェッチ/キャッシュ） | 11/26 13:00-18:00 | `resolveMasterSource` 実装、React Query TTL=5 分設定、監査メタ付与、fallback 定数組み込み。 | 5h | `/orca/master/address` スモークで `dataSource=server` 付与が確認できること。 |
| SP3 同期ジョブ & スナップショット更新 | 11/26 19:00-22:00 | `bridge-sync` npm script 追加、結果を `artifacts/api-stability/20251124T021734Z/master-sync/` へ保存、ロールバック手順追記。 | 3h | 1 回目の同期で snapshot が保存され、DOC_STATUS 備考にパスを追記。 |
| SP4 UI 配線・回帰 | 11/27 00:00-06:00 | Charts/Reception/Claim の fetch フックへ組み込み、`warning` バナーと監査送出を E2E/スモークで確認。 | 6h | E2E 主要 6 シナリオ PASS（MSW→server 切替含む）。 |
| SP5 バッファ/報告 | 11/27 06:00-09:00 | DOC_STATUS 反映、証跡ログ更新、ワーカー報告草案。 | 2h | DOC_STATUS 備考に RUN_ID・ログ・アーティファクトを記載し、未完タスクを明示。 |

## 5. 成果物 & 更新先
- ドキュメント: 本ファイルと証跡ログ `docs/server-modernization/phase2/operations/logs/20251124T021734Z-webclient-master-bridge-plan.md`。
- アーティファクト: `artifacts/api-stability/20251124T021734Z/master-sync/`（同期ジョブ結果）を作成予定。
- DOC_STATUS: Webクライアント/連携 行に RUN_ID・ログ・アーティファクトを備考へ追記する（別途更新済み）。
- レポート: ワーカー報告フォーマットに沿い、実施内容・証跡パス・DOC_STATUS 更新行・RUN_ID をセットで報告する。

## 6. リスクと対応
- サーバー REST 未提供のままでは UI フォールバックが継続し警告が常時表示される → `WEB_ORCA_MASTER_SOURCE` フラグと runtime override で即ロールバックできるよう維持。
- 同期ジョブ失敗時のデータ汚染 → 実行前に既存 snapshot を退避し、失敗検知時はロールバック手順をログに従って実施。
- 監査メタ欠落 → fetch レイヤーで強制付与し、契約テストに `dataSource`/`fallbackUsed`/`missingMaster` を追加。

## 7. 次アクション（作業開始前の準備）
- [ ] SP1 設計レビュー用のサマリをログへ下書き（締切: 11/26 09:00 JST）。
- [ ] `bridge-sync` スクリプトの雛形を作成し、Node/tsx 前提でライセンス確認（Python 使用禁止を遵守）。
- [ ] mac-dev ORCA へのスモーク手順（curl）を ORCA 連携手順書通りに再確認し、必要コマンドをログへ記載。
