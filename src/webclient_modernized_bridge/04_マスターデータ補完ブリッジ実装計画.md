# 04_マスターデータ補完ブリッジ実装計画

- RUN_ID: `20251124T000000Z`
- 期間: 2025-11-25 03:00 〜 2025-11-27 03:00 (JST)
- 優先度: Medium / 緊急度: High
- エージェント: gemini cli
- YAML ID: `src/webclient_modernized_bridge/04_マスターデータ補完ブリッジ実装計画.md`
- 参照チェーン: `AGENTS.md` → `docs/web-client/README.md` → `docs/server-modernization/phase2/INDEX.md` → `docs/managerdocs/PHASE2_MANAGER_ASSIGNMENT_OVERVIEW.md` → 本ファイル
- 前提日付: mac-dev 実測 = 2025-11-24 09:00 JST（DNS/TLS/acceptlstv2 スモーク）、最新スナップショット = `artifacts/api-stability/20251124T000000Z/master-snapshots/`（取得 2025-11-24 00:00 UTC）
- 依存資料: `src/webclient_modernized_bridge/03_ギャップ解消方針とUI影響分析.md` / `src/webclient_modernized_bridge/02_ORCAマスターデータギャップ報告精査.md` / `src/webclient_modernized_bridge/02_接続基盤セットアップ（MSW無効化とVITE_DEV_PROXY_TARGET設定）.md` / `artifacts/api-stability/20251124T000000Z/master-snapshots/`
- 証跡ログ: `docs/server-modernization/phase2/operations/logs/20251124T000000Z-webclient-master-bridge-plan.md`

## ゴール
1. ORCA マスターデータ不足（ORCA-05/06/08 中心）に対し、webclient_modernized_bridge 層での補完レイヤー（取得元選択・フォールバック・キャッシュ・監査）の設計を決定する。
2. ORCA 連携手順書（`docs/server-modernization/phase2/operations/ORCA_CONNECTIVITY_VALIDATION.md`）の制約を尊重した運用案を提示し、開発/検証で使用する接続先・手順を固定する。
3. スプリント粒度に分解した実装タスクと所要時間見積り（人時）を更新し、期限 2025-11-27 09:00 (JST) に間に合うロードマップを確定する。

> スコープ明示: 本計画は **クライアント側ブリッジの設計・運用** に限定する。ORCA-05/06/08 の REST 提供などサーバー API の新規実装・追加整備は本ドキュメントの対象外であり、依存事項として扱う（サーバー担当の別タスクで追跡）。

## 前提・制約
- Python スクリプト実行禁止。サーバー側（`server/`）や Legacy 資産（`client/` `common/` `ext_lib/`）は非改変。
- 接続先は `docs/web-client/operations/mac-dev-login.local.md` 記載の開発 ORCA のみ。WebORCA Trial や `curl --cert-type P12` は禁止。
- MSW 無効化・`VITE_DEV_PROXY_TARGET` 設定は `src/webclient_modernized_bridge/02_接続基盤セットアップ（MSW無効化とVITE_DEV_PROXY_TARGET設定）.md` に従う。接続設定変更時は監査メタ `dataSourceTransition` を送出する。
- RUN_ID=`20251124T000000Z` を DOC_STATUS/ログ/証跡で共通利用し、派生 RUN_ID は本値を親として明示する。

## データソース設計（RUN_ID=20251124T000000Z）[^gap][^orca_status][^api_guide]
参照: 監査ポリシー `docs/web-client/process/API_UI_GAP_ANALYSIS.md`、API サーフェス整合 `docs/server-modernization/phase2/operations/MODERNIZED_API_DOCUMENTATION_GUIDE.md`、提供状況 `docs/server-modernization/phase2/operations/ORCA_API_STATUS.md`。
`docs/web-client/process/API_UI_GAP_ANALYSIS.md` の監査ポリシーに沿い、マスターデータ取得は以下の優先順位とフォールバック条件で統一する。ソース決定・切替時は必ず `dataSourceTransition` を送出する。

| 優先 | データソース | 具体例 / パス | 適用範囲 | フォールバック条件 | `dataSourceTransition` 送出トリガ |
| --- | --- | --- | --- | --- | --- |
| 1 | MSW フィクスチャ | `web-client/src/mocks/fixtures/orcaMaster.ts` など | 開発デフォルト（MSW 有効時） | `VITE_DISABLE_MSW=1` 設定、または MSW 健全性チェック失敗時に 2 へ降格 | ① `from=msw` から 2/3 へ降格した瞬間 ② MSW 再有効化で `to=msw` へ復帰した瞬間 |
| 2 | スナップショット | `artifacts/api-stability/20251124T000000Z/master-snapshots/` | MSW 無効時の既定ソース | HTTP 4xx/5xx/timeout、スキーマ検証 NG、`version` 欠落で 3 へ降格 | ① `from=snapshot` から 3 へ降格 ② スナップショット `version`／ファイル名更新検知時（例: `address_404.json` 差し替え） |
| 3 | 固定コード最小セット | bridge 内定数（保険者種別/都道府県コード 等） | 上位が利用不可の最終手段 | なし（終端）。上位復旧で昇格 | ① 2→3 への降格 ② 3→2/1 への昇格を検知した瞬間 |

フォールバック判定は `resolveMasterSource(masterType)` で一元化し、次のいずれかを満たした場合に発火させる。
- 接続エラー: 5xx/timeout/DNS 解決失敗/Basic 認証失敗。
- データ品質: 必須フィールド欠落・スキーマ不一致・`version` 未設定。
- オペレーション: `VITE_DISABLE_MSW=1` または runtime flag で上位ソースを明示的に無効化したとき。

`dataSourceTransition` 監査メタは `{ runId: "20251124T000000Z", masterType, from, to, reason, snapshotVersion }` を最小セットとし、
- 初回ソース決定（cold start）、
- 前回決定値と異なる経路を選択したとき、
- スナップショットの `version`／ファイル名が変わったとき、
- 警告バナー表示状態が変わったとき（表示/非表示）
に送出する。

## 要件[^gap][^orca_status]
参照: 提供状況 `docs/server-modernization/phase2/operations/ORCA_API_STATUS.md`、UI 影響分析 `docs/web-client/process/API_UI_GAP_ANALYSIS.md`。
| ORCA ID | 不足フィールド（サーバー REST 未提供） | 依存 UI/機能 | ブリッジ入力（必須列） | ブリッジ出力/変換 | TTL・更新頻度 |
| --- | --- | --- | --- | --- | --- |
| ORCA-05 薬剤分類・最低薬価・用法・特定器材・検査分類 | `generic_class_code/name`、`youhou_code/name`、`material_code/name/category`、`kensa_sort_code/name`、`min_price`、薬価改定日 | Charts: オーダ候補検索・禁忌チェック、材料単価計算、再計算/請求 | `code` `name` `category` `unit` `minPrice` `youhouCode` `materialCategory` `kensaSort` `validFrom` `validTo` `version` | `dataSource`/`missingMaster`/`fallbackUsed` を付与し、単価欠落時は `unitPrice=null`＋保存ブロック理由を返す。`version` を監査へ透過 | fetch キャッシュ TTL=5分、snapshot TTL=24時間、同期ジョブ（`artifacts/api-stability/20251124T000000Z/master-sync/`）で1日1回差し替え |
| ORCA-06 保険者・住所 | `hokenja_code/name/kubun`、`payer_ratio`、`prefCode` `cityCode` `zip`→住所マップ、住所改定日 | 受付/予約: 資格確認・保険選択、郵便番号→住所補完、患者登録住所入力 | `payerCode` `payerName` `payerType` `payerRatio` `prefCode` `cityCode` `zip` `addressLine` `version` | 空レスポンス時は `fallbackUsed=true` で最小コードセットを返却。住所は `prefCode/cityCode` を JIS で正規化し、フリーテキストは `dataSource=fallback` で監査送出 | 住所キャッシュ TTL=7日、保険者キャッシュ TTL=5分。snapshot 更新は週1（毎週月曜 03:00 JST）で取得・置換 |
| ORCA-08 電子点数表・診療行為区分 (`TBL_ETENSU_1~5`) | `tensu_code` `kubun` `name` `tanka` `unit` `startDate` `endDate` `category` `tensuVersion` | Charts: 病名/算定、Claim 再計算、点数帯検索 | `tensuCode` `name` `kubun` `tanka` `unit` `category` `startDate` `endDate` `tensuVersion` `version` | 返却時に `tensuVersion` を必須付与し、欠損コードは `tensuCodeMissing=true` をセット。MSW→server 切替は `dataSourceTransition` を強制ログ | fetch キャッシュ TTL=5分、MSW フィクスチャは毎日 03:00 JST に CI で再生成。実 API 提供後は日次 03:00 JST で差分取得・適用 |


## 1. 追加取得が必要なマスターデータと補完方針
| マスタ種別 (ORCA ID) | 主要ユースケース | 現状 | 補完レイヤー設計（webclient_modernized_bridge） | 取得手段/エンドポイント案 |
| --- | --- | --- | --- | --- |
| 薬剤分類・最低薬価・用法・特定器材・検査分類 (ORCA-05) | Charts オーダ候補/禁忌/最低薬価チェック | REST 未提供。MSW + snapshot 依存 | (A) `data-source=mock|snapshot` を明示する警告バナーと監査メタ `missingMaster=true` を送出。<br>(B) `masterSourceResolver` で **snapshot → mock → server** の順にフェッチし、単価/用法欠落時は保存ブロック + `audit.logValidationError`。<br>(C) 同期ジョブで snapshot を 1 日 1 回差し替え、UI は `version` を監査へ送出。 | `/orca/master/generic-class` `/generic-price` `/youhou` `/material` `/kensa-sort`（提供時）<br>提供前は `artifacts/api-stability/20251124T000000Z/master-snapshots/` を継続利用。 |
| 保険者・住所 (ORCA-06) | 受付/予約 資格確認・住所補完 | REST 未提供 | (A) 最小コード定数（国保/社保/後期）を bridge 配下に同梱し `data-source=fallback` として監査へ送出。<br>(B) 保険者レスポンスが空の場合はフリーテキスト入力を許容し、送信前に `fallbackUsed=true` を必須ログ。<br>(C) 住所マスタは都道府県/市区町村スナップショットを 7 日 TTL の in-memory キャッシュで保持。 | `/orca/master/hokenja` `/orca/master/address?pref|zip`（提供時）<br>現在は `artifacts/api-stability/20251124T000000Z/master-snapshots/` の空レスポンスを検証用に使用。 |
| 電子点数表・診療行為区分 (ORCA-08) | 病名/算定・Claim 再計算 | REST 未提供、MSW のみ | (A) `WEB_ORCA_MASTER_SOURCE` フラグで MSW→server を段階切替。<br>(B) 取得結果に `tensuVersion` を付与し、算定差異は `audit.logBillingAction` へ `tensuCodeMissing` を送出。<br>(C) サーバー実装前は MSW との差分を契約テストでスナップショット化し、件数乖離時は UI で `warning` トースト。 | `/orca/tensu/ten?min&max&date`（提供時）<br>MSW フィクスチャ: `artifacts/api-stability/20251123T130134Z/schemas/` 継続。 |
| 住所/保険同期ジョブ | スタンドアロン同期で UI 更新 | 未設計 | (A) `bridge-sync` job を npm script で追加し、MSW 無効化 + `VITE_DEV_PROXY_TARGET` 既設定時のみ実行。<br>(B) 実行結果は `artifacts/api-stability/20251124T000000Z/master-sync/` へ保存し、DOC_STATUS 備考にパスを記録。<br>(C) 失敗時はロールバック（前回 snapshot を復旧）手順を明文化。 | `node scripts/bridge-sync`（※実装時は Python 禁止・Node/tsx で） |
| 監査メタ | dataSourceTransition / fallbackUsed / missingMaster | 一部未送出 | (A) fetch フック共通ミドルで強制付与し、画面ごとの audit ロガーへ透過。<br>(B) 切替・再取得時は `audit.logUiState` で `bannerVisible` を送出。 | 監査送出は既存 axios/fetch ラッパーを利用、追加実装はフロントのみ。 |

## 2. 補完レイヤーの構成案
1. **source resolver**: `webclient_modernized_bridge` 配下に `resolveMasterSource(masterType)` を追加し、`env (WEB_ORCA_MASTER_SOURCE)`・runtime flag・API reachability（health check）で `server|snapshot|mock|fallback` を決定。監査フィールド `dataSource`/`dataSourceTransition` を強制付与。
2. **fetch adapter**: masterType 別に `fetchOrcaMaster(masterType, params)` を実装し、server ルートは `/orca/master/*` など REST を呼び、snapshot/mock/fallback はローカル JSON/定数を返す。全経路でスキーマ検証を行い、欠損フィールドは `missingMaster=true` として返却。
3. **cache & versioning**: React Query で TTL=5 分、key=`[orca-master, masterType, version]`。snapshot/sync ジョブは `version` を更新し UI 再取得を促す。localStorage/IndexedDB は使用しない。
4. **validation hooks**: 保存前に `masterRequiredFields` を検証し、欠損時は UI ブロック + `audit.logValidationError` + `warning` バナー。Charts/Reception/Claim で共通ロジックを共有。
5. **observability**: TraceId を fetch レイヤーで拾い、監査/トーストに表示。`docs/web-client/ux/CHART_UI_GUIDE_INDEX.md` のトーン規約に従い `warning`/`danger` を統一。

## 3. ORCA 連携運用案（ORCA_CONNECTIVITY_VALIDATION 順守）
- 接続先: `mac-dev-login.local.md` の mac-dev ORCA のみ。Trial や本番経路は禁止。
- 手順: (1) `VITE_DISABLE_MSW=1` を設定 → (2) `VITE_DEV_PROXY_TARGET` を mac-dev URL へ設定 → (3) `npm run dev` 起動前に `./public/mockServiceWorker.js` を削除確認 → (4) `docs/server-modernization/phase2/operations/ORCA_CONNECTIVITY_VALIDATION.md` §4.3 の curl スモーク（DNS/TLS/acceptlstv2）を実行し、ログに RUN_ID を付与。
- 監査: 取得経路・fallback・警告表示をすべて `audit.logOrcaQuery` / `audit.logUiState` に記録し、データソース切替時は `dataSourceTransition` を必須化。
- 禁止事項: WebORCA Trial へのアクセス、`curl --cert-type P12`、未承認の本番経路利用、Python スクリプト実行。

## 4. スプリント別タスク & 見積り（人時）
| スプリント | 期間 | タスク | 見積り | 完了条件 |
| --- | --- | --- | --- | --- |
| SP1 設計固定 | 11/25 03:00-06:00 | source resolver / fetch adapter の API 面・監査フィールド定義、フラグ仕様確定。 | 3h | 設計メモを本ファイルに反映し、ログへ記録。 |
| SP2 実装（フェッチ/キャッシュ） | 11/25 06:30-11:30 | `resolveMasterSource` 実装、React Query TTL=5 分設定、監査メタ付与、fallback 定数組み込み。 | 5h | `/orca/master/address` スモークで `dataSource=server` 付与が確認できること。 |
| SP3 同期ジョブ & スナップショット更新 | 11/25 12:30-15:30 | `bridge-sync` npm script 追加、結果を `artifacts/api-stability/20251124T000000Z/master-sync/` へ保存、ロールバック手順追記。 | 3h | 1 回目の同期で snapshot が保存され、DOC_STATUS 備考にパスを追記。 |
| SP4 UI 配線・回帰 | 11/26 09:00-15:00 | Charts/Reception/Claim の fetch フックへ組み込み、`warning` バナーと監査送出を E2E/スモークで確認。 | 6h | E2E 主要 6 シナリオ PASS（MSW→server 切替含む）。 |
| SP5 バッファ/報告 | 11/26 15:00-17:00 | DOC_STATUS 反映、証跡ログ更新、ワーカー報告草案。 | 2h | DOC_STATUS 備考に RUN_ID・ログ・アーティファクトを記載し、未完タスクを明示。 |

## 実装ロードマップ（SP1〜SP4 詳細、RUN_ID=20251124T000000Z）[^gap][^api_guide]
参照: タスク分解 `src/webclient_modernized_bridge/03_ギャップ解消方針とUI影響分析.md`、API インターフェース `docs/server-modernization/phase2/operations/MODERNIZED_API_DOCUMENTATION_GUIDE.md`、監査メタ要件 `docs/web-client/process/API_UI_GAP_ANALYSIS.md`。
- 出典: `src/webclient_modernized_bridge/03_ギャップ解消方針とUI影響分析.md` の SP 方針を本計画用に担当/締切/証跡パス付きで具体化。

| スプリント | 担当 | 締切 (JST) | 完了条件 | 証跡パス |
| --- | --- | --- | --- | --- |
| SP1: 型/フィクスチャ整理 | Webクライアント担当（codex） | 2025-11-25 06:00 | `resolveMasterSource`/`fetch adapter` の API 面と監査フィールドを `03_ギャップ解消方針…` に一致させ、本ファイルへ反映。型/フィクスチャ diff を整理しログへ記載。 | `docs/server-modernization/phase2/operations/logs/20251124T000000Z-webclient-bridge.md#SP1` |
| ↳ SP1着手メモ | - | - | 型生成: 2025-11-22 時点のモダナイズ版 `/orca/master/address|insurer|generic-price|use-class` OpenAPI で ts 型を固定。MSW差し替え: `msw/handlers/master/*` を `artifacts/api-stability/20251124T000000Z/master-snapshots/` に揃え `dataSource=snapshot|mock` を返却。必須列バリデーション: code/name/category/validFrom/validTo(+warningFlag) を Zod で検証し欠損は `audit.logValidationError` + 再取得誘導。 | - |
| SP2: ブリッジ実装 | Webクライアント担当（codex） | 2025-11-25 11:30 | React Query TTL=5分設定、fallback 定数組み込み、`dataSource`/`dataSourceTransition` 送出を実装。`/orca/master/address` スモークで `dataSource=server` が確認できること。 | `docs/server-modernization/phase2/operations/logs/20251124T000000Z-webclient-bridge.md#SP2` |
| SP3: 契約テスト | QA（契約テスト担当） | 2025-11-25 16:00 | MSW ↔ 実サーバーのスキーマ差分/件数差分テストが緑。監査メタ `dataSource`/`fallbackUsed`/`missingMaster` が契約テストで検証済み。 | `docs/server-modernization/phase2/operations/logs/20251124T000000Z-webclient-bridge.md#SP3` |
| SP4: 切替準備 | フロント+QA | 2025-11-26 15:00 | Feature flag で MSW↔server を往復し、主要 6 シナリオ E2E PASS。警告バナー/監査メタが UI で表示・送出されること。 | `docs/server-modernization/phase2/operations/logs/20251124T000000Z-webclient-bridge.md#SP4` |

#### SP4 チェックリスト（RUN_ID=20251124T000000Z）
- [ ] runtime flag 切替手順: `.env.local` の `WEB_ORCA_MASTER_SOURCE=mock|snapshot|server` を順番に適用し各切替後に `npm run e2e:smoke -- --runId=20251124T000000Z --tag=master-bridge` を実行、`artifacts/e2e/20251124T000000Z/sp4-runtime-flag.log` に `dataSourceTransition` が記録されることを確認。
- [ ] ロールバック条件: 切替直後に MSW 停止・5xx・スキーマ欠落・ハッシュ DIFF を検知したら即 `WEB_ORCA_MASTER_SOURCE=mock` に戻し、同ログに `dataSource=mock` かつ `fallbackUsed`/`missingMaster` が true で再取得記録されることを確認。
- [ ] server版ハッシュ比較: server 提供後に `artifacts/api-stability/20251124T000000Z/master-sync/<YYYYMMDD>/hashes/server/*.hash` と `.../msw/*.hash` を比較し、結果（許容内/DIFF理由）を `docs/server-modernization/phase2/operations/logs/20251124T000000Z-webclient-bridge.md#SP3` へ貼付。
- [ ] 監査メタ最終確認: Charts/Reception/Claim の主要6シナリオを E2E 実行し、`artifacts/e2e/20251124T000000Z/sp4-main-scenarios.log` に `runId` `apiRoute` `dataSource` `cacheHit` `missingMaster` `fallbackUsed` が空値なく出力され PASS であることを確認。
- [ ] E2E 結果リンク: 上記主要6シナリオログを `docs/server-modernization/phase2/operations/logs/20251124T000000Z-webclient-bridge.md#SP4` に貼付し、FAIL があれば再現手順とチケット ID を併記。
- [ ] Slack 通知テンプレ: `#modernized-webclient` へ「MSW↔server 切替 E2E 完了・監査メタ確認済 / RUN_ID=20251124T000000Z / evidence=artifacts/e2e/20251124T000000Z/sp4-main-scenarios.log / flag=WEB_ORCA_MASTER_SOURCE=server」を送信し、送信ログ/スクショパスを #SP4 に記録。

## 契約テスト観点（SP3ドラフト）
参照: `docs/web-client/ux/API_SURFACE_AND_AUDIT_GUIDE.md`（監査フィールド必須）、`docs/web-client/ux/CHART_UI_GUIDE_INDEX.md`（警告トーン）、`docs/server-modernization/phase2/operations/ORCA_API_STATUS.md`（提供有無の基準）。
- スキーマ差分: MSW と実サーバーのレスポンスを同一 Zod スキーマで検証し、必須キー欠落・型不一致・`version`/`tensuVersion` 欠落を FAIL 判定にする。
- 件数・単価差分: ORCA-05/06/08 それぞれで件数・`tanka|min_price` の総計/中央値/最大値を比較し、閾値超過で WARNING（UI トースト）＋監査 `missingMaster=true` を送出。
- 監査メタ送出: MSW→server 切替時に `dataSourceTransition` が `from=mock|snapshot` → `to=server` で記録されること、`runId=20251124T000000Z` が全イベントに付与されることを契約テストで確認。
- キャッシュ/フォールバック判定: React Query 再取得で `cacheHit` が true→false に遷移すること、空レスポンス時に `missingMaster=true`/`fallbackUsed=true` が上書きされることを UI/監査両方で検証。
- cacheHit 監査確認手順: (1) snapshot 取得直後に同一リクエストを実行し `cacheHit=true` を確認、(2) snapshot を更新（または TTL 超過を模擬）後に再取得し `cacheHit=false` を確認、(3) 強制 refetch で再度 `cacheHit=false` が送出されることを確認。
- snapshot→server 切替監査手順: (1) MSW/mock 有効状態で `dataSource=mock|snapshot` を取得、(2) フラグを server へ切替えて同一リクエストを実行し `dataSourceTransition=mock|snapshot->server` が送出されること、(3) 切替後レスポンスで `missingMaster`/`fallbackUsed` が期待値（空レス時は true、それ以外は false）であることを確認。
- 警告表示: CHART_UI ガイドに従い、件数・単価差分または fallback 発生時に `warning` バナーとトーストが表示されることをスモークで確認（色/トーンはガイド準拠）。
- 証跡保存先: `docs/server-modernization/phase2/operations/logs/20251124T000000Z-webclient-bridge.md#SP3` にテスト結果と差分ハッシュを記録する。

### 契約テスト手順（ORCA-05/06/08 ケース・ハッシュ算出）
- ORCA-05（薬剤分類/最低薬価/用法/特定器材/検査分類）  
  入力ケース: 薬剤コード最小境界（例: `0000001`）、最大境界（例: `9999999`）、`min_price` 欠損、`youhou_code` 未設定、`kensa_sort` 未設定。  
  期待レスポンス: 必須列が充足し、欠損時は `missingMaster=true`＋`fallbackUsed=true`。  
  ハッシュ計算: レスポンス配列を `code` 昇順で安定ソート → 必須フィールド順 `code,name,category,unit,minPrice,youhouCode,materialCategory,kensaSort,validFrom,validTo,version,dataSource,cacheHit,missingMaster,fallbackUsed` に整列 → JSON 文字列化（スペースなし） → `sha256`。  
  保存先: `artifacts/api-stability/20251124T000000Z/master-sync/<YYYYMMDD>/hashes/orca05.hash`。
- ORCA-06（保険者・住所）  
  入力ケース: `prefCode` のみ存在し `cityCode` 欠損、郵便番号だけ指定、保険者コード最小/最大、空レスポンス（想定障害時）。  
  期待レスポンス: 空レスは fallback で最小コードセットを返却し `fallbackUsed=true`、住所欠損時は `missingMaster=true`。  
  ハッシュ計算: `payerCode` 昇順＋`prefCode`/`cityCode` 昇順でソート → フィールド順 `payerCode,payerName,payerType,payerRatio,prefCode,cityCode,zip,addressLine,version,dataSource,cacheHit,missingMaster,fallbackUsed` → JSON 文字列化（改行・スペースなし） → `sha256`。  
  保存先: `artifacts/api-stability/20251124T000000Z/master-sync/<YYYYMMDD>/hashes/orca06.hash`。
- ORCA-08（電子点数表・診療行為区分）  
  入力ケース: 日付フィルタで空ヒット（存在しない期間）、`tensu_code` 最小/最大、`tanka` が 0 または欠損。  
  期待レスポンス: 空ヒット時は空配列＋`cacheHit=false` を返し、`tensuVersion` 欠落は FAIL。  
  ハッシュ計算: `tensuCode` 昇順でソート → フィールド順 `tensuCode,name,kubun,tanka,unit,category,startDate,endDate,tensuVersion,version,dataSource,cacheHit,missingMaster,fallbackUsed` → JSON 文字列化（スペースなし） → `sha256`。  
  保存先: `artifacts/api-stability/20251124T000000Z/master-sync/<YYYYMMDD>/hashes/orca08.hash`。

#### ハッシュファイル配置手順（実行フロー）
1) 入力データ準備: 上記ケースごとに MSW/実サーバーへリクエストを送り、レスポンス JSON を取得（改行・スペース維持）。  
2) レスポンス整形: 各ケースの配列を対象マスターのソートキー（ORCA-05=`code`、ORCA-06=`payerCode`,`prefCode`,`cityCode`、ORCA-08=`tensuCode`）で安定ソートし、必須フィールドだけを抽出してフィールド順を固定。  
3) 文字列化: 抽出後の配列を JSON 文字列化し、インデント・スペースなしのフラット文字列へ統一。  
4) `sha256` 計算: 文字列を入力に `sha256` を計算し、結果ハッシュを `orca05.hash` / `orca06.hash` / `orca08.hash` に書き出す。  
5) 保存パス: `artifacts/api-stability/20251124T000000Z/master-sync/<YYYYMMDD>/hashes/` 配下に配置（<YYYYMMDD> は取得日でディレクトリを分ける）。  
6) 記録: 生成日時・使用入力セット・ハッシュ値を `docs/server-modernization/phase2/operations/logs/20251124T000000Z-webclient-bridge.md#SP3` に追記し、MSW/実サーバーいずれの結果かを明示する。  
7) 再現性: フィールド順とソートキーが一致していない場合は再計算し、ズレ理由を #SP3 に併記する。

#### サーバー提供開始後に実行するハッシュ比較（待ちタスク）
- 状態: server レスポンス提供待ち。提供開始後に下記チェックリストを SP3 で実施する。  
- チェックリスト（順守順）:
  1) 入力取得: MSW と同一入力セットを server 実環境へ送信しレスポンスを取得（改行・スペース維持）。  
  2) 整形: MSW と同じソートキー・フィールド順で配列を整形。  
  3) `sha256` 計算: 整形後の文字列を `sha256` で計算。  
  4) 保存: `artifacts/api-stability/20251124T000000Z/master-sync/<YYYYMMDD>/hashes/server/` に `orca05.hash` / `orca06.hash` / `orca08.hash` を保存。  
  5) 比較: `hashes/msw/*.hash` を基準に server ハッシュを突き合わせ、値一致=PASS、不一致=DIFF とし、DIFF は必須フィールド別の差分件数・最大/中央値差分を算出。  
  6) 許容判定: totalCount ±1% 以内、`tanka|minPrice` の最大差分 1 円以内（税抜）を暫定許容。閾値超過は WARNING とし要因を記録。  
  7) 監査確認: 比較リクエストで `dataSourceTransition=mock|snapshot->server`、`cacheHit` 状態、`missingMaster`/`fallbackUsed` が期待通り送出されているか監査ログで確認。  
  8) 記録: 比較日時・環境(server)・入力セット・ハッシュ一致/DIFF 判定・差分要因・許容/要修正判定・監査ログ確認結果を `docs/server-modernization/phase2/operations/logs/20251124T000000Z-webclient-bridge.md#SP3` に追記。  

#### server版 ↔ MSW 差分記録テンプレ（RUN_ID=20251124T000000Z）
| 実行日時 | 環境 | ハッシュ値 | 件数差 | 単価差 | 許容判定 | diffファイルパス | 監査メタ送出確認結果 |
| --- | --- | --- | --- | --- | --- | --- | --- |
|  |  |  |  |  |  |  |  |

### 付録: CI/同期ジョブ設計（RUN_ID=20251124T000000Z）
| ジョブ名 | 対象データ | 実行時刻 (UTC / JST) | 出力パス | 保持世代 | 失敗時通知 |
| --- | --- | --- | --- | --- | --- |
| 日次スナップショット生成 (MSW・点数表) | MSW フィクスチャ、電子点数表 `TBL_ETENSU_1~5` | 18:00 UTC / 03:00 JST | `artifacts/api-stability/20251124T000000Z/master-sync/<YYYYMMDD>/msw-etensu/` | 7 日分ローテーション（直近 7 世代） | Phase2 Ops Slack `#modernized-webclient`（BOT 通知）、失敗時は managerdocs 連絡網へメール転送 |
| 週次住所コード同期 | 住所マスタ（都道府県/市区町村）、保険者コード補完 | 18:10 UTC / 03:10 JST 毎週月曜 | `artifacts/api-stability/20251124T000000Z/master-sync/<YYYYMMDD>/address/` | 4 週分ローテーション（直近 4 世代） | 上記 Slack チャンネルに WARN、CI サマリを managerdocs 記載のマネージャーへメール |
| 手動リラン（障害復旧用） | 上記いずれか | 随時（実行者ローカル時間） | 同一パスに `<YYYYMMDDHHmm>-rerun/` ディレクトリを追加 | 自動削除しない（復旧証跡として保持） | 実行者が証跡ログに RUN_ID と理由を追記し、Slack で共有 |

### SP1具体タスクリスト（RUN_ID=20251124T000000Z）
- 型生成対象（ORCA-05/06/08 必須列）: 2025-11-22 時点のモダナイズ OpenAPI `/orca/master/address|insurer|generic-price|use-class` を基に `ts` 型を固定し、必須列を以下で統一する。ORCA-05= `code` `name` `category` `unit` `minPrice` `youhouCode` `materialCategory` `kensaSort` `validFrom` `validTo` `version`。ORCA-06= `payerCode` `payerName` `payerType` `payerRatio` `prefCode` `cityCode` `zip` `addressLine` `version`。ORCA-08= `tensuCode` `name` `kubun` `tanka` `unit` `category` `startDate` `endDate` `tensuVersion` `version`。生成スクリプト禁止のため、手動でスキーマを貼り付けて型確定する。
- MSWフィクスチャ差し替え対象: `web-client/src/mocks/fixtures/orcaMaster.ts` と `msw/handlers/master/*` を `artifacts/api-stability/20251124T000000Z/master-snapshots/` に揃え、レスポンスへ `dataSource=snapshot|mock` を必ず付与する。電子点数表は CI 03:00 JST 生成の MSW フィクスチャと同一パスを参照し、保険者・住所は最新 snapshot を優先して差し替える。
- 必須列バリデーションのチェックポイント: Zod で masterType 別スキーマを組み、ORCA-05 は `code/name/category/validFrom/validTo` に加え `minPrice`/`youhouCode`/`materialCategory`/`kensaSort` を必須検証。ORCA-06 は `payerCode/payerName/payerType/payerRatio/prefCode/cityCode/zip/addressLine` を必須とし、欠損時は `fallbackUsed=true`＋保存ブロック。ORCA-08 は `tensuCode/name/kubun/tanka/unit/category/startDate/endDate/tensuVersion` の欠損を `missingMaster=true` として `audit.logValidationError` を送出し、再取得を誘導する。

## 5. 成果物 & 更新先
- ドキュメント: 本ファイルと証跡ログ `docs/server-modernization/phase2/operations/logs/20251124T000000Z-webclient-master-bridge-plan.md`。
- アーティファクト: `artifacts/api-stability/20251124T000000Z/master-sync/`（同期ジョブ結果）を作成予定。
- DOC_STATUS: Webクライアント/連携 行に RUN_ID・ログ・アーティファクトを備考へ追記する（別途更新済み）。
- レポート: ワーカー報告フォーマットに沿い、実施内容・証跡パス・DOC_STATUS 更新行・RUN_ID をセットで報告する。

## 6. リスクと監査計画[^gap][^orca_status][^api_guide]
参照: 監査フィールド必須一覧 `docs/web-client/process/API_UI_GAP_ANALYSIS.md`、API 入出力契約 `docs/server-modernization/phase2/operations/MODERNIZED_API_DOCUMENTATION_GUIDE.md`、提供ステータス `docs/server-modernization/phase2/operations/ORCA_API_STATUS.md`。

| リスク | 検知 | 回避 | テスト観点 | 完了条件 |
| --- | --- | --- | --- | --- |
| スナップショット陳腐化（薬価・住所・点数表の更新漏れ） | `version`/取得日時を監査フィールド強制付与し、UI は CHART_UI_GUIDE トーンの warning バナー＋トーストで表示 | 1 日 1 回差し替え＋7 日 TTL キャッシュ、差分契約テストで件数/ハッシュ比較 | snapshot 更新後 `cacheHit=false`、旧版→再取得で `dataSourceTransition=snapshot->server` 送出 | SP3 契約テストで snapshot→server 遷移が監査メタ付きで送出確認済み、SP4 E2E で warning バナー表示と再取得誘導を確認 |
| 固定コード・定数誤り（保険区分コード、address fallback） | fetch 直後スキーマ検証＋`audit.logValidationError`（`valueBefore/valueAfter` 必須）でブロック | 定数を `webclient_modernized_bridge` に集約し、変更時はコードセット契約テストを必須化 | fallback 経路で `fallbackUsed=true` 送出、禁止コード入力で保存不可 | コードセット契約テスト緑＆固定コードレビュー完了、UI で禁止コード入力が保存不可となることを確認 |
| 監査メタ欠落（runId/actorRole/apiRoute/dataSource/cacheHit/missingMaster/fallbackUsed/valueBefore/valueAfter/evidencePath） | fetch 共通ミドルで付与し、契約テストで必須キー存在を確認 | 新規 fetch を共通ラッパ経由に限定し、UI イベントで `audit.logUiState`/`audit.logValidationError` を必須化 | 各マスター取得・保存・再取得で全フィールド送出、空値は FAIL | 監査メタ必須キーが契約テストで送出確認済み、主要シナリオ E2E の監査ログが空値なしで保存されている |
| API モック乖離・スキーマ破損 | API_SURFACE_AND_AUDIT_GUIDE 準拠契約テストで `missingMaster`/`dataSource`/`apiRoute` を検証し MSW↔server 差分ハッシュ比較 | スプリント開始時スナップショットを `artifacts/api-stability/20251124T000000Z/` に固定し破損時は即ロールバック | MSW→server 切替で UI 警告/監査メタが期待通り遷移 | MSW と server の差分ハッシュ 0 件を確認し、切替 E2E が監査メタ付きで 2 回連続 PASS |
| キャッシュ TTL/無効化不整合 | React Query `cacheTime`/`staleTime` を監査ログに出し再取得時 `cacheHit` 比較 | TTL=5 分固定、強制リロード時は `cacheHit=false` 送出 | snapshot 更新直後の再取得と 5 分経過後再取得で `cacheHit=false` になること | SP3 契約テストで `cacheHit` true→false 遷移が確認でき、SP4 E2E で強制リロード時に `cacheHit=false` ログが残ること |
| ロールバック手順未実施によるデータ汚染 | 同期ジョブ後のハッシュ比較と `evidencePath` ログ出力、失敗時トリガーブロック | 実行前退避と `valueBefore`/`valueAfter` 記録を必須化 | ジョブ失敗時に旧 snapshot へ復旧し、`fallbackUsed=true` と `evidencePath` が残る | SP3 同期/契約テストのドライランでロールバック手順を証跡化し、`fallbackUsed=true` と `evidencePath` がログに残ることを確認 |

### 監査メタ実装メモ（SP2 設計反映）
- `dataSourceTransition`: 層=source resolver（fetch adapter 入口）。`from/to/reason` を決定し、cold start と前回決定値からの変化時のみ送出。UI 側のフラグ切替（MSW 有効化など）でも同 resolver を通すことで一元送出。
- `dataSource` / `apiRoute`: 層=fetch adapter。HTTP 実リクエスト成功時は必ず送出し、React Query の `isFetching`→`isSuccess` で最新値を上書き。cache hit 時も adapter が `cacheHit=true` を付けた状態で監査へ透過させる（ネットワーク不発でも送出）。
- `cacheHit`: 層=fetch adapter。取得直後に React Query の `isStale`/`isCached` から判定し、キャッシュ命中返却時は `cacheHit=true` で送出。強制 refetch または TTL 超過時は `cacheHit=false` を送出するのが期待値。
- `fallbackUsed`: 層=source resolver（サーバー→snapshot/定数へ降格した瞬間に true）、merge 層（空レスポンスに対し fallback データをマージした場合に true へ上書き）。送出タイミングはフォールバック選択時および保存前検証で fallback データが残存している場合。
- `missingMaster`: 層=merge（スキーマ検証結果）、UI（保存前バリデーション）。必須フィールド欠落を検知したタイミングで true をセットし送出。fetch 成功でも必須欠落なら true、フォールバックでも欠落解消済みなら false を再送出。
- 送出タイミングまとめ: fetch 成功時は `dataSource`/`apiRoute`/`cacheHit`/`missingMaster`（検証結果）を送出、フォールバック時は追加で `dataSourceTransition`/`fallbackUsed` をセット、キャッシュ命中返却時は `cacheHit=true` を強制し再送出（UI はバナー表示更新のみ）。

[^gap]: `docs/web-client/process/API_UI_GAP_ANALYSIS.md`
[^orca_status]: `docs/server-modernization/phase2/operations/ORCA_API_STATUS.md`
[^api_guide]: `docs/server-modernization/phase2/operations/MODERNIZED_API_DOCUMENTATION_GUIDE.md`

## 7. 次アクション（作業開始前の準備）
- [ ] SP1 設計レビュー用のサマリをログへ下書き（締切: 11/25 06:30 JST）。
- [ ] `bridge-sync` スクリプトの雛形を作成し、Node/tsx 前提でライセンス確認（Python 使用禁止を遵守）。
- [ ] mac-dev ORCA へのスモーク手順（curl）を ORCA 連携手順書通りに再確認し、必要コマンドをログへ記載。
