# 04_マスターデータ補完ブリッジ実装計画 test

- RUN_ID: `20251124T073245Z`
- 親RUN_ID: `20251124T000000Z`（スナップショット基線・証跡・データ取得は親 RUN を継続利用）
- 期間: 2025-11-25 03:00 〜 2025-11-27 03:00 (JST)
- 優先度: Medium / 緊急度: High
- エージェント: Codex
- YAML ID: `src/webclient_modernized_bridge/04_マスターデータ補完ブリッジ実装計画.md`
- 参照チェーン: `AGENTS.md` → `docs/web-client/README.md` → `docs/server-modernization/phase2/INDEX.md` → `docs/managerdocs/PHASE2_MANAGER_ASSIGNMENT_OVERVIEW.md` → 本ファイル
- 前提: mac-dev 実測 (DNS/TLS/acceptlstv2 スモーク) 2025-11-24 09:00 JST、最新スナップショット `artifacts/api-stability/20251124T000000Z/master-snapshots/`
- 依存: `03_ギャップ解消方針とUI影響.md` / `02_ORCAマスターデータギャップ報告精査.md` / `02_接続基盤セットアップ（MSW無効化とVITE_DEV_PROXY_TARGET設定）.md` / `artifacts/api-stability/20251124T000000Z/master-snapshots/`
- 証跡ログ: `docs/server-modernization/phase2/operations/logs/20251124T000000Z-webclient-master-bridge-plan.md`（親RUN） / `docs/server-modernization/phase2/operations/logs/20251124T073245Z-webclient-master-bridge.md`（本RUN）

## ゴール
1. ORCA マスターデータ不足（ORCA-05/06/08）に対し、webclient_modernized_bridge 層での補完レイヤー（取得・選択・フォールバック・キャッシュ・監査）の設計を決定する。
2. ORCA 連携手順（`docs/server-modernization/phase2/operations/ORCA_CONNECTIVITY_VALIDATION.md`）の制約を尊重した運用案を提示し、開発/検証で使用する接続先・手順を固定する。
3. スプリント粒度で実装タスクと見積り（人時）を更新し、期限 2025-11-27 09:00 (JST) までに間に合うロードマップを確定する。

## 前提・制約
- Python スクリプト実行禁止。`server/` 配下・Legacy 資産（`client/` `common/` `ext_lib/`）は非改変。
- 接続先は `docs/web-client/operations/mac-dev-login.local.md` 記載の mac-dev ORCA のみ。WebORCA Trial や `curl --cert-type P12` は禁止。
- MSW 無効化と `VITE_DEV_PROXY_TARGET` 設定は `02_接続基盤セットアップ...md` に従う。接続設定変更時は監査メタ `dataSourceTransition` を送信。
- RUN_ID=`20251124T073245Z` を DOC_STATUS/ログ/証跡で共通利用し、派生 RUN_ID は本値を親として明示。

## データソース設計（RUN_ID=20251124T073245Z）
`docs/web-client/process/API_UI_GAP_ANALYSIS.md` の監査ポリシーに従い、取得ソースとフォールバックを統一する。

| 優先 | データソース | 具体例/パス | 適用範囲 | フォールバック条件 | `dataSourceTransition` トリガ |
| --- | --- | --- | --- | --- | --- |
| 1 | MSW フィクスチャ | `web-client/src/mocks/fixtures/orcaMaster.ts` 等 | 開発デフォルト（MSW 有効時） | `VITE_DISABLE_MSW=1` または MSW 健全性チェック失敗で 2 に降格 | MSW → snapshot/fallback への降格、MSW 再有効化で復帰 |
| 2 | スナップショット | `artifacts/api-stability/20251124T000000Z/master-snapshots/` | MSW 無効時の既定ソース | HTTP 4xx/5xx/timeout、スキーマ検証 NG、`version` 欠落で 3 に降格 | snapshot → fallback への降格、snapshot `version` 更新検知 |
| 3 | 固定コード最小セット | bridge 配下の定数（保険者区分/都道府県コードなど） | 上位が利用不可の最終手段 | なし（終端）。上位復旧で昇格 | fallback への降格/復帰 |

## 要件（ORCA_API_STATUS 準拠）
| ORCA ID | 不足フィールド（旧 REST 未提供） | 依存 UI/機能 | ブリッジ入力 | ブリッジ出力 | TTL/更新頻度 |
| --- | --- | --- | --- | --- | --- |
| ORCA-05 薬剤/最低薬価/用法/特定器材/検査区分 | generic_class_code/name、youhou_code/name、material_code/name/category、kensa_sort_code/name、min_price、薬価改定日 | Charts: オーダ候補検索・禁忌チェック、材料単価計算、請求 | `code` `name` `category` `unit` `minPrice` `youhouCode` `materialCategory` `kensaSort` `validFrom` `validTo` `version` | `dataSource`/`missingMaster`/`fallbackUsed` を付与し、単価欠落時は `unitPrice=null` で保存ブロック + 監査。`version` を透過 | fetch TTL=5分、snapshot TTL=24時間、同期ジョブで1日1回差し替え |
| ORCA-06 保険者/住所 | hokenja_code/name/kubun、payer_ratio、prefCode/cityCode/zip→住所マップ、改定日 | 受診/予診の保険選択・住所補完 | `payerCode` `payerName` `payerType` `payerRatio` `prefCode` `cityCode` `zip` `addressLine` `version` | 空レスポンス時は `fallbackUsed=true` で最小コードセット返却。住所は JIS で正規化し `dataSource=fallback` を監査送信 | 住所キャッシュ TTL=7日、保険者キャッシュ TTL=5分、snapshot 更新は週1（毎週月曜 03:00 JST） |
| ORCA-08 電子点数表/診療行為区分 (TBL_ETENSU_1~5) | tensu_code/kubun/name/tanka/unit/startDate/endDate/category/tensuVersion | Charts: 計算/算定、Claim 再計算、点数帯検索 | `tensuCode` `name` `kubun` `tanka` `unit` `category` `startDate` `endDate` `tensuVersion` `version` | 返却時に `tensuVersion` を付与し、欠損コードは `tensuCodeMissing=true`。MSW→server 遷移時は `dataSourceTransition` を強制ログ | fetch TTL=5分。MSW フィクスチャは毎日 03:00 JST CI 再生成。API 提供後は日次 03:00 JST で差し替え適用 |

## 追加取得が必要なマスタと補完方針
| マスタ種別 (ORCA ID) | 主要ユースケース | 現状 | 補完レイヤー設計 | 取得手段/エンドポイント |
| --- | --- | --- | --- | --- |
| ORCA-05 薬剤/最低薬価/用法/特定器材/検査区分 | Charts オーダ候補・禁忌・最低薬価チェック | REST 未提供（MSW + snapshot 依存） | (A) `data-source=mock|snapshot` を表示する警告バナー + `missingMaster=true` を監査送信 (B) `masterSourceResolver` で snapshot↔mock↔server を順次フェッチし、単価/用法欠落時は保存ブロック + `audit.logValidationError` (C) 同期ジョブで snapshot を日次差し替え、UI は `version` を監査へ送信 | `/orca/master/generic-class` `/generic-price` `/youhou` `/material` `/kensa-sort`（提供後）提供前は snapshot 継続 |
| ORCA-06 保険者/住所 | 受診/予診の保険確認・住所補完 | REST 未提供 | (A) 最小コード定数（国保/社保/後期高齢）を bridge に同梱し `data-source=fallback` で監査送信 (B) 保険者レスポンスが空の場合はフリーテキスト入力を許容し、送信前に `fallbackUsed=true` をログ (C) 住所マスタは都道府県/市区町村スナップショットを 7 日 TTL の in-memory キャッシュで保持 | `/orca/master/hokenja` `/orca/master/address?pref|zip`（提供後）現状は snapshot の空レスポンスで検証 |
| ORCA-08 電子点数表/診療行為 | 病名/算定、Claim 再計算 | REST 未提供（MSW のみ） | (A) `WEB_ORCA_MASTER_SOURCE` フラグで MSW→server を段階切替 (B) 取得結果に `tensuVersion` を付与し、算定差異は `audit.logBillingAction` で `tensuCodeMissing` を送信 (C) サーバ提供後は MSW との差分ハッシュを日次比較し、件数乖離時は UI で `warning` トースト | `/orca/tensu/ten?min&max&date`（提供後）MSW フィクスチャ: `artifacts/api-stability/20251123T130134Z/schemas/` |
| 住所/保険 同期ジョブ | スタンドアロン同期で UI 更新 | 未実装 | (A) `bridge-sync` npm script を追加（MSW 無効 + `VITE_DEV_PROXY_TARGET` 設定時のみ実行） (B) 実行結果は `artifacts/api-stability/20251124T000000Z/master-sync/` へ保存し、DOC_STATUS 備考にパス記録 (C) 失敗時はロールバック手順で直前 snapshot を復旧 | `node scripts/bridge-sync`（Python 禁止・Node/tsx 前提） |
| 監査メタ | dataSourceTransition / fallbackUsed / missingMaster | 一部未送信 | (A) fetch フック共通ミドルで強制付与し、画面ごとの audit ロガーへ透過 (B) 取得・再取得時は `audit.logUiState` で `bannerVisible` を送信 | 監査送信は既存 axios/fetch ラッパーを利用（追加実装はフロントのみ） |

## 補完レイヤーの構成
1. **source resolver**: `resolveMasterSource(masterType)` を追加し、`WEB_ORCA_MASTER_SOURCE` / runtime flag / reachability / health check から `server|snapshot|mock|fallback` を決定。`dataSource`/`dataSourceTransition` を強制付与。
2. **fetch adapter**: `fetchOrcaMaster(masterType, params)` で server `/orca/master/*` を呼び、snapshot/mock/fallback はローカル JSON/定数を返却。全経路でスキーマ検証し、欠損は `missingMaster=true` として返却。
3. **cache & versioning**: React Query TTL=5分、key=`[orca-master, masterType, version]`。snapshot/sync ジョブで `version` を更新し UI 再取得を誘導。localStorage/IndexedDB は使用しない。
4. **validation hooks**: 保存前に `masterRequiredFields` を検証し、欠損時は UI ブロック + `audit.logValidationError` + `warning` バナー。Charts/Reception/Claim で共通化。
5. **observability**: fetch レイヤーで TraceId を拾い監査/トーストに表示。`docs/web-client/ux/legacy/CHART_UI_GUIDE_INDEX.md` のトーン規約に従い warning/danger を統一。

## ORCA 連携運用案（ORCA_CONNECTIVITY_VALIDATION 準拠）
- 接続: mac-dev ORCA のみ。Trial・本番経路は禁止。
- 手順: ① `VITE_DISABLE_MSW=1` 設定 ② `VITE_DEV_PROXY_TARGET` を mac-dev に設定 ③ `npm run dev` 前に `./public/mockServiceWorker.js` を削除 ④ `ORCA_CONNECTIVITY_VALIDATION.md` §4.3 の curl（DNS/TLS/acceptlstv2）を実行しログに RUN_ID を付与。
- 監査: 取得経路・fallback・警告表示を `audit.logOrcaQuery` / `audit.logUiState` に記録し、データソース遷移時は `dataSourceTransition` を送信。
- 禁止: WebORCA Trial、`curl --cert-type P12`、未承認の本番経路、Python スクリプト実行。

## スプリント別タスク & 見積り（人時）
| スプリント | 期間 | タスク | 見積り | 完了条件 |
| --- | --- | --- | --- | --- |
| SP1 設計固め | 11/26 09:00-12:00 | source resolver / fetch adapter の API 面・監査フィールド定義、フラグ仕様確定 | 3h | 設計メモを本ファイルに反映し、ログへ記録 |
| SP2 実装（fetch/cache） | 11/26 13:00-18:00 | `resolveMasterSource` 実装、React Query TTL=5分設定、監査メタ付与、fallback 定数組み込み | 5h | `/orca/master/address` スモークで `dataSource=server` 付与が確認できること |
| SP3 同期ジョブ & スナップショット更新 | 11/26 19:00-22:00 | `bridge-sync` npm script 追加、結果を `artifacts/api-stability/20251124T000000Z/master-sync/` へ保存、ロールバック手順記載 | 3h | 初回同期で snapshot 保存、DOC_STATUS 備考にパスを追記 |
| SP4 UI 配線 & 回帰 | 11/27 00:00-06:00 | Charts/Reception/Claim の fetch フックへ組み込み、warning バナーと監査送信を E2E/スモークで確認 | 6h | 主要6シナリオ E2E PASS（MSW→server 切替含む） |
| SP5 バッファ/報告 | 11/27 06:00-09:00 | DOC_STATUS 反映、証跡ログ更新、ワーカー報告草案 | 2h | DOC_STATUS 備考に RUN_ID・ログ・アーティファクトを記載し、未完タスクを明示 |

## 実装ロードマップ（SP1〜SP4 詳細、RUN_ID=20251124T073245Z）
- SP1: 型/フィクスチャ整備。モダナイズ側 OpenAPI に合わせて ts 型を固定し、MSW フィクスチャを snapshot と同期。監査必須キー: code/name/category/validFrom/validTo(+warningFlag)。
- SP2: ブリッジ実装。React Query TTL=5分、fallback 定数組み込み、`dataSource`/`dataSourceTransition` 送信を実装。`/orca/master/address` スモークで `dataSource=server` を確認。
- SP3: 契約テスト。MSW vs server のスキーマ/件数差分を比較し、`dataSource`/`fallbackUsed`/`missingMaster` を契約テストで検証。
- SP4: 切替準備。feature flag で MSW↔server を往復し、主要6シナリオ E2E PASS。warning バナー/監査メタが UI で表示・送信されること。

## 現状報告（RUN_ID=20251124T073245Z 反映）
- SP3: `node scripts/bridge-sync.mjs --run-id 20251124T073245Z --date 20251124 --source server` 実行で `artifacts/api-stability/20251124T000000Z/master-sync/20251124/hashes/{msw,server}` を更新。`diffs/server-vs-msw-orca05.json` で ORCA-05 件数差 (MSW=5→server=4) を確認し、`missingMaster=false`/`fallbackUsed=false`/`dataSource=snapshot` を監査記録（ログ `...#SP3`）。
- SP4: `fetchWithResolver` と `OrcaMasterFetchOptions` に runId/snapshotVersion を付与し、`app/App.tsx` で `ORCA_MASTER_FETCH_TTL_MS` (5分) を同期。Charts/Reception/Claim に `fetchOrca05/06/08 BridgeMasters` を配線し、warning バナー/監査メタ付きの E2E 候補を `artifacts/e2e/20251124T073245Z/sp4-main-scenarios.log` に記録（ログ `...#SP4`）。
- DOC_STATUS: `docs/web-client/planning/phase2/DOC_STATUS.md:65` に RUN_ID・bridge-sync/MSW+server ハッシュ・`artifacts/e2e/20251124T073245Z/` E2Eログ・`PHASE2_WEB_CLIENT_EXPERIENCE_MANAGER_CHECKLIST.md` 連携・未完タスクを記載。
- 追加確認: `web-client/.env.sample` など未追跡ファイルとの整合性変化なし（更新はログ・DOC_STATUS・ハッシュ関連に限定）。
- server-modernized: `/resources/api/orca/master/{generic-class,generic-price,youhou,material,kensa-sort,hokenja,address,etensu}` スタブ（Basic 認証）を追加し、`dataSource=server/runId=20251124T073245Z/version=20251124` で 200/JSON を返却。docker-compose.modernized.dev を再ビルド/デプロイ（MODERNIZED_APP_HTTP_PORT=8000）し、curl で各パス 200 を確認済み。
- ドキュメント更新: `docs/server-modernization/phase2/operations/logs/20251124T073245Z-orca-master-server.md` `docs/server-modernization/phase2/operations/ORCA_API_STATUS.md` `docs/server-modernization/phase2/operations/MODERNIZED_API_DOCUMENTATION_GUIDE.md` に 200/JSON 状態・認証ヘッダー・期待スキーマ・RUN_ID を追記。
- 懸念: 現状レスポンスは固定スタブで ORCA DB 連携と動的フィルタは未実装。bridge/E2E で dataSource=server 監査メタを確認後、実データ接続への差し替え実装を検討。
- RUN_ID=`20251126T150000Z`: server stub now loads artifacts/api-stability/20251124T000000Z/master-snapshots/ (msw-fixture fallback) for `/orca/master/*`, emits `dataSourceTransition=server->snapshot|server->msw-fixture|server->fallback`, and records `missingMaster`/`fallbackUsed`. Admin `d_facility`/`d_users` seed + header auth allowed `generic-class`〜`etensu` to hit Stage Preview (`VITE_DISABLE_MSW=1 VITE_DEV_PROXY_TARGET=http://localhost:8000/openDolphin/resources VITE_API_BASE_URL=http://localhost:8000/openDolphin/resources VITE_DEV_USE_HTTPS=1 npm run preview -- --host 0.0.0.0 --port 4173 --strictPort`) and Playwright (`RUN_ID=20251126T150000Z VITE_DISABLE_MSW=1 VITE_DEV_PROXY_TARGET=http://localhost:8000/openDolphin/resources VITE_API_BASE_URL=http://localhost:8000/openDolphin/resources PLAYWRIGHT_BASE_URL=https://localhost:4173 npx playwright test tests/e2e/orca-master.spec.ts`). Stage Preview, Playwright, and the `curl` cycle were rerun in the same session; `artifacts/e2e/20251126T150000Z/{stage-preview.log,playwright-orca-master.log,master-bridge-stub-check.log}` now capture Reception/Claim `warning banner tone=server`/`dataSourceTransition=server`, Playwright’s 1 pass + 8 skip Live profile `dataSource=server/runId=20251126T150000Z/missingMaster=false/fallbackUsed=false`, and eight `curl` responses returning `dataSourceTransition=server->fallback`/`missingMaster=true`/`fallbackUsed=true`/`runId=20251126T150000Z`/`version=20251126`/`cacheHit=false`/`HTTP_STATUS:200`.<br/>`node scripts/bridge-sync.mjs --run-id 20251126T150000Z --date 20251124 --source server` was rerun after that coverage cycle, overwriting `artifacts/api-stability/20251124T000000Z/master-sync/20251124/hashes/server/{orca05.hash,orca06.hash,orca08.hash}` and `diffs/server-vs-msw-orca*.json`, while preserving `schema missing: artifacts/api-stability/20251124T151500Z/ab-compare/20251124T153000Z/raw/B/orca-master-generic-class.json` plus `auditSummary` (`serverDataSource=snapshot`/`serverMissingMaster=false`/`serverFallbackUsed=false`); DOC_STATUS 65 行・このチェックリスト 55 行・worker report RUN_ID セクション have been updated to reference these outputs alongside `artifacts/e2e/20251126T150000Z/*`/`warning banner tone=server` events.<br/>`npm run build`（`orca-api.ts` 型整備・`AlertBanner` 定義整理・`HttpHandlerMethod.resolver` 保護・React Query `cacheTime`→`gcTime`）succeeded after the TypeScript fixes, and the new `dist` was consumed by the Stage/Preview + Playwright + `curl` verification cycle (`docs/server-modernization/phase2/notes/issue-master-bridge-build.md` has the full trace). `mvn -pl server-modernized -DskipTests compile` also succeeded because `UserModel#getRegisteredDateAsString` is back, so the Modernized runtime can keep serving `/resources/api/orca/master/*`.<br/>Next actions: (1) keep raw B → bridge-sync → hashes/diffs → DOC_STATUS/manager checklist/worker report loops running and rewrite the `artifacts/api-stability/20251124T000000Z/master-sync/20251124/` hashes/diffs every time `dataSourceTransition=server`/`missingMaster` moves toward the server route, (2) continue revalidating Reception/Claim Live coverage with `warning banner tone=server` + `dataSourceTransition=server` through Stage/Playwright/curl and overwrite `artifacts/e2e/20251126T150000Z/*`, (3) repeat `npm run build` → Stage Preview → Playwright → curl after any further TypeScript or UserModel changes so `dist`/logs stay aligned.

## 次のアクション（RUN_ID=20251124T073245Z）
1. server raw B の更新確認後、`node scripts/bridge-sync.mjs --run-id 20251124T073245Z --date 20251124 --source server` を再実行し、`hashes/server/` と `diffs/server-vs-msw-orca*.json` を上書き。差分があれば `missingMaster`/`fallbackUsed`/`cacheHit` の変化を `...#SP3` と DOC_STATUS 行に追記し、manager checklist へ通知。
2. `WEB_ORCA_MASTER_SOURCE=server` + `VITE_DISABLE_MSW=1` の Stage/Preview で `npm run e2e:orca-master` を再実行し、Playwright ログ（runId/dataSource/cacheHit/missingMaster/fallbackUsed）を `artifacts/e2e/20251124T073245Z/` に残す。結果・警告・再現手順を `...#SP4` に追記し、DOC_STATUS 65 行と manager checklist RUN_ID セクションにリンクを追加。
3. ワーカー報告を final 形式で整備（`docs/server-modernization/phase2/notes/worker-report-master-bridge-20251124T073245Z.md`）。`docs/web-client/README.md`・`docs/web-client/planning/phase2/DOC_STATUS.md:65`・`docs/managerdocs/PHASE2_WEB_CLIENT_EXPERIENCE_MANAGER_CHECKLIST.md` の RUN_ID 行を同期（RUN_ID/ログ/アーティファクト/未完タスク/次アクションを統一）。
4. 再検証テンプレ: raw B 更新（ORCA 特材など）を感知したら `node scripts/bridge-sync.mjs --run-id 20251126T150000Z --date 20251124 --source server` で `artifacts/api-stability/20251124T000000Z/master-sync/20251124/hashes/server/{orca05.hash,orca06.hash,orca08.hash}` と `diffs/server-vs-msw-orca*.json` を上書きし `schema missing: artifacts/api-stability/20251124T151500Z/ab-compare/20251124T153000Z/raw/B/orca-master-generic-class.json` を確認、Stage Preview/Playwright/curl を同 RUN_ID で回して `dataSourceTransition=server` ルートの変化を追跡する。Stage Preview: `VITE_DISABLE_MSW=1 VITE_DEV_PROXY_TARGET=http://localhost:8000/openDolphin/resources VITE_API_BASE_URL=http://localhost:8000/openDolphin/resources VITE_DEV_USE_HTTPS=1 npm run preview -- --host 0.0.0.0 --port 4173 --strictPort` で `artifacts/e2e/20251126T150000Z/stage-preview.log` を上書きし `warning banner tone=server`/`dataSourceTransition=server` を確認、Playwright: `RUN_ID=20251126T150000Z VITE_DISABLE_MSW=1 VITE_DEV_PROXY_TARGET=http://localhost:8000/openDolphin/resources VITE_API_BASE_URL=http://localhost:8000/openDolphin/resources PLAYWRIGHT_BASE_URL=https://localhost:4173 npx playwright test tests/e2e/orca-master.spec.ts` で `artifacts/e2e/20251126T150000Z/playwright-orca-master.log` に Live profile `dataSource=server/runId=20251126T150000Z/missingMaster=false/fallbackUsed=false` + `warning banner tone=server`/`dataSourceTransition=server` を記録、(5) curl: admin header + eight endpoints `/resources/api/orca/master/{generic-class,generic-price,youhou,material,kensa-sort,hokenja,address,etensu}` を `master-bridge-stub-check` で叩いて `dataSourceTransition=server->fallback`/`missingMaster=true`/`fallbackUsed=true`/`runId=20251126T150000Z`/`version=20251126`/`cacheHit=false`/`warning banner tone=server` を `artifacts/e2e/20251126T150000Z/master-bridge-stub-check.log` へ記録し Stage log と照合。各サイクルの RUN_ID・`artifacts/api-stability/20251124T000000Z/master-sync/20251124/hashes/server/{orca05.hash,orca06.hash,orca08.hash}`・`diffs/server-vs-msw-orca*.json`・`artifacts/e2e/20251126T150000Z/{stage-preview.log,playwright-orca-master.log,master-bridge-stub-check.log}` を DOC_STATUS・manager checklist・worker report・issue note へ反映し続ける。現段階では raw B 更新を追いかけず document 校正・証跡整理を優先し、次の raw B 更新トリガーが来たら本テンプレで再走することを明記。

## 接続断ループ運用（Stage/Live 再接続前）
| フェーズ | 内容 | 証跡パス | 監査メタ観点 |
| --- | --- | --- | --- |
| 1. 全クライアント停止 | Stage/Live 接続前に全 Web クライアント停止（Vite/Playwright + Stage/Live 接続）し raw B 停止を確認 | `docs/server-modernization/phase2/operations/logs/20251124T073245Z-webclient-master-bridge.md#SP3` | `dataSourceTransition`（snapshot|msw → server）が接続を跨いで発生しないか検証 |
| 2. raw B 差分確認 | `artifacts/api-stability/20251124T151500Z/ab-compare/.../raw/B/` を確認し新規 diff を採取 | 同 + `.../20251124T153000Z/raw/B/` | `missingMaster`/`fallbackUsed` が true→false に変わるかログ確認 |
| 3. bridge-sync 実行 | 全停止中に `node scripts/bridge-sync.mjs --run-id 20251124T073245Z --date 20251124 --source server` を実行し、`hashes/server/`・`diffs/server-vs-msw-orca*.json` を更新 | `artifacts/api-stability/20251124T000000Z/master-sync/20251124/`（hashes/diffs） | `dataSource`/`cacheHit`：snapshot→server 遷移値と cache miss→hit の遷移を比較 |
| 4. hash/diff 上書き & schema 再確認 | `hashes/server/{orca05,orca06,orca08}.hash` を上書きし、schema missing を含む diff を `...#SP3` に連携 | 同 + `schema missing: .../raw/B/orca-master-generic-class.json` | `missingMaster`/`cacheHit`: schema missing 時に `missingMaster`=true になるか収集 |
| 5. DOC_STATUS / 管理ドキュメント同期 | DOC_STATUS（Webクライアント連携行）、manager checklist RUN_ID 行、worker report に `hashes`・`diffs`・`artifacts/e2e/20251124T073245Z/sp4-main-scenarios.log` を追記 | `docs/web-client/planning/phase2/DOC_STATUS.md:65` / `docs/managerdocs/PHASE2_WEB_CLIENT_EXPERIENCE_MANAGER_CHECKLIST.md` / `docs/server-modernization/phase2/notes/worker-report-master-bridge-20251124T073245Z.md` | `fallbackUsed` が true→false でホップした事例を記録 |
| 6. Stage/Live 再接続 + E2E 実行 | 再接続後に Stage/Live E2E（warning banner tone + dataSourceTransition）を実行し `artifacts/e2e/20251124T073245Z/sp4-main-scenarios.log` を上書き | 同 / `...#SP4` | `dataSourceTransition`/`warning banner tone`：snapshot→server 再接続時のトーン変化と記録を比較 |

## リスクと監査計画
| リスク | 検知 | 回避 | テスト観点 | 完了条件 |
| --- | --- | --- | --- | --- |
| スナップショット陳腐化 | `version`/取得日時を監査フィールド強制付与し、UI は warning バナー/トーストで表示 | 日次差し替え＋5分 TTL キャッシュ、差分テストで件数/ハッシュ比較 | snapshot 更新直後の再取得で `dataSourceTransition=snapshot->server` を送信 | 差分テスト緑＋E2E で warning バナー表示と再取得誘導を確認 |
| 固定コード/定数誤り（保険区分、address fallback） | fetch 直後スキーマ検証＋`audit.logValidationError`（valueBefore/valueAfter）でブロック | 定数は bridge 配下に明示し、変更時はコードセット契約テストを実施 | fallback 経路で `fallbackUsed=true` を送信、禁止コード入力で保存不可 | コードセット契約テスト緑、UI で禁止コード入力が保存不可になること |
| 監査メタ欠落（runId/apiRoute/dataSource/cacheHit/missingMaster/fallbackUsed など） | fetch 共通ミドルで付与し、契約テストで必須キー存在を確認 | 新 fetch は共通ラッパ経由に限定、UI イベントで `audit.logUiState`/`audit.logValidationError` を明示送信 | 取得/保存/再取得で全フィールド送信し空値なし | 契約テスト＋主要シナリオ E2E の監査ログに欠落なし |
| API モデル乖離・スキーマ破損 | API_SURFACE_AND_AUDIT_GUIDE 準拠の契約テストで `missingMaster`/`dataSource`/`apiRoute` を検証、MSW vs server 差分を比較 | スプリント開始時 snapshot を固定し、破損時は即ロールバック | MSW→server 切替で UI 警告/監査メタが期待通り遷移 | MSW と server の差分 0 件、切替 E2E が監査メタ付きで連続 PASS |
| キャッシュ TTL/無効化不整合 | React Query `cacheTime`/`staleTime` を監査ログに出し、取得時 `cacheHit` を比較 | TTL=5分、強制リロード時は `cacheHit=false` を送信 | snapshot 更新直後と 5分経過後の取得で `cacheHit=false` になること | 契約テストで `cacheHit` true→false 遷移確認、E2E で強制リロード時 `cacheHit=false` ログを確認 |
| ロールバック手順未実施によるデータ汚染 | 同期ジョブ後のハッシュ比較と `evidencePath` ログ出力、失敗時トリガーブロック | 実行前退避と `valueBefore`/`valueAfter` 記録を徹底 | ジョブ失敗時に旧 snapshot へ復旧し、`fallbackUsed=true` と `evidencePath` を残す | 同期/契約テストのドライランでロールバック手順を証跡化し、`fallbackUsed=true` と `evidencePath` がログに残ること |

## 監査メタ実装メモ（SP2 設計反映）
- `dataSourceTransition`: source resolver/fetch adapter 入口。`from/to/reason` を決定し、cold start と前回決定値からの変化時のみ送信。UI フラグ操作（MSW 有効化など）も同 resolver を通す。
- `dataSource` / `apiRoute`: fetch adapter で HTTP リクエスト成功時に送信し、React Query `isSuccess` で最新値を上書き。cache hit 時も `cacheHit=true` を付けたまま監査へ透過（ネットワーク不発でも送信）。
- `cacheHit`: fetch adapter。取得直後に React Query `isStale`/`isCached` から判定し、キャッシュ命中返却時は `cacheHit=true` を送信。強制 refetch や TTL 越え時は `cacheHit=false` を送信するのが期待。
- `fallbackUsed`: source resolver でサーバ→snapshot/定数へ降格した瞬間に true。merge 層で空レスポンスへ fallback データをマージした場合も true へ上書き。送信はフォールバック選択時および保存前検証で fallback データが残存する場合。
- `missingMaster`: merge 層（スキーマ検証結果）、UI（保存前バリデーション）。必須フィールド欠落を検知したタイミングで true を設定し送信。fetch 成功でも欠落なら true、フォールバックで解消済みなら false。
- 送信タイミングまとめ: fetch 成功時に `dataSource`/`apiRoute`/`cacheHit`/`missingMaster` を送信し、フォールバック時に `dataSourceTransition`/`fallbackUsed` を追加。キャッシュ命中返却時は `cacheHit=true` を強制し送信。UI はバナー表示更新のみ。

## 次アクション前の準備
- [ ] SP1 設計レビュー用サマリをログへ下書き（締切 11/26 09:00 JST）。
- [ ] `bridge-sync` スクリプトの雛形を Node/tsx で作成（Python 禁止）。
- [ ] mac-dev ORCA へのスモーク手順（curl）を ORCA 連携手順通りに再確認し、必要コマンドをログへ記載。

## 現在の進捗（履歴）
- MSW フィクスチャを `artifacts/api-stability/20251123T130134Z/schemas/` で再生成し、`web-client/src/mocks/fixtures/orcaMaster.ts` / `msw/handlers/master/*` を snapshot/hash と同期。ハッシュ再計算結果は DOC_STATUS に追記し、ログ `docs/server-modernization/phase2/operations/logs/20251123T135709Z-webclient-master-bridge.md#msw-fixture` に掲載。
- `WEB_ORCA_MASTER_SOURCE`/`VITE_ORCA_MASTER_BRIDGE` で MSW→snapshot→server を切替える source resolver を追加し、`web-client/src/features/charts/api/orca-api.ts` 配下の ORCA-05/06/08 取得フックに `dataSource/dataSourceTransition/cacheHit/missingMaster/fallbackUsed/runId/snapshotVersion` を透過。
- 単体テスト: `npm run test -- --reporter=verbose src/features/charts/api/__tests__/orca-api.test.ts`（SharedArrayBuffer polyfill を setupFiles へ追加）で 13/13 PASS。`web-client/test-results/.last-run.json` 更新済み。
- UI スモーク: MSW headless/headful では `orca-search-input` 未表示で警告未捕捉。リラン要件を `docs/server-modernization/phase2/operations/logs/20251123T135709Z-webclient-master-bridge.md#ui-smoke` に記録。
- DOC_STATUS/ログ: `docs/web-client/planning/phase2/DOC_STATUS.md` と `docs/server-modernization/phase2/operations/logs/20251123T135709Z-webclient-master-bridge.md` に RUN_ID=20251124T073245Z の進捗と証跡リンクを記載済み。
