# 03_ギャップ解消方針とUI影響分析

- RUN_ID: `20251123T224654Z`
- 期間: 2025-11-25 09:00 〜 2025-11-26 09:00 (JST)
- 優先度: High / 緊急度: High
- エージェント: codex
- YAML ID: `src/webclient_modernized_bridge/03_ギャップ解消方針とUI影響分析.md`
- 参照チェーン: `AGENTS.md` → `docs/web-client/README.md` → `docs/server-modernization/phase2/INDEX.md` → `docs/managerdocs/PHASE2_MANAGER_ASSIGNMENT_OVERVIEW.md` → 本ファイル
- 依存資料: `src/webclient_modernized_bridge/01_API互換レイヤー再確認とギャップ整理.md`、`src/webclient_modernized_bridge/02_ORCAマスターデータギャップ報告精査.md`、`docs/web-client/process/API_UI_GAP_ANALYSIS.md`、`docs/web-client/ux/CHART_UI_GUIDE_INDEX.md`、`docs/web-client/ux/API_SURFACE_AND_AUDIT_GUIDE.md`

## 0. 背景と課題
- ORCA マスターデータの不足（薬剤分類・最低薬価・用法・特定器材・検査分類・保険者・住所など）により、ChartsPage のオーダ/病名 UI と 予約/請求フローで入力候補・禁忌チェックが欠落している。参照元: `02_ORCAマスターデータギャップ報告精査`。
- モダナイズ版サーバーの恒久 API 追加は別タスク（ORCA-05/06/07）として進行中。短期は Web クライアント側で「暫定データ供給＋キャッシュ＋バリデーションの整合」を図り、監査要件を満たしたまま UI の破綻を防ぐ必要がある。
- UI/UX ガイド（`CHART_UI_GUIDE_INDEX.md`、`API_SURFACE_AND_AUDIT_GUIDE.md`）ではエラー/空状態トーン統一・監査ログ送出・Danger 操作の隔離が必須。暫定データでも同要件を崩さないことが前提。

## 1. 暫定データ供給・キャッシュ・バリデーション方針
| 区分 | 方針 | 監査/UX への反映 | 備考 |
| --- | --- | --- | --- |
| データ供給 | (A) **静的スナップショット配布**: `artifacts/api-stability/20251123T224654Z/master-snapshots/` に ORCA DB 由来の匿名化 CSV/JSON（薬剤分類・用法・特定器材・検査分類・保険者）を置き、MSW から `/orca/*` にフェイルオーバー。<br>(B) **モダナイズ API プレースホルダ**: サーバー側が未提供の間は 200 + `apiResult=79 warning` を返すモックを維持し、UI では `warning` トーンで「暫定データ」バッジを表示。<br>(C) **UI 固定候補**: 資格確認や保険選択で必須となる最小コード（例: 国保/社保種別）だけを TypeScript 定数として同梱し、入力検証を通す。 | - MSW/実サーバー切替時も `audit.logOrcaQuery` を送信し、`data-source: snapshot|mock|server` をメタとして記録。<br>- `warning` トーン + `aria-live="polite"` で暫定データ利用を明示し、CHART UI ガイドのトーン規則を遵守。 | スナップショットは Secrets/個人情報を含めない。`localStorage` への永続キャッシュは禁止（API_UI_GAP_ANALYSIS 既定）。
| キャッシュ | - React Query / SWR の in-memory キャッシュを 5 分 TTL で使用。<br>- 予約/請求タブを跨いだ再利用は `cacheKey = [orca-master, masterType, version]` で分離し、マスター更新時に `version` をインクリメント。<br>- 診療中セッション内のみ再利用し、ブラウザ再起動で必ず再取得。 | - キャッシュ命中時も `audit.logOrcaQuery` に `cacheHit=true` を送出し、操作ログとの整合を確保。<br>- キャッシュ失効時のフェイルバックは `neutral` → `info` の順にトースト通知し、API 呼び出し失敗は `danger` トーンで明示する。 | `localStorage` / IndexedDB は利用しない。セッション間の汚染を防ぐため、タブクローズ時に `queryClient.clear()` を呼ぶ。 |
| バリデーション | - **入力前**: コード・ID 形式（桁数/数値/チェックディジット）をクライアントで先行検証し、無効な値は API 呼び出しを行わない。<br>- **取得後**: スナップショット/モックの行数と必須列（code/name/category/validFrom/validTo）を検証し、欠損時は `danger` トーンで再取得を促す。<br>- **送信前**: 予約/請求/カルテ保存のペイロードにマスタ参照フィールドが null の場合、`audit.logValidationError` を送出してブロック。 | - エラーメッセージは `resolveErrorMessage` を経由し API 例外はそのまま提示、想定外は既定文言を使用（CHART UI ガイド準拠）。<br>- Danger 操作（予約削除/請求再送）は暫定データ利用時に二重確認を要求し、RUN_ID をダイアログに表示。 | 監査ログ項目: `action`, `runId`, `dataSource`, `cacheHit`, `validationStage`, `affectedUi`. |

## 2. UI 影響と変更規模（カルテ/予約/請求）
| 領域 | 影響する UI / コンポーネント | 影響内容 | 規模見積 | 対応方針 |
| --- | --- | --- | --- | --- |
| カルテ（オーダ/病名/禁忌） | `OrcaOrderPanel`, `DiagnosisPanel`, `DocumentTimelinePanel` | マスター不足時に検索候補が空 → 現行はスピナーのまま。禁忌チェック/薬剤分類が欠落。 | M（UI ステータス/バッジ/モック追加） | - 暫定データ利用時は `warning` バナーと「暫定」タグをリスト項目に表示。<br>- 禁忌チェックはスナップショットに含まれる相互作用のみ実行し、不足項目は `info` トーストで明示。<br>- 監査: `audit.logOrcaQuery` + `audit.logChartsAction` に dataSource を付与。 |
| 予約 / 受付 | `ReceptionPage` カード、`VisitManagementDialog`, `FacilitySchedulePage` | 予約理由・診療科・保険種別の選択肢不足で登録/編集が失敗しうる。 | S〜M（選択肢とバリデーションの差し替え） | - 選択肢を暫定マスターで埋め、欠損時はフリーテキスト許容＋警告バッジ。<br>- `VisitManagementDialog` Danger 操作は暫定データ使用時に確認チェックを追加。<br>- 監査: `audit.logReceptionAction` / `audit.logScheduleAction` に dataSource を付与。 |
| 請求 / Claim | `ClaimAdjustmentPanel`, `ChartsPage` 保存フロー | 点数コード欠落時に再送信が拒否される。保険者コード不足で Claim 再計算が失敗。 | M〜L（入力制約と再送信前検証の追加） | - 点数コード必須欄は暫定マスターで補完し、欠損時は UI 側で送信をブロック。<br>- `resolveProgressContext` に「マスタ未充足」ステータスを追加し、再送信前に `danger` トーンで警告。<br>- 監査: `audit.logBillingAction` に dataSource / validationStage を付与。 |

## 3. 入力制約とエラーハンドリング更新案（UX ガイド適合）
1. **トーン規則の適用**: 空/再取得待ちは `neutral`、暫定データ警告は `warning`、検証失敗は `danger`、成功/復旧は `info`。`CHART_UI_GUIDE_INDEX.md` の DocumentTimeline トーン運用に合わせる。
2. **Danger 操作の隔離**: 予約削除・請求再送・カルテ上書きは暫定データ利用時に確認チェックボックス＋RUN_ID 表示を追加し、`API_SURFACE_AND_AUDIT_GUIDE.md` の Danger セクション運用を踏襲。
3. **SSE/LP 連携**: `chart-events.replay-gap` 受信時にマスター再取得を促すバナーを追加し、`ReplayGapState` の遷移表に「マスター再読込待ち」ステートを追記予定。
4. **入力前検証**: ORCA コード系は桁数・先頭記号をフロントで検証し、無効値は API 呼び出し前に `audit.logValidationError` を送信。予約/保険フォームでは必須項目を `aria-required` で明示。
5. **オフライン/タイムアウト時のフォールバック**: ORCA API 5 秒 timeout 時はスナップショットへフォールバックし、`cacheHit=false` で監査に残す。失敗メッセージは `resolveErrorMessage` で API 由来文言を優先。

## 4. 実装ステップと担当想定
| ステップ | 内容 | 担当候補 | 期限 |
| --- | --- | --- | --- |
| S1 | スナップショット格納先とファイル形式（CSV/JSON）を決定し、`artifacts/api-stability/20251123T224654Z/master-snapshots/` を作成。 | Ops/Server 担当 | 2025-11-25 AM |
| S2 | MSW モックに master-snapshots を紐付け、dataSource メタを audit フックに配線。 | Web クライアント | 2025-11-25 PM |
| S3 | Reception/FacilitySchedule/Charts/Claim 各フォームに暫定データ警告・入力前検証・危険操作ガードを実装。 | Web クライアント | 2025-11-26 AM |
| S4 | `ux/CHART_UI_GUIDE_INDEX.md` と `ux/API_SURFACE_AND_AUDIT_GUIDE.md` に暫定データ運用とトーン規則の更新を反映、DOC_STATUS を同日更新。 | Web クライアント | 2025-11-26 PM |

## 5. エビデンス計画
- ログ: `docs/server-modernization/phase2/operations/logs/20251123T224654Z-webclient-master-bridge.md` に方針・実装ステップ・モック/スナップショット配置を記録する。
- アーティファクト: `artifacts/api-stability/20251123T224654Z/master-snapshots/` に CSV/JSON と期待スキーマ、`mocks/` に MSW 追記差分を格納予定。
- DOC_STATUS: 本ファイルを Active 行として追加し、備考に RUN_ID・ログ・アーティファクトパスを記載する。

## 6. 次アクション（本タスク内）
1. 上記エビデンスログの枠だけ先行作成（RUN_ID 記載と証跡パス案）。
2. DOC_STATUS へ本ドキュメントの行を追加し、備考に RUN_ID とログパスを追記。
3. UX ガイド更新で使うトーン/監査メタのキーワードを整理し、実装担当へ渡す。
