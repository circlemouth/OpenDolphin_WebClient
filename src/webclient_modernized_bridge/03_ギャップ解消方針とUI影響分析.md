# 03_ギャップ解消方針とUI影響分析

- RUN_ID: `20251124T000000Z`
- 期間: 2025-11-24 09:00 〜 2025-11-25 09:00 (JST)
- 優先度: High / 緊急度: High
- エージェント: codex
- YAML ID: `src/webclient_modernized_bridge/03_ギャップ解消方針とUI影響分析.md`
- 参照チェーン: `AGENTS.md` → `docs/web-client/README.md` → `docs/server-modernization/phase2/INDEX.md` → `docs/managerdocs/PHASE2_MANAGER_ASSIGNMENT_OVERVIEW.md` → 本ファイル
- 依存資料: `src/webclient_modernized_bridge/01_API互換レイヤー再確認とギャップ整理.md`、`src/webclient_modernized_bridge/02_ORCAマスターデータギャップ報告精査.md`、`docs/web-client/process/API_UI_GAP_ANALYSIS.md`、`docs/web-client/ux/CHART_UI_GUIDE_INDEX.md`、`docs/web-client/ux/API_SURFACE_AND_AUDIT_GUIDE.md`、`docs/server-modernization/phase2/operations/ORCA_API_STATUS.md`（2025-11-22 mac-dev 実測）

## 0. 背景と課題
- ORCA マスターデータの不足（薬剤分類・最低薬価・用法・特定器材・検査分類・保険者・住所・電子点数表など）で、ChartsPage のオーダ/病名 UI と 予約/請求フローの候補・禁忌チェックが欠落している（参照: `02_ORCAマスターデータギャップ報告精査`）。
- 2025-11-22 mac-dev 実測では `/api01rv2/acceptlstv2`・`/orca14/appointmodv2`・`/api21/medicalmodv2` など受付/予約系 API は 200/`Api_Result=00` まで前進した一方、マスタ系（ORCA-05/06/08）は依然 REST 未提供（`ORCA_API_STATUS.md`）。UI では暫定データを継続利用する前提で監査・警告トーンを崩さない必要がある。
- UI/UX ガイド（`CHART_UI_GUIDE_INDEX.md`、`API_SURFACE_AND_AUDIT_GUIDE.md`）ではエラー/空状態トーン統一・監査ログ送出・Danger 操作の隔離が必須。暫定データでも同要件を維持する。

### 0-1. 完了・未完・リスクまとめ（RUN_ID=`20251124T000000Z`）
| 項目 | 状態 | リスク/要確認 | UI 影響 | 解消オーナー | ターゲット日 | 次アクション（誰が・何を・いつまでに） |
| --- | --- | --- | --- | --- | --- | --- |
| ORCA-01/02/03 修正 | 完了 | なし | 影響解消済み | Webクライアント担当（codex） | 2025-11-24 完了 | Webクライアント担当が 2025-11-25 までに 回帰監視結果を DOC_STATUS に追記する |
| ORCA-04 点数帯フィルタ | 暫定（UI/MSW/型完了、実API切替待ち） | 実 REST 未接続。計算差異検知が遅れる | Charts 点数検索は暫定表記 | Webクライアント担当（codex） | 2025-11-25（SP3 ロードマップ） | Webクライアント担当が 2025-11-25 12:00 JST までに 実 API 切替の契約テストを実施しログを 20251124T000000Z-webclient-bridge.md に記録する |
| ORCA-05 薬剤/材料/用法/検査分類 | 未完（REST 未提供） | 禁忌/最低薬価欠落、候補空 | オーダ候補が暫定・警告表示 | モダナイズAPI担当（サーバー） | 暫定: 2025-12-06（サーバー REST 追加の ETA 未確定のため） | モダナイズAPI担当が 2025-12-06 までに ORCA-05 REST の schema draft とサンプルレスポンスを提示し、UI 型連携会議を設定する |
| ORCA-06 保険者/住所 | 未完（REST 未提供） | 資格確認・住所補完が暫定、誤請求リスク | 受付/予約フォームが暫定警告・フリーテキスト許容 | モダナイズAPI担当（サーバー） | 暫定: 2025-12-06（REST 実装未着手のため暫定） | モダナイズAPI担当が 2025-12-06 までに 保険者/住所 REST の提供可否を決定し、提供不可なら暫定コードセット拡充を通達する |
| ORCA-07 接続設定ハードニング | 未完（設計のみ） | 環境切替時の監査漏れ | UI 影響小（切替エラー減少期待） | サーバー基盤担当（Infra） | 暫定: 2025-12-02（設計レビュー未完のため暫定） | サーバー基盤担当が 2025-12-02 までに DataSource/Secrets 化の設計レビューを完了し、実装スプリントの開始日を通達する |
| ORCA-08 電子点数表 | 未完（REST 未提供） | 算定差異・返戻リスク | Claim 再計算が暫定警告 | モダナイズAPI担当（サーバー） | 暫定: 2025-12-06（REST 仕様未提示のため暫定） | モダナイズAPI担当が 2025-12-06 までに 電子点数表 REST のレスポンス案を提示し、MSW との差分検証スコープを共有する |
| 監査メタ整備（暫定データ） | 暫定（実装箇所レビュー中） | `missingMaster`・`fallbackUsed` の未送出が一部 | Charts/Reception/Claim で監査ギャップが残る | WebクライアントQA（監査担当） | 2025-11-25（SP4 回帰テスト内） | WebクライアントQAが 2025-11-25 18:00 JST までに 監査メタ送出の差分レビューを完了し、不足項目を issue 化する |

## 1. 暫定データ供給・キャッシュ・バリデーション方針（20251124T000000Z）
| 区分 | 方針 | 監査/UX への反映 | 備考 |
| --- | --- | --- | --- |
| データ供給 | (A) **静的スナップショット継続利用**: `artifacts/api-stability/20251123T130134Z/master-snapshots/` を引き続き参照。新 RUN_ID では実測差分が無いため複製せず、差分取得時に `.../20251124T000000Z/` を作成する。<br>(B) **モダナイズ API プレースホルダ**: サーバー未提供箇所は 200 + `apiResult=79 warning` モックを維持し、UI は `warning` バッジを表示。<br>(C) **固定コード最小セット**: 保険選択に必要な最小コード（国保/社保等）を TypeScript 定数として同梱し、資格確認をブロックしない。 | - MSW/実サーバー切替時も `audit.logOrcaQuery` へ `data-source: snapshot|mock|server` を付与。<br>- `warning` トーン＋`aria-live="polite"` で暫定データを明示し、CHART UI ガイドのトーン規則を遵守。 | スナップショットに Secrets/個人情報は含めない。`localStorage` 永続キャッシュは禁止（API_UI_GAP_ANALYSIS 既定）。
| キャッシュ | - React Query / SWR の in-memory キャッシュを 5 分 TTL で使用。<br>- 予約/請求タブ跨ぎは `cacheKey = [orca-master, masterType, version]` で分離し、マスター更新時は `version` をインクリメント。<br>- 診療中セッション内のみ再利用し、ブラウザ再起動で必ず再取得。 | - キャッシュ命中時も `audit.logOrcaQuery` に `cacheHit=true` を送出。<br>- 失効時は `neutral` → `info` トースト、API 失敗は `danger` トーン。 | `localStorage` / IndexedDB は使用しない。タブクローズ時に `queryClient.clear()` を呼び出し汚染を防止。 |
| バリデーション | - **入力前**: コード/ID 形式をフロントで検証し不正値は API 呼び出し前に止める。<br>- **取得後**: スナップショット/モックの行数と必須列（code/name/category/validFrom/validTo）を検証し欠損は `danger` トーンで再取得促し。<br>- **送信前**: 予約/請求/カルテ保存でマスタ参照が null の場合 `audit.logValidationError` を送出してブロック。 | - エラー文言は `resolveErrorMessage` 経由で標準化。<br>- Danger 操作（予約削除/請求再送）は暫定データ利用時に確認チェック＋RUN_ID 表示を要求。 | 監査必須: `action`, `runId`, `actorRole`, `staffId`, `patientId`, `clientUUID`, `apiRoute`, `dataSource`, `cacheHit`, `validationStage`, `affectedUi`, `valueBefore`, `valueAfter`, `evidencePath`. |

## 2. UI 影響ディープダイブ（画面別、ORCA-05/06/08）
| 画面/機能 | 必要マスタ (ORCA ID) | 現状（MSW/実API） | 症状/UXリスク | 解消方針（モダナイズAPI/代替/UX調整） | テスト観点 |
| --- | --- | --- | --- | --- | --- |
| Charts: オーダ（薬剤・材料検索/禁忌） | 薬剤分類・最低薬価・用法・特定器材・検査分類 (ORCA-05) | MSW: master snapshot を薬剤/材料/用法に注入し禁忌は相互作用のみカバー。<br>実API: REST 未提供 → 200 mock `apiResult=79` を返却。 | 候補空/スピナー継続、禁忌漏れ、最低薬価欠落で過量投与警告が出ない。 | - `data-source=mock|snapshot` 時に InlineFeedback `tone=warning` + `alert-triangle` + `aria-live="polite"`。「暫定データ（ORCA-05）」バッジをオーダ一覧へ。<br>- 禁忌/最低薬価チェックは snapshot 範囲のみ実行し不足分は `info` トーストで通知。<br>- 無候補時はフリーテキスト入力を許可し、保存前 `audit.logValidationError` でブロック。 | - MSW⇔実 API のスイッチでデータソースバッジ/監査メタが送出されるか。<br>- 最低薬価欠落時に警告トーストが出るか。<br>- 監査ログ出力確認（項目: runId, staffId, actorRole, patientId, clientUUID, action, apiRoute, dataSource, cacheHit, missingMaster, warningBadgeShown, valueBefore, valueAfter, evidencePath）。 |
| Charts: 病名/点数算定（カルテ保存） | 電子点数表・診療行為区分 (ORCA-08) | MSW: 点数フィクスチャで再計算可。<br>実API: REST 未、計算結果は MSW 依存。 | 点数コード欠落で保存/再送失敗、算定差異が見えない。 | - `resolveProgressContext` に「マスター未充足」を追加し InlineFeedback `tone=warning` 「暫定点数表で算定中（ORCA-08）」を表示。<br>- 必須コード null は送信ブロックし理由を明示。 | - 必須コード欠落時に `audit.logValidationError` が送出されるか。<br>- 点数帯フィルタ付き検索が MSW/実 API どちらでも同件数になるか（契約テスト）。<br>- 監査ログ出力確認（項目: runId, staffId, actorRole, patientId, clientUUID, action, apiRoute, dataSource, valueBefore, valueAfter, validationStage, evidencePath）。 |
| Charts: 点数帯フィルタ検索 | 点数マスタ (ORCA-04) | MSW: 点数帯フィルタ実装済みでフィクスチャ応答。<br>実API: REST 切替待ち。 | 実 API 切替時に件数/型差異で検索結果が不一致、フィルタが効かず UX 劣化。 | - `data-source` バッジで「暫定点数帯フィルタ（ORCA-04）」を表示し、件数乖離時に `info` トーストを出す。<br>- 実 API 切替前後でフィルタパラメータを共通化し、乖離時は自動で MSW にフォールバックできるようフラグ制御。 | - MSW⇔実 API で同一クエリの件数/キーが一致するか契約テスト。<br>- フォールバック発動時に `audit.logUiState` が送出されるか。<br>- 監査ログ出力確認（項目: runId, staffId, actorRole, clientUUID, action, apiRoute, dataSource, cacheHit, bannerVisible, interaction, evidencePath）。 |
| 資格確認/保険選択（受付・予約） | 保険者・資格区分・負担率・給付割合 (ORCA-06) | MSW: 最小コードセットを fixture 化。<br>実API: REST 未、資格確認 API も機能限定。 | 保険選択ドロップダウン空/ミスマッチで受付不可、誤請求リスク。 | - `InsuranceSelector` に固定コード（国保/社保/後期等）を同梱し InlineFeedback `tone=warning` 「暫定保険マスター（ORCA-06）」を表示。<br>- ドロップダウン空時はフリーテキスト＋`audit.logValidationError` で保存前確認。<br>- 資格確認レスポンス暫定時は `data-source=mock` を監査送出。 | - 固定コードのみでも保存ブロックされないか。<br>- 監査メタ `fallbackUsed`・`insuranceType` が送出されるか。<br>- 監査ログ出力確認（項目: runId, staffId, actorRole, patientId, clientUUID, action, apiRoute, dataSource, insuranceType, fallbackUsed, valueBefore, valueAfter, evidencePath）。 |
| 住所補完/患者登録 | 住所コード（JIS 都道府県/市区町村）、郵便番号→住所マッピング (ORCA-06) | MSW: 都道府県/市区町村コード簡易スナップショットのみ。<br>実API: REST 未提供。 | 郵便番号補完が不完全で入力遅延、保険者コードと齟齬。 | - 郵便番号→住所は `info` トースト付き手入力フローに切替。<br>- 都道府県/市区町村コード選択部に InlineFeedback `tone=warning` 「暫定住所マスター（ORCA-06）」を表示し、欠損時は手入力許可。<br>- 保存前コード未設定なら `audit.logValidationError` を送出。 | - 郵便番号検索失敗時に `warning` → `info` トーストが順に出るか。<br>- 保存ブロック時に `fieldId` / `reason=masterMissing` が記録されるか。<br>- 監査ログ出力確認（項目: runId, staffId, actorRole, patientId, clientUUID, action, apiRoute, dataSource, valueBefore, valueAfter, validationStage, errorCode, evidencePath）。 |
| Claim 調整/再計算 | 電子点数表・材料単価 (ORCA-08, ORCA-05) | MSW: 点数/材料フィクスチャで計算。<br>実API: 返却なし。 | 再計算結果が実際と乖離し返戻リスク。 | - 再計算実行時に InlineFeedback `tone=warning` 「暫定算定結果（ORCA-05/08）実 API 反映後に再確認」を表示。<br>- 材料単価欠損時は再送信ボタン無効化し手入力を促す。 | - 再送信ボタン disable 条件が `missingMaster` と連動するか。<br>- `audit.logBillingAction` の `tensuCodeMissing/payerCodeMissing` が送出されるか。<br>- 監査ログ出力確認（項目: runId, staffId, actorRole, patientId, clientUUID, action, apiRoute, dataSource, tensuCodeMissing, payerCodeMissing, valueBefore, valueAfter, evidencePath）。 |
| 全画面: 接続先未設定ガード / TraceId バナー | 接続設定 (MSW 無効化・VITE_DEV_PROXY_TARGET) | MSW: 無効化漏れ時に mock が優先。<br>実API: 接続先未設定だと黒画面/404。 | Stage 接続時にデータ取得不能・監査メタ欠落。トレース不可で障害復旧が遅延。 | - `VITE_DISABLE_MSW=1` + `VITE_DEV_PROXY_TARGET` 未設定時は上部バナーで警告、TraceId を ErrorBoundary に常時表示。<br>- Service Worker 残存時は再読込をブロックし解除手順を案内。 | - 未設定起動でバナーが表示されスクリーンリーダーで読めるか。<br>- TraceId が ErrorBoundary/トーストで一致しコピー可能か。<br>- `/mockServiceWorker.js` がロードされないことを Network で確認。<br>- 監査ログ出力確認（項目: runId, staffId, actorRole, clientUUID, action, apiRoute, dataSource, dataSourceTransition, bannerVisible, interaction, evidencePath）。 |
| 環境切替時監査メタ（接続設定ハードニング） | 接続設定 (ORCA-07) | MSW/実API: dataSourceTransition ログ未整備。 | 環境切替・資格情報更新時に UI では正常でも監査欠落で事後追跡不能。 | - 環境フラグ変更時に `audit.logUiState` / `audit.logOrcaQuery` へ `dataSourceTransition` と `runId` を付与し、バッジにも反映。<br>- 接続失敗時は `warning` トーンで自動ロールバックを促す。 | - ENV 切替操作で `dataSourceTransition` が必ず送出されるか。<br>- 切替後の最初の API 呼び出しに新接続先が反映されているか。<br>- 監査ログ出力確認（項目: runId, staffId, actorRole, clientUUID, action, apiRoute, dataSourceTransition, evidencePath）。 |
| Charts: スタンプ/セット/禁忌 回帰監視 | 入力セット/スタンプ/新薬禁忌 (ORCA-01〜03) | MSW/実API: 修正済み（20251116 時点）。 | 今後の改修で括弧漏れ・診療日未指定・単位欠落が再発し UI が過去データを誤表示。 | - レグレッション警告バナーは表示せず、契約テストと監査メタで検知（`missingMaster=false` を期待）。<br>- 異常検知時のみ `danger` トーンで保存ブロック。 | - 週次契約テストで `/orca/inputset` / `/stamp` / `/tensu/shinku` の必須列が揃うか。<br>- 保存前に `missingMaster` が false のままか確認。<br>- 監査ログ出力確認（項目: runId, staffId, actorRole, patientId, clientUUID, action, apiRoute, dataSource, missingMaster, valueBefore, valueAfter, evidencePath）。 |

※ トーン/文言は `docs/web-client/ux/CHART_UI_GUIDE_INDEX.md`・`ux/KARTE_SCREEN_IMPLEMENTATION.md` の `neutral`/`info`/`warning`/`danger` 運用に準拠し、警告は `InlineFeedback` の `tone=warning` + `alert-triangle` アイコン、`aria-live="polite"` で統一（RUN_ID=`20251124T000000Z` 証跡）。証跡ログ: `docs/server-modernization/phase2/operations/logs/20251124T000000Z-webclient-bridge.md` にトーン準拠とテスト観点を記録。

## 2-1. 監査・ログ要件（暫定データ利用時） / RUN_ID=20251124T000000Z
- **共通フィールド**: `runId=20251124T000000Z`, `staffId`（操作者 ID）, `actorRole`, `patientId`, `clientUUID`（端末識別子）, `screenId`, `timestamp`, `action`, `apiRoute`, `dataSource (snapshot|mock|server)`, `cacheHit`, `masterType`, `valueBefore`, `valueAfter`, `evidencePath` を全イベントで必須（ガイド表記に統一）。
- **Charts（OrcaOrderPanel / DiagnosisPanel / DocumentTimelinePanel）**
  - マスタ検索/禁忌チェック: `audit.logOrcaQuery` に `query`, `resultCount`, `missingMaster`, `warningBadgeShown`, `actorRole`, `clientUUID`, `apiRoute` を付与。
  - 入力前/送信前ブロック: `audit.logValidationError` に `fieldId`, `validationStage (preInput|preSend)`, `errorCode`, `errorMessage`, `payloadFragment`, `actorRole`, `clientUUID`, `apiRoute`。保存阻止時は `uiBlocked=true`。
  - 暫定データを選択して保存/署名: `audit.logChartsAction` に `selectedCode`, `selectedName`, `fallbackUsed`, `dangerConfirm`, `valueBefore`, `valueAfter`, `actorRole`, `clientUUID`, `apiRoute`, `evidencePath` を付与。
- **Reception / FacilitySchedule**
  - 予約作成・変更・キャンセル: `audit.logScheduleAction` に `action (create|update|cancel)`, `departmentCode`, `visitReason`, `insuranceType`, `fallbackUsed`, `confirmationChecked`, `actorRole`, `clientUUID`, `apiRoute`, `evidencePath`。
  - 保険者/資格確認で暫定値を入力・保存拒否: `audit.logValidationError` に `fieldId`, `inputValue`, `reason (masterMissing|formatError)`, `blocked=true|false`, `actorRole`, `clientUUID`, `apiRoute`。
- **Claim / Billing**
  - 再計算・再送: `audit.logBillingAction` に `action (recalc|resend)`, `tensuCodeMissing`, `payerCodeMissing`, `validationStage (preSend|postSend)`, `warningShown`, `actorRole`, `clientUUID`, `apiRoute`, `evidencePath`。
  - 点数/保険者コード欠落による送信ブロック: `audit.logValidationError` に `fieldId`, `errorCode (missing-tensu|missing-payer)`, `payloadFragment`, `uiBlocked=true`, `actorRole`, `clientUUID`, `apiRoute`。
- **トーン表示ログ**: 暫定データ警告バナー表示/非表示時に `audit.logUiState` を送出し、`bannerVisible`, `affectedUi`, `interaction (auto|userDismiss)` を記録。
- **切替テレメトリ**: MSW→実サーバー切替で `dataSourceTransition (msw→server)` を共通メタに追加し、Feature flag ロールバック時も同様に送出。

### 2-1-1. UI 監査配線確認チェックリスト（RUN_ID=20251124T000000Z）
| 画面/機能 | audit 呼び出し箇所 | 必須項目 | 未確認/補足 |
| --- | --- | --- | --- |
| Charts: OrcaOrderPanel 検索/選択 | `audit.logOrcaQuery` 呼び出し（検索時） / `audit.logChartsAction`（暫定データ選択保存時） | `runId`, `actorRole`, `staffId`, `patientId`, `clientUUID`, `screenId`, `action`, `apiRoute`, `dataSource`, `query`, `resultCount`, `missingMaster`, `warningBadgeShown`, `cacheHit`, `valueBefore`, `valueAfter`, `evidencePath` | `missingMaster` null 時の扱いを実装レビューで要確認 → **オーナー: フロント / 期限: 2025-11-25 18:00 JST (SP4 QA)**<br>解消手段: MSW+実API トレースで `missingMaster=null` の送出有無を比較し契約テストにケース追加。検索→保存パスで `cacheHit`/`dataSource` も併せて検証。<br>エビデンス: `docs/server-modernization/phase2/operations/logs/20251124T000000Z-webclient-bridge.md §監査要確認クローズ計画`<br>テスト観点: 監査ログ出力確認（項目: runId, screenId, action, dataSource, query, resultCount, missingMaster, cacheHit, valueBefore, valueAfter, evidencePath） |
| Charts: Diagnosis/Document 保存 | `audit.logChartsAction` 保存時 / `audit.logValidationError`（保存前ブロック） | `runId`, `actorRole`, `staffId`, `patientId`, `clientUUID`, `screenId`, `action`, `apiRoute`, `dataSource`, `selectedCode`, `selectedName`, `fallbackUsed`, `dangerConfirm`, `validationStage`, `errorCode`, `uiBlocked`, `valueBefore`, `valueAfter`, `evidencePath` | `fallbackUsed` が保存ブロック時にも送られるか未確認 → **オーナー: フロント / 期限: 2025-11-25 18:00 JST (SP4 QA)**<br>解消手段: `audit.logValidationError` 送出時にも `fallbackUsed` を含めるかを MSW/実API 両系で保存前ブロックを再現し確認。必要ならロガーへフィールド追加し契約テストに保存前ブロックケースを追加。<br>エビデンス: `docs/server-modernization/phase2/operations/logs/20251124T000000Z-webclient-bridge.md §監査要確認クローズ計画`<br>テスト観点: 監査ログ出力確認（項目: runId, actorRole, patientId, screenId, action, apiRoute, dataSource, selectedCode, selectedName, fallbackUsed, dangerConfirm, validationStage, errorCode, uiBlocked, valueBefore, valueAfter, evidencePath） |
| Reception/FacilitySchedule（予約・保険） | `audit.logScheduleAction`（予約作成/変更/キャンセル） / `audit.logValidationError`（保険者/資格確認） | `runId`, `actorRole`, `staffId`, `patientId`, `clientUUID`, `screenId`, `action`, `apiRoute`, `dataSource`, `departmentCode`, `visitReason`, `insuranceType`, `fallbackUsed`, `confirmationChecked`, `fieldId`, `inputValue`, `reason`, `blocked`, `valueBefore`, `valueAfter`, `evidencePath` | `confirmationChecked` がキャンセル時にも必須か要確認 → **オーナー: QA / 期限: 2025-11-25 18:00 JST (SP4 QA)**<br>解消手段: 予約キャンセル・保険変更で確認チェック有無の両ケースを実/モック API で再現し、`audit.logScheduleAction` の `confirmationChecked`/`blocked`/`dataSource` 送出を確認。必要なら UI でチェック必須を強制し契約テストを追加。<br>エビデンス: `docs/server-modernization/phase2/operations/logs/20251124T000000Z-webclient-bridge.md §監査要確認クローズ計画`<br>テスト観点: 監査ログ出力確認（項目: runId, actorRole, patientId, screenId, action, apiRoute, dataSource, departmentCode, visitReason, insuranceType, fallbackUsed, confirmationChecked, fieldId, inputValue, reason, blocked, valueBefore, valueAfter, evidencePath） |
| Claim/Billing 再計算・再送 | `audit.logBillingAction` / `audit.logValidationError` | `runId`, `actorRole`, `staffId`, `patientId`, `clientUUID`, `screenId`, `action (recalc|resend)`, `apiRoute`, `dataSource`, `tensuCodeMissing`, `payerCodeMissing`, `validationStage`, `warningShown`, `errorCode`, `payloadFragment`, `uiBlocked`, `valueBefore`, `valueAfter`, `evidencePath` | `tensuCodeMissing` の bool/配列どちらで送るか未確認 → **オーナー: サーバー（型）+ QA / 期限: 2025-12-02 18:00 JST (サーバーRESTレビュー)**<br>解消手段: REST スキーマで `tensuCodeMissing` 型を確定し OpenAPI/ts 型を更新、MSW/実API 双方で契約テストを追加。フロントはロガーをスキーマに合わせて変換し、bool/配列の混在を禁止。<br>エビデンス: `docs/server-modernization/phase2/operations/logs/20251124T000000Z-webclient-bridge.md §監査要確認クローズ計画`<br>テスト観点: 監査ログ出力確認（項目: runId, actorRole, patientId, screenId, action, apiRoute, dataSource, tensuCodeMissing, payerCodeMissing, validationStage, warningShown, errorCode, payloadFragment, uiBlocked, valueBefore, valueAfter, evidencePath） |
| 警告バナー表示状態 | `audit.logUiState`（警告バナー表示/閉じる） | `runId`, `actorRole`, `staffId`, `clientUUID`, `screenId`, `action`, `apiRoute`, `dataSource`, `bannerVisible`, `affectedUi`, `interaction (auto|userDismiss)`, `timestamp`, `evidencePath` | 非表示→再表示時に重複送信を許容するか要確認 → **オーナー: フロント / 期限: 2025-11-25 18:00 JST (SP4 QA)**<br>解消手段: バナーIDごとに `bannerVisible` 変化時のみ送出するか、重複送信を許容する場合は `interaction` と `timestamp` の変化をテレメトリで検証。MSW/実API で表示→再表示のシナリオを撮り、重複送信方針を決定。<br>エビデンス: `docs/server-modernization/phase2/operations/logs/20251124T000000Z-webclient-bridge.md §監査要確認クローズ計画`<br>テスト観点: 監査ログ出力確認（項目: runId, actorRole, screenId, action, apiRoute, dataSource, bannerVisible, affectedUi, interaction, timestamp, evidencePath） |

## 3. 入力制約とエラーハンドリング更新案（UX ガイド適合）
1. **トーン規則の適用**: 空/再取得待ちは `neutral`、暫定データ警告は `warning`、検証失敗は `danger`、成功/復旧は `info`。`CHART_UI_GUIDE_INDEX.md` の DocumentTimeline トーン運用に合わせる。
2. **Danger 操作の隔離**: 予約削除・請求再送・カルテ上書きは暫定データ利用時に確認チェックボックス＋RUN_ID 表示を追加し、`API_SURFACE_AND_AUDIT_GUIDE.md` の Danger セクション運用を踏襲。
3. **SSE/LP 連携**: `chart-events.replay-gap` 受信時にマスター再取得を促すバナーを追加し、`ReplayGapState` の遷移表に「マスター再読込待ち」ステートを追記予定。
4. **入力前検証**: ORCA コード系は桁数・先頭記号をフロントで検証し、無効値は API 呼び出し前に `audit.logValidationError` を送信。予約/保険フォームでは必須項目を `aria-required` で明示。
5. **オフライン/タイムアウト時のフォールバック**: ORCA API 5 秒 timeout 時はスナップショットへフォールバックし、`cacheHit=false` で監査に残す。失敗メッセージは `resolveErrorMessage` で API 由来文言を優先。

## 4. 実装ロードマップ（時系列/依存）
RUN_ID=20251124T000000Z （本ロードマップ証跡用）

| スプリント | 期間目安 | 主要作業 | 依存/完了条件 | 備考 |
| --- | --- | --- | --- | --- |
| SP1: サーバー実装固定 | 2025-11-24 PM | モダナイズ REST エンドポイントのレスポンス型・バリデーションを凍結し、OpenAPI/ts 型を出力。暫定フィクスチャは `artifacts/api-stability/20251123T130134Z/master-snapshots/` を基にし、差分取得時に `.../20251124T000000Z/master-snapshots/` を作成する。 | サーバー REST スキーマ承認 → 型生成が完了していること。 | RUN_ID=20251124T000000Z をエビデンスログに追記。 |
| SP2: 型/フィクスチャ反映 & MSW 差し替え | 2025-11-24 PM | `types/*` と MSW ハンドラを SP1 の型/フィクスチャに合わせて差し替え。dataSource メタと audit フック連携を実装。 | SP1 の OpenAPI/型/スナップショットが揃っていること。 | MSW で `data-source: snapshot|mock|server` を送出。RUN_ID 記録。 |
| SP3: 実 API 切替（UI フラグ付き） | 2025-11-25 AM | UI フェッチを MSW→実サーバー REST へ段階切替。Feature flag で旧モックへロールバック可能にし、暫定データ警告/検証/危険操作ガードを UI に適用。 | SP2 の型/ハンドラ反映が済み、契約テストが緑。 | Charts/Reception/Claim の各ページで `data-source` バッジ表示を確認。RUN_ID で操作ログ紐付け。 |
| SP4: UI 回帰テスト & トーン整合 | 2025-11-25 PM | E2E/スモークで UI 回帰（警告トーン、危険操作確認、監査ログ出力）。`ux/CHART_UI_GUIDE_INDEX.md` / `ux/API_SURFACE_AND_AUDIT_GUIDE.md` に暫定運用を反映。 | SP3 のフラグ付き実 API がステージングで稼働していること。 | DOC_STATUS 更新は担当者タスク。RUN_ID をテストログ/証跡に付記。 |

依存チェーン（必須順）: **サーバーREST確定 → 型/フィクスチャ更新 → UI/フェッチ切替 → UI回帰テスト**。切替フェーズは常に Feature flag でロールバック経路を確保する。

### フラグ設計と切替手順（ORCA-04/08 実API化、RUN_ID=`20251124T000000Z`）
- **フラグ構成**: `WEB_ORCA_MASTER_SOURCE` env (`msw`/`server`) をビルド時デフォルトにし、ランタイムで `localStorage['orcaMasterSource']` を上書き許容（診療セッション限定。persist は禁止）。Charts/Claim/Reception の fetch フックに `sourceResolver` を共通化。
- **切替リハーサル**: ステージングで `WEB_ORCA_MASTER_SOURCE=msw` → `server` を 1 セッション内で往復し、`data-source` バッジと監査ログ出力を比較。MSW/実API のレスポンス差分（フィールド欠落・型不一致・totalCount/件数・fetchedAt 形式）を契約テストで検出。
- **本番切替手順**: 1) デプロイ時 env を `server` に設定。2) Feature flag dashboard から runtime override を `msw` へ戻せる UI を維持。3) 切替直後に Charts/Claim/Reception の smoke を 3 画面実施。
- **ロールバック条件**: 契約テスト NG（必須フィールド欠落/数値→文字列化）、監査ログの `data-source` 欠落、予約/請求保存時 4xx 増加を検知した場合は runtime override で即 `msw` へ復帰し、env をロールバックせずに済ませる。
- **契約テスト観点**: `/orca/master/*` の **スキーマ差分**（キー/型）、**ビジネス差分**（件数/単価/期間境界）、**空データ時挙動**（address=空 body、generic-price=price:null）、**ステータスコード**（基本200固定）を MSW vs 実API で snapshot 比較し、乖離時に警告。

## 5. エビデンス計画
- ログ: `docs/server-modernization/phase2/operations/logs/20251124T000000Z-webclient-bridge.md` に方針・実装ステップ・モック/スナップショット配置を記録する。
- アーティファクト: 2025-11-24 10:47 JST の mac-dev 実測（`/orca/master/address`・`/orca/tensu/ten`=HTTP404+JSON、`/api/orca/*`=status=000 empty reply）を `artifacts/api-stability/20251124T000000Z/master-snapshots/` に保存済み。基点となる 20251123 スナップショット不在のため取得差分は「なし」。
- DOC_STATUS: 上記エビデンスを備考に RUN_ID・ログパス・アーティファクトパス付きで追記し、404/000 応答のみで有効スナップショット差分が無い旨も明示する。

## 6. 次アクション（本タスク内）
- [完了] 上記エビデンスログの枠を作成し、RUN_ID と証跡パス案を記載済み。
- [完了] DOC_STATUS に本ドキュメント行を追加し、備考へ RUN_ID とログパスを追記済み。
- 残タスクなし（本セクション内）。

更新ログ（2025-11-24）: 次アクションの棚卸しを実施し、完了項目を明示・残タスクなしを確認。

## 7. ORCA ギャップ→解消方針・UI 影響マッピング（RUN_ID=`20251124T000000Z`）
| ID | 解消方針 | Web UI 影響 | 優先度 | 依存（API/MSW/型/接続設定） |
| --- | --- | --- | --- | --- |
| ORCA-01 | `/orca/inputset` の括弧漏れは修正済み。定期リグレッション監視のみ。 | 影響解消済み（セット混入なし）。 | Low | API:済 / MSW:不要 / 型:済 / 接続設定:不要 |
| ORCA-02 | `visitDate` 付与済み。現行仕様を維持しリプレイテストで監視。 | 影響解消済み（過去/未来カルテ取得可）。 | Low | API:済 / MSW:不要 / 型:済 / 接続設定:不要 |
| ORCA-03 | `/orca/tensu/shinku` 列追加済み。単位/薬剤区分の欠落は再発監視のみ。 | 影響解消済み（禁忌/区分表示正常）。 | Low | API:済 / MSW:不要 / 型:済 / 接続設定:不要 |
| ORCA-04 | 点数帯フィルタは MSW/型/UI 実装済み。実 ORCA API への切替待ち。 | ChartsPage 検索効率改善、警告バナーで切替待ち明示。 | Medium | API:切替待ち / MSW:有 / 型:有 / 接続設定:不要 |
| ORCA-05 | 薬剤分類・最低薬価・用法・特定器材・検査分類 REST 追加を待つ。暫定は master snapshot + MSW を供給。 | オーダー候補/禁忌フィルタが暫定データ依存。警告バッジと `warning` トーンで明示。 | High | API:未 / MSW:有（フィクスチャ） / 型:有 / 接続設定:不要 |
| ORCA-06 | 保険者・住所 REST 追加待ち。暫定は最小コード定数＋スナップショットで代替。 | 住所/保険選択は暫定候補 + フリーテキスト許容。資格確認は `warning` トーン。 | High | API:未 / MSW:有 / 型:有 / 接続設定:不要 |
| ORCA-07 | ORCA 接続設定の DataSource/Secrets 化をサーバー側で実施予定。 | Web UI 直接影響は小。環境切替時のエラー減少を期待。 | Medium | API:設計中 / MSW:対象外 / 型:対象外 / 接続設定:要（サーバー） |
| ORCA-08 | 電子点数表 REST 追加を待つ。暫定は MSW で計算テスト継続。 | Claim 再計算・区分チェックが暫定動作。実 API 切替まで `info` トーンで案内。 | High | API:未 / MSW:有 / 型:有 / 接続設定:不要 |

- 参照: `src/webclient_modernized_bridge/02_ORCAマスターデータギャップ報告精査.md` 最新版（RUN_ID=`20251123T135709Z`）。
- 備考: 本セクションは RUN_ID=`20251124T000000Z` の証跡とし、サーバー実装待ち項目（ORCA-05/06/07/08）は完了まで High 優先度を維持。

## 8. ORCA モダナイズ REST 仕様サマリ（調査結果を反映）
- パス/プレフィックス: 基本は `/orca/master/*` と `/orca/tensu/*`。WebORCA 経由では `/api/orca/...` プレフィックスになる場合あり。旧独自パス `/openDolphin/resources/orca/*` は非推奨。
- 主なエンドポイント: address / hokenja / generic-class / generic-price / youhou / material / kensa-sort / etensu / tensu/ten。
- 認証とメソッド: GET + Basic 認証が標準（ormaster 等）。Accept: `application/json` を推奨。REST が無効な環境では receipt_route.ini などの設定が必要。
- レスポンス構造: JSON 配列が基本。`data` ラッパー有無は環境依存のため要実測確認。totalCount/fetchedAt は返らない想定（クライアント計算）。エラー時は `{"error":{code,message}}`。
- 代表的クエリ: `/orca/tensu/ten?min=&max=&date=YYYYMMDD`、`/orca/master/address?zip|pref|keyword=`、`/orca/master/hokenja?InsuranceProvider_Number|Insurance_Number=`。空ヒットは 200 + 空配列。
- 開発環境: `http://100.102.17.40:8000`（HTTP）。REST 404 時は `/api/orca/...` プレフィックス有無と設定有効化を要確認。
- 未実装/制約: 病名マスタ等は REST 未提供。数値フィールドの null 許容や E 点数は etensu で別扱い。レートリミットなしだが大量取得は負荷注意。
- サンプルレスポンス: address/hokenja/generic-class/generic-price/youhou/material/kensa-sort/etensu/tensu-ten の 1 件例を別途証跡に保持（本節は概要のみ）。
- mac-dev 実測（2025-11-24 10:47 JST）: `/orca/master/address`・`/orca/tensu/ten` は HTTP404 + JSON エラーボディ、`/api/orca/*` は status=000 の empty reply。`artifacts/api-stability/20251124T000000Z/master-snapshots/` に保存済みで、20251123 基点不在のため差分なし。
