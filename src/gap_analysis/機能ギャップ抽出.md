# 機能ギャップ抽出（webclient non chart gap audit plan）

- RUN_ID: `20251230T191420Z`
- 期間: 2026-01-02 09:00 〜 2026-01-03 09:00 (JST)
- 優先度: high / 緊急度: high
- エージェント: codex
- YAML ID: `src/gap_analysis/機能ギャップ抽出.md`

## 目的
旧来版（Legacy クライアント）とモダナイズ版 Web クライアントの差分を一覧化し、追加検討項目を抽出する。

## 対象範囲
- 受付 / 患者管理 / 管理・配信 / Charts（カルテ入力以外）/ 印刷
- 参照元: `src/discovery/対象範囲と成果物定義.md`

## 追加検討候補の分類
- **仕様**: 要件・運用ルールの確定、文言や遷移の整理
- **実装**: UI/API/権限制御の追加実装
- **運用**: 配信手順、エラー時対応、ロールバック
- **監査**: 監査ログの粒度・永続化・検索 UI
- **テスト**: E2E/統合/回帰の検証観点・証跡

## ギャップ一覧（画面別）

| ID | 画面/機能 | 旧来版/期待される挙動 | モダナイズ版 現状 | ギャップ要約 | 影響タグ | 追加検討候補 |
| --- | --- | --- | --- | --- | --- | --- |
| GAP-REC-01 | Reception 右ペイン | 患者概要/直近診療/オーダー概要を一覧と分離して即時判断できる | 右ペイン未実装 | 受付の判断材料が不足 | UI / 運用 | 実装 / 仕様 / テスト |
| GAP-REC-02 | Reception 一覧列 | 受付/会計判断に必要な列（保険/自費、ORCA キュー、直近診療など）を表示 | 基本列のみで不足 | 状態判断と例外把握が弱い | UI / 運用 | 仕様 / 実装 |
| GAP-REC-03 | Reception 例外一覧 | 未承認/送信エラー/遅延を別リストで原因と次操作を提示 | 専用の未承認一覧がない | 例外処理の優先順位が付けづらい | UI / 運用 / 監査 | 仕様 / 実装 / テスト |
| GAP-REC-04 | Reception 監査履歴表示 | 操作履歴の一覧・検索が可能 | 監査メモ入力のみ | 受付操作の追跡性が不足 | 監査 / 運用 | 監査 / 実装 |
| GAP-REC-05 | Reception 新規タブ導線 | レガシー同等の「カルテを別タブで開く」導線 | 新規タブ遷移未実装 | マルチ患者処理の効率が低い | UI / 運用 | 仕様 / 実装 |
| GAP-PAT-01 | Patients 監査履歴ビュー | 変更履歴の詳細/検索/時系列が必要 | 簡易表示のみ | 監査検索/説明責任が不足 | 監査 / 運用 | 監査 / 実装 |
| GAP-PAT-02 | Patients ORCA 反映状態 | 反映済/未反映/エラーを明示 | 状態表示なし | 編集結果の確定性が不明 | UI / 運用 / 監査 | 仕様 / 実装 |
| GAP-PAT-03 | Patients 未紐付/警告 | 未紐付や警告の強調表示と通知 | 警告 UI 未実装 | 受付/カルテ側への影響が伝わりにくい | UI / 運用 | 仕様 / 実装 |
| GAP-ADM-01 | Administration 全体設計 | 旧来版相当の管理メニュー（マスタ/権限/セット/通知/監査設定など） | ORCA 設定・配信フラグ中心 | 管理対象の大半が未実装 | UI / 運用 / 権限 | 仕様 / 実装 / テスト |
| GAP-ADM-02 | Administration アクセス制御 | system_admin 以外は画面自体もブロック | UI のみ非活性で画面閲覧可 | 権限逸脱時の安全性不足 | 権限 / 監査 | 実装 / テスト |
| GAP-ADM-03 | 配信タイミング/環境表示 | 即時/次回リロード/再ログインの明示と環境ラベル表示 | 表示が未整備 | 運用判断ができない | 運用 / UI | 仕様 / 実装 |
| GAP-ADM-04 | 管理変更の監査保持 | 管理設定変更の監査ログ保持期間/検索 UI が必要 | 保存記録はあるが保持/検索は未定 | 監査要件が未確定 | 監査 / 運用 | 監査 / 仕様 |
| GAP-ADM-05 | 管理更新の配信証跡 | 配信バージョン/ETag/反映遅延の証跡 | 検証計画はあるが運用確定前 | 実運用での追跡性が不足 | 運用 / 監査 | 運用 / テスト |
| GAP-AUTH-01 | ログイン施設/ユーザ選択 | 施設/ユーザ選択 UI と切替導線（権限境界の明示） | 単一施設前提の入力フロー | 複数施設運用時の入口が不足 | UI / 権限 / 運用 | 仕様 / 実装 / テスト |
| GAP-AUTH-02 | 施設/ユーザ切替 | ログアウト→再ログインの安全な切替フローと履歴保護 | 明示的な切替導線なし | 誤操作・権限越境リスク | 運用 / 権限 / 監査 | 仕様 / 実装 |
| GAP-AUTH-03 | 権限境界の運用フロー | 役割別の可視化/拒否理由/承認導線が明確 | UI 非活性中心で運用フロー未整備 | 実運用での判断材料が不足 | 権限 / 運用 / 監査 | 仕様 / 運用 / テスト |
| GAP-CHT-01 | Charts 印刷（外来/文書） | 実 PDF 生成/プレビュー/送信/復旧導線 | 監査ログ中心で実処理は限定的 | 印刷の業務完結性が不足 | 運用 / 監査 / UI | 実装 / テスト |
| GAP-CHT-02 | Charts 診療終了/送信 | 署名/送信の実処理と結果反映 | デモ扱い（監査のみ） | 受付・会計連携が未完 | 運用 / 監査 | 実装 / テスト |
| GAP-CHT-03 | Charts 患者安全ヘッダ | 旧来版同等の患者安全ヘッダ（氏名強調/年齢/和暦） | 未実装 | 誤認防止の導線不足 | UI / 運用 | 仕様 / 実装 |
| GAP-CHT-04 | Charts ドキュメント履歴 | 検索・フィルタ・閲覧ガードと履歴 UI の統合 | DocumentTimeline はあるが要件未充足 | 履歴確認と監査が弱い | UI / 監査 | 仕様 / 実装 |
| GAP-COM-01 | 共通 RUN_ID/通知 | RUN_ID コピー/通知トースト/ナビバッジ | 未実装 | 運用・障害時通知が不足 | UI / 運用 | 仕様 / 実装 |
| GAP-COM-02 | 共通 data-run-id 統一 | 画面横断で data-run-id/aria-live が統一 | 付与箇所が統一されていない | 監査・可観測性の整合不足 | 監査 / 運用 | 仕様 / 実装 / テスト |

## 追加検討候補の整理（分類別サマリ）

### 仕様
- 配信タイミング（即時/次回リロード/再ログイン）の統一ルール確定
- Reception 例外一覧の対象条件と「次の一手」定義
- Charts 印刷/送信の成功・失敗時 UI メッセージと復旧導線
- ログイン時の施設/ユーザ選択・切替手順と権限境界の提示ルール

### 実装
- Reception 右ペインと列拡張
- Administration 管理メニュー（マスタ/権限/セット/通知/監査設定）追加
- Charts 印刷/送信の実処理連携
- 施設/ユーザ切替導線（安全なログアウト/再ログイン）と権限ガード表示

### 運用
- 配信バージョン/ETag/反映遅延の運用監視と記録手順
- 管理変更のロールバック・再配信手順
- Patients/Reception の未紐付警告の運用フロー
- 複数施設運用時のログイン/切替/監査記録の運用手順

### 監査
- 画面横断の監査イベント分類と必須メタ統一
- Patients/Administration の監査履歴検索 UI
- 受付・印刷・送信の監査ログ永続化証跡
- 施設/ユーザ切替・権限拒否の監査イベント定義

### テスト
- Login→Reception→Charts→Patients→Administration の主要フロー E2E
- 権限制御（UI/サーバ）一致の回帰テスト
- 配信反映遅延/エラーの再現テストと証跡
- 複数施設/複数ロールでのログイン切替と権限境界テスト

## 参照ドキュメント
- `docs/DEVELOPMENT_STATUS.md`
- `src/discovery/対象範囲と成果物定義.md`
- `src/webclient_productionization/01_現状実装棚卸しとギャップ整理.md`
- `docs/web-client/ux/reception-schedule-ui-policy.md`
- `docs/web-client/ux/patients-admin-ui-policy.md`
- `docs/web-client/ux/admin-delivery-validation.md`
- `docs/web-client/ux/charts-claim-ui-policy.md`
