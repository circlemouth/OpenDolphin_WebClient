# 非カルテ入力ユーザーフロー整理

- RUN_ID: `20251230T181259Z`
- 期間: 2026-01-01 09:00 〜 2026-01-02 09:00 (JST) / 優先度: medium / 緊急度: high / エージェント: codex
- YAML ID: `src/modernized_review/非カルテ入力ユーザーフロー整理.md`

## 参照チェーン
1. `docs/DEVELOPMENT_STATUS.md`
2. `web-client/src/AppRouter.tsx`
3. `web-client/src/features/login/FacilityLoginResolver.tsx`
4. `web-client/src/features/reception/pages/ReceptionPage.tsx`
5. `web-client/src/features/patients/PatientsPage.tsx`
6. `web-client/src/features/administration/AdministrationPage.tsx`

## 対象範囲
- 非カルテ入力の画面: Login / Reception / Patients / Administration（設定・配信）/ Outpatient Mock
- Charts は「遷移先」としてのみ記載（詳細フローは対象外）。

## 1. 画面遷移図（テキスト）

```
[未ログイン]
  |  /login
  |  /f/:facilityId/login
  |  旧URL(/reception,/patients,/administration,...) → /login へリダイレクト
  v
[Login: FacilityLoginResolver → LoginScreen]
  |  成功: state.from があればそこへ、それ以外は /f/:facilityId/reception
  |  失敗: Login 画面に留まる
  v
[FacilityShell (/f/:facilityId/*)]
  |  index → /f/:facilityId/reception
  |  左ナビで遷移
  |   ├─ /f/:facilityId/reception
  |   ├─ /f/:facilityId/patients
  |   ├─ /f/:facilityId/administration (role gate)
  |   └─ /f/:facilityId/outpatient-mock
  |
  |  Reception/Patients から Charts へ遷移（非カルテ入力の出口）
  v
[Logout / Session Expired] → /login
```

## 2. 主要操作の入口/出口

### Login / Facility 入口
- 入口
  - `/login`（施設ID未指定）
  - `/f/:facilityId/login`（施設ID固定）
  - 旧URLアクセス時の強制リダイレクト（state.from を保持）
  - セッション切れ通知からの強制リダイレクト
- 出口
  - ログイン成功 → `state.from` へ復帰（無ければ `/f/:facilityId/reception`）
  - ログイン失敗 → Login 画面に留まる
  - 既ログイン状態で Login ルートへ入った場合 → `/f/:facilityId/reception`

### AppShell / 共通ナビゲーション
- 入口
  - ログイン成功後に `FacilityShell` が表示
  - `/f/:facilityId/` の index は `/f/:facilityId/reception` へ遷移
- 出口
  - 左ナビで Reception / Patients / Administration / Outpatient Mock へ移動
  - `ログアウト` で `/login` へ戻る

### Reception（受付）
- 入口
  - ログイン直後のデフォルト遷移先
  - 左ナビからの遷移
  - 旧 `/reception` アクセス（施設ID付きにリダイレクト）
- 主な操作
  - 受付一覧の検索/フィルタ/ソート（URL と localStorage へ同期）
  - 受付行の選択・ダブルクリックで Charts へ遷移（RUN_ID 継承 + フィルタ引継ぎ）
  - 受付/ORCA キューの状態確認、Admin 配信バナーの閲覧
- 出口
  - Charts へ遷移（非カルテ入力の出口）
  - Patients / Administration へナビ遷移
  - ログアウト

### Patients（患者管理）
- 入口
  - 左ナビからの遷移
  - Charts からの戻り導線（returnTo/受付フィルタの復元）
  - 旧 `/patients` アクセス（施設ID付きにリダイレクト）
- 主な操作
  - 患者検索・一覧表示
  - 患者情報の編集/保存/削除と監査表示
  - missingMaster / fallback / transition 条件の編集ブロック
- 出口
  - Charts へ遷移（非カルテ入力の出口）
  - Reception へ戻る導線
  - Administration へナビ遷移
  - ログアウト

### Administration（設定・配信）
- 入口
  - 左ナビ（role=system_admin/admin 等で有効化）
  - 直接 URL: `/f/:facilityId/administration`
- 主な操作
  - ORCA 接続設定/配信フラグの編集・保存
  - 配信キューの再送/破棄
  - Admin 配信バナーの更新（Reception/Charts/Patients に影響）
- 出口
  - Reception / Patients へナビ遷移
  - ログアウト

### Outpatient Mock（QA/検証）
- 入口
  - 左ナビからの遷移（`/f/:facilityId/outpatient-mock`）
- 主な操作
  - MSW シナリオ切替、tone/transition の強制
  - 受付〜カルテ導線の事前検証
- 出口
  - Reception / Charts へ遷移
  - ログアウト
