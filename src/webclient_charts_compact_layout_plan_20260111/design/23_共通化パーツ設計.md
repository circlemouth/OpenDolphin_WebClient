# 23 共通化パーツ設計

- RUN_ID: `20260111T075557Z`
- 期間: 2026-01-11 21:00 〜 2026-01-12 21:00 (JST) / 優先度: high / 緊急度: high / エージェント: codex
- YAML ID: `src/webclient_charts_compact_layout_plan_20260111/design/23_共通化パーツ設計.md`

## 参照
- `docs/DEVELOPMENT_STATUS.md`
- `src/webclient_charts_compact_layout_plan_20260111/discovery/11_重複UIコンポーネント整理.md`
- `docs/web-client/ux/charts-compact-layout-proposal-20260110.md`
- `web-client/src/features/shared/RunIdBadge.tsx`
- `web-client/src/features/shared/StatusBadge.tsx`

---

## 1. 目的と前提
- Charts コンパクトレイアウトで **重複する患者メタ/RunId/監査サマリ/ステータス表示**を共通化する。
- 共有部品は `web-client/src/features/shared/` に置き、**画面固有（charts/reception/patients）への依存を禁止**する。
- `StatusBadge`（カード内の詳細表示）と **`StatusPill`（ヘッダ/メタバー向け）を分離**する。

---

## 2. 共通パーツ API 定義

### 2-1. PatientMetaRow
患者 ID 群（患者ID/受付ID/予約ID）を **1行 or 2行で統一表示**するための行コンポーネント。

```ts
export type PatientMetaRowVariant = 'compact' | 'detailed';

export interface PatientMetaRowProps {
  patientId?: string;
  receptionId?: string;
  appointmentId?: string;
  birthDateIso?: string;
  birthDateEra?: string;
  sex?: string;
  age?: string;
  variant?: PatientMetaRowVariant; // compact=IDのみ / detailed=性別・年齢・生年月日も含める
  showLabels?: boolean; // 既定 true: "患者ID:" を付与
  showEmpty?: boolean; // 既定 false: 値が未設定の項目は非表示
  separator?: 'pipe' | 'slash' | 'dot'; // 既定 'pipe'
  runId?: string; // data-run-id 用
  className?: string;
  ariaLabel?: string; // 明示指定が必要な場合のみ
}
```

**表示ルール（既定）**
- `compact`: `患者ID / 受付ID / 予約ID` のみを 1 行で表示。
- `detailed`: `compact` + `性別/年齢/生年月日（和暦/ISO）` を 2 行目に表示。
- 主要 ID が未設定の場合は `—` ではなく **項目ごと非表示**を優先（`showEmpty=true` の場合のみ `—` 表示）。

---

### 2-2. RunIdBadge（既存）
RunId 表示・コピーを提供する既存部品。**API は維持**し、レイアウト規約を明記する。

```ts
type RunIdBadgeProps = {
  runId?: string;
  tone?: LiveRegionTone; // 既定 'info'
  showCopy?: boolean; // 既定 true
  className?: string;
};
```

**使用ルール**
- ヘッダ/メタバーの先頭に配置し、**RunId を最初に視認できる並び**を維持する。
- サイズ差分が必要な場合は `className` で **`runid-badge--sm` / `runid-badge--xs`** などを指定する（API 拡張は不要）。

---

### 2-3. StatusPill（新規）
Charts/Reception の `span` ベース pill 群を統一する **軽量ステータス表示**。

```ts
export type StatusPillTone = 'neutral' | 'info' | 'success' | 'warning' | 'error';
export type StatusPillSize = 'xs' | 'sm' | 'md';

export interface StatusPillProps {
  label?: string; // "missingMaster" など
  value?: ReactNode; // "true" など
  tone?: StatusPillTone; // 既定 'neutral'
  size?: StatusPillSize; // 既定 'sm'
  ariaLive?: LiveRegionAria; // 既定 'off'
  runId?: string;
  className?: string;
  ariaLabel?: string; // label/value から合成できない場合のみ
  children?: ReactNode; // label/value の代替（任意）
}
```

**表示ルール（既定）**
- `label` + `value` がある場合は `label: value` を表示。
- `children` がある場合は `label/value` より優先して表示。
- `tone` はテキスト/背景の軽い差分（バッジより抑えめ）。
- `StatusBadge` とは **用途を分離**（カード内は StatusBadge、ヘッダ/メタバーは StatusPill）。

---

### 2-4. AuditSummaryInline（新規）
監査イベントの簡易サマリを **inline/pill/bannner** で表示する共通部品。

```ts
export type AuditSummaryTone = 'info' | 'warning' | 'error';
export type AuditSummaryVariant = 'inline' | 'pill' | 'banner';

export type AuditSummary = {
  action?: string;
  outcome?: string;
  actor?: string;
  note?: string;
  lockExpiresAt?: string;
  traceId?: string;
  timestamp?: string; // 最終更新などで利用
  message?: string; // 明示指定する場合は最優先
};

export interface AuditSummaryInlineProps {
  auditEvent?: Record<string, unknown>; // raw payload
  summary?: AuditSummary; // 事前に整形済みの場合
  tone?: AuditSummaryTone; // 既定 'info'
  variant?: AuditSummaryVariant; // 既定 'inline'
  showActor?: boolean; // 既定 true
  showTrace?: boolean; // 既定 false
  showNote?: boolean; // 既定 false
  showLock?: boolean; // 既定 true
  maxFragments?: number; // 既定 4
  ariaLive?: LiveRegionAria;
  runId?: string;
  className?: string;
}
```

**抽出ロジックの方針**
- `summary.message` があれば最優先で使用。
- `auditEvent` から以下を抽出し、`action(outcome)` を先頭に並べる。
  - `action`, `outcome`, `details.actor`, `details.note`, `details.lockExpiresAt`, `details.traceId`
- `tone` は **衝突/ロック系 = warning / それ以外 = info** を既定とし、必要に応じて上書き可能とする。

---

## 3. shared 配置・依存関係の整理

### 3-1. 配置案
```
web-client/src/features/shared/
  components/
    PatientMetaRow.tsx
    RunIdBadge.tsx
    StatusPill.tsx
    AuditSummaryInline.tsx
  styles/
    runIdBadge.css (既存 app-shell.css から整理)
    statusPill.css
    auditSummaryInline.css
  utils/
    auditSummary.ts (auditEvent → AuditSummary 変換)
  index.ts
```

### 3-2. 依存ルール
- **許可**: `web-client/src/libs/*` / `web-client/src/styles/*` / `web-client/src/features/shared/*`
- **禁止**: `web-client/src/features/{charts,reception,patients,administration}` への直接依存
- `StatusBadge` の `reception/styles` 依存は **shared/styles へ移動**し、相互参照を解消する。
- `RunIdBadge` の `app-shell.css` 依存は **shared/styles へ段階的に移行**し、画面間の暗黙依存を減らす。

---

## 4. 移植対象一覧（優先順）

### 4-1. PatientMetaRow
| 画面/領域 | 現状 | 移植内容 |
| --- | --- | --- |
| Charts SummaryBar（患者ヘッダ/安全表示統合） | `charts-patient-header` / `charts-safety__meta` | ID 群を `PatientMetaRow (compact)` に置換 |
| Charts Safety 詳細（折りたたみ） | `charts-safety__meta` | `PatientMetaRow (detailed)` を配置 |
| Charts PatientsTab 重要行/一覧 | `patients-tab__row-id` / 詳細 ID 行 | `PatientMetaRow (compact)` |
| Reception 右ペイン 患者概要 | `reception-sidepane__item` の ID 行 | `PatientMetaRow (compact)` |
| Reception 一覧テーブル | 受付/予約 ID セル | `PatientMetaRow (compact)`（ID セルとして利用） |

### 4-2. RunIdBadge
| 画面/領域 | 現状 | 移植内容 |
| --- | --- | --- |
| Charts Topbar | `RunIdBadge + charts-page__pill` | 既存維持、サイズ規約を統一 |
| Reception Header | `RunIdBadge + reception-pill` | 既存維持、StatusPill 併用へ |
| Patients Header | `RunIdBadge + StatusBadge` | 既存維持、StatusPill 併用検討 |
| Administration Header | `RunIdBadge` | 既存維持、レイアウト規約のみ適用 |

### 4-3. StatusPill
| 画面/領域 | 現状 | 移植内容 |
| --- | --- | --- |
| Charts Topbar | `.charts-page__pill` 群 | `StatusPill` に置換（dataSource/flags/lastUpdated 等） |
| Reception Header | `.reception-pill` 群 | `StatusPill` に置換（dataSourceTransition/missingMaster/cacheHit/fetchedAt） |
| Charts ActionBar | `.charts-actions__pill` 群 | `StatusPill` に置換（runId/traceId/transition 等） |
| Patients 監査行 | `.patients-page__audit-pill` | tone を持つ `StatusPill` へ統合（任意） |

### 4-4. AuditSummaryInline
| 画面/領域 | 現状 | 移植内容 |
| --- | --- | --- |
| Charts DocumentTimeline | `ToneBanner` + `auditSummary` | `AuditSummaryInline (banner)` へ置換 or 内包化 |
| Charts Topbar 最終更新 | `formattedLastUpdated` の手組み | `AuditSummaryInline (inline)` へ置換 |
| Charts PatientsTab 監査サマリ | raw 展開 + pill | `AuditSummaryInline (inline/pill)` を追加 |
| PatientsPage 監査サマリ | raw 展開 | `AuditSummaryInline (inline)` を追加（raw 展開は別枠で維持） |

---

## 5. 運用メモ
- `StatusPill` と `StatusBadge` の **用途分離**を維持し、カード内は `StatusBadge` を優先。
- `AuditSummaryInline` は **ToneBanner に依存せず**、ToneBanner が必要な場合は `AuditSummaryInline` を内部で利用する。
- 共有部品の CSS は `shared/styles` に集約し、feature CSS への逆依存を排除する。

---

## 6. 未決事項
- `StatusPill` の色トークン（Charts/Reception の既存配色との互換確認）。
- `AuditSummaryInline` の `variant=banner` と `ToneBanner` の置換範囲（既存テストの影響確認）。
