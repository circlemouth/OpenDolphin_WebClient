# 11 重複 UI コンポーネント整理（RUN_ID=20260110T231957Z）

## 目的
- Charts コンパクトレイアウト案に合わせ、患者メタ / RunId / 監査メタの **重複箇所と props** を棚卸しする。
- 共有候補（PatientMetaRow / RunIdBadge / StatusPill / AuditSummaryInline）の **適用範囲** を整理する。
- 成果物として **共通化対象と配置マトリクス** を提供する。

## 参照
- `docs/DEVELOPMENT_STATUS.md`
- `docs/web-client/ux/charts-compact-layout-proposal-20260110.md`
- `web-client/src/features/charts/*`

---

## 1. 重複箇所の棚卸し（患者メタ / RunId / 監査メタ）

### 1-1. 患者メタ（患者ID/受付ID/予約IDなど）
| 画面/コンポーネント | 表示項目 | 現状 props / 参照元 | 重複ポイント |
| --- | --- | --- | --- |
| Charts `ChartsPage` 患者ヘッダ (`#charts-patient-header`) | 患者番号/性別・年齢/生年月日/受付番号/予約番号 | `patientDisplay` / `patientId` / `receptionId` / `appointmentId` | 安全表示・PatientsTab と ID 系が重複 |
| Charts `ChartsPage` 安全表示 (`#charts-safety-display`) | 患者ID/受付ID/予約ID/生年月日(ISO)/和暦/性別/年齢/RUN_ID/missingMaster | `patientDisplay.*` / `resolvedRunId` / `resolvedMissingMaster` | 患者ヘッダと ID 行が重複し、RunId/監査系も混在 |
| Charts `PatientsTab` 重要行 | 氏名/患者ID/受付ID/保険/状態 | `selected` / `selectedContext` | 患者ヘッダ/安全表示と ID 情報が重複 |
| Charts `PatientsTab` 一覧行 | 患者ID / 受付ID | `patient.patientId` / `patient.receptionId` / `patient.appointmentId` | Reception 一覧と同種の ID 表示が分散 |
| Reception 一覧テーブル | 患者ID / 受付ID or 予約ID | `entry.patientId` / `entry.receptionId` / `entry.appointmentId` | Charts/PatientsTab と同様の ID 表現 |
| Reception 右ペイン「患者概要」 | 患者ID / 受付・予約ID | `selectedEntry.*` | ID ブロックが再利用可能 |
| ToneBanner（Charts/Reception/Patients） | 患者ID / 受付ID (付帯) | `patientId` / `receptionId` | 患者ID 表示の粒度がばらつく |

### 1-2. RunId 表示
| 画面/コンポーネント | 表示項目 | 現状 props / 参照元 | 重複ポイント |
| --- | --- | --- | --- |
| Charts `ChartsPage` ヘッダ | RunIdBadge + pill群 | `RunIdBadge` (`runId`, `tone`, `showCopy`, `className`) / `resolvedRunId` | RunIdBadge は共有済みだが周辺 pill 表記が画面固有 |
| Reception `ReceptionPage` ヘッダ | RunIdBadge + `reception-pill` | `RunIdBadge` / `mergedMeta.runId` | Charts と同じ情報構造を別 UI で表示 |
| Patients `PatientsPage` ヘッダ | RunIdBadge + StatusBadge 群 | `RunIdBadge` / `StatusBadge` | RunId + 状態表示の並びが画面ごとに異なる |
| Administration `AdministrationPage` ヘッダ | RunIdBadge | `RunIdBadge` | RunId 表示の配置は統一済みだがレイアウト規約が不足 |
| Charts 安全表示 | `RUN_ID` 文字列 | `resolvedRunId` | RunIdBadge と重複表示 |

### 1-3. 監査メタ（auditEvent / audit log summary）
| 画面/コンポーネント | 表示項目 | 現状 props / 参照元 | 重複ポイント |
| --- | --- | --- | --- |
| Charts `DocumentTimeline` | auditEvent のサマリ（ToneBanner） | `auditEvent` → `auditSummary` (action/outcome/actor/note/lockExpiresAt) | PatientsTab の auditEvent 表示と分岐 |
| Charts `PatientsTab` | auditEvent 詳細（raw 展開） + 監査モーダル | `auditEvent`, `auditSnapshot` | Timeline と仕様が分裂、表示粒度が統一されていない |
| Charts `ChartsPage` トップバー | 最終更新 (audit log から抽出) | `auditEvents` → `formattedLastUpdated` | audit サマリの別形式（短文） |
| Reception `ReceptionAuditPanel` | auditEvent 検索・一覧 | `runId` / `selectedEntry` | 監査 UI は専用だが、抜粋サマリの共通部品は未整備 |

---

## 2. 共有候補コンポーネントの props 整理

### 2-1. PatientMetaRow（新規候補）
**目的**: 患者ID/受付ID/予約IDの共通表示を 1 行（または 2 行）に圧縮。

**必要 props（現状利用の最小集合）**
- `patientId?: string`
- `receptionId?: string`
- `appointmentId?: string`
- `variant?: 'compact' | 'detailed'`（label 表示/折り返しなど）
- `showLabels?: boolean`（例: `患者ID:` を出すか）
- `runId?: string`（data-run-id 用）

**派生 props（Charts 安全表示の詳細用）**
- `birthDateIso?: string`
- `birthDateEra?: string`
- `sex?: string`
- `age?: string`

### 2-2. RunIdBadge（既存）
**現状 props**
- `runId?: string`
- `tone?: LiveRegionTone`
- `showCopy?: boolean`
- `className?: string`

**補足**: Charts/Reception/Patients で利用済み。RunId 表示位置や周辺 pill 表現は統一されていない。

### 2-3. StatusPill（新規候補）
**目的**: Charts/Reception の `span` ベース pill 群を統一し、StatusBadge（カード内）と差別化。

**想定 props**
- `label: string`
- `value: string`
- `tone?: 'info' | 'warning' | 'success' | 'error'`
- `ariaLive?: LiveRegionAria`
- `runId?: string`
- `size?: 'xs' | 'sm' | 'md'`（トップバー用）

**対象データ**
- `dataSourceTransition`
- `missingMaster`
- `cacheHit`
- `fallbackUsed`
- `recordsReturned` / `fetchedAt`
- `lastUpdated` (audit summary を短く)

### 2-4. AuditSummaryInline（新規候補）
**目的**: auditEvent の短いサマリ表示（ToneBanner/Topbar/Modal の共通ベース）

**必要 props**
- `auditEvent?: Record<string, unknown>`
- `runId?: string`
- `variant?: 'pill' | 'inline' | 'banner'`
- `tone?: 'info' | 'warning' | 'error'`
- `showTrace?: boolean`
- `showActor?: boolean`

**抽出対象フィールド（既存ロジックから集約）**
- `action` / `outcome`
- `details.actor` / `details.note`
- `details.lockExpiresAt`
- `details.traceId`

---

## 3. 共有候補の配置マトリクス

記号: **◎=適用確定候補 / ○=適用候補 / △=要調整 / —=対象外**

| 画面/領域 | PatientMetaRow | RunIdBadge | StatusPill | AuditSummaryInline |
| --- | --- | --- | --- | --- |
| Charts SummaryBar（患者ヘッダ+安全表示統合） | ◎ | ◎ | ○ | △ |
| Charts Safety 詳細（折りたたみ） | ○（detailed variant） | ○ | — | ○ |
| Charts Topbar（現 `charts-page__meta`） | — | ◎ | ◎ | ○（最終更新の短文） |
| Charts PatientsTab（重要行/一覧） | ◎ | — | ○（tone/role など） | ○（監査サマリ行） |
| Charts DocumentTimeline（監査サマリ） | — | — | — | ◎（ToneBanner 置換 or 内包） |
| Reception Header | — | ◎ | ◎ | — |
| Reception 一覧テーブル | ○（ID セル） | — | — | — |
| Reception 右ペイン 患者概要 | ◎ | — | — | — |
| Patients Header | — | ◎ | ○（StatusBadge と住み分け） | — |
| Administration Header | — | ◎ | ○ | — |

---

## 4. 共通化対象（優先度付き）
1. **PatientMetaRow**: Charts SummaryBar / Reception 右ペイン / PatientsTab 重要行で共通化。
2. **StatusPill**: Charts/Reception のトップバー pill 群を統合。
3. **AuditSummaryInline**: DocumentTimeline の ToneBanner と Charts Topbar の最終更新表示を統合。
4. **RunIdBadge**: 既存利用のレイアウト規約化（並び順・サイズ・余白）。

---

## 補足
- `StatusBadge` はカード内の詳細表示に適合しており、**StatusPill はヘッダ/メタバー用途**で分離する。
- PatientMetaRow は **ID 3点（患者/受付/予約）を基準**とし、必要な詳細（性別/年齢/生年月日）は **variant=detailed** で拡張する。
- AuditSummaryInline は **ToneBanner に依存しない簡易サマリ**として用意し、ToneBanner からも利用可能にする。
