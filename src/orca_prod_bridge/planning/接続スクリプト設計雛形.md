# 接続スクリプト設計雛形（RUN_ID=20251211T090000Z）
- 期間: 2025-12-11 09:00 - 2025-12-12 09:00（JST） / 優先度: high / 緊急度: high / YAML ID: `src/orca_prod_bridge/planning/接続スクリプト設計雛形.md`
- 目的: `setup-modernized-env.sh` を前提に、ORCAcertification の認証情報を環境変数経由で安全に受け取り、本番ターゲットへの誤接続を防ぎつつ RUN_ID に紐づく証跡パスを自動生成する接続スクリプトの設計雛形をまとめる。

## 参照チェーン
- `AGENTS.md` → `docs/web-client/README.md` → `docs/server-modernization/phase2/INDEX.md` → `docs/managerdocs/PHASE2_MANAGER_ASSIGNMENT_OVERVIEW.md`
- `docs/managerdocs/PHASE2_ORCA_CONNECTIVITY_MANAGER_CHECKLIST.md`
- `docs/server-modernization/phase2/operations/ORCA_CONNECTIVITY_VALIDATION.md`
- `ORCAcertification/README_PASSPHRASE.md`（認証値は `<MASKED>` 運用）

## 前提と設計方針
- Web クライアントは `WEB_CLIENT_MODE=npm ./setup-modernized-env.sh` で起動し、モダナイズ版サーバーをローカル Docker で立ち上げた状態を前提とする。
- 接続スクリプトは bash 想定（Python 実行禁止ルールを踏まえ POSIX+α に収める）。既存の `read_orca_info` のパターンを踏襲しつつ、本番接続専用の環境変数を追加で受け取る。
- 認証情報は **必ず環境変数で受け取り、echo/log 時には `<MASKED>` に置き換える**。`ORCAcertification/` 配下のファイルは直接参照せず、事前に `export` した値のみを使用する。

## 入力インターフェイス案（環境変数／引数）
- 必須 RUN_ID: `RUN_ID` または `--run-id <YYYYMMDDThhmmssZ>`。未設定ならエラー終了。正規表現 `^[0-9]{8}T[0-9]{6}Z$` で検証。
- ORCAcertification 認証情報（全て環境変数で受け取り、欠落時はエラー）  
  - `ORCA_PROD_CERT_PATH` … PKCS#12 ファイルパス（例: `ORCAcertification/103867__JP_u00001294_client3948.p12`。パーミッション 600 前提）  
  - `ORCA_PROD_CERT_PASS` … PKCS#12 パスフレーズ  
  - `ORCA_PROD_BASIC_USER` / `ORCA_PROD_BASIC_KEY` … Basic 認証（ユーザー/キー）
- 接続ターゲット:  
  - `ORCA_PROD_HOST`（デフォルト `weborca.cloud.orcamo.jp`）  
  - `ORCA_PROD_PORT`（デフォルト `443`）  
  - `ORCA_PROD_SCHEME`（デフォルト `https`）  
  - `ORCA_PROD_API_PATH`（例: `/api/api01rv2/acceptlstv2?class=01`。実行時引数 `--api-path` で上書き可）
- 動作フラグ: `--dry-run`（コマンド生成のみ）、`--yes`（ガードの確認プロンプトを自動承認）、`--force-target <host>`（デフォルト以外への接続を許可する場合のみ明示）。

## 証跡パス自動生成
- ベース: `RUN_ID` をキーに、以下を自動生成・作成する。存在しない場合は `mkdir -p`。  
  - ログ: `docs/server-modernization/phase2/operations/logs/<RUN_ID>-orca-prod-bridge.md`（手順・判断ログ用のひな型を同時に生成）  
  - 証跡ディレクトリ: `artifacts/orca-connectivity/<RUN_ID>/`  
    - `httpdump/` … `curl --dump-header` で取得したヘッダー  
    - `trace/` … `--trace-ascii` での通信ログ  
    - `data-check/` … PHI マスク後のレスポンス JSON など  
  - `tmp/orca-prod-bridge/<RUN_ID>/` … 一時ファイル（実行後に消去可）
- 生成時は `umask 077` を設定し、ディレクトリ権限を 700 相当に固定する。ファイル出力時は `tee` を使わず `cat > file` に限定。

## 誤用防止ガード（target 確認プロンプト）
- 実行前に以下をまとめて確認し、`--yes` がない限り対話プロンプトを出す。  
  1. 接続先ホスト/ポート/スキーム: `${ORCA_PROD_SCHEME}://${ORCA_PROD_HOST}:${ORCA_PROD_PORT}` が `https://weborca.cloud.orcamo.jp:443` であるかを表示し、差異がある場合は赤字警告。  
  2. RUN_ID: 現在の `RUN_ID` を表示し、未設定なら即時中断。  
  3. 出力先: `docs/server-modernization/phase2/operations/logs/<RUN_ID>-...` と `artifacts/.../<RUN_ID>/` を示し、PHI マスク義務を再確認。  
  4. 認証情報: 変数名のみ表示し、値は `<MASKED>` として存在チェック。空ならエラー終了。  
  5. `--force-target` を伴う場合は「Stage/Preview ではないか」「ORCA_CERTIFICATION_ONLY に従うか」を追記した 2 重確認。
- プロンプト例: `Proceed to call https://weborca.cloud.orcamo.jp:443 (RUN_ID=20251211T090000Z)? [y/N]`。`y`/`yes` 以外は中断。

## 実行フロー雛形（bash 擬似コード）
```
parse_args()  # --run-id/--api-path/--dry-run/--yes/--force-target を処理
require_run_id && validate_pattern
require_env ORCA_PROD_CERT_PATH ORCA_PROD_CERT_PASS ORCA_PROD_BASIC_USER ORCA_PROD_BASIC_KEY
set_defaults ORCA_PROD_HOST=weborca.cloud.orcamo.jp ORCA_PROD_PORT=443 ORCA_PROD_SCHEME=https
export RUN_ID  # 以後のコマンドとログ生成で使用
prepare_paths_with_umask   # logs/<RUN_ID>-*.md, artifacts/<RUN_ID>/*, tmp/<RUN_ID>
render_log_stub            # ログ md をテンプレートで作成（参照チェーンとマスク注意喚起を含む）
show_guard_info_and_confirm
if ! dry_run; then
  curl --cert-type P12 --cert "${ORCA_PROD_CERT_PATH}:${ORCA_PROD_CERT_PASS}" \
       -u "${ORCA_PROD_BASIC_USER}:${ORCA_PROD_BASIC_KEY}" \
       --trace-ascii "trace/${RUN_ID}-orca-prod.trace" \
       --dump-header "httpdump/${RUN_ID}-headers.txt" \
       --output "data-check/${RUN_ID}-response.json" \
       "${ORCA_PROD_SCHEME}://${ORCA_PROD_HOST}:${ORCA_PROD_PORT}${ORCA_PROD_API_PATH}"
  # レスポンス整形: jq 等で PHI を除去し `<MASKED>` を追加（記述のみ、実装は別途）
fi
cleanup_tmp_if_needed
echo "DONE: logs/.../${RUN_ID}-orca-prod-bridge.md"
```

## フォローアップ/未決事項
- `docs/server-modernization/phase2/operations/ORCA_CERTIFICATION_ONLY.md` がリポジトリに存在しないため、ガード文言や接続許可条件を同ファイルと整合させる作業が別途必要。
- PHI マスク処理の具体例（jq フィルタなど）は別タスクで補完する。現段階ではログひな型に「PHI を残さない」旨を明記する。
- スクリプト実装時は `docs/web-client/planning/phase2/DOC_STATUS.md` の該当行に RUN_ID と証跡パスを追記する運用を前提とする。
