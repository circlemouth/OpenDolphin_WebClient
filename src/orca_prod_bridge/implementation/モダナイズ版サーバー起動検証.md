# モダナイズ版サーバー起動検証（RUN_ID=20251210T130644Z）
- 期間: 2025-12-14 09:00 - 2025-12-15 09:00 JST（窓外での本番接続禁止）
- YAML ID: `src/orca_prod_bridge/implementation/モダナイズ版サーバー起動検証.md`
- 目的: 新スクリプト `scripts/orca_prod_bridge.sh` を用いて **server-modernized** を起動し、webORCA 本番 (`https://weborca.cloud.orcamo.jp`) との TLS ハンドシェイクおよび API 応答（最低 `/api/api01rv2/acceptlstv2?class=01`）を取得する。結果は ORCA_API_STATUS / ORCA_CONNECTIVITY_VALIDATION の運用に沿って RUN_ID 付きで記録する。

## 参照チェーン / 更新対象
- 参照: `AGENTS.md` → `docs/web-client/README.md` → `docs/server-modernization/phase2/INDEX.md` → `docs/managerdocs/PHASE2_MANAGER_ASSIGNMENT_OVERVIEW.md` → `docs/managerdocs/PHASE2_ORCA_CONNECTIVITY_MANAGER_CHECKLIST.md`
- 手順: `docs/server-modernization/phase2/operations/ORCA_CONNECTIVITY_VALIDATION.md`（接続/証跡ルール）, `docs/server-modernization/phase2/operations/ORCA_API_STATUS.md`（ステータス反映）
- 証跡: `docs/server-modernization/phase2/operations/logs/20251210T130644Z-orca-prod-bridge.md`（本 RUN 用ログ stub + 実行結果）、`artifacts/orca-connectivity/20251210T130644Z/{httpdump,trace,data-check,tls}/`
- 棚卸し: `docs/web-client/planning/phase2/DOC_STATUS.md` ORCA 接続行の備考へ RUN_ID/証跡パスを追記

## 前提条件・環境
- 実行端末: WSL（outbound HTTPS 許可を事前確認）。`umask 077` で証跡生成。
- サーバー起動: `WEB_CLIENT_MODE=npm ./setup-modernized-env.sh` で server-modernized を起動し、`/serverinfo/claim/conn` が `server` であることを確認（証跡を artifacts 配下に保存）。
- 認証情報: `ORCA_PROD_CERT_PATH/ORCA_PROD_CERT_PASS/ORCA_PROD_BASIC_USER/ORCA_PROD_BASIC_KEY` を環境変数で供給し、ログには `<MASKED>` としてのみ記載。作業後に `unset ORCA_PROD_*`。
- ポリシー確認: `docs/server-modernization/phase2/operations/ORCA_CERTIFICATION_ONLY.md` を接続ポリシーの唯一の根拠として参照し、手順・ログは本ファイルと同一 RUN_ID で同期する。

## 実施手順（期間内）
1. **事前 dry-run**（本番接続なし）  
   `RUN_ID=20251210T130644Z ORCA_PROD_CERT_PATH=... ORCA_PROD_CERT_PASS=... ORCA_PROD_BASIC_USER=... ORCA_PROD_BASIC_KEY=... ./scripts/orca_prod_bridge.sh --dry-run --yes`  
   - 目的: ログ stub と `artifacts/...` ディレクトリ生成のみ。curl 実行なし。
2. **server-modernized 起動確認**  
   - `WEB_CLIENT_MODE=npm ./setup-modernized-env.sh` を実行。  
   - `curl http://localhost:8080/openDolphin/resources/serverinfo/claim/conn` を取得し、`artifacts/orca-connectivity/20251210T130644Z/serverinfo/claim_conn.json` に保存。`claim.conn=server` でない場合は `ops/shared/docker/custom.properties` 等の `claim.*` を修正し差分を同 RUN_ID 配下へ保存。
3. **webORCA 本番 TLS ハンドシェイク + API 実行**（期間内に限定）  
   - コマンド例（本番ホストのみ、認証値マスク必須）:  
     ```bash
     RUN_ID=20251210T130644Z \
     ORCA_PROD_CERT_PATH=/path/to/ORCAcertification/103867__JP_u00001294_client3948.p12 \
     ORCA_PROD_CERT_PASS=<MASKED> \
     ORCA_PROD_BASIC_USER=<MASKED> \
     ORCA_PROD_BASIC_KEY=<MASKED> \
     ./scripts/orca_prod_bridge.sh --yes --method POST --api-path "/api/api01rv2/acceptlstv2?class=01"
     ```
   - `--force-target` は webORCA 以外のホスト指定時のみ使用可（通常禁止）。
4. **結果整理**  
   - `docs/server-modernization/phase2/operations/logs/20251210T130644Z-orca-prod-bridge.md` に HTTP ステータス・`Api_Result`・実行端末・使用コマンド（マスク済）を記載。  
   - `ORCA_API_STATUS.md` に最新結果 RUN_ID と next action を追記。  
   - `ORCA_CONNECTIVITY_VALIDATION.md` / `DOC_STATUS.md` 備考に RUN_ID・証跡パス・期間内実施/未実施を反映。
5. **クリーンアップ**  
   - `unset ORCA_PROD_*`、`chmod 600` で証跡の権限確認。不要な tmp を削除（`tmp/orca-prod-bridge/20251210T130644Z`）。  
   - WSL 履歴から認証情報行を削除。

## リスク・未決事項
- `/api/api01rv2/acceptlstv2?class=01` は HTTP 404 (HTML NotFound) を返却し Api_Result 不明。接続先ベースパスの確認とリトライが必要。  
- TLS ハンドシェイクが alert 40 で失敗（`tls/openssl_s_client_20251210T130644Z.txt`）。プロトコル/証明書/クライアント証明書設定の再確認が必要。  
- PHI/資格情報のマスク漏れ防止。ログ出力先は `artifacts/` と `docs/server-modernization/phase2/operations/logs/` のみに限定。  
- server-modernized 設定変更が発生した場合、Legacy `server/` 配下を変更しないこと（AGENTS 制約）。
