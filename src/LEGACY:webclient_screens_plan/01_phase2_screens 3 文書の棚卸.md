# 01_phase2/screens 3 文書の棚卸 (RUN_ID=20251202T090000Z)

期間: 2025-12-02 09:00 〜 2025-12-04 09:00 (JST)

## ゴール
1. Phase2 の画面拡張を狙った docs/web-client/planning/phase2/screens 以下の 3 文書を読み解き、各画面が担うユースケースとデータ/API要件を抽出する。
2. Reception/Charts/Patients/Administration という実装候補画面を想定し、画面間遷移とログイン認証フローを再設計する仮説を整理する。
3. 抽出した内容を docs/web-client/ux のポリシードラフトおよび docs/server-modernization/phase2/operations/logs/20251202T090000Z-screens.md へつなげるためのアウトラインとしてまとめ、DOC_STATUS 備考へ RUN_ID を記録するための手順を明文化する。
4. 実装を急ぐ最短ルート方針: Phase2 文書を遵守し、既存 3 文書のユースケース/API/権限前提をそのまま仕様として実装することを優先する。

## 読解した 3 文書と画面要件
### 1. 受付状況処理画面 (docs/web-client/planning/phase2/screens/RECEPTION_SCREEN_PLAN.md)
- 役割/前提: 「今日の患者フローを見える化し、カルテ・基本情報・ORCA連携への入口になるハブ」。受付〜診療〜会計までをステータスと待ち時間で把握し、受付側でも必要最低限の修正ができる。
- ユースケース: 受付登録・修正・取消、新患の簡易登録、タブ（受付状況／診察終了）での状態確認、診療科/担当医/時間帯/自費フラグのフィルタ、カルテを開く／基本情報編集／受付修正／ORCA送信/再送／会計完了チェック、簡易診療履歴・処方履歴・患者メモ参照、過去受診歴検索→当日受付追加、待ち時間/診療科/受付時間ソート、自動更新、印刷/エクスポート。
- UI/情報要素: ヘッダーに施設ロゴ・日付時刻・ログインユーザー＋ロール・グローバルメニュー・システムアラート。左側にステータス別タブ＋フィルタ。中央テーブルにステータス/患者ID/氏名/年齢性別/自費アイコン/受付時間/待ち時間/予約区分/診療科/担当医/メモ有無と行アクション（カルテを開く、基本情報編集、受付修正/取消、診察終了タブではカルテ再表示・ORCA送信/再送・会計完了チェック）。右パネルに基本情報サマリ、直近診療日＋病名サマリ、処方・検査などの概要、患者メモ。
- API/データ依存: 受付一覧・予約一覧・診療ステータスをまとめて取得する受付リソース（予約・受付登録/修正/取消の POST/PUT/DELETE を想定）。患者検索と基本情報編集用の Patient/Insurance リソース。患者メモ/履歴サマリ取得用の軽量サマリ API。ORCA 送信ステータスの取得と送信/再送コマンド（会計・オーダー送信をまとめる ORCA 連携リソース）を持ち、エラー理由を返す。自動更新時は上記一覧 API をポーリングし、操作ログは「誰がいつどの患者の受付をどう変更したか」を記録。
- 遷移/権限前提: 行の「カルテを開く」で患者IDと自費/保険モードを Chart Entry に渡す。「基本情報編集」は患者編集画面（Patients 管理）へのディープリンク。ステータスは医師側の「診療開始」「診療終了」と連動しつつ、受付ロールが手動調整できる範囲を管理画面で定義。role=受付/看護/医師/管理者で操作可否を分け、全操作に監査ログを残す。

### 2. カルテ記入画面 (docs/web-client/planning/phase2/screens/CHART_ENTRY_SCREEN_PLAN.md)
- 役割/前提: 受付から渡された患者について「診療録入力・病名管理・オーダー/処方/検査登録・結果閲覧・文書・サマリ・DICOM 参照」をブラウザ内の擬似タブで完結させる本丸。保険/自費カルテをトグルで切り替え、診療終了で受付ステータスと ORCA 送信をトリガー。
- ユースケース/タブ: ヘッダーで患者基本情報＋受付情報＋注意フラグを常時表示し、保険/自費切替と保存/下書き/診療終了/署名を提供。タブ構成は「診療録（SOAP/フリー切替＋テンプレ＋過去サマリ参照）」「病名（保険病名＋転帰＋適用チェック＋未紐付オーダー一覧）」「オーダー（処方/注射/検査/処置・指導/リハ/予防接種/文書オーダーのサブタブ＋セット呼出/登録）」「結果・履歴（検査結果・処方/オーダー履歴・病名未紐付ショートカット）」「画像(DICOM)（履歴一覧＋ビューア＋カルテ貼付リンク）」「文書（診断書・紹介状等の下書き生成・PDF/印刷）」「サマリ（長期経過・問題リスト・タイムライン）」。
- UI/右サイドバー: 患者メモ（一般/医師専用）、今日のチェック項目（病名未紐付や ORCA エラー警告）、医師お気に入り/病名ベースのオーダー候補、ショートカットキーや自動保存の設定反映。
- API/データ依存: 診療録/テンプレ/サマリ/患者メモ CRUD の ChartResource。病名検索・転帰更新・オーダー紐付チェック用の Disease/Order link API。薬剤/注射/検査/処置/リハ/予防接種/文書オーダーの登録・更新を受ける Order API と、候補表示のための ORCA マスタ参照 API（薬剤・用法・検査セット等）＋適用病名チェック。セット作成/呼出のためのセット管理 API（標準/医師お気に入り/患者・病名サジェスト）。DICOMResource で検査履歴・画像取得・カルテ貼付リンク生成。結果・履歴の取得 API（検査結果、処方/オーダー履歴）。診療終了や署名で受付ステータスと ORCA 送信キューに反映するエンドポイント。すべての編集/承認に監査ログを付与。
- 遷移/前提: 受付から渡された患者IDと保険/自費モードを初期化時に受け取り、診療終了時に Reception のステータスを「診療終了」へ、ORCA 送信エラーは受付の「診察終了」タブで共有。role に応じて入力/承認範囲を制御（看護師は下書き・医師が署名、事務は閲覧中心）。セット/テンプレ/初期表示モードは管理画面で設定されたデフォルトを引き継ぐ。

### 3. カルテ全般管理画面 (docs/web-client/planning/phase2/screens/CHART_ADMIN_SCREEN_PLAN.md)
- 役割/前提: 「受付・カルテ・オーダー画面の裏側のルール/マスタ/権限」を決めるバックオフィス。左メニュー＋右詳細フォームで設定を行う。
- 管理メニュー/ユースケース: 施設・診療科・受付時間などの基本設定、ユーザー/ロール管理（権限制御と承認ルール）、受付/診療ステータス定義と遷移ルール、カルテ記載方式（SOAP/フリー）とテンプレ/サマリ/メモカテゴリ設定、オーダー/セット管理（診療セット・処方/検査/接種セット・医師お気に入り・自動サジェスト閾値）、ORCA 連携設定（接続テスト・マスタ同期・適用病名チェック・送信タイミング・エラー表示文言）、自費診療メニューと自費セット、DICOM 接続・自動取得ルール、セキュリティ/パスワード/ロック/自動ログアウト、監査ログ/保存期間/バックアップ、表示カスタマイズ（受付列選択・カラー設定・初期タブ）。
- API/データ依存: 施設/診療科/ユーザー/ロール/ステータスの CRUD を行う管理 API。診療録方式・テンプレ・サマリ・メモ設定を返す Chart 設定 API。セット/自費メニュー管理 API と、ORCA マスタ同期・適用病名チェック設定を持つ ORCA 連携設定 API（接続テスト結果も返却）。DICOM 接続情報と取得ルールを保持する Config API。セキュリティ/ログ/バックアップ設定の System/Log リソース。表示カスタマイズの保存/配布 API。設定変更は監査ログに記録され、フロント側に配信される。
- 遷移/権限前提: role=system_admin/管理者のみがアクセスし、設定は Reception/Chart Entry に即時または次回リロード時に反映。受付ステータスや ORCA 送信ルールをここで定義する前提で、医師側の診療終了・受付側の再送ボタンと整合させる。テンプレ/セット/初期表示モードの更新はカルテ画面のデフォルトに波及し、ログ保存期間やパスワードポリシーは全画面の認証・監査挙動に影響する。

## Reception/Charts/Patients/Administration 画面間遷移と認証フロー仮説
1. ログイン後は `LoginScreen` が受け取った JWT もしくはセッション cookie を使い、Facility・Role・デフォルト診療科を保持。Reception をデフォルトルートにし、ヘッダーで「Reception / Charts / Patients / Administration」ナビとシステムアラート（ORCA接続エラー等）を表示する。
2. Reception の行操作「カルテを開く」で患者IDと保険/自費モードを Charts に渡し、Chart Entry は `PatientResource` で基本情報・受付情報を取得して初期化。診療終了ボタンを押すと受付ステータスを「診療終了」に更新し、ORCA 送信キューへ積む（エラーは Reception の診察終了タブに戻す）。
3. Patients 管理画面は Reception の「基本情報編集」や Administration のユーザー/ロール設定からディープリンク。共通トークンで Patient/Insurance メンテナンス API を呼び、保存後に Reception へ戻る。
4. Administration は role=system_admin/admin のみ表示。ログイン時の `roles/permissions` をガードとして適用し、受付・カルテ側で参照するステータス定義、テンプレ/セット、保険/自費モードのデフォルト、ORCA接続/適用病名チェック設定をここから配布する。
5. ORCA 送信/再送は Charts の送信ボタンと Reception の「ORCA送信/再送」から呼び、結果コードを UI バナーで共有。送信ルール・エラー文言は Administration で決め、Runbook (`ORCA_API_STATUS.md` など) へのリンクをバナーから開けるようにする。監査ログは各画面の操作と ORCA 送信の成否を共通フォーマットで記録。

## UXポリシー草稿との接続ライン
- Reception の詳細モジュールは `docs/web-client/ux/reception-schedule-ui-policy.md` に集約される予定の受付スケジュール UX を参照し、フィルタ/ステータスアイコン/アラートバナーのトーンを合わせる。
- Chart entry は `docs/web-client/ux/charts-claim-ui-policy.md` を起点に、DocumentTimeline/OrderConsole のレイアウト比、ARIA ライブのガイド、メモのトーン（例: patient memos を `aria-live` で読み上げるべきか）を反映。
- Patients/Administration は `docs/web-client/ux/patients-admin-ui-policy.md` と UX チェックリスト（監査・アクセシビリティ要件）に基づき、権限による表示切り替えや操作ログ出力、ARIA ヘッダーを設計。
- 本文で抽出したユースケースは、該当する UX ポリシーの各章へ移植し、`docs/web-client/ux/ux-documentation-plan.md` の更新箇所と相関させる。Phase2 のマネージャーチェックリスト（`docs/managerdocs/PHASE2_WEB_CLIENT_EXPERIENCE_MANAGER_CHECKLIST.md`）に従い、AGENTS → README → INDEX → この plan → UX draft の順を守り、RUN_ID を同一に保って周知。

## 進捗メモ（20251202T090000Z）
- tests/e2e/orca-delivery.spec.ts を追加し、モック ON/OFF 両方をカバーするシナリオを実装（テスト未実行）。
- Playwright 用フィクスチャ（roles.json、ORCA queue モック、admin 配信レスポンス、audit entries）を追加。
- flagged-mock-plugin に admin 配信のヘッダー分岐を拡張し、ヘッダー伝播のマージ順を改善。
- fetchAuditLog に entries/配列両対応の正規化とバックオフを追加し、遅延時の WARN 出力を整備。
- DOC_STATUS / README / manager checklist / 証跡ログを RUN_ID=20251202T090000Z で更新済み。
- 本方針に従い実装を進める。
- 棚卸し完了メモ: A/B反映済み。ハブ同期済み（RUN_ID=20251202T090000Z）。

## DOC_STATUS / 証跡 / 次アクション
1. DOC_STATUS の `Web クライアント UX/Features` 行に RUN_ID=`20251202T090000Z` を追加し、本ファイルと `docs/server-modernization/phase2/operations/logs/20251202T090000Z-screens.md` へのリンクを備考欄に記載する。
2. このページを参照した UX ドラフトが完成した箇所を README に追記し、README/DOC_STATUS/ログの連携を維持。
3. 証跡ログ: `docs/server-modernization/phase2/operations/logs/20251202T090000Z-screens.md` に本棚卸しの要約（参照した 3 文書、必要 API、画面遷移案、RUN_ID）を記録。
4. 次工程: `docs/web-client/ux/` の草稿に各画面のユースケース＆API要件を移植し、その進捗を `DOC_STATUS` と manager checklist に追記。必要に応じて ORCA 接続証跡（`ORCA_CONNECTIVITY_VALIDATION.md` / `ORCA_API_STATUS.md`）をリンクする。
