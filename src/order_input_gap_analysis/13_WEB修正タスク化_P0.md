# 13 Web修正タスク化（P0）

RUN_ID: 20251229T065934Z

## 前提
- 判定根拠: `src/order_input_gap_analysis/12_差分判定_修正区分.md` に従い、P0 は Web クライアント改修のみ（server-modernized 変更なし）とする。
- API 不足が判明した場合のみ、別途サーバータスクを起票する。
- Legacy `client/` `server/` は参照のみで変更しない。

## 影響範囲整理（P0）
- 画面:
  - Charts 右パネル（OrderBundleEditPanel + 文書メニュー/フォーム）
  - Orders の検索補助 UI（マスタ検索/検索結果テーブル/行選択）
- API:
  - `/orca/order/bundles`（保存/更新/削除）
  - `/orca/master/*`（用法/材料/点数/検査ソート 等の検索）
  - `/stamp/*`（スタンプ保存/取り込み UI での利用可否を確認）
- 監査ログ:
  - `operationPhase`（入力/保存/展開/反映などのフェーズ）
  - 入力差分メタ（変更点の要約と runId/screen の付与）

## P0 改修タスク（Web）

### 1) マスタ検索/UI の追加（OrderBundleEditPanel）
- 対象画面/機能:
  - OrderBundleEditPanel の検索欄・結果テーブル・行選択の導線追加（処方/処置検査/リハビリ共通）
- 旧来版の挙動（差分要約）:
  - 旧来版は検索フォーム + 結果テーブルでマスタ検索→行選択で入力に反映。
  - Web は検索補助 UI が不足。
- Web 目標挙動（実装範囲）:
  - 検索入力 → 検索結果テーブル表示 → 行選択で入力へ反映。
  - 既存の readOnly/missingMaster/fallbackUsed ガードは維持。
- 依存 API/データ:
  - `/orca/master/*` 系検索（用法/材料/点数/検査ソート等）
- 監査/ログ要件:
  - 検索実行・結果選択の監査イベント要否を整理（既存ポリシーに合わせる）。
- ブロッカー:
  - 検索 API の戻りスキーマと UI 仕様の再確認。
- テスト観点:
  - 検索条件変更時の結果更新、行選択反映、readOnly 時のブロック。

### 2) スタンプ保存/取り込み相当の導線追加
- 対象画面/機能:
  - OrderBundleEditPanel に保存 UI/既存スタンプ選択 UI/反映手順を追加。
- 旧来版の挙動（差分要約）:
  - 旧来版はスタンプ保存・取り込みの導線がある。
  - Web は導線が未実装。
- Web 目標挙動（実装範囲）:
  - 保存 UI（名称/分類/対象）とスタンプ選択 UI を追加。
  - 取り込み後の編集反映手順を明示。
- 依存 API/データ:
  - `/stamp/*` の既存 API を利用できるか確認（不足時はサーバータスク化）。
- 監査/ログ要件:
  - スタンプ保存/取り込みの操作ログ（operationPhase と入力差分）。
- ブロッカー:
  - スタンプ API の仕様/認可/保存データ構造の確認。
- テスト観点:
  - 保存/取り込みの成功・失敗、反映手順の UI 表示、readOnly ブロック。

### 3) 展開/展開継続の操作導線追加
- 対象画面/機能:
  - カルテ反映フローを想定した展開/展開継続 UI を追加。
- 旧来版の挙動（差分要約）:
  - 展開/展開継続で入力内容をカルテに反映する導線がある。
- Web 目標挙動（実装範囲）:
  - 展開/展開継続の UI 導線を設け、保存導線との差分を明示。
  - 既存の保存フロー（/orca/order/bundles）との整合を維持。
- 依存 API/データ:
  - `/orca/order/bundles` 保存フローに合わせた運用設計。
- 監査/ログ要件:
  - operationPhase を展開/保存で分離し、入力差分メタを記録。
- ブロッカー:
  - 展開時のビジネスルール（カルテ反映の定義）確認。
- テスト観点:
  - 展開/展開継続/保存の UI 導線とログの整合。

### 4) 処方・BaseEditor の必須判定を Web バリデーションに反映
- 対象画面/機能:
  - 処方: 薬剤≥1、用法必須、用法検索必須。
  - BaseEditor 系: entity 別の必須判定。
- 旧来版の挙動（差分要約）:
  - 旧来版は必須条件を満たさない場合に保存不可/警告。
- Web 目標挙動（実装範囲）:
  - Web バリデーションとして必須判定を統一実装。
  - readOnly/missingMaster/fallbackUsed と競合しない判定順序を整理。
- 依存 API/データ:
  - entity 定義・入力フォームの必須項目一覧。
- 監査/ログ要件:
  - バリデーション失敗時の UI ログ（必要に応じて監査イベント）。
- ブロッカー:
  - entity 別必須項目の定義が未整理の場合は明文化が必要。
- テスト観点:
  - 必須違反時の保存ブロックとメッセージ表示。

### 5) 文書作成メニュー/フォーム追加（Charts 右パネル）
- 対象画面/機能:
  - Charts 右パネルに文書作成メニューとフォーム（紹介状/診断書/返信書）。
- 旧来版の挙動（差分要約）:
  - 旧来版は文書作成メニューから各フォームを表示。
- Web 目標挙動（実装範囲）:
  - 右パネルに文書作成メニューを追加し、フォームの起動導線を提供。
  - フォーム内容は P0 の必須項目まで実装（テンプレ/印刷は P1 以降）。
- 依存 API/データ:
  - 文書作成用 API の確認（不足時はサーバータスク化）。
- 監査/ログ要件:
  - 文書作成操作の auditEvent（screen/charts, runId, operationPhase）。
- ブロッカー:
  - 文書 API の有無/仕様が未確定。
- テスト観点:
  - メニュー表示、フォーム起動、保存/中断時の挙動。

## 実装順序（P0）
1. 必須判定の Web バリデーション（4）
2. マスタ検索/UI（1）
3. 展開/展開継続導線（3）
4. スタンプ保存/取り込み導線（2）
5. 文書作成メニュー/フォーム（5）

## ブロッカー整理
- スタンプ API と文書 API の仕様確認（不足時は server-modernized 側の別タスク起票）。
- 展開/展開継続のカルテ反映ルールの合意。
- entity 別必須条件の定義（処方/処置検査/リハビリ/文書）。

## テスト/確認観点（P0 共通）
- readOnly/missingMaster/fallbackUsed のガードが追加 UI でも維持されていること。
- 監査ログの runId/screen/operationPhase が既存規約に一致すること。
- 既存の `/orca/order/bundles` 保存フローに影響を与えないこと。
