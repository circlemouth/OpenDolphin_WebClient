# 02 旧来版：文書オーダー入力調査

RUN_ID: 20251228T215523Z

## 参照コード（主要）
- 文書作成メニュー/テンプレ選択: `client/src/main/java/open/dolphin/client/ChartImpl.java`
- 紹介状（診療情報提供書）: `client/src/main/java/open/dolphin/letter/LetterImpl.java`, `client/src/main/java/open/dolphin/letter/LetterView.java`
- 紹介患者経過報告書（お返事）: `client/src/main/java/open/dolphin/letter/Reply1Impl.java`, `client/src/main/java/open/dolphin/letter/Reply1View.java`
- ご報告（紹介患者経過報告書系）: `client/src/main/java/open/dolphin/letter/Reply2Impl.java`, `client/src/main/java/open/dolphin/letter/Reply2View.java`
- 診断書: `client/src/main/java/open/dolphin/letter/MedicalCertificateImpl.java`, `client/src/main/java/open/dolphin/letter/MedicalCertificateView.java`
- PDF 出力: `client/src/main/java/open/dolphin/letter/*PDFMaker.java`
- 文書履歴/再編集導線: `client/src/main/java/open/dolphin/letter/*Viewer.java`

## 1) 文書作成メニューとテンプレ選択

### 新規文書作成フロー（ChartImpl#newDocument）
1. **プラグイン型文書（NChartDocument）** を PluginLister で列挙し、リストに表示。
2. **OpenOffice/差し込み文書 (.odt)** を `ClientContext.getOdtTemplateDirectory()` から列挙してリストに表示。
3. リストから選択 →
   - `.odt` の場合: `invokeOffice()` で差し込み実行
   - プラグインの場合: `invokePlugin()` で文書エディタ起動

### ODT差し込みの入力支援（ChartImpl#invokeOffice）
テンプレートに以下の差し込みフィールドがセットされる（固定/自動挿入）:
- 発行日: `entry_date`, `entry_date_era`
- 患者: `pt_id`, `pt_kana`, `pt_name`, `g`, `pt_birth`, `pt_birth_era`, `pt_age`, `pt_zip`, `pt_addr`, `pt_tel`
- 医療機関/医師: `phy_hosp`, `phy_zip`, `phy_addr`, `phy_tel`, `phy_fax`, `phy_name`

生成ファイル名: `文書名_患者氏名様_YYYY-MM-DD(n).odt`（`UserDocumentHelper.createPathToDocument`）

## 2) 文書別の入力欄と特記事項

### 2-1. 診療情報提供書（紹介状）: LetterImpl / LetterView
- 入力欄（編集可）
  - 紹介先: 医療機関名/診療科/医師
  - 傷病名
  - 紹介目的
  - 既往歴・家族歴（テキスト）
  - 症状経過（テキスト）
  - 現在の処方（テキスト）
  - 備考
- 自動反映（編集不可）
  - 患者氏名/性別/生年月日/年齢
  - 発行日（confirmed）
- 署名/印影
  - 画面上は「先生 御机下」ラベルのみ。印影入力欄はなし（PDF/印刷フォーム側の固定配置）。
- 入力支援
  - AutoKanjiListener + BundleTransferHandler + CutCopyPasteAdapter を入力欄に付与
- 必須項目
  - **UI上の必須バリデーションなし**（未入力でも保存可能。null は空文字で保存）。

### 2-2. 紹介患者経過報告書（お返事）: Reply1Impl / Reply1View
- 入力欄（編集可）
  - 紹介元: 医療機関名/診療科/医師
  - 経過報告（informedContent）
- 自動反映（編集不可）
  - 患者氏名/生年月日
  - 来院日（visitedDate）
  - 発行日（confirmed）
  - 差出人情報（住所/電話/病院名/医師）
- 署名/印影
  - 画面に「印」ラベルのみ。印影入力欄はなし。
- 入力支援
  - AutoKanjiListener + BundleTransferHandler + CutCopyPasteAdapter を入力欄に付与
  - PopupCalendarListener が来院日に設定されるが、view 側は `setEditable(false)` のため通常は変更不可
- 必須項目
  - **UI上の必須バリデーションなし**（未入力でも保存可能）

### 2-3. ご報告（紹介患者経過報告書系）: Reply2Impl / Reply2View
- 入力欄（編集可）
  - 紹介元: 医療機関名/診療科/医師
  - ご報告内容（informedContent）
- 自動反映（編集不可）
  - 患者氏名/生年月日
  - 来院日（visited）
  - 発行日（confirmed）
  - 差出人情報（住所/電話/病院名/医師）
- 署名/印影
  - 画面に「印」ラベルのみ。印影入力欄はなし。
- 入力支援
  - AutoKanjiListener + BundleTransferHandler + CutCopyPasteAdapter を入力欄に付与
  - PopupCalendarListener が来院日に設定されるが、view 側は `setEditable(false)` のため通常は変更不可
- 必須項目
  - **UI上の必須バリデーションなし**（未入力でも保存可能）

### 2-4. 診断書: MedicalCertificateImpl / MedicalCertificateView
- 入力欄（編集可）
  - 病名
  - 記載内容（informedContent）
- 自動反映（編集不可）
  - 患者氏名/性別/生年月日/住所
  - 発行日（confirmed）
  - 医療機関情報（住所/病院名/電話/医師）
- 署名/印影
  - 画面に「印」ラベルのみ。印影入力欄はなし。
- 入力支援
  - AutoKanjiListener + BundleTransferHandler + CutCopyPasteAdapter を入力欄に付与
- 必須項目
  - **UI上の必須バリデーションなし**（未入力でも保存可能。病名/本文が空でも保存処理は進む）。

### 2-5. OpenOffice差し込み文書（同意書/訪問看護指示書等）
- 入力欄: **テンプレート側に依存**（本体UIでは入力欄なし）
- 自動反映: `invokeOffice()` の差し込み項目が文書に展開
- 署名/印影/発行日
  - ODT テンプレート側の固定レイアウトに依存
- 保存/プレビュー
  - `.odt` を生成し、Desktop で既定アプリを開く（印刷はアプリ側）

## 3) 印刷/プレビュー導線

- 文書エディタ（Letter/Reply1/Reply2/MedicalCertificate）で「印刷」操作 →
  - ダイアログで **PDF 作成** or **フォーム印刷** を選択
  - PDF 作成: `*PDFMaker.create()` → 生成ファイルを `Desktop.browse()` で開く（プレビュー相当）
  - フォーム印刷: `Panel2.printPanel()`

## 4) 保存・再編集の流れ

- 保存処理: `LetterDelegater.saveOrUpdateLetter(model)`
- 保存時の挙動
  - 新規: `confirmed/recorded/started` を現在時刻で再設定
  - 修正: `linkId` に元 id を保持し、`id=0` にして **新規保存**（コメント上は「元モデル削除」前提）
- 文書履歴からの再編集/複製
  - `*Viewer.modifyKarte()` で既存文書を取得 → 新しい編集タブを開く
  - `*Viewer.copyDocument()` で ID をクリアした複製を生成

## 5) 差分表テンプレート（旧来版: 文書）

| 項目名 | 入力方式 | 必須条件 | 保存挙動 | コード参照 |
| --- | --- | --- | --- | --- |
| 文書: 新規文書作成メニュー | リスト選択 | 選択必須 | 選択内容に応じてプラグイン起動 or ODT差し込み | `client/src/main/java/open/dolphin/client/ChartImpl.java` |
| 文書: ODTテンプレート選択 | リスト選択 | 選択必須 | `.odt` 生成 → 既定アプリで開く | `client/src/main/java/open/dolphin/client/ChartImpl.java` |
| 文書: ODT差し込み（患者/医療機関） | 自動反映 | UI入力なし | ODTへ差し込み、ファイル保存 | `client/src/main/java/open/dolphin/client/ChartImpl.java` |
| 診療情報提供書: 紹介先（医療機関/診療科/医師） | テキスト入力 | 必須なし | LetterModuleへ保存 | `client/src/main/java/open/dolphin/letter/LetterImpl.java` |
| 診療情報提供書: 傷病名 | テキスト入力 | 必須なし | LetterItem(disease) | `client/src/main/java/open/dolphin/letter/LetterImpl.java` |
| 診療情報提供書: 紹介目的 | テキスト入力 | 必須なし | LetterItem(purpose) | `client/src/main/java/open/dolphin/letter/LetterImpl.java` |
| 診療情報提供書: 既往歴/症状経過/現在の処方 | テキスト入力 | 必須なし | LetterText(pastFamily/clinicalCourse/medication) | `client/src/main/java/open/dolphin/letter/LetterImpl.java` |
| 診療情報提供書: 備考 | テキスト入力 | 必須なし | LetterItem(remarks) | `client/src/main/java/open/dolphin/letter/LetterImpl.java` |
| 診療情報提供書: 発行日 | 自動反映 | 変更不可 | confirmed/recorded/started を保存 | `client/src/main/java/open/dolphin/letter/LetterImpl.java` |
| 紹介患者経過報告書: 紹介元（医療機関/診療科/医師） | テキスト入力 | 必須なし | LetterModuleへ保存 | `client/src/main/java/open/dolphin/letter/Reply1Impl.java` |
| 紹介患者経過報告書: 来院日 | 自動反映（編集不可） | 変更不可 | LetterItem(visitedDate) | `client/src/main/java/open/dolphin/letter/Reply1Impl.java` |
| 紹介患者経過報告書: 経過報告本文 | テキスト入力 | 必須なし | LetterText(informedContent) | `client/src/main/java/open/dolphin/letter/Reply1Impl.java` |
| ご報告: 紹介元（医療機関/診療科/医師） | テキスト入力 | 必須なし | LetterModuleへ保存 | `client/src/main/java/open/dolphin/letter/Reply2Impl.java` |
| ご報告: 来院日 | 自動反映（編集不可） | 変更不可 | LetterItem(visited) | `client/src/main/java/open/dolphin/letter/Reply2Impl.java` |
| ご報告: 報告内容 | テキスト入力 | 必須なし | LetterText(informedContent) | `client/src/main/java/open/dolphin/letter/Reply2Impl.java` |
| 診断書: 病名 | テキスト入力 | 必須なし | LetterItem(disease) | `client/src/main/java/open/dolphin/letter/MedicalCertificateImpl.java` |
| 診断書: 記載内容 | テキスト入力 | 必須なし | LetterText(informedContent) | `client/src/main/java/open/dolphin/letter/MedicalCertificateImpl.java` |
| 診断書: 発行日/医療機関情報 | 自動反映 | 変更不可 | confirmed/consultant* を保存 | `client/src/main/java/open/dolphin/letter/MedicalCertificateImpl.java` |
| 文書共通: 印刷/プレビュー | ダイアログ選択 | 選択必須 | PDF作成 or フォーム印刷 | `client/src/main/java/open/dolphin/letter/*Impl.java` |

