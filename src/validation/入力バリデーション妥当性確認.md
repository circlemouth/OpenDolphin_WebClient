# 入力バリデーション妥当性確認

## 目的
server-modernized 側で追加したバリデーションが UI/運用の想定と齟齬がないかを確認する。

## 実行前提
- `WEB_CLIENT_MODE=npm ./setup-modernized-env.sh` で起動し、ログイン情報は同スクリプトの記載に従う
- 病名/処方/オーダーの試験データを用意できること
- 監査イベントを確認できる状態（UI の監査表示/ログ保存先の準備）

## 実施情報
- RUN_ID: 20260104T064701Z
- 実施日: 2026-01-04
- 環境起動: `MODERNIZED_APP_HTTP_PORT=19085`, `MODERNIZED_APP_ADMIN_PORT=19985`, `MODERNIZED_POSTGRES_PORT=56010`, `MINIO_API_PORT=9200`, `MINIO_CONSOLE_PORT=9201`
- 認証: `userName=1.3.6.1.4.1.9414.10.1:dolphin`, `password=36cdf8b887a5cffc78dcd5c08991b993`
- 監査テーブル: `d_audit_event` を手動作成（既定スキーマ未投入のため）

## 確認メモ（期待/実結果）

### 病名（/orca/disease）
- 期待（UI/運用）
  - UI: 病名は空文字不可（保存前に `病名を入力してください。`）
  - server-modernized: `patientId` 必須 / `operations` 必須 / `operation` は create/update/delete のみ
- 実結果
  - `patientId` 欠落 → 400 `invalid_request` / `field=patientId` / `validationError=true` を返却（ログあり）
  - `operations` 必須チェックは **未確認**（患者/カルテの前提データが未整備のため）
  - 病名文字列の空文字チェックは server 側に未実装（UI でブロックされるが、API 直叩きでは通過可能）
- 所見
  - UI では空文字を抑止するが、API では `diagnosisName` 空文字の拒否が無い → 仕様差分候補

### 処方/オーダー束（/orca/order/bundles）
- 期待（UI/運用）
  - UI: item/用法/バンドル名/コメントコードの必須や形式チェックあり
  - server-modernized: `patientId` 必須 / `operations` 必須 / `operation` 必須・値チェック / `entity` 値チェック / `documentId` 必須
- 実結果
  - `/orca/order/bundles` が **404**（web.xml に `OrcaOrderBundleResource` 登録が無く REST ルーティングされない）
  - そのため server 側バリデーションの実動作は **未確認**
- 所見
  - エンドポイント未登録のため、UI からの処方/オーダー編集 API が到達しない。

## API エラーレスポンスと UI 表示の整合
- 病名の `patientId` 欠落エラーは JSON で `message`/`field`/`validationError` が返るが、
  UI は `apiResultMessage` を参照するため **サーバーメッセージが表示されず**、
  画面上は「保存に失敗しました」の汎用表示に留まる。
- 404（/orca/order/bundles 未登録）も UI では汎用エラー扱いとなる見込み。

## 監査イベント（拒否理由/endpoint）
- `ORCA_DISEASE_MUTATION` 失敗時に `field=patientId` / `errorMessage=patientId is required` を payload に記録していることを確認。
- `/orca/order/bundles` は 404 となり `REST_ERROR_RESPONSE` で `http_404` が記録される。

## 仕様差分/追加対応の一覧
1. `/orca/order/bundles` が `web.xml` の `resteasy.resources` に未登録 → 404 で到達不可。
2. `diagnosisName` の空文字は UI で抑止するが API では拒否しない（直叩き対策が必要なら server 側 validation 追加）。
3. server のバリデーションメッセージは UI の `apiResultMessage` と不一致（`message` を拾う/整形する対応が必要）。
4. `operations` 必須などの deeper validation は患者/カルテ前提データが必要で未検証。

## 実行ログの保存先
- `artifacts/validation/validation/logs/`
- `artifacts/validation/validation/screenshots/`
- `artifacts/validation/validation/README.md`（サマリとrunId一覧）

## 証跡最低要件
- バリデーション確認メモ（期待/実結果）
- エラー応答のスクリーンショット or ログ
- 監査イベントの確認メモ（拒否理由/endpoint）
