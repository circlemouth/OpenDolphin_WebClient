# 入力バリデーション妥当性確認

## 目的
server-modernized 側で追加したバリデーションが UI/運用の想定と齟齬がないかを確認する。

## 実行前提
- `WEB_CLIENT_MODE=npm ./setup-modernized-env.sh` で起動し、ログイン情報は同スクリプトの記載に従う
- 病名/処方/オーダーの試験データを用意できること
- 監査イベントを確認できる状態（UI の監査表示/ログ保存先の準備）

## 実施情報
- RUN_ID: 20260104T071346Z
- 実施日: 2026-01-04
- 環境起動: `MODERNIZED_APP_HTTP_PORT=19086`, `MODERNIZED_APP_ADMIN_PORT=19986`, `MODERNIZED_POSTGRES_PORT=56011`, `MINIO_API_PORT=9202`, `MINIO_CONSOLE_PORT=9203`, `WEB_CLIENT_DEV_PORT=5174`
- 認証: `userName=1.3.6.1.4.1.9414.72.103:doctor1`, `password=632080fabdb968f9ac4f31fb55104648`
- DB 初期化: `artifacts/parity-manual/db-restore/20251120TbaselineGateZ1/legacy_schema_dump.sql` を適用
- 追加調整: `ALTER ROLE opendolphin SET search_path TO public,opendolphin;` / `ops/db/local-baseline/local_synthetic_seed.sql` 適用 / 患者・カルテの最小シード (WEB1001) / `server-modernized/tools/flyway/sql/V0227__audit_event_trace_id.sql` 適用

## 確認メモ（期待/実結果）

### 病名（/orca/disease）
- 期待（UI/運用）
  - UI: 病名は空文字不可（DiagnosisEditPanel で `病名を入力してください。`）
  - server-modernized: `patientId` 必須 / `operations` 必須 / `operation` は create/update/delete のみ
- 実結果
  - `patientId` 欠落 → 400 `invalid_request` / `field=patientId` / `validationError=true`（ログあり）
  - `operations` 空配列 → 400 `invalid_request` / `field=operations` / `validationError=true`（ログあり）
  - `operation=noop` → 400 `invalid_request` / `field=operation` / `validationError=true`（ログあり）
  - `diagnosisName` 空文字チェックは server 側に未実装（`buildDiagnosis` が値をそのまま設定）
- 所見
  - UI は空文字を抑止するが、API では `diagnosisName` 空文字の拒否が無い → 仕様差分候補
  - バリデーションエラーは `message` に入るが、UI は `apiResultMessage` を参照するため文言が露出しない

### 処方/オーダー束（/orca/order/bundles）
- 期待（UI/運用）
  - UI: OrderBundleApi が `patientId` / `entity` / `operation` / `operations` を扱う
  - server-modernized: `patientId` 必須 / `operations` 必須 / `operation` 必須・値チェック / `entity` 値チェック / `documentId` 必須
- 実結果
  - `/orca/order/bundles` が **404**（web.xml の `resteasy.resources` に `OrcaOrderBundleResource` 未登録）
  - そのため server 側バリデーションの実動作は **未確認**
- 所見
  - エンドポイント未登録のため、UI からの処方/オーダー編集 API が到達しない。

## API エラーレスポンスと UI 表示の整合
- server のバリデーションエラーは `{error, message, field, validationError, traceId}` 形式で返却される
- web-client の diseaseApi / orderBundleApi は `apiResultMessage` しか参照しないため、
  UI 上は「病名の保存に失敗しました」等の汎用表示になり、server の `message` は表示されない

## 監査イベント（拒否理由/endpoint）
- `traceId=20260104T071346Z`: `ORCA_DISEASE_MUTATION` + `REST_ERROR_RESPONSE` の payload に `field=patientId` / `errorMessage=patientId is required` を記録
- `traceId=20260104T071346Z-OPREQ`: `field=operations` / `errorMessage=operations is required`
- `traceId=20260104T071346Z-OPINVALID`: `field=operation` / `errorMessage=operation is invalid`
- `traceId=20260104T071346Z-ORDER`: `/orca/order/bundles` の `REST_ERROR_RESPONSE` (`http_404`) を記録

## 仕様差分/追加対応の一覧
1. `/orca/order/bundles` が `web.xml` の `resteasy.resources` に未登録 → 404 で到達不可。
2. server のバリデーションメッセージは `message` に入るが、UI は `apiResultMessage` のみ参照 → エラー理由が画面に出ない。
3. `diagnosisName` の空文字は UI で抑止するが API では拒否しない（直叩き対策が必要なら server 側 validation 追加）。
4. `/orca/order/bundles` バリデーション（patientId/operations/entity/operation）はエンドポイント未登録のため未検証。

## 実行ログの保存先
- `artifacts/validation/validation/logs/20260104T071346Z_orca_disease_missing_patientId_v2.{headers,json,status}`
- `artifacts/validation/validation/logs/20260104T071346Z_orca_disease_missing_operations.{headers,json,status}`
- `artifacts/validation/validation/logs/20260104T071346Z_orca_disease_invalid_operation.{headers,json,status}`
- `artifacts/validation/validation/logs/20260104T071346Z_orca_order_bundles_404.{headers,status}`
- `artifacts/validation/validation/logs/20260104T071346Z_audit_event_trace.txt`
- `artifacts/validation/validation/logs/20260104T071346Z_disease_validation_audit.txt`
- `artifacts/validation/validation/logs/20260104T071346Z_order_audit_event_trace.txt`

## 証跡最低要件
- バリデーション確認メモ（期待/実結果）: 本ドキュメント
- エラー応答のログ: `artifacts/validation/validation/logs/20260104T071346Z_orca_disease_missing_patientId_v2.json` ほか
- 監査イベントの確認メモ（拒否理由/endpoint）: `artifacts/validation/validation/logs/20260104T071346Z_*audit*.txt`
