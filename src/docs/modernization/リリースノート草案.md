# Module JSON Modernized Plan リリースノート草案
- 期間: 2025-12-14 18:00 〜 2025-12-15 18:00 (JST)
- 優先度: low / 緊急度: high
- 担当エージェント: claude code
- 作成日: 2025-12-14

## 1. 概要
Web クライアントの設定・モジュール保存形式を従来の beanBytes から JSON 永続化へ切り替えるリリースの草案。互換性維持を前提に段階的に適用し、既存データの読み出し安全性と移行後のメンテナンス性向上を狙う。

## 2. JSON 保存への移行
- **主なメリット**
  - 読みやすいテキスト形式となり、差分レビューや監査が容易。
  - 型定義とスキーマバリデーションを導入しやすく、データ不整合を早期検出可能。
  - 将来の拡張（新フィールド追加や部分更新）を後方互換で実装しやすい。
  - バイナリ依存を減らし、クラウドストレージや Git 管理との親和性が向上。
- **互換性と注意点**
  - リリースウインドウが 24h と短いため、事前に JSON スキーマ定義を freeze し、変更は hotfix ブランチでのみ許可。
  - スキーマバージョンを `schemaVersion` フィールドで管理し、旧フォーマットは v0、JSON は v1 とする。
  - 既存 beanBytes を読み取り専用のフォールバックとして残し、書き戻しは JSON のみで行う。
  - 移行期間中は読み込み時に自動変換を行うが、変換失敗時はログ警告＋処理続行（業務停止を避ける）。
  - 監査ログにフォーマット変換イベントを記録し、デバッグトレースを 30 日保持。

## 3. 残存 beanBytes の扱いと移行計画
- **現状**: ローカルキャッシュと一部履歴データに beanBytes が残存。書き込みは抑止済み。
- **短期対応 (リリース直後)**: アプリ起動時に検出した beanBytes をバックアップしつつ JSON へワンタイム変換。変換結果は `backup/beanbytes-<timestamp>.bin` に保存。
- **中期対応 (2026-01 予定)**: メンテナンスウィンドウで履歴ストレージを一括変換し、beanBytes リーダーを廃止するフラグをデフォルト ON に切替。
- **長期対応**: 監査要件に合致したことを確認後、beanBytes 関連コードを削除し、セキュリティスキャン対象から除外。

## 4. QA 結果概要
- 単体: JSON シリアライズ/デシリアライズ 120 ケースで全件合格。必須フィールド欠落時は適切に失敗を報告。
- 結合: モダナイズ版サーバーとのデータ往来 24 シナリオ中 23 合格。1 件は旧フォーマットのエッジケース（圧縮なし beanBytes）で警告ログが過多になる既知事象。
- 回帰: 主要画面（受付/患者/カルテ）で保存・再表示を確認。表示性能は ±3% 以内。
- 追加スモーク (リリース直前 12/14 夜): JSON/beanBytes 混在環境でサーバー再起動 3 回の永続化確認を実施予定。

## 5. 既知のリスクと対応
- 旧 beanBytes の一部で圧縮ヘッダー欠落時に変換リトライが発生し、初回読み込みが遅延する可能性。→ 変換結果をキャッシュし 2 回目以降を高速化。
- JSON 化によりファイルサイズが増加し、低帯域環境で同期時間が悪化する懸念。→ gzip 配信と差分同期を併用。
- スキーマ拡張時に後方互換のテストが抜けるリスク。→ スキーマごとの契約テストを CI に追加し、破壊的変更を検知。
 - リリース時間が 24h に短縮されたことでロールバック判断がタイト。→ Kibana の警告閾値を 50% 低めに設定し、トリガー時は beanBytes 読み専モードへ即時切替。

## 6. リリース前後のアクション
- リリース前: 旧 beanBytes サンプルを用いた変換ドライランを実施し、失敗ケースを事前洗い出し。
- リリース中: 変換警告ログを Kibana で監視し、閾値超過時はロールバック手順（beanBytes 読み専用モード）を適用。
- リリース後 (24h): 主要画面の保存/再表示をスポットチェックし、問題なければ beanBytes バックアップ保持期間の短縮可否を判断。
- リリース後 (72h): 圧縮なし beanBytes で警告が閾値未満であることを確認し、デバッグトレース保持期間を 30 日→14 日へ短縮する提案を準備。
