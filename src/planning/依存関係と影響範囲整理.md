# 依存関係と影響範囲整理（webclient non chart gap audit plan）

- RUN_ID: `20251230T201901Z`
- 期間: 2026-01-03 09:00 〜 2026-01-04 09:00 (JST)
- 優先度: medium / 緊急度: medium
- エージェント: codex
- YAML ID: `src/planning/依存関係と影響範囲整理.md`

## 目的
追加検討項目の実装影響範囲と依存関係を整理し、次フェーズの計画化に必要な前提を明文化する。

## 参照ドキュメント
- `docs/DEVELOPMENT_STATUS.md`
- `src/discovery/対象範囲と成果物定義.md`
- `src/gap_analysis/機能ギャップ抽出.md`
- `src/gap_analysis/追加検討項目の優先度付け.md`
- `src/webclient_productionization/01_現状実装棚卸しとギャップ整理.md`

## 依存関係マップ（概念）

```
[認証/権限ガード]
  ├─ Administration 画面アクセス制御 (BKL-002)
  ├─ 施設/ユーザ選択・切替 (BKL-003/004)
  └─ 権限境界の運用フロー (BKL-016)

[監査メタ共通化]
  ├─ data-run-id/aria-live 統一 (BKL-019)
  ├─ 監査検索 UI 基盤 (BKL-013/014/018)
  └─ 配信/送信/印刷の監査永続化 (BKL-008/005)

[配信・運用基盤]
  ├─ 管理メニュー設計 (BKL-001)
  ├─ 配信タイミング/環境ラベル (BKL-009)
  └─ 配信証跡/ETag/遅延監視 (BKL-012)

[業務完結性]
  ├─ Charts 送信/診療終了 (BKL-005)
  ├─ Charts 印刷 (BKL-008)
  ├─ Reception 例外一覧 (BKL-006)
  └─ Patients ORCA 反映状態 (BKL-007)

[UI拡張]
  ├─ Reception 右ペイン/列拡張 (BKL-010/011)
  ├─ Patients 監査/警告表示 (BKL-014/015)
  ├─ Charts 安全ヘッダ/履歴強化 (BKL-017/018)
  └─ 共通 RUN_ID コピー/通知 (BKL-020)
```

## 依存関係一覧（バックログ観点）

| Backlog | 主な依存関係 | 補足 |
| --- | --- | --- |
| BKL-001 管理メニュー全体設計 | BKL-002 (権限ガード) / BKL-009 (配信表示) / BKL-012 (配信証跡) | 画面構成と API 群の基準点になる |
| BKL-002 system_admin ガード | 認証/権限仕様合意 | 画面ブロック + API 側 enforcement が必要 |
| BKL-003 施設/ユーザ選択 | 認証フロー再設計 | BKL-004 と同時設計が前提 |
| BKL-004 施設/ユーザ切替 | BKL-003 (施設選択) | 監査イベント定義も同時に固める |
| BKL-005 診療終了/送信 | ORCA 連携仕様 / 監査メタ共通化 | Reception/Claim への反映と運用手順が連動 |
| BKL-006 Reception 例外一覧 | 監査イベント粒度 / 送信結果の定義 | BKL-005, BKL-008 の結果情報が前提 |
| BKL-007 Patients ORCA 反映状態 | ORCA 更新 API と結果コード | 監査 UI と連動（BKL-014） |
| BKL-008 Charts 印刷 | 印刷 API/生成基盤 / 監査永続化 | 失敗時の復旧導線を BKL-006 と整合 |
| BKL-009 配信タイミング/環境ラベル | BKL-001 の画面設計 | 伝播の説明責任が BKL-012 と結合 |
| BKL-010 Reception 右ペイン | BKL-011 列定義 / Patient/Claim データ | データ要件は Patients/Charts 参照が多い |
| BKL-011 Reception 列拡張 | 列仕様合意 / API 追加 | ORCA キューや請求状態との統合 |
| BKL-012 配信証跡設計 | 配信 API / 監査メタ共通化 | 運用ログの保管と検索 UX に依存 |
| BKL-013 受付監査履歴 | 監査検索 UI 基盤 | 監査メタ共通化 (BKL-019) が前提 |
| BKL-014 Patients 監査履歴 | 監査検索 UI 基盤 | 監査イベント粒度の統一が必須 |
| BKL-015 未紐付/警告 | 警告ルール合意 | Reception/Charts への波及がある |
| BKL-016 権限境界運用 | BKL-002/003/004 | 運用手順と UI 表示の整合が必要 |
| BKL-017 患者安全ヘッダ | UI 方針 / 既存患者ヘッダ | Charts 中の誤認防止要件に依存 |
| BKL-018 ドキュメント履歴 | 監査検索 UI 基盤 | BKL-013/014 と共通基盤化 |
| BKL-019 data-run-id/aria-live 統一 | 既存 UI の改修計画 | 多画面横断で小改修が多発 |
| BKL-020 RUN_ID コピー/通知 | AppShell UI 拡張 | 監査/運用強化の補助要素 |

## 影響範囲メモ

### UI 影響
- Reception: 右ペイン/列拡張/例外一覧の UI 追加、既存テーブルレイアウトの再設計が必要。
- Patients: 監査履歴ビューと ORCA 反映状態・警告表示の新規 UI が必要。
- Administration: 管理メニュー体系の再設計、system_admin ガードの画面遷移制御が必要。
- Charts: 印刷/送信の状態表示、患者安全ヘッダ、履歴検索 UI の拡張が必要。
- 共通: data-run-id/aria-live 統一、RUN_ID コピー/通知、権限拒否時メッセージの共通化。

### API 影響
- 認証/権限: 施設/ユーザ選択・切替に伴う認証 API の拡張、権限制御のサーバ側 enforce。
- ORCA 連携: 診療終了/送信、印刷処理、Patients 反映状態の API を確定し、結果コード/監査メタを揃える。
- 配信/管理: 配信バージョン/ETag/反映タイミングを返す API 拡張と永続化が必要。
- 監査: 監査イベントの operation/action 体系を再整理し、検索 API（条件/期間/画面別）を設計する。

### 運用 影響
- 配信運用: 環境ラベル・反映タイミング・ロールバック手順を提示しないと運用判断ができない。
- 例外対応: Reception 例外一覧の運用ルール（未承認/送信失敗/遅延）を明文化する必要がある。
- 権限運用: 施設/ユーザ切替、権限拒否時の再ログイン導線を手順化する必要がある。
- 印刷/送信: 失敗時の復旧導線（再送/再印刷）を業務手順として整備する必要がある。

### 監査 影響
- 監査メタ統一: runId/traceId/dataSource/operation/screenId の必須化が前提。
- 監査検索 UI: 受付/患者/管理/Charts の監査検索・時系列を共通基盤で用意する必要がある。
- 権限/切替監査: 施設/ユーザ切替、権限拒否を必ず監査イベントに記録する必要がある。
- 配信/送信監査: 配信適用・診療終了・印刷の成功/失敗を監査イベントと UI で同期する必要がある。

## 計画化のための前提確認リスト
- 認証フロー（施設/ユーザ選択・切替）の合意と API 仕様化。
- 監査イベントの共通スキーマ（operation/action/metadata）の再整理。
- 配信/運用の基準（即時/次回リロード/再ログイン）の合意。
- 送信/印刷の実処理方式（ORCA/バックエンド連携）の決定。

## 補足
- 監査検索 UI 基盤の有無が BKL-013/014/018 のクリティカルパス。
- 権限と配信の前提が固まらないと、UI 実装が二度手間になる可能性が高い。
