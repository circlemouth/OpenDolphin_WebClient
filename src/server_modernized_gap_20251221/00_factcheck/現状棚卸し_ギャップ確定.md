# 現状棚卸し_ギャップ確定（2025-12-21）

## 前提
- 期間: 2025-12-22 09:00 - 2025-12-24 09:00（計画）
- 手段: 既存コード/設定/Runbook の突合のみ。コンテナ起動・外部接続・実測は未実施。
- Phase2 文書は Legacy 参照のみ（更新対象外）。

## 参照ソース
- 現行参照: `docs/DEVELOPMENT_STATUS.md`
- 差分一次整理: `src/predeploy_readiness/00_inventory/開発ドキュメント総点検.md`
- API インベントリ: `docs/server-modernization/MODERNIZED_REST_API_INVENTORY.md`
- 旧サーバー API: `docs/server-modernization/server-api-inventory.md`
- Runbook/Legacy: `docs/server-modernization/phase2/operations/ORCA_API_STATUS.md`
- Jakarta ギャップ(参照): `docs/server-modernization/phase2/foundation/JAKARTA_EE10_GAP_LIST.md`
- 設定/コード根拠:
  - `server-modernized/src/main/webapp/WEB-INF/web.xml`
  - `server-modernized/src/main/webapp/WEB-INF/beans.xml`
  - `ops/modernized-server/docker/configure-wildfly.cli`
  - `server-modernized/src/main/java/open/dolphin/metrics/RequestMetricsFilter.java`
  - `server-modernized/src/main/java/open/dolphin/metrics/DatasourceMetricsRegistrar.java`
  - `server-modernized/src/main/java/open/orca/rest/OrcaMasterResource.java`
  - `server-modernized/src/main/java/open/dolphin/orca/transport/StubOrcaTransport.java`
  - `server-modernized/src/main/java/open/dolphin/orca/service/OrcaWrapperService.java`
  - `server-modernized/src/main/java/open/dolphin/rest/OutpatientClaimResource.java`
  - `server-modernized/src/main/java/open/dolphin/rest/orca/OrcaMedicalModV2Resource.java`
  - `server-modernized/src/main/java/open/dolphin/adm20/rest/PHRResource.java`
  - `server-modernized/src/main/java/open/dolphin/touch/*`
  - `server-modernized/src/main/java/open/dolphin/rest/LogFilter.java`
  - 監査 gap 指摘: `src/outpatient_ux_modernization/03_モダナイズAPIマッピング.md`

## 確認済み（実装/設定の一致）
- `web.xml` / `beans.xml` は Jakarta EE 10（Servlet 6 / CDI 4.0）スキーマへ更新済み。
- WildFly CLI に ORCADS/DataSource、JMS キュー、EE Concurrency、Micrometer サブシステム設定が存在。
- Micrometer 収集（`RequestMetricsFilter` / `DatasourceMetricsRegistrar`）は実装済み。
- `LogFilter` に 4xx/5xx 監査記録が実装済み（TraceId 連携含む）。
- `ORCAConnection` は JNDI `java:jboss/datasources/ORCADS` を使用（接続そのものは JNDI 依存）。

## 確定ギャップ（未実装/未検証）
1. **ORCA ラッパーの実接続未実装**
   - `OrcaWrapperService` は `StubOrcaTransport` に依存し、固定 XML を返却する構成。
2. **ORCA master API の実データ未接続**
   - `OrcaMasterResource` は snapshot/MSW fixture を読み込み、ORCA DB へ接続しない。
3. **Web クライアント前提 API が mock 応答**
   - `/api01rv2/claim/outpatient/*` と `/orca21/medicalmodv2/outpatient` は固定 RUN_ID の mock 応答で、実データ連携が未実装。
4. **監査連携の不足（ORCA wrapper）**
   - `OrcaAppointmentResource` など wrapper API で `recordAudit` 未実装（指摘あり）。
5. **PHR 実測・公開状況が未検証**
   - `PHRResource` は `web.xml` 登録済みだが、Runbook/Inventory 側は未公開扱いの記載が残存。実測証跡が未取得。
6. **Touch/Demo の JSON 統一と監査整備が未完**
   - `DolphinResource` / `DemoResource` 等の legacy XML と JSON 系 API が混在。ヘッダー必須化・監査イベント統一・Demo 固定 facility 運用の証跡が未取得。
7. **API インベントリの差分**
   - `MODERNIZED_REST_API_INVENTORY` に Web クライアント前提 API（`/api01rv2/claim/outpatient/*`, `/orca21/medicalmodv2/outpatient` 等）が未記載。
8. **ORCA_API_STATUS の記載不足**
   - acceptlstv2/medicalmodv2 以外が未記載で、PHR/予約/紹介状/マスタ API の実測結果が未反映。

## PHR / ORCA / Touch / Demo 差分一次リスト（スコープ確定）
| 領域 | コード実装の現況 | Runbook/Inventory の現況 | 確定ギャップ（一次スコープ） |
| --- | --- | --- | --- |
| PHR | `PHRResource` 登録済み、`PhrDataAssembler`/`IdentityService` 等が稼働前提 | `MODERNIZED_REST_API_INVENTORY` では未公開扱い・監査/ヘッダー要件のみ記載 | 実測証跡未取得、外部接続/Secrets/Export 設定の検証不足。Runbook 記述との不整合解消が必要。 |
| ORCA | Wrapper は stub transport、Master API は fixture 読み込み | `ORCA_API_STATUS` は一部のみ記載、実接続の証跡が不足 | ORCA 実接続・Master REST 実データ化・監査連携（予約/請求）の実測証跡取得が必要。 |
| Touch | legacy XML (`DolphinResource*`) と JSON (`Touch*Resource`) が混在 | Inventory では JSON 統一・ヘッダー/監査要件を明記 | JSON 応答統一、ヘッダー必須化、監査イベント整備、テスト/証跡未取得。 |
| Demo | `DemoResource*` 登録済み（legacy XML 前提） | Inventory では Demo JSON 化・固定 facility 運用を要求 | Demo 専用ヘッダー/監査/データ固定の検証未実施。 |

## 未検証項目（証跡欠落）
- ORCA 実接続（ORCA_CERTIFICATION_ONLY 準拠）の 200 証跡
- PHR 11 API + export 系の 200 証跡と監査ログ
- Touch/Demo の JSON 応答とヘッダー/監査の整合性
- ORCA Master API の実データ連携（fixture 置換後の差分/ETag/キャッシュ）
- Web クライアント前提 API の Stage/Preview 実測（HAR/telemetry）

## 補足
- 本棚卸しは「コード/設定/Runbook の突合」まで。実測は別タスクで実施する。
- Phase2 文書の更新は行わない。必要なら `docs/DEVELOPMENT_STATUS.md` に現行ギャップを集約する方針を別途決定する。
