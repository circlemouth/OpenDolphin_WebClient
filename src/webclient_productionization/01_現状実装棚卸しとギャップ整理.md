# 01 現状実装棚卸しとギャップ整理

- RUN_ID: `20251227T060850Z`
- 期間: 2025-12-29 09:00 〜 2025-12-31 09:00 (JST) / 優先度: high / 緊急度: high / エージェント: codex
- YAML ID: `src/webclient_productionization/01_現状実装棚卸しとギャップ整理.md`

## 参照チェーン
1. `docs/DEVELOPMENT_STATUS.md`
2. `docs/web-client/architecture/future-web-client-design.md`
3. `web-client/src/AppRouter.tsx`
4. `web-client/src/features/*`

## 1. 実装棚卸し（Login / AppShell / Reception / Charts / Patients / Administration / Outpatient Mock）

### Login
- 実装済み
  - 施設ID/ユーザーID/パスワード/クライアントUUID入力、MD5化して `/user/{facility:user}` へ GET。
  - RUN_ID 発行（generateRunId）+ observability meta 設定。
  - 成否メッセージ表示、成功時に displayName/commonName を表示。
  - dev 用 seed を localStorage に保存。
- 暫定/未実装
  - テレメトリ（login success/failure）送信が未実装。
  - 失敗時の明確な `role=alert` 出し分けは未実装（常に role=status）。
  - セッション継続・トークン更新等の本番認証フローは未整備。

### AppShell（AppRouter）
- 実装済み
  - トップバー（施設/ユーザー/role/RUN_ID/ログアウト）。
  - 左ナビ（Reception/Charts/Patients/Administration/Outpatient Mock）。
  - role によるリンク無効化（aria-disabled + tabIndex）。
- 暫定/未実装
  - RUN_ID クリックでコピー（設計要件）未実装。
  - 通知トーストスタック未実装。
  - ナビのバッジ/ツールチップ未実装。
  - 画面共通の data-run-id 付与ポリシーが統一されていない。

### Reception
- 実装済み
  - 検索/フィルタ/ソート + URL/LocalStorage 同期。
  - 受付ステータス別のグループ表示・折りたたみ。
  - ToneBanner/ResolveMasterBadge/OrderConsole で tone/transition/missingMaster/cacheHit を制御。
  - API 連携（claim flags / appointment outpatients）+ audit/logUiState。
  - ダブルクリック or Enter で Charts 遷移、RUN_ID 継承。
- 暫定/未実装
  - 右ペイン（患者概要/直近診療/オーダー概要）未実装。
  - 受付テーブル列（保険/自費、ORCA キュー状態、直近診療）不足。
  - 受付行ダブルクリックで「新規タブ」遷移は未実装。
  - 監査メモ入力はあるが、操作履歴の一覧ビューは未実装。

### Charts
- 実装済み
  - ChartsActionBar（送信/下書き/終了/印刷）＋監査/テレメトリ連携。
  - DocumentTimeline / OrcaSummary / PatientsTab / TelemetryFunnelPanel。
  - ORCA queue 取得とステータス可視化。
  - 管理配信（admin config）適用メタ表示、配信影響バナー。
  - 外来コンテキスト保持（URL/search+localStorage）とタブロック。
- 暫定/未実装
  - ActionBar の下書き保存は TODO（本実装未着手）。
  - finish/cancel/print がデモ扱い（監査のみで実処理なし）。
  - 外来カルテ作業台（3カラム+右固定メニュー）未実装。
  - 患者安全向けヘッダ（氏名強調/年齢・和暦併記/誤認防止）未実装。
  - Charts 画面に AuthServiceControls（デモ）を常設。

### Patients
- 実装済み
  - 患者一覧 + 編集フォーム、保存/削除、validation、監査イベント表示。
  - Reception フィルタの継承、Charts 戻り導線。
  - missingMaster/fallbackUsed/transition による保存ブロック。
- 暫定/未実装
  - 監査ログの履歴ビューは簡易表示のみ（詳細/検索/時系列なし）。
  - ORCA 反映ステータスの明示 UI は未実装。
  - 未紐付ステータス（warning + トースト）の明示 UI は未実装。

### Administration
- 実装済み
  - ORCA 接続設定、MSW/配信フラグ切替、保存で broadcast + audit。
  - 配信キュー一覧（再送/破棄）とトーン警告。
  - system_admin 以外は編集不可（UI disable）。
- 暫定/未実装
  - 環境ラベル（dev/stage）や即時/次回リロード状態の表示が未実装。
  - ルートアクセス制限は UI 側のみ（画面自体は閲覧可能）。

### Outpatient Mock
- 実装済み
  - MSW シナリオ切替、missingMaster/cacheHit/transition の強制。
  - テレメトリ funnel（resolve_master → charts_orchestration）確認。
  - fault injection（timeout/500/schema mismatch/queue stall）設定。
- 暫定/未実装
  - 本番での非表示/権限制御が未実装（ナビに常時露出）。

## 2. future-web-client-design.md とのギャップ（P0/P1/P2）

### P0（本番運用ブロッカー）
- 認可/権限の実効制御
  - Administration 画面のアクセス制限が UI だけで、URL 直叩き時のブロック無し。
- Charts の業務処理がデモ止まり
  - ActionBar の下書き保存、finish/cancel/print が実処理になっていない。
- 監査の永続化と網羅性
  - auditEvent/logUiState の送信はあるが、永続ストアへの保証・全操作網羅（login/患者編集/配信/送信）に未達。

### P1（本番前に必須レベルの不足）
- AppShell の設計要件不足
  - RUN_ID コピー、通知トーストスタック、ナビのバッジ/ツールチップ。
- Reception の詳細ペイン不足
  - 患者概要/直近診療/オーダー概要/ORCA キュー状態が未実装。
- Charts の UI/UX 要件不足
  - 外来カルテ作業台（3カラム構成）、患者安全ヘッダ、SOAP セクション編集の統合。
- Patients の監査・ORCA 反映ステータス不足
  - 監査ログ履歴ビュー、未紐付ステータス警告が未実装。
- ARIA/監査の統一運用
  - 画面横断で `role=status|alert` + `aria-live` の統一ルール未整備。
  - `data-run-id` の付与箇所が統一されていない。

### P2（改善・拡張レベル）
- Charts の右固定メニュー/詳細編集 UI。
- Administration の配信環境ラベル・配信状態の詳細表示。
- Outpatient Mock の本番時非表示切替（環境変数/権限スイッチ）。
- Reception/Patients の検索 UI 強化（保存ビュー、バッジ件数など）。

## 3. “本番運用可能” 判定の不足項目（セキュリティ/監査/運用/テスト）

### セキュリティ
- 認証/セッション: トークン更新・失効・多要素等の本番設計が未確立。
- 認可: 画面・API 両面の権限制御（特に Administration/送信系）の保証が不足。
- 資格情報の保護: dev 用 localStorage 保管の運用切替（本番無効化）と秘匿設計が必要。
- 通信安全性: CSRF/リプレイ/監査ログ改ざん防止の設計が未確認。

### 監査
- 監査イベントの永続ストレージ連携（サーバ側監査ログ）未確定。
- 操作単位での operation 分類（chart_note_add 等）と必須メタ（runId/traceId/transition）の網羅性が不足。
- 監査 UI の検索・時系列・差分表示が未実装。

### 運用
- 通知/障害時の運用導線（トースト/アラート集約・再試行ガイド）不足。
- 監視・ログ集約（RUM/トレース/メトリクス）の実運用設計が未整備。
- 配信/環境切替の運用ガード（設定ロールバック/確認フロー）が不足。

### テスト
- Playwright/E2E での主要フロー検証（Login→Reception→Charts→Patients→Administration）未整備。
- tone/ARIA/runId/transition chain の自動検証不足。
- 患者編集/送信/配信の失敗系テスト（ネットワーク障害/権限不足）未整備。

