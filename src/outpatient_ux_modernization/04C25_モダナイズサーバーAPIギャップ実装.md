# 04C2.5 モダナイズサーバー API ギャップ実装（RUN_ID=20251209T120000Z）

- 対象期間: 2025-12-09 JST（本書修正のみ。追加のサーバー操作・接続試験は未実施）
- 優先度: High / 緊急度: Medium
- 参照チェーン: `AGENTS.md` → `docs/web-client/README.md` → `docs/server-modernization/phase2/INDEX.md` → `docs/managerdocs/PHASE2_WEB_CLIENT_EXPERIENCE_MANAGER_CHECKLIST.md` → 本ファイル
- 依存: 04C2 WEB クライアント API 統合実装、04C3 WEB クライアント API 接続検証
- 背景: 12/08 ローカル modernized で外来 API 404 を解消（200 応答・telemetry 取得）。本書ではギャップ一覧を最新化し、「解消済み」「未解消」「検証未実施」を明確化する。

## 1. サマリー（2025-12-09 更新）
- `/api01rv2/claim/outpatient/mock` / `/orca21/medicalmodv2/outpatient` は **解消済み**。web.xml へのリソース登録＆stub 実装で 200 応答を確認（RUN_ID=20251208T180500Z, ローカル modernized, MD5 認証, MSW OFF）。tone/telemetry carry-over も UI で確認済み。
- `Stage/Preview` での再検証は未実施（DNS 解決不可・接続権限未取得）。次回も RUN_ID=20251208T124645Z/20251205T133848Z を再利用して再走予定。
- `/api01rv2/appointment/outpatient/*` の `auditEvent`/metadata 透過は **未解消**。現行 `OrcaAppointmentResource` に `recordAudit` 未実装。優先度 High（外来 reception banner の監査欠落）。

## 2. ギャップ一覧（解消状況を明確化）
| API / ギャップ | 状況 | 確認日 | 検証手段 | ワークアラウンド / 次アクション | オーナー / 優先度 |
| --- | --- | --- | --- | --- | --- |
| `/api01rv2/claim/outpatient/mock` 404 → stub 実装＋audit metadata | 解消済 | 2025-12-08 | ローカル modernized（MSW OFF, `VITE_DEV_PROXY_TARGET=http://localhost:9080/openDolphin/resources`, MD5 ヘッダ）。証跡: `docs/server-modernization/phase2/operations/logs/20251208T180500Z-integration-qa.md` / `artifacts/webclient/e2e/20251208T180500Z-integration/`。 | UI では tone=server / cacheHit=false / missingMaster=false を carry-over 済み。Stage/Preview での 200 再確認が残課題。 | サーバー: modernized チーム（owner TBD）。優先度: High（Stage 追認待ち）。 |
| `/orca21/medicalmodv2/outpatient` 404 → stub 実装＋audit metadata | 解消済 | 2025-12-08 | 同上（curl + UI 巡回）。証跡: `docs/server-modernization/phase2/operations/logs/20251208T180500Z-integration-qa.md`。 | Stage/Preview 未実施。データ量増で `recordsReturned`/`outcome` の挙動差があれば再度 telemetry 収集。 | サーバー: modernized チーム。優先度: High（Stage 追認待ち）。 |
| `/api01rv2/appointment/outpatient/*` 監査・metadata 透過なし | 未解消 | 最終確認 2025-12-04 | デスク調査 (`docs/server-modernization/phase2/operations/logs/20251204T064209Z-api-gap.md`)。実 API での `recordAudit` 追加未確認。 | Web クライアントでは `resolveMasterSource`/`tone` は carry-over するが audit 欠落。暫定: reception バナーは `dataSourceTransition` を表示しつつ監査欠落を警告に残す。 | サーバー: OrcaAppointmentResource 担当。優先度: High。ブロッカー: audit 実装待ち。 |
| Stage/Preview での外来 API 実測（DNS / 認証） | 検証未実施 | 2025-12-05/08 | `stage.open-dolphin` DNS 解決不可で curl/Playwright 失敗（RUN_ID=20251205T133848Z, 20251208T124645Z）。 | DNS/証明書復旧後に同 RUN_ID を再利用して再実行。UI バナーで `dataSourceTransition=server` を取得し DOC_STATUS/チェックリストへ展開。 | マネージャー経由で Stage 権限者に依頼。優先度: Medium。 |

## 3. 証跡リンク
- 実装＋MSW OFF 検証: `docs/server-modernization/phase2/operations/logs/20251208T180500Z-integration-qa.md`
- stub 実装内容: `docs/server-modernization/phase2/operations/logs/20251208T124645Z-api-gap-implementation.md` / `artifacts/api-stability/20251208T124645Z/outpatient/`
- Stage/Preview 失敗ログ: `docs/server-modernization/phase2/operations/logs/20251205T133848Z-charts-qa.md`, `docs/server-modernization/phase2/operations/logs/20251208T124645Z-dev-proxy-validation.md`
- ORCA API ステータス集約: `docs/server-modernization/phase2/operations/ORCA_API_STATUS.md`（外来行に 12/09 追記済み）

## 4. 今後のタスク
1. `OrcaAppointmentResource` に `recordAudit(action=ORCA_APPOINTMENT_OUTPATIENT, details: runId/cacheHit/missingMaster/dataSourceTransition/appointmentId/patientId)` を追加する PR を依頼し、実装完了後に本書と 04C3 を更新。
2. Stage/Preview DNS 復旧後、RUN_ID=`20251209T120000Z` のまま 12/08 と同手順で UI + curl を再実施し、`resolveMasterSource`/`tone=server` の carry-over をスクリーンショット付きで追記。
3. `DOC_STATUS.md` と `PHASE2_WEB_CLIENT_EXPERIENCE_MANAGER_CHECKLIST.md` の外来行に、本 RUN_ID と証跡ログを同期する（本ファイルの更新完了後に実施）。

## 5. リスクと回避策
- Stage/Preview のネットワーク復旧が遅延すると、tone バナーの server ルート確認が遅れる。→ ローカル modernized の CI 実行（MSW OFF curl + Playwright）で毎回 200 を確認し、Stage 再開まで UI リグレッションを抑止する。
- appointment 監査未実装のままリリースすると reception banner の監査ログが欠落。→ `auditEvent` が付くまで banner に「監査未送信」ラベルを表示し、ログにも WARN を残す暫定ワークアラウンドを維持する。

## 6. 報告テンプレ
`【ワーカー報告】RUN_ID=20251209T120000Z 実施: 04C25ドキュメント更新/検証。証跡: docs/server-modernization/phase2/operations/logs/20251209T120000Z-webclient-04C25.md。DOC_STATUS更新: docs/web-client/planning/phase2/DOC_STATUS.md 該当行を更新。`
