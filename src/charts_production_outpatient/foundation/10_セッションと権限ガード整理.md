# 10 セッションと権限ガード整理（webclient charts production outpatient plan）

- RUN_ID: `20251213T000432Z`
- 期間: 2025-12-22 09:00 〜 2025-12-24 09:00 (JST) / 優先度: high / 緊急度: medium / エージェント: codex
- YAML ID: `src/charts_production_outpatient/foundation/10_セッションと権限ガード整理.md`
- 参照チェーン: `AGENTS.md` → `docs/web-client/README.md` → `docs/server-modernization/phase2/INDEX.md` → `docs/managerdocs/PHASE2_WEB_CLIENT_EXPERIENCE_MANAGER_CHECKLIST.md` → `src/charts_production_outpatient/00_RUN_IDと参照チェーン.md` → 本書
- 証跡ログ: `docs/web-client/planning/phase2/logs/20251213T000432Z-charts-session-permission-guard.md`

---

## 0. 結論（決めたこと）
- Charts の主要アクション（診療終了/ORCA送信/患者編集/印刷）は **権限ロールでのみ活性化** し、非活性時は理由を tooltip＋`aria-describedby` で提示する。非表示にはしない。
- セッション切れ・施設不一致・ユーザー変更を検知したら、`runId` と患者選択・ドラフトを **即座に破棄してブロック UI** を出し、ログアウト（再ログイン）へ誘導する。
- 監査要件「誰が/いつ/どの runId で」を満たすため、Topbar と Charts ヘッダーで **facility・user・runId・発行時刻** を常時表示し、runId pill からコピーできるようにする。

---

## 1. 権限ガード（活性条件と理由提示）

### 1.1 権限マトリクス（UI 活性）
| アクション | system_admin | 医師 | 看護 | 受付 |
| --- | --- | --- | --- | --- |
| 診療終了 | ✅ | ✅ | ❌ | ❌ |
| ORCA送信/再送/破棄 | ✅ | ✅ | ✅（再送のみ） | ✅（再送のみ） |
| 患者編集（基本/保険） | ✅ | ✅ | ✅ | ❌ |
| 印刷/出力（領収/明細） | ✅ | ✅ | ✅ | ✅ |

- 役割は `SessionContext.role` を単一ソースにし、`AuthServiceProvider` から `ChartsActionBar` / `PatientsTab` / `OrcaSummary` / 印刷ボタンへ渡す。
- `missingMaster` や `fallbackUsed` 由来のビジネスガードは従来通り（送信不可など）適用し、ここでは **権限不足の理由** を明示する。

### 1.2 無効化時の表示・ARIA
- ボタンは `disabled`（非表示にしない）＋ `data-disabled-reason="permission_denied|session_invalid|missing_master|facility_mismatch"` のようにメタを持たせる。
- `aria-describedby` で紐づけた説明テキストを同一 DOM に置く（例: `<p id="chart-action-disable-reason">権限: 医師のみ実行可</p>` を `sr-only` で配置）。
- Tooltip には簡潔な理由を表示する（例: 「権限がありません（医師/管理者専用）」）。Focus 時にも理由が読まれることを Playwright/A11y で確認する。
- 監査/テレメトリ: `audit.logUiState(action=CHARTS_ACTION_DISABLED, reason, runId, facilityId, userId, patientId?)` を共通で送信。`recordOutpatientFunnel('charts_action', {action, enabled:false, reason})` でも残す。

### 1.3 実装の置き場所（参考）
- `web-client/src/features/charts/ChartsActionBar.tsx`: 診療終了/送信/再送/破棄/印刷の活性制御と理由表示。
- `web-client/src/features/charts/PatientsTab.tsx`: 患者編集ボタンの権限チェックと `aria-describedby` 付与。
- `web-client/src/features/charts/pages/ChartsPage.tsx`: 権限不足時に action bar 全体を disabled とし、上部に警告バナーを表示。
- `web-client/src/features/auth/AuthServiceProvider.tsx`: `SessionContext` に `role/facilityId/userId/runId/issuedAt` を保持し、切替/破棄を集中管理。

---

## 2. セッション切れ・施設不一致・ユーザー変更時の扱い

### 2.1 検知条件
- セッション切れ: 401/419 などの認証エラー、または `AuthService` が保持する `issuedAt + ttl` を超過。
- 施設不一致: セッションの `facilityId` と API 応答/ヘッダーの `facility-id` が一致しない、または Reception→Charts のパラメータと異なる。
- ユーザー変更: 同一ブラウザで別ユーザーへログインした痕跡（`SessionContext.userId` と localStorage 保存値の差異、`runId` が再発行されたことの検知）。
- runId 不整合: Topbar の `runId` と Charts 内に保持している `AuthService.runId` が異なる（バックグラウンド更新時など）。

### 2.2 破棄対象と UI
- 破棄対象: `runId`、選択患者（`selectedPatient`）、編集中ドラフト（localStorage/React Query キャッシュ）、予約/請求キャッシュ、送信キューのローカルステータス。
- UI: Charts 全体を **半透明のブロッカー** で覆い、モーダルで「セッションが無効/施設不一致/ユーザーが変更されました。再ログインしてください。」を `role=alertdialog` + `aria-live=assertive` で表示。唯一のアクションは「ログアウトして戻る」。
- ナビゲーション: モーダルから Login へ遷移し、`AuthService.clear()` を経由して runId/credential を削除。ブラウザバックで戻れないよう `replace` ナビを使用。
- 監査: `audit.logUiState(action=SESSION_INVALID, reason, facilityId, userId, runId?, patientId?)` を送信し、`recordOutpatientFunnel('session_guard', {...})` で時刻と理由を残す。

### 2.3 API/キャッシュの同期
- `react-query` の `queryClient.clear()`（Charts 領域の key のみ）を実行し、stale データを表示しない。
- `localStorage` に保存しているドラフト/選択患者は `runId` を key に紐付け、runId が変わった時点で自動削除する。
- `AuthService` が `facilityId` 変更を検知した場合は、Reception 側にも通知（バナー）を出し、双方で再ログインを要求する。

---

## 3. 監査表示（Topbar / Charts ヘッダー）

### 3.1 Topbar（全画面共通）
- 表示項目: `facilityId` + 施設名、`userId` + 表示名、`role`、`runId` pill、`runIdIssuedAt`（UTC）を並列表示。`runId` pill はクリックでコピーできる。
- aria: Topbar の `runId` pill に `aria-label="RUN_ID 20251213T000432Z（コピー可）"` を付与し、`aria-live=polite` で更新を告知。
- セッション異常時: `runId` pill を赤色バッジに切り替え、`data-state="invalid"` として tooltip に「セッションを再取得してください」と表示。

### 3.2 Charts ヘッダー（ページ内）
- 表示項目: 患者ID/氏名/受付ID/保険-自費トグル + `runId` + `dataSourceTransition/missingMaster/cacheHit/fallbackUsed` バッジ。`runId` は Topbar と同値で、差異があれば警告を表示。
- 「誰が/いつ」の補完: `updatedAt` または `encounterClosedAt` を併記し、`userId`/`role` をサブラベルに表示する（監査ログに一致させる）。
- 印刷/診療終了/送信ボタンのそばに `aria-describedby` で runId を付け、監査文脈が画面から確認できるようにする。

### 3.3 表示更新のトリガー
- Login 成功時: `runId` と `runIdIssuedAt` を Topbar/Charts に一括反映。
- runId 再発行時（ユーザー切替や再ログイン）: 旧 runId で開いているタブは 2.2 のブロッカーを表示し、新 runId での再取得を促す。

---

## 4. 次アクション（実装タスク化のためのメモ）
- `ChartsActionBar` と `PatientsTab` に共通の `usePermissionGuard`（権限 + セッション状態 + missingMaster）フックを追加し、`aria-describedby` 付き理由を返す。
- Topbar の `RunIdPill` に `issuedAt` と `role/facility/user` を追加し、コピー/警告 UI を再利用できるようにコンポーネント化する。
- セッション無効化の共通ハンドラを `AuthServiceProvider` に置き、401/419/施設不一致を捕捉する Axios interceptor と連動させる。
