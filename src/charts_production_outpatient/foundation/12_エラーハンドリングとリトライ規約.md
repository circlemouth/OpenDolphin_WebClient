# 12 エラーハンドリングとリトライ規約（webclient charts production outpatient plan）

- RUN_ID: `20251213T121500Z`
- 期間: 2025-12-24 09:00 〜 2025-12-26 09:00 (JST) / 優先度: high / 緊急度: medium / エージェント: cursor cli
- YAML ID: `src/charts_production_outpatient/foundation/12_エラーハンドリングとリトライ規約.md`
- 参照: `src/charts_production_outpatient/03_モダナイズ外来API契約テーブル確定.md`（RUN_ID=`20251212T143720Z`）、`src/charts_production_outpatient/foundation/10_セッションと権限ガード整理.md`（RUN_ID=`20251213T000432Z`）、`docs/web-client/ux/charts-claim-ui-policy.md`、`docs/web-client/ux/reception-schedule-ui-policy.md`、`docs/web-client/operations/debugging-outpatient-bugs.md`
- 証跡ログ: `docs/web-client/planning/phase2/logs/20251213T121500Z-charts-error-handling.md`

---

## 0. 結論（決めたこと）
- API 失敗は **tone/banner/aria-live の共通ルール** に従い、runId/traceId/失敗理由/再試行導線を必ずセット表示する。timeout/5xx は error（`aria-live=assertive`）、4xx は warning/info（理由別）、スキーマ不一致は error + 「データ構造を確認してください」を明示する。
- `missingMaster=true` または `fallbackUsed=true` のときは **送信・編集・印刷をブロック**。Charts ヘッダー直下に ToneBanner（warning, `aria-live=assertive`）を常時表示し、次アクション（再取得/Receptionへ戻る/管理者連絡）を示す。アクションボタンは disabled のまま理由付きで表示する。
- ErrorBoundary は **ページ初期化不可・セッション無効・必須文脈欠損** 時のみ全画面ブロックに使う。API 単位の失敗は各パネル内の部分失敗 UI（ToneBanner + 空状態 + 再取得ボタン）で扱い、他パネルを巻き込まない。

## 1. 失敗タイプ別の表示とリトライ共通ルール
| 失敗タイプ | UI/トーン | 導線・再試行 | 監査/テレメトリ |
| --- | --- | --- | --- |
| timeout / network error | ToneBanner error（assertive）、`runId`/`traceId` を併記。 | 「再取得」ボタン（同リクエストを idempotent で再送）。ポーリング系は次周期も継続。 | `audit.logUiState(action, outcome=ERROR, reason=timeout, runId, traceId)` を送る。 |
| 5xx | ToneBanner error（assertive）。再取得ボタン + “復旧しない場合は管理者へ” 文言。 | ボタン押下時に retry 回数を TelemetryFunnel へ送る（連打防止の cooldown=5s）。 | `auditEvent.outcome=ERROR` + status code。 |
| 401/403 | ToneBanner warning（assertive） + 「再ログインして続行」リンク。 | `AuthService` へ委譲し、セッション無効フロー（10 章）で runId/キャッシュ破棄。 | `audit.logUiState(action=SESSION_INVALID, reason=401|403, runId)`。 |
| 404（対象なし） | ToneBanner info（polite） + 空状態（アイコン/説明）を表示。 | 「戻る」「再取得」「別患者を開く」導線を提示。 | `auditEvent.details.recordsReturned=0` を明示。 |
| 409/412（楽観ロック等） | ToneBanner warning（assertive） + 「最新情報を再読込してから保存」を表示。 | 再取得後に編集を再度有効化。 | `outcome=BLOCKED`、reason=conflict/precondition_failed。 |
| スキーマ不一致/parse 失敗 | ToneBanner error（assertive） + 「データ構造が想定と異なります」と表示し、`runId`/`traceId`/`content-type` を列挙。 | 「再取得」＋「ログをダウンロード」導線。自動再試行はしない。 | `auditEvent.details.schemaMismatch=true` を付加し、`debugging-outpatient-bugs.md` の手順で raw を保存。 |

補足: 取得系は必ず「再取得」ボタンを持つ。保存/送信系は **retry=手動のみ** とし、成功するまで結果を提示しない。

## 2. `missingMaster` / `fallbackUsed` が真のときの扱い
- ブロック対象: ORCA送信/再送/破棄/診療終了/患者編集/印刷。`ChartsActionBar` と PatientsTab のボタンに `data-disabled-reason="missing_master|fallback_used"` を付け、`aria-describedby` で理由を読み上げる。
- 表示: Charts ヘッダー直下に ToneBanner warning（`aria-live=assertive`、`data-source-transition`/`cacheHit` pill 併設）。文言例: 「ORCA マスターデータが欠損しています。再取得しても解消しない場合は Reception でマスター更新後に再試行してください。」
- 導線: 1) 「再取得」ボタン（対象 API を再実行）、2) 「Receptionへ戻る」リンク（患者選択に戻ってマスター更新）、3) 「管理者へ共有」リンク（audit に runId/traceId を残しつつログをダウンロード）。
- 解除条件: `missingMaster=false` かつ `dataSourceTransition=server` を確認するまでボタン活性化を禁止。解除時は ToneBanner を Success/Info に切替え、`audit.logUiState(action='charts_guard_release', outcome=SUCCESS, runId)` を送る。

## 3. ErrorBoundary と部分失敗の使い分け
- 全画面 ErrorBoundary（blocker）のみで扱うケース
  - 初期ロードで患者コンテキスト/認証情報が取得できない。
  - `AuthService` 判定によるセッション無効・施設不一致・ユーザー変更（10 章のフロー）。
  - 画面全体で必須の設定（feature flag, env）が欠損している。
- 部分失敗（パネル内 ToneBanner + 再取得）で扱うケース
  - DocumentTimeline / OrcaSummary / PatientsTab / OrderConsole / TelemetryFunnel の個別 API エラー。
  - ポーリング中の一時的な timeout/5xx。
  - MSW/Mock から server への遷移失敗（dataSourceTransition が snapshot のまま）。
- 実装指針
  - ErrorBoundary は `data-testid="charts-error-boundary"` を付け、再読込ボタンを 1 つだけ置く。
  - パネル内の ToneBanner には `data-scope="panel"` を持たせ、隣接パネルが動いていることを示す「他の情報は利用可能です」テキストを添える。
  - 再取得ボタンの handler は `queryClient.refetchQueries`（対象 key 限定）を使用し、全体クリアは避ける。

## 4. リトライ/回復導線の具体化
- ポーリング系（予約/請求一覧）: 2 分間隔を維持しつつ、失敗時は即座に「手動再取得」ボタンを表示。連続 3 回失敗で ToneBanner を error に格上げし、ポーリングを一時停止して手動のみ許可。
- 手動取得（OrcaSummary, PatientsTab）: ボタン押下時に `runId`/`traceId` を再発行せず継続利用する。連続失敗回数を TelemetryFunnel に記録し、3 回で「管理者へ共有」を強調表示。
- 保存/送信系: 自動再試行禁止。UI は **結果未確定状態**（スピナー + 「サーバー応答待ち」）を 8 秒でタイムアウトし、error バナーへ切替える。retry 押下時は idempotent key を維持し、重複送信を防ぐ。
- UI 文言テンプレ（共通）: `title`=短い原因、「再取得」ボタン、「詳細ログを見る」リンク。aria は `role=alert`（warning/error）/`status`（info）で統一。

## 5. 監査・オブザーバビリティ
- すべての失敗で `auditEvent.details` に `runId/traceId/dataSourceTransition/cacheHit/missingMaster/fallbackUsed/status/reason/retryCount` を残す。UI からも `logUiState` を同キーで送る。
- ToneBanner/再取得ボタンには `data-run-id` と `data-trace-id` を属性で保持し、HAR/Playwright の assertion で利用できるようにする。
- スキーマ不一致/parse 失敗時は `docs/web-client/operations/debugging-outpatient-bugs.md` に従い raw JSON/headers を保存し、証跡ログへパスを貼る。

## 6. 実装タスクの置き場所メモ
- `web-client/src/libs/http/httpClient.ts`: 共通エラー整形と `traceId` 生成。timeout/5xx のリトライ禁則・cooldown をここで扱う。
- `web-client/src/components/ToneBanner.tsx`（想定）: tone=warning/error の `aria-live` 既定値を本規約に合わせる。
- `web-client/src/features/charts/*` の各パネル: `data-scope="panel"` 付き部分失敗 UI と `queryClient.refetchQueries` を実装。
- `tests/e2e`（Playwright）: 失敗パターン 4 種（正常/ missingMaster / fallbackUsed / timeout ）をフィクスチャと assertion で追加し、ToneBanner 表示と再取得導線を検証する。
