# 01 外来機能の完全カバレッジ定義（Charts / 商用カルテ品質のゴール）

- RUN_ID=`20251212T131901Z`
- 参照チェーン: `AGENTS.md` → `docs/web-client/README.md` → `docs/server-modernization/phase2/INDEX.md` → `docs/managerdocs/PHASE2_MANAGER_ASSIGNMENT_OVERVIEW.md` → 各 manager checklist
- 目的: Charts（電子カルテ画面）を **実運用できる品質** へ引き上げるため、モダナイズ版サーバーの外来機能（予約/請求/外来医療記録/患者更新/設定配信/キュー）を UI 観点で “漏れなく” 一覧化し、実装/検証タスクへ落とす。
- 成果（本ガントのゴール）: 「外来: 受付→診療→会計」を Charts 観点で完走できること（Reception からの遷移・患者編集・ORCA送信・状態遷移・印刷/出力）。
- 証跡ログ: `docs/web-client/planning/phase2/logs/20251212T131901Z-charts-outpatient-coverage.md`

---

## 0. 対象スコープ / 非対象

### 対象（外来のみ）
- Reception → Charts →（Patients/Administration を含む）→ 会計/印刷までの導線
- モダナイズ版サーバーの外来機能（予約/請求/外来医療記録/患者更新/設定配信/キュー）
- Charts の DoD（監査/アクセシビリティ/運用）を “要件として固定” し、未実装はギャップとして明示

### 非対象（本書では N/A）
- 入院ワークフロー
- Legacy 資産の更新（`client/`, `common/`, `ext_lib/`）
- 旧サーバースクリプトの改修（`server/`）

---

## 1. “商用カルテ品質” の Definition of Done（Charts 観点）

### 1.1 完走条件（受付→診療→会計）
- Reception から Charts へ遷移して患者コンテキスト（患者/受付/保険or自費/診療科）が保持される
- Charts で外来医療記録の参照/作成/保存ができ、送信キューへ投入できる（ドラフト/キャンセル含む）
- 患者更新（基本情報/保険）を行い、Charts に戻って文脈が保持される
- 会計状態へ遷移し、請求サマリ表示・印刷/出力が可能

### 1.2 監査（auditEvent / 操作ログ）
- すべての “意味のある操作” が `auditEvent`（サーバー）または `audit.logUiState`（UI）に記録される
- 監査メタが必ず透過される（最低限）:
  - `runId`, `traceId/requestId(存在すれば)`, `facilityId`, `userId`, `patientId`, `encounterId(または visitId)`, `action`, `outcome`, `durationMs`
  - `dataSource`, `dataSourceTransition`, `cacheHit`, `missingMaster`, `fallbackUsed`, `fetchedAt`
- 監査の粒度: “ボタン押下” ではなく “業務結果（診療終了/送信/再送/破棄/印刷）” に紐付く

### 1.3 アクセシビリティ（ARIA + 重要通知）
- 重要通知（エラー/警告/成功/状態遷移）が `role` と `aria-live` で一貫して伝達される
  - Error/Warning: `aria-live=assertive`（必要なら `role=alert`）
  - Info/Success: `aria-live=polite`（`role=status` を基本）
- キーボード操作（Tab/Shift+Tab/Enter/Esc）で主要導線が完走できる
- ダイアログ/ドロワーは focus trap、閉じたら “戻り先の要素” へ復帰
- “送信中/ロック中” が `aria-busy` 等で表現される（読み上げも含む）

### 1.4 運用（障害時表示 / 再試行 / フィクスチャ運用）
- 失敗時にユーザーが次に取れるアクションが必ず示される（再試行、キャンセル、保存、戻る）
- タイムアウト/通信断/401/403/404/5xx を “種別” で表現し、復旧導線がある
- MSW/fixture の “注入点” と “期待 UI” が定義され、E2E（Playwright）で再現可能
- `missingMaster`/`fallbackUsed` が true のときは **業務結果に影響する操作をガード** し、理由を提示する

---

## 2. カバレッジ一覧（機能 → UI 要件 → 監査/A11y/運用）

> 記号: Must=本番必須 / Should=早期に必要 / Could=後追い可（ただし DoD を崩さない範囲）

### 2.1 受付→Charts 導線（Reception 起点）
| 機能 | Must/Should | UI カバレッジ（Charts 観点） | 監査 | A11y/通知 | 障害時/再試行 | Fixture/テスト |
| --- | --- | --- | --- | --- | --- | --- |
| Reception から Charts へ遷移 | Must | 患者/受付/保険or自費/診療科の carry-over、戻る導線（Reception へ） | `action=CHARTS_OPEN` + context | 遷移完了を `polite` で告知（必要なら） | 404/権限不足を明確化 | Playwright: Reception→Charts |
| Charts 初期表示 | Must | ローディング/空状態/直近受診の表示、Tabs の初期フォーカス | `action=CHARTS_BOOTSTRAP` + duration | `aria-busy` + スケルトン | timeout→再試行/オフライン案内 | MSW: timeout/500 |
| コンテキスト変更（患者切替/保険切替） | Should | 切替後の UI 一貫性（タブ状態/検索条件） | `action=CONTEXT_SWITCH` | 変更を `polite` | 競合/未保存の警告 | E2E: unsaved guard |

### 2.2 外来医療記録（診療記録 / ドキュメント）
| 機能 | Must/Should | UI カバレッジ（Charts 観点） | 監査 | A11y/通知 | 障害時/再試行 | Fixture/テスト |
| --- | --- | --- | --- | --- | --- | --- |
| 診療記録の参照（タイムライン/履歴） | Must | DocumentTimeline（ロード/フィルタ/選択）、最新が分かる | `action=RECORD_FETCH` + `recordsReturned` | 件数は `polite` | 取得失敗→再試行 | MSW: empty/500 |
| 診療記録の作成/編集/保存（ドラフト） | Must | 編集UI、未保存表示、保存成功/失敗 | `action=DRAFT_SAVE` outcome | 成功=polite / 失敗=assertive | 競合/ロック/再試行 | E2E: draft save |
| キャンセル（編集破棄） | Must | 確認ダイアログ、破棄後の復帰 | `action=DRAFT_CANCEL` | ダイアログ focus trap | 破棄失敗→復旧 | MSW: 409 |
| 診療終了（状態遷移） | Must | “診療終了” 実行、進行表示、完了後の状態バッジ更新 | `action=ENCOUNTER_CLOSE` | 進行=polite、失敗=assertive | timeout/再試行/ロールバック案内 | MSW: timeout |

### 2.3 ORCA 送信キュー（送信/再送/破棄/遅延）
| 機能 | Must/Should | UI カバレッジ（Charts 観点） | 監査 | A11y/通知 | 障害時/再試行 | Fixture/テスト |
| --- | --- | --- | --- | --- | --- | --- |
| 送信（キュー投入） | Must | “送信” ボタン、進捗、キュー状態表示 | `action=ORCA_SEND` + duration | 送信中=polite、失敗=assertive | 再送導線 | E2E: send+retry |
| 再送 | Must | 失敗状態から再送、結果の差分表示 | `action=ORCA_RESEND` | 結果通知 | 多重クリック防止 | MSW: flaky |
| 破棄/取り消し | Should | “破棄”/“取消” の確認と可視化 | `action=ORCA_DISCARD` | ダイアログ/結果通知 | 誤操作防止 | E2E: confirm |
| 遅延/滞留の可視化 | Should | “滞留” バナー/最終更新/手動更新 | `action=QUEUE_REFRESH` | 更新=polite | 更新失敗→再試行 | MSW: stale |

### 2.4 予約（来院前後の予定/予約変更）
| 機能 | Must/Should | UI カバレッジ（Charts 観点） | 監査 | A11y/通知 | 障害時/再試行 | Fixture/テスト |
| --- | --- | --- | --- | --- | --- | --- |
| 患者別予約の表示 | Should | 次回予約/当日予約の表示、Reception との整合 | `action=APPOINTMENT_FETCH` | 件数=polite | 取得失敗→再試行 | MSW: empty |
| 予約変更/キャンセル（業務要件次第） | Could | 編集UI、監査要件の確定 | `action=APPOINTMENT_MUTATE` | 成功/失敗通知 | 409/権限の明示 | E2E: mutate |

### 2.5 請求（会計向けサマリ/印刷/出力）
| 機能 | Must/Should | UI カバレッジ（Charts 観点） | 監査 | A11y/通知 | 障害時/再試行 | Fixture/テスト |
| --- | --- | --- | --- | --- | --- | --- |
| 請求サマリ表示 | Must | 請求バンドル、missingMaster/fallbackUsed バナー | `action=CLAIM_FETCH` | 更新=polite | 取得失敗→再試行 | MSW: missingMaster |
| 会計状態への遷移（会計待ち/会計済み） | Should | 状態バッジ、Reception リスト反映 | `action=CLAIM_STATE_CHANGE` | 状態変化=polite | 競合/再取得 | E2E: state |
| 印刷/出力 | Must | 印刷対象選択、PDF/出力、成功/失敗 | `action=PRINT_OUTPATIENT` | 進行/完了通知 | print API 失敗→再試行 | MSW: 500 |

### 2.6 患者更新（基本情報/保険）※ Charts からの “戻り” を含む
| 機能 | Must/Should | UI カバレッジ（Charts 観点） | 監査 | A11y/通知 | 障害時/再試行 | Fixture/テスト |
| --- | --- | --- | --- | --- | --- | --- |
| 患者基本情報の更新 | Must | Patients へ遷移→編集→保存→Charts へ復帰 | `action=PATIENT_UPDATE` + `operation=update` | 成功/失敗通知 | 409/権限 | E2E: edit roundtrip |
| 保険/公費の更新 | Must | 保険セット編集、Validation、反映タイミング明示 | `action=INSURANCE_UPDATE` | Validation は `assertive` | 保存失敗→復旧 | MSW: validation |
| Charts への反映 | Must | サマリ/請求/記録に反映、コンテキスト保持 | `action=PATIENT_REFRESH` | 反映完了=polite | 反映失敗→再取得 | E2E: refresh |

### 2.7 設定配信（Administration / フラグ / マスタ切替）
| 機能 | Must/Should | UI カバレッジ（Charts 観点） | 監査 | A11y/通知 | 障害時/再試行 | Fixture/テスト |
| --- | --- | --- | --- | --- | --- | --- |
| 設定変更の受信通知 | Must | Charts 上で “設定が更新された” を明示（再読込/手動更新導線） | `action=CONFIG_RECEIVED` | 変更通知=polite | 反映失敗→再読込 | E2E: banner |
| 配信キューの状態（遅延/失敗） | Should | 影響範囲（Charts/Reception）への影響説明 | `action=CONFIG_DELIVERY_STATUS` | 重要は assertive | 復旧導線 | MSW: delay |

---

## 3. ガード条件（本番事故を防ぐ）

### 3.1 `missingMaster=true` / `fallbackUsed=true` の扱い
- Must: 患者更新/送信/会計確定/印刷など “結果が残る操作” はガード（無効化 + 理由の表示 + 監査）
- Must: ガードされた操作は `audit.logUiState` に `outcome=BLOCKED` と理由を残す
- Should: 手動更新（再取得）で復帰できる導線を常設する

### 3.2 排他/ロック（多重送信・競合）
- Must: 送信/診療終了/印刷はロック（再入防止）し、`aria-busy` と “いま何が起きているか” を通知
- Must: 競合（409 等）を検出したら “再読込して再実行” の導線を出す

---

## 4. 検証（最低ライン：Playwright + MSW で担保）

### 4.1 E2E シナリオ（外来完走）
1. Reception で患者を選択 → Charts に遷移
2. 診療記録を編集 → ドラフト保存 → 送信 → キュー状態を確認
3. Patients で基本情報/保険を更新 → Charts に戻って反映確認
4. 会計サマリ表示 → 印刷/出力（成功/失敗の両方を fixture で再現）

### 4.2 重要な異常系（必ず fixture で再現可能にする）
- timeout（再試行できる）
- 401/403（権限/再ログイン/戻る）
- 409（競合 → 再取得）
- `missingMaster=true`（送信/確定/印刷がブロックされる）
- `fallbackUsed=true`（警告 + 監査 + 誤操作防止）

---

## 5. 依存ドキュメント（必読）
- `docs/web-client/planning/phase2/WEB_CLIENT_IMPLEMENTATION_PLAN.md`
- `docs/web-client/ux/charts-claim-ui-policy.md`
- `docs/web-client/ux/reception-schedule-ui-policy.md`
- `docs/web-client/architecture/web-client-api-mapping.md`
- `src/webclient_modernization_phase2/04_charts/ORCA送信・ドラフト・キャンセル制御.md`

