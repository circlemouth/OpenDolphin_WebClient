# 26 印刷/エクスポート（診療文書）（webclient charts production outpatient plan）

- RUN_ID: `20251217T233649Z`
- 期間: 2026-01-13 09:00 〜 2026-01-16 09:00 (JST) / 優先度: medium / 緊急度: low / エージェント: codex
- YAML ID: `src/charts_production_outpatient/ux/26_印刷_エクスポート_診療文書.md`

## 0. 目的とアウトカム
- Charts（外来）の “診療記録の出力” を **商用要件として最低限実装** し、印刷プレビュー（A4/余白/ヘッダ）と PDF 出力導線を提供する。
- 監査ログに “誰が・いつ・何を出力したか” を **runId と紐づけて記録** し、後追い可能にする。
- 個人情報の取り扱い（画面/印刷）を明示し、出力時の注意喚起（`tone=warning`）を UI に組み込む。

## 1. 参照チェーン・インプット
- `AGENTS.md` → `docs/web-client/README.md` → `docs/server-modernization/phase2/INDEX.md` → `docs/managerdocs/PHASE2_WEB_CLIENT_EXPERIENCE_MANAGER_CHECKLIST.md`
- Charts 基盤:
  - `src/charts_production_outpatient/foundation/11_監査ログauditEvent統一.md`
  - `src/charts_production_outpatient/foundation/12_エラーハンドリングとリトライ規約.md`
  - `src/charts_production_outpatient/03_モダナイズ外来API契約テーブル確定.md`（missingMaster/fallbackUsed ガード方針）

## 2. UI フロー（最低限）
1. Charts アクションバーの **「印刷/エクスポート」** を押下
2. 印刷プレビューページ（A4）へ遷移し、`ToneBanner tone="warning"` を表示
3. `印刷` / `PDF出力` ボタンから `window.print()` を実行
   - PDF はブラウザの印刷ダイアログで「送信先: PDFに保存」を選ぶ（ブラウザ仕様）
4. 画面の `閉じる` で Charts に戻る

> 重要: 出力時の UI は “誤出力防止” を優先し、**患者情報を URL に載せない**（画面遷移 `state` 経由）方針を採用する。

## 3. 印刷レイアウト要件（A4/余白/ヘッダ）
- `@page size A4` とし、余白は上下左右 12〜14mm 程度を標準とする。
- ヘッダには最低限以下を含める:
  - 文書名（診療記録/外来サマリ）
  - 施設ID / 出力者（facilityId:userId）/ 出力日時 / RUN_ID
- 画面用のツールバー/警告バナーは印刷時に非表示（`@media print`）。

## 4. 監査ログ要件（誰が・いつ・何を）
- 出力に関する操作は `recordChartsAuditEvent` で記録する（現状は Web クライアント内の監査ログ）。
- 最低限含める情報:
  - **誰が**: `details.actor = facilityId:userId`
  - **いつ**: `timestamp`（ISO）
  - **何を**: `details.patientId` / `details.appointmentId` + `subject`
  - runId: `details.runId`
- 監査対象のイベント例:
  - `subject=outpatient-document-preview`: プレビューを開いた
  - `subject=outpatient-document-output`: 印刷/PDF 出力（開始、afterprint）
- 個人名などの過度な PHI を監査 payload に含めない（患者名は document 本文にのみ表示）。

## 5. 個人情報（画面/印刷）の注意喚起
- プレビューページ上部に `ToneBanner tone="warning"` を表示し、以下を明示する:
  - 画面共有や第三者の閲覧に注意
  - 印刷物・PDF は必要最小限、不要になったら施設規定に従い廃棄
- missingMaster / fallbackUsed の場合は “結果が残る操作” として出力をブロックし、再取得/解決の nextAction を提示する。

## 6. 証跡
- 実装ログ: `docs/web-client/planning/phase2/logs/20251217T233649Z-charts-print-export.md`

