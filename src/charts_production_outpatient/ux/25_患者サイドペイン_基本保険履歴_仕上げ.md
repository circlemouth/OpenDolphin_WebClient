# 25 患者サイドペイン（基本/保険/履歴）仕上げ（webclient charts production outpatient plan）

- RUN_ID: `20251217T114005Z`
- 期間: 2026-01-06 09:00 〜 2026-01-09 09:00 (JST) / 優先度: medium / 緊急度: low / エージェント: codex
- YAML ID: `src/charts_production_outpatient/ux/25_患者サイドペイン_基本保険履歴_仕上げ.md`

## 0. 目的とアウトカム
- 患者サイドペイン（左 30% 基準）の情報を **閲覧中心に再編** し、編集は権限と `missingMaster` で明確にガードする。
- 患者基本/保険の **差分表示（before/after）と保存監査ログへの導線** を UI に組み込み、保存結果を即確認できる状態にする。
- 過去受診/直近受診の導線を整理し、患者切替ミスを減らす（コンテキストを維持しつつ絞込・復帰を簡潔にする）。

## 1. 参照チェーン・インプット
- `AGENTS.md` → `docs/web-client/README.md` → `docs/server-modernization/phase2/INDEX.md` → `docs/managerdocs/PHASE2_WEB_CLIENT_EXPERIENCE_MANAGER_CHECKLIST.md` → `src/charts_production_outpatient/00_RUN_IDと参照チェーン.md`
- UX/ポリシー: `docs/web-client/ux/charts-claim-ui-policy.md`, `docs/web-client/ux/patients-admin-ui-policy.md`, `src/charts_production_outpatient/ux/20_ChartsシェルUI最終レイアウト.md`, `src/charts_production_outpatient/ux/22_ToneBannerと状態Pillの一貫性.md`
- 基盤: `src/charts_production_outpatient/foundation/10_セッションと権限ガード整理.md`, `11_監査ログauditEvent統一.md`, `12_エラーハンドリングとリトライ規約.md`, `14_パフォーマンス予算と計測導入.md`

## 2. 情報構造（閲覧中心の再配置）
- **重要情報ストリップ（左ペイン先頭 48px）**: 患者名・患者ID・受付ID・保険/自費モード・role を 1 行表示。クリックで「基本/保険」タブへスクロール。`runId`/`dataSourceTransition` ピルはトップバーと共通表示。
- **基本情報カード（閲覧モード既定）**: 氏名/カナ/生年月日/性別/住所/連絡先/担当医。権限が無い場合はロックアイコン＋ツールチップ（理由: role 不足 or missingMaster/fallback）。
- **保険・公費カード**: 現行契約と保険モード（保険/自費）を常時表示。`保険切替` ボタンは トグルと同期し、編集導線は Patients 画面へディープリンク。missingMaster=true なら disable＋理由表示。
- **履歴カード（過去受診/直近受診）**: タブ `直近3回` / `過去90日` / `全期間検索` を並列化し、受付ステータス＋保険モードをバッジ表示。現在開いている受付行はハイライトし、クリックで DocumentTimeline にフォーカス。
- **チェック項目ミラー**: ToneBanner の内容（missingMaster/fallback/dataSourceTransition）をサイドペイン上部にミラー表示（aria-live=off）。未紐付/エラーは CTA で該当タブへ。

## 3. 権限・ガード・編集導線
- **閲覧をデフォルト**: PatientsTab/サイドペインは常に閲覧モードで開く。編集ボタンは権限と `missingMaster=false & fallbackUsed=false & dataSourceTransition=server` を満たす場合のみ活性。
- **権限別の活性化** (foundation/10 に準拠):
  - 医師/看護師: 患者メモ編集のみ直接許可。基本/保険の編集は Patients 画面へ遷移（編集権限がある場合のみボタン活性）。
  - 受付/事務: 基本/保険編集ボタンを活性（権限ありの場合）。診療中はガードを外し、会計待ち以降は編集不可。
  - 権限不足/セッション不一致: ボタンは disable＋tooltip=`権限不足/セッション不整合`。クリック不能だが文言で理由を提示。
- **missingMaster/fallback ガード**: いずれか true なら全編集ボタン disable、CTA を「マスタ再取得」へ差し替え。解除時は `aria-live=polite` で 1 回だけ解除通知（22 のポリシー通り）。
- **編集導線**: 「基本を編集」「保険を編集」ボタンから Patients 画面へ deeplink。戻り時に `patientId/insuranceMode/runId` を carry-over しサイドペインへ復帰。

## 4. 差分表示と監査ログ導線
- **差分パネル**: サイドペイン下部に `変更前 / 変更後` を 2 カラムで表示。対象: 氏名/生年月日/住所/電話/保険種別/適用開始・終了日/公費。`oldValue` は直近保存時点、`newValue` は現在のドラフトまたは API 応答。
- **取得元**: 患者取得 API `/orca/patients/local-search` の応答から `updatedAt`/`updatedBy` を抽出し、直近保存値として使用。保存成功後は応答の値を `newValue` として即反映。
- **監査ログ表示**: foundation/11 の `auditEvent` を右上に「保存履歴」ボタンで開くモーダルへ列挙（action=PATIENT_UPDATE, operation=update/create/delete, outcome, runId, traceId, changedKeys）。最新 5 件を表示し、クリックで差分ハイライトにフォーカス。
- **エラー時**: 保存失敗は `ToneBanner error` + 差分パネル上部にエラーバッジを表示し、`auditEvent.outcome=ERROR` をモーダルにも反映。

## 5. 履歴・受診導線の整理（患者切替ミス防止）
- **選択状態の固定**: 現在開いている受付/患者を履歴リスト上で強調し、別患者をクリックすると確認ダイアログ（未保存チェック＋`CHARTS_PATIENT_SWITCH` audit）。
- **直近受診ショートカット**: `直近3回` タブは “診療科/担当医/保険モード” をピルで表示し、クリックで DocumentTimeline の該当エントリへジャンプ。ジャンプ時に `charts:patient_switch_start|ready` 計測（foundation/14）を送信。
- **全期間検索**: 日付/診療科/保険モードフィルタ＋検索を提供。結果の選択は常に新タブではなく同一サイドペインで切替。検索キーワードは URL には出さず、戻るボタンで直前のタブへ。
- **戻り導線**: Patients から戻る際は直前に開いていた履歴タブ・スクロール位置を復元。Reception へ戻るリンクは別配置（誤クリック防止）。

## 6. UI/ARIA/トーン連携
- ToneBanner とピルの表記は 22 のポリシーを踏襲（バナーのみ aria-live, ピルは off）。サイドペインのチェック項目ミラーは aria-live=off。
- 差分パネル更新・履歴ジャンプ・編集ガード切替は `aria-live=polite` で単発通知。missingMaster/fallback 発生時のみ assertive。
- クリック数削減: 重要情報ストリップ＋履歴ショートカットで “患者確認→履歴確認→差分確認” を 3 操作以内に収める。

## 7. テレメトリ・監査粒度（追加）
- telemetry: `recordOutpatientFunnel('charts_patient_sidepane', { action: 'view|diff|history_jump|deeplink', runId, patientIdHash, insuranceMode, manualRefresh, missingMaster, fallbackUsed, cacheHit, dataSourceTransition })` を追加。diff 表示と履歴ジャンプは action 別で送信。
- audit: サイドペイン経由の患者切替は `CHARTS_PATIENT_SWITCH` を必ず記録（既存処理に `origin=sidepane` を加える）。差分確認/履歴ジャンプ/Patients への deeplink は `logUiState` で action 別に残す。

## 8. 実装タスク（抜粋）
1. サイドペインレイアウト: `ImportantStrip`（20 の再利用）＋ 基本/保険/履歴カードを stack。情報行間を 12px、2 カラム差分は 40/60 で表示。
2. 権限・ガード: PatientsTab コンポーネントに role/missingMaster/fallback 判定と deeplink ボタンを追加し、編集系を disable/tooltip に統一。
3. 差分パネル: 患者取得/保存 API 応答をローカル state と比較し before/after を描画。`auditEvent` モーダルを共通部品化し Charts の保存ログを流用。
4. 履歴タブ: 直近/期間/全期間の 3 タブとフィルタ UI を追加し、DocumentTimeline へフォーカス移動する CTA を実装。計測イベントを foundation/14 に合わせて発火。
5. E2E 観点: missingMaster/fallback ガード時に編集ボタンが disable であること、差分パネルが最新保存値を反映すること、履歴ジャンプ時に患者切替 audit が 1 回だけ記録されることを Playwright へ追加。

## 9. リスク・未決事項
- 保険情報の差分取得 API は `/orca/patients/local-search/*` の応答項目（updatedBy/updatedAt/versions）依存。未提供なら暫定で保存応答を直近値として扱う。
- 履歴検索の API 負荷（全期間検索）に対するページング/キャッシュ戦略を foundation/13 `fetchWithResolver` へ取り込む必要あり。
- 差分と audit モーダルのデータ件数上限（最新 50 件など）を決め、パフォーマンス予算（14 章）を満たすか検証する。

## 10. 次アクション（RUN_ID=`20251217T114005Z`）
1. PatientsTab の閲覧モード化と権限/missingMaster ガード実装を着手（Playwright 追加含む）。
2. 差分パネル＋監査モーダルの UI プロトタイプを作成し、保存 API 応答サンプルを当て込み検証。
3. 履歴タブのフィルタ/CTA/計測イベントを実装し、`charts:patient_switch_start|ready` を計測ログで確認。

## 11. 実装結果（RUN_ID=`20251218T092541Z`）
- 実装: `web-client/src/features/charts/PatientsTab.tsx` を患者サイドペイン相当として再編（重要情報ストリップ + 基本/保険/履歴/差分カード）。
- 編集ガード:
  - `missingMaster` / `fallbackUsed` / `dataSourceTransition!==server` を満たす場合は **全編集導線を停止**（理由表示）。
  - role ガード（暫定）: `doctor|nurse` はメモ編集のみ可、`reception|system_admin` 系は Patients への基本/保険編集導線のみ可（会計待ち以降は不可）。
- 差分表示: `Patients` の取得結果（`/orca/patients/local-search`）をベースラインとして before/after を表示し、強調/解除・監査ログクリック→差分フォーカスを追加。
- 保存履歴: UI 側 `auditEventLog`（`getAuditEventLog()`）を最新5件表示するモーダル導線を追加（`changedKeys` があれば表示）。
- 履歴導線: `直近3回` / `過去90日` / `全期間検索` のタブを追加し、クリックで encounter context 更新 + `DocumentTimeline` へフォーカス移動。
- 証跡: `docs/web-client/planning/phase2/logs/20251218T092541Z-charts-patient-sidepane.md`

### 未完/今後
- 基本/保険の分離取得 API を整備し、差分ベースライン（`updatedAt/updatedBy`・版管理）の精度を高める。
- 監査ログの「サーバー永続履歴」表示（UI 側 in-memory ではなく）への統合を進める。
