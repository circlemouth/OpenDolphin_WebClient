# 52 監査ログ / テレメトリ 証跡化（webclient charts production outpatient plan）

- RUN_ID: `20251218T183545Z`
- 期間: 02/04 09:00 - 02/06 09:00（先行実施日: 2025-12-18）
- 優先度: high / 緊急度: low / エージェント: codex
- YAML ID: `src/charts_production_outpatient/quality/52_監査ログ_テレメトリ_証跡化.md`
- 参照チェーン: `AGENTS.md` → `docs/web-client/README.md` → `docs/server-modernization/phase2/INDEX.md` → `docs/managerdocs/PHASE2_WEB_CLIENT_EXPERIENCE_MANAGER_CHECKLIST.md` → `src/charts_production_outpatient/00_RUN_IDと参照チェーン.md` → 本書
- 証跡ログ: `docs/server-modernization/phase2/operations/logs/20251218T183545Z-charts-audit-telemetry.md`
- 計画ログ: `docs/web-client/planning/phase2/logs/20251218T183545Z-charts-audit-telemetry.md`
- テスト: `web-client/src/features/charts/__tests__/auditTelemetryRunId.test.ts`

## 0. ゴール
- 主要操作（本 RUN では ORCA_SEND）で `auditEvent` と telemetry (`recordOutpatientFunnel`) が **同一 runId/traceId** と dataSource メタ（cacheHit/missingMaster/fallbackUsed/dataSourceTransition）を共有することを証跡で示す。
- runId を鍵に監査と計測を横断追跡できることを、ログ（operations）と自動テストで保証する。

## 1. 実施内容
- Observability meta を `runId=20251218T183545Z / traceId=trace-52-run / dataSourceTransition=server` へ固定し、telemetry と auditEvent を連続発火する vitest を追加。
- `npm test -- src/features/charts/__tests__/auditTelemetryRunId.test.ts` を実行し、console 出力で両者が同一 runId/traceId で記録されることを確認。
- 証跡ログへ telemetry/audit の出力抜粋（recordedAt, timestamp, dataSourceTransition 等）を転記。

## 2. DoD
- [x] telemetry と auditEvent の runId が一致し、traceId も同期していることをテストで証明。
- [x] dataSourceTransition/cacheHit/missingMaster/fallbackUsed が両イベントで同値であることを確認。
- [x] 証跡ログ（operations）と DOC_STATUS の備考に RUN_ID / ログパスを追記。
- [x] ハブ文書（README）へ本ドキュメントリンクを追加。

## 3. 次のステップ
- ENCOUNTER_CLOSE / PRINT_OUTPATIENT / CHARTS_ACTION_FAILURE について同一テストパターンを追加し、複数操作で runId/traceId 整合を自動検証する。
- telemetry funnel の stage 別粒度（charts_orchestration / charts_patient_sidepane など）も runId で突合できるよう、既存テストへ拡張する。

## 4. 参照・補足
- 監査ログ設計: `src/charts_production_outpatient/foundation/11_監査ログauditEvent統一.md`
- fetch/観測メタ同期: `src/charts_production_outpatient/foundation/13_データ取得レイヤの統一_fetchWithResolver.md`
- パフォーマンス計測 & telemetry: `src/charts_production_outpatient/foundation/14_パフォーマンス予算と計測導入.md`
