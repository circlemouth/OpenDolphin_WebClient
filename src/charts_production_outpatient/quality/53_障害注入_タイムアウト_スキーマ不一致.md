# 53 障害注入（タイムアウト/500/スキーマ不一致/キュー滞留）（RUN_ID=`20251218T171651Z`）

## ゴール
- Charts が「落ちない（白画面にならない / 例外で停止しない）」こと。
- 失敗の種類（timeout/500/schema mismatch/queue stall）を UI 上で説明できること（文言・nextAction・runId/traceId）。
- 復旧後に UI が正常復帰できること（再取得、状態の解消、ドラフト保持）。
- 失敗の証跡（HAR/スクショ/runId/traceId）を artifacts とログへ保存できること。

## 対象（MSW で再現）
- `/api01rv2/appointment/outpatient/*`（一覧）
- `/api01rv2/claim/outpatient/*`（請求/キュー）
- `/orca21/medicalmodv2/outpatient`（外来医療記録）
- `/api/orca/queue`（ORCA キュー状態）

## 障害注入の仕組み
- MSW 有効時に `x-msw-fault` / `x-msw-delay-ms` を全 API リクエストに付与し、ハンドラ側で故障を注入します。
- UI からは `/outpatient-mock` の **障害注入（MSW）** で設定できます（localStorage に保存）。

### `x-msw-fault` の値
- `timeout` : 504 を返す（必要なら `x-msw-delay-ms` で遅延も付与）
- `http-500` : 500 を返す
- `schema-mismatch` : 200 を返すが `apiResult=ERROR_SCHEMA_MISMATCH` + 型不一致 payload を返す
- `queue-stall` : `/api/orca/queue` に「滞留」するエントリを混ぜる（lastDispatchAt が 5 分超過）

## 手順（手動検証）
### 0) 前提
- 起動: `WEB_CLIENT_MODE=npm ./setup-modernized-env.sh`（ログイン情報は `setup-modernized-env.sh` 記載を使用）
- MSW を使う場合は `VITE_DISABLE_MSW=0`（`VITE_DISABLE_MSW=1` だと障害注入 UI は無効化されます）
- 事故防止のため、障害注入ヘッダーは **`?msw=1` のページでのみ送出** されます（例: `/outpatient-mock?msw=1`, `/charts?msw=1`）。

### 1) 障害注入 ON
1. ブラウザで `/outpatient-mock?msw=1` を開く
2. **障害注入（MSW）** を `timeout` / `http-500` / `schema-mismatch` / `queue-stall` に設定
3. そのまま `/charts?msw=1` を開く

### 2) 期待結果（落ちずに説明できる）
共通:
- 上部/カードが表示され続け、画面が白くならない
- `runId`/`traceId` が UI / 監査ログ / HAR に残る

`timeout` / `http-500` / `schema-mismatch`:
- DocumentTimeline に「請求バンドルの取得に失敗しました」が表示され、**請求バンドルを再取得** ボタンが出る
- MedicalRecordPanel に「外来医療記録の取得に失敗しました」が表示され、再取得導線が説明できる

`queue-stall`:
- DocumentTimeline の該当患者に **滞留** バッジが表示され、nextAction が「送信が滞留…」系になる

### 3) 障害注入 OFF → 復帰確認
1. `/outpatient-mock` で **障害注入を解除**
2. `/charts` に戻って以下を実行
   - DocumentTimeline の **請求バンドルを再取得**
   - OrcaSummary の **再取得**（表示されている場合）
3. エラー表示が解消し、通常表示へ復帰することを確認

### 4) ドラフト保持（復帰後）
- 患者サイドペイン等で入力を行い、未保存ドラフト状態を作る
- `timeout` / `http-500` 等を注入した状態でも UI が落ちず、解除→再取得後もドラフトが保持されることを確認

## 証跡
- 作業ログ: `docs/web-client/planning/phase2/logs/20251218T171651Z-charts-fault-injection.md`
- Playwright 生成物（HAR/スクショ）: `artifacts/webclient/e2e/<RUN_ID>/msw-on/`
  - `har/*.har`
  - `screenshots/*.png`
