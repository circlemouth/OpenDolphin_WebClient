# 30 外来受診コンテキスト確立（受付ID/診療日/患者）

- RUN_ID: `20251218T082404Z`
- 期間: 2026-01-02 09:00 〜 2026-01-04 09:00 (JST) / 優先度: high / 緊急度: low / エージェント: codex
- YAML ID: `src/charts_production_outpatient/workflow/30_外来受診コンテキスト確立.md`
- 参照: [01 外来機能の完全カバレッジ定義](../01_外来機能の完全カバレッジ定義.md)（RUN_ID=`20251212T131901Z`）、[02 ChartsPage現状棚卸しとギャップ](../02_ChartsPage現状棚卸しとギャップ.md)（RUN_ID=`20251212T140014Z`）、[10 セッションと権限ガード整理](../foundation/10_セッションと権限ガード整理.md)（RUN_ID=`20251213T000432Z`）、[31 診療開始終了の状態遷移](./31_診療開始終了の状態遷移.md)（RUN_ID=`20251217T120220Z`）
- 証跡ログ: `docs/web-client/planning/phase2/logs/20251218T082404Z-charts-encounter-context.md`

---

## 0. 結論（今回の実装）
- **Reception→Charts の遷移で、外来コンテキスト（`patientId` / `receptionId` / `visitDate`）を URL クエリへ格納**し、リロード/複数タブ/復元で壊れないようにした。
- **Charts 側は URL → sessionStorage（タブ単位）→ location.state の順で復元**し、いずれも無い場合は外来リスト先頭を自動選択して URL を `replace` で正規化する。
- **別患者混入防止のクリティカルガード**として、未保存ドラフトまたは処理中（UI ロック）状態では URL 由来の患者切替（戻る/進む）をブロックし、URL を現在のコンテキストへ戻す。
- 「今どこ？」を迷わせないため、**DocumentTimeline を `受付→診療→会計` の 3 ステップに統一**し、ActionBar には「患者/受付ID/診療日/現在ステータス」を常時表示する。

## 1. 目的とスコープ
- 目的: 受付画面からカルテ画面へ遷移したときに、**来院（受付ID）コンテキストが必ず引き継がれ**、かつブラウザ操作（更新/戻る/複数タブ）でも **別患者の情報が混ざらない**こと。
- スコープ: Charts（web-client）における「選択患者/来院コンテキスト」の状態管理。ORCA 実送信・サーバー側の状態管理は対象外。

## 2. コンテキストモデル（URL パラメータ）
- Charts の URL クエリを以下に固定する。
  - `patientId`: 患者ID（例: `000123`）
  - `appointmentId`: 予約ID（任意、予約由来の選択に使用）
  - `receptionId`: 受付ID（来院コンテキスト、可能なら最優先）
  - `visitDate`: 診療日（`YYYY-MM-DD`）
- これにより「URL だけで復元できる」前提が成立し、他タブ/復元で state が消えても破綻しない。

## 3. 選択解決の優先順位（混入防止）
1. `receptionId` があれば **同一受付ID** を最優先で選択する（同一患者の複数来院/予約が混ざる事故を避ける）。
2. 次に `appointmentId`（予約ベース）
3. 最後に `patientId`
4. いずれも指定が無い場合は、外来リスト先頭を選択し、URL を正規化する。

## 4. クリティカルガード（戻る/進む・複数タブ）
- URL のコンテキストが変化しても、以下のときは **自動切替をしない**:
  - `draftDirty=true`（未保存入力あり）
  - UI ロック中（送信/印刷など進行中）
- ブロック時は「別患者混入防止」の警告を出し、URL を現在のコンテキストへ `replace` で戻す。

## 5. UI での「今どこ？」表示
- DocumentTimeline: `受付→診療→会計` の 3 ステップで進捗を表示し、`会計` は missingMaster/キュー失敗時に `blocked` として明示。
- ActionBar: 「患者/受付ID/診療日/現在ステータス」をピルで常時表示し、現場の視認性を確保する。

## 6. 実装箇所（要点）
- `web-client/src/features/reception/pages/ReceptionPage.tsx`：Charts への遷移 URL を `buildChartsUrl(...)` で生成し、`receptionId/visitDate` を渡す。
- `web-client/src/features/charts/pages/ChartsPage.tsx`：URL/セッション/ state の復元、URL 正規化、ブロックガード。
- `web-client/src/features/charts/encounterContext.ts`：parse/build/store の単一ソース。
- `web-client/src/features/charts/DocumentTimeline.tsx`：3 ステップ表示 + `selectedReceptionId` 対応。
- `web-client/src/features/charts/PatientsTab.tsx`：患者切替を「受付ID優先」の encounter 単位にし、ロック中は切替不可。

---

## 7. 証跡・同期
- 証跡ログ: `docs/web-client/planning/phase2/logs/20251218T082404Z-charts-encounter-context.md`
- DOC_STATUS / Web Client Hub（README）の該当行へ RUN_ID と証跡リンクを追記する。

