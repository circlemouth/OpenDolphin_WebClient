# 31 診療開始終了の状態遷移（webclient charts production outpatient plan）

- RUN_ID: `20251217T120220Z`（親: `20251217T114331Z`）
- 期間: 2026-01-06 09:00 〜 2026-01-09 09:00 (JST) / 優先度: high / 緊急度: low / エージェント: claude code
- YAML ID: `src/charts_production_outpatient/workflow/31_診療開始終了の状態遷移.md`
- 参照: [01 外来機能の完全カバレッジ定義](../01_外来機能の完全カバレッジ定義.md)（RUN_ID=`20251212T131901Z`）、[03 モダナイズ外来 API 契約テーブル確定](../03_モダナイズ外来API契約テーブル確定.md)（RUN_ID=`20251212T143720Z`）、[11 監査ログauditEvent統一](../foundation/11_監査ログauditEvent統一.md)（RUN_ID=`20251213T125127Z`）、[12 エラーハンドリングとリトライ規約](../foundation/12_エラーハンドリングとリトライ規約.md)（RUN_ID=`20251217T125828Z`）、[22 ToneBannerと状態Pillの一貫性](../ux/22_ToneBannerと状態Pillの一貫性.md)（RUN_ID=`20251217T063116Z`）
- 証跡ログ: `docs/web-client/planning/phase2/logs/20251217T114331Z-charts-encounter-state.md`

---

## 0. 結論（今回決めたこと）
- 診療状態を **6 つの主状態 + フラグ** に整理し、UI（ヘッダー Pill / Timeline / ActionBar）と監査を同じ値で描画する: `OPEN`（診療中）、`READY_TO_CLOSE`（送信完了・未保存なし・終了可能）、`DIRTY`（未保存ドラフトあり）、`QUEUE_PENDING`（ORCA送信未完了）、`CLOSING`（終了処理中）、`CLOSED`（完了）/`ABORTED`（中止）。`DIRTY` と `QUEUE_PENDING` は終了禁止フラグとして OPEN/READY_TO_CLOSE に重畳する。
- 診療終了ボタンは **4 つのブロック理由を判定** してから有効化する: (1) `missingMaster=true` or `fallbackUsed=true`、(2) 未保存ドラフト（dirty=true）、(3) ORCA 送信キューに `pending|error|retryable` が存在、(4) セッション無効/患者コンテキスト欠損。ブロック時は ActionBar ボタンを disable＋理由ツールチップ、ToneBanner に「終了できません」文言を出す。
- 状態遷移のソースオブトゥルースは **サーバー応答の `encounterState` + `auditEvent`**。終了リクエスト送信後も UI 側で勝手に CLOSED にしない。`CLOSING` → `CLOSED/ABORTED` は **サーバー確定レスポンス** または **再取得で確認** できたときのみ遷移させる。
- 通信断/タイムアウト時は **ローカルを OPEN に巻き戻しつつ「終了失敗」バナーを表示**。同じ `closeRequestId`（runId 由来の idempotency key）で再試行する。Timeline には `ENCOUNTER_CLOSE` の `outcome=ERROR` を一時表示し、成功後に `SUCCESS` で上書きする。
- Timeline/Banner/Pill の整合: ヘッダー Pill に `encounterState`、DocumentTimeline に `ENCOUNTER_STATE` 行（open/close/abort/rollback）を追加し、ActionBar の disable 理由を同じ値から描画する。aria-live は ToneBanner 優先（assertive）、Pill は `aria-live=off`。

## 1. 状態モデル（主状態とブロックフラグ）
| 状態/フラグ | 意味 | UI 表示 | 監査 (action/outcome) | 遷移元→先 | 非同期エラー時の扱い |
| --- | --- | --- | --- | --- | --- |
| OPEN | 診療中/編集中。デフォルト状態。 | ヘッダー Pill=`診療中`(info)、Timeline に最新行 `ENCOUNTER_STATE=OPEN`。 | `ENCOUNTER_CLOSE` 未送信。 | Reception→Charts でセット。 | 取得エラーは `tone=error` を表示するだけで状態は OPEN のまま。 |
| READY_TO_CLOSE | 未保存なし・送信待ちなしで終了可能。 | Pill=`終了可能`(success, subtle)、ToneBanner info（polite）で「終了できます」を 1 回だけ表示。 | 直前のドラフト保存/送信完了で自動遷移。 | OPEN → READY_TO_CLOSE（DIRTY=false かつ QUEUE_PENDING=false を検知）。 | 再取得で DIRTY/QUEUE_PENDING が復活したら OPEN に戻す。 |
| DIRTY (flag) | 未保存ドラフトが存在。 | ActionBar の終了ボタン disable（tooltip=`未保存ドラフトがあります`）、左ペインチェック項目にバッジ表示。 | `DRAFT_SAVE` 成否を audit に記録、状態は OPEN に重畳。 | ドラフト編集/差分検知で付与、保存成功で解除。 | 通信断時は flag を維持し、再同期後にサーバー保存成否で解除。 |
| QUEUE_PENDING (flag) | ORCA送信キューに pending/resend/error がある。 | ActionBar 終了ボタン disable（tooltip=`ORCA送信待ちがあります`）、ToneBanner warning。 | `ORCA_SEND/RESEND` の outcome が success になるまで flag を残す。 | 送信リクエスト後に付与、全件 success で解除。 | キュー確認 API が失敗したら flag を維持し、再取得 CTA を出す。 |
| CLOSING | 診療終了リクエスト送信済み、サーバー確定待ち。 | ヘッダー Pill=`終了処理中`(warning)、ActionBar 全ボタン aria-disabled + スピナー、ToneBanner warning (`aria-live=assertive`)。 | `ENCOUNTER_CLOSE` outcome=started。 | OPEN かつ flag が無い状態でボタン押下。 | タイムアウト時は `closeRequestId` を保持し、状態を OPEN へ戻す + `outcome=error` を audit に追加。 |
| CLOSED | 診療終了（完了）。 | Pill=`診療終了`(success)、Timeline に `ENCOUNTER_STATE=CLOSED` 行、ActionBar の送信/終了系を非表示。 | `ENCOUNTER_CLOSE` outcome=success。 | CLOSING → サーバー応答 success、または再取得で `state=closed` を確認。 | 状態は保持。再開は許可しない（新しい runId が必要）。 |
| ABORTED | 診療終了（中止）: 途中でキャンセル/ロールバック。 | Pill=`終了を中止`(warning)、Timeline 行に reason を表示、ActionBar は OPEN と同じ構造で戻す。 | `ENCOUNTER_CLOSE` outcome=blocked or cancelled。 | CLOSING → ユーザー取消 or サーバーから abort 応答。 | 通信断時は OPEN に戻し、abort か未完かを再取得で判定。 |

補足: `DIRTY`/`QUEUE_PENDING` は単独状態ではなく **終了禁止フラグ**。UI/監査では `ENCOUNTER_CLOSE` を出さず、ActionBar がブロックしたことを `outcome=blocked` で記録する。

## 2. イベント別の遷移と UI/ARIA
- **診療開始（Charts Open）**: Reception から遷移時に `encounterState=OPEN` をセットし、Timeline へ `ENCOUNTER_STATE=OPEN` 行（info, polite）を追加。`CHARTS_OPEN` audit を発火。
- **ドラフト編集/保存**:
  - 編集検知で `DIRTY=true`。ヘッダー Pill は変えず、ActionBar 終了/送信/印刷を disable。ToneBanner は出さず、左ペイン「未保存ドラフトあり」チェック項目で通知（aria-live=off）。
  - 保存成功で `DIRTY=false`。保存失敗は ToneBanner error（assertive）＋再取得 CTA、state は OPEN 維持。
- **ORCA送信**:
  - 送信開始で `QUEUE_PENDING=true`。ToneBanner warning（assertive）を表示し、終了/印刷を disable。キュー再取得タイマーを開始（初回 5s、以降指数 5s→15s→45s、最大 3 回）し、失敗時は「再取得」CTA を表示。
  - 送信完了 success で `QUEUE_PENDING=false`、Timeline に送信結果行を追加。失敗/再送待ちは flag 維持。キュー再取得成功で `pending=0` を確認した時点で READY_TO_CLOSE へ自動遷移し、info バナーを 1 回だけ鳴らす（polite）。
- **診療終了ボタンクリック**:
  1) `missingMaster || fallbackUsed || DIRTY || QUEUE_PENDING || sessionInvalid` が真なら **リクエストを送らず** modal/tooltip で理由を列挙。`logUiState(action='ENCOUNTER_CLOSE', outcome='blocked', reason=<flags>)` を記録。aria-live=assertive の ToneBanner「終了できません」を表示。
  2) 上記が全て false のときのみ `CLOSING` に遷移し、`closeRequestId` を `runId` 由来で発行。ActionBar 全体をロックし、ToneBanner warning（assertive）、Pill=`終了処理中`。`auditEvent ENCOUNTER_CLOSE outcome=started` を送信。
- **終了応答 success**: サーバー応答の `encounterState=closed` または `auditEvent ENCOUNTER_CLOSE outcome=success` を受けて `CLOSED` へ遷移。Timeline に `ENCOUNTER_STATE=CLOSED` 行を success（polite）で挿入し、ActionBar の送信系ボタンを非表示。
- **終了応答 abort/cancel**: サーバーが `state=aborted` を返した場合や UI で「終了を中止」を選択した場合、`ABORTED` へ遷移。Timeline に warning 行、ActionBar は OPEN 相当へ戻す。
- **終了応答 error/timeout**: `CLOSING` → `OPEN` に巻き戻し、ToneBanner error（assertive）＋再取得ボタン、Timeline に `ENCOUNTER_CLOSE outcome=ERROR` を一時表示。`closeRequestId` を保持して同じリクエストを再送可能にする。

## 3. UI 表示の同期（Timeline / Pill / Badge）
- **ヘッダー StatusBadge 順**: `runId` → `dataSourceTransition` → `missingMaster` → `fallbackUsed` → `cacheHit` → `encounterState`。`encounterState` pill は以下マッピング: OPEN=info、READY_TO_CLOSE=success（subtle）、DIRTY/QUEUE_PENDING=warning（小型サブテキスト付き）、CLOSING=warning+spinner、CLOSED=success、ABORTED=warning。aria-live は off（22 章に従う）。
- **DocumentTimeline**: 新しいイベントタイプ `ENCOUNTER_STATE` を追加し、`state` (`open|closing|closed|aborted|rollback`) と `reason` を表示。`outcome=ERROR` は赤（assertive）、成功は info/success（polite）。`ENCOUNTER_CLOSE` 監査イベントを同じ行に表示して乖離を防止。
- **ActionBar ボタン活性条件**:
  - 終了ボタン enable 条件: `state=OPEN` かつ `DIRTY=false` かつ `QUEUE_PENDING=false` かつ `missingMaster=false` かつ `fallbackUsed=false` かつ `sessionValid=true`。
  - 送信/印刷も上記に `CLOSED/ABORTED` でないことを追加。
  - disable 時は tooltip で理由、`data-disabled-reason` を audit と同じ値で保持。
- **左ペイン「今日のチェック項目」**: 未保存ドラフト/送信待ち/通信再取得待ちを一覧表示。aria-live=off、リンクで該当タブへスクロール。

## 4. ブロック理由別の抑止と復旧導線
- **未保存ドラフト (DIRTY)**: 終了ボタンを押下すると「未保存ドラフトがあります。保存してから終了してください」ダイアログ。CTA=「下書きを保存」「破棄して終了（危険）」の2択。危険操作は confirm checkbox 付き。
- **ORCA送信未完了 (QUEUE_PENDING)**: 「ORCA送信が完了していません。キューを確認してから終了してください」ToneBanner + 「キューを再取得」「送信を中止」ボタン。再取得は 5s→15s→45s バックオフで最大 3 回自動実行し、全失敗時のみ CTA を残す。中止を選ぶと `ABORTED` へ遷移し、audit に outcome=blocked, reason=queue_pending を記録。
- **missingMaster / fallbackUsed**: 12 章のガードに従い終了ボタンを disable。解除条件（missingMaster=false && fallbackUsed=false && dataSourceTransition=server）を検知したら info バナーで「終了可能になりました」（polite）を 1 回だけ鳴らす。
- **セッション無効/患者コンテキスト欠損**: 10 章フローに委譲し全画面 ErrorBoundary でブロック。終了ボタンは表示しない。

## 5. 例外・復元戦略（通信断/タイムアウト含む）
- **idempotency**: `closeRequestId = runId + "-close" + isoTimestamp` を ActionBar で生成し、UI/Audit/Timeline に同一値を表示。サーバー応答が不明のときは同じ id で再送し、重複閉鎖を防ぐ。
- **ロールバック方針**: `CLOSING` 中に network error/timeout が発生したらローカル状態を OPEN + `rollback=true` に戻す。Timeline へ `ENCOUNTER_STATE=rollback`（warning）行を追加。再取得成功後に `state=closed` が確認できた場合は自動で CLOSED へ昇格し、rollback 行を success で上書き。
- **再取得ソース**: `fetchOrcaOutpatientSummary` を再実行し、`encounterState` とキュー状態を取得して UI を復元する。成功したら ToneBanner を消し、Pill をサーバー値に合わせる。キュー確認 API も同じ backoff（5s/15s/45s, max3）で再試行し、総失敗時は `queue_refresh_failed=true` を Pill tooltip に表示。
- **ローカルキャッシュの扱い**: React Query キャッシュには `encounterState` と `closeRequestId` を保持。画面再読み込み時はキャッシュ優先（stale-while-revalidate）で UI を即時復元しつつサーバーを再取得。`staleTime=0` にして必ず確認する。

## 6. 実装/テストタスク（抜粋）
1. `web-client/src/features/charts/context/EncounterStateContext.ts`（仮）を追加し、`encounterState` と `closeRequestId` を単一ソース管理。ActionBar/ToneBanner/Timeline がここから値を読むよう統一。
2. ActionBar に終了ボタンのブロック理由判定を実装（DIRTY/QUEUE_PENDING/missingMaster/fallbackUsed/session invalid）。`data-disabled-reason` と tooltip を同じ文字列で出力し、ARIA は `aria-disabled`。
3. DocumentTimeline に `ENCOUNTER_STATE` イベント type を追加し、`state/reason/outcome/timestamp/closeRequestId/runId` を表示。Playwright で `state` ごとの行が追加されることを確認。
4. Telemetry/Audit: `recordChartsAuditEvent` を拡張し、`ENCOUNTER_CLOSE` の `outcome=started|success|error|blocked` に `closeRequestId` を含める。UI の disable 判定時も `blocked` を送信する。
5. MSW/Playwright フィクスチャ: 正常終了、未保存ブロック、送信未完ブロック、timeout→再取得で復元、abort の 5 ケースを追加。ToneBanner が1回のみ読み上げ、Pill は無言であることを assertion。

## 7. 証跡・同期
- 証跡ログ: `docs/web-client/planning/phase2/logs/20251217T114331Z-charts-encounter-state.md`
- DOC_STATUS: RUN_ID と本ドキュメント/ログを追加する。
- README: 最新更新サマリと Active リストへ追加する。
