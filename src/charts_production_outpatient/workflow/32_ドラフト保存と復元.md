# 32 ドラフト保存と復元（webclient charts production outpatient plan）

- RUN_ID: `20251217T212600Z`
- 期間: 2026-01-09 09:00 〜 2026-01-12 09:00 (JST) / 優先度: medium / 緊急度: low / エージェント: codex
- YAML ID: `src/charts_production_outpatient/workflow/32_ドラフト保存と復元.md`
- 参照: [01 外来機能の完全カバレッジ定義](../01_外来機能の完全カバレッジ定義.md)（RUN_ID=`20251212T131901Z`）、[03 モダナイズ外来API契約テーブル確定](../03_モダナイズ外来API契約テーブル確定.md)（RUN_ID=`20251212T143720Z`）、[10 セッションと権限ガード整理](../foundation/10_セッションと権限ガード整理.md)（RUN_ID=`20251213T000432Z`）、[11 監査ログauditEvent統一](../foundation/11_監査ログauditEvent統一.md)（RUN_ID=`20251213T125127Z`）、[12 エラーハンドリングとリトライ規約](../foundation/12_エラーハンドリングとリトライ規約.md)（RUN_ID=`20251217T125828Z`）、[13 データ取得レイヤの統一_fetchWithResolver](../foundation/13_データ取得レイヤの統一_fetchWithResolver.md)（RUN_ID=`20251213T133932Z`）、[31 診療開始終了の状態遷移](./31_診療開始終了の状態遷移.md)（RUN_ID=`20251217T120220Z`）
- 証跡ログ: `docs/web-client/planning/phase2/logs/20251217T212600Z-charts-draft-save.md`

---

## 0. 結論（今回決めたこと）
- **ドラフトの単位を受付ID + 患者ID + 診療日 + runId + facilityId + userId で厳密に束縛**し、一致しない限り自動復元しない。URL パラメータや patientContext が変わった場合はサイレント破棄（通知のみ）とする。
- 保存媒体は **localStorage（キー: `charts:draft:<facilityId>:<userId>:<runId>:<patientId>:<receptionId>:<encounterDate>`）を一次、React Query キャッシュを二次**とし、両方に `contentHash/updatedAt/version` を持たせてクラッシュ復元と二重保存防止を行う。
- **ドラフト状態フラグ `DIRTY` を encounter 状態モデル（31章）のフラグとして継承**し、保存成功時に解除・復元適用時に付与。ActionBar の終了/送信/印刷は `DIRTY` を理由に disable される。
- 監査ログを **`DRAFT_SAVE` / `DRAFT_RESTORE` / `DRAFT_DISCARD`** に統一し、details に `draftKey`（上記キー）、`contentHash`、`source=autosave|manual|restorePrompt|sessionInvalidated` を必ず含める。復元/破棄も outcome と理由を残す。
- UI フロー: (1) 編集検知で autosave 30s ごと＋blur 時に localStorage へ保存、(2) 画面初期化で一致キーのドラフトを検知し、差分をダイアログで提示→「復元」「破棄」「あとで」選択、(3) セッション無効/runId 変化/患者変更で即時破棄＋通知、(4) 復元後は `DIRTY=true` のまま明示保存を促す ToneBanner（polite）。
- 失敗ハンドリング: localStorage 書き込み失敗/容量不足は ToneBanner warning＋`DRAFT_SAVE outcome=error reason=quota` を audit。autosave エラー時は 60s バックオフ、手動保存は try-catch で即時エラー表示。

## 1. 対象と適用範囲
- スコープ: ChartsPage の **所見/メモ/チェック項目/処方/オーダー入力**（モダナイズ外来 API で送信対象となるフィールド）の送信前入力。患者基本情報・保険情報は対象外（患者管理タブで扱うため）。
- 適用条件: `patientContext` が有効で `encounterState` が `OPEN|READY_TO_CLOSE` のときのみ。`CLOSING|CLOSED|ABORTED` ではドラフト UI を非表示にし、既存ドラフトはロードしない。
- 環境: WEB_CLIENT_MODE=npm でのモダナイズ版サーバー接続（MSW ON/OFF いずれも）。Legacy サーバー経路への保存は行わない。

## 2. 保存モデルとキー設計
- **draftKey**: `charts:draft:<facilityId>:<userId>:<runId>:<patientId>:<receptionId>:<encounterDate>`。
  - `encounterDate` は `YYYY-MM-DD`、`receptionId` は当日日付で一意、`runId` は Charts セッション生成時の値（10章参照）。
  - runId が変わった場合は新規キーを使い、旧キーを掃除する（10章のセッション切替フックで実行）。
- **payload**: `{ version: 1, updatedAt: isoString, contentHash: sha256(content), content, dirty: true, dataSourceTransition, missingMaster, fallbackUsed }`。
  - `content` はモジュール化されたフォーム値（所見/メモ/チェック/オーダー等をフィールド名で保持）。
  - `contentHash` で差分判定し、同一ハッシュなら保存をスキップして audit を送らない。
- **保存トリガー**: 手動「下書きを保存」ボタン、autosave（最後の変更から 30s）、入力フィールド blur、ページ unload（`beforeunload`）。autosave は 30s → 60s → 120s バックオフ（最大 3）でエラー時に間隔を伸ばす。

## 3. 復元フローとガード
1) **検知**: Charts 初期表示または患者切替後、draftKey が一致するレコードを localStorage から取得。
2) **適合判定**: 以下の全一致でのみ復元候補とする。未一致なら `DRAFT_DISCARD outcome=blocked reason=scope_mismatch` を記録し破棄。
   - facilityId / userId / runId / patientId / receptionId / encounterDate
   - `missingMaster=false` かつ `fallbackUsed=false`（12章に従い信頼できないデータは復元しない）
3) **コンフリクト確認**: サーバーの最新 `documentRevision`（`03` の契約テーブルで定義）または `updatedAt` と比較し、ドラフトの方が古い場合は差分ダイアログを表示。選択肢: 「ドラフトを適用」「サーバー版を保持」「マージ（フィールド単位選択）」
4) **適用**: 選択後、フォームへ反映し `DIRTY=true` をセット。ToneBanner (polite) で「ドラフトを適用しました。保存してください」を 1 回だけ表示。
5) **破棄**: ユーザーが「破棄」または scope mismatch/セッション無効時は draftKey を削除し、`DRAFT_DISCARD outcome=success` を audit。

## 4. UI/UX の具体
- **ActionBar**: 「下書きを保存」ボタンを常設（CLOSED/ABORTED 以外）。`DIRTY=false` かつ差分なしなら disable し tooltip=`保存済み`。保存成功時は 3 秒間 success toast を表示（polite）。
- **復元ダイアログ**: 初回ロード時にモーダルで表示。内容: 更新日時、差分（最大 5 フィールドをハイライト）、適用/破棄/あとで。キーボード: Enter=適用、Esc=あとで。aria-live=off（モーダルラベル aria-labelledby を設定）。
- **ToneBanner**: 復元後と保存失敗のみ表示。復元成功=info polite、保存失敗=error assertive、容量警告=warning assertive。
- **左ペインチェック項目**: `DIRTY=true` のとき「未保存ドラフトあり」バッジ、`autosaveError=true` のとき「下書き保存に失敗」バッジを表示。aria-live=off。
- **キーボードショートカット**: `Ctrl/Cmd+S` をドラフト保存に割り当て（送信とは別）。送信ボタンは `Ctrl/Cmd+Enter` を維持。

## 5. 監査ログ / テレメトリ
- `action` / `outcome` / `details` を 11 章の規約に合わせて送信。
  - `DRAFT_SAVE` with outcome=`success|error|blocked`, details `{ draftKey, contentHash, source, durationMs?, error? }`
  - `DRAFT_RESTORE` with outcome=`success|error|blocked`, details `{ draftKey, contentHash, source=restorePrompt, reason? }`
  - `DRAFT_DISCARD` with outcome=`success|blocked`, details `{ draftKey, source=scopeMismatch|userDiscard|sessionInvalidated }`
- `source=autosave` の場合でも outcome を必ず送信し、DocumentTimeline の `ENCOUNTER_STATE` 行とは別に `DRAFT_SAVE` 行を info で追加。エラー時は warning/assertive。
- Telemetry: `charts_draft_save_ms`, `charts_draft_restore_ms`, `charts_draft_quota_error` を追加し、P95 アラートを 14 章の予算に連動させる。

## 6. 失敗・例外時の扱い
- **localStorage 容量不足/Blocked**: 保存を停止し、ToneBanner warning + `DRAFT_SAVE outcome=error reason=quota|blocked`。`autosave` は 60s バックオフ、手動保存は即時リトライ可能。
- **スキーマ不整合**: `version` が未知、または JSON parse 失敗時は破棄して `DRAFT_DISCARD reason=invalid_schema` を記録。ユーザーへ「古いドラフトを破棄しました」通知（assertive）。
- **セッション無効/施設不一致**: 10 章のガードで検知した時点で draftKey を削除し、復元ダイアログを出さずにログアウト誘導。audit に `source=sessionInvalidated` を残す。
- **オフライン**: オフライン時も localStorage へ保存は続行。送信・終了は disable。オンライン復帰後に autosave を 1 回走らせて同期し、成功したら DIRTY を解除。

## 7. 実装タスク（抜粋）
1. `web-client/src/features/charts/draft/useDraftStore.ts`（仮）を追加し、draftKey 生成・autosave・復元判定・audit 送信をカプセル化。React Query と localStorage を同一 API で扱う。
2. `ChartsActionBar` に「下書きを保存」ボタンと `Ctrl/Cmd+S` を追加し、`DIRTY`／`encounterState` フラグに従って disable/tooltip を表示。`recordChartsAuditEvent` を利用。
3. 初期レンダリングで復元ダイアログを出すフックを `ChartsPage` に追加し、コンフリクト比較のための `documentRevision` 取得を fetch レイヤ（13章）に追加。
4. ToneBanner/左ペインのバッジを `DIRTY` と `autosaveError` に連動させ、31章の終了ガード（DIRTY→終了禁止）と一貫させる。
5. テレメトリ・Playwright: quota error / restore success / discard scope mismatch の 3 ケースを MSW フィクスチャと e2e シナリオに追加し、aria-live と tooltip を検証する。

## 8. 証跡・同期
- 証跡ログ: `docs/web-client/planning/phase2/logs/20251217T212600Z-charts-draft-save.md`
- DOC_STATUS と README の Active/最新更新サマリへ本ドキュメントと RUN_ID を追加する。
