# 34 並行編集とロック表示（webclient charts production outpatient plan）

- RUN_ID: `20251218T092228Z`
- 期間: 2026-01-09 09:00 〜 2026-01-11 09:00 (JST) / 優先度: medium / 緊急度: low / エージェント: gemini cli
- YAML ID: `src/charts_production_outpatient/workflow/34_並行編集とロック表示.md`
- 参照: [01 外来機能の完全カバレッジ定義](../01_外来機能の完全カバレッジ定義.md)（RUN_ID=`20251212T131901Z`）、[03 モダナイズ外来API契約テーブル確定](../03_モダナイズ外来API契約テーブル確定.md)（RUN_ID=`20251212T143720Z`）、[10 セッションと権限ガード整理](../foundation/10_セッションと権限ガード整理.md)（RUN_ID=`20251213T000432Z`）、[11 監査ログauditEvent統一](../foundation/11_監査ログauditEvent統一.md)（RUN_ID=`20251213T125127Z`）、[12 エラーハンドリングとリトライ規約](../foundation/12_エラーハンドリングとリトライ規約.md)（RUN_ID=`20251217T125828Z`）、[22 ToneBannerと状態Pillの一貫性](../ux/22_ToneBannerと状態Pillの一貫性.md)（RUN_ID=`20251217T063116Z`）、[31 診療開始終了の状態遷移](./31_診療開始終了の状態遷移.md)（RUN_ID=`20251217T120220Z`）
- 証跡ログ: `docs/web-client/planning/phase2/logs/20251218T092228Z-charts-concurrent-edit-lock.md`

---

## 0. 結論（今回決めたこと）
- **現状の実装（RUN_ID=`20251218T092228Z`）**: ブラウザ内（同一端末/複数タブ）の `localStorage` ロック＋閲覧専用化、衝突時の `ToneBanner warning` 統一、監査イベント（`CHARTS_EDIT_LOCK` / `CHARTS_CONFLICT`）と「最終更新（誰/いつ）」ピルの最低限を実装済み。サーバー側 `editLock`（soft-lock + ETag）連携は `server-modernized` 側仕様確定後に実装する。
- **二段階ロック**で衝突を抑止する: ①ブラウザ内（同一端末/複数タブ）では `localStorage` の `chartsLock:<patientId>:<appointmentId>` に runId+tabId を保存し、別タブは即座に「閲覧専用」を提示。②サーバーとは `editLock` ハンドシェイク（`lockOwner`,`lockExpiresAt`,`lockRequestId`,`documentVersion` ETag）を `fetchWithResolver` メタで受渡し、取得失敗や 409/412 は UI を読み取り専用に落とす。
- **「最終更新者/時刻/ソース」表示をヘッダーピルとして常時掲示**。`lastUpdatedBy`（userName + role）/`lastUpdatedAt`/`dataSourceTransition` を表示し、キャッシュ値は「(cache)」、ORCA 反映待ちは「(pending)」を suffix。ToneBanner は `warning`（assertive）で 1 回だけ読み上げ、Pill は aria-live=off。
- **保存・送信・診療終了の誤上書き防止フローを固定**: 操作前に `lockOwner` と `documentVersion` を比較し、他者/他端末/他タブが保持している場合はリクエストを送らず `outcome=blocked, reason=edit_lock_conflict` を audit に残す。ユーザーには 3 ボタンを提示: 「最新を再読込」「自分の変更を破棄」「強制引き継ぎ（ロック奪取）」。
- **衝突発生時の UX を統一**: ToneBanner warning（assertive）＋ダイアログに差分概要（最終更新者/時刻/保存種別）を表示。閲覧専用モードでは ActionBar を全面 disabled（tooltip 付き）、DocumentTimeline に `EDIT_CONFLICT` 行を追加し、`ENCOUNTER_STATE` は OPEN のまま。
- **監査ログ/テレメトリを追加**: `CHARTS_EDIT_LOCK`（outcome=`acquired|renewed|stolen|conflict|released|expired`）、`CHARTS_CONFLICT`（outcome=`blocked|discarded|resolved`）、`ENCOUNTER_CLOSE`/`ORCA_SEND` へ `lockRequestId` と `documentVersion` を注入。details に `lockOwnerUserId/Name`, `lockExpiresAt`, `trigger=tab|device|server`, `resolution=reload|force_takeover|discard` を入れる。

## 1. ロック/バージョンモデル
- **サーバーロック (soft-lock + ETag)**
  - 取得系 API で `editLock` メタを返す: `{ lockOwnerUserId, lockOwnerName, lockOwnerRunId, lockIssuedAt, lockExpiresAt (デフォルト 15 分), lockRequestId, documentVersion }`。
  - 編集系リクエストは `If-Match: <documentVersion>` と `X-Edit-Lock: <lockRequestId>` を送信。409/412 でロック衝突またはバージョン不一致を判定。
  - 成功応答は新しい `documentVersion` と更新後の `editLock` を返し、UI はキャッシュとヘッダーピルを同じ値で更新する。`CLOSING`（診療終了中）はロック継続し、`CLOSED` でロック自動解放。
- **ローカルロック (same-device multi-tab)**
  - `tabSessionId` をセッションストレージに生成し、患者/受付単位のキーで `runId, tabSessionId, expiresAt(5m)` を localStorage に保存。自身以外のキーが存在すれば「別タブ編集中」と判断。
  - localStorage の `expiresAt` は 60s ごとに refresh。タブが閉じた場合 `storage` イベントで掃除し、残存ロックは 5 分で TTL 失効。
- **状態と Pill**
  - `lockStatus` を `owned | shared | other-tab | other-user | expired | none` とし、ヘッダーに Pill=`編集中/他ユーザー編集中/閲覧専用` を表示。ARIA は off、ToneBanner は衝突時のみ assertive。

## 2. 衝突検知と UX（読み取り専用/復帰導線）
| シナリオ | 検知トリガー | ユーザー表示 | 許可される操作 | 監査 `outcome/details` | 復帰方法 |
| --- | --- | --- | --- | --- | --- |
| 他端末/他ユーザーがロック中 | 取得時の `editLock.lockOwnerUserId !== currentUser` | ToneBanner warning + モーダル「<user>/<time> が編集中」| 閲覧専用（保存/送信/終了/印刷 disabled）| `CHARTS_EDIT_LOCK outcome=conflict, reason=other_user` | 「最新を再読込」→ lockOwner 解放後に enable / 「強制引き継ぎ」→ 409 を許容して retry（詳述） |
| 同一ユーザー別端末 | `lockOwnerUserId` 同じ・`runId` 異なる | ToneBanner warning「別端末から編集中」| 閲覧専用。強制引き継ぎ CTA を表示（デフォルトは抑止）| `reason=other_device_same_user` | 強制引き継ぎ時に `X-Force-Takeover: true` を付与し `outcome=stolen` |
| 同一端末別タブ | localStorage に他タブの `tabSessionId` | 即時ダイアログ「別タブで開いています」| 保存/送信/終了を非表示、閲覧専用 | `reason=other_tab`（UI ログのみ）| 元タブで閉じる or 自タブで「タブを切替」ボタン |
| 保存/送信時に 409/412 | サーバー応答 | ToneBanner warning + 再読込 CTA。モーダルに「保存できませんでした」 | ドラフトを read-only、ActionBar disable | `CHARTS_CONFLICT outcome=blocked, version=<old/new>` | 「最新を再読込」で再取得。破棄ボタンでローカル差分を捨てる。強制引き継ぎ可（下記） |
| 強制引き継ぎ | ユーザーが CTA を明示押下 | 二段 confirm + チェックボックス「上書きします」| 送信/保存/終了を 1 回のみ許可。失敗時は再び read-only | `CHARTS_EDIT_LOCK outcome=stolen, previousOwner=...` | 成功後、新しい lockOwner でヘッダー/Timeline を更新 |
| ロック期限切れ | `lockExpiresAt < now` を検知 | info バナー「編集中ロックが期限切れ」| 自動でロック取得を再試行（1,4,15s backoff）| `outcome=renewed|expired` | 再取得成功で編集可。失敗時は conflict と同じ挙動 |

補足: 強制引き継ぎは **他ユーザーが離席したままロックを持ち続ける** 緊急時のみ。実行時は必ず `recordChartsAuditEvent` に `reason=force_takeover` を残し、DocumentTimeline に `EDIT_LOCK:stolen` 行を追加する。

## 3. 「最終更新者/いつか」の表示と差分提示
- ヘッダーピル: `最終更新 <HH:MM> by <userName (role)> [source]`。`source` は `server|cache|pending` のいずれか。
- ActionBar の保存/送信ボタン tooltip に `lastUpdatedAt/By` と `documentVersion` を併記し、誤上書き防止の即時フィードバックに使う。
- 衝突ダイアログでは **差分概要** を表示: 直近の `auditEvent` から `action` と `outcome` を抜粋（例: ENCOUNTER_CLOSE success at 10:02, by Dr. Sato）。UI のドラフトとサーバー版のフィールド数・最終編集セクションを比較し、件数/フィールド名を示す（全文 diff は非表示）。
- DocumentTimeline に `EDIT_LOCK` イベントを追加: `state=acquired|conflict|stolen|released`, `owner`, `expiresAt`, `documentVersion` を表示。Tone は conflict/stolen=warning(assertive), acquired/renewed=info(polite)。

## 4. 監査・テレメトリ
- 追加する action
  - `CHARTS_EDIT_LOCK`: outcome=`acquired|renewed|stolen|conflict|released|expired`。
  - `CHARTS_CONFLICT`: outcome=`blocked|discarded|resolved`（差分破棄/再読込/強制引き継ぎの選択を記録）。
- details 共通項目: `lockRequestId`, `lockOwnerUserId`, `lockOwnerName`, `lockOwnerRunId`, `lockExpiresAt`, `documentVersion`, `trigger=<fetch|save|send|close|tab>`, `resolution=<reload|force_takeover|discard|timeout>`, `tabSessionId`, `runId`。
- 既存 action との連携: `ENCOUNTER_CLOSE` / `ORCA_SEND` / `DRAFT_SAVE` / `CHARTS_ACTION_FAILURE` に `lockRequestId` と `documentVersion` を注入。失敗時は `outcome=blocked` とし、DocumentTimeline でも同じ details を表示する。

## 5. 実装/テストタスク（DoD）
1. `web-client/src/features/charts/context/EncounterStateContext.ts`（31 章の予定）に `editLock` ストアを追加し、ActionBar/Timeline/ヘッダーピルが同じ `lockStatus/lastUpdated` を参照するよう統一。
2. `fetchWithResolver` の meta ハンドラに `editLock/documentVersion/lastUpdatedBy/At` を追加し、React Query キャッシュへ保存。保存/送信/終了リクエストは `If-Match` と `X-Edit-Lock` ヘッダーを付与する。
3. UI 反映: ヘッダーピルに「最終更新」を追加、ActionBar の disable 判定に `lockStatus` を組み込み、衝突時の ToneBanner + モーダル + CTA（再読込/破棄/強制引き継ぎ）を実装。ARIA: ToneBanner assertive、Pill aria-live=off。
4. DocumentTimeline: 新イベント `EDIT_LOCK` を追加し、`state/owner/expiresAt/resolution/documentVersion` を表示。`EDIT_CONFLICT` 行を warning(assertive) で 1 回のみ読み上げる。
5. MSW/Playwright: ケース追加 — (a) 他ユーザー編集中（409 で閲覧専用）、(b) 同一ユーザー別端末ロック奪取成功、(c) 保存時に 412 で再読込→成功、(d) localStorage タブ重複ブロック、(e) ロック期限切れ→自動再取得。ToneBanner が複数回鳴らないことと ActionBar disable 理由をアサート。

## 6. 残課題 / 注意点
- サーバー側の `editLock` 実装/API 仕様は `server-modernized` 側で要確定。仮決めのヘッダー/フィールド名が変わった場合は本書を更新する。
- オフライン中の編集はローカルロックのみ機能し、サーバー復帰時に 412 が出る想定。差分マージ UI は scope 外とし、破棄/再読込/強制上書きの 3 択に限定する。
- Stage/Preview で強制引き継ぎを実施する場合は、証跡ログに `resolution=force_takeover` を残し、ロール許可（管理者のみ）を確認する。
