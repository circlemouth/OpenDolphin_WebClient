# 12 デバッグ画面一覧と隔離候補整理

- RUN_ID: `20260106T072016Z`
- 期間: 2026-01-07 15:00 〜 2026-01-08 15:00 (JST) / 優先度: medium / 緊急度: high / エージェント: cursor cli
- YAML ID: `src/webclient_screen_structure_plan/inventory/12_デバッグ画面一覧と隔離候補整理.md`

## 参照チェーン
1. `docs/DEVELOPMENT_STATUS.md`
2. `web-client/src/AppRouter.tsx`（LegacyRootRedirect / legacy routes）
3. `web-client/src/features/outpatient/OutpatientMockPage.tsx`
4. `web-client/src/features/charts/pages/ChartsPage.tsx`
5. `web-client/src/features/charts/AuthServiceControls.tsx`
6. `web-client/src/features/charts/TelemetryFunnelPanel.tsx`
7. `web-client/src/features/administration/AdministrationPage.tsx`
8. `web-client/src/libs/http/header-flags.ts`（`?msw=1` によるデバッグヘッダ注入）

## 1. デバッグ/検証UI一覧（画面/要素/URL/ガード/用途）

| 画面/要素 | URL/導線 | ガード状態 | 用途/補足 |
| --- | --- | --- | --- |
| Outpatient Mock（検証専用画面） | `/f/:facilityId/outpatient-mock`（Legacy `/outpatient-mock` からも到達） | セッション必須 + facilityId 一致。ロール/ENV ガードなし。 | MSW シナリオ/故障注入/トーン遷移の検証。`?msw=1` で MSW fault header を許可。`localStorage` に検証フラグを保存。 |
| Auth-service flags デモ（埋め込みUI） | Charts 内部（`/f/:facilityId/charts` の左カラム） | セッション必須 + facilityId 一致。ロール/ENV ガードなし。 | `missingMaster/cacheHit/dataSourceTransition/runId` を手動で切替し、トーン表示を検証。画面内に常時表示（デモ表記あり）。 |
| Telemetry funnel パネル（埋め込みUI） | Charts 内部（`/f/:facilityId/charts` の右カラム） | セッション必須 + facilityId 一致。ロール/ENV ガードなし。 | `resolve_master → charts_orchestration → charts_action` のテレメトリログを表示。`dataSourceTransition/missingMaster/cacheHit` の変化追跡を支援。 |

## 2. 検証用途の操作を含む画面（本番機能に内包）

| 画面/要素 | URL/導線 | ガード状態 | 用途/補足 |
| --- | --- | --- | --- |
| Administration 配信 | `/f/:facilityId/administration` | セッション必須 + facilityId 一致。UI は `system_admin/admin/system-admin` 以外を操作ブロック（URL 直アクセスの遮断は未実装）。 | `useMockOrcaQueue`/`mswEnabled`/`chartsMasterSource` など検証向けフラグを含む。運用面では管理機能として必要。 |

## 3. 隔離候補（ENV / role / 別URL）と影響範囲

| 対象 | 隔離方法 | 影響範囲 / 留意点 |
| --- | --- | --- |
| Outpatient Mock | ENV ガード（例: `VITE_ENABLE_DEBUG_PAGES=1` の時のみ Route 登録/ナビ表示） | 本番導線から非表示化。既存の検証フローはローカル/検証環境でのみ利用可。Legacy `/outpatient-mock` も同時に無効化が必要。E2E/Playwright の導線変更が必要。 |
| Outpatient Mock | Role ガード（system_admin のみ許可） | 本番での閲覧を制限可能。`FacilityShell` 側で権限チェックを追加する必要。E2E/Playwright のロール前提を調整。 |
| Outpatient Mock | 別URL（`/debug/*` や専用ホスト） | 本番 UI から完全分離可能。別ビルド/別ルーティング管理が必要。アクセス制御は別途実装。E2E/Playwright の baseURL を分離。 |
| Auth-service flags デモ | ENV ガード（例: `VITE_ENABLE_DEBUG_UI=1` でのみ表示） | Charts 画面のレイアウトからデモ枠を除去。検証者は ENV 有効時のみ利用。E2E/Playwright の UI 検証条件を更新。 |
| Auth-service flags デモ | Role ガード（system_admin のみ表示） | 本番アクセスでも限定表示可能。UI 露出は残るため導線の誤操作リスクは低いが存在。 |
| Telemetry funnel パネル | ENV ガード（例: `VITE_ENABLE_DEBUG_UI=1` でのみ表示） | Charts 画面からテレメトリ表示を排除。ログ確認は検証環境でのみ可能。E2E/Playwright の UI セクション検証が必要。 |
| Telemetry funnel パネル | Role ガード（system_admin のみ表示） | 本番運用でも限定露出にできる。運用ユーザーへの露出を下げたい場合に有効。 |
| Administration 配信 | URL ガード強化（role 判定で読み取りも遮断） | 現行は UI で操作ブロックのみ。URL 直アクセスを遮断する場合は監査ログ方針と整合を取る必要。 |

## 4. 補足（現行のデバッグ導線とガード不足）

- `?msw=1` が付いた URL でのみ MSW fault header 注入が許可される設計だが、画面単位の遮断はないため、導線整理と合わせて URL 制限の見直しが必要。
- Outpatient Mock はナビ（NAV_LINKS）に常時表示されるため、本番導線で誤アクセスされる可能性がある。
- Auth-service flags デモ / Telemetry funnel パネルは Charts に常時表示され、運用利用者にも露出する。ENV/role ガードでの隔離が望ましい。
