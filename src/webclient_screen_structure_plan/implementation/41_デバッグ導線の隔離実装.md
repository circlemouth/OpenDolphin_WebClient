# 41 デバッグ導線の隔離実装

- RUN_ID: `20260106T104932Z`
- 期間: 2026-01-09 09:00 〜 2026-01-10 21:00 (JST) / 優先度: medium / 緊急度: high / エージェント: cursor cli
- YAML ID: `src/webclient_screen_structure_plan/implementation/41_デバッグ導線の隔離実装.md`

## 実施内容
- デバッグ導線の別ルート `/f/:facilityId/debug` を追加し、QA/検証用のハブ画面を実装。
- `VITE_ENABLE_DEBUG_PAGES=1` + `system_admin` ロールのみアクセス可能にし、未許可時は監査ログと明示ブロックを実施。
- Outpatient Mock の導線は `/f/:facilityId/debug/outpatient-mock` のみに限定し、旧導線は NotFound 固定のまま維持。

## 変更ファイル
- `web-client/src/AppRouter.tsx`（debug hub ルートと権限ガード追加）
- `web-client/src/features/debug/DebugHubPage.tsx`（QA/検証ハブ画面の新規追加）

## 検証
- `npm run -C web-client typecheck`

## 補足
- Charts 内の Auth-service flags / Telemetry panel は `VITE_ENABLE_DEBUG_UI=1` + `system_admin` で表示されるため、debug hub から案内しています。
- `msw=1` クエリが付いた場合のみ障害注入ヘッダーを許可する仕様は従来通りです。

## 追記（RUN_ID: 20260106T120200Z）

### 変更内容
- Debug hub / Outpatient Mock のアクセス拒否時に `denialReasons` として `env flag disabled` / `role missing` を監査ログへ追記。
- Debug hub UI に「本番導線は完全非表示」「QA/検証専用」「環境フラグがOFFの場合は表示されない」を明記。
- Debug hub に前提条件（ENV/role）と利用手順セクションを追加し、リンク説明で `msw=1` 必須/本番不可を明示。

### テスト結果
- `npm run -C web-client typecheck`: 成功
- `npm run -C web-client lint`: 失敗（既存の lint エラー多数。`FocusTrapDialog.tsx` の no-useless-escape、`@typescript-eslint/no-explicit-any` など、広範な既存指摘のため今回の差分とは無関係）
