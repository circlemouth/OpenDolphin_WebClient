# 30 本番ナビ/ルーティング最終設計

- RUN_ID: `20260106T101118Z`
- 期間: 2026-01-08 09:00 〜 2026-01-09 09:00 (JST) / 優先度: high / 緊急度: high / エージェント: gemini cli
- YAML ID: `src/webclient_screen_structure_plan/design/30_本番ナビ/ルーティング最終設計.md`

## 参照
- `docs/DEVELOPMENT_STATUS.md`
- `src/webclient_screen_structure_plan/inventory/11_Web画面構成の棚卸し.md`
- `src/webclient_screen_structure_plan/analysis/20_旧来→Web対応表と差分整理.md`
- `src/webclient_screen_structure_plan/analysis/21_デバッグ画面隔離方針の確定.md`
- `web-client/src/AppRouter.tsx`

## 1. 本番ナビ（順序・名称・遷移仕様）

本番ナビは **受付 → カルテ → 患者 → 管理** の順で固定し、英語/検証向け表記は本番表示から除外する。

| 順序 | 本番表示名 | ルート | 役割 | ガード |
| --- | --- | --- | --- | --- |
| 1 | 受付 | `/f/:facilityId/reception` | 受付リスト/トーン連携の入口 | セッション必須 + facilityId 一致 |
| 2 | カルテ | `/f/:facilityId/charts` | 診療カルテの中心画面 | セッション必須 + facilityId 一致 |
| 3 | 患者 | `/f/:facilityId/patients` | 患者管理/新患登録 | セッション必須 + facilityId 一致 |
| 4 | 管理 | `/f/:facilityId/administration` | 配信/管理系設定 | セッション必須 + facilityId 一致 + `system_admin` 系ロールのみ操作許可（閲覧は可能） |

補足:
- 旧ナビの英語表記（`Charts` / `Administration 配信`）は本番では **日本語表記に統一**する。
- `/f/:facilityId/outpatient-mock` は **本番ナビから除外**し、`analysis/21` の方針に従い `debug` 配下へ隔離する。

## 2. ルーティング構成（本番）

### ベースルート
- `/login`: 未ログイン時の入口。
- `/f/:facilityId/login`: 施設固定ログイン。未ログイン時のみ有効。
- `/f/:facilityId` (index): `/f/:facilityId/reception` へリダイレクト。

### 本番ルート（本番ナビ対象）
- `/f/:facilityId/reception`
- `/f/:facilityId/charts`
- `/f/:facilityId/patients`
- `/f/:facilityId/administration`

### 付随ルート（ナビ外・業務導線）
- `/f/:facilityId/charts/print/outpatient`（カルテ印刷/外来プレビュー）
- `/f/:facilityId/charts/print/document`（文書印刷プレビュー）

### ガード/正規化ルール
- 未ログインは `/login` へ必ず誘導。
- 施設ID不一致は **専用の拒否画面** を表示し、現在施設へ戻す導線を提供。
- 旧ルート（`/reception` など）や未知ルートは施設付き URL へ正規化する。
- `/f/:facilityId/*` の未知ルートは `/f/:facilityId/reception` へフォールバック。

## 3. 画面遷移図（最小構成）

最小構成は **本番ナビ 4 画面 + ログイン/ガード** のみで運用可能な導線を定義する。

```
[未ログイン]
  └─ /login
        └─(ログイン成功)
            └─ /f/:facilityId (index)
                  └─ /f/:facilityId/reception
                        ├─ (ナビ切替) → /f/:facilityId/charts
                        ├─ (ナビ切替) → /f/:facilityId/patients
                        └─ (ナビ切替) → /f/:facilityId/administration

[ガード]
  - 施設ID不一致: 施設不一致ガード画面 → /f/:facilityId/reception へ戻す
  - 未ログイン: /login へ強制遷移
```

## 4. 画面遷移図（拡張構成）

拡張構成は **最小構成 + 印刷/ログイン切替/デバッグ隔離** を含む。

```
/charts
  ├─(印刷)→ /charts/print/outpatient
  └─(文書印刷)→ /charts/print/document

/login (ログイン済みアクセス)
  └─ LoginSwitchNotice → ログアウト → /login

/debug (本番では無効)
  └─ /f/:facilityId/debug/outpatient-mock (ENV+role 条件時のみ)
```

## 5. ガード要件（本番/拡張共通）

| ガード種別 | 対象 | 判定 | 期待挙動 |
| --- | --- | --- | --- |
| セッションガード | 全ルート | セッション未取得 | `/login` へリダイレクト |
| 施設境界ガード | `/f/:facilityId/*` | facilityId 不一致 | 拒否画面 + 現在施設へ戻る導線 |
| 役割ガード | `/administration` | `system_admin` 系ロール以外 | UI 操作をブロック + 警告表示（閲覧は可能） |
| 旧ルート正規化 | `/reception` 等 | 施設無し URL | 施設付き URL へ正規化 |
| デバッグ隔離 | `/debug/*` | ENV + role 不一致 | route 未登録/アクセス遮断 |

## 6. 決定事項（本番向け）

- 本番ナビは **受付/カルテ/患者/管理** の 4 画面で固定。
- 本番ナビには **デバッグ/検証系画面を含めない**。
- 付随ルート（印刷など）は **ナビ外の内部遷移**として維持。
- ルート正規化・施設境界ガード・ログイン切替ガードは **全体方針として維持**。

## 7. 未決事項/保留

- 管理画面の「閲覧のみ許可」範囲と、本番文言の詳細（UI 表示文言の最終確定）。
- `Patients` での旧来患者検索の高度導線（右クリック導線など）の再現範囲。
