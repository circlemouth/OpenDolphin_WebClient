# 21 デバッグ画面隔離方針の確定

- RUN_ID: `20260106T081751Z`
- 期間: 2026-01-07 21:00 〜 2026-01-08 21:00 (JST) / 優先度: high / 緊急度: high / エージェント: codex
- YAML ID: `src/webclient_screen_structure_plan/analysis/21_デバッグ画面隔離方針の確定.md`

## 参照
- `docs/DEVELOPMENT_STATUS.md`
- `src/webclient_screen_structure_plan/inventory/12_デバッグ画面一覧と隔離候補整理.md`

## 決定事項（隔離方式の採用）

### 方針（採用）
- **ENV + role の二段階ガード** を標準とし、**Outpatient Mock は別URL（/debug 配下）** で隔離する。
- 本番ビルドでは **ENV が無効 = ルーティング登録自体を行わない** ことで、本番導線から完全除外する。
- 検証用途の UI（埋め込みパネル）は **ロール限定 + ENV 有効時のみ表示** とする。

### 採用理由
- ENV での route 登録制御により **本番導線からの完全除外** が可能（ナビ/URL直叩きともに不可）。
- role 併用で **検証環境でも閲覧者を限定** でき、誤操作を抑止できる。
- 別URL（/debug）により **運用手順・監査対象・E2E を分離** しやすい。

## 対象別の隔離ポリシー（運用/権限/URL）

| 対象 | 運用（ENV） | 権限（role） | URL | 本番導線からの除外条件 |
| --- | --- | --- | --- | --- |
| Outpatient Mock（検証専用画面） | `VITE_ENABLE_DEBUG_PAGES=1` の時のみ route 登録 | `system_admin` のみ | `/f/:facilityId/debug/outpatient-mock`（既存 `/outpatient-mock` は無効化） | ENV 無効時は route 未登録（404/リダイレクト）。NAV_LINKS から削除。 |
| Auth-service flags デモ（Charts 内部） | `VITE_ENABLE_DEBUG_UI=1` の時のみ表示 | `system_admin` のみ | `/f/:facilityId/charts` 内埋め込み | ENV 無効 or role 不一致時は DOM 非表示。 |
| Telemetry funnel パネル（Charts 内部） | `VITE_ENABLE_DEBUG_UI=1` の時のみ表示 | `system_admin` のみ | `/f/:facilityId/charts` 内埋め込み | ENV 無効 or role 不一致時は DOM 非表示。 |
| Administration 配信（検証フラグ操作） | `VITE_ENABLE_ADMIN_DEBUG=1` の時のみ検証トグル表示 | `system_admin` のみ | `/f/:facilityId/administration` | ENV 無効時は検証トグル非表示。URL 直アクセスは既存の role ガードで遮断（予定）。 |

## 影響範囲の整理

### ナビゲーション
- NAV_LINKS から `/outpatient-mock` を除外し、**/debug 配下に移動**。
- Debug UI はナビに載せず、検証環境でのみ URL 共有する運用とする。

### ルーティング
- `VITE_ENABLE_DEBUG_PAGES=1` の時のみ `/debug/*` を登録。
- 既存 `/outpatient-mock` / legacy route は **無効化（NotFound/redirect）**。

### 権限ガード
- Debug 画面と debug UI は **`system_admin` 固定**。
- `facilityId` 不一致ガードは既存ルールを維持。

### 運用手順
- **ローカル/検証環境**: `.env` に `VITE_ENABLE_DEBUG_PAGES=1` / `VITE_ENABLE_DEBUG_UI=1` / `VITE_ENABLE_ADMIN_DEBUG=1` を設定。
- **本番**: 3 変数は未設定（false）を標準とし、debug 画面は **ビルドから除外**。
- Debug 画面を利用する場合は、**検証環境で system_admin ロールを付与**し、URL を限定共有。

## 本番導線からの除外条件（チェックリスト）
- `VITE_ENABLE_DEBUG_PAGES` が **false**（route 未登録）
- `VITE_ENABLE_DEBUG_UI` が **false**（埋め込み UI 非表示）
- `VITE_ENABLE_ADMIN_DEBUG` が **false**（検証トグル非表示）
- NAV_LINKS に debug ルートを含めない
- `/outpatient-mock` と legacy debug ルートが **NotFound/redirect**

## 追加の確認・更新が必要な項目
- E2E/Playwright: `/debug/*` 導線・ENV 依存のテスト条件を追加。
- 運用手順: `setup-modernized-env.sh` の検証用 ENV 設定セクション更新（必要時）。
- 監査ログ: debug 画面アクセスは **debug フラグ付き**で記録する方針を追記するか検討。
