# 21 デバッグ画面隔離方針の確定

- RUN_ID: `20260106T094936Z`
- 期間: 2026-01-07 21:00 〜 2026-01-08 21:00 (JST) / 優先度: high / 緊急度: high / エージェント: codex
- YAML ID: `src/webclient_screen_structure_plan/analysis/21_デバッグ画面隔離方針の確定.md`

## 参照
- `docs/DEVELOPMENT_STATUS.md`
- `src/webclient_screen_structure_plan/inventory/12_デバッグ画面一覧と隔離候補整理.md`
- `web-client/src/AppRouter.tsx`
- `web-client/src/features/FacilityShell.tsx`
- `web-client/src/libs/navLinks.ts`
- `web-client/src/features/outpatient/OutpatientMockPage.tsx`
- `web-client/src/features/charts/pages/ChartsPage.tsx`
- `web-client/src/features/charts/AuthServiceControls.tsx`
- `web-client/src/features/charts/TelemetryFunnelPanel.tsx`
- `web-client/src/features/administration/AdministrationPage.tsx`
- `web-client/src/libs/http/header-flags.ts`

## 方針の確定（採用）

### 隔離方式
- **ENV + role の二段階ガード** を標準採用し、**Outpatient Mock は /debug 配下の別URL** として隔離する。
- **本番ビルドは ENV 無効が既定**。ENV 無効時は **ルーティング登録自体を行わない**（導線・URL直叩きの両方を遮断）。
- デバッグ UI（埋め込みパネル/検証トグル）は **ENV 有効 + role 許可時のみ表示** とする。

### 採用理由
- route 登録制御により、本番導線から完全除外できる。
- role 併用により、検証環境でも閲覧者を限定でき、誤操作リスクを下げられる。
- /debug 配下分離で、運用手順・監査対象・E2E の切り分けが明確になる。

## ENV 名の最終採用
- `VITE_ENABLE_DEBUG_PAGES` : /debug 配下の **デバッグ画面 route 登録** を制御
- `VITE_ENABLE_DEBUG_UI` : Charts 内の **デバッグ埋め込み UI 表示** を制御
- `VITE_ENABLE_ADMIN_DEBUG` : Administration 内の **検証トグル表示** を制御

## 旧ルートの扱い（確定）
- 旧 `/outpatient-mock` は **NotFound 扱い** とする。
  - 理由: 誤導線の温存を避け、本番アクセスの経路を明確に遮断するため。
  - `/debug/outpatient-mock` のみが検証環境で有効。

## 権限ロールの確定
- **許可ロールは `system_admin` のみ**を基本とする。
- `admin` / `system-admin` は **既存実装上 `system_admin` と同義の別表記**として扱う（用語揺れを許容し、説明は統一）。
- ドキュメント・ガード表示文言は **`system_admin` に統一**。

## デバッグ UI / 検証機能の全量一覧（対象範囲整理）

| 対象 | 画面/導線 | URL | 表示条件（ENV + role） | 想定利用者 | 遮断時の挙動 |
| --- | --- | --- | --- | --- | --- |
| Outpatient Mock（検証専用画面） | 独立ページ | `/f/:facilityId/debug/outpatient-mock` | `VITE_ENABLE_DEBUG_PAGES=1` + `system_admin` | QA/検証担当 | route 未登録（ENV 無効）/ 403相当ガード表示（role不一致） |
| Auth-service flags デモ | Charts 左カラム埋め込み | `/f/:facilityId/charts` 内 | `VITE_ENABLE_DEBUG_UI=1` + `system_admin` | QA/検証担当 | DOM 非表示、テレメトリ/操作 UI は現れない |
| Telemetry funnel パネル | Charts 右カラム埋め込み | `/f/:facilityId/charts` 内 | `VITE_ENABLE_DEBUG_UI=1` + `system_admin` | QA/検証担当 | DOM 非表示、テレメトリ一覧は現れない |
| Administration 配信検証トグル | Administration ページ | `/f/:facilityId/administration` | `VITE_ENABLE_ADMIN_DEBUG=1` + `system_admin` | 管理者/検証担当 | 検証トグル非表示。role不一致時は既存ガードを表示 |
| MSW fault header 注入 | URL パラメータ | `?msw=1` 付きアクセス | `VITE_ENABLE_DEBUG_PAGES=1` or `VITE_ENABLE_DEBUG_UI=1` のいずれか + `system_admin` | QA/検証担当 | header 注入無効（msw=1 のみでは有効化しない） |

補足:
- Outpatient Mock の旧導線 `/outpatient-mock` は **NotFound** で遮断する。
- Administration 配信自体は本番機能であり、**検証用トグルのみ**を隔離対象とする。

## 本番導線からの除外条件（チェックリスト）
- `VITE_ENABLE_DEBUG_PAGES` = false（/debug route 未登録）
- `VITE_ENABLE_DEBUG_UI` = false（Charts デバッグ UI 非表示）
- `VITE_ENABLE_ADMIN_DEBUG` = false（検証トグル非表示）
- NAV_LINKS に debug ルートを含めない
- 旧 `/outpatient-mock` を NotFound へ統一

## 影響範囲（実装ポイント）

### ナビゲーション
- `web-client/src/libs/navLinks.ts` で /debug ルートを条件付き（ENV 有効時のみ）にする。
- Debug UI は **ナビに載せない**（URL 共有のみ）。

### ルーティング
- `web-client/src/AppRouter.tsx` で `VITE_ENABLE_DEBUG_PAGES` が false の場合は **/debug route を登録しない**。
- 旧 `/outpatient-mock` は **NotFound へ送る**（legacy route も同様）。

### 権限ガード
- `FacilityShell` の role ガードを踏襲し、debug 画面は `system_admin` に限定。
- role 不一致時は **遮断理由を明示**し、`/reception` 等へ戻す導線を表示。

### 埋め込み UI
- `ChartsPage` 内の `AuthServiceControls` / `TelemetryFunnelPanel` は `VITE_ENABLE_DEBUG_UI` で表示分岐。

### Administration 検証トグル
- `AdministrationPage` 内で `VITE_ENABLE_ADMIN_DEBUG` を判定し、検証トグル群のみを非表示化。
- 既存の `system_admin` ガード（操作ブロック + 監査ログ）を維持。

### MSW / header flag
- `header-flags.ts` の `?msw=1` は **ENV + role 条件を満たす時のみ有効**とする運用を前提。

## 運用手順（本番 / 検証 / ローカル）

### 本番
- ENV: `VITE_ENABLE_DEBUG_PAGES/DEBUG_UI/ADMIN_DEBUG` を未設定（false）
- 期待状態: `/debug/*` は route 未登録、埋め込み UI/検証トグルは非表示、旧 `/outpatient-mock` は NotFound
- 監査: debug フラグを含むログは出力されない

### 検証（ステージング/QA）
- ENV: `VITE_ENABLE_DEBUG_PAGES=1` `VITE_ENABLE_DEBUG_UI=1` `VITE_ENABLE_ADMIN_DEBUG=1`
- role: `system_admin`（`admin` / `system-admin` は同義）を付与
- URL: `/f/:facilityId/debug/outpatient-mock` を共有して利用

### ローカル
- `.env.local` に上記 3 変数を設定
- 検証用途のため、`?msw=1` は **debug ENV + role 条件成立時のみ**有効化

### 運用チェックリスト（最小）
- 本番: 3 変数未設定 / debug route なし / 旧 `/outpatient-mock` NotFound
- 検証: 3 変数=1 / system_admin ロール / /debug URL のみ共有
- ローカル: .env.local 設定 / MSW 条件確認

## 監査ログ方針（明文化）
- debug 画面・デバッグ UI のアクセス/遮断は **監査イベント**に以下を含める。
  - `debug: true`
  - `debugFeature`: `outpatient-mock` / `auth-service-flags` / `telemetry-funnel` / `admin-debug-toggle` / `msw-header`
  - `role`, `requiredRole`（`system_admin`）
  - `envFlags`: `VITE_ENABLE_DEBUG_PAGES/DEBUG_UI/ADMIN_DEBUG` の on/off
  - `runId`
  - `blockedReason`（ENV 無効 / role 不一致 / route 未登録）
- 既存の guard ログ（Administration など）は **debug 専用のメタを追加**して統一。

## テスト観点（Playwright/E2E）

### ENV on/off
- `VITE_ENABLE_DEBUG_PAGES=0` で `/debug/outpatient-mock` が 404/NotFound になる。
- `VITE_ENABLE_DEBUG_UI=0` で Charts から debug UI が消える。
- `VITE_ENABLE_ADMIN_DEBUG=0` で Admin の検証トグルが消える。

### role 不一致
- `system_admin` 以外で `/debug/outpatient-mock` にアクセスすると guard 表示 + 監査ログ。
- Charts の debug UI が role 不一致で表示されない。
- Admin の検証トグルが role 不一致で非表示。

### URL 直叩き
- `/outpatient-mock` 旧ルートが NotFound。
- `/debug/*` が ENV 無効時に route 未登録扱い。

### MSW 無効
- `?msw=1` 付きでも ENV/role 条件を満たさない場合は fault header が付与されない。

## 追加の確認・更新が必要な項目
- E2E/Playwright: /debug 導線と ENV 条件のテストを追加。
- 運用手順: `setup-modernized-env.sh` の検証用 ENV 設定セクション更新（必要時）。
- 監査ログ: debug フラグ付与の実装方針を調整（既存 auditEvent へ拡張）。
