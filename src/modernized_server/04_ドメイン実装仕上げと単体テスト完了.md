# 04_ドメイン実装仕上げと単体テスト完了 ✓

- RUN_ID: `20251120T061329Z`
- 期間: 2025-11-30 09:00 〜 2025-12-07 09:00 (JST)
- エージェント: Codex
- YAML ID: `src/modernized_server/04_ドメイン実装仕上げと単体テスト完了.md`

## 1. 参照チェーン（遵守）
1. `AGENTS.md`
2. `docs/web-client/README.md`
3. `docs/server-modernization/phase2/INDEX.md`
4. `docs/managerdocs/PHASE2_MANAGER_ASSIGNMENT_OVERVIEW.md`
5. 関連チェックリスト: `docs/managerdocs/PHASE2_ORCA_SPRINT2_MANAGER_CHECKLIST.md` / `PHASE2_ORCA_PHR_GAP_MANAGER_CHECKLIST.md` / `PHASE2_SERVER_FOUNDATION_MANAGER_CHECKLIST.md`

## 2. 守るべき禁止事項
- `server/` 配下およびサーバースクリプトの変更は禁止。モダナイズ版サーバーのコードを書く場合も本 RUN では実装を行わず、計画・ドキュメント整備に限定する。
- Legacy 資産（`client/`、`common/`、`ext_lib/`）は参照のみ。更新不可。
- Python スクリプトの実行禁止（明示指示がある場合のみ例外）。
- ORCA 接続は WebORCA トライアル `https://weborca-trial.orca.med.or.jp/`（BASIC 認証 `trial` / `weborcatrial`）のみを使用。本番証明書や `curl --cert-type P12` は使用しない。

## 3. ゴール
- 会計・処方・予約など優先ドメインの不足 API を設計レベルで洗い出し、契約に沿ったレスポンス整形方針を確定する。
- 例外ハンドリングと入力バリデーションの統一方針をまとめ、主要ロジックに対する単体テスト追加計画を提示する。
- 既存テストのフレーク検知と修正計画を整理し、カバレッジ目標と測定パスを明記する。

## 4. スコープと非スコープ
- スコープ: ドメイン実装の残課題整理、API 契約確認、テスト方針およびログ運用の計画策定、証跡ログの整備。
- 非スコープ: `server/` 配下の実装・設定変更、Docker/WildFly の再起動や Secrets 配布など運用作業。

## 5. タスク分解
- **API 不足整理**: `docs/server-modernization/phase2/domains/API_PARITY_MATRIX.md` と `docs/server-modernization/MODERNIZED_REST_API_INVENTORY.md` を突合し、会計・処方・予約領域の未実装/応答整形不足の Matrix No. を列挙。Trial Blocker (`TrialEndpointMissing`, `TrialLocalOnly`) の根拠リンクを付記。
- **例外/バリデーション方針**: 現行 Runbook（`operations/ORCA_CONNECTIVITY_VALIDATION.md`、`operations/ORCA_API_STATUS.md`）やカルテ系ノートを参照し、HTTP ステータス、エラーコード、必須ヘッダー、入力チェックの基準を統一したガイドをドラフト。
- **テスト計画**: 主要ドメインの単体テスト追加対象をリスト化し、フレーク検知方法（再現手順・ログ採取パス）とカバレッジ測定コマンドを記載。実装は行わず、必要な証跡パス・RUN_ID の貼付ルールをまとめる。
- **証跡整理**: 本 RUN_ID 用ログ `docs/server-modernization/phase2/operations/logs/20251120T061329Z-domain-finish.md` を作成し、作業メモ・参照リンク・今後の Evidence 収納先（例: `artifacts/orca-connectivity/20251120T061329Z/`）を記録。

## 6. Definition of Done
- DoD-1: API 不足と Blocker を Matrix No. / 根拠 URL / 対応方針付きで本ドキュメントへ反映。
- DoD-2: 例外・バリデーションの統一ガイド草案を作成し、追従すべき Runbook/チェックリストをリンク。
- DoD-3: 単体テスト追加計画（対象・観点・カバレッジ計測コマンド・フレーク検知/回避策）を明記し、証跡ログへ RUN_ID と保存パスを記録。
- DoD-4: `docs/web-client/planning/phase2/DOC_STATUS.md` の該当行へ本 RUN_ID と更新内容を追記し、関係ハブ（必要に応じて `docs/server-modernization/phase2/INDEX.md`）と整合させる準備ができている。

## 7. ログ・証跡運用
- ログ: `docs/server-modernization/phase2/operations/logs/20251120T061329Z-domain-finish.md`
- アーティファクト（必要時に作成）: `artifacts/orca-connectivity/20251120T061329Z/`
- DOC_STATUS: 「モダナイズ/ドメイン」系の行へ RUN_ID と更新メモを追記し、参照チェーンのハブと同期する。

## 8. 整理結果（2025-11-20, RUN_ID=`20251120T061329Z`）
- API 不足・Blocker（会計/処方/予約優先）
  - Rsv-1: Matrix No.2/6/15（`/orca14/appointmodv2`、`/api01rv2/appointlstv2`、`/api01rv2/appointlst2v2`）は `OrcaAppointmentResource` 実装済みだが Trial 405 により Blocker=`TrialLocalOnly`（Spec-based）。ORMaster 実測計画 RUN_ID=`20251116T173000Z` 依存。
  - Billing-1: Matrix No.16 `/api01rv2/acsimulatev2` → `POST /orca/billing/estimate` は `BillingSimulationRequest/Response` で実装済みながら Trial 送信不可。`claimBundles` が空の場合 400 を返す仕様を維持し、OR Master 解放後に実測する。
  - Rx-1: PHR-01〜11（`/20/adm/phr/*`）は REST 公開なしで Blocker=`TrialEndpointMissing`。PHR-09（処方テキスト）を含むため最優先で RESTEasy 登録＋証跡取得が必要。
  - Rx-2: `/orca102/medicatonmodv2`（点数マスタ同期）と `/orca21/medicalsetv2`（診療セット）は stub で `Api_Result=79` を返却中（Trial 405）。開放後に XML → DTO 変換を実測してレスポンス整形を確定する。
  - Rx-3: `DolphinResourceASP` 19 件 / `DemoResourceASP` 15 件（例: `/touch/module/rp/{param}`）が RESTEasy 未登録で全未整備。登録方針とレスポンス整形指針を決め、テストシナリオを追加する。
- 例外・バリデーション統一ドラフト
  - ORCA ラッパー: ORCA `Api_Result/Api_Error` は HTTP 200 で透過し、Trial 405/404 時のみ `status=blocked`・`blocker=TrialLocalOnly` を JSON と監査に付与（現行 stub と合わせる）。モダナイズ内部例外は 4xx/5xx を返しつつ同メタデータを載せる。
  - Content-Type: `/api01rv2/system01dailyv2` 等の XML 系は `application/xml; charset=UTF-8` 固定（Shift_JIS は Api_Result=91）、予約/請求の JSON 系も `Accept/Content-Type` の明示を必須化。BASIC 認証は `trial/weborcatrial` 統一。
  - 入力必須: `BillingSimulationRequest.claimBundles` 非空＋`performDate` 就診日±1 営業日、AppointmentMutation は `patientId/departmentCode/physicianCode/action` 必須、PHR Key/Token は facility 突合と `X-Access-Reason` 監査ヘッダー必須。
- 単体テスト計画（実装は別 RUN）
  - `OrcaAppointmentResource`/`OrcaWrapperService`: 405→`status=blocked` 透過と予約 DTO 変換（list/patient/mutation）を Mockito で検証。
  - `BillingSimulationResponseMapper`（OrcaXmlMapper）: `claimBundles` 空で 400、ポイント計算の丸め、`mirroredClaimXml` 有無の 2 経路をカバー。
  - PHR フォーマッタ: `PhrDataAssembler`/`TouchMedicationFormatter` の薬剤文言・禁忌語置換を固定フィクスチャでスナップショット化（PHR-09 先行）。
  - RESTEasy 登録: `RestApplication` に DolphinResourceASP/DemoResourceASP を登録する回帰テストで 404→200 の差分を確認。
  - フレーク検知/カバレッジ: `TZ=Asia/Tokyo mvn -f pom.server-modernized.xml -pl server-modernized -am test -DskipITs` を 2 回連続実行し `target/surefire-reports/*.xml` を比較。`mvn ... jacoco:report -DskipITs` でカバレッジ採取（実行は別 RUN）。
- 証跡ログ: `docs/server-modernization/phase2/operations/logs/20251120T061329Z-domain-finish.md`

## 9. 進行中メモ
- 本 RUN は計画・棚卸しに限定し、サーバー実装や ORCA CRUD 実測は別 RUN に委譲する。
- 期間内に新たなワーカー指示が出た場合も RUN_ID を `20251120T061329Z` で統一する。

## 10. 更新履歴
- 2025-11-20: 初版作成（Codex、計画のみ／サーバーコード変更なし）。
