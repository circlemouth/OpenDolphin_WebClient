# 01_ギャップ分析と完了定義 ✓

- RUN_ID: `20251120T131731Z` （00 ガバナンスメモと共通）
- 期間: 2025-11-21 09:00 〜 2025-11-24 09:00 (JST)
- エージェント: Claude code

## 1. ゴール
- モダナイズ版サーバーの残タスクとギャップを洗い出し、Web クライアント要求と ORCA Trial 契約の両方で **着地する完了条件 (DoD)** を合意する。
- 「WEBORCA トライアル (`https://weborca-trial.orca.med.or.jp/`, BASIC=trial/weborcatrial) のみを使う」前提で診療・会計ドメイン API の網羅性を確認し、Trial 未開放 API は Blocker ラベルと証跡で管理する。
- Web クライアントが必要とするエンドポイント／契約を再確認し、非開発範囲・外部依存 (Legacy/Trial 制約) を明記する。

## 2. スコープと非スコープ
- スコープ: モダナイズ版サーバーの REST/Lite 実装・ORCA Trial ラッパー・監査ログ要件・Web クライアント契約（UI/UX は参照のみ）。
- 非スコープ: `server/` 配下のコード変更、Legacy `client/`/`common/`/`ext_lib/` の更新、クラウド ORCA や本番証明書 (`curl --cert-type P12`) を用いた接続。

## 3. 参照チェーン（遵守）
1. `AGENTS.md`
2. `docs/web-client/README.md`
3. `docs/server-modernization/phase2/INDEX.md`
4. `docs/managerdocs/PHASE2_MANAGER_ASSIGNMENT_OVERVIEW.md`
5. `docs/managerdocs/PHASE2_SERVER_FOUNDATION_MANAGER_CHECKLIST.md`

## 4. ギャップ分析チェックリスト（ドラフト）
- API網羅性: `MODERNIZED_REST_API_INVENTORY.md` / `API_PARITY_MATRIX.md` / `ORCA_REST_IMPLEMENTATION_NOTES.md` を突合し、診療(ORCA)/会計/PHR/予約/紹介状/レセ関連を Matrix No. で網羅確認。Trial 提供不可は Blocker=`TrialEndpointMissing|TrialLocalOnly` で明示。
- Web クライアント契約: `WEB_CLIENT_REQUIREMENTS.md` / `API_UI_GAP_ANALYSIS.md` / `ORCA_WEB_CLIENT_API_RELATIONSHIP(_MODERNIZED).md` と照合し、HTTP 契約（URI, メソッド, ステータス, 必須ヘッダー, DTO フィールド）を表形式で列挙。
- 監査/ログ: `d_audit_event` への書き込み要件（例: `PHR_*`, `STAMP_*`, JMS TraceId）と再現手順を Runbook 参照付きで洗い出し。
- 環境制約: Trial サンプルデータ欠落・POST 禁止 API・GUI 端末依存を一覧化し、代替（Modernized 200/403 実測 or 仕様ベース）を記録。
- エビデンス: `docs/server-modernization/phase2/operations/logs/<RUN_ID>-gap-analysis.md` を新設し、curl/UI/ログ/スクリーンショットのパスを集約。

## 5. 完了条件 (Definition of Done)
- DoD-1: 上記チェックリストを埋めたギャップサマリを本ファイルに反映し、Blocker/Ready/Done ラベルで分類。
- DoD-2: Trial 提供不可の API については、根拠 URL（`trialsite.md`）と最新実測 RUN_ID を併記し、Web クライアント側の暫定挙動（プレースホルダー/非表示/リトライ禁止）を決定。
- DoD-3: Modernized 実装で提供可能な API には、期待レスポンス例・監査イベント・必須ヘッダー（例: `X-Facility-Id`, `Authorization`）を明文化し、`README`/Runbook いずれかにリンク。
- DoD-4: 記録した RUN_ID=`20251120T131731Z` を `DOC_STATUS.md` 備考欄に追記し、`docs/web-client/README.md` / `docs/server-modernization/phase2/INDEX.md` の該当セクションへ同日反映できる状態にする。
- DoD-5: 参照チェーン・禁止事項（Python 実行禁止、server 配下非変更、Trial 限定）に違反する作業が無いことを確認し、ワーカー報告フォーマットで報告可能な状態にする。

## 6. タスクオーナーと成果物
- オーナー: Claude code（本ドキュメント作成・DoD 合意案提示）。
- 成果物: 本ファイル、エビデンスログ `docs/server-modernization/phase2/operations/logs/20251120T131731Z-gap-analysis.md`（未作成なら本期間内に作成）、必要に応じたチェックリスト更新 PR（コード変更なし）。

## 7. 進め方（タイムライン目安）
- Day1 (11/21): 既存インベントリ・UI契約ドキュメントを突合し、ギャップ一覧の初版を作成。
- Day2 (11/22): Trial 実測または既存証跡の再確認を行い、Blocker と代替対応を固める。
- Day3 (11/23): DoD 確定版をレビュー用に整形し、 `docs/web-client/README.md` / `phase2/INDEX.md` への反映差分を準備。
- Day4 (11/24 〜 09:00): ワーカー報告を提出し、残タスクがあれば次 RUN_ID への引き継ぎメモを追記。

## 8. ログ・証跡運用
- ログパス: `docs/server-modernization/phase2/operations/logs/20251120T131731Z-gap-analysis.md`（Trial curl, UI スクリーンショット, 監査ログ, diff 摘要を箇条書きで追記）。
- アーティファクト: `artifacts/orca-connectivity/20251120T131731Z/` 配下に Trial 実測データを格納（既存 RUN_ID と共通化）。
- DOC_STATUS: Phase2 の「モダナイズ/運用」「モダナイズ/基盤」行に `RUN_ID=20251120T131731Z` / 備考（ギャップ分析着手）を記入予定。

## 9. 連絡・報告フォーマット
- マネージャー指示: `【ワーカー指示】` で本 RUN_ID・参照チェーン・更新対象を明記。
- ワーカー報告: `【ワーカー報告】` + 実施内容 + 証跡パス + DOC_STATUS 更新行 + RUN_ID をセットで報告。Docker 再構築や本番 ORCA 接続が必要になる場合はその手前で報告して指示待ちとする。

## 10. リスクと回避策
- Trial API 未開放: Blocker ラベルと `trialsite.md#limit` の引用を必須化、Modernized 実装のみで着地させる暫定策を Web クライアントへ共有。
- データシード欠落: doctor/patient seed 依存の CRUD は GUI 端末実測が必要になるため、`artifacts/orca-connectivity/` への証跡格納と後続作業への引き継ぎを先に確保。
- スケジュール超過: Day2 時点で DoD 未充足の項目は優先度/Blocker を明示し、影響ページ（Charts/Reception/Administration など）と UI 挙動をセットで書き出す。

