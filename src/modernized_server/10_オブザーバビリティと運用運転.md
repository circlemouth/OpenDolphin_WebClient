# 10_オブザーバビリティと運用運転

- RUN_ID: `20251121T131725Z`
- 期間: 2025-12-09 09:00 〜 2025-12-13 09:00 (JST)
- 優先度: Medium / 緊急度: Low
- エージェント: gemini cli
- YAML ID: `src/modernized_server/10_オブザーバビリティと運用運転.md`

## 参照チェーン（遵守）
1. `AGENTS.md`
2. `docs/web-client/README.md`
3. `docs/server-modernization/phase2/INDEX.md`
4. `docs/managerdocs/PHASE2_MANAGER_ASSIGNMENT_OVERVIEW.md`
5. 関連チェックリスト: `docs/managerdocs/PHASE2_SERVER_FOUNDATION_MANAGER_CHECKLIST.md`

## 禁止事項 / 前提
- `server/` 配下および Legacy 資産（`client/` `common/` `ext_lib/`）の変更は禁止。参照のみ。
- Python スクリプトの実行は禁止（明示指示がある場合のみ例外）。
- WebORCA 接続が必要な検証は行わない。監査ログ・メトリクス・トレースはモダナイズ版サーバーの構成と Runbook 整備に限定する。
- RUN_ID は本タスクの `20251121T131725Z` に統一し、ログ・証跡・DOC_STATUS へ同一値で記録する。

## ゴール
- Micrometer/Prometheus/Loki/OTLP など観測データの出力先と保持期間を定義し、主要メトリクス・監査・トレースのアラート閾値を提示する。
- 障害対応 runbook と運用ハンドオフチェックリストを整備し、オンコール／定期点検で即参照できる形にする。
- 監査ログと合わせたデータ保持ポリシーを RUN_ID 付きで `docs/server-modernization/phase2/operations/logs/` に残し、Evidence/アーティファクト導線を揃える。

## スコープ / 非スコープ
- スコープ: モダナイズ版サーバーの観測データ（メトリクス/ログ/トレース）設計、保持期間とアラート閾値の定義、障害対応 runbook・ハンドオフチェックリスト作成、DOC_STATUS/ハブ更新。
- 非スコープ: Web クライアント UI 変更、Legacy サーバー設定変更、本番 ORCA 接続やデータ投入、CI/CD 実行。

## 期待アウトプット（DoD）
1. メトリクス/ログ/トレースの出力先・保持期間・アラート閾値をまとめた運用ノートが `docs/server-modernization/phase2/operations/logs/20251121T131725Z-observability.md` に作成されている。
2. 障害対応 runbook（検知→一次切り分け→復旧→エスカレーション）と運用ハンドオフチェックリストが同ログに掲載され、アラート名と連動している。
3. 監査ログ（`d_audit_event`）と観測データのデータ保持ポリシーが明記され、Evidence/アーティファクト保存パス（例: `artifacts/observability/20251121T131725Z/`）が定義されている。
4. RUN_ID=`20251121T131725Z` を `DOC_STATUS.md` 備考欄と関連ハブへ反映できるよう準備されている。

## タスク分解
- **A. 観測対象と保持ポリシー定義**
  - Micrometer（REST/JDBC/SSE）、WildFly/Undertow、監査ログ、OTLP トレースの出力先と保持期間を決定し、Ops/オンコール向けの表を作成する。
  - Prometheus/Loki/Elastic/Grafana/Alertmanager/PagerDuty の関連付け（job 名、ダッシュボード UID、ルーティング先）を整理する。
- **B. アラート設計と runbook**
  - エラーレート・レイテンシ・接続枯渇・監査フォーマット崩れ・OTLP 不能の代表シグナルを選定し、Warning/Critical の閾値と通知先を定義する。
  - 検知→切り分け→復旧→エスカレーションの手順、証跡取得コマンド、PoC/Stage/Prod の差分を runbook とハンドオフチェックリストへ記載する。
- **C. ドキュメント・棚卸し**
  - `docs/server-modernization/phase2/operations/logs/20251121T131725Z-observability.md` を作成し、A/B の成果と Evidence へのパスをまとめる。
  - `docs/web-client/planning/phase2/DOC_STATUS.md` に RUN_ID/ログパス/備考を追記し、必要に応じてハブ（README/INDEX）へリンクを追加する。

## 証跡配置
- ログ: `docs/server-modernization/phase2/operations/logs/20251121T131725Z-observability.md`
- アーティファクト: `artifacts/observability/20251121T131725Z/{dashboards,alerts,evidence}/`（必要に応じて作成）

## スケジュール目安
- 12/09 (Day1): 観測対象・保持ポリシーの草案作成、アラート案の洗い出し。
- 12/10 (Day2): アラート閾値と通知経路、runbook/ハンドオフチェックリストの初版作成。
- 12/11 (Day3): Evidence/アーティファクト構造整理、ログドキュメント仕上げ。
- 12/12 09:00 まで: DOC_STATUS 反映と引き継ぎメモ記載、残課題整理。

## リスクと留意点
- Prometheus/Loki/Grafana の環境差異により保持期間が揃わないリスク → 各環境のデフォルト値と上書きパラメータを並記し、最小共通期間をアラート/証跡の前提にする。
- 監査ログとメトリクスの突合が未自動化 → traceId/RequestId を必須フィールドとして runbook に照合手順を明記し、ハンドオフチェックリストへ確認項目を追加する。
- OTLP 収集経路が未構成の場合の運用ブレ → OTLP 未接続時のフォールバック（Prometheus/Loki 単独運用）と検知方法を runbook に記載する。
