
# 05_エラーハンドリングと監査ログ強化 ✓

- RUN_ID: `20240215T093000Z`（親 RUN_ID=`20251120T193040Z`）
- 期間: 2025-12-07 09:00 〜 2025-12-10 09:00 (JST)
- エージェント: Claude code
- YAML ID: `src/modernized_server/05_エラーハンドリングと監査ログ強化.md`

## 1. 参照チェーン（遵守）
1. `AGENTS.md`
2. `docs/web-client/README.md`
3. `docs/server-modernization/phase2/INDEX.md`
4. `docs/managerdocs/PHASE2_MANAGER_ASSIGNMENT_OVERVIEW.md`
5. 関連チェックリスト: `docs/managerdocs/PHASE2_SERVER_FOUNDATION_MANAGER_CHECKLIST.md` / `PHASE2_ORCA_SPRINT2_MANAGER_CHECKLIST.md` / `PHASE2_WEB_CLIENT_EXPERIENCE_MANAGER_CHECKLIST.md`

## 2. 守るべき禁止事項
- `server/` 配下およびサーバースクリプトの変更は禁止。本 RUN は計画・ドキュメント整備に限定し、実装や設定変更は行わない。
- Legacy 資産（`client/`、`common/`、`ext_lib/`）への変更禁止。参照のみ。
- Python スクリプトの実行禁止（明示指示がある場合のみ例外）。
- ORCA 接続は開発用 ORCA サーバー（`mac-dev-login.local.md` 参照）のみを使用。本番証明書や `curl --cert-type P12` は使用しない。

## 3. ゴール
- 共通エラーフォーマット（HTTP ステータス/アプリケーションコード/メッセージ/track-id/Blocker/ORCA Api_Result 等）の草案をまとめ、ORCA ラッパーと内部例外で統一できる指針を示す。
- 監査ログ出力ポリシーを策定し、個人情報マスク方針と追跡 ID（TraceId/SpanId/RequestId）付与ルールを整理する。挿入先（`d_audit_event` など）と必須フィールドを明記する。
- 障害時サポート手順（ログ収集・再現手順・責任分界）のドラフトを作成し、本 RUN_ID で `docs/server-modernization/phase2/operations/logs/` に保存する。

## 4. スコープと非スコープ
- スコープ: エラーフォーマット指針、監査ログポリシー、サポート手順のドキュメント化と証跡ログ作成。ORCA エラーコードと内部例外のマッピング表、マスク対象フィールドの定義、ログ保存パスの明示。
- 非スコープ: `server/` 配下の実装変更、WildFly/Docker の再起動や設定反映、Secrets 配布。本 RUN ではコードや構成を変更しない。

## 5. タスク分解
- **共通エラーフォーマット草案**: 既存資料（`ORCA_API_STATUS.md`、`API_PARITY_MATRIX.md`、`MODERNIZED_REST_API_INVENTORY.md`, `TRACE_PROPAGATION_CHECK.md`）のエラー出力を収集し、HTTP ステータス、`code`、`message`、`blocker`、`orca.apiResult`、`details[]` の最小要素を定義。ORCA 200/Api_Result≠00 を 4xx/5xx へどう昇格させるかの判断基準を明文化。
- **監査ログポリシー草案**: `d_audit_event` / `trace_http_*` で必要なフィールド（TraceId/SpanId/RequestId/actor/facility/patientId masked/action/resource/payloadDigest/result/blocker）を整理し、マスク方針（患者IDハッシュ化、氏名/住所の部分マスク、自由記述の削除/ハッシュ化）と保持期間・保存先を記載。
- **ORCA エラーとの整合**: ORCA `Api_Result/Api_Error` → 共通 `code/message/blocker` への変換表を作成し、監査ログへ同じ追跡 ID を連携する手順をまとめる。`TrialEndpointMissing`/`TrialLocalOnly` など Blocker ラベルの付与基準もここで定義。
- **障害時サポート手順**: `docs/server-modernization/phase2/operations/logs/20251120T193040Z-error-audit.md` を作成し、ログ採取対象（WildFly server.log、trace/metrics、httpdump）、収集コマンド例、再現追従に必要な環境変数/ヘッダー依存を RUN_ID 付きでテンプレ化。GUI/ネットワーク制約時の代替策も記す。
- **証跡配置と連携**: 本 RUN_ID 用の artifacts 置き場（`artifacts/error-audit/20251120T193040Z/`）とログファイルを定義し、DOC_STATUS・ハブ文書へ同日付で反映できるよう準備する。

## 6. Definition of Done
- DoD-1: 共通エラーフォーマット草案を本ドキュメントに記載し、ORCA/内部例外のマッピングと Blocker ラベル付け基準を示している。
- DoD-2: 監査ログポリシー草案に必須フィールド・マスク方針・追跡 ID 連携ルール・保存/保持先を明記し、関連 Runbook への連携ポイントを列挙している。
- DoD-3: 障害対応手順ログ `docs/server-modernization/phase2/operations/logs/20251120T193040Z-error-audit.md` を作成し、収集パス/再現手順/連絡テンプレを RUN_ID 付きで残している。
- DoD-4: `docs/web-client/planning/phase2/DOC_STATUS.md` の該当行へ RUN_ID と更新内容を追記し、必要に応じて `docs/server-modernization/phase2/INDEX.md` などハブとの整合準備ができている。

## 7. ログ・証跡運用
- ログ: `docs/server-modernization/phase2/operations/logs/20251120T193040Z-error-audit.md`（親 RUN 継承）、本 RUN で追記する場合は `docs/server-modernization/phase2/operations/logs/20240215T093000Z-error-audit.md` を新設して紐付ける。
- アーティファクト: `artifacts/error-audit/20240215T093000Z/`（本 RUN 用）、親 RUN の参照は `artifacts/error-audit/20251120T193040Z/` を継続利用。
- DOC_STATUS: 「モダナイズ/監査・エラーハンドリング」行を本 RUN_ID で更新し、証跡パス `artifacts/error-audit/20240215T093000Z/audit-policy/` を備考に記載する。

## 8. 進行メモ
- 本タスクは 04_ドメイン実装仕上げの成果を前提とし、API 契約/エラートーンの整合チェックは同ドキュメントのスコープを尊重して行う。
- ORCA Trial 依存の Blocker は 06/07 以降の実測タスクと連携し、本 RUN では Spec ベースの整合に留める。

## 9. 監査ログポリシー草案（RUN_ID=`20240215T093000Z`、親 RUN=`20251120T193040Z`）
- 目的: 監査・障害調査時に同一 `traceId` で HTTP エラー／JMS／DB 挿入を突合できる状態を維持する。共通エラーフォーマットの `trackId` = `X-Trace-Id` を監査ログの主キーとして扱う。
- 保存先:
  - **トランザクション監査**: `d_audit_event`（永続 DB）にアクション/結果を保存。同一 `traceId` で複数行が入る場合は `spanId` も併記。
  - **HTTP トレース**: `trace_http_*`（`ops/tools/send_parallel_request.sh` 採取ログ）と WildFly ローテートログ。障害再現用は `artifacts/error-audit/20240215T093000Z/audit-policy/` へコピー。
  - **JMS/外部連携**: `MessagingHeaders.TRACE_ID` を `X-Trace-Id` で統一し、JMS プロパティの値が Artemis で拒否されないことを `TRACE_PROPAGATION_CHECK.md` で検証する。
- 必須フィールド

| フィールド | 内容 / 例 | 出典/伝搬 | マスク・保存 |
| --- | --- | --- | --- |
| `traceId` (`track-id`/`X-Trace-Id`) | 追跡 ID（エラー応答と同一値） | `LogFilter` → `SessionTraceManager` → `SessionAuditDispatcher` → `MessagingHeaders.TRACE_ID` | 平文で保存し突合キーにする |
| `spanId` | アプリ内処理単位 | APM/span もしくは SessionOperationInterceptor（無い場合は `-`） | 平文 |
| `requestId` | サーバー生成 ID | `track-id` 非存在時のフォールバック | 平文 |
| `actor` | `userId` / `authType` | 認証層から取得。匿名は `anonymous` | 資格情報は保存禁止 |
| `facilityId` | 施設識別子 | 認証ヘッダー、Touch コンテキスト | 平文 |
| `patientId` | 対象患者キー | リクエスト/DTO から抽出 | **SHA-256 → 8 桁短縮**（例 `b3d9e1f4`）、原文非保存 |
| `action` | `READ/CREATE/UPDATE/DELETE/SEND` | HTTP メソッドと API で決定 | 平文 |
| `resource` | エンドポイント or サービス名 | REST パス、ORCA ラッパーは ApiId も併記 | 平文 |
| `payloadDigest` | ボディのハッシュ | 正規化 JSON → SHA-256 | ハッシュのみ保存 |
| `result` | `SUCCESS/FAILURE/BLOCKED` | HTTP ステータスと `error.code` から決定 | 平文 |
| `blocker` | 例: `TrialLocalOnly`/`TrialEndpointMissing`/`MissingSecrets` | エラーマッピングで判定 | 平文 |
| `httpStatus` / `error.code` | 例: `401`, `error=unauthorized`, `orca.apiResult=E70x` | 共通エラーフォーマットと同じ値 | 平文 |
| `client` | `ip`/`userAgent`/`acceptLang` | `LogFilter` | IP は `/24` マスク、UA はハッシュ |
| `timestamp` | 受信・出力時刻（UTC ISO8601） | サーバー時刻 | 平文 |

- マスク指針
  - 患者 ID は SHA-256→8 桁短縮で統一。ソルトは監査・トレースで共通。
  - 氏名/住所/自由記述は監査へ保存しない。必要な場合も `payloadDigest` のみで原文を残さない。
  - 電話/メール/保険者番号は後方 4 桁のみ（`****-**12` など）。添付ファイルや署名付き URL はログに残さず、署名 URL を貼らない。

- 保持・閲覧ルール（案）
  - `d_audit_event`: 365 日オンライン保持。月次バックアップを 24 か月冷凍保存し、削除ジョブは `d_audit_event` に記録。
  - `trace_http_*` / ローテートログ: 90 日保持。重大障害 RUN は `artifacts/error-audit/20240215T093000Z/` へ複製し 180 日保持。
  - 閲覧権限はセキュリティ/監査担当のみ。開発者はハッシュ済みビューを利用。

- エラーフォーマットとの連携
  - 共通エラーレスポンスの `trackId` をそのまま `traceId` として監査保存し、`details.auditId`（監査 DB の主キー）をレスポンスに返すことでサポート照会を容易にする。
  - 4xx/5xx でも `actor`/`facilityId`/`resource` を確定させ、`result=BLOCKED` と `blocker` を必須で記録。`TRACE_PROPAGATION_CHECK.md` にある 401/500 監査未記録のブロッカー解除が必須条件。
  - ORCA `Api_Result!=00` は HTTP 200 でも `result=FAILURE`、`blocker=ORCAError`、`error.code=orca.apiResult.<code>` として記録し、`payloadDigest` で入力のみを保持する（個人情報は生で保持しない）。

- 運用・証跡
  - 本 RUN の監査セットアップは `artifacts/error-audit/20240215T093000Z/audit-policy/README.md` にチェックリスト化し、`trace_http_{401,500}` の採取ログで上表の全フィールド充足を確認する。
  - エスカレーション時は `docs/server-modernization/phase2/operations/logs/<RUN_ID>-*.md` へ `traceId`/`payloadDigest` の参照のみを貼り、原文・添付は貼らない。

## 10. 共通エラーフォーマット草案（RUN_ID=`20240215T093000Z`、親 RUN=`20251120T193040Z`）
 - 目的: Web クライアントとモダナイズ版サーバー、ORCA ラッパーのいずれでも同じ構造のエラーを返し、監査ログ・トレース（`trace_http_*`）・Runbook ログと相互参照できるようにする。証跡: `artifacts/error-audit/20240215T093000Z/format/README.md`（RUN_ID=`20240215T093000Z`, 親=`20251120T193040Z` のフォーマット例・Blocker基準・監査連携メモを集約し、親 RUN 草案との差分・整合を明記）。
- 最小フォーマット（UTF-8/JSON 想定）:
  - `status`（HTTP）、`code`（アプリケーション固有、例: `ORCA.PATIENT.MOD.VALIDATION` / `INTERNAL.ERROR`）、`message`（ユーザー表示向け短文）、`blocker`（配列、無い場合は空配列）、`trackId`（`X-Request-Id` と `trace_http_*` の TraceId を統一）、`orca.apiResult` / `orca.apiResultMessage` / `orca.runId`（ORCA ラッパーのみ）、`details`（開発・サポート向けキー/値）。サーバー内部例外の場合も `trackId`・`details` は必須。
  - 返却例:
    ```json
    {
      "status": 503,
      "code": "ORCA.VISIT.LIST.TRIAL_BLOCKED",
      "message": "ORCA Trial はこの API を提供していません（Spec-based 応答）",
      "blocker": ["TrialLocalOnly"],
      "trackId": "c5b2f6c9b6c847c8",
      "orca": {"apiResult": "79", "apiResultMessage": "Spec-based implementation / Trial未検証", "runId": "20251116T170500Z"},
      "details": {"endpoint": "/api01rv2/visitptlstv2", "runId": "20240215T093000Z"}
    }
    ```
- HTTP / ORCA `Api_Result` / Blocker のマッピング基準:
  - ORCA 側 HTTP=2xx 且つ `Api_Result=00`: HTTP 200/201 を維持し、`orca.apiResult=00` をレスポンスへ透過。監査ログには `trackId` と `runId` を残す。
  - ORCA 側 HTTP=2xx だが `Api_Result!=00`:  
    - 入力妥当性・ビジネスルール違反（例: `Api_Result=10/12/13/21` が `REST_API_INVENTORY` / `ORCA_API_STATUS` でバリデーション起因と判定できる場合）は HTTP 422（`code=*VALIDATION`、Blocker 空）。  
    - Trial 封鎖や Spec-based 代替（`Api_Result=79`、`Api_ResultMessage` に「Spec-based implementation / Trial未検証」）は HTTP 503、Blocker=`TrialLocalOnly`。  
    - 上記以外のシステム/外部障害は HTTP 502（`code=*UPSTREAM_ERROR`）、Blocker 空。
  - ORCA 側 HTTP=404/405 かつ `ORCA_API_STATUS` / `API_PARITY_MATRIX` に Trial 未提供と明記されている場合は HTTP 503、Blocker=`TrialEndpointMissing`。ORCA 実装が存在し Web 側スタブで代替するケースは `TrialLocalOnly` を付与。
  - ORCA 側 HTTP=401/403 は資格情報欠落として HTTP 401/403 をそのまま返し、`code=ORCA.AUTH`、Blocker 空。  
  - ORCA 以外の内部例外（`DatabaseException` / `UnexpectedException` 等）は HTTP 500、`code=INTERNAL.ERROR`、Blocker 空。再現手順を `details` に記載し、監査ログと `trace_http_*` で同じ `trackId` を用いる。
- Blocker 付与ルール（`blocker` 配列）:
  - `TrialEndpointMissing`: Trial サーバーが 404/405 を返す、または `ORCA_API_STATUS` に「Trial 再実測完了（404/405）」と記録されている API（例: `/20/adm/phr/*`, `/orca14/appointmodv2`）。
  - `TrialLocalOnly`: `API_PARITY_MATRIX` の ORCA 行で「Spec-based」や「Trial では POST 閉鎖」と記載され、モダナイズ側スタブが代替する API（例: `/orca/visits/list` `Api_Result=79`）。
  - `TrialSeedMissing`: Trial UI の seed 不足が原因で 4xx を返すケース（例: doctor/patient seed 欠落）。再検証条件を `details` に記載。
  - Blocker が無い一般的な業務/入力エラーは配列を空にし、HTTP ステータスと `code` で意図を明示する。
- 監査・トレース連携:
  - `trackId` は `X-Request-Id`（フロント起点）と `trace_http_*`（サーバー側ログ）の TraceId を一致させ、`d_audit_event.run_id` にも同値を格納する。ORCA ラッパーでは `orca.runId`（例: `20251116T170500Z`）を併記し、Runbook 証跡と突合できるようにする。
  - `details` には `endpoint`、`method`、`facilityId`、`patientId`（マスク済み）、`auditId` を記録し、個人情報はマスク/ハッシュ（患者 ID はハッシュ、氏名はイニシャル化）を徹底する。

## 11. Runbook 更新（20240215T093000Z）
- 新規ログ `docs/server-modernization/phase2/operations/logs/20240215T093000Z-error-audit.md` を追加し、WildFly `server.log` / `trace_http_*` / `metrics` / `httpdump` / `Thread.print` / `jmap histo` / `curl` 取得と Blocker 連絡テンプレ（影響範囲・添付パス付き）を整理。
- 証跡ディレクトリを `artifacts/error-audit/20240215T093000Z/`（`wildfly/`, `trace/`, `metrics/`, `httpdump/`, `thread-dump/`, `heap-dump/`, `client-requests/`, `docs/`）として事前作成。採取後は RUN_ID と時刻をファイル名へ付与し、本章・DOC_STATUS に同じパスを記載する。
- ハブ反映: `docs/web-client/planning/phase2/DOC_STATUS.md`（モダナイズ/監査・エラーハンドリング行）と必要に応じて `docs/server-modernization/phase2/INDEX.md` / `docs/managerdocs/PHASE2_MANAGER_ASSIGNMENT_OVERVIEW.md` から当該ログへのリンクを付与する。

## 12. 更新履歴
- 2024-02-15: RUN_ID=`20240215T093000Z`（親=`20251120T193040Z`）。監査ログポリシー草案を追加し、必須フィールド/マスク/保持/trace 連携方針を整理。
- 2025-11-20: 初版作成（計画のみ、サーバーコード/設定変更なし）。
## 進捗メモ（2025-11-21, RUN_ID=20251121T153300Z, child=20251121ErrorMatrixZ1）
- 正常系: /api01rv2/system01dailyv2 200/00。誤パスワードで 401、patientgetv2 id=999999 で 404、/actuator/health 404 を採取。
- 業務系エラー拡充（ErrorMatrixZ1）: system01dailyv2 Request_Number=99→200/91、cceptlstv2 過去日+不正医師→200/13、medicalmodv2 不正患者→200/10、/api21/medicalmodv2 直下 POST は 405 を保存。
- Evidence: rtifacts/error-audit/20251121T153300Z/...、rtifacts/error-audit/20251121ErrorMatrixZ1/...。親ログ docs/server-modernization/phase2/operations/logs/20251120T193040Z-error-audit.md に子 RUN を追記済み。
- 反映済み: ORCA_API_STATUS.md / ORCA_CONNECTIVITY_VALIDATION.md / DOC_STATUS（監査・エラーハンドリング行）。
- 残課題: 正常患者を使った /api/api21/medicalmodv2 成功ケース採取、405 直下ルートの扱いを Handbook へ整理。
