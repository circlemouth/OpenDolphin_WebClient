# 05_エラーハンドリングと監査ログ強化 

- RUN_ID: `20251120T193040Z`
- 期間: 2025-12-07 09:00 〜 2025-12-10 09:00 (JST)
- エージェント: Claude code
- YAML ID: `src/modernized_server/05_エラーハンドリングと監査ログ強化.md`

## 1. 参照チェーン（遵守）
1. `AGENTS.md`
2. `docs/web-client/README.md`
3. `docs/server-modernization/phase2/INDEX.md`
4. `docs/managerdocs/PHASE2_MANAGER_ASSIGNMENT_OVERVIEW.md`
5. 関連チェックリスト: `docs/managerdocs/PHASE2_SERVER_FOUNDATION_MANAGER_CHECKLIST.md` / `PHASE2_ORCA_SPRINT2_MANAGER_CHECKLIST.md` / `PHASE2_WEB_CLIENT_EXPERIENCE_MANAGER_CHECKLIST.md`

## 2. 守るべき禁止事項
- `server/` 配下およびサーバースクリプトの変更は禁止。本 RUN は計画・ドキュメント整備に限定し、実装や設定変更は行わない。
- Legacy 資産（`client/`、`common/`、`ext_lib/`）への変更禁止。参照のみ。
- Python スクリプトの実行禁止（明示指示がある場合のみ例外）。
- ORCA 接続は WebORCA トライアル `https://weborca-trial.orca.med.or.jp/`（BASIC 認証 `trial` / `weborcatrial`）のみを使用。本番証明書や `curl --cert-type P12` は使用しない。

## 3. ゴール
- 共通エラーフォーマット（HTTP ステータス/アプリケーションコード/メッセージ/track-id/Blocker/ORCA Api_Result 等）の草案をまとめ、ORCA ラッパーと内部例外で統一できる指針を示す。
- 監査ログ出力ポリシーを策定し、個人情報マスク方針と追跡 ID（TraceId/SpanId/RequestId）付与ルールを整理する。挿入先（`d_audit_event` など）と必須フィールドを明記する。
- 障害時サポート手順（ログ収集・再現手順・責任分界）のドラフトを作成し、本 RUN_ID で `docs/server-modernization/phase2/operations/logs/` に保存する。

## 4. スコープと非スコープ
- スコープ: エラーフォーマット指針、監査ログポリシー、サポート手順のドキュメント化と証跡ログ作成。ORCA エラーコードと内部例外のマッピング表、マスク対象フィールドの定義、ログ保存パスの明示。
- 非スコープ: `server/` 配下の実装変更、WildFly/Docker の再起動や設定反映、Secrets 配布。本 RUN ではコードや構成を変更しない。

## 5. タスク分解
- **共通エラーフォーマット草案**: 既存資料（`ORCA_API_STATUS.md`、`API_PARITY_MATRIX.md`、`MODERNIZED_REST_API_INVENTORY.md`, `TRACE_PROPAGATION_CHECK.md`）のエラー出力を収集し、HTTP ステータス、`code`、`message`、`blocker`、`orca.apiResult`、`details[]` の最小要素を定義。ORCA 200/Api_Result≠00 を 4xx/5xx へどう昇格させるかの判断基準を明文化。
- **監査ログポリシー草案**: `d_audit_event` / `trace_http_*` で必要なフィールド（TraceId/SpanId/RequestId/actor/facility/patientId masked/action/resource/payloadDigest/result/blocker）を整理し、マスク方針（患者IDハッシュ化、氏名/住所の部分マスク、自由記述の削除/ハッシュ化）と保持期間・保存先を記載。
- **ORCA エラーとの整合**: ORCA `Api_Result/Api_Error` → 共通 `code/message/blocker` への変換表を作成し、監査ログへ同じ追跡 ID を連携する手順をまとめる。`TrialEndpointMissing`/`TrialLocalOnly` など Blocker ラベルの付与基準もここで定義。
- **障害時サポート手順**: `docs/server-modernization/phase2/operations/logs/20251120T193040Z-error-audit.md` を作成し、ログ採取対象（WildFly server.log、trace/metrics、httpdump）、収集コマンド例、再現追従に必要な環境変数/ヘッダー依存を RUN_ID 付きでテンプレ化。GUI/ネットワーク制約時の代替策も記す。
- **証跡配置と連携**: 本 RUN_ID 用の artifacts 置き場（`artifacts/error-audit/20251120T193040Z/`）とログファイルを定義し、DOC_STATUS・ハブ文書へ同日付で反映できるよう準備する。

## 6. Definition of Done
- DoD-1: 共通エラーフォーマット草案を本ドキュメントに記載し、ORCA/内部例外のマッピングと Blocker ラベル付け基準を示している。
- DoD-2: 監査ログポリシー草案に必須フィールド・マスク方針・追跡 ID 連携ルール・保存/保持先を明記し、関連 Runbook への連携ポイントを列挙している。
- DoD-3: 障害対応手順ログ `docs/server-modernization/phase2/operations/logs/20251120T193040Z-error-audit.md` を作成し、収集パス/再現手順/連絡テンプレを RUN_ID 付きで残している。
- DoD-4: `docs/web-client/planning/phase2/DOC_STATUS.md` の該当行へ RUN_ID と更新内容を追記し、必要に応じて `docs/server-modernization/phase2/INDEX.md` などハブとの整合準備ができている。

## 7. ログ・証跡運用
- ログ: `docs/server-modernization/phase2/operations/logs/20251120T193040Z-error-audit.md`
- アーティファクト（必要時作成）: `artifacts/error-audit/20251120T193040Z/`
- DOC_STATUS: 「モダナイズ/監査・エラーハンドリング」行を追加し、本 RUN_ID とログパスを備考に記載する。

## 8. 進行メモ
- 本タスクは 04_ドメイン実装仕上げの成果を前提とし、API 契約/エラートーンの整合チェックは同ドキュメントのスコープを尊重して行う。
- ORCA Trial 依存の Blocker は 06/07 以降の実測タスクと連携し、本 RUN では Spec ベースの整合に留める。

## 9. 更新履歴
- 2025-11-20: 初版作成（計画のみ、サーバーコード/設定変更なし）。
