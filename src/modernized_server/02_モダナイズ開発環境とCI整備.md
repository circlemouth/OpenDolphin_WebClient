# 02_モダナイズ開発環境と CI 整備 ✓

- RUN_ID: `20251120T053902Z`
- 期間: 2025-11-24 09:00 〜 2025-11-27 09:00 (JST)
- 優先度: High / 緊急度: Medium
- エージェント: gemini cli

## 参照チェーン（遵守）
1. `AGENTS.md`
2. `docs/web-client/README.md`
3. `docs/server-modernization/phase2/INDEX.md`
4. `docs/managerdocs/PHASE2_MANAGER_ASSIGNMENT_OVERVIEW.md`
5. 関連チェックリスト: `docs/managerdocs/PHASE2_SERVER_FOUNDATION_MANAGER_CHECKLIST.md`

## 禁止事項 / 前提
- `server/` 配下やサーバースクリプトの変更は禁止。Legacy 資産（`client/` `common/` `ext_lib/`）は参照のみ。
- Python スクリプトの実行は禁止（明示指示がある場合のみ例外）。
- ORCA 接続は WebORCA トライアル (`https://weborca-trial.orca.med.or.jp/`, BASIC=`trial`/`weborcatrial`) のみ。`curl --cert-type P12` や本番証明書・ローカル ORCA コンテナは禁止。
- 秘匿情報は Git 管理しない。`.env` ひな型や README への記載はダミー値・取り扱いルールの明文化に限定する。

## ゴール
- `docker-compose.modernized.dev.yml` を基準にローカル開発環境を再構成し、既存 compose との差異・環境依存点をドキュメント化する。
- CI でのビルド・単体テスト・lint を安定化させ、失敗時の再現手順を README に追記できる状態にする。
- 秘匿情報の取り扱いルールを再点検し、`.env` ひな型（ドキュメントのみ）を更新して漏洩リスクを下げる。

## スコープ / 非スコープ
- スコープ: モダナイズ版開発環境構成の整理、CI パイプラインの再現性確保、秘密情報ハンドリングのガイド更新。
- 非スコープ: `server/` 以下のコード変更や本番証明書運用、Legacy 資産の改修、実運用インフラの変更。

## 期待アウトプット（DoD）
1. 開発環境: `docker-compose.modernized.dev.yml` を起点にした起動手順・差分表・主要環境変数の説明が整理されたドキュメント（候補: `docs/server-modernization/phase2/operations/` 配下）。
2. CI: `npm run build` / `npm test` / `npm run lint`（必要に応じて `npm run typecheck`）の安定実行条件と失敗再現手順が README に追記され、CI ログとの突き合わせ手順が明記されている。
3. Secrets: `.env.example` 相当のテンプレートが更新され、ダミー値と保存・配布ルール、Git へコミットしてはいけない項目が明文化されている（コードは無変更）。
4. RUN_ID: 本メモに記載の RUN_ID=`20251120T053902Z` を関連ログ・備考に共通適用し、必要に応じて DOC_STATUS を更新できる状態にする。

## タスク分解
- **A. 開発環境再構成（compose ベースライン）**
  - `docker-compose.modernized.dev.yml` のサービス・ボリューム・環境変数を棚卸しし、現行との相違点を表形式で整理。
  - 起動手順・依存ツール（Docker Desktop / WSL / helper サービスなど）の最小セットを確認し、ブロッカーがあれば `SERVER_MODERNIZED_STARTUP_BLOCKERS.md` との整合をとる。
  - 差分ドキュメント（例: `docs/server-modernization/phase2/operations/<RUN_ID>-modernized-dev.md`）を作成。
- **B. CI 安定化（build / test / lint）**
  - CI で実行されるコマンドとローカル再現手順を確認し、失敗パターンの FAQ を `README` か専用 Runbook に追記。
  - 依存キャッシュ・環境変数・ネットワーク要件などの前提を列挙し、再現テンプレート（ログ採取・コマンド例）を用意。
- **C. 秘匿情報取り扱いの再点検**
  - `.env` ひな型の項目（API エンドポイント、認証情報、署名キーなど）を棚卸しし、ダミー値と取り扱いルールを更新。
  - `SECURITY_SECRET_HANDLING.md` ほか既存ガイドとの整合を確認し、更新差分をドキュメントに限定する（サーバーコードは変更しない）。

## 成果物と更新対象
- 本ファイル（計画・DoD・タスク分解）
- 回収ログ: `docs/server-modernization/phase2/operations/logs/20251120T053902Z-modernized-dev.md`（作業ログが発生した場合に作成）
- 参考更新候補: `docs/server-modernization/phase2/operations/SECURITY_SECRET_HANDLING.md`, `docs/server-modernization/phase2/operations/LOCAL_BACKEND_DOCKER.md`, `README.md`（CI 再現手順セクション）
- DOC_STATUS: 「モダナイズ/基盤」行へ RUN_ID と備考を連携（必要に応じて）

## スケジュール目安
- 11/24 (Day1): compose 差分棚卸し・ブロッカー確認、差分ドラフト作成。
- 11/25 (Day2): CI 再現手順収集、失敗パターン整理、README 追記案作成。
- 11/26 (Day3): `.env` ひな型改訂案と Secret 取扱いルール整合性確認、DoD チェック。
- 11/27 09:00 まで: 未完タスクの引き継ぎメモとワーカー報告準備。

## リスクと留意点
- Docker 環境差異（WSL/Intel/Apple Silicon）での再現性低下に注意。差分表に CPU/OS 条件を記録する。
- CI 環境のキャッシュやリソース制限によりローカル再現が困難な場合、代替ログ採取手順を提示する。
- 秘匿情報の値は絶対にコミットしない。ダミー値と取り扱い規約のみ記載し、既存ガイドと齟齬が出た場合は要レビュー。
