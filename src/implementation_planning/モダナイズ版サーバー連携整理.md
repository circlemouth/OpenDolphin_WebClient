# モダナイズ版サーバー連携整理

- RUN_ID: `20260103T100050Z`
- 目的: 非カルテ領域の未実装項目を server-modernized の契約として整理し、UI/サーバの責務境界を確定する。
- 前提: `src/implementation_planning/未実装項目の画面割当と実装箇所整理.md`

## 連携対象 API（UI 期待と契約）
### 共通: 観測メタ/監査メタの取り扱い
- リクエストヘッダ（web-client 自動付与）
  - `X-Run-Id`, `X-Trace-Id`, `X-Cache-Hit`, `X-Missing-Master`, `X-DataSource-Transition`, `X-Fallback-Used`
- レスポンスヘッダ（server-modernized 側で返却推奨）
  - `x-run-id`, `x-trace-id`, `x-cache-hit`, `x-missing-master`, `x-datasource-transition`, `x-fallback-used`
- レスポンスボディ共通（OutpatientMeta）
  - `runId`, `traceId`, `requestId`, `dataSourceTransition`, `cacheHit`, `missingMaster`, `fallbackUsed`, `fetchedAt`, `recordsReturned`, `outcome`, `auditEvent`

### Reception: 例外一覧・キュー状態
#### `/api01rv2/appointment/outpatient/*` (POST)
- 目的: 受付一覧・予約・来院状態を取得し、Reception テーブルへ反映
- リクエスト
  - `appointmentDate` (YYYY-MM-DD)
  - `keyword`, `departmentCode`, `physicianCode`, `page`, `size` (任意)
- レスポンス（UI が読むデータ）
  - `slots[]` / `reservations[]` / `visits[]` を許容
  - 各エントリに `patient.*` / `appointmentId` / `visitInformation` などの ORCA 形式を許容
  - `recordsReturned`, `page`, `size`, `hasNextPage`
  - `auditEvent` (action/outcome/details) を返却
- 監査メタ必須
  - `runId`, `dataSourceTransition`, `cacheHit`, `missingMaster`, `fallbackUsed`, `recordsReturned`
- server-modernized 現状
  - `/api01rv2/appointment/outpatient/*` ルートは未実装
  - 代替: `/orca/appointments/list` (OrcaAppointmentResource)
- 追加/置換方針
  - 互換ルートを `server-modernized/src/main/java/open/dolphin/rest/` に追加し、`/orca/appointments/list` をラップするか
  - UI の `appointmentCandidates` を `/orca/appointments/list` に置き換えて契約統一する

#### `/api01rv2/claim/outpatient` (POST)
- 目的: 受付/診療の請求バンドルとキュー状態を取得
- レスポンス（UI が読むデータ）
  - `claim:bundle` または `claimBundles[]`
  - `claim:information` または `claimInformation`（`status`）
  - `queue` / `queueEntries` / `queue.entries` のいずれか（キュー警告表示用）
  - `claimStatus` / `claimStatusText`
  - `auditEvent` (action/outcome/details)
- 監査メタ必須
  - `runId`, `dataSourceTransition`, `cacheHit`, `missingMaster`, `fallbackUsed`, `recordsReturned`
- server-modernized 現状
  - `OutpatientClaimResource` で `/api01rv2/claim/outpatient` 実装済み
  - `queueEntries` は未返却のため、ORCA キュー警告は空配列扱い
- 追加/修正ポイント
  - 必要であれば `queueEntries` を含める（Reception のキュー状態表示と一致させる）

### Patients: ORCA 反映状態
#### `/api01rv2/patient/outpatient/*` (POST)
- 目的: Patients 一覧の検索/表示
- リクエスト
  - `keyword`, `departmentCode`, `physicianCode`, `paymentMode` (任意), `runId`
- レスポンス
  - `patients[]`（`patientId`, `name`, `kana`, `birthDate`, `sex`, `phone`, `zip`, `address`, `insurance`, `memo`, `lastVisit`）
  - `recordsReturned`, `auditEvent`
- server-modernized 現状
  - `/api01rv2/patient/outpatient/*` ルートは未実装
  - 代替: `/orca/patients/*` (OrcaPatientBatchResource)
- 追加/置換方針
  - 互換ルートを新設して `patientIdList`/`patientBatch` を組み合わせるか
  - UI 側の検索 API を `/orca/patients/*` へ統一し、`fetchWithResolver` へ移行

#### `/orca12/patientmodv2/outpatient` (POST)
- 目的: 患者基本/保険情報の作成・更新・削除
- リクエスト（UI 送信）
  - `operation`: `create` | `update` | `delete`
  - `patient` 情報
  - `auditEvent`: `operation/runId/patientId/section/changedKeys/visitDate/...`
  - `runId`
- レスポンス
  - `runId`, `dataSourceTransition`, `cacheHit`, `missingMaster`, `fallbackUsed`, `auditEvent`, `patient`
- server-modernized 現状
  - `/orca12/patientmodv2/outpatient` ルートは未実装
- 追加/修正ポイント
  - `server-modernized/src/main/java/open/dolphin/rest/orca/` に新規リソースを追加し、`auditEvent` を返却

### Charts: 送信・印刷の監査メタ
#### `/orca21/medicalmodv2/outpatient` (POST)
- 目的: Charts の医療履歴/送信前提情報
- リクエスト
  - 空ボディを許容
- レスポンス
  - `outpatientList[]`, `recordsReturned`, `outcome`, `auditEvent`
  - `dataSourceTransition`/`runId` を返却
- server-modernized 現状
  - `OrcaMedicalModV2Resource` で実装済み

#### `/api01rv2/claim/outpatient` (POST)
- 目的: Charts の送信結果/印刷時の判定
- server-modernized 現状
  - `OutpatientClaimResource` で実装済み

### Administration: 配信
#### `/api/admin/config` (GET/PUT) / `/api/admin/delivery` (GET)
- 目的: 配信・環境フラグの取得/保存
- リクエスト
  - `PUT /api/admin/config`: `orcaEndpoint`, `mswEnabled`, `useMockOrcaQueue`, `verifyAdminDelivery`, `chartsDisplayEnabled`, `chartsSendEnabled`, `chartsMasterSource`
- レスポンス（共通）
  - ボディ: `runId`, `orcaEndpoint`, `mswEnabled`, `useMockOrcaQueue`, `verifyAdminDelivery`, `chartsDisplayEnabled`, `chartsSendEnabled`, `chartsMasterSource`, `deliveryId`, `deliveryVersion`, `deliveredAt`, `note`, `environment`, `deliveryMode`, `source`, `verified`
  - ヘッダ: `x-environment`, `x-delivery-mode`, `x-admin-delivery-verification`, `x-orca-queue-mode`, `x-run-id`
- server-modernized 現状
  - `/api/admin/*` ルートは未実装
- 追加/修正ポイント
  - `server-modernized/src/main/java/open/dolphin/rest/admin/` などに新規リソースを追加し、レスポンスヘッダを統一

#### `/api/orca/queue` (GET/DELETE)
- 目的: 配信キューの可視化/再送/破棄
- リクエスト
  - `GET /api/orca/queue?patientId=...`
  - `GET /api/orca/queue?patientId=...&retry=1`
  - `DELETE /api/orca/queue?patientId=...`
- レスポンス
  - `queue[]`, `runId`, `traceId`, `source`, `verifyAdminDelivery`
- server-modernized 現状
  - `/api/orca/queue` ルートは未実装

### 共通監査: auditEvent 永続化/検索
- 目的: UI の auditEvent を永続化し、画面内検索へ連携
- 想定 API（新設）
  - `POST /api/audit/event`: UI から送信する監査イベントを保存
  - `GET /api/audit/events?screenId=&patientId=&runId=&from=&to=`: 条件検索
- server-modernized 現状
  - `AuditTrailService` は存在するが、REST での検索/参照は未提供
- 追加/修正ポイント
  - `server-modernized/src/main/java/open/dolphin/rest/AuditEventResource.java` を追加し、`AuditTrailService` から検索できる API を実装
  - `auditEvent` の JSON を返却し、UI の `auditEvent` 表示/検索に一致させる

## server-modernized 側の追加/修正ポイント整理
- 未実装 REST ルート
  - `/api01rv2/appointment/outpatient/*`
  - `/api01rv2/patient/outpatient/*`
  - `/orca12/patientmodv2/outpatient`
  - `/api/admin/config` `/api/admin/delivery`
  - `/api/orca/queue`
  - `auditEvent` 永続化/検索 API
- 既存実装の補完
  - `OutpatientClaimResource` に `queueEntries` を追加するか、別 API で連携
  - auditEvent の `details` に `screenId`, `patientId`, `appointmentId` を含める

## UI 側の API 置換/追加実装チェックリスト
- [ ] Reception/Patients/Charts の `fetchWithResolver` 統一（Patients は `httpFetch` から移行）
- [ ] `appointmentCandidates` を server-modernized の実装ルートへ切替（互換ルート or `/orca/appointments/list`）
- [ ] Patients の検索 API を `/api01rv2/patient/outpatient/*` または `/orca/patients/*` に整理
- [ ] Patients の保存 API `/orca12/patientmodv2/outpatient` と `auditEvent` 返却の整合
- [ ] Administration の `/api/admin/*` と `/api/orca/queue` を server-modernized と接続
- [ ] `auditEvent` の永続化 API を呼び出す共通モジュールを追加
- [ ] `dataSourceTransition/cacheHit/runId` を UI と auditEvent の双方に必ず反映
- [ ] エラー時の ToneBanner/例外一覧の表示条件を API レスポンスに合わせて更新

## 参照
- `web-client/src/features/reception/api.ts`
- `web-client/src/features/patients/api.ts`
- `web-client/src/features/charts/api.ts`
- `web-client/src/features/administration/api.ts`
- `web-client/src/features/outpatient/fetchWithResolver.ts`
- `server-modernized/src/main/java/open/dolphin/rest/OutpatientClaimResource.java`
- `server-modernized/src/main/java/open/dolphin/rest/orca/OrcaMedicalModV2Resource.java`
- `server-modernized/src/main/java/open/dolphin/orca/rest/OrcaAppointmentResource.java`
- `server-modernized/src/main/java/open/dolphin/orca/rest/OrcaPatientBatchResource.java`
