# エラーハンドリング・リトライ整備（predeploy readiness）

- RUN_ID: `20251221T073000Z`
- 期間: 2025-12-26 09:00 - 2025-12-27 09:00 (JST)
- 優先度: medium / 緊急度: medium
- YAML ID: `src/predeploy_readiness/02_feature_implementation/エラーハンドリング・リトライ整備.md`

## 目的
- サーバー側の統一エラーハンドリングと再試行戦略を確立する。
- 既存クライアント（Charts 規約・Reception 等）の期待値と整合させる。

## 対応内容
- REST 例外の統一マッピングを追加し、JSON エラー形式を **全例外で標準化**。
- 5xx / タイムアウト / 上流断のケースは `retryable=true` を付与し、UI 側の再試行判断と整合させる。
- ORCA wrapper 由来の例外を `502 Bad Gateway` に正規化し、`orca_gateway_error` を返却する。
- 既存の `WebApplicationException` は、JSON エラーを持つ場合はそのまま返し、**非 JSON 応答時のみ**共通形式に変換する。
- `validationError`/`field`/`details` を追加し、400/422 のバリデーション情報を可能な範囲で補完する。
- `exceptionClass` のレスポンス露出を廃止し、ログ側のみで保持する。
- 404/409/412 は `reason` を付与し、クライアントの理由表示と整合させる。

## 変更ファイル
- `server-modernized/src/main/java/open/dolphin/rest/RestExceptionMapper.java`
- `src/predeploy_readiness/02_feature_implementation/エラーハンドリング・リトライ整備.md`（本ドキュメント）

## 期待されるレスポンス例（共通）
- `error` / `code` / `message` / `status` / `traceId` を共通で返す。
- 400/422 では `validationError=true` と `field`/`details` を可能な範囲で付与する。
- `retryable=true` は 408 / 429 / 500 / 502 / 503 / 504 のみ付与。
- 404/409/412 では `reason` を付与する。

## 留意点
- Phase2 ドキュメントは Legacy/Archive のため更新しない。
- ORCA 実環境接続や Stage/Preview 検証は本タスクでは未実施。

## 差分実装内容
- 非 JSON の `WebApplicationException` で `message` 抽出を行い、共通エラー形式に統一。
- 400/422 の際に `validationError` / `field` / `details` を追加し、`field` はメッセージから抽出。
- 404/409/412 は `reason` を付与。
- `details.exceptionClass` を削除し、例外クラスはログのみで追跡。
- 412 の `error`/`code` を `precondition_failed` に統一。

## 未対応事項
- 実機/API レベルでの相互接続検証（Stage/Preview）は未実施。
- 422 の発生条件整理と server 側の明示的な発火ポイント整理は未着手。

## 確認結果（コードレビュー観点）
- [ ] 400/422 で `validationError`/`field`/`details` が返る経路を確認（例: `BadRequestException` 経由）
- [ ] 404/409/412 で `reason` が返ることを確認
- [ ] 非 JSON `WebApplicationException` が JSON に統一されることを確認
- [ ] `exceptionClass` がレスポンスに含まれないことを確認
