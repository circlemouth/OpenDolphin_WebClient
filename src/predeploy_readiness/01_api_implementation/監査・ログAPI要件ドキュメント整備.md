# 監査・ログAPI要件ドキュメント（2025-12-20）

## 目的
監査・ログAPI補完の前提となる要件（必須監査イベント、必須フィールド、失敗時の errorMessage 方針、traceId/requestId 運用）を整理し、後続の実装タスクで参照する単一の前提を確立する。

## 参照ソース（単一参照元 + Legacy 参照なし）
- 単一参照元: `docs/DEVELOPMENT_STATUS.md`
- 注記: Phase2 文書は Legacy/Archive であり、本ドキュメントでは参照・更新しない。

---

## 1. 対象範囲
- 対象: Web クライアントとモダナイズ版サーバー間の API 連携に関わる監査イベントと運用ログ。
- 非対象: Legacy サーバー/Legacy クライアントの保守、Phase2 文書の更新。

## 2. 監査イベントの必須カテゴリ
監査イベントは「誰が・いつ・何を・どの結果で・どの経路で」を再現できることが目的。以下のカテゴリは **必須** とする。

1. 認証/セッション
   - ログイン成功/失敗、セッション開始/終了、権限不足による拒否。
2. 患者コンテキスト
   - 患者選択/切替、受診コンテキスト開始/終了、予約/受付単位の状態遷移。
3. 診療データ操作
   - カルテ作成/更新/削除、診療情報の送信/再送/取消、ドラフト保存/復元。
4. ORCA 連携
   - 送信/取得/同期、キュー投入/再試行/失敗、ORCA 連携エラー。
5. 管理/配信
   - 管理設定の参照/更新、配信設定の検証/適用、運用切替操作。
6. 出力/エクスポート
   - 印刷、帳票生成、エクスポート/ダウンロード。
7. 失敗/例外
   - 上記いずれかで失敗した操作（原因が外部依存であっても必須）。

## 3. 監査イベント必須フィールド
監査イベントの payload は **最小情報で追跡可能** であることを要求する。

### 3.1 必須フィールド一覧
- `eventId`: 監査イベントの一意 ID（サーバー生成）。
- `occurredAt`: ISO-8601（UTC）での発生時刻。
- `action`: 監査イベントの操作種別（定義済み語彙）。
- `outcome`: `success | failure | blocked | started` のいずれか。
- `actor`: 操作者の識別子（`userId` など）。
- `actorRole`: 操作者のロール（監査閲覧で必要）。
- `facilityId`: 施設コンテキスト（環境を跨いだ追跡に必須）。
- `source`: `webclient | server | batch | external` のいずれか。
- `traceId`: 追跡 ID（後述の運用ルールに従う）。
- `requestId`: リクエスト単位 ID（後述の運用ルールに従う）。
- `target`: 監査対象の識別子（`patientId` / `appointmentId` / `karteId` などのいずれか、該当が無い場合は `null` を明示）。
- `details`: 監査詳細（最小限の構造化オブジェクト）。

### 3.2 個人情報の取り扱い
- `details` には **氏名・住所・保険情報などの直接識別子を含めない**。
- 追跡に必要な ID のみ許可（`patientId` / `appointmentId` / `documentId` など）。

## 4. action / outcome の語彙ルール
- `action` は **Web クライアントとサーバーで共通語彙** を持つこと。
- `outcome` は `success | failure | blocked | started` の固定。
- 例: `PATIENT_SWITCH`, `CHART_UPDATE`, `ORCA_SEND`, `DELIVERY_VERIFY`, `PRINT_OUTPATIENT`。

## 5. traceId / requestId 運用要件
### 5.1 生成と伝播
- `traceId`: 外側（Web クライアント or API gateway）が生成し、全リクエストに伝播する。
- `requestId`: サーバーがリクエスト単位で生成する（`traceId` と異なる値）。

### 5.2 ヘッダー運用
- 送信ヘッダー: `X-Trace-Id` を必須。
- 受信ヘッダー: `X-Request-Id` をレスポンスに必須で返却。
- Web クライアントは `X-Request-Id` を監査イベントに格納する。

### 5.3 ログ相関
- 監査イベント・運用ログ・エラーレスポンスは **同一の `traceId` / `requestId` で相関可能** とする。

## 6. 失敗時の errorMessage 方針
### 6.1 API レスポンス規約
- 失敗時は以下を **必須** で返却する。
  - `errorCode`: 安定したコード（文字列）。
  - `errorMessage`: UI 表示可能な説明文（機微情報/スタックトレースを含めない）。
  - `traceId` / `requestId`: 相関用 ID。
  - `httpStatus`: HTTP ステータス。

### 6.2 ログ側の詳細
- 内部ログには `errorDetail`（例外クラス、スタックトレース、下流 API 応答）を記録するが、**API レスポンスには含めない**。
- `errorMessage` は診療情報・個人情報・認証情報を含まないこと。

## 7. 監査ログ API の機能要件
- **登録 API**: 監査イベントを受理し、`eventId` を発行する。
- **検索 API**: 期間・`action`・`outcome`・`actor`・`patientId` でフィルタ可能。
- **取得 API**: `eventId` 単位で詳細取得可能。
- **権限制御**: 管理者/監査閲覧権限のみアクセス可能。

## 8. 非機能要件（最小）
- 監査ログは **改ざん検知が可能** であること（追記のみ・削除不可が前提）。
- 監査ログの保管は **長期保持** を想定し、削除/匿名化は運用規程に従う。
- `occurredAt` はサーバー基準時刻で統一する。

## 9. 後続タスクへの前提
本書は「監査・ログAPI補完」実装の前提要件であり、後続タスクは **本書の必須項目を満たすこと** を実装/テスト条件とする。

---

## 作成した要件ドキュメントのパス
- `src/predeploy_readiness/01_api_implementation/監査・ログAPI要件ドキュメント整備.md`
