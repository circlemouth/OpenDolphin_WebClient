services:
  app:
    image: mcr.microsoft.com/devcontainers/base:jammy
    volumes:
      - ..:/workspaces/${localWorkspaceFolderBasename:-OpenDolphin_WebClient}:cached
    command: sleep infinity
  db-modernized:
    image: postgres:14
    container_name: opendolphin-postgres-modernized
    environment:
      POSTGRES_DB: ${MODERNIZED_POSTGRES_DB:-opendolphin_modern}
      POSTGRES_USER: ${MODERNIZED_POSTGRES_USER:-opendolphin}
      POSTGRES_PASSWORD: ${MODERNIZED_POSTGRES_PASSWORD:-opendolphin}
      POSTGRES_HOST_AUTH_METHOD: ${MODERNIZED_POSTGRES_HOST_AUTH_METHOD:-md5}
      POSTGRES_INITDB_ARGS: ${MODERNIZED_POSTGRES_INITDB_ARGS:---auth-host=md5 --auth-local=trust}
      TZ: Asia/Tokyo
    ports:
      - "${MODERNIZED_POSTGRES_PORT:-55432}:5432"
    volumes:
      - postgres-data-modernized:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER"]
      interval: 10s
      timeout: 5s
      retries: 5

  server-modernized-dev:
    profiles:
      - modernized-server
    build:
      context: ..
      dockerfile: ops/modernized-server/docker/Dockerfile
    platform: linux/amd64
    container_name: opendolphin-server-modernized-dev
    depends_on:
      db-modernized:
        condition: service_healthy
    environment:
      DB_HOST: ${MODERNIZED_DB_HOST:-db-modernized}
      DB_PORT: ${MODERNIZED_DB_PORT:-5432}
      DB_NAME: ${MODERNIZED_POSTGRES_DB:-opendolphin_modern}
      DB_USER: ${MODERNIZED_POSTGRES_USER:-opendolphin}
      DB_PASSWORD: ${MODERNIZED_POSTGRES_PASSWORD:-opendolphin}
      DB_SSLMODE: ${MODERNIZED_DB_SSLMODE:-prefer}
      DB_SSLROOTCERT: ${MODERNIZED_DB_SSLROOTCERT:-}
      PLIVO_AUTH_ID: ${PLIVO_AUTH_ID:-}
      PLIVO_AUTH_TOKEN: ${PLIVO_AUTH_TOKEN:-}
      PLIVO_SOURCE_NUMBER: ${PLIVO_SOURCE_NUMBER:-}
      PLIVO_BASE_URL: ${PLIVO_BASE_URL:-https://api.plivo.com/v1/}
      PLIVO_ENVIRONMENT: ${PLIVO_ENVIRONMENT:-production}
      PLIVO_LOG_LEVEL: ${PLIVO_LOG_LEVEL:-NONE}
      PLIVO_LOG_MESSAGE_CONTENT: ${PLIVO_LOG_MESSAGE_CONTENT:-false}
      PLIVO_DEFAULT_COUNTRY: ${PLIVO_DEFAULT_COUNTRY:-+81}
      FACTOR2_AES_KEY_B64: ${FACTOR2_AES_KEY_B64:-b3BlbmRvbHBoaW4tZGV2LWZhY3RvcjIta2V5LTMyYnl0ZXM=}
      FIDO2_RP_ID: ${FIDO2_RP_ID:-localhost}
      FIDO2_RP_NAME: ${FIDO2_RP_NAME:-OpenDolphin Dev}
      FIDO2_ALLOWED_ORIGINS: ${FIDO2_ALLOWED_ORIGINS:-https://localhost:8443,http://localhost:9080}
      TZ: Asia/Tokyo
    ports:
      - "${MODERNIZED_APP_HTTP_PORT:-9080}:8080"
      - "${MODERNIZED_APP_ADMIN_PORT:-9995}:9990"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -sf -H \"userName: ${SYSAD_USER_NAME:-1.3.6.1.4.1.9414.10.1:dolphin}\" -H \"password: ${SYSAD_PASSWORD:-36cdf8b887a5cffc78dcd5c08991b993}\" http://localhost:8080/openDolphin/resources/dolphin || exit 1"
        ]
      interval: 30s
      timeout: 10s
      retries: 5

volumes:
  postgres-data-modernized:
