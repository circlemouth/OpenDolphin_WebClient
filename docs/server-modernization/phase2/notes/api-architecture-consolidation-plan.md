# Webクライアント/サーバー間 API接続状況と統合計画

**作成日**: 2026-01-15
**RUN_ID**: 20260115T195100Z
**対象**: Webクライアント (`web-client`) および モダナイズ版サーバー (`server-modernized`)

## 1. 調査背景と結論

「サーバーに実装されたAPIの多くがWebクライアントから未使用である」という報告に基づき、Webクライアントのソースコードとサーバーの実装状況を詳細に調査しました。

### 結論
*   **機能未接続ではない**: 主要な業務機能（予約、受付、患者検索）はWebクライアントに実装済みであり、正常に動作しています。
*   **利用エンドポイントの乖離**: Webクライアントはサーバー上の最新設計API（`/orca/...`）ではなく、**ORCA互換API（`/api01rv2/...`）** を使用しています。
*   **二重実装の状態**: サーバー側には「Webクライアント用のORCA互換レイヤー（`/api01rv2`）」と「最新設計のネイティブAPI（`/orca`）」が共存しており、内部ロジック（Service層）は共有されています。

---

## 2. APIアーキテクチャの現状分析

現状のシステムには、以下の2系統のAPIエンドポイントが存在します。

| API系統 | パス | 特徴・現状 | 歴史的経緯 |
| :--- | :--- | :--- | :--- |
| **ORCA互換API** | `/api01rv2/...` | **Webクライアントが現在使用中**。ORCA公式Web APIの仕様に合わせ、パラメータ名やレスポンス構造を模倣したラッパー。 | **完全な独自実装**。OpenDolphin Legacyには存在せず、今回のモダナイゼーション過程でWebクライアントに合わせて追加実装された「異物」。維持コストが高い。 |
| **Dolphin標準API**| `/orca/...` | **サーバー側の推奨実装（現在は未使用）**。Legacyサーバーの `open.orca.rest` をベースにJAX-RS/Jacksonでモダナイズしたもの。 | **Legacy由来の正統進化**。Legacyサーバーに同等のAPIが存在しており、本来Webクライアントはこれを使うべきであった。 |

### 発生経緯と根本原因
Gitログの調査により、以下の時系列で現在の「ねじれ構造」が発生したことが判明しました。

1.  **2025-12-11 (Web Client)**: クライアント開発側が、サーバー側の既存実装（`/orca/...`）を確認せず、ORCA公式仕様書をベースに `/api01rv2` への接続コードを先行実装。
2.  **2026-01-05 (Server)**: クライアントからの接続要求を受ける形で、サーバー側に急遽 `/api01rv2` を処理する互換レイヤー（`AppointmentOutpatientResource` 等）が追加実装される。

この「一時的な合わせ込み」が定着してしまっているのが現状です。したがって、単なるリファクタリングではなく、**「Webクライアントの実装を本来のDolphin標準APIに向ける修正」と「サーバー側の互換レイヤー撤去」という双方向の大掛かりな手術が不可避**となります。

### 構造上の課題
1.  **本来の設計からの乖離**: WebクライアントはLegacy由来の `/orca` APIを使うべきところを、なぜかORCA公式仕様 (`/api01rv2`) を模倣して実装されており、サーバー側での変換ロスを生んでいる。
2.  **業務機能内でのAPI混在リスク**: カルテ画面 (`Charts`) において、患者基本情報は `/api01rv2` (旧) で取得している一方、病名登録やオーダー入力は `/orca` (新) を使用しているという **「ちゃんぽん状態」** が確認されました。認証方式やエラーハンドリングの不統一により、部分的な機能不全（例：患者は表示されるが病名が保存できない）を引き起こす重大なリスクがあります。
3.  **無駄な変換処理**: クライアントが `/api01rv2` を叩くたびに、サーバー側で「ORCA仕様リクエスト → 内部DTO」への手動変換処理が走り、パフォーマンスとコード量の無駄が発生しています。
4.  **デッドコード**: サーバー側の `/orca/...` エンドポイントは、機能としては完成していますが、クライアントから呼ばれていないため実質的なデッドコードとなっています。

---

## 3. 推奨される統合・最適化プラン

システムの保守性とパフォーマンスを向上させるため、以下の段階的な移行を推奨します。

### 【Phase A: クライアントのAPI移行】（推奨）
Webクライアントの接続先を、ORCA互換APIから **Dolphin新API (`/orca/...`)** へ切り替えます。

*   **メリット**:
    *   パラメータ変換のオーバーヘッド削減によるサーバーパフォーマンス向上。
    *   型定義（One-to-Oneのマッピング）による堅牢性の向上。
    *   システム構成がシンプルになり、デバッグが容易になる。
*   **必要な作業**:
    1.  Webクライアント (`/features/*/api.ts`) のエンドポイント修正。
    2.  送信パラメータ名の修正（`keyword` → `medicalInformation` などDTO定義に合わせる）。
    3.  **注意点**: サーバー側DTO (`OrcaAppointmentListRequest` 等) に一部のフィルタ条件（`departmentCode` 等）が含まれていない場合があるため、必要に応じてサーバー側DTOへのフィールド追加を行う必要があります。

### 【Phase B: サーバー側 旧APIの削除】
Phase A完了後、サーバー側の `/api01rv2/...` 実装を削除します。

*   `AppointmentOutpatientResource.java` などの「ORCA互換ラッパー」を削除。
*   これにより、コードベースが大幅にスリム化されます。

---

## 4. API対照表（移行用リファレンス）

| 機能 | 現行 Client (`/api01rv2`) | 移行先 Target (`/orca`) | 備考 |
| :--- | :--- | :--- | :--- |
| **予約一覧** | `/api01rv2/appointment/outpatient/list` | `/orca/appointments/list` | パラメータ名変更あり |
| **予約登録** | `/api01rv2/appointment/outpatient` | `/orca/appointments/mutation` | |
| **患者検索** | `/api01rv2/patient/outpatient` | *`/orca/patients/name-search`* | ※機能が若干異なるため要検証（現在はローカル検索、新APIはORCA直接検索） |
| **受付一覧** | `/api01rv2/visitptlstv2` | `/orca/visits/list` | |

## 5. 患者検索機能に関する特記事項

*   **現状 (`/api01rv2/patient/outpatient`)**: ローカルDB (`PatientServiceBean`) を検索しています。
*   **新API (`/orca/patients/name-search`)**: ORCAサーバー (`OrcaWrapperService`) を直接検索する機能です。
*   **方針**: これらは「別機能」として扱うべきです。既存のローカル検索は維持しつつ、**「ORCAから患者を取り込む」新機能**として新APIを追加接続するのが正しいアプローチです。
