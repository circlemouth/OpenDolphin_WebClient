# Webクライアント/サーバー間 API接続状況と統合計画

**作成日**: 2026-01-15
**RUN_ID**: 20260115T195100Z
**対象**: Webクライアント (`web-client`) および モダナイズ版サーバー (`server-modernized`)

## 1. 調査背景と結論

「サーバーに実装されたAPIの多くがWebクライアントから未使用である」という報告に基づき、Webクライアントのソースコードとサーバーの実装状況を詳細に調査しました。

### 結論
*   **機能未接続ではない**: 主要な業務機能（予約、受付、患者検索）はWebクライアントに実装済みであり、正常に動作しています。
*   **利用エンドポイントの乖離**: Webクライアントはサーバー上の最新設計API（`/orca/...`）ではなく、**ORCA互換API（`/api01rv2/...`）** を使用しています。
*   **二重実装の状態**: サーバー側には「Webクライアント用のORCA互換レイヤー（`/api01rv2`）」と「最新設計のネイティブAPI（`/orca`）」が共存しており、内部ロジック（Service層）は共有されています。

---

## 2. APIアーキテクチャの現状分析

現状のシステムには、以下の2系統のAPIエンドポイントが存在します。

| API系統 | パス | 特徴・現状 |
| :--- | :--- | :--- |
| **ORCA互換API** | `/api01rv2/...` | **Webクライアントが現在使用中**。ORCA公式Web APIの仕様に合わせ、パラメータ名やレスポンス構造を模倣したラッパー。<br>※ **OpenDolphin Legacy由来のコードではありません。** モダナイズ版サーバーでクライアント向けに独自実装された互換レイヤーです。 |
| **Dolphin新API**| `/orca/...` | **サーバー側の推奨実装（現在は未使用）**。JAX-RSとJacksonを活用した型安全な設計。パラメータ解析のオーバーヘッドがなく、保守性が高い。 |

### 構造上の課題
1.  **無駄な変換処理**: クライアントが `/api01rv2` を叩くたびに、サーバー側で「ORCA仕様リクエスト → 内部DTO」への手動変換処理が走り、パフォーマンスとコード量の無駄が発生しています。
2.  **デッドコード**: サーバー側の `/orca/...` エンドポイントは、機能としては完成していますが、クライアントから呼ばれていないため実質的なデッドコードとなっています。
3.  **仕様の複雑化**: 同じ機能に対して入り口が2つあるため、将来的な機能改修時に修正漏れや挙動不一致のリスクがあります。

---

## 3. 推奨される統合・最適化プラン

システムの保守性とパフォーマンスを向上させるため、以下の段階的な移行を推奨します。

### 【Phase A: クライアントのAPI移行】（推奨）
Webクライアントの接続先を、ORCA互換APIから **Dolphin新API (`/orca/...`)** へ切り替えます。

*   **メリット**:
    *   パラメータ変換のオーバーヘッド削減によるサーバーパフォーマンス向上。
    *   型定義（One-to-Oneのマッピング）による堅牢性の向上。
    *   システム構成がシンプルになり、デバッグが容易になる。
*   **必要な作業**:
    1.  Webクライアント (`/features/*/api.ts`) のエンドポイント修正。
    2.  送信パラメータ名の修正（`keyword` → `medicalInformation` などDTO定義に合わせる）。
    3.  **注意点**: サーバー側DTO (`OrcaAppointmentListRequest` 等) に一部のフィルタ条件（`departmentCode` 等）が含まれていない場合があるため、必要に応じてサーバー側DTOへのフィールド追加を行う必要があります。

### 【Phase B: サーバー側 旧APIの削除】
Phase A完了後、サーバー側の `/api01rv2/...` 実装を削除します。

*   `AppointmentOutpatientResource.java` などの「ORCA互換ラッパー」を削除。
*   これにより、コードベースが大幅にスリム化されます。

---

## 4. API対照表（移行用リファレンス）

| 機能 | 現行 Client (`/api01rv2`) | 移行先 Target (`/orca`) | 備考 |
| :--- | :--- | :--- | :--- |
| **予約一覧** | `/api01rv2/appointment/outpatient/list` | `/orca/appointments/list` | パラメータ名変更あり |
| **予約登録** | `/api01rv2/appointment/outpatient` | `/orca/appointments/mutation` | |
| **患者検索** | `/api01rv2/patient/outpatient` | *`/orca/patients/name-search`* | ※機能が若干異なるため要検証（現在はローカル検索、新APIはORCA直接検索） |
| **受付一覧** | `/api01rv2/visitptlstv2` | `/orca/visits/list` | |

## 5. 患者検索機能に関する特記事項

*   **現状 (`/api01rv2/patient/outpatient`)**: ローカルDB (`PatientServiceBean`) を検索しています。
*   **新API (`/orca/patients/name-search`)**: ORCAサーバー (`OrcaWrapperService`) を直接検索する機能です。
*   **方針**: これらは「別機能」として扱うべきです。既存のローカル検索は維持しつつ、**「ORCAから患者を取り込む」新機能**として新APIを追加接続するのが正しいアプローチです。
