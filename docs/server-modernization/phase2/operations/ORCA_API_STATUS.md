# ORCA ↔ モダナイズ版サーバー API 差異サマリ（2025-11-19 Trial 切替）

> 接続手順・RUN_ID 発行・CRUD ログ運用は `ORCA_CONNECTIVITY_VALIDATION.md` §0 を参照。`tmp/orca-weekly-summary.*` の貼り付け位置や curl 雛形も同 Playbook のみを一次情報とする。
> RUN_ID=`20251116T173000Z`: Trial サーバーで POST/PHR API が禁止されている間は Spec-based 実装として扱い、最終段階で ORMaster／本番サーバー接続に切り替えて通信検証を行う。検証完了後に DOC_STATUS／Runbook／API_STATUS を同日更新する。

## API 状況とトライアル再検証方針

### 2.1 コア外来 API（Matrix No.1-18）
| No | ORCA API (class) | 直近期の実測 / RUN_ID | トライアル再検証＆CRUD 可否 | Spec-based until production validation |
| --- | --- | --- | --- | --- |
| 1 | `/api01rv2/patientgetv2` (`class=id`) | 2025-11-13 WebORCA 本番で `HTTP 404`（`RUN_ID=20251113TorcaP0OpsZ1/Z2`）。 | Trial では GET が開放されているため `curl -u trial:weborcatrial -H 'Accept: application/json' 'https://weborca-trial.orca.med.or.jp/api/api01rv2/patientgetv2?class=00&patientid=000001'` を実行し、レスポンス JSON と `Api_Result` を `artifacts/.../api01rv2_patientgetv2/` に保存する。参照系のみ（CRUD なし）。 | - |
| 2 | `/orca14/appointmodv2` (`class=01/02`) | 2025-11-13 WebORCA 本番で `HTTP 405`（`RUN_ID=20251113TorcaP0OpsZ1/Z2`）。2025-11-16 カバレッジ RUN（`RUN_ID=20251116T170500Z`）でも `HTTP/1.1 405 (Allow=OPTIONS,GET)` のままのため `[Spec-based]` として `artifacts/orca-connectivity/20251116T170500Z/coverage/coverage_matrix.md` に登録済み。 | Trial では予約 CRUD が許可される想定だが、POST 封鎖が続く限り実測不可。`artifacts/orca-connectivity/20251116T170500Z/blocked/README.md#appointmodv2`（trialsite §1）を参照し、POST 解放後に `docs/server-modernization/phase2/operations/logs/2025-11-19-orca-trial-crud.md` を更新する。 | RUN_ID=20251116T173000Z で Production/ORMaster (`curl -vv -u ormaster:ormaster .../orca14/appointmodv2`) 実測予定。計画: `docs/server-modernization/phase2/operations/logs/20251116T173000Z-prod-validation-plan.md#appointmodv2` |
| 3 | `/api21/medicalmodv2` (`class=01-03`) | 2025-11-13 WebORCA 本番で `HTTP 405`／`Api_Result=14`（`RUN_ID=20251113TorcaP0OpsZ1`, `20251113TorcaDoctorManualW60`）。 | Trial で診療行為を登録し、`curl -u trial:weborcatrial -H 'Content-Type: application/json; charset=Shift_JIS' --data-binary '@assets/orca-api-requests/03_medicalmodv2_request.json' 'https://weborca-trial.orca.med.or.jp/api21/medicalmodv2?class=01'` を実行。`trace/medicalmodv2_{request,response}.json` と ORCA UI の証跡を保存し、実際に登録された行為を API/画面で削除するまで記録する。CRUD OK（Trial のみ）。 | - |
| 4 | `/orca11/acceptmodv2` (`class=01/02`) | 2025-11-13 WebORCA 本番で `HTTP 405`（`RUN_ID=20251113TorcaP0OpsZ1/Z2`）。2025-11-16 カバレッジ RUN（`RUN_ID=20251116T170500Z`）で再検証しても `HTTP/1.1 405` が継続し `[Spec-based]` 扱い。Evidence: `artifacts/orca-connectivity/20251116T164300Z/crud/acceptmodv2/headers_*.txt`. | Trial 受付 CRUD は POST 開放待ち。`blocked/README.md#acceptmodv2` を参照し、Doctor/Patient seed 復旧＋Trial 設定変更後に実測へ切り替える。 | RUN_ID=20251116T173000Z で Production/ORMaster (`curl -vv -u ormaster:ormaster .../orca11/acceptmodv2`) 実測予定。計画: `docs/server-modernization/phase2/operations/logs/20251116T173000Z-prod-validation-plan.md#acceptmodv2` |
| 5 | `/api01rv2/acceptlstv2` (`class=01-03`) | 2025-11-13 WebORCA 本番で `Api_Result=00`（`RUN_ID=20251113TorcaP0OpsZ1/Z2/Z3`）。 | Trial でも同様の JSON を `curl -u trial:weborcatrial -H 'Content-Type: application/json; charset=Shift_JIS' --data-binary '@assets/orca-api-requests/05_acceptlstv2_request.json' 'https://weborca-trial.orca.med.or.jp/api01rv2/acceptlstv2?class=01'` で取得。取得結果は参照のみだが、Trial 側で受付 CRUD を行った後の差分を必ず記録する。 | - |
| 6 | `/api01rv2/appointlstv2` (`class=01`) | 2025-11-13 は測定対象外。 | Trial で予約一覧が取得できることを確認し、`RUN_ID=20251119TorcaTrialCrudZ1` 以降で `curl -u trial:weborcatrial .../api01rv2/appointlstv2?class=01` を取得。予約 CRUD 後の反映タイムラグを `artifacts/.../appointlstv2/Δtimestamp.md` へまとめる。 | - |
| 12 | `/api01rv2/medicalgetv2` (`class=01-04`) | 2025-11-16 Worker-C が Web クライアント向けラッパー `POST /orca/medical/records` を実装（RUN_ID=`20251116T170500Z`）。ORCA Trial POST は依然 405 のため、レスポンスはモダナイズ DB 上のカルテ履歴をエクスポートする **Spec-based implementation / Trial未検証**。Evidence: `docs/server-modernization/phase2/operations/logs/20251116T170500Z-orca-medical.md#1-実装サマリ`。 | Trial/本番で POST が開放され次第、`tmp/orca-weekly-summary.*` テンプレを使って ORCA XML→JSON 変換の整合を取る。ラッパーは既に稼働しているため、ORCA 側の `Api_Result` をレスポンスへ透過させること。 | - |
| 13 | `/api01rv2/diseasegetv2` (`class=01`) | 2025-11-16 RUN（`20251116T170500Z`）で `/orca/disease/import` ラッパーを更新。`KarteServiceBean#getDiagnosis` から返す差分を ORCA 互換 JSON に整形し、`AuditTrail` を付与。Trial POST は未検証のため `[Spec-based]`。 | Trial で POST が許可され次第、`docs/server-modernization/phase2/operations/ORCA_CONNECTIVITY_VALIDATION.md` §4.4 に沿って ORCA → モダナイズ DB の差分比較を実施し、`artifacts/orca-connectivity/<RUN_ID>/diseasegetv2/` へ証跡を保存。 | - |
| 14 | `/orca12/patientmodv2` | 2025-11-16 RUN（`20251116T170500Z`）で `/orca/patient/mutation` ラッパーを追加。create/update は `PatientServiceBean#addPatient/#update` を呼び出し、delete は Trial 禁止のため `Api_Result=79 (Spec-based)` を返却。 | Trial で POST が開放されるまでは削除系レスポンスに「Spec-based implementation / Trial未検証」を添える。Trial ORCA で削除が可能になったら `PatientServiceBean` に論理削除 API を追加し、証跡を `docs/server-modernization/phase2/operations/logs/` に残す。 | - |
| 17 | `/orca25/subjectivesv2` | 2025-11-16 RUN（`20251116T170500Z`）で `/orca/chart/subjectives` を Spec-based stub として実装。Trial では POST が閉じられているため `Api_Result=79`＋警告を返し、監査に `status=blocked` を記録。 | Trial で subjectives API が開放され次第、`OrcaSubjectiveResource` を ORCA XML 呼び出し＋`KarteServiceBean` への保存へ切り替える。 | - |

### 2.2 その他 API（Matrix No.19-53）
| API | 直近期の実測 / RUN_ID | トライアル再検証＆CRUD 可否 | Spec-based until production validation |
| --- | --- | --- | --- |
| `/api21/medicalmodv23` | 2025-11-13 WebORCA 本番 `HTTP 405`（`RUN_ID=20251113T002806Z`）。 | Trial では初診算定日の XML POST を受け付ける。`curl -u trial:weborcatrial -H 'Content-Type: application/xml; charset=Shift_JIS' --data-binary '@operations/assets/orca-api-requests/xml/46_medicalmodv23_request.xml' 'https://weborca-trial.orca.med.or.jp/api21/medicalmodv23?class=01'` を実行し、登録→取消までを CRUD ログに記録。 | - |
| `/orca06/patientmemomodv2` | 2025-11-13 本番 `HTTP 405`（`RUN_ID=20251113T002806Z`）。 | Trial では患者メモの登録/更新/削除が可能。XML テンプレを送信後に `Memo_ID` を控え、削除までの一連を `artifacts/.../patientmemomodv2/README.md` にまとめる。 | - |
| `/orca31/hspmmv2` | 2025-11-13 本番 `HTTP 405`。 | Trial では `Perform_Month` を指定した XML を POST し、`Api_Result=00` を取得できる。`RUN_ID=20251119TorcaTrialCrudZ2` で `curl -u trial:weborcatrial --data-binary '@operations/assets/orca-api-requests/xml/39_hspmmv2_request.xml' 'https://weborca-trial.orca.med.or.jp/orca31/hspmmv2'` を取得し、帳票 UI と突合。参照のみ。 | - |
| `/api01rv2/system01lstv2` | 2025-11-16 カバレッジ RUN（`RUN_ID=20251116T170500Z`）で管理メニューが閉鎖されていることを確認し `[Spec-based]` 登録。Evidence: `artifacts/orca-connectivity/20251116T170500Z/coverage/coverage_matrix.md`。 | Trial UI の 1010 システム管理メニューが非活性なため API 認証が通らず、診療科/職員マスタは ORMaster 環境待ち。`blocked/README.md#system01lstv2`（trialsite §1）を参照。 | Matrix No.11。RUN_ID=20251116T173000Z で ORMaster 管理メニュー解放後に `/orca/system/management` を再測（`...prod-validation-plan.md#system01lstv2`） |
| `/orca31/hsptinfmodv2` | 未実測（本番 405 想定）。 | Trial で入退院登録の CRUD を実施し、`Request_Number=08/09` の XML とレスポンスを保存。病棟コードは Trial UI で確認した値を利用し、書き込みログへ必ず Runbook 参照を追記する。 | - |
| `/orca31/hsacctmodv2` | 未実測（本番 405 想定）。 | Trial で外泊/食事/会計の作成・取消を順に実行。各 Request_Number ごとに `curl` コマンドと ORCA UI キャプチャを保存し、差分計算は `docs/server-modernization/phase2/operations/logs/2025-11-19-orca-trial-crud.md#hsacctmodv2` に記録。 | - |
| `/orca32/hsptevalmodv2` | 未実測（本番 405 想定）。 | Trial で ADL/医療区分データを XML で送信。登録後に `hsptevalv2` で読み戻し、CRUD 可否を確認する。 | - |
| `/orca101/manageusersv2` | 2025-11-16 カバレッジ RUN（`RUN_ID=20251116T170500Z`）で Trial UI が参照専用のままで POST 不可と判定し `[Spec-based]` 扱い。Evidence: `artifacts/orca-connectivity/20251116T170500Z/blocked/README.md#manageusersv2`。 | Trial では職員管理メニューがクローズされているため CRUD 実測不可。管理 API の解放 or ORMaster 環境が用意でき次第、ユーザー登録/削除を `docs/server-modernization/phase2/operations/logs/2025-11-19-orca-trial-crud.md` へ追記する。 | Matrix No.32。RUN_ID=20251116T173000Z で ORMaster 職員登録を `curl -vv -u ormaster:ormaster .../orca101/manageusersv2` で実施し、`...prod-validation-plan.md#manageusersv2` に証跡を残す |
| `/orca21/medicalsetv2` | 2025-11-16 RUN（`20251116T170500Z`）で `/orca/medical-sets` を Spec-based stub として実装。Trial POST は変わらず 405 のため `Api_Result=79`＋警告を返し、`docs/server-modernization/phase2/operations/logs/20251116T170500Z-orca-medical.md` に証跡を記録。 | Trial で診療セット API が開放されたら `OrcaMedicalAdministrationResource` を ORCA XML 経由の CRUD へ差し替え、`artifacts/.../medicalsetv2/` に CRUD ログを集約する。 | - |
| `/orca102/medicatonmodv2` | 2025-11-16 RUN（`20251116T170500Z`）で `/orca/tensu/sync` stub を追加。Trial では点数マスタ同期が封鎖されているため **Spec-based implementation / Trial未検証**。 | ORMaster or Trial で POST を再開できた際に `docs/server-modernization/phase2/operations/assets/orca-api-requests/07_medicatonmodv2_request.json` を利用して CRUD 証跡を採取する。 | - |
| `/orca31/birthdeliveryv2` | 2025-11-16 RUN（`20251116T170500Z`）で `/orca/birth-delivery` stub を実装し、`Api_Result=79` を返却。Trial UI で該当メニューが無効化されているため `[Spec-based]`。 | Trial UI が開放されるまでは stub のまま維持。開放後は公費組合せの CRUD ログを `docs/server-modernization/phase2/operations/logs/` へ追加し、ORCA API への POST/DELETE を実測する。 | - |
| `/orca22/diseasev2` | 2025-11-16 RUN（`20251116T170500Z`）で `/orca/disease` ラッパーの create/update/delete を実装。ORCA Trial 連携は未検証のため `[Spec-based]` とし、モダナイズ DB の差分のみを更新。 | Trial で POST が利用可能になったら、ORCA 側 `Api_Result` をレスポンスへ透過させ、`artifacts/orca-connectivity/<RUN_ID>/diseasev2/` に CRUD 証跡を保存。 | - |
| `/orca22/diseasev3` | 2025-11-16 RUN（`20251116T170500Z`）で `/orca/disease/v3` stub を追加。補足コメントや BaseMonth の検証は ORCA Trial で POST が開放されてから実施予定。 | Trial/ORMaster で API 解放後に `DiseaseMutationRequest` の v3 フィールドを ORCA 仕様と突き合わせて更新する。 | - |
| `/orca42/receiptprintv3` | 2025-11-16 カバレッジ RUN（`RUN_ID=20251116T170500Z`）の時点で `docs/server-modernization/phase2/operations/assets/orca-trialsite/raw/trialsite.md#お使いいただけない機能等` §4 により帳票印刷が禁止されているため `[Spec-based]`。Evidence: `artifacts/orca-connectivity/20251116T170500Z/blocked/README.md#receiptprintv3`。 | Trial 環境ではプリンタ出力・`push-exchanger`・`/blobapi` が利用できない。ローカル ORMaster で `/orca42/receiptprintv3` を実測し、結果を `docs/server-modernization/phase2/operations/logs/20251116T170500Z-coverage.md` 経由で共有する。 | Matrix No.42。RUN_ID=20251116T173000Z で ORMaster 帳票出力を `curl -vv -u ormaster:ormaster .../orca42/receiptprintv3` で採取し、`...prod-validation-plan.md#receiptprintv3` へ記録 |
| `/20/adm/phr/*` | Trial 404/405（RUN_ID=20251121TrialPHRSeqZ1-{A/B,CDE}、Blocker=`TrialEndpointMissing`）を継続記録。 | Spec-based のままモダナイズ REST で UI を維持しつつ、RUN_ID=20251116T173000Z で ORMaster `/20/adm/phr/` へ `curl -vv -u ormaster:ormaster --data-binary @payloads/phr_phase_prod.xml` を送信し通信検証を完了させる。 | RUN_ID=20251116T173000Z 計画（`docs/server-modernization/phase2/operations/logs/20251116T173000Z-prod-validation-plan.md#phr`）に沿って本番切替ログ/DNS/TLS 証跡を取得し、完了日に DOC_STATUS／Runbook／API_STATUS を同日更新する。 |

---

- 参考資料: [`assets/orca-api-spec/manifest.json`](assets/orca-api-spec/manifest.json)、[`logs/2025-11-13-orca-connectivity.md`](logs/2025-11-13-orca-connectivity.md)、[`notes/orca-api-field-validation.md`](../notes/orca-api-field-validation.md)、[`ORCA_HTTP_404405_HANDBOOK.md`](logs/ORCA_HTTP_404405_HANDBOOK.md)、[`MODERNIZED_REST_API_INVENTORY.md`](../../MODERNIZED_REST_API_INVENTORY.md)
