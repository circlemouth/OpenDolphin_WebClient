# 20251122T071146Z-metrics

## 目的
`src/modernized_server/10_オブザーバビリティと運用運転.md` に SLO/SLA 主要指標とログ設計方針を追補するための検討メモ。

## 追加内容サマリ
- 指標: API レイテンシ p95/p99、エラー率、ORCA 連携失敗率、ジョブ遅延/滞留、SSE 中断率、DB プール余裕度。
- 収集ポイント: Micrometer→Prometheus（job `modernized-api` / `async-worker`）、Undertow カスタムメトリクス、HikariCP Binder、Recording Rule 例を記載。
- ログ方針: 構造化 JSON、`requestId`/`traceId`/`facilityId` の必須化、`sha256(value + env_salt)` による PII マスク、Loki/Elastic 二重送信と保持期間統一（Loki14d/Elastic90d/Tempo7d/Prom30d）。
- アラート連携: A1〜A10 と同一の式・ラベルセットを使用し、デプロイ後 15 分抑止ラベル `deployed_within=15m` を共通化。

## 決定事項
- RUN_ID をルール名/ログ行に含め Evidence 追跡を容易にする方針を維持。
- 保存期間は最短値優先で評価窓を設定し、環境差異があれば本ログへ実測を追記する。

## 未完了/フォローアップ
- 環境ごとの実保持期間・ログローテーション設定の実測が未取得。次回のメトリクス収集タイミングで本ログに追記する。
