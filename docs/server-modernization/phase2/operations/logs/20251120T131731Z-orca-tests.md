# 2025-11-20 API と ORCA の結合テスト（RUN_ID=20251120T131731Z）

- 接続先: `https://weborca-trial.orca.med.or.jp/`（BASIC=`trial`/`weborcatrial`）。Python 不使用、`curl`/shell のみ。
- 目的: ドメイン別代表シナリオを自動化し、成功・失敗パターンを WebORCA trial で網羅。証跡を RUN_ID 付きで保存し、ORCA_API_STATUS と照合できる状態にする。
- 対象 API（例）: 受付/予約=`acceptlstv2`,`appointlstv2`、診療=`medicalmodv2`、帳票=`receiptprintv3`、PHR=`/20/adm/phr/*`、副作用確認=`system01dailyv2` など。必要に応じて追加。
- 証跡: `artifacts/orca-connectivity/20251120T131731Z/{automation,crud,coverage,blocked}`（本ログは雛形。実測時に追記）。

## 1. ドメイン別カバレッジ現況（既知結果の取り込み）
- 受付/予約: `/api01rv2/acceptlstv2`=HTTP200/Api_Result=13（doctor seed 不足）、`/api01rv2/appointlstv2`=HTTP200/Api_Result=12。POST 系 `/orca11/acceptmodv2` `/orca14/appointmodv2` は HTTP405 (Allow: OPTIONS, GET)。
- 診療: `/api/api21/medicalmodv2`=HTTP200/Api_Result=10（患者 seed 不足）。
- 帳票: `/orca42/receiptprintv3`=HTTP405（push/blobs 未構成）。
- PHR: `/20/adm/phr/*` は Trial 側 404/405（実装済だが未開放）。
- 副作用確認: `system01dailyv2` は Api_Result=91→91/00 変動があるため再測時にパラメータ固定が必要。

## 2. 自動化シナリオと実行手順
- `automation/run.sh`（雛形）に API ごとの payload/ヘッダーをまとめ、`--max-time`/`--retry` 等の共通オプションを環境変数で切り替えられるようにする。
- 例: `curl -s -u trial:weborcatrial -H 'Accept: application/xml' -H 'Content-Type: application/xml' --retry 2 --retry-all-errors --max-time 20 --data-binary @payloads/acceptlst_trial.xml https://weborca-trial.orca.med.or.jp/api01rv2/acceptlstv2?class=01`。
- 成功/失敗双方を保存するため、レスポンス XML/JSON、ヘッダー、curl ステータスを `crud/<api>/<timestamp>.*` へ保存する。404/405 も同様に evidence として扱う。
- カバレッジ表は `coverage/coverage_matrix.md` に API × シナリオ × 結果（200/403/404/405, Api_Resultxx, Blocker 理由）を追記する。

## 3. 既知の制約 / Blocker（ORCA_API_STATUS 連動）
- `TrialEndpointMissing`: `/20/adm/phr/*` 系は Trial 側でエンドポイント未開放。成功パス確認は Modernized 側 or ORMaster 環境で代替。
- `TrialLocalOnly` / HTTP405(Local): `/orca11` `/orca14` `/orca06` `/orca42` の POST が閉鎖。Allow ヘッダーと trialsite 禁止操作をログに残す。
- `DataSeedMissing`: doctor code `0001`, patient `00000001` が欠落。取得時は Api_Result=12/13/10 となるため、seed 後の再測を TODO に残す。
- `Timeout/Retries`: TLS/HTTP タイムアウトは `--max-time` と `--retry` を明示し、失敗時の期待挙動をログ化する。

## 4. 結果記入テンプレ（実測後に置換）
- `/api01rv2/acceptlstv2`: HTTP200 / Api_Result=13, Evidence=`crud/acceptlstv2/response_YYYYMMDDThhmmssZ.xml`。
- `/api01rv2/appointlstv2`: HTTP200 / Api_Result=12, Evidence=`crud/appointlstv2/response_YYYYMMDDThhmmssZ.xml`。
- `/api/api21/medicalmodv2`: HTTP200 / Api_Result=10, Evidence=`crud/medicalmodv2/response_YYYYMMDDThhmmssZ.xml`。
- `/orca11/acceptmodv2`: HTTP405, Evidence=`crud/acceptmodv2/headers_*.txt`。
- `/orca14/appointmodv2`: HTTP405, Evidence=`crud/appointmodv2/headers_*.txt`。
- `/orca42/receiptprintv3`: HTTP405, Evidence=`crud/receiptprintv3/headers_*.txt`。
- `/20/adm/phr/phaseA` etc.: HTTP404/405, Evidence=`crud/phr_phase*/response_*.json`。

## 5. 次アクション
- 実測結果を `coverage/coverage_matrix.md` と `blocked/README.md` に反映し、本ログのテンプレを実データへ置換。
- DOC_STATUS の該当行へ RUN_ID とログ/証跡パスを追記し、ハブ（README / INDEX）を同日付で更新する。
- ワーカー報告草案として、制約表と再開条件（seed投入・POST開放・PHR endpoint 開放）をまとめ、マネージャーチェックリストへ展開する。
