# 2025-11-20 ドメイン実装仕上げ計画ログ（RUN_ID=`20251120T061329Z`）

- スコープ: 計画整理のみ（サーバーコード変更・Docker操作なし）。参照チェーン: AGENTS → docs/web-client/README.md → docs/server-modernization/phase2/INDEX.md → docs/managerdocs/PHASE2_MANAGER_ASSIGNMENT_OVERVIEW.md。
- API 不足 / Blocker 抽出（会計・処方・予約）
  - Rsv-1: Matrix No.2/6/15（`/orca14/appointmodv2`、`/api01rv2/appointlstv2`、`/api01rv2/appointlst2v2`）は `OrcaAppointmentResource` 実装済みだが Trial 405 のため Blocker=`TrialLocalOnly`（Spec-based）。ORMaster 実測計画 RUN_ID=`20251116T173000Z` 依存。
  - Billing-1: Matrix No.16 `/api01rv2/acsimulatev2` → `POST /orca/billing/estimate` は `BillingSimulationRequest/Response` で実装済みだが Trial 送信不可。`claimBundles` 空なら 400 を返す仕様を維持し、実測は ORMaster 解放待ち。
  - Rx-1: PHR-01〜11（`/20/adm/phr/*`）は REST 未公開。Blocker=`TrialEndpointMissing`、Evidence=`20251121TrialPHRSeqZ1-{A/B,CDE}`。PHR-09（処方テキスト）を含むため処方領域の最優先。
  - Rx-2: `/orca102/medicatonmodv2`（点数マスタ同期）と `/orca21/medicalsetv2`（診療セット）を stub で `Api_Result=79` 返却中。Trial 405 により Spec-based 継続。
  - Rx-3: `DolphinResourceASP` 19 件 / `DemoResourceASP` 15 件（例: `/touch/module/rp/{param}`）が RESTEasy 未登録で全未整備。登録＋レスポンス整形方針を決める必要あり。
- 例外・バリデーション統一草案
  - ORCA ラッパーは ORCA `Api_Result/Api_Error` を基本 200 で透過しつつ、Trial 405/404 の場合は `status=blocked`・`blocker=TrialLocalOnly` を JSON に含めて監査へも記録（現行 stub 挙動とそろえる）。モダナイズ内例外は 4xx/5xx を返しつつ同メタデータを付与。
  - Content-Type 指針: `/api01rv2/system01dailyv2` 等 XML 系は `application/xml; charset=UTF-8` 固定（Shift_JIS は Api_Result=91）、予約/請求の JSON 系は `Accept/Content-Type` の明示を必須化。BASIC 認証は `trial/weborcatrial` に統一。
  - 入力必須: `BillingSimulationRequest.claimBundles` 非空・`performDate` は就診日±1 営業日、AppointmentMutation は `patientId/departmentCode/physicianCode/action` 必須、PHR Key/Token 系は facility 突合と `X-Access-Reason` 監査ヘッダーを必須にする。
- 単体テスト計画（実装不可なので方針のみ）
  - `OrcaAppointmentResource`/`OrcaWrapperService`: 405→`status=blocked` の透過、予約 DTO 変換（list/patient/mutation）の双方向を Mockito で検証。
  - `BillingSimulationResponseMapper` (`OrcaXmlMapper`): `claimBundles` 空で 400、ポイント計算の丸め、`mirroredClaimXml` 付与有無の2経路をカバー。
  - PHR 系: `PhrDataAssembler`/`TouchMedicationFormatter` の薬剤文言・禁忌語置換を固定フィクスチャでスナップショット化（PHR-09 先行）。
  - RESTEasy 登録テスト: `RestApplication` に DolphinResourceASP/DemoResourceASP を登録する回帰テストを追加し、未登録時に 404 になることを再現してから修正。
  - フレーク検知: `TZ=Asia/Tokyo mvn -f pom.server-modernized.xml -pl server-modernized -am test -DskipITs` を 2 回連続実行し `target/surefire-reports/*.xml` を比較。カバレッジは `mvn ... jacoco:report -DskipITs` で測定する計画（実行は別 RUN）。
- TODO: 本計画を `src/modernized_server/04_ドメイン実装仕上げと単体テスト完了.md` と `docs/web-client/planning/phase2/DOC_STATUS.md` へ同期し、完了報告時に Evidence パスを併記する。削除や CRUD 操作は実施していない。
