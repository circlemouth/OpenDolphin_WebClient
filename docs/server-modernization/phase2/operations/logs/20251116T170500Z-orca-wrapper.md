# 2025-11-16 ORCA Wrapper Stub 同期ログ（RUN_ID=20251116T170500Z）

## 1. コンテキスト
- 指示: 【ワーカー指示】ORCA ラッパー未実装 API 整備（RUN_ID=20251116T170500Z）に基づき、予約/請求/来院および患者同期 API をモダナイズ版サーバーから提供できるようラッパーを実装。
- 対象 ORCA API: `appointlstv2` / `appointlst2v2` / `acsimulatev2` / `visitptlstv2` / `patientlst1v2` / `patientlst2v2` / `patientlst3v2` / `patientlst6v2` / `patientlst8v2`。
- Trial 環境では POST 実測が禁止されているため **Blocker=TrialLocalOnly** とし、`orca/stub/*.sample.xml` から取得した payload を `StubOrcaTransport` で読み込み、DTO 変換フローのみ証跡化。

## 2. 実装・DTO
- 新規 REST リソース: `OrcaAppointmentResource`（予約/請求/来院系列）、`OrcaPatientBatchResource`（患者バッチ/保険/旧姓）。【F:server-modernized/src/main/java/open/dolphin/orca/rest/OrcaAppointmentResource.java†L40-L94】【F:server-modernized/src/main/java/open/dolphin/orca/rest/OrcaPatientBatchResource.java†L41-L105】
- サービス/Mapper: `OrcaWrapperService`（RUN_ID/Blocker 注入）、`OrcaXmlMapper`（Jackson XML→DTO）、`StubOrcaTransport`（スタブ読み込み）。【F:server-modernized/src/main/java/open/dolphin/orca/service/OrcaWrapperService.java†L35-L132】【F:server-modernized/src/main/java/open/dolphin/orca/converter/OrcaXmlMapper.java†L21-L188】【F:server-modernized/src/main/java/open/dolphin/orca/transport/StubOrcaTransport.java†L13-L33】
- DTO: `open.dolphin.rest.dto.orca.*` に Appointment/Patient/Billing/Insurance/FormerName 系を定義し、ORCA API payload と 1:1 でマッピング。

## 3. テスト
- コマンド: `mvn -pl server-modernized -Dtest=Orca*ResourceTest -DskipITs test`
- 内容: `OrcaAppointmentResourceTest` で予約/請求ラッパーの JSON 生成を検証し、`OrcaPatientBatchResourceTest` で ID リスト・バッチ・旧姓 API のバリデーション＆レスポンスを確認。
- 結果: すべて PASS（Trial 実測不可につきスタブベース）。

## 4. ドキュメント更新
- `docs/server-modernization/MODERNIZED_REST_API_INVENTORY.md` §7 → ORCA ラッパー行を「◎ 実装完了（Blocker=TrialLocalOnly, RUN_ID=20251116T170500Z）」で更新。
- `docs/server-modernization/phase2/domains/API_PARITY_MATRIX.md` → Matrix No.6/8/9/10/15/16/18/35 + 新規 No.51 を Implemented に変更。
- `docs/web-client/planning/phase2/DOC_STATUS.md` → ORCA Sprint2 行および関連ハブ文書の備考に本ログと RUN_ID を追記。

## 5. Blocker / フォローアップ
- Blocker: Trial 環境では ORCA Studio API の POST が禁止のため、実測 `Api_Result` は `StubOrcaTransport` で擬似的に算出。解除後に `OrcaTransport` 実装を切り替え、`ORCA_CONNECTIVITY_VALIDATION.md` §4 と照合する。
- Request: ORCA 接続チームは `ORCA_API_STATUS.md` に記載した `TrialLocalOnly` 行の解除条件（trialsite での POST 開放 or 公式 sandbox）を共有し、実測ログが取得でき次第本ログを更新する。
