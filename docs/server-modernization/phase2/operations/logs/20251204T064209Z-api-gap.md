# RUN_ID=20251204T064209Z API ギャップ清書

期間: 2025-12-04 00:00 - 2025-12-04 09:00 (JST)

## 概要
- `src/outpatient_ux_modernization/03_モダナイズAPIマッピング.md` に Reception/Charts/Patients/Administration の外来 API（`/api01rv2/claim/outpatient/*`、`/api01rv2/appointment/outpatient/*`、`/orca12/patientmodv2/outpatient`、`/orca21/medicalmodv2/outpatient`）のレスポンス設計と `auditEvent` フィールドの要件を整理した。
- `docs/server-modernization/phase2/foundation/IMPACT_MATRIX.md` の優先領域・`docs/server-modernization/phase2/operations/orca-master-sprint-plan.md` の meta 契約を踏まえて、`runId/dataSource/cacheHit/missingMaster/fallbackUsed/dataSourceTransition/fetchedAt` をすべてのレスポンス `details` に透過することを明示した。

## ギャップ
1. `/api01rv2/claim/outpatient/*` および `/api01rv2/appointment/outpatient/*` は現行 `KarteResource`/`OrcaAppointmentResource` が `recordAudit` を実行していないため `d_audit_event` に `claim`/`appointment` 系 `action` が記録されていない。`auditEvent.details` に `facilityId`/`patientId`/`appointmentId`/`claimBundles` 等を追加する設計を検討してほしい。
2. `Orca` 側から回帰的に返される HTTP ボディに `dataSource` 系 metadata（`runId` を含む common field set）を埋め込む実装がまだ安定していないため、UI 側で `missingMaster`/`fallbackUsed` の監査フローが全件 `mock` ルートに寄っている。
3. `/orca21/medicalmodv2/inpatient` など入院 API は本フェーズで扱わない（`inpatient` スコープ外）ので、「外来スコープ外」と明記し、本 log と DOC_STATUS 備考で記録した。

## 次のアクション
- server-modernized チームへ `claim`/`appointment` エンドポイントで `SessionAuditDispatcher.record` を呼び出し、`action=ORCA_CLAIM_OUTPATIENT`/`ORCA_APPOINTMENT_OUTPATIENT`（仮称）と `details` の `runId/dataSource/cacheHit/missingMaster/fallbackUsed/dataSourceTransition` を確保するよう依頼し、本 log に RUN_ID を追記。
- 書き込み可能な Orchestrator で `dataSourceTransition` が `mock→server` に変わるケースを取得し、`docs/server-modernization/phase2/operations/logs/<RUN_ID>-api-gap.md` の GAP に `evidence` を追記する。
- `auditEvent` の `traceId/requestId` をフロントの `httpClient` が `X-Trace-Id`/`X-Request-Id` ヘッダーで登録することと、`docs/server-modernization/phase2/operations/logs/20251124T000000Z-webclient-bridge.md` で定義された metadata ルールを UI 監査にも適用する。
