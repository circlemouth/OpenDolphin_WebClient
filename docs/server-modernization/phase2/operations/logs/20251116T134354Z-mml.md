# 2025-11-16 紹介状/MML ラッパー実装ログ (RUN_ID=20251116T134354Z)

- 参照チェーン: `AGENTS.md` → `docs/web-client/README.md` → `docs/server-modernization/phase2/INDEX.md` → `docs/managerdocs/PHASE2_ORCA_PHR_GAP_MANAGER_CHECKLIST.md` → `EXTERNAL_INTERFACE_COMPATIBILITY_RUNBOOK.md` §4.4
- 指示: 【ワーカー指示】紹介状/MML ラッパー実装＆疎通確認（RUN_ID=20251116T134354Z）
- 成果物: `server-modernized/src/main/resources/META-INF/persistence.xml`、`tmp/parity-headers/mml_TEMPLATE.headers`、`artifacts/external-interface/mml/20251116T134354Z/README.md`

## 1. 変更概要
1. **Jakarta Persistence 登録漏れの補完**
   - `LetterItem` / `LetterText` / `LetterDate` エンティティを `server-modernized/.../persistence.xml` へ追加。WildFly 再デプロイ後に `MmlServiceBean#getLetterByPK` が `SessionOperation` で失敗しないようにする。
2. **CLI 認証ヘッダーの整備**
   - `tmp/parity-headers/mml_TEMPLATE.headers` を MD5 表記のパスワード (`632080...`) と `X-Facility-Id` 付きに更新。`userService.authenticate` が `d_users.password`（MD5）を比較しているため、CLI 実測が 401 で止まらなくなる。
3. **証跡ディレクトリの初期化**
   - `artifacts/external-interface/mml/20251116T134354Z/` を作成し、4 エンドポイント分のサブディレクトリと README を配置。差分ファイルの命名ルールと次回手順を明記。
4. **ビルド検証**
   - `mvn -pl server-modernized -am -DskipTests package` を実行し、WAR 生成まで通ることを確認。

## 2. 実測メモ
| Endpoint | Legacy (`localhost:8080`) | Modernized (`localhost:9080`) | メモ |
| --- | --- | --- | --- |
| `/mml/letter/list/{fid}` | 200 / CSV=`8` | 未実施（旧 WAR） | 認証ヘッダー MD5 化で 200 を確認。|
| `/mml/letter/json/{pk}` | 200 / JSON を取得 | 500 Session layer failure | Modernized 側は旧 WAR のままのため `LetterItem` のロードで失敗。再デプロイ後に再測。|
| `/mml/labtest/list/{fid}` | 500 Internal Server Error | 未実施 | Legacy DB にラボサンプルが無く 500。`EXT-03` Blocker へ追記。|
| `/mml/labtest/json/{pk}` | ブロッカー (PK 不明) | 未実施 | `ops/tests/fixtures/adm/adm10/labo_item.json` を Legacy 参照値として利用予定。 |

## 3. Blocker / TODO
- [ ] Modernized docker 再構築後に 4 エンドポイントを `ops/tools/send_parallel_request.sh` で採取し、`artifacts/.../20251116T134354Z/` に Legacy/Modern/diff を保存。
- [ ] Legacy 側 `labtest` 500 は `ops/db/local-baseline` のラボシード再適用が必要。`EXT-03` に `LabSeedMissing` Blocker を追加。
- [ ] 監査 ID (`LETTER_EXPORT_*`, `LABTEST_EXPORT_*`) の動作確認は次 RUN で実施。

## 4. Trace / Evidence
- Header template: `tmp/parity-headers/mml_TEMPLATE.headers`
- Evidence staging: `artifacts/external-interface/mml/20251116T134354Z/`
- Build log: `mvn -pl server-modernized -am -DskipTests package`（2025-11-16 22:58 JST 完了）

