# JMS Probe / Trace Evidence（RUN_ID=20251116T210500Z-C）

- 指示: 【ワーカー指示】Worker-C（Messaging/Trace/Audit/Ops）
- 参照チェーン: `AGENTS.md` → `docs/web-client/README.md` → `docs/server-modernization/phase2/INDEX.md` → `docs/managerdocs/PHASE2_SERVER_FOUNDATION_MANAGER_CHECKLIST.md`
- 対象ツール・証跡: `ops/tools/jms-probe.sh` 実行ログ（RUN_ID=`20251108T210639Z` 再利用）、`artifacts/parity-manual/TRACEID_JMS/{20251116TtracePropagationZ1,20251117TtraceAuditZ1}/logs/jms_dolphinQueue_read-resource.txt`、`artifacts/parity-manual/JMS/20251108T210639Z/logs/opendolphin-server-modernized-dev.log`

## 1. `ops/tools/jms-probe.sh` 証跡の棚卸し

| 項目 | 値 |
| --- | --- |
| シナリオ | `claim`（`--scenario claim`）|
| プロファイル | `compose`（`send_parallel_request.profile.env.sample`）|
| 出力ルート | `artifacts/parity-manual/JMS/20251108T210639Z/` |
| JMS ログ | `logs/opendolphin-server-modernized-dev.log`, `logs/opendolphin-server.log` |
| docker logs | `logs/opendolphin-{server,server-modernized,server-modernized-dev,claim-jms}.log` |

- スクリプトは 2025-11-08 21:06:39Z（UTC）に取得済みで、本 RUN では証跡を参照専用で再評価した。`metadata.json` で `log_targets` や timestamp が確認できる。今後同条件で再実行する場合は `TIMESTAMP=$(date -u +%Y%m%dT%H%M%SZ)` を指定して新 RUN_ID を付与する。

## 2. Enqueue/ACK 実測

| 観測 | Legacy | Modernized |
| --- | --- | --- |
| PUT `/20/adm/eht/sendClaim` HTTP | `200 OK`（ユーザー=doctor1） | `401→500`（anonymous 扱い、TraceId=`61c92269-7884-4e27-9c78-1551ddc337e7`）|
| JMS enqueue | 無し（ログ 2 行のみ） | `AMQ139012`（`open.dolphin.traceId` は invalid identifier）|
| Fallback | - | `Claim fallback send started` → `claimHelper.vm` 不在で 500 |
| Audit/JMS | - | `open.dolphin.audit.external` で `CLAIM_REQUEST` まで記録するが `SessionAuditDispatcher` 発火せず |

- `opendolphin-server-modernized-dev.log` 行 31 の WARN で `open.dolphin.traceId` の命名違反が原因と判明。`MessagingGateway` の JMS プロパティ名を `open_dolphin_trace_id` など Java Identifier に合わせる必要がある。
- Enqueue 失敗後は `Claim fallback send started` → `Claim send error ... claimHelper.vm`（行 155, 162）で 500 応答となり、ACK は発生しない。

## 3. Queue 統計（TRACEID_JMS Run）

| 証跡 | `messages-added` | `message-count` | 備考 |
| --- | --- | --- | --- |
| `TRACEID_JMS/20251116TtracePropagationZ1/logs/jms_dolphinQueue_read-resource.txt` | `6L` | `0L` | Modernized Trace Harness 200/400/401/500 実行後。投入 6 件だが消費済みで滞留なし。 |
| `TRACEID_JMS/20251117TtraceAuditZ1/logs/jms_dolphinQueue_read-resource.txt` | `9L` | `0L` | 追加 3 件で messages-added=9。`d_audit_event` は増分 0 のまま。 |

- JMS キュー側では Trace-ID 付きメッセージが確実に増分しているが、`d_audit_event_latest.tsv`（RUN_ID=`20251116T151200Z`）は 11/11 取得分の 43 行から進んでいない。4xx/5xx 例外が `SessionAuditDispatcher` へ届いていないことがブロッカー。

## 4. ブロッカー整理（引き継ぎ）

1. **JMS property 命名**: `MessagingGateway` が JMS Property に `open.dolphin.traceId` を使用しており、ActiveMQ Artemis で拒否される（`AMQ139012`). `MessagingHeaders.TRACE_ID` を `X-Trace-Id` に揃える差分を設計。 
2. **Audit 未記録**: 401/500 ハーネス実行後も `SessionAuditDispatcher`→`AuditTrailService` で行追加が無い。`LogFilter`／`AbstractResource` レベルでレスポンスコードを監査ペイロードに載せる仕組みを追加する。 
3. **Fallback 模板欠落**: `claimHelper.vm` の参照先 (`common-claim`) が compose 環境に含まれず 500 になる。`ops/tools/jms-probe.sh` 再実行前に template 配置と `VelocityEngine` の classpath を整える。

> 次 RUN（Target: `RUN_ID=20251123TclaimAuditZ1`）では上記 3 点を解消したうえで `ops/tools/jms-probe.sh --scenario claim,diagnosis --profile compose --timestamp <RUN_ID>` を実行し、`messages-added` と `d_audit_event` の双方に Trace-ID が現れることを証跡化する。
