# 20251120T193040Z エラーハンドリング/監査ログ計画ログ

- RUN_ID: `20251120T193040Z`
- タスク: `src/modernized_server/05_エラーハンドリングと監査ログ強化.md`
- 作成: 2025-11-20 (JST) / 作業ステータス: 計画ドラフト（実装・接続作業なし）

## 1. 参照リンク
- 参照チェーン: `AGENTS.md` → `docs/web-client/README.md` → `docs/server-modernization/phase2/INDEX.md` → `docs/managerdocs/PHASE2_MANAGER_ASSIGNMENT_OVERVIEW.md` → `PHASE2_SERVER_FOUNDATION_MANAGER_CHECKLIST.md` / `PHASE2_ORCA_SPRINT2_MANAGER_CHECKLIST.md` / `PHASE2_WEB_CLIENT_EXPERIENCE_MANAGER_CHECKLIST.md`
- 関連ドキュメント: `ORCA_API_STATUS.md`, `API_PARITY_MATRIX.md`, `MODERNIZED_REST_API_INVENTORY.md`, `TRACE_PROPAGATION_CHECK.md`
- ハブ反映予定: `docs/web-client/planning/phase2/DOC_STATUS.md`（モダナイズ/監査・エラーハンドリング行を追加予定）

## 2. 想定証跡ディレクトリ
- ログ: `docs/server-modernization/phase2/operations/logs/20251120T193040Z-error-audit.md`（本ファイル）
- アーティファクト（必要に応じて作成）: `artifacts/error-audit/20251120T193040Z/`

## 3. 計画メモ（ドラフト）
- 共通エラーフォーマット案: `status` / `code` / `message` / `traceId` / `blocker` / `orca.apiResult` / `details[]` を最小セットとし、ORCA 200/Api_Result≠00 の昇格基準を整理する。
- 監査ログ必須項目: TraceId/SpanId/RequestId、actor（user/facility/role）、patientId（マスク済み）、action、resource、payloadDigest、result、blocker。`d_audit_event` への格納位置とマスクルール（氏名・住所の部分マスク、自由記述のハッシュ化）を定義する。
- 障害対応テンプレ: WildFly `server.log` / `trace_http_*` / `metrics` / `httpdump` の採取手順を RUN_ID 付きで列挙し、GUI/ネットワーク制約時の収集代替（ログ提供依頼テンプレ）を記載する。

### 3.1 ORCA Trial ログ採取チェック（trace_http_{401,500} / metrics / httpdump）
- RUN 連携: 親=`20251120T193040Z`、子=`20240215T093000Z`。Trace/metrics/httpdump の取得と Blocker ラベルを共通化する。
- チェック項目（取得したら `[x]` に変更し、Blocker を必ず記載する）:
  - [ ] trace_http_401（ORCA Trial Basic 認証失敗/未開放時の 401）  
    取得: `find standalone/log -name 'trace_http_401*' -mtime -1 -print -exec cp {} artifacts/error-audit/${RUN_ID}/trace/ \;`  
    Blocker: ______________________（例: `TrialEndpointMissing`, `TraceAuditMissing`）
  - [ ] trace_http_500（ORCA Trial 経由の 5xx / モダナイズ側 500）  
    取得: `find standalone/log -name 'trace_http_500*' -mtime -1 -print -exec cp {} artifacts/error-audit/${RUN_ID}/trace/ \;`  
    Blocker: ______________________（例: `TrialLocalOnly`, `TraceAuditMissing`）
  - [ ] metrics（Micrometer/JMX snapshot に RUN_ID と取得時刻を付記）  
    取得: `curl -s http://localhost:9990/metrics > artifacts/error-audit/${RUN_ID}/metrics/metrics_$(date -Iseconds).txt`  
    Blocker: ______________________（例: `MetricsGap`, `TrialLocalOnly`）
  - [ ] httpdump（pcap を短時間取得しフィルタ条件を記録）  
    取得: `tcpdump -i any -s0 -w artifacts/error-audit/${RUN_ID}/httpdump/httpdump_$(date -Iseconds).pcap 'tcp port 8080 or tcp port 9990'`  
    Blocker: ______________________（例: `HttpDumpPending`, `TrialEndpointMissing`）

### 3.2 追記メモ
- 2024-02-15 子 RUN (`20240215T093000Z`) で上記チェック項目をテンプレ化する。親 RUN（本ファイル）は Blocker ラベル入力欄を設け、子 RUN の記入結果を突合してハブ文書へリンクする。

## 4. 次アクション
- 共通エラーフォーマットと監査ログポリシーの草案を `src/modernized_server/05_エラーハンドリングと監査ログ強化.md` に追記。
- DOC_STATUS へ本 RUN_ID とログパスを追加し、ハブ文書との整合を確認。
- 実装タスクとの連携ポイント（ORCA Trial 実測・API 契約確定・オブザーバビリティ計画）を整理し、必要に応じて派生 RUN_ID を作成する。

## 5. 子 RUN `20251121T153300Z` 実測ログ（親=`20251120T193040Z`）
- 接続先: 開発用 ORCA（詳細は `docs/web-client/operations/mac-dev-login.local.md` を参照、Authorization はマスク済み）。証跡: `artifacts/error-audit/20251121T153300Z/README.md`（trace_http/httpdump/metrics）。
- 成功ケース: `POST /api01rv2/system01dailyv2?class=00`（XML、Base_Date=2025-11-21）→ HTTP 200 / `Api_Result=00`。trace=`trace_http/trace_http_success.txt`、レスポンス=`httpdump/system01dailyv2_success/response.xml`。
- 認証失敗: 同 API を `ormaster:wrong_pass` で送信 → HTTP 401 JSON（`Code=401`/`Message=Unauthorized`）。trace=`trace_http/trace_http_authfail.txt`、レスポンス=`httpdump/system01dailyv2_authfail/response.*`。
- 存在しない患者 ID: `GET /api01rv2/patientgetv2?id=999999`（Basic 正常）→ HTTP 404 JSON（`Code=404`/`Message=Not Found`）。trace=`trace_http/trace_http_patient.txt`、レスポンス=`httpdump/patientgetv2_notfound/response.*`。
- メトリクス/ヘルス確認: `GET /actuator/health` → HTTP 404 JSON（メトリクス未公開）。`metrics/health_<timestamp>.{headers,json}` に保存。Blocker 目安: `MetricsGap`。

## 6. 子 RUN `20251121ErrorMatrixZ1` 実測ログ（親=`20251120T193040Z`）
- 接続先: 開発用 ORCA（詳細は `docs/web-client/operations/mac-dev-login.local.md` を参照、Authorization はすべて `<MASKED>`）。証跡: `artifacts/error-audit/20251121ErrorMatrixZ1/README.md`（trace_http/httpdump）。
- 業務系エラー採取:
  - `POST /api01rv2/system01dailyv2?class=00`（Request_Number=99, Base_Date=2025-11-21）→ HTTP 200 / `Api_Result=91` / `Api_Result_Message=リクエスト番号がありません`。trace=`trace_http/trace_http_system01dailyv2_invalid.txt`、レスポンス=`httpdump/system01dailyv2_invalid/response.xml`。
  - `POST /api01rv2/acceptlstv2?class=01`（Acceptance_Date=2000-01-01, Physician_Code=99999）→ HTTP 200 / `Api_Result=13` / `Api_Result_Message=ドクターが存在しません`。trace=`trace_http/trace_http_acceptlstv2_invalid_doctor.txt`、レスポンス=`httpdump/acceptlstv2_invalid_doctor/response.json`。
  - `POST /api/api21/medicalmodv2?class=01`（Patient_ID=999999）→ HTTP 200 / `Api_Result=10` / `Api_Result_Message=患者番号に該当する患者が存在しません`。trace=`trace_http/trace_http_medicalmodv2_invalid_patient_alt.txt`、レスポンス=`httpdump/medicalmodv2_invalid_patient_alt/response.json`。ルート直下 `/api21/...` への POST は HTTP 405（`Allow=OPTIONS, GET` として `httpdump/medicalmodv2_invalid_patient/` に保存）。
