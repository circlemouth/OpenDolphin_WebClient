# 20251122T071146Z-tracing

- 日付: 2025-11-22 (JST)
- 担当: Codex (ワーカー指示: トレーシング/可観測性配線)
- 対応範囲: OpenTelemetry 前提のスパン設計・サンプリング方針・Web クライアント TraceContext 伝搬要件を `src/modernized_server/10_オブザーバビリティと運用運転.md` に反映。

## 変更ハイライト
- スパン命名規約/共通属性/エラー記録の最小セットを定義し、Gateway→WildFly→JMS/ジョブの相関（traceparent/tracestate ヘッダ・span.link・dead-letter 属性）を強化。
- Tail+probabilistic の二段サンプリング、施設別 deterministic sampler、バックプレッシャ時の 1% 縮退と復旧順序を追記。A5 アラートと連動するメトリクスを明文化。
- Web クライアントの TraceContext 伝搬にヘッダ上限・PII 禁止・RUM との突合・SSE 再接続時の TraceId 再利用・CORS/Lint ルールを追加。
- サンプリングドロップ/JMS TraceContext 欠落のアラート条件と runbook 参照を追加（実装後は Grafana カード化予定）。

## Tempo/Jaeger 環境別設定棚卸し（2025-11-22 実値反映）
| 環境 | Tempo 保持/コンパクション | Jaeger 保持/コンパクション | OTLP Exporter (アプリ→Collector) | OTLP Ingester/Collector 設定 |
| --- | --- | --- | --- | --- |
| Dev | **未構築（Tempo サービスなし）**。ローカル docker-compose では Tempo/Jaeger 非起動のため保持/compaction は N/A。 | **未構築**。 | `http://otel-collector:4318` (OTLP/HTTP)。Collector image `otel/opentelemetry-collector-contrib:0.101.0`、`OTEL_EXPORTER_OTLP_PROTOCOL=http/protobuf`。 | `receiver: otlp.http` のみ有効、`batch.send_batch_size=1024`・`batch.timeout=10s`、`memory_limiter` 512Mi、`resource` で `deployment=local-dev` を付与。gRPC 4317 は未開放。 |
| Stage | **14 日保持（Tempo blockstore S3）/ compactor 24h ロール**。バックエンドバケット `tempo-stage`、retention/compaction は SRE 口頭値。 | **30 日保持 / rollover 24h**（Jaeger/Elastic ILM hot→warm=7d, stage 用プロファイル）。 | `https://otel-collector.stage.opendolphin.local:4318` (OTLP/HTTP)。`OTEL_EXPORTER_OTLP_PROTOCOL=http/protobuf`、Helm `otelcol` サービス 4317/4318 を併用。 | `receivers: otlp{grpc+http}`、`batch.send_batch_size=8192`・`batch.timeout=10s`、`memory_limiter=1Gi`。`tail_sampling` error/`orca.result!=00` 強制保持 + `parentbased_probability=0.05`。 |
| Prod | **30 日保持（Tempo blockstore S3）/ compactor 24h ロール**。バックエンドバケット `tempo-prod`。 | **30 日保持 / rollover 24h**（Jaeger/Elastic ILM hot→warm=7d）。 | `https://otel-collector.prod.opendolphin.local:4317` (OTLP/gRPC) / `https://otel-collector.prod.opendolphin.local:4318` (OTLP/HTTP)。`OTEL_EXPORTER_OTLP_PROTOCOL=grpc`。 | `receivers: otlp{grpc+http}`、`batch.send_batch_size=8192`・`batch.timeout=10s`、`memory_limiter=2Gi`。`tail_sampling` error 100% + `parentbased_probability=0.03`、`attributes.deployment_environment=prod` を付与。 |

### 変更履歴 / 根拠
- Dev 環境が Tempo/Jaeger を持たず、OTLP Collector（0.101.0）単独で稼働していることを `ops/monitoring/docker-compose.otlp.yml` と `ops/monitoring/otel-collector-config.yaml`、`artifacts/parity-manual/env-status/20251122TenvCheckZ4/docker_compose_status.txt` で確認。よって保持・compaction テンプレ値を「未構築/N/A」に置換し、Collector の実設定（batch/send_batch_size/timeout/memory_limiter/resource ラベル）を記載。
- Stage/Prod の保持・compaction・Exporter/Collector は SRE (Ops) から口頭取得した値を反映。Tempo blockstore は Stage=14d / Prod=30d（compactor 24h）、Jaeger は Stage=30d / Prod=30d rollover 24h。Exporter は Stage=OTLP/HTTP 4318、Prod=gRPC 4317 + HTTP 4318。`20251121T131725Z-observability` の保持期間メモと SRE 共有メモを突合して反映。

## メトリクス定義・Grafana カード例（PromQL）
- `messaging_tracecontext_missing_total`（JMS/キュー TraceContext 欠落率）  
  - PromQL: `sum by (deployment_environment,queue)(increase(messaging_tracecontext_missing_total{deployment_environment=~"$env"}[5m])) / clamp_min(sum by (deployment_environment,queue)(increase(messaging_consumed_total{deployment_environment=~"$env"}[5m])), 1)`  
  - Grafana: Stat パネル「TraceContext Missing %」/ 単位 % / Threshold: Warning=1%、Critical=2%（5m）。補足リンク: runbook §JMS TraceContext 。
- `otel_sampler_dropped_total`（サンプラーで破棄されたスパン率）  
  - PromQL（件数）: `sum by (deployment_environment,service_name)(rate(otel_sampler_dropped_total{deployment_environment=~"$env"}[5m]))`  
  - PromQL（率）: `sum by (deployment_environment)(rate(otel_sampler_dropped_total{deployment_environment=~"$env"}[5m])) / clamp_min(sum by (deployment_environment)(rate(otel_sampler_seen_total{deployment_environment=~"$env"}[5m])), 1)`  
  - Grafana: Stat パネル「Sampler Drop %」/ 単位 % / Threshold: Warning=5%（A5 と同値）、Critical=20%。Annotation に RUN_ID を残し tail-sampling switch 手順へ動線を付ける。

## 参照・更新ファイル
- 更新: `src/modernized_server/10_オブザーバビリティと運用運転.md`
- 証跡: 本ログ `docs/server-modernization/phase2/operations/logs/20251122T071146Z-tracing.md`

### tail-sampling-switch（縮退→復旧手順メモ）
1. Collector の tail processor を無効化し `parentbased_probability=0.01` へ一時縮退（Exporter 停止なし）。
2. `otelcol` 再負荷計測（`otel_sampler_dropped_total`）が 5% 未満に戻ったら batch サイズを 1/2 に縮小し tail processor を再有効化。
3. 需要に応じて `facility.id` 単位で deterministic sampler のレートを段階復旧（1%→3%→5%）。復旧のたびに `sampling.limiter.exceeded` が増加していないことを確認。
4. 復旧完了後はダッシュボード Annotation と本 RUN_ID を Tempo/Jaeger に記録し、Alert A5 を解除。

## 今後の TODO
- Web クライアント側の RUM/OTel 初期化手順を `docs/web-client/operations/` にテンプレート化（別タスクで実装）。
