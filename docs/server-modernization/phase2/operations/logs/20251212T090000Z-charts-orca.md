# RUN_ID=20251212T090000Z Chart/ORCA UX実装

1. **目的・背景**
   - DocumentTimeline/OrderConsole/OrcaSummary/Patients の外来 ORCA state を `missingMaster`/`cacheHit`/`dataSourceTransition=server` で統一し、Reception の tone/`aria-live` carry over ルール (`docs/web-client/ux/reception-schedule-ui-policy.md §5`) と整合する UX を実装。
   - `auth-service.tone=server` フラグを使って ORCA バナーの色を Warning→Info へ切り替え、`data-run-id` を持つ `role=alert` ライブリージョンで `missingMaster` だけを強調。

2. **実装内容**
   - DocumentTimeline の `missingMaster` 受信トリガーで `Warning (琥珀)` バナーを `aria-live=assertive` で即時表示し、`dataSourceTransition=server` へ移行したタイミングでは `Info (青)` tone に戻して `auth-service` flag を tone change の gate とした。`aria-atomic=false` で二重読み上げを防止し、`data-run-id=20251212T090000Z` を Reception へ carry over。
   - OrderConsole/OrcaSummary の `FilterBadge`/`DataSourceBanner` は `missingMaster`/`cacheHit`/`dataSourceTransition` を受信すると `tone`/`aria-live`/`audit.meta`（`action/patientId/queueStatus/tone/ariaLive/runId`）を更新。`dataSourceTransition=server` 表示では `reason`（`retry`/`fallback`/`server`）を伝える tooltip を持ち、監査ログにも透過。
   - Patients タブのヘッダー・行バナーを missingMaster/Info tone で統一。`cacheHit=true` になった際には green label + `aria-live=polite` で「マスタキャッシュを使用」へ切替え、権限がない場合は `aria-role=status` で unauthorized tone を追加しました。

3. **ステージ/観測**
   - Stage/Preview (`VITE_DISABLE_MSW=1`, `VITE_DEV_PROXY_TARGET=http://100.102.17.40:8000/openDolphin/resources`) で ORCA Queue 操作を行い、`cacheHit` false→true、`missingMaster=true`→false、`dataSourceTransition=server` のトーン変化を記録。DocumentTimeline/OrderConsole/OrcaSummary/Patients が同一 `data-run-id` で tone を連携していることを確認。
   - ORCA `cacheHit`/`missingMaster` 受信タイミングと tone の履歴を `artifacts/webclient/ux-notes/20251212T090000Z-orca-flags.md` に記録し、スクリーンショット付きで DocumentTimeline missingMaster と `dataSourceTransition=server` バナーを補足。監査ログには `audit.logUiState` `/ `audit.logOrcaQuery` へ `tone`/`ariaLive`/`dataSourceTransition` を追加し、`action=poll` などで tone が伝播していることも確認。

4. **ドキュメント連携**
   - `docs/web-client/ux/ux-documentation-plan.md` に RUN_ID=`20251212T090000Z` セクションを追加し、本実装と `artifacts/webclient/ux-notes/20251212T090000Z-orca-flags.md` を記載。スクリーンショットとトーン履歴を UX coverage に反映。
   - `docs/web-client/planning/phase2/DOC_STATUS.md` の Web クライアント UX 行に RUN_ID=`20251212T090000Z` / 本ログ / artifact / doc を追記。当該行の備考に `src/outpatient_ux_modernization/04B2_WEBクライアントChartsPatientsUX実装.md` も補足。

5. **次のタスク**
   1. Playwright で `missingMaster` → `cacheHit` → `dataSourceTransition=server` の tone chain を自動化し、`docs/web-client/ux/playwright-scenarios.md` へ `auth-service` flag 切替を記載。
   2. `cacheHit` の true/false 切り替えが実 API でも `audit.logUiState` に記録されているか Stage/Preview curl で確認し、必要に応じて `dataSourceTransition` map を更新。
