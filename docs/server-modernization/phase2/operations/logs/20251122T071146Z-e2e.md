# 20251122T071146Z E2E 接続確認ログ（Web クライアント連携）

- RUN_ID: `20251122T071146Z` （親 RUN_ID=`20251120T131731Z`）
- 対象: Web クライアント × モダナイズ版サーバー開発環境（mac-dev-login.local.md 設定）
- 状態: **部分実施 / Blocked**（Stage 向き先不明・UI 操作用ブラウザなし）。mac-dev ORCA へ `patientlst2v2` を実行し 404 を確認、Stage TLS (443/8443) はハンドシェイク失敗。UI 実測は未完。
- リンク整合: 2025-11-22 07:11:46Z 時点で確認済。未取得の証跡は表・メモに「未取得」と明示。
- 2025-11-22: 09 章に Stage 接続先情報リクエストテンプレを追加。Ops/SRE へ送付し回答待ち。

## Stage 起動準備（Web クライアント）
- `web-client/.env.stage.example` を新規作成し、Stage 用の API/Audit/HTTP 設定キーを列挙（MSW は既定で無効化フラグ `VITE_DISABLE_MSW=1` をセット）。`.env.stage` 本体は空で保持し、`.env` の baseURL を上書きする場合は起動時に `VITE_API_BASE_URL=` を明示する。
- Vite 6.4 では `--https` オプションが廃止されたため、起動コマンドを `VITE_API_BASE_URL= VITE_DISABLE_MSW=1 npx vite --host --mode stage --port 4173 --clearScreen false` へ変更（`@vitejs/plugin-basic-ssl` + `server.https={}` で HTTPS 化）。
- `web-client/README.md` に Stage 接続手順を追記（`.env.stage` 作成 → 上記コマンド → `https://localhost:4173` で確認）。

## UI フェイルセーフ / TraceId コピー確認（2025-11-22 JST）
- 前提: `VITE_API_BASE_URL=`（未設定）かつ `VITE_DISABLE_MSW=1`。`https://localhost:4173` で「接続先未設定（Stage URL を .env.stage に記入してください）」バナーが表示されることを確認。
- TraceNoticeCenter のコピー動作をデバッグ通知で検証（`trace-test-123` / `req-test-456` を注入し、`navigator.clipboard` へコピーできることを確認）。
- ブラウザログ: `[MSW] 環境変数によりモックを無効化します。` / `Web Crypto での MD5 ハッシュ化に失敗しました。CryptoJS を利用します。` / `[HTTP] GET /user/9001:doctor1` → 404 / `SSE 接続に失敗しました。再試行します。 Error: SSE connection failed with status 404`。
- 証跡: `artifacts/observability/20251122T071146Z/missing-endpoint-banner.png`（バナー表示） / `artifacts/e2e-connect/20251122T071146Z/README.md#ローカル起動確認`（起動ログ・コピー検証メモ）。

## 予定シナリオと証跡配置
| シナリオ | 期待結果 | 証跡パス | ステータス / 次アクション |
| --- | --- | --- | --- |
| 認証/セッション延長 | UI でログイン成功、トークン更新が 401→再認証 なく継続 | `artifacts/e2e-connect/20251122T071146Z/httpdump/auth/patientlst2v2_20251122T132823Z.{curl.log,xml}` | **Blocked**: Stage Web クライアント向き先不明。mac-dev ORCA への Basic 認証は通過したが `/api01rv2/patientlst2v2?class=01` が 404（HTTP dump 取得済）。UI 実測はブラウザ環境確保後に再実行。 |
| 受付/予約 CRUD | 受付検索・登録、予約作成/更新が UI 200/Api_Result=00 | `artifacts/e2e-connect/20251122T071146Z/httpdump/reception/` | **Blocked**: Stage/ORCA の受付エンドポイント向き先・seed 未確定（ディレクトリのみ、証跡未取得）。GUI 端末で `WEB1002` 登録＋重複 409 を再計測予定。 |
| カルテ閲覧・保存（DocInfo/ChartEvent） | UI 表示と保存が成功し差分が反映 | `artifacts/e2e-connect/20251122T071146Z/httpdump/charts/version_localhost_20251122T132903Z.curl.log` | **Blocked**: Modernized API ホスト不明。`/openDolphin/resources/api/version` へのローカル接続は connection refused を確認（ログ保存済）。Stage API URL 入手後に DocInfo/ChartEvent を取得。 |
| ORCA ラッパー代表 API | acceptmod/appointmod/medicalmodv2 等が 200/Api_Result=00 | `artifacts/e2e-connect/20251122T071146Z/httpdump/orca-wrapper/` | **Blocked**: mac-dev ORCA で基礎 API (patientlst2v2) が 404。Stage ラッパー URL/doctor seed 不明のため保留（ディレクトリのみ、証跡未取得）。 |
| エラー系 (token 失効/4xx/5xx/ネットワーク遮断) | UI で TraceId/RequestId 表示、再試行がガード | `artifacts/observability/20251122T071146Z/traceid-error-boundary.png`（500系）<br>`artifacts/observability/20251122T071146Z/missing-endpoint-banner.png`（接続先未設定バナー）<br>`artifacts/e2e-connect/20251122T071146Z/httpdump/tls/100.102.17.40_{443,8443}_20251122T1329*.txt` | **部分済**: バナー表示 + TraceNoticeCenter コピー動作をローカルで確認済。TLS は 443/8443 いずれもハンドシェイク失敗（証明書未提供/接続拒否）。token 失効/ネットワーク遮断は UI 未接続のため未採取。 |

## 取得手順メモ
1. `npm run preview -- --host` で実サーバー接続に切替え、ブラウザは MSW/キャッシュを無効化。**現状: Stage ホスト未確定のため待機。**
2. `mac-dev-login.local.md` の認証情報を使用し、開発 ORCA へ接続（Trial 本番は利用不可）。**実施**: patientlst2v2→HTTP 404 を取得（Basic 認証通過確認済）。
3. HAR/HTTP dump は Chrome DevTools + `--source-map=false` で取得し、個人情報は保存前にマスク。ファイル名は `<scenario>_<timestamp>.har` / `<scenario>_<timestamp>.json`。**現状: UI 未到達のため HAR 未取得。**
4. サーバーログは `server_latest_logs.txt` から対象時間帯を抽出し、`artifacts/e2e-connect/20251122T071146Z/server-logs/` へ保存。TraceId で UI と突合する。**現状: Stage API 未接続につき採取不可。**
5. 証跡反映後、本ファイルと `src/modernized_server/09_統合E2E接続確認（Webクライアント連携）.md` のチェック項目にリンクを追加し、DOC_STATUS を更新する。**現状: Blocker を記載し再試行待ち。**

## 追加取得・残課題メモ（2025-11-22T13:30Z）
- TLS チェーン: `artifacts/e2e-connect/20251122T071146Z/httpdump/tls/` に `openssl s_client` の結果を保存。100.102.17.40 の :443/:8443/:8000 はいずれも TLS ハンドシェイク失敗（internal error / connection refused）。
- HTTP 疎通: `artifacts/e2e-connect/20251122T071146Z/httpdump/auth/patientlst2v2_20251122T132823Z.{curl.log,xml}` で mac-dev ORCA が 404 を返却。`httpdump/charts/version_localhost_20251122T132903Z.curl.log` でモダナイズ版 localhost:8080 は connection refused を確認。
- サーバーログ: Stage 未接続のため新規ログ採取なし。接続後に `server_latest_logs.txt` 抜粋を突合予定。
- フォールバック UI: `fallback/README.md` に再取得手順を記載。UI スクショは未取得（ブラウザ環境未用意）。
- UI フェイルセーフ: `VITE_API_BASE_URL` 未設定かつ MSW 無効の起動時に警告バナーを表示するガードを追加。TraceErrorBoundary/TraceNoticeCenter に TraceId/RequestId コピー ボタンを追加。スクショは `artifacts/observability/20251122T071146Z/missing-endpoint-banner.png` へ取得予定。

## リンク整合チェック（2025-11-22 07:11:46Z）
- `docs/server-modernization/phase2/operations/logs/20251122T071146Z-e2e.md`：本ファイルを起点にリンク確認。
- `artifacts/e2e-connect/20251122T071146Z/httpdump/auth/patientlst2v2_20251122T132823Z.{curl.log,xml}`：存在（mac-dev ORCA 404）。
- `artifacts/e2e-connect/20251122T071146Z/httpdump/charts/version_localhost_20251122T132903Z.curl.log`：存在（localhost 接続拒否）。
- `artifacts/e2e-connect/20251122T071146Z/httpdump/tls/*.txt`：存在（443/8443/8000 いずれもハンドシェイク失敗）。
- `artifacts/e2e-connect/20251122T071146Z/server-logs/server_latest_logs_excerpt.txt`：存在。
- `artifacts/e2e-connect/20251122T071146Z/har/` / `screenshots/` / `trace/`：未取得（ディレクトリのみ）。
- `artifacts/observability/20251122T071146Z/traceid-error-boundary.png`：存在（TraceId UI 表示スクショ）。
- `artifacts/observability/20251122T071146Z/missing-endpoint-banner.png`：存在（接続先未設定バナー＋TraceNotice コピー確認）。

## 既存関連証跡
- 観測系: `docs/server-modernization/phase2/operations/logs/20251122T071146Z-{tracing,alerts,metrics,links,artifacts,incident}.md`
- スクリーンショット: `artifacts/observability/20251122T071146Z/traceid-error-boundary.png`
