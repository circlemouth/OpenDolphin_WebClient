# API 安定化ログ（RUN_ID=20251120T191203Z）

参照チェーン: `AGENTS.md` → `docs/web-client/README.md` → `docs/server-modernization/phase2/INDEX.md` → `docs/managerdocs/PHASE2_MANAGER_ASSIGNMENT_OVERVIEW.md` → 本ログ / `src/modernized_server/08_Webクライアント向けAPI安定化.md`

## 0. 前提メモ
- Web クライアント利用 API は `REST_API_INVENTORY.md` / `API_UI_GAP_ANALYSIS.md` を起点に抽出。UX 側 SLA は `WEB_CLIENT_REQUIREMENTS.md` (N1 3s/ORCA 5s) と `process/ROADMAP.md` のロングポーリング 55s×5 リトライを採用。`CHART_UI_GUIDE_INDEX.md` には数値 SLA が無いため、本ログで暫定値を明示。
 - 実測: `tmp/api-stability-seed.sql` を modernized/ORCA 双方の DB へ流した **後に** `docker restart opendolphin-server-modernized-dev`（compose up は `opendolphin-minio` と衝突するため未使用）を実施し、`ChartEventServiceBean.initializePvtList` が seed 済み PVT をキャッシュする状態を作ってから `PARITY_OUTPUT_DIR=artifacts/api-stability/20251120T191203Z/benchmarks TRACE_RUN_ID=20251120T191203Z BASE_URL_MODERN=http://localhost:9080/openDolphin/resources PARITY_HEADER_FILE=tmp/parity-headers/api_stability_20251120T191203Z.headers` で `ops/tools/send_parallel_request.sh --profile modernized-dev --targets modern --loop 3 --loop-sleep 0.2 --run-id 20251120T191203Z` を実行。
- 成果物: `artifacts/api-stability/20251120T191203Z/{benchmarks,mocks,schemas}/`

## 1. Web クライアント利用 API と SLA 紐付け（計測対象）
| 領域 | 代表エンドポイント | SLA/耐障害性 | ペイロード前提・備考 |
| --- | --- | --- | --- |
| Charts (タイムライン/文書) | `GET /karte/docinfo/{karteId}?from&includeModified`<br>`POST /karte/document` / `PUT /karte/document` | 応答 3s 以内（N1）。添付は null 前提で大容量を回避。React Query の再フェッチのみ、リトライなし。 | 文書メタのみ取得。`REST_API_INVENTORY` では `PUT /karte/document`（本文更新）を使用しており、Modernized の `PUT /karte/document/{id}`（タイトル更新のみ）との差分に注意。 |
| Reception (受付/長輪講) | `GET /pvt2/pvtList` | ロングポーリング 55s タイムアウト、最大 5 リトライ（`process/ROADMAP.md`）。 | eventId で差分取得。state 数値は Legacy コードを踏襲。 |
| Administration | `GET /user/{userId}` / `GET /serverinfo/*` | 応答 3s 以内。Axios 既定の指数バックオフで 2 回までリトライ。 | AppShell 初期ロードで必須。空 roles を返さないよう互換層で補完。 |
| ORCA wrapper / Master | `GET /orca/tensu/name/{query}/` / `PUT /orca/interaction` | 応答 5s 以内（N1 重量 API）。タイムアウト時は UI に Retry ボタン（`ux/API_SURFACE_AND_AUDIT_GUIDE.md` 5 秒キャンセル）。 | Trial では 404/405 多発。互換レイヤーで `apiResult=79` を `HTTP200 + warning` へ正規化し UI を継続。 |
| ChartEvent (リアルタイム) | `GET /chartEvent/subscribe` (LP) / `GET /chart-events` (SSE) | LP: 55s×5 リトライ / SSE: 無限ストリーム、疎通不可時は LP へフェールバック。 | `clientUUID` を必須ヘッダーとし、Missing 時は互換層で匿名 UUID を補う。 |

計測対象リストは `artifacts/api-stability/20251120T191203Z/benchmarks/README.md` に詳細化。

## 2. Legacy vs モダナイズ非互換と互換レイヤー方針
| 差分/課題 | 互換レイヤー方針（デフォルト値・feature flag） | ロールバック |
| --- | --- | --- |
| `PUT /karte/document` （本文更新）vs Modernized `PUT /karte/document/{id}` （タイトル更新のみ） | `X-Client-Compat: legacy-doc-update` が付与された場合、互換層で本文更新を許可し `id` をボディから解決。未指定はタイトル更新のみ。 | flag 無効化で Modernized 既定に戻す。 |
| ChartEvent: Legacy ロングポーリング `/chartEvent/subscribe` と SSE `/chart-events` の両立 | `X-Client-Compat: lp-only` で LP 優先。既定は SSE 優先で LP をフォールバックに使用。`Last-Event-ID` 欠落時は 0 を補完。 | flag を落として SSE を停止すると LP だけで稼働。 |
| ORCA wrapper stub 応答（spec-based `Api_Result=79`）と Trial 404/405 の不一致 | `X-Client-Compat: orca-trial` 時は 404/405 を `200 + apiResult=79 + warningHeader` へマップ。`apiResult` が無い場合は `00` を既定にし UI を動作させる。 | flag を外すと HTTP ステータスを透過（エラーとして扱う）。 |
| UserResource `roles` / `facilityId` 欠落時の Null 破壊 | 互換層で空配列や null を検知したら `roles=["USER"]`, `facilityId` をセッションから補完。 | 補完を外すと AppShell 初期化失敗を検知できる。 |
| `DELETE /pvt`/`/pvt2` の戻り値: Legacy はボディなし、Modernized は JSON 0/1 を返却する場合あり | 互換層で 204 か空 JSON を強制し、`X-Client-Compat: strict-delete` で旧挙動を返却。 | flag 解除で Modernized の戻り値を透過。 |

## 3. ベンチマーク結果（modernized-dev 再実施）
- コマンド: `PARITY_OUTPUT_DIR=artifacts/api-stability/20251120T191203Z/benchmarks TRACE_RUN_ID=20251120T191203Z BASE_URL_MODERN=http://localhost:9080/openDolphin/resources ops/tools/send_parallel_request.sh --profile modernized-dev --targets modern --loop 3 --loop-sleep 0.2 --run-id 20251120T191203Z ...`
- ヘッダー: `tmp/parity-headers/api_stability_20251120T191203Z.headers`（`userName=1.3.6.1.4.1.9414.72.103:doctor1`, `password=MD5(doctor2025)`, Basic=MS4z..., `X-Trace-Id=api-stability-20251120T191203Z`）。
- seed: `tmp/api-stability-seed.sql` を拡張し、doc module 付き文書と UTC 今日の日付の PVT を `opendolphin_modern` へ投入。tensu master stub/tbl_syskanri/tbl_dbkanri/tbl_genericname を modernized/ORCA 接続先（`opendolphin`）両方へ作成。modernized サーバーを再起動してから計測（起動後に seed を流す場合は `/pvt2` POST でウォームアップして list を返す状態にする）。
- 結果（modern のみ、loop=3）:
  | 領域 | パス | ステータス | 中央値 / 90p | 備考 |
  | --- | --- | --- | --- | --- |
  | Charts | `/karte/docinfo/1012,2024-01-01%2000:00:00,true` | 200 | 13.2ms / 50.9ms | seed 文書 1 件を返却（docPk=1013/title=API Seed Progress Note）。`from` は `yyyy-MM-dd HH:mm:ss` 形式必須で、初回のみ 50ms 台。 |
  | Reception | `/pvt2/pvtList` | 200 | 5.0ms / 5.1ms | list[1] を返却（pvtPk=1014, pvtDate=`2025-11-21T07:07:09Z`, state=2, memo=`api stability seed`, patientId=`0000001`）。 |
  | Administration | `/user/1.3.6.1.4.1.9414.72.103:doctor1` | 200 | 10.2ms / 21.5ms | roles 配列に `doctor` を返却。 |
  | ORCA wrapper | `/orca/tensu/name/プロパネコール,20240401,true/` | 200 | 11.6ms / 66.6ms | stub 行（srycd=110001110, ten=120, yakkakjncd=1234567890）を返却。初回のみ 60ms 台。 |
- 課題/進捗: docinfo/tensu/user は 200（初回のみ 20〜70ms、その後 10ms 前後）。pvtList は seed→再起動の順にすると初回から list を返却する。起動後に seed を流した場合は `ChartEventServiceBean.initializePvtList` が空リストをキャッシュしたままになるため、再起動を挟むか `/pvt2` POST（ウォームアップ）で明示追加する。証跡: `artifacts/api-stability/20251120T191203Z/benchmarks/reception_pvtlist_loop001/modern/{response.json,meta.json}`（loop002/003 も同パス）。

## 4. バックワード互換テスト & モック配置
- シナリオ一覧: `artifacts/api-stability/20251120T191203Z/schemas/backward-compat-scenarios.md`（`charts-docinfo.json`, `reception-pvtlist.json`, `admin-user-profile.json`, `orca-tensu-name.json`）。
- MSW モック: `artifacts/api-stability/20251120T191203Z/mocks/msw-handlers.ts` / README 付。`/api/karte/docinfo/:karteId` / `/api/pvt2/pvtList` / `/api/user/:userId` / `/api/orca/tensu/name/:query/` を Legacy 互換レスポンスで返却。
- 利用手順: MSW の handler 配列へ `apiStabilityHandlers` を追加し、SLA 逼迫テストは `ctx.delay()` で再現可能。

## 5. 今後のアクション
1. pvtList は seed→再起動の順で `initializePvtList` に取り込ませる。起動後 seed の場合は空キャッシュになるため、再起動または `/pvt2` POST を手順書と自動化スクリプトに組み込む（本ログ・benchmarks README を更新済み）。
2. 互換フラグ `X-Client-Compat` の受け渡しとデフォルト値を server-modernized 側の設定ファイルに追記（コード変更なしで切替可とする）。
3. ChartEvent SSE/LP のフェールバック動作を MSW モックで確認し、`CHART_UI_GUIDE_INDEX.md` へ SLA 数値（3s/5s/55s×5）を追記する提案を検討。

## 6. X-Client-Compat 有効化可否と切替手順（RUN_ID=20251120T191203Z）
- 現状: リポジトリ内に `X-Client-Compat` を既定付与する設定ファイルや環境変数は存在せず（`server-modernized` コード/設定を `rg` で確認）、手動でヘッダーを付けたリクエストのみ有効。デフォルトは Modernized 挙動（`lp-only` なしで SSE 優先、`legacy-doc-update` 無効、`strict-delete` 無効、`orca-trial` 無効）。
- 有効化手順（WildFly Undertow で全リクエストへ既定ヘッダーを付与する例、要 Ops 適用）  
  1. `jboss-cli.sh --connect --file=configure-wildfly.cli` で適用する前提で、以下を追記 or 単発実行:  
     ```
     /subsystem=undertow/configuration=filter/request-header=client-compat:add(header-name="X-Client-Compat", header-value="legacy-doc-update,lp-only,strict-delete,orca-trial")
     /subsystem=undertow/server=default-server/host=default-host/filter-ref=client-compat:add
     :reload
     ```  
     - 既定ヘッダー値は「互換を優先する」組み合わせ（本文更新許可＋LP強制＋削除204/空JSON＋ORCA Trial 404/405 を 200/warning へマップ）。SLA/検証状況に応じて値を減らす。  
     - ルート限定が必要な場合は `location=/openDolphin` 直下に filter-ref を追加する。
  2. ロールバック:  
     ```
     /subsystem=undertow/server=default-server/host=default-host/filter-ref=client-compat:remove
     /subsystem=undertow/configuration=filter/request-header=client-compat:remove
     :reload
     ```
- 依存設定・注意点:  
  - Reverse Proxy/Nginx 経由で付与する場合は同じヘッダー値を upstream へ渡すだけでよい（アプリ側コード変更不要）。  
  - 併用するヘッダーはカンマ区切り 1 本で渡せばサーブレット側で `String` として受け取れる。機能別に個別ヘッダーへ分割する場合はアプリ改修が必要になるため本ログでは非推奨。  
  - デフォルトを Modernized 挙動へ戻したい場合は filter を外すだけでよい（アプリ側の既定値がモダナイズ動作）。運用切替時は本節の CLI/Proxy 設定を Evidence として保存する。

## 7. X-Client-Compat デフォルト付与作業ログ（2025-11-21T13:53:34+09:00）
- コンテナ: `opendolphin-server-modernized-dev`（ワーカーポート 9080）
- 実施コマンド: `/subsystem=undertow/configuration=filter/response-header=X-Client-Compat:add(header-name=X-Client-Compat, header-value=legacy)` → `/subsystem=undertow/server=default-server/host=default-host/filter-ref=X-Client-Compat:add()` → `:reload`
- 確認: `curl -i http://localhost:9080/actuator/health | grep -i x-client-compat` で `X-Client-Compat: legacy` を確認
- 備考（ロールバック）: `/subsystem=undertow/server=default-server/host=default-host/filter-ref=X-Client-Compat:remove()` → `/subsystem=undertow/configuration=filter/response-header=X-Client-Compat:remove()` → `:reload`

## 7. チケット
- pvtList 初期化欠落（`ServletContextHolder.getToday()` null → `/pvt2` 500）: `server-modernized/src/main/java/open/dolphin/mbean/ServletStartup.java` / `session/ChartEventServiceBean.java` / `session/PVTServiceBean.java` / `mbean/ServletContextHolder.java` に RUN_ID=20251120T191203Z で防御実装を追加。Issue/PR: `pvtList init guard (RUN_ID=20251120T191203Z)` を起票予定（本ログで暫定トラッキング）。
- docinfo / ORCA wrapper で空データ時に `IndexOutOfBounds` で 500 となる不具合の恒久対応（優先度: 安定化タスク）: `docs/server-modernization/phase2/operations/logs/20251120T191203Z-docinfo-orca-indexoutofbounds-issue.md`。null/empty ガードと安全な list 参照、防御的な tensu 取得をサーバー側に実装し、seed 無しでも HTTP 200 を返すよう修正を依頼。

## 8. X-Client-Compat 自動付与フック追加（RUN_ID=20251120T191203Z）
- 目的: `scripts/start_legacy_modernized.sh` で modernized WildFly を起動した直後に `X-Client-Compat: legacy` を Undertow response-header へ恒常付与する。
- 実施内容: `scripts/compat/x-client-compat.cli` を新設し、`/subsystem=undertow/configuration=filter/response-header=X-Client-Compat` の追加/属性更新と `filter-ref` 追加、`:reload` をまとめた（冪等）。`start_legacy_modernized.sh` の `start` 後段で `opendolphin-server-modernized-dev` のヘルスチェック完了を待ち、`docker cp` → `docker exec /opt/jboss/wildfly/bin/jboss-cli.sh -c --file=/opt/jboss/wildfly/x-client-compat.cli` を自動実行するフックを挿入。
- 想定確認手順 (docker 環境起動後): `./scripts/start_legacy_modernized.sh start --build` 実行後、`curl -i http://localhost:${MODERNIZED_APP_HTTP_PORT:-9080}/actuator/health | grep -i X-Client-Compat` で `X-Client-Compat: legacy` がレスポンスに含まれることを確認。
- ロールバック: `docker exec opendolphin-server-modernized-dev /opt/jboss/wildfly/bin/jboss-cli.sh -c "/subsystem=undertow/server=default-server/filter-ref=X-Client-Compat:remove; /subsystem=undertow/configuration=filter/response-header=X-Client-Compat:remove; :reload"` を実行するか、スクリプトのフック呼び出しを外す。

## 9. ヘッダー付与フック動作確認（2025-11-21T15:04頃, RUN_ID=20251120T191203Z）
- `./scripts/start_legacy_modernized.sh start --build` は `services.dockerfile must be a mapping`（スクリプト生成の compose override で `dockerfile:` が services 直下）で失敗し、Compose 実行前に停止。
- 既存稼働中の `opendolphin-server-modernized-dev`（healthy, ポート 9080）を利用して確認。
  - `curl -i http://localhost:9080/actuator/health | grep -i X-Client-Compat` → `X-Client-Compat: legacy`
  - `curl -i http://localhost:9080/karte/document` → HTTP 404 でも `X-Client-Compat: legacy` が含まれることを確認。
- `docker compose -f docker-compose.modernized.dev.yml up ...` は既存 `opendolphin-minio` コンテナ名と衝突し途中停止。稼働中コンテナはそのまま維持。

## 10. PVTResource2Test 実行ログ（modernized-dev, 2025-11-21）
- コマンド: `docker run --rm -u $(id -u):$(id -g) -e MAVEN_CONFIG=/home/ubuntu/.m2 -e HOME=/home/ubuntu -v "$HOME/.m2":/home/ubuntu/.m2 -v "$PWD":/workspace -w /workspace maven:3-eclipse-temurin-17 mvn -f pom.server-modernized.xml -pl server-modernized -am test -Dtest=PVTResource2Test -Dsurefire.failIfNoSpecifiedTests=false`
- 環境: ホストに Java/Maven が無いため Maven 3 + Temurin 17 コンテナで実行。前段で `mvn` コマンド（ホスト/コンテナ）とも依存解決エラーとなったため、`~/.m2` を `/home/ubuntu/.m2` へマウントし直して `-f pom.server-modernized.xml -pl reporting -am install -DskipTests` / `-pl common -am install -DskipTests` を実行し、`opendolphin-{reporting,common}` をローカルに配置してから再実行。
- 結果: SUCCESS。`open.dolphin.rest.PVTResource2Test` Tests run: 4, Failures: 0, Errors: 0, Skipped: 0（実行時間 2.9s）。SLF4J provider 不在警告のみ。
- 備考: 依存モジュールにテストが存在しないため `-Dsurefire.failIfNoSpecifiedTests=false` を付与してビルド失敗を回避。開始 2025-11-21T06:20Z / 終了 2025-11-21T06:22Z。

## 10. start_legacy_modernized.sh compose override インデント修正検証（2025-11-21T15:20+09:00, RUN_ID=20251120T191203Z）
- 修正: `scripts/start_legacy_modernized.sh` が生成する override YAML の `services.server.build.dockerfile` を正しくネスト。
- 検証コマンド: `./scripts/start_legacy_modernized.sh start --build`（タイムアウト 120s で終了）。`services.dockerfile must be a mapping` は再現せず、`server` / `server-modernized-dev` ビルドが開始されたことを確認（Compose config 通過）。
- 状態: タイムアウトのためコンテナ起動前に停止。`docker ps` では既存 `opendolphin-*` 系コンテナのみ稼働中で、`legacy-vs-modern` プレフィックスの新規コンテナは無し。既存 `opendolphin-minio` との衝突は未発生だが、回避が必要な場合は `PROJECT_NAME=legacy-vs-modern` のまま起動するか、代替プロジェクト名を指定して別名コンテナで起動する運用を推奨。

## 11. ヘッダー付与フック再確認（2025-11-21T15:50+09:00, RUN_ID=20251120T191203Z）
- コマンド: `./scripts/start_legacy_modernized.sh start --build`（タイムアウト 300s で完走、終了コード 1）。ビルドは完了し `opendolphin-server-modernized-dev` / `opendolphin-server` / `postgres` / `minio` がすべて healthy。終了直前に `WFLYCTL0030: No resource definition is registered for address /subsystem=undertow/server=default-server/filter-ref=X-Client-Compat` で rollback が発生しており、CLI 側の filter-ref 操作に失敗している模様。
- ヘッダー確認: `curl -i http://localhost:9080/actuator/health | grep -i X-Client-Compat` はヒットなし（レスポンスヘッダーに未付与）。`curl -i http://localhost:9080/karte/docinfo` / `curl -i http://localhost:9080/karte/document` も 404 応答だが `X-Client-Compat` は付かず、フックが効いていないことを確認。
- 補足: `docker ps` では `opendolphin-server-modernized-dev` が healthy（ポート 9080）。ヘッダー付与フックの CLI コマンドを再点検する必要あり（filter 名一致や remove/add 順序など）。

## 12. X-Client-Compat 自動付与フック修正・再検証（2025-11-21T07:02:47Z, RUN_ID=20251120T191203Z）
- 修正: `scripts/compat/x-client-compat.cli` の filter-ref パスを `/subsystem=undertow/server=default-server/host=default-host/filter-ref=X-Client-Compat` へ変更し、response-header add → filter-ref add → :reload の順で適用するよう整列（invalid address で rollback していた問題を解消）。
- コマンド: `./scripts/start_legacy_modernized.sh start --build`（終了コード 0, cache 多数活用）。WildFly 起動後に CLI 適用ログ `{"outcome" => "success"}` を確認。
- 確認: `curl -i http://localhost:9080/actuator/health | grep -i X-Client-Compat` / `curl -i http://localhost:9080/karte/docinfo` いずれも `X-Client-Compat: legacy` を応答ヘッダーで確認。
- 状態: rollback は再発せず。`opendolphin-server-modernized-dev` / `opendolphin-server` など既存コンテナは稼働継続（project name=legacy-vs-modern ビルド済み）。必要に応じて `docker ps` で二重起動の有無を確認。
