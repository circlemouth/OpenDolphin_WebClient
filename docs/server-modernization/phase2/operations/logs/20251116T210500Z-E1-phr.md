# RUN_ID=20251116T210500Z-E1 / EXT-01 PHR REST 実装証跡
- 指示: 【ワーカー指示】PHR REST 実装 + 証跡取得 (2025-11-16 21:05Z 採番)。
- 参照チェーン: AGENTS.md → docs/web-client/README.md → docs/server-modernization/phase2/INDEX.md → PHASE2_ORCA_PHR_GAP_MANAGER_CHECKLIST.md。
- 対象タスク: EXT-01（PHR REST 登録 + 証跡）。Flyway (`phr_access_key`), Layer ID secrets, Audit ID, RESTEasy リソース登録、Trial/ORMaster CRUD エビデンス整備。

## 1. 実施内容
1. Flyway DDL (`server-modernized/tools/flyway/sql/V0228__phr_key_and_async_job.sql`) をレビューし、`d_phr_key` / `phr_async_job` が導入済みであることを確認。`artifacts/orca-connectivity/20251116T210500Z-E1/checks/flyway.md` に要約。
2. `.env.modernized` の PHR Secrets を `ops/check-secrets.sh` で検証（Layer ID は Vault 管理のため値なし）。結果を `checks/secrets.log` に保存。警告は S3 未使用のみ。
3. Trial 証跡: RUN_ID=`20251121TrialPHRSeqZ1-A/B` の `curl_summary.log` を `artifacts/.../trial/logs/` へコピーし、404/405 応答を Blocker 根拠として保持（Trial サイトの `/20/adm/phr/*` は未開放）。
4. ORMaster (Modernized 経路) 証跡: RUN_ID=`20251121TrialPHRSeqZ1-CTX` の CRUD/ServerInfo/WildFly ログを `artifacts/.../ormaster/` に集約し、RESTEasy リソース登録＋監査 ID 発火 (`PHR_ACCESS_KEY_*`, `PHR_*_TEXT`) を確認。
5. README/Checks を更新し、EXT-01 の Evidence 参照先を整理。

## 2. Trial / ORMaster 結果サマリ
| 系統 | 内容 | HTTP/状態 | 証跡 |
| --- | --- | --- | --- |
| Trial (RUN_ID=20251121TrialPHRSeqZ1-A/B) | `/20/adm/phr/accessKey`, `/patient`, `/abnormal` など Phase-A/B API | 404/405 (`Method Not Allowed` / `Not Found`) | `artifacts/orca-connectivity/20251116T210500Z-E1/trial/logs/curl_summary.log` |
| Modernized (RUN_ID=20251121TrialPHRSeqZ1-CTX) | `/20/adm/phr/allergy`, `/labtest`, `/container` ほか | HTTP200 (JSON 応答 + `PHR_*` 監査) | `artifacts/.../ormaster/crud/*`, `ormaster/wildfly/phr_*.log` |
| Modernized Export | `POST /20/adm/phr/export`, `GET /status/{jobId}` | Trial 経路=405、Modernized=UnknownEntityException（`PHRKey`/`PHRAsyncJob` persistence 未登録時の fail-fast を RUN_ID=`20251121TrialPHRSeqZ1-CTX` で再現） | `ormaster/crud/PHR_CTX/post-export.log`, `ormaster/wildfly/phr_20251121TrialPHRSeqZ1-CTX.log` |

## 3. Blocker / 次アクション
- Trial 環境: `/20/adm/phr/*` 未開放 → `TrialEndpointMissing`。`docs/server-modernization/phase2/notes/external-api-gap-20251116T111329Z.md` の PHR 節に RUN_ID を追記し `[Spec-based]` を継続。
- ORMaster 実測: Modernized サーバー（BASIC）経由の CRUD で 200/403 まで確認済。ただし実 ORMaster での 200 証跡は未取得。GUI 端末＋doctor/patient seed 復旧後に `curl -u <ormaster>` で再測する計画を `notes/` に記載。
- Export Track: `PHR_EXPORT_SIGNING_SECRET` は dev 値のみ。S3 backend / Signed URL 監査 (`PHR_SIGNED_URL_*`) は未完。`PHR_EXPORT_STORAGE_TYPE=S3` を有効化したうえで Evidence を取る。 
- Audit SQL: `audit/phr_audit_extract.sql` で `PHR_ACCESS_KEY_*` / `PHR_*_TEXT` を抽出し `artifacts/.../ormaster/logs/audit_phr_extract.sql` へ保存（次 RUN）。

## 4. 証跡
- `artifacts/orca-connectivity/20251116T210500Z-E1/README.md`
- `artifacts/orca-connectivity/20251116T210500Z-E1/trial/logs/curl_summary.log`
- `artifacts/orca-connectivity/20251116T210500Z-E1/ormaster/crud/*`
- `artifacts/orca-connectivity/20251116T210500Z-E1/ormaster/wildfly/phr_20251121TrialPHRSeqZ1-CTX.log`
- `artifacts/orca-connectivity/20251116T210500Z-E1/checks/{flyway.md,secrets.md,secrets.log}`
