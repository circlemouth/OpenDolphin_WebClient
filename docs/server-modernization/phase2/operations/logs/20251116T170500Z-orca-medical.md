# 2025-11-16 ORCA 医療行為/病名/セット API 実装ログ

- RUN_ID: `20251116T170500Z`
- 担当: Worker-C（ORCA 医療行為/病名/セット API）
- 参照チェーン: `AGENTS.md` → `docs/web-client/README.md` → `docs/server-modernization/phase2/INDEX.md` → `docs/managerdocs/PHASE2_ORCA_SPRINT2_MANAGER_CHECKLIST.md` → `docs/server-modernization/phase2/domains/API_PARITY_MATRIX.md`
- 成果物: 本ログ＋ソース（`server-modernized/src/main/java/open/dolphin/rest/orca/*.java` / `dto/orca/*.java` / `web.xml`）、`ORCA_API_STATUS.md` / `API_PARITY_MATRIX.md` / `MODERNIZED_REST_API_INVENTORY.md` / `DOC_STATUS.md` の更新。

## 1. 実装サマリ
1. **REST リソース新設**: `open.dolphin.rest.orca` 配下に下記 5 クラスを追加し、`web.xml` の `resteasy.resources` に登録。
   - `OrcaMedicalResource`: `/orca/medical/records` を `MedicalGetRequest/Response` で実装。`PatientServiceBean` → `KarteServiceBean` → `DocInfoModel` を経由してカルテ履歴を JSON へ整形し、Trial 未検証でも Web クライアントから参照可能にした。
   - `OrcaDiseaseResource`: `/orca/disease/import`, `/orca/disease`, `/orca/disease/v3` を `DiseaseImportResponse`／`DiseaseMutationRequest/Response` で実装。`RegisteredDiagnosisModel` を `KarteServiceBean#add/update/removeDiagnosis` へ連携し、`UserServiceBean#getUser(remoteUser)` で監査責任者を補正。
   - `OrcaPatientResource`: `/orca/patient/mutation` を `PatientMutationRequest/Response` として追加。Trial 未解放の delete は `Api_Result=79`（Spec-based）で応答しつつ、create/update は `PatientServiceBean#addPatient/#update` と監査ログを発火。
   - `OrcaSubjectiveResource`, `OrcaMedicalAdministrationResource`: `/orca/chart/subjectives`, `/orca/medical-sets`, `/orca/tensu/sync`, `/orca/birth-delivery` を **Spec-based stub** として実装し、`Api_Result=79 / RUN_ID` を返却。Trial 未開放 API であることをレスポンスと監査ログに明記。
2. **DTO 群の整備**: `server-modernized/src/main/java/open/dolphin/rest/dto/orca/` に 15 ファイル（`MedicalGet*`, `Disease*`, `PatientMutation*`, `SubjectiveEntry*`, `MedicalSetMutation*`, `MedicationMod*`, `BirthDelivery*`）を追加し、Jackson アノテーション＋最小限のフィールド検証で JSON 契約を固定。
3. **監査/共通ヘルパー**: `AbstractOrcaRestResource` を作成し、`RUN_ID` 定数・facility/user 検証・`SessionAuditDispatcher` 連携を共通化。全エンドポイントが `audit.details = {facilityId, patientId, operation...}` を送出するよう統一。
4. **ビルド確認**: `mvn -pl server-modernized -DskipTests compile` を実行。`sun.misc.Unsafe` 警告と従来の `@Deprecated` 警告のみでコンパイル成功（Failures=0, Errors=0）。

## 2. Trial 制約と Spec-based 方針
- WebORCA Trial では `/orca25/subjectivesv2`, `/orca21/medicalsetv2`, `/orca102/medicatonmodv2`, `/orca31/birthdeliveryv2` が 405/GUI 禁止のため、実装は **Spec-based implementation / Trial未検証** とし、レスポンスにも同文言を含めた。
- `/api01rv2/medicalgetv2`, `/orca12/patientmodv2`, `/orca22/diseasev2/v3` はローカル DB と監査ログまで接続。ORCA 連携自体は今後 `OrcaConnect` で HTTP POST できるよう拡張予定（`ORCA_REST_IMPLEMENTATION_NOTES.md` に TODO を追記）。
- `API_PARITY_MATRIX.md` No.12-18/33-34/36-37 の状態列を `◎` or `△(Spec-based)` に更新し、備考へ「`RUN_ID=20251116T170500Z / Spec-based implementation / Trial未検証`」を挿入。`ORCA_API_STATUS.md` も同じ注記を追加済み。

## 3. ドキュメント更新
- `docs/server-modernization/MODERNIZED_REST_API_INVENTORY.md` §7: 新規 REST パス（`/orca/medical/records`, `/orca/patient/mutation`, `/orca/disease`, `/orca/disease/v3`, `/orca/chart/subjectives`, `/orca/medical-sets`, `/orca/tensu/sync`, `/orca/birth-delivery`）を追記し、実装状況を `Spec-based` 含めて明記。
- `docs/server-modernization/phase2/domains/API_PARITY_MATRIX.md` ORCA 行 12-18/33-34/36-37: 状態ラベルと実装計画を差し替え、`Spec-based` 行には Trial 再検証条件を記載。
- `docs/server-modernization/phase2/operations/ORCA_API_STATUS.md`: 同 API の「直近期の実測 / RUN_ID」列へ `20251116T170500Z` を追記し、Trial 未検証メモを併記。
- `docs/web-client/planning/phase2/DOC_STATUS.md` 行 34-41 を本 RUN_ID で更新し、新ログへのリンクを追記。

## 4. テスト / 証跡
```
mvn -pl server-modernized -DskipTests compile
```
- 目的: DTO/Resource 追加後のビルド確認。
- 結果: 成功。警告のみ（`sun.misc.Unsafe`, Base64Utils, `SerializationFeature#WRITE_NULL_MAP_VALUES`）。
- リンク: `target/classes` 更新済み（コミット対象外）。

## 5. TODO / リスク
1. Trial で `/orca25/subjectivesv2` 等の POST が開放されたら、`OrcaMedicalAdministrationResource` の stub を実際の `OrcaConnect` 呼び出しへ差し替え、`Spec-based` ラベルを外す。
2. `/orca/disease` update/delete では ORCA 側のステータスとモダナイズ DB のステータスが乖離する可能性があるため、次 RUN で `RegisteredDiagnosisModel` と ORCA 属性（`Disease_SuspectedFlag`, `Disease_OutCome` 等）のマッピング精度を確認する。
3. `/orca/patient/mutation` delete が未実装のため、Trial/本番での削除要件が判明し次第 `PatientServiceBean` 側に論理削除 API を追加する必要あり。
