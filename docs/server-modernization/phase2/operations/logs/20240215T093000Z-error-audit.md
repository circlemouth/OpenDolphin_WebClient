# 20240215T093000Z エラーハンドリング/監査 障害対応Runbook

- RUN_ID: `20240215T093000Z`（親 RUN: `20251120T193040Z`）
- タスク: `src/modernized_server/05_エラーハンドリングと監査ログ強化.md`「障害時サポート手順」整備
- 作成: 2024-02-15 (JST) / 作業ステータス: ドキュメント整備のみ（サーバー再起動・設定変更なし）

## 1. 参照リンク
- 参照チェーン: `AGENTS.md` → `docs/web-client/README.md` → `docs/server-modernization/phase2/INDEX.md` → `docs/managerdocs/PHASE2_MANAGER_ASSIGNMENT_OVERVIEW.md` → `PHASE2_ORCA_CONNECTIVITY_MANAGER_CHECKLIST.md`
- 関連ドキュメント: `ORCA_CONNECTIVITY_VALIDATION.md`（Evidence 保存・RUN_ID 規約）/ `TRACE_PROPAGATION_CHECK.md`（trace_http_* / d_audit_event 収集）/ `operations/logs/20251120T193040Z-error-audit.md`（計画ドラフト）
- ハブ反映: `docs/web-client/planning/phase2/DOC_STATUS.md`（モダナイズ/監査・エラーハンドリング行）、`src/modernized_server/05_エラーハンドリングと監査ログ強化.md` へサマリ連携

## 2. 前提・範囲
- 本 Runbook はログ採取・証跡保存手順のテンプレート。サーバー再起動や設定変更は行わず、既存ログの取得とドキュメント更新に限定する。
- 実ログを取得する場合は RUN_ID を環境変数に設定し、収集したファイル名に RUN_ID と取得時刻を含めて `artifacts/error-audit/20240215T093000Z/` 配下へ保存する。
- 個人情報を含む場合は必ずマスク（患者 ID はハッシュ化／氏名・住所は部分伏字／自由記述はハッシュ化）してから保存する。

## 3. 採取対象ログと保存ポリシー

| 種別 | コマンド例（参考: WildFly ローカル起動時） | 保存先ポリシー | 備考 |
| --- | --- | --- | --- |
| WildFly server.log / boot log | `tail -n 5000 /var/log/wildfly/server.log > artifacts/error-audit/20240215T093000Z/wildfly/server.log` | `wildfly/` に最新 5k 行 + 直近再起動 1 セットを保存。複数ある場合は `server_${ts}.log` で分割。 | `ops/shared/docker/custom.properties` 等の秘密情報は残さない。 |
| trace_http_* / d_audit_event | `find standalone/log -maxdepth 1 -name 'trace_http_*' -mtime -1 -print -exec cp {} artifacts/error-audit/20240215T093000Z/trace/ \\;` | `trace/` に HTTP200/400/401/500 それぞれの SQL/TSV を配置。採取日時をファイル名に付与。 | `TRACE_PROPAGATION_CHECK.md` と突き合わせ、TraceId/SpanId の有無をメモする。 |
| Metrics（Micrometer/JMX） | `curl -s http://localhost:9990/metrics > artifacts/error-audit/20240215T093000Z/metrics/metrics_$(date -Iseconds).txt` | `metrics/` にプレーンテキストで保存。Basic 認証を使う場合はヘッダーをログへ残さない。 | 取得時刻とターゲット URL をファイル冒頭にコメントとして残す。 |
| HTTP dump / wire trace | `sudo tcpdump -i any -s0 -w artifacts/error-audit/20240215T093000Z/httpdump/httpdump_$(date -Iseconds).pcap 'tcp port 8080 or tcp port 9990'` | `httpdump/` に pcap を保存。再共有時は機微データを削除または要事前承認とする。 | 長時間キャプチャは避け、発生/再現ウィンドウのみ取得。共有時にフィルタ条件を記載。 |
| Thread dump | `jcmd $(pgrep -f 'wildfly') Thread.print > artifacts/error-audit/20240215T093000Z/thread-dump/thread_$(date -Iseconds).txt` | `thread-dump/` に 1〜2 本まで。スタックに資格情報が出ないことを確認。 | 連続取得する場合は 10〜15 秒間隔で 3 回まで。 |
| Heap histogram (概要のみ) | `jmap -histo:live $(pgrep -f 'wildfly') | head -n 200 > artifacts/error-audit/20240215T093000Z/heap-dump/heap_$(date -Iseconds).txt` | `heap-dump/` にトップ 200 行まで。バイナリ heap dump は取得しない。 | サイズが大きい場合は Taking を中断しメモのみ残す。 |
| クライアント HTTP リクエスト | `curl -vv -H 'X-Trace-Id: ${RUN_ID}' -H 'Content-Type: application/json' https://localhost:8080/api/... -d @payload.json -D artifacts/error-audit/20240215T093000Z/client-requests/request_${ts}.headers --trace-ascii artifacts/error-audit/20240215T093000Z/client-requests/request_${ts}.trace -o artifacts/error-audit/20240215T093000Z/client-requests/response_${ts}.json` | `client-requests/` に headers + trace + response をセットで保存。 | ORCA Trial 宛ての場合は `curl -u trial:weborcatrial ...` の Basic 情報を `--config <(printf ...)` で外出しし、ファイルに書き込まない。 |

### 3.1 ORCA Trial チェックリスト（trace_http_{401,500} / metrics / httpdump）
- 親 RUN=`20251120T193040Z` との突合用に、取得した Evidence ごとに Blocker ラベルを明記する。
- 取得後に `[ ]` を `[x]` へ書き換え、Blocker を必ず埋める。
  - [ ] trace_http_401（ORCA Trial Basic 認証失敗/未開放時の 401）  
    保存先: `artifacts/error-audit/20240215T093000Z/trace/trace_http_401_${ts}.<ext>`  
    Blocker: ______________________（例: `TrialEndpointMissing`, `TraceAuditMissing`）
  - [ ] trace_http_500（ORCA Trial 経由の 5xx / モダナイズ側 500）  
    保存先: `artifacts/error-audit/20240215T093000Z/trace/trace_http_500_${ts}.<ext>`  
    Blocker: ______________________（例: `TrialLocalOnly`, `TraceAuditMissing`）
  - [ ] metrics（Micrometer/JMX snapshot に取得時刻コメントを入れる）  
    保存先: `artifacts/error-audit/20240215T093000Z/metrics/metrics_${ts}.txt`  
    Blocker: ______________________（例: `MetricsGap`, `TrialLocalOnly`）
  - [ ] httpdump（pcap を短時間取得しフィルタ条件を残す）  
    保存先: `artifacts/error-audit/20240215T093000Z/httpdump/httpdump_${ts}.pcap`  
    Blocker: ______________________（例: `HttpDumpPending`, `TrialEndpointMissing`）

## 4. 再現条件テンプレ
- 環境: ローカル / WSL2 / CI（明記）、`server-modernized` のブランチ/コミット、WildFly プロファイル（`standalone-full.xml` 等）。
- 前提設定: `claim.host` / `claim.conn` / `VITE_DEV_PROXY_TARGET` など接続先、使用した認証情報（伏字）、Feature flag の有無。
- 事象: 発生時刻（JST/UTC）、呼び出し API / UI 操作、期待結果と実際のレスポンス（HTTP ステータス / Api_Result / エラーメッセージ）。
- 影響範囲: 該当患者/施設/利用者、監査ログへの影響（挿入無し/部分欠落/内容不整合）。
- 再現手順: 実行したコマンド / curl / UI 操作を番号付きで記載し、再現に必要な seed データの有無を明示。

## 5. 連絡・エスカレーションテンプレ
```
【障害報告】RUN_ID=20240215T093000Z（親:20251120T193040Z） #Blocker:<タグ> / 影響:<クリティカル度>
- 事象: <例> Charts 保存で 500（error.code=karte_lookup_failed）
- 発生/再現: <日時 JST/UTC> / <環境> / <手順サマリ>
- 影響範囲: <患者/施設/ページ>、監査ログ=<記録有/欠落/部分>
- 添付: wildfly=<path>, trace=<path>, metrics=<path>, httpdump=<path>, client-requests=<path>
- 暫定対応: <logrotate/再試行/監査手動採取など>
- 次アクション: <担当者・期限>
```
- Blocker タグ例: `TrialEndpointMissing`, `TrialLocalOnly`, `TraceAuditMissing`, `MetricsGap`, `HttpDumpPending`。
- 添付位置は本 RUN_ID 配下に集約し、ハブ（DOC_STATUS / 05 章）へ同じパスを記載して参照できるようにする。

## 6. 証跡ディレクトリ構成（本 RUN）
- `artifacts/error-audit/20240215T093000Z/`（作成済み）
  - `wildfly/`（server.log, boot log）
  - `trace/`（trace_http_* / d_audit_event）
  - `metrics/`（Micrometer/JMX snapshot）
  - `httpdump/`（pcap）
  - `thread-dump/`（Thread.print）
  - `heap-dump/`（jmap histo）
  - `client-requests/`（curl headers/trace/response）
  - `docs/`（再現メモ・問い合わせ下書き）
- 実際のログ取得後は各ファイルに RUN_ID/取得時刻を付け、`DOC_STATUS` 備考と本ログへ同じパスを書き戻す。

## 7. 更新履歴
- 2024-02-15: 初版作成（ログ採取テンプレ整備・フォルダ作成のみ）。
