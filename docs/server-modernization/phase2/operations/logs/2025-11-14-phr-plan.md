# 2025-11-14 PHR RESTEasy 実装順序レビュー
- RUN_ID: `20251114TphrPlanZ1`
- 対象タスク: Task-B「PHR-EXPORT-TRACK ベースの PHR-01〜11 実装順序・ゲーティング策定」
- 参照ドキュメント: `docs/server-modernization/phase2/domains/PHR_RESTEASY_IMPLEMENTATION_PLAN.md`

## 概要
PHR-01〜11 を RESTEasy へ段階実装するための順序とゲーティングを整理し、(a) キー管理 → (b) 閲覧 → (c) Layer ID → (d) 画像/Schema → (e) PHRContainer → (f) Export Track の 6 フェーズに分割した。各フェーズで依存モジュール、監査 ID、テスト観点、Blocker/解放条件を表形式で記載し、ORCA 週次レビューがそのまま利用できるようアンカーを付与した。

## 決定事項
1. PHR-02/03/10（キー管理）を最優先とし、`phr_access_key` Flyway と `touch.phr.requiredHeaders` を解放条件に設定する。
2. 閲覧系（PHR-01/04/05/08/09）は UTF-8 固定化と `TouchMedicationFormatter` 抽出をゲーティングに含め、監査イベント `PHR_*_TEXT` を統一命名で登録する。
3. Layer ID（PHR-06）は SEC-OPS-002（Secrets チェックジョブ）が ready のタイミングでのみ着手し、証明書格納 Runbook 承認を必須とする。
4. Export Track は `PHR-EXPORT-TRACK` に連携し、S3/IAM/監査ジョブの 3 チケットが ready になるまで Block する。RUN_ID `20251114TphrPlanZ1` を #RUN hook として流用する。

## Plan 表抜粋
| フェーズ | 主体エンドポイント | 依存 / 監査トピック | Blocker |
| --- | --- | --- | --- |
| Phase-A: キー管理 | PHR-02/03/10 | `PhrRequestContextExtractor`, `PhrAuditHelper`, `phr_access_key` Flyway, 監査 ID `PHR_ACCESS_KEY_*` | Flyway 適用と監査 ID 承認 |
| Phase-B: 閲覧 | PHR-01/04/05/08/09 | `PhrDataAssembler`, `AMD20_PHRServiceBean`, `TouchMedicationFormatter` 抽出, `docSince/labSince` 定義 | `normalizeSampleDate2` Jakarta 化、監査イベント登録 |
| Phase-C: Layer ID | PHR-06 | `IdentityService`, Secrets チェック (SEC-OPS-002), Layer ID 証明書保管 | Secrets/証明書ガバナンス未完 |
| Phase-D: 画像 | PHR-07 | `SchemaModel` ストリーマ, `Cache-Control`/帯域設計, `TouchDownloadMonitor` | `/resources` 登録と帯域方針 |
| Phase-E: PHRContainer | PHR-11 | `PHRContainer` DTO Jackson 化, `SignedUrlService`, `PHR_EXPORT_CONFIG` | Secrets/DTO/QueryParam 承認 |
| Phase-F: Export Track | `/20/adm/phr/export*` | `PhrExportJobManager`, `S3PhrExportStorage`, 監査チェーン (AUDIT-OPS-003) | S3/IAM/監査ジョブ ready 待ち |

## 次アクション
1. API_PARITY_MATRIX PHR セクションにフェーズ別アンカーリンクを追記済み。W22 週次で周知。
2. DOC_STATUS W22 行へ「PHR 実装順序 doc を追加、優先度レビュー準備完了」と追記済み。
3. Export Track の Blocker 解除条件（S3/IAM/監査ジョブ）を `phr-2fa-audit-implementation-prep.md` で追跡し、RUN_ID `20251114TphrPlanZ1` を共有ログで共通利用する。
