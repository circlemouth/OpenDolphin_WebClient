# FacilitySchedule / PatientDataExport UX spec (RUN_ID=20251129T163000Z)

## Background
- WorkerB（Schedule/Export連携）指示に従い、Web クライアントの FacilitySchedulePage 予約ダイアログと PatientDataExportPage に RUN_ID・Charts 連携・監査可視化を補強する。Legacy サーバーや ORCA 本番への操作は伴わない。
- 参照: `docs/web-client/ux/improvementPlan.md`「受付・スケジュール補助画面の UX 強化」〜「実施ステップ」、`docs/web-client/ux/legacy/API_SURFACE_AND_AUDIT_GUIDE.md` §5（本 RUN_ID セクション）。

<a name="facilityschedule"></a>
## FacilitySchedule 予約ダイアログ要件
<a name="facilityschedule-chart-link"></a>
- `ChartLinkPanel` で Charts への導線・RUN_ID・担当者・予約ステータスを InfoBanner 化し、`audit.logChartsAction`/`audit.logScheduleAction` の `runId` を表示。`OperationHistoryPanel` は TooltipFields を再利用して予約操作履歴を badge/tooltip/evidence link 付きで並べ、監査ログへの deep link を持たせる。
<a name="facilityschedule-operation-history"></a>
- `RunIdHistoryCollapse` には過去 runId の時系列を記録し、DangerZone では患者 ID＋予約 ID 入力＋チェックボックス 2 件＋3 秒フォーカス遅延の二段階確認を課す。削除確定時には `audit.logScheduleAction(action="danger-delete", ...)` を送り、`runId`・`evidencePath`・`actorRole` を含める。

<a name="patientdataexport"></a>
## PatientDataExport 要件
- ChartsContext の患者・日付範囲プリセットを InfoCard で再掲し、`Start Export from Charts` ボタンでプリセットを拾う。変更時は `audit.logAdministrativeAction` に `runId` を載せて metadata を送信し、InfoCard に現在の `RUN_ID` と最終取得件数を表示。
- エクスポートファイルは `patient-data-export-<facility>-<chartId>-<YYYYMMDD>-<RUN_ID>.json(.csv)`、JSON metadata に `runId/chartId/evidencePath` を埋め込む。CSV には先頭コメント `# RUN_ID=20251129T163000Z`、ARIA には `aria-label="Download patient export (RUN_ID=20251129T163000Z)"` を付与。

## Wireframe
```
FacilitySchedule 予約ダイアログ
┌───────────────────────────────────┐
│ Title: 予約詳細 ─ RUN_ID=20251129T163000Z │
│ ChartLinkPanel: [Chartsへ遷移][担当医][STATUS][RUN_ID Badge] │
├───────────────────────────────────┤
│ OperationHistoryPanel (tooltip/badge)              │
│  - 2025-11-29 15:40｜Edit｜RUN_ID=20251129T162400Z  │
│  - 2025-11-29 15:10｜Created｜Evidence▽            │
├───────────────────────────────────┤
│ RunIdHistoryCollapse (過去 runId)                 │
│ DangerZone │ [PatientID再入力] [Checkbox 1/2] [Delay] │
│             [Delete Button (data-run-id)]           │
└───────────────────────────────────┘

PatientDataExport パネル
┌─────────────────────────────────────────────┐
│ InfoCard: ChartPreset [Patient XYZ | 2025-11-01〜 │
│ RUN_ID=20251129T163000Z / Last Export Count=42]  │
├─────────────────────────────────────────────┤
│ Filters: Chart Preset / Period / Format / Upload │
├─────────────────────────────────────────────┤
│ Export Buttons: [CSV（runId）][JSON（runId）]     │
│ File Name Template in tooltip + metadata embed   │
└─────────────────────────────────────────────┘
```

## Evidence / Next Steps
- 本 RUN_ID は `docs/web-client/ux/legacy/API_SURFACE_AND_AUDIT_GUIDE.md` の §5 に仕様と wireframe を追記し、DOC_STATUS `docs/web-client/planning/phase2/DOC_STATUS.md` の該当行にも `RUN_ID=20251129T163000Z` / 本ファイルへのリンクを追記した。今後の実装ではこの RUN_ID に合わせて `audit` payload/`data-run-id` 表示を統一する。
- Implementation/UX レビューで `audit.logScheduleAction`/`audit.logChartsAction`/`logAdministrativeAction`（`audit.logDataExport` 相当）がすべて `runId=20251129T163000Z`・`actorRole`・`evidencePath` を Payload に含めていることを確認済みで、PatientDataExport は `patient-data-export-<facility>-<chartId>-<YYYYMMDD>-<RUN_ID>.(json|csv)` 形式＋`# RUN_ID=20251129T163000Z` コメントで `artifacts/patient-export/` の証跡とこのログを結び付ける運用を共有する。
- <a name="e2e"></a>
- ### Playwright e2e coverage amends
- `RUN_ID=20251129T163000Z VITE_RUN_ID=20251129T163000Z VITE_DEV_PROXY_TARGET=http://localhost:8000/openDolphin/resources PLAYWRIGHT_BASE_URL=http://localhost:4173 npx playwright test tests/e2e/facility-schedule.spec.ts` で DangerZone の 2 段階確認・`data-run-id`/`RUN_ID` 表示・OperationHistory runId・PatientDataExport の `data-run-id`/`aria-label` 付きダウンロードボタンを検証。出力ログ: `artifacts/e2e/20251129T163000Z/facility-schedule.log`、スクリーンショット: `artifacts/e2e/20251129T163000Z/facility-schedule-danger-zone.png`／`artifacts/e2e/20251129T163000Z/patient-data-export.png`。検証報告は本節に追記済。〈該当ログへのリンク: `docs/server-modernization/phase2/operations/logs/20251129T163000Z-schedule.md#e2e`〉
