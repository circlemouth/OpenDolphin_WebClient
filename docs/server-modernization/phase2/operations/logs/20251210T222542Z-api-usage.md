# Webクライアント API 使用実績インベントリ（RUN_ID=20251210T222542Z）
- 期間: 2025-12-13 09:00 - 2025-12-14 09:00 JST（事前採取日: 2025-12-10）
- 目的: MSW 無効化状態で主要フローの実呼び出し経路を確認し、Vite プロキシ経路と OpenAPI 定義の差分を棚卸しする。
- 証跡: `artifacts/webclient/api-usage/20251210T222542Z/`（HAR 2 本: `webclient-api-usage.har`, `webclient-api-usage-401.har`）

## 環境・前提
- RUN_ID=`20251210T222542Z`
- 起動: `WEB_CLIENT_MODE=npm VITE_DISABLE_MSW=1 VITE_DEV_PROXY_TARGET=http://localhost:9080/openDolphin/resources VITE_DEV_USE_HTTPS=0 ./setup-modernized-env.sh`
- クライアント: `npm install --cache ../.npm-cache` → `npm run build` → `VITE_DEV_PROXY_TARGET=... VITE_DEV_USE_HTTPS=0 npm run preview -- --host localhost --port 4173`
- 認証入力: 施設ID=`LOCAL.FACILITY.0001`, ユーザーID=`dolphin`, パスワード=`dolphin`（MD5=`36cdf8b887a5cffc78dcd5c08991b993`）
- 画面遷移: `/login` → （成功後 nav click）`/outpatient-mock`。ログイン後に `localStorage.devFacilityId/devUserId/devPasswordMd5` を上書きして httpFetch のヘッダー補完を強制。
- Vite プロキシ: `/api` は `/openDolphin/resources` へ rewrite、`/api01rv2` `/orca21` `/orca12` は書き換え無しで同ターゲットへ中継。

## 実測結果（HAR 抜粋）
| 画面 | メソッド/パス | ステータス | 主なリクエストヘッダー | 応答概要 |
| --- | --- | --- | --- | --- |
| Login | `GET /api/user/LOCAL.FACILITY.0001:dolphin` | 200 | `userName: LOCAL.FACILITY.0001:dolphin` / `password: 36cdf8…` / `clientUUID: 7641bf15-…` | UserModel JSON（roles: system-administrator/doctor/user）; `x-trace-id=6634187b-9732-4634-bdb2-90aefb048820` |
| Outpatient Mock | `POST /orca/claim/outpatient/mock` | 200 | `password: 36cdf8…`（`userName` は httpFetch が補完せず） | `{"runId":"20251208T124645Z","dataSource":"server","dataSourceTransition":"server","cacheHit":false,"missingMaster":false,"fallbackUsed":false,"fetchedAt":"2025-12-10T22:43:49Z",...}`; `x-trace-id=d7e3203d-bf5d-4808-8913-8bfae96cc2d8` |
| Outpatient Mock | `POST /orca21/medicalmodv2/outpatient` | 415 | `password: 36cdf8…` のみ（Content-Type, userName 欠落） | 本体なし; `x-trace-id=f134c2c2-7023-4fc5-9d49-69814112881a` |

- 401 セッション再現: `webclient-api-usage-401.har` に `userName=LOCAL.FACILITY.0001:dolphin` 不在の状態での 401 応答と `WWW-Authenticate: Basic realm="OpenDolphin"` を保存。

## 気付き・差分
- httpFetch は localStorage から `userName/X-Facility-Id` を補完する想定だが、Outpatient モックの POST では `password` のみ送信されており、`userName` 未指定のまま 200（claim stub）/415（medical stub）になった。ヘッダー強制セットまたは fetchOptions で `Content-Type: application/json` を入れないと medical 側は Unsupported Media Type のまま。
- `/orca21/medicalmodv2/outpatient` は ORCA 本来の `/api21/medicalmodv2` とはパスが異なり、OpenAPI manifest (`operations/assets/orca-api-spec/manifest.json`) に operationId 未定義。`/orca/claim/outpatient/mock` も ORCA API には存在しないモダナイズ側スタブ。
- Vite プロキシ経路は preview/dev で共通（rewrite: `/api` のみ）。ベースパス `/openDolphin/resources` へ正常に到達していることを server ログ traceId で確認。

## 次アクション候補
1) Outpatient モック呼び出し前に `userName` / `X-Facility-Id` / `Content-Type: application/json` を明示し、415 を解消した HAR を再取得する。  
2) `httpFetch` の `applyAuthHeaders` が Outpatient でも効くよう、localStorage 読み出しを確認するテストを追加。  
3) ORCA OpenAPI operationId マッピング表に `/orca/claim/outpatient/mock` `/orca21/medicalmodv2/outpatient` を「未定義スタブ」として追記し、UI 機能対応表へリンク。

