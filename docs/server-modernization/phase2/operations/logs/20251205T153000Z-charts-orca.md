# Charts/ORCA tone alignment（RUN_ID=20251205T153000Z）

- **目的**: `missingMaster` → `cacheHit` → `dataSourceTransition=server` の tone chain を Reception と Charts で同一コピー/ARIA に揃える。`DocumentTimeline`/`PatientsTab` に `getChartToneDetails` を導入し、`OrderConsole` と `OrcaSummary` の missingMaster banner に `ToneBanner` + `aria-live` を再レンダリングさせる。
- **実装ポイント**:
  1. `web-client/src/ux/charts/tones.ts` に `getChartToneDetails` を追加し、`missingMaster`/`cacheHit`/`dataSourceTransition` で `tone`/`message`/`transitionMeta` を返す共通ルーチンを整備。server transition の label/description を `transitionMeta` に保持して `dataSourceTransition=server` 表示を一箇所で管理。
  2. `DocumentTimeline.tsx` と `PatientsTab.tsx` で `useAuthService` の `flags` を `getChartToneDetails` に渡し、`ToneBanner` の message・`StatusBadge` の tone を tone-chain に合わせて再描画。`transitionMeta` を右カラム/ヘッダーに流用し、`dataSourceTransition=server` 表示を共有。
  3. `OrcaSummary.tsx` は同 helper から `tone`/`transitionMeta` を受け取り `ToneBanner` の `ariaLive` を tone 依存で指定。`summaryMessage` は `missingMaster`/`cacheHit`・`transitionMeta` を依存に `useMemo` して `dataSourceTransition` の変化で再評価されるよう修正。
  4. `OrderConsole.tsx` に `ToneBanner` を追加し、`masterSource` を `dataSourceTransition` とみなして `getChartToneDetails` へ渡す。`missingMaster` note と `CacheHitBadge`/`MissingMasterBadge` は `runId` ごとに再描画し、`aria-live=assertive` で warning を announce することで reception 側トーンと整合する表示を実現。
- **依存 API / フロー**:
  - `web-client/src/features/charts/authService.tsx` が `AuthServiceContext` を提供し、`flags`（`missingMaster`/`cacheHit`/`dataSourceTransition`）を `DocumentTimeline`/`PatientsTab` へ供給。`AuthServiceControls` で手動トグルできることで tone の可視化を実施。
  - `web-client/src/features/reception/components/ToneBanner.tsx` により `tone`/`aria-live`/`nextAction` を unify し、`OrderConsole` でも同一バナーをレンダリング。`ToneBanner` の `toneLive` マップが `warning`/`error` を `assertive` に昇格させるため、screen reader は `missingMaster` の warning に即座に反応する。
  - `web-client/src/features/shared/StatusBadge.tsx` で `MissingMasterBadge`/`CacheHitBadge` を再利用し、`ariaLive` を `missingMaster` で assertive に、`cacheHit` で polite に切り替えて監査 carry-over を整備。
- **観察**: `missingMaster=true` から `cacheHit=true`、さらに `dataSourceTransition=server` の流れを `ToneBanner` 上で `warning→info` に切り替えることで Reception と同じ `tone=server` ルールを Charts 側でも再現。スクリーンショットは `artifacts/webclient/ux-notes/20251205T153000Z-charts-ui-audit.md` に記録（DocumentTimeline + Patients header tone banners）。
