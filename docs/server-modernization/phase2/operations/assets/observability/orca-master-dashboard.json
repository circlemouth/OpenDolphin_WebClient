{
  "uid": "orca-master-bridge-obs",
  "title": "ORCA Master Bridge Observability (Draft)",
  "schemaVersion": 39,
  "version": 1,
  "tags": ["orca", "master", "bridge", "phase2"],
  "timezone": "browser",
  "refresh": "30s",
  "time": { "from": "now-6h", "to": "now" },
  "templating": {
    "list": [
      {
        "name": "prom",
        "type": "datasource",
        "query": "prometheus",
        "label": "Prometheus",
        "refresh": 2
      },
      {
        "name": "loki",
        "type": "datasource",
        "query": "loki",
        "label": "Loki",
        "refresh": 2
      },
      {
        "name": "env",
        "type": "query",
        "datasource": { "type": "prometheus", "uid": "${prom}" },
        "query": "label_values(opendolphin_api_request_total, environment)",
        "label": "environment",
        "includeAll": true,
        "multi": true,
        "allValue": ".*",
        "current": { "text": "dev", "value": "dev" }
      },
      {
        "name": "service",
        "type": "custom",
        "query": "orca-master-bridge,opendolphin-api",
        "label": "service",
        "current": { "text": "orca-master-bridge", "value": "orca-master-bridge" }
      },
      {
        "name": "api",
        "type": "custom",
        "query": "ORCA-05,ORCA-06,ORCA-08",
        "label": "api",
        "includeAll": true,
        "multi": true,
        "allValue": "ORCA-(05|06|08)",
        "current": { "text": "ORCA-05,ORCA-06,ORCA-08", "value": "ORCA-(05|06|08)" }
      },
      {
        "name": "facility",
        "type": "query",
        "datasource": { "type": "prometheus", "uid": "${prom}" },
        "query": "label_values(opendolphin_api_request_total, facility)",
        "label": "facility",
        "includeAll": true,
        "multi": true,
        "allValue": ".*",
        "current": { "text": "All", "value": ".*" }
      },
      {
        "name": "user",
        "type": "query",
        "datasource": { "type": "prometheus", "uid": "${prom}" },
        "query": "label_values(opendolphin_api_request_total, user)",
        "label": "user",
        "includeAll": true,
        "multi": true,
        "allValue": ".*",
        "current": { "text": "All", "value": ".*" }
      },
      {
        "name": "runId",
        "type": "query",
        "datasource": { "type": "prometheus", "uid": "${prom}" },
        "query": "label_values(opendolphin_api_request_total, run_id)",
        "label": "runId",
        "includeAll": true,
        "multi": true,
        "allValue": ".*",
        "current": { "text": "All", "value": ".*" }
      }
    ]
  },
  "panels": [
    {
      "type": "timeseries",
      "title": "P99 latency (s)",
      "description": "目標: ORCA-05/06 ≤1.2s (cache hit 0.6s)、ORCA-08 ≤1.8s。警告>2.0s, 致命>3.0s (ORCA-08 致命>3.5).",
      "datasource": { "type": "prometheus", "uid": "${prom}" },
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "orange", "value": 2 },
              { "color": "red", "value": 3 }
            ]
          }
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.99, sum by (le,api) (rate(http_request_duration_seconds_bucket{job=\"$service\",environment=~\"$env\",api=~\"$api\",facility=~\"$facility\",user=~\"$user\",run_id=~\"$runId\"}[$__rate_interval])))",
          "legendFormat": "{{api}} P99"
        }
      ],
      "options": {
        "legend": { "displayMode": "table", "placement": "bottom", "calcs": ["last", "max"] },
        "tooltip": { "mode": "single" }
      },
      "gridPos": { "h": 9, "w": 12, "x": 0, "y": 0 }
    },
    {
      "type": "timeseries",
      "title": "RPS (5m rate)",
      "datasource": { "type": "prometheus", "uid": "${prom}" },
      "targets": [
        {
          "expr": "sum by (api) (rate(http_requests_total{job=\"$service\",environment=~\"$env\",api=~\"$api\",facility=~\"$facility\",user=~\"$user\",run_id=~\"$runId\"}[$__rate_interval]))",
          "legendFormat": "{{api}}"
        }
      ],
      "options": {
        "legend": { "displayMode": "list", "placement": "bottom" },
        "tooltip": { "mode": "single" }
      },
      "gridPos": { "h": 9, "w": 12, "x": 12, "y": 0 }
    },
    {
      "type": "timeseries",
      "title": "エラー率 (5xx / total)",
      "description": "警告>1% 5分平均、致命>3% (release-plan §4)。",
      "datasource": { "type": "prometheus", "uid": "${prom}" },
      "fieldConfig": {
        "defaults": {
          "unit": "percentunit",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "orange", "value": 1 },
              { "color": "red", "value": 3 }
            ]
          }
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "100 * (sum by (api) (rate(http_requests_total{job=\"$service\",environment=~\"$env\",api=~\"$api\",status=~\"5..\",facility=~\"$facility\",user=~\"$user\",run_id=~\"$runId\"}[$__rate_interval])) / sum by (api) (rate(http_requests_total{job=\"$service\",environment=~\"$env\",api=~\"$api\",facility=~\"$facility\",user=~\"$user\",run_id=~\"$runId\"}[$__rate_interval])))",
          "legendFormat": "{{api}}"
        }
      ],
      "gridPos": { "h": 8, "w": 8, "x": 0, "y": 9 }
    },
    {
      "type": "timeseries",
      "title": "Cache hit %",
      "description": "警告 <80% (ORCA-05/06), <70% (ORCA-08) 10分継続",
      "datasource": { "type": "prometheus", "uid": "${prom}" },
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "red", "value": 70 },
              { "color": "orange", "value": 80 },
              { "color": "green", "value": 90 }
            ]
          }
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "100 * (sum by (api) (rate(http_requests_total{job=\"$service\",environment=~\"$env\",api=~\"$api\",cache_hit=\"true\",facility=~\"$facility\",user=~\"$user\",run_id=~\"$runId\"}[$__rate_interval])) / sum by (api) (rate(http_requests_total{job=\"$service\",environment=~\"$env\",api=~\"$api\",facility=~\"$facility\",user=~\"$user\",run_id=~\"$runId\"}[$__rate_interval])))",
          "legendFormat": "{{api}}"
        }
      ],
      "gridPos": { "h": 8, "w": 8, "x": 8, "y": 9 }
    },
    {
      "type": "timeseries",
      "title": "missingMaster %",
      "description": "警告 >0.5% 5分平均 (release-plan §4)",
      "datasource": { "type": "prometheus", "uid": "${prom}" },
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "orange", "value": 0.5 },
              { "color": "red", "value": 1 }
            ]
          }
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "100 * (sum by (api) (rate(http_requests_total{job=\"$service\",environment=~\"$env\",api=~\"$api\",missing_master=\"true\",facility=~\"$facility\",user=~\"$user\",run_id=~\"$runId\"}[$__rate_interval])) / sum by (api) (rate(http_requests_total{job=\"$service\",environment=~\"$env\",api=~\"$api\",facility=~\"$facility\",user=~\"$user\",run_id=~\"$runId\"}[$__rate_interval])))",
          "legendFormat": "{{api}}"
        }
      ],
      "gridPos": { "h": 8, "w": 8, "x": 16, "y": 9 }
    },
    {
      "type": "timeseries",
      "title": "audit_missing %",
      "description": "監査フィールド欠落率。警告>0.1% (release-plan §4)",
      "datasource": { "type": "prometheus", "uid": "${prom}" },
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "orange", "value": 0.1 },
              { "color": "red", "value": 0.5 }
            ]
          }
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "100 * (sum by (api) (rate(opendolphin_api_audit_missing_total{job=\"$service\",environment=~\"$env\",api=~\"$api\",facility=~\"$facility\",user=~\"$user\",run_id=~\"$runId\"}[$__rate_interval])) / sum by (api) (rate(http_requests_total{job=\"$service\",environment=~\"$env\",api=~\"$api\",facility=~\"$facility\",user=~\"$user\",run_id=~\"$runId\"}[$__rate_interval])))",
          "legendFormat": "{{api}}"
        }
      ],
      "gridPos": { "h": 8, "w": 8, "x": 0, "y": 17 }
    },
    {
      "type": "bargauge",
      "title": "dataSource breakdown (5m rate)",
      "datasource": { "type": "prometheus", "uid": "${prom}" },
      "fieldConfig": {
        "defaults": {
          "unit": "reqps",
          "thresholds": { "mode": "absolute", "steps": [ { "color": "green", "value": null } ] }
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "sum by (data_source) (rate(http_requests_total{job=\"$service\",environment=~\"$env\",api=~\"$api\",facility=~\"$facility\",user=~\"$user\",run_id=~\"$runId\",data_source!\"\"}[$__rate_interval]))",
          "legendFormat": "{{data_source}}"
        }
      ],
      "options": { "orientation": "horizontal", "displayMode": "gradient", "reduceOptions": { "calcs": ["lastNotNull"] } },
      "gridPos": { "h": 8, "w": 8, "x": 8, "y": 17 }
    },
    {
      "type": "logs",
      "title": "Loki search (runId/traceId)",
      "datasource": { "type": "loki", "uid": "${loki}" },
      "options": {
        "dedupStrategy": "none",
        "enableLogDetails": true,
        "prettifyLogMessage": true,
        "showTime": true,
        "wrapLogMessage": true,
        "queries": []
      },
      "targets": [
        {
          "expr": "{service=\"$service\", environment=~\"$env\"} |= \"runId\" |= \"$runId\"",
          "refId": "A"
        }
      ],
      "gridPos": { "h": 8, "w": 8, "x": 16, "y": 17 }
    }
  ],
  "annotations": {
    "list": [
      { "builtIn": 1, "datasource": "-- Grafana --", "enable": true, "hide": true, "iconColor": "rgba(0, 211, 255, 1)", "name": "Annotations & Alerts", "type": "dashboard" }
    ]
  },
  "links": [],
  "description": "ORCA-05/06/08 監視ダッシュボード draft。RUN_ID=20251124T142000Z (parent=20251124T000000Z). §7 SLA・release-plan 閾値を色分けに反映。"
}
