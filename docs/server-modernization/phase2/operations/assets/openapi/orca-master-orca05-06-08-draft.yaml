openapi: 3.0.3
info:
  title: ORCA Master APIs (ORCA-05/06/08) - Draft
  version: 0.1.0-draft
  description: |
    RUN_ID: 20251124T090500Z (parent: 20251124T000000Z)
    ORCA マスターデータ追加 REST の下書き。ORCA DB 定義書 (2024-04-26 正式版) と
    webclient_modernized_bridge の補完設計に基づく。実装前提: DataSource=java:/datasources/OrcaDb。
servers:
  - url: https://modernized.example.orca
    description: placeholder server for draft
  - url: http://localhost:8080
    description: local dev (MSW/snapshot 切替時に利用)
tags:
  - name: ORCA-05
    description: 薬剤分類・最低薬価・用法・特定器材・検査分類
  - name: ORCA-06
    description: 保険者・住所マスタ
  - name: ORCA-08
    description: 電子点数表（診療行為区分）
components:
  parameters:
    effectiveDate:
      name: effective
      in: query
      description: 取得基準日 (YYYYMMDD)。未指定は当日。
      required: false
      schema:
        type: string
        pattern: "^\\d{8}$"
    keyword:
      name: keyword
      in: query
      description: 部分一致検索キーワード（名称・カナ）
      required: false
      schema:
        type: string
        maxLength: 64
    page:
      name: page
      in: query
      description: 1 始まりのページ番号。既定 1。
      required: false
      schema:
        type: integer
        minimum: 1
        default: 1
    pageSize:
      name: size
      in: query
      description: 1 ページ件数。既定 100、最大 2000。
      required: false
      schema:
        type: integer
        minimum: 1
        maximum: 2000
        default: 100
  schemas:
    MasterMeta:
      type: object
      properties:
        version:
          type: string
          description: ORCA マスタ版 or DB スナップショット日付。
        runId:
          type: string
          description: ドキュメント/取得ログ共通の RUN_ID。
        snapshotVersion:
          type: string
          nullable: true
          description: スナップショットの基準日（MSW/snapshot 取得時）。
        dataSource:
          type: string
          enum: [server, snapshot, mock, fallback]
        cacheHit:
          type: boolean
        missingMaster:
          type: boolean
        fallbackUsed:
          type: boolean
        fetchedAt:
          type: string
          format: date-time
      required: [version, runId, dataSource, cacheHit, missingMaster, fallbackUsed]

    DrugMasterEntry:
      type: object
      description: ORCA-05 薬剤分類/最低薬価/用法/特定器材/検査分類を統合した最小項目。
      properties:
        code:
          type: string
          description: マスタコード（SRYCD など）
        name:
          type: string
        category:
          type: string
          description: 種別（generic/material/kensa/etc）
        unit:
          type: string
          nullable: true
        minPrice:
          type: number
          format: double
          nullable: true
        youhouCode:
          type: string
          nullable: true
        materialCategory:
          type: string
          nullable: true
        kensaSort:
          type: string
          nullable: true
        validFrom:
          type: string
          pattern: "^\\d{8}$"
        validTo:
          type: string
          pattern: "^\\d{8}$"
        note:
          type: string
          nullable: true
        meta:
          $ref: '#/components/schemas/MasterMeta'
      required: [code, name, category, validFrom, validTo, meta]

    InsurerEntry:
      type: object
      description: ORCA-06 保険者マスタ
      properties:
        payerCode:
          type: string
          description: 保険者番号
        payerName:
          type: string
        payerType:
          type: string
          description: 国保/社保/後期 など
        payerRatio:
          type: number
          format: double
        prefCode:
          type: string
        cityCode:
          type: string
        zip:
          type: string
        addressLine:
          type: string
        phone:
          type: string
          nullable: true
        meta:
          $ref: '#/components/schemas/MasterMeta'
      required: [payerCode, payerName, payerType, payerRatio, prefCode, cityCode, addressLine, meta]

    AddressEntry:
      type: object
      description: ORCA-06 住所マスタ（郵便番号→住所）
      properties:
        zip:
          type: string
        prefCode:
          type: string
        cityCode:
          type: string
        city:
          type: string
        town:
          type: string
        kana:
          type: string
        roman:
          type: string
          nullable: true
        fullAddress:
          type: string
        meta:
          $ref: '#/components/schemas/MasterMeta'
      required: [zip, prefCode, cityCode, city, town, fullAddress, meta]

    TensuEntry:
      type: object
      description: ORCA-08 電子点数表（診療行為区分）
      properties:
        tensuCode:
          type: string
        name:
          type: string
        kubun:
          type: string
          description: 区分コード（診療/薬剤/材料など）
        tanka:
          type: number
          format: double
        unit:
          type: string
        category:
          type: string
        startDate:
          type: string
          pattern: "^\\d{8}$"
        endDate:
          type: string
          pattern: "^\\d{8}$"
        tensuVersion:
          type: string
        meta:
          $ref: '#/components/schemas/MasterMeta'
      required: [tensuCode, name, kubun, tanka, unit, category, startDate, endDate, tensuVersion, meta]

paths:
  /orca/master/generic-class:
    get:
      tags: [ORCA-05]
      summary: 薬剤分類ツリー取得
      parameters:
        - $ref: '#/components/parameters/keyword'
        - $ref: '#/components/parameters/effectiveDate'
        - $ref: '#/components/parameters/page'
        - $ref: '#/components/parameters/pageSize'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  totalCount:
                    type: integer
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/DrugMasterEntry'
              examples:
                sample:
                  value:
                    totalCount: 2
                    items:
                      - code: "211"
                        name: "降圧薬"
                        category: "generic"
                        unit: "tablet"
                        minPrice: 8.5
                        youhouCode: null
                        materialCategory: null
                        kensaSort: null
                        validFrom: "20240401"
                        validTo: "99991231"
                        note: "正式版 2024-04-26"
                        meta:
                          version: "20240426"
                          runId: "20251124T090500Z"
                          snapshotVersion: "2025-11-23"
                          dataSource: "snapshot"
                          cacheHit: false
                          missingMaster: false
                          fallbackUsed: false
                          fetchedAt: "2025-11-24T09:06:00Z"
                      - code: "21101"
                        name: "ACE 阻害薬"
                        category: "generic"
                        unit: "tablet"
                        minPrice: 12.0
                        youhouCode: "Y001"
                        materialCategory: null
                        kensaSort: null
                        validFrom: "20240401"
                        validTo: "99991231"
                        note: null
                        meta:
                          version: "20240426"
                          runId: "20251124T090500Z"
                          snapshotVersion: "2025-11-23"
                          dataSource: "snapshot"
                          cacheHit: false
                          missingMaster: false
                          fallbackUsed: false
                          fetchedAt: "2025-11-24T09:06:00Z"

  /orca/master/generic-price:
    get:
      tags: [ORCA-05]
      summary: 薬価・最低薬価取得
      parameters:
        - name: srycd
          in: query
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/effectiveDate'
      responses:
        '200':
          description: 成功（ヒットなしは price=null）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DrugMasterEntry'
              examples:
                hit:
                  value:
                    code: "610008123"
                    name: "アムロジピン錠 5mg"
                    category: "generic-price"
                    unit: "TAB"
                    minPrice: 12.5
                    youhouCode: "Y003"
                    materialCategory: null
                    kensaSort: null
                    validFrom: "20240401"
                    validTo: "99991231"
                    meta:
                      version: "20240426"
                      runId: "20251124T090500Z"
                      snapshotVersion: "2025-11-23"
                      dataSource: "snapshot"
                      cacheHit: false
                      missingMaster: false
                      fallbackUsed: false
                      fetchedAt: "2025-11-24T09:06:10Z"
                noPrice:
                  value:
                    code: "699999999"
                    name: "未収載薬"
                    category: "generic-price"
                    unit: "TAB"
                    minPrice: null
                    youhouCode: null
                    materialCategory: null
                    kensaSort: null
                    validFrom: "20240401"
                    validTo: "99991231"
                    meta:
                      version: "20240426"
                      runId: "20251124T090500Z"
                      snapshotVersion: "2025-11-23"
                      dataSource: "snapshot"
                      cacheHit: false
                      missingMaster: true
                      fallbackUsed: true
                      fetchedAt: "2025-11-24T09:06:10Z"

  /orca/master/youhou:
    get:
      tags: [ORCA-05]
      summary: 用法マスタ取得
      parameters:
        - $ref: '#/components/parameters/keyword'
        - $ref: '#/components/parameters/effectiveDate'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DrugMasterEntry'
              examples:
                sample:
                  value:
                    - code: "10"
                      name: "1日1回 朝食後"
                      category: "youhou"
                      unit: null
                      minPrice: null
                      youhouCode: "10"
                      materialCategory: null
                      kensaSort: null
                      validFrom: "20240401"
                      validTo: "99991231"
                      meta:
                        version: "20240426"
                        runId: "20251124T090500Z"
                        snapshotVersion: "2025-11-23"
                        dataSource: "snapshot"
                        cacheHit: true
                        missingMaster: false
                        fallbackUsed: false
                        fetchedAt: "2025-11-24T09:06:20Z"

  /orca/master/material:
    get:
      tags: [ORCA-05]
      summary: 特定器材マスタ取得
      parameters:
        - $ref: '#/components/parameters/keyword'
        - $ref: '#/components/parameters/effectiveDate'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DrugMasterEntry'
              examples:
                sample:
                  value:
                    - code: "5001001"
                      name: "注射器 2.5mL"
                      category: "material"
                      unit: "EA"
                      minPrice: 35.0
                      materialCategory: "A1"
                      validFrom: "20240401"
                      validTo: "20250331"
                      meta:
                        version: "20240426"
                        runId: "20251124T090500Z"
                        snapshotVersion: "2025-11-23"
                        dataSource: "snapshot"
                        cacheHit: false
                        missingMaster: false
                        fallbackUsed: false
                        fetchedAt: "2025-11-24T09:06:30Z"

  /orca/master/kensa-sort:
    get:
      tags: [ORCA-05]
      summary: 検査分類マスタ取得
      parameters:
        - $ref: '#/components/parameters/keyword'
        - $ref: '#/components/parameters/effectiveDate'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DrugMasterEntry'
              examples:
                sample:
                  value:
                    - code: "1101"
                      name: "血液検査"
                      category: "kensa-sort"
                      unit: null
                      kensaSort: "11"
                      validFrom: "20240401"
                      validTo: "99991231"
                      meta:
                        version: "20240426"
                        runId: "20251124T090500Z"
                        snapshotVersion: "2025-11-23"
                        dataSource: "snapshot"
                        cacheHit: true
                        missingMaster: false
                        fallbackUsed: false
                        fetchedAt: "2025-11-24T09:06:40Z"

  /orca/master/hokenja:
    get:
      tags: [ORCA-06]
      summary: 保険者検索
      parameters:
        - name: pref
          in: query
          required: false
          description: 都道府県コード（JIS）
          schema:
            type: string
        - $ref: '#/components/parameters/keyword'
        - $ref: '#/components/parameters/effectiveDate'
        - $ref: '#/components/parameters/page'
        - $ref: '#/components/parameters/pageSize'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  totalCount:
                    type: integer
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/InsurerEntry'
              examples:
                sample:
                  value:
                    totalCount: 1
                    items:
                      - payerCode: "06123456"
                        payerName: "札幌市国民健康保険"
                        payerType: "national_health"
                        payerRatio: 0.7
                        prefCode: "01"
                        cityCode: "01100"
                        zip: "0600001"
                        addressLine: "北海道札幌市中央区北一条西2"
                        phone: "011-123-4567"
                        meta:
                          version: "20240426"
                          runId: "20251124T090500Z"
                          snapshotVersion: "2025-11-23"
                          dataSource: "snapshot"
                          cacheHit: false
                          missingMaster: false
                          fallbackUsed: false
                          fetchedAt: "2025-11-24T09:07:00Z"

  /orca/master/address:
    get:
      tags: [ORCA-06]
      summary: 郵便番号から住所 1 件取得
      parameters:
        - name: zip
          in: query
          required: true
          schema:
            type: string
            pattern: "^\\d{7}$"
        - $ref: '#/components/parameters/effectiveDate'
      responses:
        '200':
          description: 成功（ヒットなしは空オブジェクト）
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/AddressEntry'
                  - type: object
              examples:
                hit:
                  value:
                    zip: "1000001"
                    prefCode: "13"
                    cityCode: "13101"
                    city: "千代田区"
                    town: "千代田"
                    kana: "チヨダク チヨダ"
                    roman: "Chiyoda-ku Chiyoda"
                    fullAddress: "東京都千代田区千代田"
                    meta:
                      version: "20240426"
                      runId: "20251124T090500Z"
                      snapshotVersion: "2025-11-23"
                      dataSource: "snapshot"
                      cacheHit: false
                      missingMaster: false
                      fallbackUsed: false
                      fetchedAt: "2025-11-24T09:07:10Z"
                empty:
                  value:
                    {}

  /orca/tensu/etensu:
    get:
      tags: [ORCA-08]
      summary: 電子点数表検索
      parameters:
        - $ref: '#/components/parameters/keyword'
        - name: category
          in: query
          required: false
          description: 区分コード（例: 11=診療、21=薬剤、31=特定器材）
          schema:
            type: string
        - name: asOf
          in: query
          required: false
          description: 適用日 (YYYYMMDD)
          schema:
            type: string
            pattern: "^\\d{8}$"
        - name: tensuVersion
          in: query
          required: false
          description: 点数表版。未指定は最新。
          schema:
            type: string
        - $ref: '#/components/parameters/page'
        - $ref: '#/components/parameters/pageSize'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  totalCount:
                    type: integer
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/TensuEntry'
              examples:
                sample:
                  value:
                    totalCount: 2
                    items:
                      - tensuCode: "110000001"
                        name: "初診料"
                        kubun: "11"
                        tanka: 288
                        unit: "visit"
                        category: "診察"
                        startDate: "20240401"
                        endDate: "99991231"
                        tensuVersion: "202404"
                        meta:
                          version: "202404"
                          runId: "20251124T090500Z"
                          snapshotVersion: "2025-11-23"
                          dataSource: "snapshot"
                          cacheHit: false
                          missingMaster: false
                          fallbackUsed: false
                          fetchedAt: "2025-11-24T09:07:30Z"
                      - tensuCode: "110000101"
                        name: "再診料"
                        kubun: "11"
                        tanka: 75
                        unit: "visit"
                        category: "診察"
                        startDate: "20240401"
                        endDate: "99991231"
                        tensuVersion: "202404"
                        meta:
                          version: "202404"
                          runId: "20251124T090500Z"
                          snapshotVersion: "2025-11-23"
                          dataSource: "snapshot"
                          cacheHit: true
                          missingMaster: false
                          fallbackUsed: false
                          fetchedAt: "2025-11-24T09:07:30Z"
        '404':
          description: 該当なし（空コレクションも可）
        '503':
          description: ORCA DB 不整合またはキャッシュ障害
