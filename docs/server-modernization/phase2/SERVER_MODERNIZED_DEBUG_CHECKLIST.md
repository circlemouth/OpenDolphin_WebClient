# server-modernized デバッグチェックリスト（2026-06-15）

server-modernized モジュールのデバッグ状況を把握するためのチェックリスト。  
各項目は **新 Web クライアントと連携する Modernized サーバー** の完成度を確認することを目的とし、Legacy サーバー／旧クライアントは参照用の比較材料に限定する。旧クライアントとの互換や Legacy 単体の 200 応答は完了条件ではない。進捗更新時は本ファイルと `PHASE2_PROGRESS.md` の両方を更新すること。

## ステータス凡例

- `[x]` … 完了
- `[ ]` … 未完了（未着手または進行中。備考欄で詳細を記載）

---

### 2025-11-07 追記: Webクライアント非依存デバッグ基本方針

- Web クライアントが未完成な期間は Legacy サーバーからの実測リクエスト/レスポンス → Modernized へのリプレイ → サーバー内部メトリクス採取の 3 レイヤーで同等性を証跡化する。
- すべての検証は CLI／スクリプト（`ops/tools/send_parallel_request.sh`, `ops/tests/api-smoke-test/`, curl/httpie, WildFly control スクリプトなど）で完結させ、Web UI 操作を前提にしない。
- Legacy/Modernized 並列キャプチャ環境の構築 Runbook を `docs/server-modernization/phase2/operations/` に整備し、`PHASE2_PROGRESS.md` へリンクと更新日時を記録するまで他フェーズのステータスを「完了」にしない。
- 新規や更新した Runbook／スクリプトの保存先を本ファイルの備考欄に必ず記載し、証跡（ログ・diff・ハッシュなど）は `artifacts/parity-manual/` 配下に時刻付きフォルダで保管する。

### 2025-11-19 追記: WebORCA トライアル接続と CRUD ログ方針

- ORCA 連携検証の接続先を **WebORCA トライアルサーバー**（`https://weborca-trial.orca.med.or.jp/`）へ切り替え、Basic 認証 `trial/weborcatrial` のみで疎通させる。`ORCAcertification/` 配下の PKCS#12、`curl --cert-type P12`、`weborca.cloud.orcamo.jp` へのアクセス記述はアーカイブ済みとし、参照時は `docs/server-modernization/phase2/operations/assets/orca-trialsite/raw/trialsite.md` を根拠にする。
- `ops/shared/docker/custom.properties` / `ops/modernized-server/docker/custom.properties` の `claim.host`, `claim.scheme`, `claim.send.encoding` は Trial 向けの HTTP Basic 前提へ更新する。`/serverinfo/claim/conn` の疎通確認は `curl -u trial:weborcatrial https://weborca-trial.orca.med.or.jp/api/system01dailyv2?class=01` など Basic のみで再取得する。
- Trial 環境では「新規登録／更新／削除 OK（トライアル環境でのみ）」と定義し、CRUD を行った際は `RUN_ID=YYYYMMDDTorcaTrialCrudZ#` を採番して `artifacts/orca-connectivity/<RUN_ID>/trial/` に `httpdump/trace/ui` を保存する。ログサマリは `docs/server-modernization/phase2/operations/logs/2025-11-19-orca-trial-crud.md` および `ORCA_HTTP_404405_HANDBOOK.md#trial-crud-logging` に追記して監査可能にする。
- `docs/server-modernization/phase2/operations/EXTERNAL_INTERFACE_COMPATIBILITY_RUNBOOK.md` の ORCA 節へ「2025-11-19: WebORCA Trial + CRUD」段落を追加し、Basic 認証手順と CRUD ログ手順を統一する。`PHASE2_PROGRESS.md` / `ORCA_API_STATUS.md` / `DOC_STATUS.md` の ORCA 行には「2025-11-19 trial 切替＋CRUD 許可」を同日付で反映する。

### 2025-11-19 追記: 初期ユーザー登録時の FK 違反問題

- **状況**: サーバー再構築後の初期ユーザー登録（`POST /openDolphin/resources/user`）で `PSQLException: ERROR: insert or update on table "d_roles" violates foreign key constraint "fk_roles_user"` が発生。`UserModel` がデータベースに保存される前に `RoleModel` の挿入が試みられる。
- **実施した修正（RUN_ID=`20251119T132300Z`）**:
  1. `UserModel.java` から `cascade=CascadeType.ALL` を削除し、SystemServiceBean と同じパターンに統一
  2. `UserServiceBean.addUser` で `em.merge()` を `em.persist()` に変更し、`role.setUserId(add.getUserId())` を追加
  3. 認証問題を解決（MD5 ハッシュ `e88df8596ff8847e232b1e4b1b5ffde2` を password ヘッダーとして使用）
- **RuntimeException テスト結果（RUN_ID=`20251119T220900Z`）**: `UserServiceBean.addUser` の先頭に `throw new RuntimeException("DEBUG: UserServiceBean.addUser called!")` を挿入してビルド・デプロイし、doctor 登録 API を呼び出したところ、例外が正常に発生。これによりデプロイされたコードは確実に実行されていることを確認。
- **根本原因**: `em.persist(add)` と `em.flush()` を呼び出しても、Hibernate が UserModel の INSERT 文を実行していない。SystemServiceBean.addFacilityAdmin では Facility を先に persist することで成功しているが、UserServiceBean では既存 facility を使用するため、Hibernate が UserModel の INSERT を遅延させている。ID 352, 402 の UserModel が生成されているが、データベースには保存されず FK 違反が発生。
- **最終解決策（実施中）**: PostgreSQL sequence から UserModel の ID を手動生成し、`em.persist()` 前に設定する。これにより Hibernate の遅延 INSERT に依存せず、確実にデータベースへ保存できる。
  ```java
  Number nextId = (Number) em.createNativeQuery("select nextval('d_users_id_seq')").getSingleResult();
  add.setId(nextId.longValue());
  em.persist(add);
  em.flush();
  ```
- **証跡**: `artifacts/parity-manual/user-registration/20251119T132300Z/` に全テスト結果を保存。詳細な分析は `docs/server-modernization/phase2/notes/user-registration-fk-violation-analysis.md` を参照。
- **関連ドキュメント**: `PHASE2_PROGRESS.md` にも 2025-11-19 時点の進捗として反映すること。


- Ops/DBA の公式 Postgres dump 提供待ちを前提にすると進捗が停滞するため、フェーズ2ではローカル合成ベースライン（Hibernate 自動 DDL + `ops/db/local-baseline/local_synthetic_seed.sql`) を正式な標準フローとする。  
- これに伴い `【Deferred-Ops/DBA】` プレフィックスを廃止し、過去に Deferred としていたタスクもローカルシード上で即時実行できるように整理した。`PHASE2_PROGRESS.md` からも Deferred ステータスを削除し、通常トラッキングへ戻すこと。  
- 2FA・監査ログ・REST 例外検証は合成ベースラインで `d_factor2_*` / `d_audit_event` を生成した上で進める。公式 dump を活用した再検証はフェーズ4以降のオプション扱いとし、Gate #40/#44 ではローカル証跡でクローズできる。  
- `POSTGRES_BASELINE_RESTORE.md` は Secrets/VPN 前提の記述を削除し、ローカル合成ベースラインの詳述へ更新済み。Runbook 参照時は節 0〜4 を順に実行すれば Ops への依頼なしで DB を復旧できる。

## フェーズ0: 事前準備・資料棚卸し

> **2026-06-14 更新:** ステークホルダー合意によりフェーズ0タスクは現行デバッグスコープから除外する。今後の進捗管理ではフェーズ1以降のみ追跡対象とする。

- [x] モダナイズ関連ドキュメント（`docs/server-modernization/` 配下）を精読し、既存ツールとスクリプトの利用可否を整理する（備考: `api-smoke-test.md`, `operations/API_PARITY_RESPONSE_CHECK.md` を確認済み）
- [x] Codex 向け環境構築スクリプト `scripts/setup_codex_env.sh` の実行可否と必要な権限を確認する（備考: 2025-11-07 `artifacts/parity-manual/setup/20251107T234615Z/` のログで CRLF 行末による失敗と root 権限必須を証跡化。`docs/server-modernization/phase2/operations/LEGACY_MODERNIZED_CAPTURE_RUNBOOK.md` に CLI 前提の実行手順・注意事項を追記し、`PHASE2_PROGRESS.md` とリンクを同期済み）
- [x] Docker Compose (`docker-compose.modernized.dev.yml`) のサービス構成を確認し、デバッグ時の起動順序・依存関係を明文化する（備考: 上記 Runbook にサービス表・起動順序・フォールバック手順・証跡保存ポリシーを追加し、`ops/tools/send_parallel_request.profile.env.sample` で `MODERNIZED_TARGET_PROFILE` を `compose`/`remote-dev`/`custom` へ切り替えるテンプレートを提供済み）
- [x] `scripts/**` および `ops/tools/**` の行末を LF に統一し、CRLF 由来の実行失敗を防止する（備考: `.gitattributes` で対象拡張子を `text eol=lf` に固定し、`git add --renormalize .` + `perl -pi -e 's/\\r$//'` で `scripts/setup_codex_env.sh` / `scripts/run-static-analysis-diff.sh` を LF 化。詳細は `docs/server-modernization/phase2/operations/DEV_ENV_COMPATIBILITY_NOTES.md`、証跡は `artifacts/parity-manual/setup/20251108-renormalize/` を参照）

## フェーズ1: ビルド・依存性確認

- [x] `mvn -pl server-modernized -am clean verify -DskipTests` を実行し、ビルド警告および Jakarta 依存差分を記録する（備考: 2025-11-06 `mvn -f server-modernized/pom.xml clean verify -DskipTests` 実行。`Base64Utils` / `Long(long)` / `Character(char)` などの非推奨 API 警告を確認済み。**指針: 非推奨 API 対応は開発完了後の課題として別途チケット化する**）
- [x] `META-INF/persistence.xml` など Jakarta EE 10 対応設定をレビューし、スキーマ不一致を洗い出す（備考: `persistence.xml` は 3.1、`ejb-jar.xml` は 4.0 スキーマで整合。データソース/hibernate プロパティに不一致なし）
- [x] 共通モジュール（`common/`）との互換性確認を実施し、DTO/エンティティの差分一覧を作成する（備考: `notes/common-dto-diff-A-M.md` と `notes/common-dto-diff-N-Z.md` で Legacy との差分・新規 DTO・リスク評価を整理。Archive 版は `../archive/2025Q4/server-modernization/phase2/notes/common-dto-diff-A-M.md` / `.../common-dto-diff-N-Z.md` を参照。PHR 系フィールド追加、FirstEncounter 系削除、監査/2FA/ケアプラン新規 DTO、Hibernate 6 の CLOB 対応などフォローアップ課題を抽出済み）
- [x] Maven duplicate 恒久対応: ルート `pom.xml` / `pom.server-modernized.xml` / `server-modernized/pom.xml` の `<modules>`・`<artifactId>` を再点検し、Legacy (`opendolphin-server`) と Modernized (`opendolphin-server-modernized`) の GAV がユニークであることを証跡化。RUN_ID=`20251116TreactorFixZ1` にて `mvn -f pom.server-modernized.xml -pl server-modernized -am help:effective-pom -DskipTests` と `... package -DskipTests` を連続実行し、`Project "opendolphin:opendolphin-server:2.7.1" is duplicated` が再発しないことを確認した。ログは `artifacts/parity-manual/build/duplicate_project/20251116TreactorFixZ1/{help_effective_pom.log,mvn_package.log}` と `server-modernized-target-ls.txt`（`opendolphin-server.war` finalName 維持）へ保存済み。
- [x] AuditTrailService Java8 互換対応: `common/src/main/java/open/dolphin/audit/{AuditTrailService,AuditEventEnvelope}.java` から Java 9 以降専用構文（`private` インターフェースメソッド / `Map.of()` / `String#isBlank()`）を排除し、`requireNonBlank`/`isNullOrBlank` ヘルパーへ移行した。差分は `patches/audit_trail_java8_fix.diff`、検証ログは `artifacts/parity-manual/build/audit_trail_java8_fix/mvn-compile.log`（`mvn -rf :opendolphin-common -DskipTests compile` 実行結果）に保存済み。`opendolphin-common` を Java 8 で単体ビルドする際の再現手順として本行を参照する。
- [x] Legacy build（`pom.server-classic.xml` + `-Plegacy-wildfly10`）: 2025-11-12 22:15 JST 時点で `AuditTrailService` / `StampResource` / `StampServiceBean` の Java 8 互換化が完了し、`scripts/start_legacy_modernized.sh start --build` で `server/target/opendolphin-server-2.7.1.war` が再生成されるところまで確認済み。`TypedQuery` 依存は `server/pom.xml` の `javax.persistence:javax.persistence-api:2.2`（scope=provided）で解決し、Stamp 系ロガーは `patches/legacy_stamp_logger_fix.diff` のとおり `LOGGER.log(Level, message, ex)` へ戻した。`mvn -f pom.server-classic.xml -pl server -am -Plegacy-wildfly10 -DskipTests package` の実行ログは `artifacts/parity-manual/build/legacy_war_missing/{mvn-package-server.fix.log,mvn-package-stamp-logger.log}`、`dependency:tree` は `mvn-deptree-server.fix.log`、`server/target` の成果物は `server-target-ls.txt` を参照。**2025-11-12 追記:** `patches/legacy_war_rename_fix.diff` どおり WAR リネーム時の `ls "server/target"/*.war` quoting を修正し、`artifacts/parity-manual/build/legacy_war_missing/start_legacy_modernized_fix.log` に `+ FIRST_WAR=server/target/opendolphin-server-2.7.1.war` → `+ mv ...` の実行ログを保存した。Dockerfile (legacy/modernized) と `scripts/start_legacy_modernized.sh` を同時更新済み。
  **2025-11-13 追記 / RUN_ID=`20251118TlegacyFixZ1`:** `server/pom.xml` / `pom.server-classic.xml` の `maven-compiler-plugin` を 3.11.0 + `<release>8</release>` + `-Xlint:unchecked` に更新し、JDK17 上での `bootstrap class path not set in conjunction with -source 8` を解消。`server/src/main/java/open/dolphin/adm20/converter/IDocInfo.java` は `admFlag` フィールド/アクセサを単一化、`server/src/main/java/open/dolphin/touch/JsonTouchResource.java` は `handleDocumentPayload` 追加＋dryRunヘルパー同期で Modernized 版と同じ DTO 初期化フローを利用できるようにした。成功ログは `artifacts/parity-manual/build/legacy_server_compile/20251118TlegacyFixZ1/mvn_package.log`。

## フェーズ2: 静的解析・コードマッピング

- [x] `server-modernized/src/main/java` をレイヤー別に整理し、循環依存や未使用コンポーネントを棚卸しする（備考: `docs/server-modernization/phase2/notes/server-layer-map.md` を 2026-06-14 版へ更新済み。`VitalServiceBean` 未使用・`UserCache` 再設計などを `notes/static-analysis-findings.md` に記録）
- [x] フィルター/インフラ層（例: `LogFilter`, `RequestMetricsFilter`）の挙動をレビューし、ログ・トレース ID の伝搬状況を可視化する（備考: `docs/server-modernization/phase2/notes/infrastructure-trace-review.md` へテキストシーケンスとログ採取手順を追記。`tmp/trace-review/sa-static-map-20260614.log` に調査ログを保存）
- [x] 静的解析ツール導入可否を調査し、CI 反映方針をまとめる（備考: `docs/server-modernization/phase2/notes/static-analysis-plan.md` / `notes/static-analysis-findings.md` に SpotBugs/Checkstyle/PMD の導入方針と Jenkins/GitHub Actions 実装、Nightly CPD 設計、差分ゲート手順、Ops への資格情報・通知運用フローを記録。`PHASE2_PROGRESS.md` にも 2026-06-14 時点の進捗・残タスクを反映済み）
- [x] Legacy/Modernized Postgres ベースライン復旧計画を Runbook 化し、DB 欠損が発生した際の Gate と証跡フローを整備する（備考: `docs/server-modernization/phase2/operations/POSTGRES_BASELINE_RESTORE.md` 節3/4/6を 2025-11-09 版へ改訂し、`psql -h localhost` シード手順・`flyway/flyway:10.17` コマンド例・失敗パターン表・Gate 章立てを追記。証跡は `artifacts/parity-manual/db-restore/20251109T200035Z/` に集約し、`LEGACY_MODERNIZED_CAPTURE_RUNBOOK.md` 0章からリンク済み）

## フェーズ3: REST/API レイヤー

- [x] 代表エンドポイント（`open.dolphin.rest`）のシグネチャとレスポンス DTO を Legacy 実装と diff し、差分レポートを作成する（備考: `docs/server-modernization/phase2/notes/rest-touch-diff-report.md` に `/jtouch` vs `/10/adm/jtouch` の機能表・公開方針を整理済み。Legacy 限定 API の切り分けと Impact 記載を完了）
- [x] SSE / ポーリング併用エンドポイント（`ChartEvent*`）の挙動をデバッグし、再接続および認証フローの検証ステップを定義する（備考: `rest-touch-diff-report.md` に再送仕様/履歴100件の評価とギャップ検知フローを追記。`docs/server-modernization/phase2/operations/EXTERNAL_INTERFACE_COMPATIBILITY_RUNBOOK.md` 手順8へ Last-Event-ID ギャップ再接続手順および `chart-events.replay-gap` の受信時対応を記載。`ChartEventSseSupport` は Micrometer メトリクス、WARN ログ、SSE reload イベント、Alert ルール案（`ops/monitoring/chart-event-alerts.yml`）およびシミュレーター (`ops/monitoring/scripts/chart-event-metrics-sim.mjs`) で運用フローと閾値調整まで整備済み。Stage 実測メトリクスの取得は VPN 情報待ちのため保留、代替案を `worker-directives-20260614.md` へ記録済み。Reception/Charts/Touch UI のリプレイギャップ仕様と React 実装は `docs/web-client/operations/RECEPTION_WEB_CLIENT_MANUAL.md` / `web-client/src/features/replay-gap/*` に反映、`/rest/charts/patientList` & `sendReplayGapAudit` の正式実装・テストも完了し、Touch reload 監査・実機テストは後続タスク）
- [x] DTO コンバータ群の Jackson 設定差異を洗い出し、互換性リスクを整理する（備考: `LegacyObjectMapperProducer` に JavaTimeModule/WRITE_DATES_AS_TIMESTAMPS=false を追加し、ADM10/20/Touch/EHT リソースすべてが CDI `ObjectMapper` を利用。`JsonTouchResourceParityTest` に JavaTime ペイロード検証を追加し、`rest-touch-diff-report.md` / `touch-api-parity.md` にロールアウト記録と JavaTime 監視手順（`OBSERVABILITY_AND_METRICS.md`、Runbook 186 行付近）を追記。Stage/Prod 監視とエスカレーションフローも同ドキュメントに記録済み）

## フェーズ4: セッション層・ドメインロジック

- [x] 主要サービス (`KarteServiceBean`, `PatientServiceBean` など) のトランザクション境界と JPQL をレビューし、Legacy との差異を網羅表にまとめる（備考: RUN_ID=`20251110T122417Z` で macOS Docker Desktop から `ops/tools/send_parallel_request.sh --profile compose` を実行。HTTP/ヘッダー/JPQL/`docker compose logs`/`d_audit_event` 実行ログを `artifacts/parity-manual/JPQL/20251110T122417Z/<service>/` と README に整理し、`docs/server-modernization/phase2/notes/domain-transaction-parity.md` §3/§3.2/付録A および `rest_error_scenarios.manual.csv` に反映した。Patient=Modern 500 (`SessionServiceException`), Karte=Modern 400 (`KarteBeanConverter` null), Schedule=Modern `{\"list\":null}`, Appo=両環境 200（reseeding 前提）であることを記録。`d_audit_event` は Legacy=空 / Modern=SYSTEM_ACTIVITY のみだったため、TraceId を記録できるよう Elytron/JACC 修正を TODO として継続。)
  2026-06-16 追記: 旧 RUN_ID (`20251109T201157Z`, `20251110T002451Z`, `20251110T034844Z`) の README に CLI 条件・TraceId・`docker compose exec db-{legacy,modern}` 不可理由を追記し、Mac 側での再取得手順を `PHASE2_PROGRESS.md` (2025-11-10/11 節) と連動させた。
  2026-06-16 追記2: `artifacts/parity-manual/persistence-check/20251110T122417Z/persistence_class_check.txt` に PatientVisitModel/AppointmentModel が登録済みであることを証跡化し、Modern DB には `public.d_patient_seq` を追加・`setval` してから `/tmp/reseed_appo.sql` を投入する Appo re-seed フローを確立。README には再取得条件・reseeding・監査取得コマンドを追記し、`docs/server-modernization/phase2/notes/domain-transaction-parity.md` §3/§3.2/付録A と `docs/web-client/planning/phase2/DOC_STATUS.md`・`ops/tests/api-smoke-test/rest_error_scenarios.manual.csv` を最新 RUN_ID に同期済み。
- [x] 予約/予定カルテ/紹介状/ラボ/スタンプ系 REST（`/appo`, `/schedule`, `/odletter`, `/lab`, `/stamp`）とサービス層（`AppoServiceBean`, `ScheduleServiceBean`, `LetterServiceBean`, `NLabServiceBean`, `StampServiceBean`）の CRUD・監査ログ・JMS 連携を Legacy 実装と突き合わせる
  - ✅ **完了（RUN_ID=`20251111TstampfixZ3`）**: helper コンテナ経由で `ops/tools/send_parallel_request.sh` を再実行し、`PUT /stamp/tree`／`GET /stamp/tree/9001`／`rest_error_stamp_data_exception` を 200/200 で揃えた。`ops/db/local-baseline/stamp_tree_oid_cast.sql` 再適用と Modern DB への `d_subscribed_tree` 追加で GET 500 を解消し、`logs/d_audit_event_stamp_{legacy,modern}.tsv` / `logs/jms_dolphinQueue_read-resource*.txt` に TraceId=`parity-stamp-20251111TstampfixZ3`（Audit=両環境記録, JMS=`messages-added=4L`）を保存済み。`tmp/parity-letter/stamp_tree_payload.json` も versionNumber=11 を反映した最新版へ更新し、`rest_error_scenarios.manual.csv` / Runbook / Appendix を同 RUN_ID に同期済み。
  - ✅ **公開系 GET 完了（RUN_ID=`20251113Tstamp{Public,Shared,Published}PlanZ1`）**: `/stamp/tree/{facility}/{public|shared|published}` を Legacy/Modern 双方に実装し、helper コンテナ（`--network legacy-vs-modern_default`）から `GET /stamp/tree/9001/<variation>` を実行。public/shared/published の全 variation が Legacy/Modern=200 となり、`artifacts/parity-manual/stamp/20251113Tstamp<Variation>PlanZ1/` に HTTP/headers/meta と `logs/d_audit_event_stamp_<variation>_{legacy,modern}.tsv`（TraceId=`parity-stamp-tree-<variation>-...Z1`）および `logs/jms_dolphinQueue_read-resource{,_legacy}.{before,after}.txt`、`send_parallel_request.log` を保存した。facility ミスマッチ検証（`RUN_ID=20251113TstampPublicPlanZ4`, `/stamp/tree/9002/public`）では両環境とも 403 となり、WARN ログを `...Z4/logs/{legacy,modern}_warn.log` へ採取済み。
  - ✅ **Appo/Schedule Audit/JMS 実装完了（RUN_ID=`20251115TappoSchedPlanZ`）**: `SessionAuditDispatcher` を実装し、`tmp/reseed_appo.sql` で Legacy/Modern の `d_appo` を初期化 → helper コンテナから `ops/tools/send_parallel_request.sh --profile modernized-dev` で `rest_audit_{appo,schedule}_trace` を実行。Appo は `d_audit_event` に `APPOINTMENT_MUTATION`（成功/失敗ともに `actor_id=1.3.6.1.4.1.9414.72.103:doctor1`, `request_id=trace-audit-appo-20251115TappoSchedPlanZ`）を記録し、Modern JMS `messages-added=4L→5L`（Legacy=0L）を `artifacts/parity-manual/appo/20251115TappoSchedPlanZ/logs/jms_dolphinQueue_read-resource{,_legacy}.{before,after}.txt` で確認。Schedule も `SCHEDULE_FETCH` 監査が Legacy/Modern 双方に 1 行ずつ残り、JMS は変化 0（想定どおり）。HTTP/headers/meta, `logs/d_audit_event_{legacy,modern}.tsv`, reseed 手順を `artifacts/parity-manual/{appo,schedule}/20251115TappoSchedPlanZ/` へ保存し、`TRACEID_JMS_RUNBOOK.md` Appendix A および `rest_error_scenarios.manual.csv` の該当ケースを同 RUN_ID に更新した。
  - 🔁 **残課題・Backlog（フェーズ4-2 継続）**:
    2. **Letter/Lab Audit（RUN_ID=`20251115TletterAuditZ1` / `20251115TlabAuditZ1` で Evidence 採取済み）**: `SessionAuditDispatcher` を追加し、`LetterServiceBean` / `NLabServiceBean` の CRUD で `LETTER_CREATE` / `LAB_TEST_READ` を `d_audit_event` に記録できるようにした。Modern 側は `logs/d_audit_event_{letter,lab}_modern.tsv` で TraceId=`trace-letter-audit-*` / `trace-lab-audit-*` を確認、`logs/jms_dolphinQueue_read-resource.{before,after}.txt` でも `messages-added` が 0L→1L→2L へ増分。Legacy は Audit/JMS が未連携（Lab は seed 未適用のため 404）であることを Evidence と `rest_error_scenarios.manual.csv` に明記し、seed 復旧後の再取得を TODO として残す。関連ドキュメント: `domain-transaction-parity.md §4`、`TRACEID_JMS_RUNBOOK.md §5.8`、`patches/letter_lab_audit_plan.md`（DONE 判定）。
    2. 【2025-11-12 対応済み】`AuditTrailService` を `(REQUIRES_NEW)` に変更し、`AppoServiceBean` / `ScheduleServiceBean` が `SessionTraceContext` から actorId/requestId/traceId/patientId を補完するよう更新。`ScheduleServiceBean#removePvt` の details も `pvtDeletedCount` / `documentsDeletedCount` / `documentsDeletedStatus` に分割した。差分は `patches/appo_schedule_audit_fix.diff` および `domain-transaction-parity.md §3.4` を参照。残課題は JMS ディスパッチ (`SessionAuditDispatcher`) 実装と RUN_ID=`20251115TappoSchedPlanZ` での Evidence 取得。
    2. Legacy JMS は Stamp parity でも `message-count=0L` を継続。`TRACEID_JMS_RUNBOOK.md` §4.1 / `LEGACY_MODERNIZED_CAPTURE_RUNBOOK.md` §3.4 で before/after ログ取得フローを整備済みだが、`messages-added` が増えないことから MDB or consumer が停止している疑いが濃厚。**次アクション: `StampSenderMDB` 再起動 → `messages-added` 変化確認 → `standalone-full.xml` / `ejb-jar.xml` の JMS 設定整合性チェック**（マネージャー指示待ち）。
    3. `GET /stamp/tree/{facility}/{public|shared|published}` は RUN_ID=`20251113TstampPublicPlanZ1`（public）/`20251113TstampSharedPlanZ1`（shared）/`20251113TstampPublishedPlanZ1`（published）で Legacy/Modern=200 と監査ログを取得済み。`ops/db/local-baseline/stamp_public_seed.sql` へ facility=`9001` / user=`9001:doctor1` のシード追加を行い、`TRACEID_JMS_RUNBOOK.md` Appendix A.4 の helper 手順も `--network legacy-vs-modern_default` 版へ更新した。残タスクは Letter/Lab Audit と JMS `SessionAuditDispatcher` 最終化のみ。**参考:** 施設ミスマッチ 403 の WARN ログは `RUN_ID=20251113TstampPublicPlanZ4` で採取済み。
    4. Letter FK/JMS（`fk_d_letter_module_karte`）と Lab DTO/Audit の 500/空ログ解消、`ops/db/local-baseline/` reseed フロー、`rest_error_{letter_fk,lab_empty}` の Audit 取得を Issue 化し、`artifacts/parity-manual/{letter,lab}/<next RUN_ID>/logs/` へ TraceId を必ず残す。
    5. **Factor2 / Messaging backlog**:
       - ✅ **Factor2 TOTP/FIDO parity（RUN_ID=`20251118Tfactor2ParityZ2`）**: helper コンテナ＋`tmp/factor2/factor2_totp_registration.config` で `/20/adm/factor2/{totp/registration,fido2/registration/options,fido2/assertion/options}` を再実行。Modern=200・Legacy=404（Legacy WildFly10 では当該 REST を公開していないため想定内）を確認し、`artifacts/parity-manual/factor2/20251118Tfactor2ParityZ2/` に HTTP/headers/meta・`logs/send_parallel_request.log`・`logs/jms_dolphinQueue_read-resource{,_legacy}.{before,after}.txt`（Modern `messages-added`=23L→26L）・`logs/d_audit_event_factor2_{modern,legacy}.tsv` を保存した。`SessionAuditDispatcher` 経由で `TOTP_REGISTER_INIT` / `FIDO2_{REGISTER,ASSERT}_INIT` が `d_audit_event` へ 1 行ずつ残り、`d_factor2_{credential,challenge}` CSV で副作用も採取済み。レスポンスの `secret` / `provisioningUri` は README でマスク済み。
  - ✅ **Claim/Diagnosis/MML dispatch（RUN_ID=`20251118TmessagingParityZ2` → `20251118TdiagnosisLegacyZ1` → `20251118TdiagnosisAuditZ2`）**: helper コンテナ（`--network legacy-vs-modern_default`）から `ops/tools/send_parallel_request.sh` を実行し、Claim=Legacy/Modern 200、MML=Legacy 404（未実装）/Modern 200 を維持したまま、Diagnosis を Legacy 500→200 へ改善。対策は (1) `tmp/diagnosis_seed.sql` で Legacy Postgres に患者/カルテ/レター/診断シード＋シーケンス setval を投入（監査採取前にも毎回再投入）、(2) `tmp/configure-wildfly.legacy.cli` 経由で `dolphin.claim` logger level=INFO を常設し `DiagnosisSender` NPE を排除、(3) `RUN_ID=20251118TdiagnosisLegacyZ1` で HTTP/headers/meta/JMS を `artifacts/parity-manual/messaging/20251118TdiagnosisLegacyZ1/` へ保存、(4) `RUN_ID=20251118TdiagnosisAuditZ2` で Legacy/Modern 両サーバーに audit hook/WAR を展開し、`artifacts/parity-manual/messaging/20251118TdiagnosisAuditZ2/logs/d_audit_event_diagnosis_{legacy,modern}.tsv` に `EHT_DIAGNOSIS_CREATE` (TraceId=`parity-diagnosis-send-20251118TdiagnosisAuditZ2`) が残ることを確認した。Legacy JMS は 0L→0L（サーバー直送）、Modern は enqueue 対象外。Appendix A.6 / `PHASE2_PROGRESS.md` にも RUN_ID と証跡先を追記済み。
    6. **Lab module GET Audit/JMS（RUN_ID=`20251112TlabReportZ1`）**: `tmp/parity-headers/lab_report_TEMPLATE.headers`（`userName=1.3.6.1.4.1.9414.72.103:doctor1`, `password=doctor2025`）で `/lab/module/WEB1001,0,5` を再取得し、Modern 側は `logs/d_audit_event_lab_modern.tsv` に `LAB_TEST_READ` を記録、`logs/jms_dolphinQueue_read-resource.{before,after}.txt` は `messages-added=10L→12L` を確認。Legacy は 200 応答だが Audit/JMS は従来どおり記録されないため backlog 継続（`artifacts/parity-manual/lab/20251112TlabReportZ1/` を参照）。

    完了条件（StampTree GET variations）: public/shared/published の 3 variation が Legacy/Modern=200 を返し、`logs/d_audit_event_stamp_<variation>.tsv` に TraceId=`parity-stamp-tree-<variation>-<RUN_ID>` を記録、`logs/jms_dolphinQueue_read-resource{,_legacy}.txt` で before/after を採取して `messages-added` 差分（Legacy `message-count=0L` 追記）を残していること。

  備考: helper コンテナから `ops/tools/send_parallel_request.sh` を実行し、RUN_ID=`20251110T234440Z` → `20251110TnewZ` → `20251111T070532Z` で HTTP baseline を採取。PK 揃えログは `artifacts/parity-manual/db/20251111T062323Z/karte_id_check.txt` を参照。Runbook/Appendix/DOC_STATUS/`rest_error_scenarios.manual.csv` は順次同 RUN ID へ反映済み。
  2025-11-10 追記: RUN_ID=`20251110T123655Z` にて TraceId 付きヘッダー（`parity-{appo|schedule|letter|lab|stamp}-20251110T123655Z`）を Legacy/Modernized 双方へ投入し、`artifacts/parity-manual/{appo,schedule,letter,lab,stamp}/20251110T123655Z/` にレスポンス・メタ・Modernized Trace Log・監査ダンプを収集。Modernized 側で `LetterModule`/`NLabModule`/`StampTreeModel` が persistence unit に含まれておらず 500 になる、Schedule は `remoteUser=anonymous` のまま `d_audit_event` を記録できず JMS も流れない、Legacy 側は 200 だが `d_audit_event` は空というギャップを `docs/server-modernization/phase2/notes/domain-transaction-parity.md` 付録A.2/A.3 に記載した。
  2025-11-11 追記: RUN_ID=`20251110TnewZ` で `V0225__letter_lab_stamp_tables.sql` + `local_synthetic_seed.sql` を両 DB に適用後、letter/lab/stamp を再取得。Flyway/seed 証跡は `artifacts/parity-manual/db/20251110TnewZ/`。結果は Legacy=200 / Modern=500（letter: `fk_d_letter_module_karte`、stamp: `Bad value for type long … treeBytes`）・lab=両環境200（`{"list":null}`）。Audit/JMS は全ケースで空のままなので、`d_karte` PK の揃え込みと `StampTreeModelConverter` の型変換、`NLabServiceBean` の DTO マッピング、および監査/JMS 経路の整備を次アクションとする。
  2025-11-11 追記2: RUN_ID=`20251111T070532Z` で Compose 環境を再起動し、`docker run --rm --network legacy-vs-modern_default -v "$PWD":/workspace buildpack-deps:curl bash -lc "cd /workspace && BASE_URL_LEGACY=http://server:8080/openDolphin/resources BASE_URL_MODERN=http://server-modernized-dev:8080/openDolphin/resources PARITY_HEADER_FILE=tmp/parity-headers/<case>_${RUN_ID}.headers ... ops/tools/send_parallel_request.sh --profile compose"` をケース別に実行。`artifacts/parity-manual/{appo,schedule,letter,lab,stamp}/20251111T070532Z/` へ HTTP/headers/meta・`logs/{legacy,modern}_trace.log`・`modern_trace_context.log`（letter/stamp）・`d_audit_event_{legacy,modern}.txt`・`jms_note.txt` を保存し、`ops/tests/api-smoke-test/rest_error_scenarios.manual.csv` / `tmp/parity-headers/*.headers` も同 RUN_ID へ更新した。Appo=Legacy/Modern200（レスポンス=1）、Schedule=Legacy/Modern200 で `list` に `架空 花子` 1 件が復帰した一方、Letter=200/500（`fk_d_letter_module_karte`）、Lab=両環境 `{"list":null}`、Stamp=500/500（Legacy `First Commit Win Exception`, Modern `Bad value for type long … treeBytes`）は継続。全ケースで `docker compose exec db* psql` による `d_audit_event` は `SYSTEM_ACTIVITY_SUMMARY` のみ、JMS ログもヒットせず（`logs/jms_note.txt` に記録）。
  2026-06-16 追記: 上記 RUN に加えて `artifacts/parity-manual/persistence-check/20251110T122417Z/persistence_class_check.txt` を更新し、`tmp/reseed_appo.sql` による Appo 再現手順と `docker run --network container:opendolphin-postgres-modernized flyway/flyway:10.17 migrate` で DocumentModel 系テーブルを適用する手順を Runbook へ記録済み。`LEGACY_MODERNIZED_CAPTURE_RUNBOOK.md` §3.2 に docker-network 版 `send_parallel_request.sh` の実行例・MD5 パスワード必須の注意を追記した。
- [x] DocumentModel/persistence + Trace Harness RUN_ID=20251110T133000Z を進め、Modernized 側で DocumentModel が参照する `ModuleModel`/`SchemaModel`/`AttachmentModel` を `server-modernized/src/main/resources/META-INF/persistence.xml` に登録し、`server-modernized/tools/flyway/sql/V0224__document_module_tables.sql` で `d_document`/`d_module`/`d_image`/`d_attachment` を Modern DB に投入して UnknownEntityException を解消する。TraceId 付き `trace_http_200` を `tmp/trace_http_200.headers` で再取得し、`artifacts/parity-manual/TRACEID_JMS/20251110T133000Z/` に HTTP/trace/JMS/`d_audit_event` を保存。AuditTrail に TraceId が残らない現状をブロッカーとしつつ、Modern WildFly 再ビルド→`docker compose` で `/schedule/pvt/2025-11-09` を 200 で回して `d_audit_event`/JMS TraceId を確認する（Docker 操作は他ワーカーとの調整後）。
  2025-11-11 追記 (RUN_ID=`20251110T231006Z`): `docker run --network container:opendolphin-postgres-modernized flyway/flyway:10.17 migrate` で V0224 を再適用し、`flyway_schema_history` に version 0224 を追加。`opendolphin` スキーマに `d_document`/`d_module`/`d_image`/`d_attachment` が作成済みであることを `psql` ログに記録し、`mvn -f pom.server-modernized.xml -pl server-modernized -am package -DskipTests` → `scripts/start_legacy_modernized.sh down && start --build` で WAR/コンテナを再構築した。`curl -H userName:1.3.6.1.4.1.9414.72.103:doctor1 ... /schedule/pvt/2025-11-09` は HTTP 200 (`trace-schedule-20251110T231006Z`)、レスポンス本文は `schedule_pvt_2025-11-09.json` に保存。`SERVER_LOG` には認証警告→doctor1 での INFO ログが残り、DocumentModel 由来の `UnknownEntityException` は再現せず。`artifacts/parity-manual/schedule/20251110T231006Z/` に Flyway/Maven/Compose/curl/psql 証跡を集約済み。残課題: `opendolphin.d_audit_event` に `/schedule/pvt/` の監査行が生成されない（TraceId も空）。AuditTrail/JMS 経路の改修は別チケットで追跡。
  2026-06-16 追記: RUN_ID=`20251110T123655Z` にて TraceId 付きヘッダー（`parity-{appo|schedule|letter|lab|stamp}-20251110T123655Z`）を Legacy/Modernized 双方へ投入し、`artifacts/parity-manual/{appo,schedule,letter,lab,stamp}/20251110T123655Z/` にレスポンス・メタ・Modernized Trace Log・監査ダンプを収集。現状 Appo/Schedule/Letter/Lab/Stamp いずれの Modernized 側でも AppointmentModel/LetterModule/NLabModule/StampTreeModel が persistence unit に含まれておらず 500 を返す、Schedule は `remoteUser=anonymous` のまま `d_audit_event` を記録できず JMS も流れない、Legacy 側はすべて 200 だが `d_audit_event` は空のままなので、これらを `docs/server-modernization/phase2/notes/domain-transaction-parity.md` 付録A.2/A.3 の再取得予定欄に追記。さらに `docs/server-modernization/phase2/operations/LEGACY_MODERNIZED_CAPTURE_RUNBOOK.md` に Appo/Schedule の reseed＋監査取得フローを反映し、TraceId/JMS/監査出力の改善を次フェーズとしてフォロー。
- [ ] `@SessionOperation` / `SessionTraceManager` の適用範囲を確認し、例外発生時のトレース出力を実機で検証する（備考: RUN_ID=`20251110T002045Z` で `trace_http_{200,400,401,500}`, `trace-schedule-jpql`, `trace-appo-jpql` を収集→Legacy/Modernized 差分を把握。2025-11-10 07:06Z の再実行（RUN_ID=`20251110T070638Z`）は Docker 未統合で `curl: (7)` となったが、`TRACE_PROPAGATION_CHECK.md` §7 にブロッカーと `@SessionOperation` 未付与クラス（`open.dolphin.touch.session.{EHT,IPhone}ServiceBean`）を追記済み。2025-11-10 12:26Z（RUN_ID=`20251110T122644Z`）は helper コンテナ経由、13:30Z（RUN_ID=`20251110T133000Z`）はホスト compose プロファイルで再取得し、`artifacts/parity-manual/TRACEID_JMS/{20251110T122644Z,20251110T133000Z}/` に HTTP/Trace/JMS/`d_audit_event` を記録した。Modernized は `trace_http_400` で 400 / `trace_http_500` で 400（`KarteBeanConverter` null）、Legacy は `LogFilter#password.equals` NPE で 500（400 ケース）および `{}` 200（500 ケース）のまま。`d_audit_event` は `SYSTEM_ACTIVITY_SUMMARY` のみ（id=-41〜-43）で TraceId が残らず、`d_audit_event_id_seq` を再採番すると Modernized も 500（PK 衝突）になる。Touch 401, Karte 500、AuditTrail TraceId 永続化、Legacy `LogFilter` null-safe 化が完了するまで本タスクは継続。詳細は `domain-transaction-parity.md` §2 / `PHASE2_PROGRESS.md` 2025-11-10 節 / `TRACE_PROPAGATION_CHECK.md` §8 を参照。）
- [ ] `@SessionOperation` / `SessionTraceManager` の適用範囲を確認し、例外発生時のトレース出力を実機で検証する（備考: RUN_ID=`20251110T002045Z` で `trace_http_{200,400,401,500}`, `trace-schedule-jpql`, `trace-appo-jpql` を収集→Legacy/Modernized 差分を把握。2025-11-10 07:06Z の再実行（RUN_ID=`20251110T070638Z`）は Docker 未統合で `curl: (7)` となったが、`TRACE_PROPAGATION_CHECK.md` §7 にブロッカーと `@SessionOperation` 未付与クラス（`open.dolphin.touch.session.{EHT,IPhone}ServiceBean`）を追記済み。2025-11-10 12:26Z（RUN_ID=`20251110T122644Z`）は helper コンテナ経由、13:30Z（RUN_ID=`20251110T133000Z`）はホスト compose プロファイルで再取得し、`artifacts/parity-manual/TRACEID_JMS/{20251110T122644Z,20251110T133000Z}/` に HTTP/Trace/JMS/`d_audit_event` を記録した。Modernized は `trace_http_400` で 400 / `trace_http_500` で 400（`KarteBeanConverter` null）、Legacy は `LogFilter#password.equals` NPE で 500（400 ケース）および `{}` 200（500 ケース）のまま。`d_audit_event` は `SYSTEM_ACTIVITY_SUMMARY` のみ（id=-41〜-43）で TraceId が残らず、`d_audit_event_id_seq` を再採番すると Modernized も 500（PK 衝突）になる。Touch 401, Karte 500、AuditTrail TraceId 永続化、Legacy `LogFilter` null-safe 化が完了するまで本タスクは継続。詳細は `domain-transaction-parity.md` §2 / `PHASE2_PROGRESS.md` 2025-11-10 節 / `TRACE_PROPAGATION_CHECK.md` §8 を参照。2025-11-13 追記: `SessionOperationInterceptor` に `WebApplicationException` バイパスを追加し `trace_http_400` が 500 落ちしないことを確認済み（`RUN_ID=20251117TtraceAuditZ1`）。）
  2025-11-10 22:16Z 追記: RUN_ID=`20251110T221659Z`（`artifacts/parity-manual/TRACEID_JMS/20251110T221659Z/`）を `--profile compose` で追加採取。Modernized 側は `trace_http_{200,400,401,500}` すべてが `403 Forbidden` となり、WildFly WARNING ログに `traceId=trace-http-*` と `Unauthorized user: {null|doctor1}` が 2 行ずつ記録された。`open.dolphin.touch.session.{EHT,IPhone}ServiceBean` へ追加済みの `@SessionOperation` が AOP 適用され Touch 経路でも Trace が残ることを確認。一方 Legacy は `trace_http_200` が `LogFilter#password.equals` NPE で 500、その他は 403 に変化したのみで trace ログは空のまま。`d_audit_event` は負 ID (-41〜-43) から増分なし、JMS Queue も `messages-added=0`。`TRACE_PROPAGATION_CHECK.md` §7.2 / §8 に Unauthorized 403 の原因（Basic 認証ヘッダー拒否、`TouchRequestContextExtractor` 直前で落下）と残課題（AuditTrail TraceId 未記録、`d_audit_event_id_seq` 衝突リスク、Legacy LogFilter null-safe 化）を追記済み。LogFilter/AuditTrail 改修と 401/500 ケースの再現を行い、TraceId→JMS→`d_audit_event` の貫通を確認するまで継続。
- [ ] `adm10` / `adm20` 系コンバータのマッピング漏れを洗い出し、再現用テストデータを選定する（備考: `AdmConverterSnapshotTest` を追加済み。スナップショットフィクスチャは `ops/tests/fixtures/adm/adm10|adm20/<scenario>.json` に移動し、`tmp/legacy-fixtures/adm10|adm20/*.json` は stub として新パスを案内するのみ。`server-modernized/pom.xml` の Surefire 設定で `adm.snapshot.fixtureDir=${project.basedir}/../ops/tests/fixtures/adm` を渡し、`mvn test` デフォルトで本テストを含められるようにした。2025-11-08 時点で VisitPackage/Labo/Diagnosis 用フィクスチャも追加済みで、`jshell --class-path "<依存クラスパス>"` → `Class.forName("open.dolphin.adm.AdmConverterSnapshotTest")` により `adm.snapshot.update=true` のまま `visitPackageSnapshot` / `laboItemSnapshot` / `registeredDiagnosisSnapshot` を再生成できる。手順詳細は `docs/server-modernization/phase2/notes/rest-touch-diff-report.md#5-adm-コンバータ差分スナップショット（2025-11-08）` を参照。2025-11-11 追記: `mvn -f reporting/pom.xml install -DskipTests` → `mvn -f server-modernized/pom.xml test -Dtest=AdmConverterSnapshotTest -DskipITs -Dsurefire.failIfNoSpecifiedTests=false`（RUN_ID=`20251111T161746Z`）で `patient_model`/`visit_package`/`labo_item`/`registered_diagnosis` の差分なしを確認。2025-11-12 追記: RUN_ID=`20251116TadmSnapshotZ1` で `mvn -f server-modernized/pom.xml test -Dtest=AdmConverterSnapshotTest -DskipITs=false` を再実行し、`artifacts/parity-manual/adm-snapshots/20251116TadmSnapshotZ1/README.md` と `server-modernized/target/surefire-reports/open.dolphin.adm.AdmConverterSnapshotTest.{txt,xml}` に証跡を保存。今回も差分ディレクトリの生成はなく、Git 管理化したフィクスチャへの変更も発生していない。今後も追加シナリオが出次第 `ops/tests/fixtures/adm/` 配下へ保存し、本節・`DOC_STATUS` を更新する。）
- [x] `HealthInsuranceModel` エンティティが WAR へ取り込まれず Hibernate が `Association ... is not an '@Entity' type` で停止する問題を修復する（2025-11-12 更新, RUN_ID=`20251116ThealthInsZ1`）。`server-modernized/pom.xml` で `opendolphin-reporting` / `opendolphin-common(jakarta)` を dependencyManagement に昇格させてバージョン衝突を防ぎ、`mvn -f pom.server-modernized.xml -pl server-modernized -am package -DskipTests` のログを `artifacts/parity-manual/HEALTH_INSURANCE_MODEL_FIX/20251116ThealthInsZ1/mvn_package.log` に保存した。`jar tf server-modernized/target/jakarta-libs/opendolphin-common-*-jakarta.jar | rg HealthInsuranceModel`（`jar_common_healthinsurance_after_fix.log`）でクラスを再確認し、`ops/modernized-server/docker/Dockerfile` / `scripts/start_legacy_modernized.sh` の BuildKit ステージに既に存在する `COPY reporting ./reporting` が欠落していないことも合わせて点検済み。コンテナ再作成は禁止ルールのため、`docker cp server-modernized/target/opendolphin-server.war opendolphin-server-modernized-dev:/opt/jboss/wildfly/standalone/deployments/` → `touch .../opendolphin-server.war.dodeploy` でホットデプロイし、コマンドログを `docker_cp_hotdeploy.log` にまとめた。`docker exec ... psql -U opendolphin -d opendolphin_modern -c '\d+ d_health_insurance'` の結果と `SELECT id, patient_id, beanbytes FROM d_health_insurance ...` は `psql_healthinsurance_model.log` に保存。証跡は `artifacts/parity-manual/HEALTH_INSURANCE_MODEL_FIX/20251116ThealthInsZ1/` に集約し、`PHASE2_PROGRESS.md` / `DOC_STATUS.md` / `domain-transaction-parity.md §3.5` へ反映済み。

## フェーズ5: 外部連携・メッセージング

- [x] `MessagingGateway` の JMS エンキュー処理とフォールバックルートを検証し、ログ出力を比較する（2025-11-08 更新: `COMPOSE_PROJECT_NAME=od-jms-debug` で `scripts/start_legacy_modernized.sh start` → `ops/tools/jms-probe.sh --scenario claim` を実行し、`artifacts/parity-manual/JMS/20251108T210639Z/` に HTTP トレース・`docker logs`・Legacy/Modernized 差分を保存。Modernized 側では `open.dolphin.traceId` が JMS 規約違反（AMQ139012）となり `Claim fallback send started` → `EHTResource.sendPackage` が `StringIndexOutOfBoundsException` で 500 返却、Legacy は 404 応答のみ。詳細ログと改善案は `docs/server-modernization/phase2/notes/messaging-parity-check.md` を参照し、同メモに将来のテスト基準（Acceptable JMS property 名 / fallback 監視フロー）を記録済み。）
- [ ] `ClaimSender` / `DiagnosisSender` / `MMLSender` の設定値差分とエラーハンドリングを確認する（2025-11-10 更新: `claimHelper.vm` に続き `diseaseHelper.vm` も `server-modernized/src/main/resources/` へ同梱し、`mvn -f pom.server-modernized.xml -pl server-modernized -am package -DskipTests` で生成した WAR を `docker compose build server-modernized-dev`→`./scripts/start_legacy_modernized.sh start` によって再配置。`ops/tools/send_parallel_request.sh --profile compose POST /karte/diagnosis/claim 20251109T231900Z_DIAGNOSIS` は Legacy=403 / Modernized=200（238ms）となり、`artifacts/parity-manual/CLAIM_DIAGNOSIS_FIX/20251109T231845Z/logs/jms_dolphinQueue_read-resource.txt` で `messages-added=1`, `message-count=0`, `logs/jms_DLQ_list-messages.txt` で空配列を確認。`db/d_diagnosis_tail.txt` には ID=-47 の新規行が追加され、DLQ 流入ゼロと DB INSERT を証跡化できた。`docs/server-modernization/phase2/notes/messaging-parity-check.md` §8.5 に再デプロイ/HTTP/JMS/DB の各ログをリンク。未対応タスク: (1) `d_diagnosis_seq` の負値スタートを是正し主キーを正数化、(2) Legacy 側 403 の根本原因整理、(3) `/karte/diagnosis/claim` のレスポンスボディ仕様と UI 連携の明文化、(4) ホスト→9080 の疎通恒久策またはヘルパー手順の Runbook 反映（CLAIM/MML も含めた一括実行 Gate 化）、(5) `MmlSenderBeanSmokeTest` を Gate #44 で自動化し `tmp/mvn-mml.log` を継続採取。）
- [x] Legacy WildFly 10 のデータソース/ネットワーク設定を再構成し、opendolphinPU が安定起動する状態を復旧する（備考: `docker-compose.yml` / `ops/legacy-server/docker-compose.yml` / `ops/legacy-server/docker/configure-wildfly.cli` / `scripts/start_legacy_modernized.sh` の DB ホスト既定値を `opendolphin-postgres` へ統一し、`./scripts/start_legacy_modernized.sh start --build` → `start` で再デプロイ。`docker exec opendolphin-server /opt/jboss/wildfly/bin/jboss-cli.sh --commands='/subsystem=datasources/data-source=PostgresDS:test-connection-in-pool'` と `.../hibernate-persistence-unit=opendolphin-server.war#opendolphinPU:read-resource(include-runtime=true)` の結果を `artifacts/parity-manual/CLAIM_SEND_ATTEMPT/logs/{jboss-cli_PostgresDS_test.txt,jboss-cli_opendolphinPU.txt}` に保存し、`server-legacy-fixed.log`／`legacy/serverinfo_*_20251108T19xxxxZ.txt` で HTTP 200 応答を採取。詳細手順と証跡は `docs/server-modernization/phase2/domains/RESERVATION_BATCH_MIGRATION_NOTES.md` §8 および `docs/server-modernization/phase2/operations/SERVER_MODERNIZED_STARTUP_BLOCKERS.md` §5 に追記済み）
- [ ] Secrets / 環境変数依存の不足時挙動を一覧化し、監視アラート要件を整理する（備考: `.env`→compose→WildFly CLI→Jakarta EE の読み込み順を `docs/server-modernization/phase2/notes/ops-observability-plan.md` にテーブル化し、`scripts/start_wildfly_headless.sh --env-file tmp/secrets-repro/<profile>` で (1) baseline (2) `MODERNIZED_POSTGRES_PASSWORD` 欠落 (3) `FACTOR2_AES_KEY_B64` 欠落 (4) SYSAD header 欠落 の 4 パターンを採取。新規ログは `artifacts/parity-manual/secrets/20251108T204806Z/README.md` 以下に保存し、Prometheus ルール / Grafana パネル / PagerDuty 経路は同ノートの Secrets マトリクスへ記載。現状、FACTOR2/SYSAD は docker-compose の `${VAR:-default}` が空文字をマスクするため未再現であり、既定値撤廃タスクをフォローアップ中。2025-11-10 追記: `tmp/secrets-repro/missing_factor2.env:23` と `missing_sysad.env:9-10` に空白を埋め込んで `${VAR:-default}` を強制的にバイパスする下ごしらえを完了し、Runbook/監視表の差分洗い出しも済み。WSL 側では `scripts/start_wildfly_headless.sh --env-file tmp/secrets-repro/base.env down` 実行時に `docker` / `docker-compose` 不在で停止したため、WildFly 起動ログや `ops/tests/security/factor2/*.http` の採取には至っていない。Docker Desktop を導入済みの Mac 環境へ引き継ぎ、4 パターンの再現と Runbook/PHASE2_PROGRESS 更新を継続する。）

## フェーズ6: 認証・セキュリティ

- [ ] 2FA 設定 (`FACTOR2_AES_KEY_B64`, FIDO2 設定値) 未設定時の WildFly 起動失敗ログを採取し、手順書に反映する（備考: `scripts/start_wildfly_headless.sh` と `docs/server-modernization/phase2/operations/FACTOR2_RECOVERY_RUNBOOK.md:10-60` にローカル合成ベースライン前提の手順を追記済み。`ops/tests/security/factor2/*.http` をそのまま流し、`artifacts/parity-manual/secrets/{wildfly-missing-secrets.log,totp-registration-missing.log}` は参考ログとして維持）
- [ ] `totp` / `fido` パッケージの監査ログ出力を検証し、成功/失敗両ケースの記録内容を確認する（備考: ローカル合成ベースラインで `d_factor2_*` が揃うため、`ops/tests/security/factor2/` の CLI を実行して `artifacts/parity-manual/factor2_*/*.log` を更新する。成功/失敗 SQL は `docs/server-modernization/phase2/notes/test-data-inventory.md:181-218` へ追記）
- [x] Elytron 移行計画とヘッダ認証後方互換 (`LogFilter`) の廃止手順を明確化する（備考: `ops/tools/logfilter_toggle.sh` を追加し `.env` で `LOGFILTER_HEADER_AUTH_ENABLED` を切り替え可能にした。`docker-compose*.yml` と `LogFilter` 側も連動済み。段階的なリリース基準は `docs/server-modernization/phase2/notes/security-elytron-migration.md` に整理済み。実機ログ採取はサーバー起動後に追加で実施する）
- [ ] Audit/JMS ルート強化：設計準備完了、実装待ち（備考: `TRACEID_JMS_RUNBOOK.md §5` に LogFilter null-safe 化、TouchRequestContext fallback、`d_audit_event_id_seq` 再採番プロトコルを追加し、`TRACE_PROPAGATION_CHECK.md` と `artifacts/parity-manual/TRACEID_JMS/<RUN_ID>/` へ参照ログの保存先を定義。実装は LogFilter/AuditTrail のコード差分と Docker 検証が可能になり次第着手する）

## フェーズ7: ストレージ・帳票

- [x] 添付ファイル保存モード（DB / S3）別の動作確認を行い、`attachment-storage.yaml` の必要パラメータを整理する（備考: RUN_ID=`20251118TattachmentDbZ3`（database）/`20251118TattachmentS3Z3`（s3）で `ops/tests/storage/attachment-mode/smoke_existing_stack.sh --use-existing` を実行し、`artifacts/parity-manual/attachments/20251118Tattachment{Db,S3}Z3/` に REST レスポンス / SHA-256 / docker logs を保存。WAR には `AttachmentModel.bytes` へ `@JdbcTypeCode(SqlTypes.BINARY)` を付与し、`server-modernized/src/main/resources/META-INF/persistence.xml` に `hibernate.jdbc.use_streams_for_lob=false` を追加。S3 切替時は `/opt/jboss/wildfly/standalone/configuration/attachment-storage.yaml` を `docker cp` + `docker exec -u root mv/chmod` で差し替え、`jboss-cli :reload` のみでホットスワップした。詳細は `docs/server-modernization/phase2/notes/storage-mode-checklist.md` を参照。）
- [x] 帳票生成 (`open.dolphin.reporting`) のフォント/ロケール設定を検証し、Legacy との出力差異を確認する（2025-11-13 実施: `REPORTING_KARTE_RUN_ID=20251118TkarteJaZ{1,2}` で `ops/tests/reporting/karte_cli.sh --locale {ja,en}` をホストから実行。`artifacts/parity-manual/reporting_karte_{ja,en}/20251118TkarteJaZ{1,2}/` に Legacy/Modern 双方の `response.pdf` / `meta.json` / `headers.txt` / `pdffonts.txt` / `response.txt` / `diff.pdf` を保存。`pdffonts` は両環境で `NotoSansCJKjp-Regular-Identity-H` が `emb=yes` となり、改行用 `Helvetica` のみ非埋め込みで残ることをログに記録。Legacy 側は WAR 全体を再ビルドせず、退避した WAR 内の `WEB-INF/lib/opendolphin-reporting-2.7.1.jar` を差し替えて `ClosedChannelException` を解消済み（詳細は `docs/server-modernization/phase2/notes/reporting-parity.md §6.5-§7` を参照）。）
- [x] ライセンス管理 (`/dolphin/license`) の権限チェックおよび設定ファイルの配置確認を実施する  
  - 2025-11-12: RUN_ID=`20251118TlicenseCheckZ1` で `GET /system/license` を再現し、Legacy=401（`authentication_failed`）、Modernized=接続失敗を `artifacts/parity-manual/license/20251118TlicenseCheckZ1/` に保存。  
  - 2025-11-13: RUN_ID=`20251118TlicenseDeployZ1` で `tmp/license/license.properties` を作成→`docker cp`→`chown jboss:jboss`→`/etc/opendolphin/license` に symlink。helper コンテナから `ops/tools/send_parallel_request.sh --profile modernized-dev --config ops/tests/api-smoke-test/configs/system_license_post.config --run-id 20251118TlicenseDeployZ1` を実行し、Legacy/Modernized 双方で `POST /dolphin/license` が `HTTP 200` `body=0` になることを確認した。証跡は `artifacts/parity-manual/license/20251118TlicenseDeployZ1/post/`（POST）、`.../get/`（`GET /dolphin/license`=405）、`.../get-system/`（`GET /system/license`=404）の 3 系列と `logs/opendolphin-server{,-modernized-dev}.log`。  
  - 2025-11-13: RUN_ID=`20251119TlicenseAliasZ1` で `SystemResource` に `@Path("/{scope : dolphin|system}")`（Legacy/Modernized 共通）を導入し、両 WAR をホットデプロイ。helper から `ops/tests/api-smoke-test/run.sh --scenario license --profile modernized-dev --run-id 20251119TlicenseAliasZ1` を実行し、`POST /dolphin/license` が `HTTP 200 body=0`、`GET /dolphin/license`／`GET /system/license` がいずれも `405 Method Not Allowed` へ揃うことを確認。証跡は `artifacts/parity-manual/license/20251119TlicenseAliasZ1/{post,get,get-system}/{legacy,modernized}/` に保存し、`X-Trace-Id=license-20251119TlicenseAliasZ1-*` が `/system` ルートでも監査ログへ残ることを `docker logs opendolphin-server{,-modernized-dev}` で確認済み。  
  - 2025-11-13: RUN_ID=`20251119TlicenseMonitorZ2Rerun` では `RUN_ID=20251119TbaselineFixZ1` の Modernized DB 復旧後に `ops/tests/api-smoke-test/run.sh --scenario license --profile modernized-dev --run-id 20251119TlicenseMonitorZ2Rerun` を再実行し、Legacy/Modernized とも `POST /dolphin/license=200 body=0`、`GET /dolphin/license=405`、`GET /system/license=405` に戻った。結果は `artifacts/parity-manual/license/20251119TlicenseMonitorZ2/{post,get,get-system}/rerun-20251119TlicenseMonitorZ2Rerun/` と `logs/modernized_server_rerun.log`、`logs/deployment_info/20251119TlicenseMonitorZ2Rerun.txt` で管理し、ライセンス API を STABLE 判定とした。  
  - 以降は `/system` ルートを利用するクライアントが 405 応答へ切り替わったことを周知し、REST API 在庫の公開パス（`/dolphin/license`）と統合ドキュメントを同期するのみ。

## フェーズ8: 観測性・ロギング

- [x] Micrometer メトリクス出力（`DatasourceMetricsRegistrar`, `RequestMetricsFilter`）の計測内容を収集し、Prometheus 連携可否を確認する（備考: `ops/modernized-server/docker/configure-wildfly.cli` へ Micrometer サブシステム＋Undertow 逆プロキシと `MICROMETER_MANAGEMENT_HOST/PORT` を追加し、管理ポート `/metrics` を `/actuator/{health,metrics,prometheus}` へ公開。Micrometer CDI 二重登録を避けるため `server-modernized/src/main/webapp/WEB-INF/jboss-deployment-structure.xml` で `org.wildfly.micrometer.deployment` を除外し、SYSAD 専用ヘッダー `ops/tests/api-smoke-test/headers/sysad-actuator.headers` を用意。`scripts/start_wildfly_headless.sh start --build` → `ops/tools/send_parallel_request.sh --profile compose --loop 5 GET /dolphin` → `curl http://localhost:9080/actuator/{health,metrics,prometheus}` の流れを `artifacts/parity-manual/observability/20251108T063106Z/`（503/404 case）と `artifacts/parity-manual/observability/20251108T074657Z-success/`（Legacy/Modernized とも 200）へ保存し、比較手順を README に追記。`mvn -f pom.server-modernized.xml -pl server-modernized -am package -DskipTests` 実行後に `jar tf server-modernized/target/opendolphin-server-2.7.1.war | grep WEB-INF/jboss-deployment-structure.xml` を取得し、Micrometer 除外設定が WAR へ恒久反映されたことを証跡化。Grafana/PagerDuty の本番適用（2025-11-08T10:32:44+09:00）は `docs/server-modernization/phase2/operations/logs/2025-11-08-pagerduty-observability.txt` へ記録済みで、`docs/server-modernization/phase2/notes/ops-observability-plan.md`／`operations/EXTERNAL_INTERFACE_COMPATIBILITY_RUNBOOK.md`／`docs/web-client/planning/phase2/DOC_STATUS.md` も「残課題なし」で同期。Evidence ID `OBS-ACTUATOR-20251108-02` に紐付く `actuator_*`／`metrics_application.log` を関係者レビューへ添付済み。)
- [x] Trace ID が JMS / セッション層ログへ伝搬するか end-to-end で確認する（備考: 401/403/500 系の AuditTrail を追加実装した `opendolphin-server.war` を helper ではなく既存コンテナへホットデプロイし、`trace_http_{200,400,401,500}` を RUN_ID=`20251117TtraceAuditZ1`（`artifacts/parity-manual/TRACEID_JMS/20251117TtraceAuditZ1/`）で再取得。Modernized 側は 200/400/401/500 が揃い、`SessionOperationInterceptor` に `WebApplicationException` バイパスを追加したことで `trace_http_400` も 400 応答へ正規化された。JMS queue は Legacy=`messages-added=0L` / Modern=`messages-added=9L`（`logs/jms_dolphinQueue_read-resource{,_legacy}.txt`）で enqueue が確認でき、`d_audit_event_trace_http_401.sql` に `REST_UNAUTHORIZED_GUARD` が 3 行（traceId=`trace-http-401-20251117TtraceAuditZ1`, actor=`1.3.6.1.4.1.9414.72.103:doctor1`）残った。200/400/500 はまだ未到達のため `_trace_http_{200,400,500}.sql` は 0 行だが、AuditTrailTraceId カラムが有効になったことと JMS→監査までの連鎖が 401 経路で証明できた。`TRACE_PROPAGATION_CHECK.md` §8.4 と Runbook Appendix A に RUN_ID を追記済み。）
  2025-11-10 22:16Z 追記: RUN_ID=`20251110T221659Z`（`--profile compose`）で `trace_http_{200,400,401,500}` を再実行したところ、Modernized は 403×4 だが `trace_http_*/modern/headers.txt` に `X-Trace-Id` が残り `logs/modern_trace_http.log` へ `Unauthorized user: {null|doctor1} traceId=trace-http-*` が 8 行出力された。Legacy は `trace_http_200/401` が `LogFilter#password.equals` NPE で 500、`trace_http_400/500` が 403 へ変化しただけで `headers.txt` に Trace ID が無く `logs/legacy_trace_http.log` も 0 バイト。`d_audit_event.log` は ID=-41〜-47 のまま増えず `d_audit_event_id_seq` も進捗ゼロ、`logs/d_audit_event_trace-http-{200,401,500}.sql` は 0 行、`logs/jms_dolphinQueue_read-resource.txt` は `messages-added=0L`（GET ケースは JMS 未到達）。Touch 系の `@SessionOperation` は AOP 適用済みだが、`UserServiceBean#authenticate` の facility 判定と Legacy `LogFilter` null-safe 化を完了しない限り JMS/Audit 伝搬を確認できない。今 RUN_ID の証跡は `artifacts/parity-manual/TRACEID_JMS/20251110T221659Z/` を参照。 
- [x] REST 例外処理共通化（`AbstractResource`）をレビューし、レスポンスフォーマットとログ整合性を検証する（備考: `ops/tests/api-smoke-test/rest_error_scenarios.manual.csv` と `README.manual.md` の期待値を参照し、ローカル合成ベースライン上で 400/401/500 ケースを実行して `artifacts/parity-manual/rest-errors/` を更新する。`RUN_ID=20251115TresterrexZ1` で再採取した結果、`/dolphin/activity/2025,04` は Legacy/Modernized 共に `error=invalid_activity_param` の JSON 400、`/touch/user/...` は `error=unauthorized` + `reason=authentication_failed` の 401、`/karte/pid/INVALID,%5Bdate%5D` は `error=karte_lookup_failed` の 500 へ統一された。証跡: `artifacts/parity-manual/rest-errors/20251115TresterrexZ1/{README.md,logs/*}`。`LogFilter` の null-safe 化と `TouchRequestContextExtractor` の WebApplicationException 返却により、Trace ID／facility 情報もボディへ含められることを確認済み。）

## フェーズ9: 回帰・API 同等性検証

- [x] スモークテストスクリプト (`ops/tests/api-smoke-test/`) を用いて Legacy・Modernized のレスポンス比較を実施し、成果物ディレクトリを保存する（備考: RUN_ID=`20251116TapiparityZ2` を `artifacts/parity-manual/smoke/20251116TapiparityZ2/` に保存済み。3 ケースすべて 200 で、Legacy/Modernized のヘッダ差分を `base_readonly_dolphin/headers.txt` から参照可能。従来通り `ops/tests/api-smoke-test/run.sh --scenario base_readonly --dual` ＋ `BASE_URL_{LEGACY,MODERN}` を使用）
- [x] API パリティチェッカー (`scripts/api_parity_response_check.py`) で代表 API の差分を測定し、結果を共有する（備考: RUN_ID=`20251117TtouchParityZ3` で Legacy/Modernized 双方へ `?dryRun=true` を新設し、`/jtouch/sendPackage` `document?dryRun=true` `mkdocument?dryRun=true` の 3 ケースが 200 + JSON 同等となった。証跡: `tmp/parity-touch/20251117TtouchParityZ3/`（HTTP キャプチャ）と `tmp/parity-touch/20251117TtouchParityZ3/diff.txt`（`[PASS]` ×3）。続けて `d_module.beanbytes` を OID へ戻す補正 SQL（`tmp/sql/touch_document_full_seed.sql`）を投入し、RUN_ID=`20251118TtouchParityZ4` で 非 dry-run `/jtouch/document` まで 200 応答＋`compare: \"status\"` を確認。最新証跡: `tmp/parity-touch/20251118TtouchParityZ4/`（および `artifacts/parity-manual/touch/20251118TtouchParityZ4/`）。）
- [ ] 監査ログ・外部副作用の検証（例: `/20/adm/factor2/*` 実行後の `d_audit_event`）を含む総合回帰テストを設計する（備考: `docs/server-modernization/phase2/notes/test-data-inventory.md:181-218` に合成ベースライン用 SQL と証跡パスを追記し、`ops/tests/security/factor2/*.http` 実行後の `artifacts/parity-manual/audit/d_audit_event_*.log` を整備する）

## フェーズ10: ドキュメント・フォローアップ

- [x] 本チェックリストを作成し、進捗確認の起点を整備する
- [x] 実施結果・既知課題を `PHASE2_PROGRESS.md` および関連ドキュメントへ反映する運用フローを確立する（備考: 2026-06-15 付で `PHASE2_PROGRESS.md` に Progress-Update-Flow（証跡24h以内反映・同営業日チェックリスト更新・週次/リリース前レビュー・RACI/テンプレ）を追加し、本チェックリスト備考へ要約を反映済み）
- [x] テストデータ・モック資材を `ops/tests/` 配下に整理し、デバッグ再現性を確保する（備考: `docs/server-modernization/phase2/notes/test-data-inventory.md` に headers/payloads/README の棚卸し・命名規則・CI 前提・ADM20/FIDO2 拡充計画を追記し、Checklist 反映に必要な資材整理を完了）

---

### 現時点の総括（2026-06-15 / 2025-11-07 追記）

- 2025-11-07: Web クライアント依存を排除する CLI 主導デバッグ方針と証跡保存ルールを追加。Legacy 実測 → Modernized リプレイ → サーバー内部観測の 3 層証跡を整備し、Runbook と `PHASE2_PROGRESS.md` を連動させる Gate を設定。
- フェーズ1は完了。フェーズ2ではサーバーレイヤーマップ/トレースフロー整理、SpotBugs/Checkstyle/PMD および Nightly CPD のワークフロー定義、`ops/analytics/evidence/nightly-cpd/20240615/` での手動証跡取得、`ops/tools/cpd-metrics.sh` のメトリクス抽出改善まで進捗。Slack/PagerDuty/Grafana の本番証跡は未取得で Ops 対応待ち。
- 2025-11-08: 公式 Postgres ベースライン dump を待たず、ローカル合成ベースラインで DB を復旧する方針へ転換。フェーズ4入口で追加検証が必要な場合は Ops 配布版を任意で適用するが、進捗管理上は合成ベースラインの証跡で Gate をクローズしてよい。
- フェーズ3〜5では Touch SSE リロード / DTO マッパー整備 / LegacyObjectMapperProducer 統一により CLI 主導テストが緑化し、`docs/server-modernization/phase2/notes/messaging-parity-check.md` で JMS enqueue→フォールバック証跡（AMQ139012, fallback 500）を取得済み。Claim/MML は RUN_ID=`20251118TmessagingParityZ2` で 200 応答と JMS/Audit を再現できたため、残作業は Legacy Diagnosis 500 と診断監査の DB 反映のみ。`claimHelper.vm` 配備と `MessagingHeaders` の検証も同 RUN_ID でクローズした。
- フェーズ7は添付ストレージ切替と帳票ロケール検証がいずれも環境未整備でブロック中。`docs/server-modernization/phase2/notes/storage-mode-checklist.md` では `ops/tests/storage/attachment-mode/*.sh` と `MODERNIZED_STORAGE_MODE` 実装が未提供であること、`docs/server-modernization/phase2/notes/reporting-parity.md` では `/reporting/karte` 404 とテンプレ/フォント不足により PDF 比較が実行できないことを整理している。
- 直近のアクション: 1) `MessagingGateway` リネーム済みヘッダーの Claim 実装反映と `claimHelper.vm` / ORCA 連携整備で `/20/adm/eht/sendClaim` 成功証跡を取得、2) `attachment-storage.yaml` ローダーと MinIO コンテナ・`ops/tests/storage/attachment-mode/*.sh` を追加し `artifacts/parity-manual/attachments/` のハッシュ比較を再開、3) `ReportingResource` 実装＋テンプレ拡張＋ `PdfDocumentWriter` フォント埋め込み対応で `reporting_karte_{ja,en}` CLI テストと `diff-pdf` 証跡を確保、4) `ops/tests/api-smoke-test/` を 4xx/5xx ケース・監査ログ突合まで拡張して `TRACEID_JMS` / `rest-errors` アーティファクトを更新。
