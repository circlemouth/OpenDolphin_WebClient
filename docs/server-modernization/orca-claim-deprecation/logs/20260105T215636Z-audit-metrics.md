# 監査ログとメトリクス確認メモ

RUN_ID: 20260105T215636Z
実施日: 2026-01-06 (JST)

## 期間メモ
- 依頼期間: 2026-01-09 09:00 - 2026-01-10 09:00（未来日）
- 本メモでは現時点（2026-01-06）の検証結果を記録。

## 環境
- 接続先: WebORCA Trial (https://weborca-trial.orca.med.or.jp)
- 認証: Basic (trial / <MASKED>)
- Modernized サーバー: http://localhost:9086/openDolphin/resources
- 管理ポート: http://localhost:10005
- Postgres: localhost:65435
- MinIO: 29020/29021
- コンテナ: opendolphin-server-modernized-dev-task-1767650111950-1a8b9f ほか

## 実施 API (API-only)
- POST /orca/patient/mutation
- POST /orca/disease
- POST /orca/order/bundles
- POST /orca/medical/records
- POST /orca21/medicalmodv2/outpatient

証跡: `artifacts/orca-connectivity/20260105T215636Z/normal/*.status`

## 監査ログ確認
- `d_audit_event` の request_id を `orca-claim-deprecation-20260105T215636Z-*` で抽出。
- API 呼び出しに対応する監査イベントが記録されていることを確認。
  - ORCA_PATIENT_MUTATION
  - ORCA_DISEASE_MUTATION
  - ORCA_ORDER_BUNDLE_MUTATION
  - ORCA_MEDICAL_GET
- 初期 500/404 発生時は REST_ERROR_RESPONSE が同一 request_id で記録され、再実行後に正常系イベントが追記されている。

証跡: `artifacts/orca-connectivity/20260105T215636Z/audit/d_audit_event_claim_deprecation.tsv`

## メトリクス確認
- `/actuator/prometheus` のメトリクスを採取し、Undertow の request/error カウンタが更新されていることを確認。
  - wildfly_undertow_request_count_total{http_listener="default"} = 18
  - wildfly_undertow_request_count_total{deployment="opendolphin-server.war",servlet="resteasy-servlet"} = 16
  - wildfly_undertow_error_count_total{http_listener="default"} = 2

証跡:
- `artifacts/orca-connectivity/20260105T215636Z/metrics/actuator_prometheus.txt`
- `artifacts/orca-connectivity/20260105T215636Z/metrics/actuator_metrics.json`

## 補足
- スキーマ生成が無効だったため、コンテナ内の `persistence.xml` を一時的に `schema-generation=create` に変更して再起動し、スキーマ生成後に `opendolphin` スキーマと `opendolphin.hibernate_sequence` を追加。
- `ops/db/local-baseline/local_synthetic_seed.sql` と `artifacts/orca-connectivity/20260105T142945Z/db/*` の seed を投入。

## 結論
- 監査ログは API フロー（ORCA_*）に統一され、CLAIM 依存のログ欠落は確認されなかった。
- API 呼び出しメトリクス（Undertow request/error カウンタ）が記録され、API 実行回数に応じた増分を確認。
