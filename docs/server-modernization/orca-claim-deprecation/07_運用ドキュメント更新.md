# 運用ドキュメント更新（前提ドキュメント）

## 目的
- CLAIM 廃止と API-only 運用手順を明文化する。

## 参照
- `docs/DEVELOPMENT_STATUS.md`（最優先）
- `AGENTS.md` / `GEMINI.md`（共通ルール）
- `setup-modernized-env.sh`（起動手順）
- `docs/server-modernization/ORCA_CLAIM_DEPRECATION.md`（CLAIM 廃止の背景）
- `docs/server-modernization/orca-claim-deprecation/05_ORCA_API互換テスト_結果.md`（API-only 成功条件の例）
- `docs/server-modernization/orca-claim-deprecation/06_監査ログとメトリクス確認.md`

## 参照優先順位（整理方針）
- `docs/DEVELOPMENT_STATUS.md` を正本とし、Phase2 系ドキュメントは Legacy/Archive 扱いとする。
- 運用手順は Phase2 文書の記述より、現行の `setup-modernized-env.sh` と `docs/server-modernization/` を優先する。

## 接続先参照（Phase2 文書依存の整理）
- 接続先の標準値は `docs/server-modernization/phase2/operations/ORCA_CERTIFICATION_ONLY.md` に集約されているが、Phase2 文書は原則 Legacy/Archive 扱いである。
- ただし **接続先情報は機微情報を含むため**、当面は同ファイルを「例外的に現行参照」として扱う。
- 参照先を移管する場合は、`docs/server-modernization/operations/` 配下へ現行版を作成し、`docs/DEVELOPMENT_STATUS.md` に更新理由と RUN_ID を記録する。

## 前提
- 監査ログ/メトリクス確認が完了している。

## 作業内容
- API-only 運用手順の追記（下記「API-only 運用手順」）。
- CLAIM 参照の撤去または Legacy 扱いを明記。
- 参照優先順位の明確化。

## API-only 運用手順
### 1. 起動と接続先
- `WEB_CLIENT_MODE=npm ./setup-modernized-env.sh` で起動する。
- 接続先は `docs/server-modernization/phase2/operations/ORCA_CERTIFICATION_ONLY.md` の Trial（XML/UTF-8 + Basic）を使用する（Phase2 例外参照）。
- `orca.orcaapi.*` / `orca.id` / `orca.password` の API-only 設定のみを使用し、CLAIM 用の設定は残さない。

### 2. CLAIM の扱い
- CLAIM 通信・CLAIM サービスは **運用対象外**（Legacy 扱い）。
- `claim.*` 設定、CLAIM 用ポート、CLAIM 接続手順は記載しない。
- CLAIM 関連の運用が必要な場合は、`docs/DEVELOPMENT_STATUS.md` の方針に従って事前にマネージャー指示を取得する。

### 3. API-only の運用フロー
- 受付/患者/病名/処方/オーダー/会計連携は API で実施する。
- CLAIM 由来のログ/警告が出ないことを確認する。
- 監査ログ/メトリクスが API フローに統一されていることを `06_監査ログとメトリクス確認.md` で確認する。

### 4. API-only 確認手順（具体）
#### 4-1. 環境・設定の確認
- `orca.orcaapi.*` / `orca.id` / `orca.password` が設定され、`claim.*` が存在しないこと。
- 起動ログに CLAIM 接続/待受/送受信に関する出力が出ていないこと。

#### 4-2. API 実行の確認（成功条件の例）
- `docs/server-modernization/orca-claim-deprecation/05_ORCA_API互換テスト_結果.md` の正常系に準拠する。
  - `/orca/patient/mutation` / `/orca/disease` / `/orca/order/bundles` / `/orca/medical/records`
    - HTTP 200 かつ `apiResult=00`
  - `/orca21/medicalmodv2/outpatient`
    - HTTP 200 かつ `outcome=SUCCESS`
- 失敗時は HTTP 400/401 等の異常系で止まり、CLAIM へフォールバックしないこと。

#### 4-3. 監査ログ/メトリクスの確認
- API 操作に対応する監査ログが記録され、CLAIM 由来の監査イベントが無いこと。
- 監査/メトリクスの結果は `docs/server-modernization/orca-claim-deprecation/logs/<RUN_ID>-audit-metrics.md` に記録する。

### 5. CLAIM 例外運用フロー（原則禁止）
#### 判断基準（いずれかに該当）
- API-only で接続できないことが外部要因（ORCA 側制限/障害）で確認された。
- 法令/契約/医療機関要件で API-only が不可であると文書で確認できる。

#### 事前承認フロー
1. 例外理由・影響範囲・期限・代替案を整理し、RUN_ID を付けて記録する。
2. マネージャーへ事前承認を依頼し、承認内容をログに残す。
3. 承認後にのみ CLAIM 例外運用を実施する（実施ログに CLAIM 利用理由を明記）。
4. 例外が解消したら、API-only へ即時復帰し、復帰ログを残す。

### 6. 運用チェックリスト（最低限）
- API-only で起動できること（CLAIM 設定の参照なし）。
- 主要ユースケース（受付/患者/病名/処方/オーダー/会計）が API で成功すること（例: HTTP 200 / apiResult=00 / outcome=SUCCESS）。
- 監査ログが API フローに統一されていること。
- CLAIM 例外運用が承認フローなしで実施されていないこと。

## 完了条件
- API-only 運用手順が **具体的な確認手順/成功条件付き** で明記されている。
- CLAIM が Legacy 扱いであることと、例外時の承認フローが明記されている。
- 接続先参照の Phase2 依存が例外扱いであることが説明されている。

## 成果物
- 更新済み運用ドキュメント
