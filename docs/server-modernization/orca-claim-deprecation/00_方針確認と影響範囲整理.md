# 方針確認と影響範囲整理（前提ドキュメント）

## RUN_ID
- 20260104T231229Z
- 20260126T135500Z

## 目的
- CLAIM 廃止の公式方針を整理し、server-modernized の影響範囲を確定する。

## 参照
- `docs/server-modernization/ORCA_CLAIM_DEPRECATION.md`
- `docs/DEVELOPMENT_STATUS.md`

## 前提
- CLAIM 通信は 2026年3月末で廃止予定。API/PushAPI への移行が必須。
- 廃止日以降は即時停止はしないが、不具合修正や機能追加は行われない。
- Phase2 文書は Legacy/Archive 扱いのため、現行運用ルールは `docs/DEVELOPMENT_STATUS.md` を優先する。

## 作業内容
- server-modernized 内の CLAIM 関連コード/設定/起動手順を棚卸しする。
- 代替となる ORCA API/PushAPI の対応表を作成する。
- 影響範囲（機能・設定・監査ログ）を分類する。

## CLAIM 依存ポイント一覧（server-modernized）

### 1) REST エンドポイント（CLAIM 送信/状態参照/設定）
- 2026-01-26 時点で server-modernized に登録されない。
- `/karte/diagnosis/claim`（`server-modernized/src/main/java/open/dolphin/rest/KarteResource.java`）
  - 病名登録/更新 + CLAIM 送信。
- `/karte/claim`（`server-modernized/src/main/java/open/dolphin/rest/KarteResource.java`）
  - DocumentModel の CLAIM 送信。
- `/schedule/document`（`server-modernized/src/main/java/open/dolphin/rest/ScheduleResource.java`）
  - 予定カルテ作成 + CLAIM 送信。
- `/orca/claim/outpatient/*`（`server-modernized/src/main/java/open/dolphin/orca/rest/OrcaClaimOutpatientResource.java`）
  - 外来請求バンドル取得（UI/監査用、CLAIM バンドル表現を返却）。
- `/serverinfo/claim/conn`（`server-modernized/src/main/java/open/dolphin/rest/ServerInfoResource.java`）
  - custom.properties の `claim.conn` 参照。
- `/claim/conn`（`server-modernized/src/main/java/open/dolphin/touch/EHTResource.java`,
  `server-modernized/src/main/java/open/dolphin/adm20/rest/EHTResource.java`）
  - touch/adm 互換の CLAIM 設定参照。

### 2) 送信実装（CLAIM ソケット/JMS）
- `KarteServiceBean#sendDocument`（`server-modernized/src/main/java/open/dolphin/session/KarteServiceBean.java`）
  - DocumentModel 送信の入口。
- `ScheduleServiceBean#dispatchClaimAsync`（`server-modernized/src/main/java/open/dolphin/session/ScheduleServiceBean.java`）
  - 予定カルテの CLAIM 非同期送信。
- `MessagingGateway` / `MessagingConfig`（`server-modernized/src/main/java/open/dolphin/msg/gateway/`）
  - `claim.conn`/`claim.host`/`claim.send.port`/`claim.send.encoding` に依存。
- `ClaimSender` / `DiagnosisSender`（`server-modernized/src/main/java/open/dolphin/msg/`）
  - CLAIM XML 生成 + TCP ソケット送信。

### 3) テンプレート/生成物
- `claimHelper.vm` / `diseaseHelper.vm` / `mml2.3Helper.vm`
  - CLAIM/MML XML 生成に使用。

### 4) 設定・接続依存
- `custom.properties` の `claim.conn` / `claim.host` / `claim.send.port` / `claim.send.encoding` / `diagnosis.claim.send`
  - `MessagingConfig` / `ServerInfoResource` で参照。
- `claim.jdbc.*` / `claim.user` / `claim.password`
  - `ORCAConnection` の legacy 設定互換（現在は JNDI を優先、claim.jdbc.* は無視）。
- `orca.orcaapi.ip` 未設定時の `claim.host` フォールバック
  - `open/orca/rest/OrcaResource.java` で参照。

### 5) データモデル/スキーマ
- `DocInfoModel#sendClaim` / `DocInfoModel#claimDate` / `PatientVisitModel.BIT_SAVE_CLAIM`
  - CLAIM 送信フラグ・送信日時を保持。
- Flyway `V0224__document_module_tables.sql` の `claimDate` カラム
  - CLAIM 送信日時の保存に依存。

### 6) 付随する表示/テスト資産
- `server-modernized/reporting/templates/receipt_export_en_US.vm`
  - claim payload を前提とした帳票テンプレート。
- `server-modernized/src/test/java/open/dolphin/orca/rest/OrcaClaimOutpatientResourceTest.java`
  - CLAIM API の監査/レスポンス仕様に依存。

## CLAIM → API/PushAPI 対応表（依存ポイント別）

| CLAIM で担っていた機能/用途 | server-modernized の CLAIM 依存 | API/PushAPI 代替 | 補足/ギャップ |
| --- | --- | --- | --- |
| 病名の送信（新規/更新/削除） | `/karte/diagnosis/claim` → `DiagnosisSender` | `/orca/disease`（POST）, `/orca/disease/v3`（POST） | server-modernized 側は ORCA API 互換の JSON 入口。CLAIM 送信経路は削除対象。 |
| 診療行為/処方/オーダの送信 | `/karte/claim` → `ClaimSender` / `MessagingGateway` | `/orca/order/bundles`（POST）, `/orca/medical-sets`（POST） | CLAIM XML 生成/ソケット送信の代替。API-only で DocumentModel の CLAIM 送信を廃止。 |
| 外来請求バンドルの取得 | `/orca/claim/outpatient/*` | `/orca21/medicalmodv2/outpatient` + `/orca/appointments/list` | API-only では ORCA API 系の取得を基準に集計。CLAIM バンドル形式の返却は互換用途。 |
| 医療履歴（診療録）取得 | CLAIM 受信（診療履歴/予約請求） | `/orca/medical/records`（POST） | CLAIM の受信フローは API 取得へ移行。 |
| 予定カルテ作成時の送信 | `/schedule/document` → `dispatchClaimAsync` | `/orca/order/bundles`（POST） + 必要に応じて PushAPI | 予約・会計連携で PushAPI が必要な場合は受信口が未実装。 |
| CLAIM 接続設定の参照 | `/serverinfo/claim/conn` / `/claim/conn` | `orca.orcaapi.*` 系設定参照 | claim.conn/host 参照は API-only 化で撤去対象。 |
| CLAIM 送信の監査ログ | `ExternalServiceAuditLogger` / `MessagingGateway` | 各 `/orca/*` REST の監査ログ | API-only で監査アクション名の統一が必要。 |
| CLAIM フォーマット生成 | `claimHelper.vm` / `diseaseHelper.vm` / `mml2.3Helper.vm` | API JSON ペイロード生成 | テンプレート/Velocity 依存は削除対象。 |
| PushAPI 受信 | （現状なし） | PushAPI 受信エンドポイント/キュー | server-modernized 内に PushAPI 受信実装は見当たらないため新規実装が必要。 |

## 影響範囲（分類）
- **機能**: 病名/処方/オーダ送信、外来請求バンドル取得、予定カルテ送信。
- **設定**: `custom.properties` の claim.*、diagnosis.claim.send、orca.orcaapi.* の優先順位。
- **監査ログ**: CLAIM 送信の監査イベント → API 監査へ置換。
- **データモデル**: `sendClaim`/`claimDate` 等の利用箇所整理。
- **UI/テレメトリ**: `/orca/claim/outpatient` の互換レスポンス維持可否。

## 完了条件
- CLAIM 依存箇所の一覧が揃っている。
- 置換対象の API/PushAPI が紐付いている。

## 成果物
- CLAIM→API 置換マップ
- 影響範囲リスト
