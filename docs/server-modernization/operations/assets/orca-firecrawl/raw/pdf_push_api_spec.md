日医標準レセプトソフト PUSH通知仕様 Ver.1.1 2018年3月13日 日本医師会ORCA管理機構 1 改版履歴 初版 2017年1月20日 １．１版 2018年3月13日 2 目次 1. 概要 ....................................................................................................................................................... 3 2. 構成及び動作概要 ................................................................................................................................. 3 3. 動作概要 ................................................................................................................................................ 4 4. 通信仕様 ................................................................................................................................................ 4 5. コマンド及びメッセージ仕様 ............................................................................................................... 4 5-1. WebSocket接続 ............................................................................................................................ 4 5-2. subscribeコマンド .......................................................................................................................... 5 5-3. subscribedメッセージ .................................................................................................................... 5 5-4. eventメッセージ ............................................................................................................................ 7 5-5. unsubscribeコマンド ..................................................................................................................... 7 5-6. unsubscribedメッセージ ................................................................................................................ 7 5-7. errorメッセージ ............................................................................................................................. 8 5-7-1. エラーコード一覧 .................................................................................................................... 8 6. PUSH通知概要 ..................................................................................................................................... 8 7-1. 共通の通知項目一覧...................................................................................................................... 9 7. PUSH通知の機能的制限 ...................................................................................................................... 9 8. PUSH通知一覧 ................................................................................................................................... 10 9-1. 受付通知(patient\_acceptイベント) ............................................................................................... 10 9-1-1. 通知項目一覧 ........................................................................................................................... 10 9-1-2. 通知サンプル ........................................................................................................................... 10 9-2. 患者登録通知(patient\_informationイベント) ............................................................................... 11 9-2-1. 通知項目一覧 ........................................................................................................................... 11 9-2-2. 通知サンプル ........................................................................................................................... 11 9-3. 診療行為通知(patient\_accountイベント) ...................................................................................... 11 9-3-1. 通知項目一覧 ........................................................................................................................... 12 9-3-2. 通知サンプル ........................................................................................................................... 12 9-4. 入退院登録通知(patient\_hospital\_stayイベント) .......................................................................... 13 9-5. 患者受付通知(acceptイベント) ................................................................................................... 14 9-5-1. 通知項目一覧 ........................................................................................................................... 14 9-6. 診療行為登録通知(accountイベント) .......................................................................................... 15 9-6-1. 通知項目一覧 ........................................................................................................................... 15 9-7. オンライン帳票印刷データ作成完了通知(print001イベント) .................................................... 16 9-7-1. 通知項目一覧 ........................................................................................................................... 16 9-8. カスタムバッチからのユーザーイベント(user\_eventイベント) .................................................. 18 9. 推奨ライブラリ ................................................................................................................................... 18 3 1. 概要 日医標準レセプトソフトPUSH通知は、日医標準レセプトソフト(以下日レセ)と電子カルテなどの 機材の連携のための仕組みである。 日レセPUSH通知は日レセで発生したイベントを日レセから連携機器に通知する仕組みであり、 主にクラウド版ORCAでのCLAIM送信、ユーザプログラム連携のトリガーの代替としての利用 を想定している。 通知の内容は、イベント名と必要最小限の付加情報のみとし、実際の連携業務で必要となる詳細情 報は付加情報を元に日レセAPIによって取得することとする。 2. 構成及び動作概要 日レセPUSH通知は以下の構成により動作する。 ① 日レセAPS ➢ COBOLアプリケーションが動作するアプリケーションサーバ ② AMQPサーバ ➢ 内部で利用するメッセージ交換サーバ ③ pusher ➢ PUSH通知を連携機器に送信するサーバ ④ pusherクライアント ➢ pusherに接続し、PUSH通知を受信する連携機器側のクライアント(連携機器内で実装) 日レセPUSH通知はクラウド版ORCAでの動作を想定しているため、マルチテナントでの動作も 想定しており、pusherで認証を行うことで該当医療機関のPUSH通知のみをpusherクライアント に通知する仕組みになっている。 4 3. 動作概要 動作の流れは以下である。 ① pusherクライアントがpusherに接続する ② APSが日レセクライアントのイベント処理を行い、イベントがPUSH通知対応イベントであった 場合、APSからAQMPサーバに向けてPUSH通知メッセージを発行する ③ AMQPサーバからpusherにPUSH通知メッセージを送信する ④ pusherはPUSH通知に対応する医療機関のpusherクライアントにPUSH通知メッセージを送信 する ⑤ pusherクライアント側でPUSH通知のイベントに応じて処理を行う 4. 通信仕様 pusherとpuhserクライアント間の通信プロトコルはWebSocket(RFC6455)を利用する。 メッセージのデータフォーマットはJSONである。 5. コマンド及びメッセージ仕様 通信の流れは以下のようになる。 ① WebSocket接続 ② subscribeコマンド送信(購読) ③ eventメッセージ受信 ④ unsubscribeコマンド送信(購読解除) ⑤ WebSocket切断 5-1. WebSocket接続 pusherにWebSocketを接続する。接続先はクラウドとオンプレで異なる。また認証方式にも違いが ある。  クラウド ➢ wss://pusher-proxy.orca.orcamo.jp/ws ➢ SSLクライアント認証  オンプレ ➢ ws://localhost:9400/ws ➢ 認証なし クラウド版ではSSLクライアント認証の設定が必要で、WebSocket接続時にSSLクライアント認証 5 の証明書によりテナントID(医療機関)がpusherで決定される。 オンプレ版では認証が設定されていないのでWebSocketクライアントからpusherにテナントIDを 指定する必要がある。またオンプレではテナントID=1と固定されている。テナントIDの指定は以 下のHTTPヘッダーを設定することで行う。 X-GINBEE-TENANT-ID: 1 なおクラウド版でX-GINBEE-TENANT-IDを指定した場合はpusher側で単に無視される。 5-2. subscribeコマンド pusherに購読するイベント名を指定する。 { "command" : "subscribe", "req.id" : "ID", // 購読リクエストID（文字列)（リクエスト毎にユニークなID） "event" : "patient" // 購読するイベント名 } リクエストに対応するレスポンスを特定するため、req.idにはランダムな文字列を設定する。 eventに購読するイベント名を記載する。 { "command" : "subscribe", "req.id" : "ID", "event" : "patient\_account" } 以下のようにして全イベントを購読することも可能である。 { "command" : "subscribe", "req.id" : "ID", "event" : "\*" } また単一のWebSocket接続で複数のsubscribeコマンドを発行することも可能である。 5-3. subscribedメッセージ subscribeリクエストに対する購読成功のレスポンスメッセージである。 6 { "command" : "subscribed", "req.id" : "ID", // 購読リクエストID "sub.id" : "ID" // 購読者ID } req.idでどのsubscribeコマンドに対応するレスポンスか特定できる。 sub.idはunsubscribeコマンドで利用する。 7 5-4. eventメッセージ 購読したイベントのPUSH通知のメッセージである。 { "command" : "event", "sub.id" : "ID", // 購読者ID "data" : { "id": 1, "uuid": “fddf4bb0-b975-4687-b3cc67ea66fa80bb”, "event": "accept", // イベント名 "user": "oruser", // イベントを発生させた日レセユーザ名 "time": "2017-01-12T14:10:17+09:00", // ISO8601形式の日時 "body": { ... // イベントによって内容は異なる } } } 5-5. unsubscribeコマンド pusherにイベントの購読停止を通知する。 { "command" : "unsubscribe", "req.id" : "ID", // 購読停止リクエストID（リクエスト毎にユニークなID） "sub.id" : "ID" // 購読ID } 5-6. unsubscribedメッセージ 購読停止成功のレスポンスメッセージである。 { "command" : "unsubscribed", "req.id" : "ID", // 購読停止リクエストID } 以上で、WebSocketは切断となる。 8 5-7. errorメッセージ subscribeコマンド、unsubscribeコマンドでのエラーを示すメッセージである。 { "command" : "error", "for" : "<COMMAND>", // "subscribe", "unsubscribe" ... (存在しない場合は空文字) "req.id" : "ID", // リクエストID(存在しない場合は空文字) "code" : "<CODE>", // エラーコード "reason" : "<TEXT>" // エラーの理由 } 5-7-1. エラーコード一覧 エラーコード 状態 INTERNAL\_ERROR サーバ側のエラー NO\_SUCH\_SUBSCRIPTION 購読停止時に指定したsub.idが存在しない INVALID\_PARAMS パラメータが不正 PARSE\_ERROR 受け取ったJSONのパースエラー 6. PUSH通知概要 PUSH通知は以下のようなJSON形式の文字列で表される。 { "command" : "event", "sub.id" : "ID", // 購読者ID "data" : { "id": 1, "uuid": “fddf4bb0-b975-4687-b3cc67ea66fa80bb”, "event": "accept", // イベント名 "user": "oruser", // イベントを発生させた日レセユーザ名 "time": "2017-01-12T14:10:17+09:00", // ISO8601形式の日時 "body": { ... // イベントによって内容は異なる } } } dataキーが表すオブジェクト中のbodyキーが表すオブジェクトの内容はイベントによって異なる。それ 以外はすべてのイベントにおいて共通の内容になっている。後述のPUSH通知一覧では、共通の項目に ついては省略して説明を行う。 9 7-1. 共通の通知項目一覧 番号 項目名 型 内容 例 備考 1 command string コマンド名。 “event” 固定値。 2 sub.id string 購読者ID。 3 data object PUSH通知の詳細。 3-1 id int PUSH通知のID。 1~65535のいずれかで 表される。 1 65535の 次は1。 他の PUSH通 知と重複 する場合 がある。 3-2 uuid string PUSH通知のID。 UUID形式の文字列で 表される。 “058a2dcd-54b4-4567-878b- 7482cdabb276” 3-3 event string イベント名。 “patient\_accept” 3-4 user string イベントを発生させた ユーザ。 “jimu01” 3-5 body object PUSH通知固有の情報。 3-6 time string 通知時間。 “2016-12-20T13:30:07+0900” 7. PUSH通知の機能的制限 日レセPUSH通知には以下の制限がある。  pusherクライアントが通信切断時など未接続の期間に発生したPUSH通知を、クライアント再接 続後に受信することはできない。 ➢ PUSH通知の受信確認および未配達PUSH通知の保存機能はない。 例えば患者登録のPUSH通知を利用し連携機器側に患者情報を保存する処理を行っているような ケースで、一時的に通信回線のダウンがありpusherとの接続が切断された場合、再接続までの間 に登録された患者のPUSH通知は送信されない。そのため該当患者の登録情報が連携機器に登録 されないといった事態が考えられる。 このような場合は、別途日レセAPIを利用しその日登録された患者一覧を比較するなどの同期確認 処理が必要となる。（別途機能を提供） 10 8. PUSH通知一覧 pusherクライアントはsubscribe済みのイベントに対して以下の通知を受信する事ができる。 9-1. 受付通知(patient\_acceptイベント) 患者受付時、受付取消、変更時にPUSH通知を行う。 9-1-1. 通知項目一覧 番号 項目名 型 内容 例 備考 3-5 body object 3-5-1 Patient\_Mode string 受付更新モード(以下の いずれか)  add：登録  modify：更新  delete：削除 “add” 3-5-2 Patient\_ID string 受付患者番号。 “00123” 3-5-3 Accept\_Date string 受付年月日。 “2016-12-02” 3-5-4 Accept\_Time string 受付時間。 “16:03:38” 3-5-5 Accept\_Id string 受付ID。 “00003” 3-5-6 Department\_Code string 診療科コード。 “01” 3-5-7 Physician\_Code string ドクターコード。 “10001” 3-5-8 Insurance\_Combination\_Number string 保険組合せ番号。 “0010” 省略された共通の通知項目については7-1節を参照。 9-1-2. 通知サンプル { "id": 1, "uuid": “fddf4bb0-b975-4687-b3cc67ea66fa80bb”, "event": "patient\_accept", "user": "jimu01", "body": { "Patient\_Mode": "add", "Patient\_ID": "00161", "Accept\_Date": "2016-12-15", "Accept\_Time": "16:03:38", "Accept\_Id": "00003", "Department\_Code": "10", "Physician\_Code": "10001", "Insurance\_Combination\_Number": "0008" 11 }, "time": "2016-12-15T16:42:15+0900" } 9-2. 患者登録通知(patient\_informationイベント) 患者登録時、訂正時、取消時にPUSH通知を行う。 9-2-1. 通知項目一覧 番号 項目名 型 内容 例 備考 3-5 body object 3-5-1 Patient\_Mode string 患者登録更新モード(以下のいずれ か)。  add：登録  modify：更新  delete：削除 “add” 3-5-2 Patient\_ID string 患者番号。 “00198” 3-5-3 Information\_Date string 登録(更新)日。 “2017-07-07” 3-5-4 Information\_Time string 登録(更新)時間。 “11:31:46” 省略された共通の通知項目については7-1節を参照。 9-2-2. 通知サンプル { "id": 1, "uuid": “fddf4bb0-b975-4687-b3cc67ea66fa80bb”, "event": "patient\_information", "user": "jimu01", "body": { "Patient\_Mode": "add", "Patient\_ID": "00198", "Information\_Date": "2017-07-07", "Information\_Time": "11:31:46" }, "time": "2017-07-07T11:31:46+0900" } 9-3. 診療行為通知(patient\_accountイベント) 診療行為登録時、取消、変更時にPUSH通知を行う。 12 9-3-1. 通知項目一覧 番号 項目名 型 内容 例 備考 3-5 body object 3-5-1 Patient\_Mode string 診療行為更新モード (以下のいずれか)。  add：登録  modify：更新  delete：削除 “add” 3-5-2 Patient\_ID string 患者番号 “00161” 3-5-3 Information\_Date string 登録(訂正)日 “2017-07-10” 3-5-4 Information\_Time string 登録(訂正)時間 “15:09:41” 3-5-5 Perform\_Date string 診療年月日 “2017-07-10” 3-5-6 Medical\_Information array 最大15件 3-5-6-1 Insurance\_Combination\_Number string 保険組合せ番号 “0006” 3-5-6-2 Department\_Code string 診療科 “01” 3-5-6-3 Physician\_Code string ドクターコード “10001” 3-5-6-4 Invoice\_Number string 伝票番号 “0000895” 省略された共通の通知項目については7-1節を参照。 9-3-2. 通知サンプル { "id": 1, "uuid": “fddf4bb0-b975-4687-b3cc67ea66fa80bb”, "event": "patient\_account", "user": "jimu01", "body": { "Patient\_Mode": "add", "Patient\_ID": "00161", "Information\_Date": "2017-07-10", "Information\_Time": "15:09:41", "Perform\_Date": "2017-07-10", "Medical\_Information": \[ { "Insurance\_Combination\_Number": "0006", "Department\_Code": "01", "Physician\_Code": "10001", "Invoice\_Number": "0000895" }, { "Insurance\_Combination\_Number": "0006", "Department\_Code": "10", "Physician\_Code": "10001", 13 "Invoice\_Number": "0000896" } \] } "time": "2017-07-10T16:42:15+0900" } 9-4. 入退院登録通知(patient\_hospital\_stayイベント) 入退院登録時にPUSH通知を行う。 9-4-1. 通知項目一覧 番号 項目名 型 内容 例 備考 3-5 body object 3-5-1 Request\_Number string リクエスト番号(以下のいずれか)  01：入院登録  02：退院登録  03：変更  05：入院取消  06：入院取消(会計含む)  07：退院取消  08：転科転棟転室  09：異動取消  10：退院再計算  11：退院登録(診療保存) “02” 3-5-2 Patient\_ID string 患者番号 “00001” 3-5-3 Admission\_Date string 入院日 “2018-01-05” 3-5-4 Discharge\_Date string 退院日 “2018-01-10” 省略された共通の通知項目については7-1節を参照。 9-4-2. 通知サンプル { "id": 1, "uuid": “fddf4bb0-b975-4687-b3cc67ea66fa80bb”, "event": "patient\_hospital\_stay", "user": "jimu01", "body": { "Request\_Number": "02", "Patient\_ID": "00001", "Admission\_Date": "2018-01-05", "Discharge\_Date": "2018-01-10" 14 }, "time": "2018-01-21T14:20:13+0900" } 9-5. 患者受付通知(acceptイベント) 該当患者登録時、患者情報の通知を行う。CLAIM用。 9-5-1. 通知項目一覧 番号 項目名 型 内容 例 備考 3-5 body object 3-5-1 Patient\_ID string 患者番号。 “00161” 3-5-2 Accept\_Date string 受付年月日。 “2016-12-15” 3-5-3 Accept\_Time string 受付時間。 “16:03:38” 3-5-4 Department\_Code string 診療科コード。 “10” 3-5-5 Physician\_Code string ドクターコード。 “10001” 3-5-6 Insurance\_Combination\_Number string 保険組合せ。 “0008” 3-5-7 Medical\_Memo\_Info string メモ送信識別。 3-5-8 Medical\_Memo string 診療内容。 省略された共通の通知項目については7-1節を参照。 9-5-2. 通知サンプル { "command" : "event", "sub.id" : "ID", // 購読者ID "data" : { "id": 1, "uuid": “fddf4bb0-b975-4687-b3cc67ea66fa80bb”, "event": "accept", // イベント名 "user": "jimu01", // イベントを発生させた日レセユーザ名 "time": "2017-01-12T14:10:17+09:00", // ISO8601形式の日時 "body": { "Patient\_ID": "00161", // 患者番号 "Accept\_Date": "2016-12-15", // 受付年月日 "Accept\_Time": "16:03:38", // 受付時間 "Department\_Code": "10", // 診療科コード "Physician\_Code": "10001", // ドクターコード "Insurance\_Combination\_Number": "0008", // 保険組合せ "Medical\_Memo\_Info": "", // メモ送信識別 "Medical\_Memo": "診察１" // 診療内容 } } 15 } 9-6. 診療行為登録通知(accountイベント) 診療行為登録時、該当患者情報の通知を行う。CLAIM用。 9-6-1. 通知項目一覧 番号 項目名 型 内容 例 備考 3-5 body object 3-5-1 Send\_Character\_Code string 送信文字コード(以 下のいずれか)。  1：EUC  2：Shift\_JIS  3：UTF-8 “3” 通知データは 常にUTF-8。 日レセAPIで データ取得後 に連携先にあ わせて本項で 受信した文字 コードに変換 するのに用い る。 3-5-2 Patient\_ID string 患者番号。 “00182” 3-5-3 Perform\_Date string 診療年月日。 “2016-12-18” 3-5-4 Department\_Code string 診療科コード。 “01” 3-5-5 Physician\_Code string ドクターコード。 “10001” 3-5-6 Insurance\_Combination\_Number string 保険組合せ。 “0010” 3-5-7 Invoice\_Number string 伝票番号。 “0000874” 3-5-8 Update\_Code string 更新モード(以下の いずれか)。  0：新規  1：更新 “0” 省略された共通の通知項目については7-1節を参照。 9-6-2. 通知サンプル{ "command" : "event", "sub.id" : "ID", // 購読者ID "data" : { "id": 1, "uuid": “fddf4bb0-b975-4687-b3cc67ea66fa80bb”, "event": "account", // イベント名 "user": "jimu01", // イベントを発生させた日レセユーザ名 "time": "2017-01-12T14:10:17+09:00", // ISO8601形式の日時 "body": { "Send\_Character\_Code": "2", // 送信文字コード 1:EUC 2:Shift\_JIS 3:UTF-8 "Patient\_ID": "00182", // 患者番号 "Perform\_Date": "2016-12-18", // 診療年月日 "Department\_Code": "01", // 診療科コード 16 "Physician\_Code": "10001", // ドクターコード "Insurance\_Combination\_Number": "0010", // 保険組合せ "Invoice\_Number": "0000874", // 伝票番号 "Update\_Code": "0" // 更新モード 0:新規 1:更新 } } } 9-7. オンライン帳票印刷データ作成完了通知(print001イベント) オンライン帳票の印刷データ作成完了の通知を行う。 この通知を元に帳票データ取得API(現在開発中)を叩くことで各種帳票のデータを取得する。 ORCAクラウドでのオンライン帳票のカスタマイズを医療機関側で行うための仕組みである。 9-7-1. 通知項目一覧 番号 項目名 型 内容 例 備考 3-5 body array 帳票情報。 最大10件。 3-5-1 Report\_ID string 帳票を識別するための固有のID。 “karte\_no1” 3-5-2 Custom\_ID string カスタマイズ帳票を識別するための ID。 システム管理に 設定。 3-5-3 Report\_Name string 帳票名。 “カルテ１号紙” 3-5-4 Data\_ID string 帳票取得用key情報。 “ec704ba9-d02d-4701-b4da- f448a0e3d654” 番号3-1 Report\_IDについては以下のいずれか。詳細については詳しくは、 http://www.orca.med.or.jp/receipt/tec/push-api/report\_data\_api.html を参照。 17 種別 帳票名 帳票ID。 外来 診療録（カルテ1号紙） “karte\_no1” 外来 処方せん（院外） “shohosen” 外来 薬剤情報提供書 “okusuri\_joho” 外来 お薬手帳 “okusuri\_techo” 外来 請求書兼領収書 “seikyusho” 外来 診療費明細書 “meisaisho” 外来 予約票 “yoyakuhyo” 外来 予約患者一覧 “yoyakukanjalist” 外来 支払証明書 “shiharai\_shomeisho” 外来 診療録（カルテ3号紙） “karte\_no3” 入院 診療録（カルテ1号紙） “karte\_no1\_n” 入院 退院証明書 “taiin\_shomeisho” 入院 請求書兼領収書 “seikyusho\_n” 入院 診療録（カルテ3号紙） “karte\_no3\_n” 入院 入院処方箋 “shohosen\_n” 入院 注射処方箋 “chushasen\_n” 入院 指示箋 “shijisen\_n” 入院 診療費明細書 “meisaisho\_n” 入院 薬剤情報提供書 “okusuri\_joho\_n” 入院 お薬手帳 “okusuri\_techo\_n” 省略された共通の通知項目については7-1節を参照。 9-7-2. 通知サンプル { "command" : "event", "sub.id" : "ID", // 購読者ID "data" : { "id": 1, "uuid": “fddf4bb0-b975-4687-b3cc67ea66fa80bb”, "event":"print001", // イベント名 "user":"jimu01", // イベントを発生させた日レセユーザ名 "time": "2017-01-12T14:10:17+09:00", // ISO8601形式の日時 "body":\[ // 配列 { // 印刷データ明細 "Report\_ID":"karte\_no1", // 帳票を識別するための固有のID "Custom\_ID":"", // カスタマイズ帳票を識別するためのID（システム管理に設定） "Report\_Name":"カルテ１号紙", // 帳票名 "Data\_ID ":"ec704ba9-d02d-4701-b4da-f448a0e3d654" // 帳票取得用key情報 }, { // 印刷データ明細の繰り返し } \] } 18 } 9-8. カスタムバッチからのユーザーイベント(user\_eventイベント) クラウド版ORCAでカスタムバッチを実行する際、ユーザイベントの通知を行う。 9-8-1. 通知項目一覧 番号 項目名 型 内容 例 備考 3-5 body object 任意の内容。 カスタムバッチによって 同じイベント名で事なる 通知が起こりうる。 9-8-2. 通知サンプル { "id": 1, "uuid": “fddf4bb0-b975-4687-b3cc67ea66fa80bb”, "event": "user\_event", "user": "jimu01", "body": { “sub\_event”: “custom\_batch\_exec” // カスタムバッチ実行時に通知する例(実在しない) }, "time": "2018-02-08T14:32:04+0900" } 省略された共通の通知項目については7-1節を参照。 9. 推奨ライブラリ ➢ Java  ライブラリ名：org.eclipse.jetty.websocket  推奨バージョン：9.4.6.v20170531以上 ➢ C言語  ライブラリ名：libwebsockets  推奨バージョン：1.7.1-1 ➢ Ruby  ライブラリ名：faye-websocket  推奨バージョン：0.10.5
