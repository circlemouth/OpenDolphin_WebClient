# 個人開発カルテ向けサーバー刷新計画（法令準拠ミニマム）

## 1. 目的と適用範囲
- 既存モノリシックサーバーを運用しつつ、個人開発規模の電子カルテ（EMR）が**日本の法令・通知・ガイドラインで要求される最低限の機能**を満たせる新アーキテクチャへ段階的に移行する。
- 対象は診療録とその周辺記録の電子的作成・保存・閲覧・出力まで。診断支援や周辺業務（医事会計・検査連携等）はスコープ外とし、将来拡張用の余地のみを持つ。
- 将来 GCP 等のクラウドへ移行可能な構成を前提としつつ、当面はオンプレ／自院サーバー運用で完結する最小構成を整える。

## 2. 準拠すべき法令・ガイドライン
- **法令必須**：医師法24条・歯科医師法23条、同施行規則23条/22条（R-101, R-102）、e-文書法および厚労省令（R-301）、個人情報保護法（R-501, R-502）。
- **通知・ガイドライン**：外部保存通知（2002/2010、R-201）、医療情報システムの安全管理ガイドライン第6.0版（R-601）、電子署名関連資料（R-401）。
- **境界確認**：医療機器該当性ガイドライン（R-701）で電子カルテ自体が非該当となる範囲に留める。
- 参考：SS-MIX2 標準化ストレージ（相互運用目的、任意）。

## 3. アーキテクチャ方針（最小構成）
1. **ストラングラー戦略**：既存モノリスを運用しつつ、法令必須機能を満たす新コンポーネントを API ゲートウェイ経由で段階投入する。
2. **ドメイン分割（最小版）**：
   - Core Clinical Record Service（診療録本体・必須4項目・追記履歴）。
   - Identity & Access Service（OIDC 想定、最小権限管理）。
   - Compliance Ledger Service（監査ログ・第三者提供記録）。
   - Retention & Storage Service（保存期間管理・バックアップ・外部保存統制）。
   - Signature & Timestamp Service（該当文書のみ）。
3. **技術スタック（推奨ミニマム）**：
   - アプリ：Kotlin or Java 17 + Spring Boot 3.x (REST API + WebFlux)。
   - 認証：Keycloak（セルフホスト） or Cloud Identity（将来 GCP 時）。個人開発段階は Keycloak + OPA/Cedar による ABAC。
   - データ：PostgreSQL 15（オンプレ）→ 将来 Cloud SQL。全文検索は同 DB の JSONB + GIN を利用し、ElasticSearch は後段。
   - 監査ログ：Append-only（PostgreSQL + TimescaleDB 拡張 or Kafka + Object Storage）、タイムスタンプは JP タイムスタンプ局の TSA 連携を想定。
   - IaC/CI：GitHub Actions + Docker Compose（ローカル）/Terraform (将来 GCP)。個人運用では Ansible 併用可。
   - Observability：Prometheus + Grafana + Loki を最小導入。GCP 展開時は Cloud Monitoring/Logging へ移行。

## 4. 法令要件と機能モジュール対応（抜粋）

| 要件ID | 法的要件の要旨 | 必要機能・モジュール |
| --- | --- | --- |
| R-101 | 診療録必須4項目記載・欠落防止 | Core Clinical Record Service の入力バリデーション／保存 API |
| R-102 | 5年保存＋延長可 | Retention & Storage Service の保存期限フラグ、ライフサイクルポリシー |
| R-201 | 外部保存の3要件・運用規程 | Retention & Storage Service と運用 Runbook、API Gateway の冗長化 |
| R-301 | 真正性・見読性・保存性 | Core Service の追記履歴、Compliance Ledger（監査ログ）、出力機能 |
| R-401 | 電子署名・タイムスタンプ | Signature & Timestamp Service、長期検証パッケージ保管 |
| R-501 | 個人情報保護（取得・利用目的・安全管理） | Identity & Access、Privacy Request API、エクスポート制御 |
| R-502 | 第三者提供・漏えい記録 | Compliance Ledger、インシデント記録テンプレート、報告エクスポート |
| R-601 | 認証・権限制御・暗号化・バックアップ・BCP | Identity & Access、暗号化 (TLS, at-rest) 設定、DR Runbook |
| R-701 | 医療機器該当性回避 | 機能境界の維持（診療録表示・編集に限定）、追加機能レビュー手順 |

## 5. フェーズ計画（最小構成ロードマップ）

### Phase 0（4週間）：法令ギャップ分析と運用規程整備
- 目的：現行サーバーと運用手順が法令要件に対して不足している点を洗い出し、最低限の運用規程案を作成する。
- 主要タスク
  - 既存データモデル／API／ログ運用の棚卸しと R-101〜R-601 要件との突合。
  - 運用管理規程ドラフト（入力・確定・訂正・閲覧・出力・バックアップ・障害対応）。
  - 監査ログ要件と実装方式（DB or イベントログ）の比較検討。
  - セキュリティ・プライバシーポリシーの雛形整備（個情ガイダンス準拠）。
- 成果物：ギャップ分析レポート、運用規程ドラフト、セキュリティ管理体制図、工数見積。

### Phase 1（6週間）：Core Clinical Record サービス立ち上げ
- 目的：診療録の必須項目と追記履歴を確実に保持できる新 API を構築し、Web クライアントが利用可能にする。
- 主要タスク
  - Core Clinical Record Service 実装（患者基本情報・診療記録・訂正追記 API）。
  - 入力チェック（必須4項目、診療日、識別子）と保存時スキーマ定義。
  - 見読性確保：患者・期間・種別検索 API、PDF/HTML 出力のテンプレート整備。
  - 既存モノリスとのデータ同期（CDC or バッチ）方式の暫定実装。
- 成果物：Core Service β版、OpenAPI 定義、単体/結合テスト、Web クライアント接続検証。

### Phase 2（6週間）：認証・監査・保存制御の基盤整備
- 目的：真正性・保存性・個人情報保護を実現するための横断基盤を整える。
- 主要タスク
  - Identity & Access Service：OIDC プロバイダ、ロール/ABAC 設計、退職時無効化フロー。
  - Compliance Ledger：操作ログ（作成・参照・訂正・出力等）を改ざん困難な形で保存。
  - Retention & Storage：5年保存計算、延長フラグ、外部保存（オフサイトバックアップ）手順。
  - 暗号化：TLS 証明書管理、DB 暗号化（pgcrypto or Transparent Data Encryption）。
  - バックアップ & 復元訓練（RTO/RPO 設定）。
- 成果物：監査ログ PoC、Retention ジョブ、バックアップ Runbook、アクセステストレポート。

### Phase 3（6週間）：電子署名・プライバシー権利対応・準備リリース
- 目的：署名が必要な文書、個人情報の権利行使対応、第三者提供記録など残りの必須要件を完了させる。
- 主要タスク
  - Signature & Timestamp Service：医師署名用証明書運用、タイムスタンプ付与、長期検証情報の保管。
  - Privacy Rights API：開示・訂正・利用停止・第三者提供記録のエクスポート機能。
  - インシデント対応手順・連絡フローのシステム連携（通知テンプレート、ログ添付）。
  - 外部保存可用性テスト：回線断シミュレーション、代替運用（紙出力）手順整備。
- 成果物：電子署名ドキュメント、プライバシー対応 API、受入テスト（AT-01〜AT-06）結果、準本番環境。

### Phase 4（任意・将来）：相互運用・クラウド移行準備
- SS-MIX2 出力、データレイク連携、GCP インフラ（Artifact Registry, Cloud SQL, Cloud Run/GKE）構築は法令必須ではないため後工程に回す。
- ガバナンス：GCP へ移行する際は安全管理 GL のクラウド委託要件（責任分担表、監査権限）を満たす契約と IaC で段階的に実現する。

## 6. モジュール別タスク詳細（最小構成）

- **Core Clinical Record Service**
  - 必須項目スキーマ（患者基本、病名、主訴、治療内容、診療日）。
  - 追記専用履歴テーブル（元記録保持、差分表示 API）。
  - PDF/CSV 出力テンプレート（見読性、本人開示用）。

- **Identity & Access Service**
  - 医療従事者ごとの個別 ID、2FA（TOTP または FIDO2）の実装計画。
  - ロールセット（医師、看護師、医療事務、管理者）と ABAC ポリシー。
  - 休眠アカウント自動無効化、退職手続き Runbook。
  - Phase 3.7 にて TOTP/FIDO2 API（`/20/adm/factor2/*`）と監査ログを実装済み。詳細は `docs/server-modernization/security/3_7-security-compliance.md` を参照。

- **Compliance Ledger Service**
  - Append-only ログテーブル + WORM ストレージ連携。
  - 操作種別（Create/Update/View/Export/Config）のイベントスキーマ。
  - NTP 同期と検証用タイムスタンプチェーン。

- **Retention & Storage Service**
  - 保存期限管理ジョブ、満了時通知、手動延長 UI。
  - バックアップ計画（毎日差分＋週次フル）、別拠点保管、復元ドリル。
  - 外部保存契約メタデータ（保存先、責任分担、暗号化鍵管理）。

- **Signature & Timestamp Service**
  - 署名対象文書一覧（診断書、紹介状など）とフォーマット。
  - 電子署名ライブラリ（XAdES/CAdES）と長期検証情報（LTV）保管。
  - タイムスタンプ局との接続、更新ジョブ（再タイムスタンプ）。

- **Privacy Rights & Third-Party Disclosure**
  - 開示請求ワークフロー：リクエスト記録、承認、出力、マスキング。
  - 第三者提供台帳：提供先、目的、項目、日時、越境有無。
  - 漏えい対応ログ：インシデント登録、報告書テンプレ、アラート通知。

## 7. リスクと緩和策（法令最優先版）
- **監査ログの改ざんリスク**：WORM ストレージまたはハッシュチェーン＋外部タイムスタンプで保証。監査ログの閲覧権限を限定。
- **署名証明書運用失敗**：証明書失効や更新漏れに備え、証明書在庫とカレンダー通知、代替署名手順を定義。
- **保存性低下（媒体故障・災害）**：複数拠点バックアップ、復元訓練、クラウドストレージ（暗号化）の併用。
- **個人情報開示の遅延**：自動抽出 API とエスカレーションを実装し、法定期限（原則15日）を守る。
- **医療機器該当機能の混在**：新規機能追加時に該当性チェックリストを通過し、NG の場合は別プロジェクト扱い。

## 8. 未確定事項と今後のアクション
- 既存サーバーの DB スキーマ／ログ仕様を Phase0 で確定（Core Service への同期方法決定）。
- 電子署名に用いる証明書の調達方法（自院発行 or 認定事業者）とコスト試算。
- 外部保存先の候補（オンプレ DR サイト or クラウドストレージ）の比較と選定。
- 個人情報保護委員会への報告フロー（漏えい時）の責任者・連絡体制を会社規程と合わせて確立。
- 将来 GCP 移行時の責任分担表テンプレートを Phase4 で準備。

---

本計画は Web クライアント開発のフェーズ構成と整合しつつ、法令で要求される範囲にスコープを絞った実装ロードマップである。各フェーズ完了時に要件 ID（AT-01〜AT-06）に基づく受入テストを実施し、運用規程とドキュメントを更新すること。
