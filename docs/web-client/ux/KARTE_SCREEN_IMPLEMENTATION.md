# カルテ画面実装メモ (2026-04-XX 更新)

本ドキュメントは Web 版カルテ画面 (`ChartsPage`) の最新 UI 構成と挙動をまとめたものです。提供されたワイヤーフレーム仕様をベースに、実装上の構造・アクセシビリティ配慮・レスポンシブ挙動・ショートカット体系を整理しています。

## ナビゲーション表示更新 (2025-10-31)

- web-client/src/app/layout/AppShell.tsx でサイドバーの文言を整理し、主要メニューは「患者一覧」「受付一覧」「施設スケジュール」「カルテ閲覧」と表記する。管理者向けは「管理者メニュー > ユーザー管理 / 患者データ出力 / システム設定 / スタンプ管理」に統一。（担当: Agent 1 の UI ラベル差し替えを確認）
- web-client/src/features/charts/components/ObservationPanel.tsx の見出しを「観察記録」、入力欄を「値」「メモ」「登録」など実運用語へ差し替え。看護記録チームと共有済みの呼称と一致。（担当: Agent 1）
- web-client/src/features/charts/pages/ChartsPage.tsx では診療チェックリストを「問診」「バイタル」「処置」「会計」とし、保存エラー文言も診療フローに沿った日本語へ更新。カルテ閲覧メニューの文言変更に合わせ、操作ログ文言も更新済み。

## 1. レイアウト概要

### ChartsPage (カルテ入力)

```
AppShell
├─ PatientHeaderBar (固定ヘッダー 約88px / 2段構成)
├─ ContentGrid (3 カラム)
│  ├─ VisitChecklist (左レール / 160px 固定)
│  ├─ ProblemListCard (左レール / sticky, 主病名・Plan連携)
│  ├─ SafetySummaryCard (左レール / アレルギー・既往・内服サマリ)
│  ├─ CentralColumn
│  │  └─ WorkspaceStack
│  │     ├─ WorkSurface（Subjective→Objective(ROS/PE)→Assessment→Plan のタブ＋アコーディオン）
│  │     ├─ タイトル / 保存アクションカード
│  │     ├─ BillingCard
│  │     └─ SupplementGrid（スタンプ・ORCA・文書テンプレ）
│  └─ RightPane（問診/バイタル・画像・過去カルテ）
├─ StatusBar (固定フッター 32px)
└─ MiniSummaryDock (右下ドック)
```

- ヘッダーは約 88px 固定。構成:
  - 左ブロック: 患者写真（`patientDetail.raw.portrait` / `photo` を想定。取得できない場合は氏名イニシャルでフォールバック）、氏名・ID・年齢/性別、来院目的（`selectedVisit.raw.appointment` → 無い場合は `selectedVisit.memo`）・支払区分（選択保険 or 自費カテゴリ）・緊急連絡先（`patientDetail.relations` + 電話）のバッジ群。
  - 中央ブロック: 主訴と主病名のインライン入力。主病名は Plan カードの「主病名」トグルと双方向同期し、Enter/blur でヘッダ → Plan 反映、Plan 側の確定操作はヘッダへ即時反映される。
  - 右ブロック: 注意フラグ一覧、診察開始からの経過タイマー（`ownerUuid === clientUUID` でローカル起動）、グローバル検索ボタン（ショートカット F3 を案内）、診察開始/終了ボタンと他端末編集中バッジ。

> メモ: 患者写真フィールドはサーバー実装側で `RawPatientResource` に明示されていないため、`portrait` / `photo` のどちらを利用するか確認が必要（未提供時はイニシャル表示でフォールバック）。診察タイマーはローカル時刻ベースのため、サーバー保存済みの開始時刻が必要な場合は別途 API 拡張を検討する。
- 左レールは 160px 固定幅で `ContentGrid` の sticky ラップ（top: 80px）内に配置。`VisitChecklist` 自体も sticky（top: 0）で、
  `calc(100vh - 80px - 48px)` の縦領域を確保しステータスバーと干渉しない。
- `VisitChecklist` 直下に `ProblemListCard` を配置。React Query の診断データ (`useDiagnosisBuckets`) を参照してアクティブ／既往を分割し、
  行のキーボード操作で `handlePlanPrimaryDiagnosisSelect` / `handlePlanCardInsert` を経由して A/P に反映する。主病名状態は `aria-pressed`
  とステータスバッジで示し、Plan 側の主病名・ヘッダの主病名入力と双方向に同期する。既存のピン留め履歴は ProblemList からの
  追加では変更せず、診療参照履歴との二重管理を防ぐ。
- `ProblemListCard` の下に `SafetySummaryCard` を配置。`usePatientKarte().allergies`、`useDiagnoses({ karteId, fromDate, activeOnly: false })`、`fetchRoutineMedications` を統合し、`determineSafetyTone` で危険度をトーン表現する。各エントリはクリック/Enter/右端の「コピー」ボタンで `handleSnippetDragStart` を介してクリップボードへ送信でき、ドラッグ＆ドロップで Subjective/Objective/Plan へ挿入できる。React Query のキー `['masuda','routineMed', karteId ?? 'none']` を MasudaSupportPanel と共有し、定期処方 API のレスポンスを再利用する。
- 中央カラムは PC モニター向けに高さ `calc(100vh - 80px - 48px)` を占有し、内部の `CentralScroll` をスクロールコンテナとして
  WorkSurface・請求フォーム・SupplementGrid を縦に積層。WorkSurface は SOAP（Subjective → Objective〈ROS/PE〉 → Assessment → Plan）
  をタブ＋アコーディオンで順次展開し、タブ遷移時はスクロール位置を保持する。Objective では否定語／数値ハイライトと ROS/PE
  テンプレートを提供し、Plan はカード型 PlanComposer（ドラッグ & Alt+↑↓ 並べ替え、主病名トグル、1段階アンドゥ）を内包する。
  F2 ショートカットは Objective ⇄ Plan の切り替えに割り当てている。
- SupplementGrid には CareMap カレンダー（治療履歴俯瞰）、オーダセット、スタンプライブラリ、ORCA 連携、文書テンプレ、ラボ結果
  パネルを配置。CareMap は月次カレンダー＋日別タイムラインで予約・カルテ・検査・画像イベントを統合表示し、オンプレ版 CareMap の
  俯瞰性を Web でも再現している。
- WorkSurface 冒頭に「最新問診サマリ」カードを配置。折りたたみ表示と「本文に取り込む / 差分確認 / 履歴」アクションを備え、
  Subjective への直接挿入と DiffMerge 経由の比較を両立させた。カード展開時は問診の Q&A をドラッグ & ドロップ／クリック挿入できる。
- WorkSurface 上部アクションとして「参照パネルを表示」トグルを追加。オンにすると左に選択中カルテ（S/O/ROS/PE/A/P）を段落単位で
  引用できるサイドバイサイドビュー、右に最新ラボ結果（サンプル日・項目・値）を表示し、各行から趣旨に応じて Objective/Plan へ
  ワンクリック挿入できる。DocumentTimelinePanel の行を選択すると参照カルテが更新され、DiffMerge を介さず引用作業が完結する。
- `visitId` が指定されていない場合は中央カラムに空状態カードを表示し、「受付患者一覧を開く」「受付情報を再取得」アクションを案内する。
- 右コラムは 380px を基準とした `OrderConsole`。意思決定支援バナー（相互作用チェック・アレルギー警告・安全メモ）を常時表示し、その下に「処方 / 検査 / 画像 / 処置 / 紹介・文書 / 会計」の 6 タブを配置。Plan カードの `orderModuleId` をタブ毎に分類したエディタと、OrderSet／スタンプ／ORCA／Lab／文書／会計各パネルを再統合している。コンソール全体は `RightRail` の sticky により `calc(100vh - 80px - 48px)` の縦領域を占有する。
  - 処方: Plan カード（内服・注射）編集、OrderSet 適用、薬剤系スタンプ、ORCA 検索＆相互作用チェックを集約。
  - 検査: 検体／生体検査の Plan カード編集、検査系スタンプ、ORCA 検索、ラボ結果ビューアを同居。
  - 画像: 画像検査 Plan カードと対応スタンプ・ORCA 検索をまとめ、画像オーダの確認を独立。
  - 処置: 処置・手術・指導料系の Plan カードとスタンプ、ORCA 検索を集約。
  - 紹介・文書: Plan カード（紹介状・文書）と文書テンプレ／診断書／シェーマエディタを統合。
  - 会計: 請求モード切替、自費入力、Claim 調整パネルを配置。
- ペイン最上部に「問診メモ（受付共有）」「患者メモ（院内共有）」カードを追加。TextArea + 保存/取り消しボタン構成で、主訴メモは `/chartEvent/event` (PVT_MEMO) を通じてリアルタイム同期、患者メモは `/karte/memo` PUT でオンプレ版 MemoInspector と共通化した。
- 患者メモカードには履歴ダイアログを開く「履歴」ボタンを配置。保存済みメモのタイムラインをプレビューし、選択したバージョンを編集欄へ復元できる。復元操作は `recordOperationEvent('patient_memo_history_apply', ...)` を発火し、保存前に監査ログへ記録する。
- 受付共有メモ保存時は `recordOperationEvent('chart', 'info', 'visit_memo_update', ...)` を出力し、`buildSafetyNotes` を再計算してヘッダーの注意バッジへ即反映。
- 患者メモ保存後は `usePatientKarte` を再フェッチして RightPane の問診サマリ／MiniSummaryDock と同期。保存済みタイムスタンプはローカルで即時表示し、再取得完了後に確定時刻へ置換する。
- 幅 1400px 未満では折りたたみボタンを表示し、1000px 未満では自動折りたたみ＋ホバー時の一時展開を行う。
- 右下ドックは 3 行の前回要約を常時表示し、ドラッグ＆ドロップで O/A&P へ挿入可能。
- ステータスバーは保存 / 署名 / 会計連携のステータス（色分け）と未完タスク数、主要アクション（保存・署名・会計連携・次患者・ショートカット）を固定表示。中央カラム下端は 140px のパディングで被りを回避。
- 診察終了（ロック解除）操作は `handleUnlock` が保存状態を確認し、未保存の変更があれば保存処理を自動実行してから `useChartLock` でロック解除イベントを送出する。保存中は終了操作をガードし、書きかけカルテの取りこぼしを防ぐ。

### ReceptionPage (受付患者一覧)

- `AppShell` 配下に独立した一覧ページを用意。ヘッダーで検索キーワード／ステータスフィルター／再取得を操作可能。
- 概要カード (`SummaryRow`) で「待機中」「呼出済み」「診察中」の件数を即座に把握できる。
- `QueueGrid` は `repeat(auto-fill, minmax(320px, 1fr))` のレスポンシブグリッドで、各 `VisitCard` に患者情報・受付メモ・ステータスバッジ・
  自端末/他端末ロックの警告を表示。主アクションは「カルテを開く」ボタンで `/charts/:visitId` に遷移する。
- 各カードから「呼出する／待機に戻す」トグルを実装。診察中（ownerUUID が付与済み）の受付はボタンを自動無効化し、誤った状態変更を防ぐ。
- 「受付メモを編集」はインラインエディタ＋保存/キャンセル操作で提供。保存時は ChartEvent (PVT_MEMO) を送出し、他端末にもメモ・注意バッジを即時反映する。
- 絞り込み結果が空／読み込み中の場合は `EmptyState` で補助メッセージとリロード手段を提示する。

## 2. キー操作とフォーカスマネジメント

| ショートカット | 動作 |
|-----------------|------|
| F1 | 主訴入力へフォーカス |
| F2 | O 面 ⇄ A&P 面トグル (150ms アニメーション、スクロール保持) |
| F3 | UnifiedSearch (コマンドパレット) を開く |
| Ctrl/Cmd + Enter | 下書き保存（トーストはステータスバーでフィードバック） |
| Alt + ↑/↓ | A&P カードの並べ替え |
| Esc | 検索・画像ビューア・差分マージなどのオーバーレイを閉じる |

- IME 確定中 (`compositionstart`〜`compositionend`) はショートカットを抑制。
- O⇄A&P トグル切替時は `aria-live="polite"` でスクリーンリーダーへアナウンス。
- UnifiedSearch はカーソルキーで候補移動→Enter で O=文挿入 / A&P=カード追加を実現。

## 3. ドラッグ＆ドロップ挙動

- 左レールの ClinicalReferencePanel（問診要約・バイタル・画像・過去カルテ）および右下ミニサマリからテキストをドラッグすると O 面 / A&P 面 / Plan カードへ挿入。
- Plan カード自身もドラッグで並び替え可能。ドロップ対象カードの前に移動。
- スタンプライブラリと UnifiedSearch からの挿入はアクティブ面に応じて自動分岐。

## 4. レスポンシブポリシー

| 画面幅 | 挙動 |
|--------|------|
| > 1400px | フル 3 カラム表示（PC 想定レイアウト） |
| 1000–1400px | 右ペインは折りたたみボタンで開閉 |
| < 1000px | 右ペイン自動折りたたみ、ホバーで一時展開 |

左レールとヘッダー／フッターは常時固定。`CentralScroll` がスクロールを担い、下部はステータスバー分 + 余白 (計 140px) のパディングを確保して
重なりを防止している。スマートフォン想定の UI は優先度を下げ、PC モニターでの視認性と操作距離の最適化を優先した。

## 5. 請求・保存フロー

- `BillingState` を UI 左下のカードに集約。保険／自費トグル、保険選択、数量・実施者・ロット・備考を提供。
- 保存トリガーは WorkSurface 下部の「保存して終了」ボタン、および Ctrl/Cmd+Enter。
- 保存状態は `StatusBar` に反映（未保存／保存中／保存済み／エラー＋時刻表示）。
- 署名ボタンは Plan カードとオーダモジュールの整合性（未紐付けカード／孤立オーダ）を検証し、未確定のオーダがある場合は警告文を表示して無効化する。
- `StatusBar` には署名・会計連携のステータス（未署名／署名処理中／署名済み、未送信／連携中／連携済み）を色分けで表示し、直近の処理時刻を併記。
- 会計連携（CLAIM 送信）は署名完了かつ保険診療時のみ有効。送信成功時はステータスを緑表示し、会計タブは必要に応じて手動で切り替える（自動フォーカスは行わない）。
- 未完タスク数はチェックリスト完了状況から自動更新。

## 6. オーバーレイ

- **UnifiedSearch**: 中央 720px 幅のコマンドパレット。セクションタブ（薬／処置／検査／フォローアップ／テンプレ／過去文／O／A&P）を備える。
- **ImageViewer**: 画像サムネイルクリック時に最大 80vw/80vh で拡大表示、Esc/閉じるボタンで終了。
- **DiffMerge**: 過去カルテサマリクリックで現在文書との差分マージ UI を表示。チェックした段落を O/A&P へ挿入可能。
- **PatientMemoHistory**: 患者メモカードから呼び出す履歴ダイアログ。保存済みメモを一覧し、プレビュー → 復元 → 保存までを 1 画面で完結できる。
- **ShortcutOverlay**: フッタ「ショートカット」ボタンで開くモーダル。主要キーボード操作・スラッシュコマンド・音声入力トリガを一覧化し、Esc でも閉じられる。

## 7. 既存ユーザーへの影響

- 受付患者一覧は `/reception` へ独立し、カルテ編集は `/charts/:visitId` に遷移するフローへ変更。従来 `/charts` を直接開いていたブックマークも空状態カードから受付画面へ誘導される。
- 既存の SOAP 下書き／請求モード設定は従来の状態管理 (`ProgressNoteDraft`, `BillingState`) を継承しているためデータ移行は不要。
- 左レールの参照パネルやミニサマリを利用したドラッグ＆ドロップ操作が追加されたが、従来のテキスト入力フローも維持。
- スタンプライブラリ／ORCA パネル／患者向け文書テンプレートは SupplementGrid に統合し、従来の操作パターンを踏襲。
- 左レールの患者メモ保存は既存 DB の `d_patient_memo` を更新するため追加移行作業は不要。ただしオンプレ版と同一レコードを共有するため、運用時は編集権限者の教育（保存ボタンによる明示コミット）が必要。

## 8. 今後のタスク候補

- プランカードの複数段階アンドゥ／リドゥ履歴。
- 右ペイン画像の実データ連携および拡大ビューでの左右キー送り実装。
- UnifiedSearch への ORCA マスター検索結果統合。
