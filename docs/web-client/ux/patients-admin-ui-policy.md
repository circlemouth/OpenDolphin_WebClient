# 患者・管理 UX ポリシー（RUN_ID=20251202T090000Z）

- 参照元: [src/webclient_screens_plan/01_phase2/screens 3 文書の棚卸.md](../../../src/webclient_screens_plan/01_phase2/screens%203%20文書の棚卸.md)
- 証跡ログ: [docs/server-modernization/phase2/operations/logs/20251202T090000Z-screens.md](../../server-modernization/phase2/operations/logs/20251202T090000Z-screens.md)
- 目的: 患者基本情報メンテナンスとカルテ/受付の裏側設定（権限・ステータス・ORCA/DICOM 連携・テンプレ/セットなど）を安全に管理する。

## 0. 現行カルテ画面（管理メニュー）から取り込む UI の骨格

現行画面では、上部に「外来受付」「予約」「在宅・訪問スケジュール」のような主要業務タブがあり、管理画面に入っても業務側へ戻れる構造になっています。また、管理画面は「左メニュー（カテゴリを展開して選ぶ）＋右側に検索と一覧」という形で統一されています。

このポリシーでは、Administration をこの形に寄せます。狙いは「どのマスタ画面でも迷わない」「探す操作が同じ」で、設定作業のミスを減らすことです。

※右下の問い合わせ用チャットバブルは本システムでは実装対象外とします。

### 0.1 マスタ一覧の共通部品（現行画面で確認できた範囲）

現行の「処方採用薬マスタ」では、上に「検索項目の選択（例: 正式名称）＋入力欄＋検索ボタン」があり、一覧の見出しに「（508件）」のように総件数が出ています。下には「First/Prev/ページ番号/Next/Last」のページ送りがあります。

本システムでも、管理系の一覧はこの共通部品で統一します。
- 検索は「項目選択＋キーワード」で始め、あとから絞り込み条件を増やす（増やし過ぎない）
- 一覧の上に「総件数」を出し、ページ送りは下に固定する
- 一覧の列は「番号」「外部/内部コード」「正式名」「別名」「単位」など、コード＋名称が同時に見える形を基本にする

※行クリックで編集が開くか、別画面へ遷移するかは、この画面からはわかりません。どちらにするかは後述の未決事項に残します。

## 1. Patients 管理（基本情報メンテナンス）

Reception の「基本情報編集」から、特定の患者の編集画面を直接開けるリンクを使って遷移する（ディープリンク: deep link）。Patients では患者検索・新患登録・保険情報編集・患者メモ編集を提供する。

戻りは「Reception に戻る」を明示し、受付側で参照しているデータとのズレ（例: 受付で開いている保険モードと Patients 側の編集内容）を戻り前に表示する。戻り時は、受付タブ/フィルタ/ソートを保持し、Reception に渡された保険/自費モードを維持したまま復帰する（ローカルストレージ＋クエリパラメータ併用）。

権限不足で編集を弾いた場合も、元のフィルタ状態で戻し、監査ログに拒否理由を残す。

患者情報と保険情報は、追加・参照・変更・削除を API で行う（CRUD: Create, Read, Update, Delete）。誰がいつどの項目を変えたかの記録（監査ログ）を必須とする。

## 2. Administration（カルテ全般管理）

### 2.1 画面の骨格（現行画面に合わせる）

Administration は「左メニュー＋右側に検索/一覧/編集」の形を基本とする。左メニューはカテゴリを折りたたみでき、どこにいるかを強調表示する（現行画面の緑の選択状態に相当）。role=system_admin/管理者のみアクセス可能とする。

上部には主要業務タブを置き、管理作業中でも受付やカルテ側へ戻れる。左メニューは表示領域を広げるために折りたたみ（最小化）できる想定にする（現行画面の左右矢印に相当）。

### 2.2 管理メニューの情報設計（現行の分類を取り込む）

現行画面の分類は「マスタメンテナンス（基本情報）」「プロファイル」「オーダー」のように、目的で分かれています。この分け方は学習コストが低いので、Administration の入口の情報設計として採用する。

- **基本情報**: スタッフ、診療科、作業場所、受付/診療ステータス、カルテ確定ルールなど「運用の土台」
- **プロファイル**: アレルギー、画像カテゴリなど「患者プロファイルに関わる定義」
- **オーダー**: 処方セット名、採用薬、用法、用法コメント、予防接種、健診・検診種別など「入力を速く・安全にする定義」

※現行にある「患者動線管理」のような概念は、本システムでは「受付/診療ステータス定義と遷移ルール」に集約し、用語は現場が理解しやすい言い方に揃える。

### 2.3 具体的な管理対象（本システムの要件に紐づけ）

Administration では以下を扱う。ここは現行画面の「マスタ一覧の共通部品」を前提に作る（検索、総件数、ページ送りの統一）。

- 施設・診療科・受付時間、ユーザー/権限の種類（role）と承認ルール
- 受付/診療ステータス定義と遷移ルール、カルテ確定ルール
- カルテ記載方式（SOAP/フリー）とテンプレ/サマリ/メモカテゴリ設定
- セット管理（診療セット・処方/検査/接種セット・医師お気に入り・自動サジェスト閾値）、自費診療メニュー
- ORCA 連携設定（接続テスト・マスタ同期・適用病名チェック・送信タイミング・エラー表示文言）
- DICOM 接続・自動取得ルール
- セキュリティ/パスワード/ロック/自動ログアウト
- 監査ログ/保存期間/バックアップ
- 表示カスタマイズ（受付列選択・カラー・初期タブ）

### 2.4 システム通知（現行画面の「お知らせ/更新」から取り込む）

現行画面にはメンテナンス告知、システム更新の通知、必要に応じてログアウトする導線が見えます。本システムでも次を共通仕様にします。

- **メンテナンス**: 予定はバナーで告知し、開始時は「ログアウトして再ログイン」を促す。業務影響がある場合は明確に書く
- **更新**: クライアント更新を検知したら「更新ボタンで再読み込み」を促し、繰り返す場合は「キャッシュを消す」案内を出す
- **重要なお知らせ**: 管理者にだけ出すものと、全員に出すものを分ける（同じ場所に出すが、対象を変える）

※通知の場所（ヘッダー固定、画面上部バナー、モーダル）の使い分けは、重要度でルール化する。

## 3. データ・API 前提

管理 API は、施設/診療科/ユーザー/権限/ステータスなどの「設定の追加・参照・変更・削除」を提供する。設定変更は監査ログを記録し、フロントへ配信する。

マスタ一覧を現行画面の形で作るため、少なくとも以下が必要になる。
- **一覧取得**: 検索項目、キーワード、ページ番号、並び順を受け取って返す（総件数も返す）
- **詳細取得**: 1件の内容を返す
- **保存**: 追加/変更/無効化（物理削除は原則しない。必要なら理由と承認も扱う）

Chart 設定 API は、診療録方式・テンプレ・サマリ・メモ設定を返却する。

セット/自費メニュー管理 API、ORCA 連携設定 API（接続テスト結果・適用病名チェック設定を含む）を分けて持つ。

Config API は DICOM 接続情報・自動取得ルールを返す。System/Log リソースでセキュリティ/ログ/バックアップ設定を保持する。

表示カスタマイズ保存/配布 API で、受付列選択やカラー設定を保持・配信する。Patients 側は Patient/Insurance メンテナンス API を共通利用する。

## 4. 遷移・権限制御

Administration で定義した受付ステータスや ORCA 送信ルールを Reception/Chart Entry が参照する前提とする。更新が「すぐ反映」か「次回読み込みで反映」かは画面に明示する。

role=system_admin/管理者のみ Administration に入れる。Patients 画面は role に応じて編集/閲覧権限を切り替え、受付ロールの範囲を安全側で制限する。Patients 経由で Reception に戻る際も role チェックを再実施し、Reception 側で閲覧専用にフォールバックするガードを必須とする。

テンプレ/セット/初期表示モードの更新は Chart Entry デフォルトへ波及し、ログ保存期間やパスワードポリシーは全画面の認証・監査に影響することを UI で周知する。

Administration で設定した ORCA 接続先/送信タイミング/自費メニュー/セッション初期化は Reception/Charts に配信される前提とし、反映遅延時は Reception/Charts 両方でバナー警告（遅延理由と直近適用版のバージョン表示）とリトライ導線（再取得＋再ログイン誘導）を提示する。

現行画面に「共通」のような切り替えが見えるため、本システムでも「設定の適用範囲（共通/診療科/作業場所など）」を切り替える場面が出る可能性がある。ここは誤操作が起きやすいので、切り替え中の範囲を常に表示し、保存時にも範囲を一言添える。

## 未決事項/要擦り合わせ

- **観測計画**: 配信タイミング/権限制御/ORCA 反映手順の検証は `docs/web-client/ux/admin-delivery-validation.md` に従って実施し、結果を踏まえて確定する。
- **一覧から編集へ入る動線**: 行クリックで同一画面内に編集フォームを出すか、別画面に遷移するか（現行画面からは判断できない）。
- **配信タイミング**: Administration 変更の通知方式（即時配信/再読込/再ログイン）と Reception/Charts/Patients への反映順序をどこで保証するか。
- **監査ログ保持期間**: 患者基本情報・ORCA 連携設定・権限変更などの監査ログ保持期間と削除/アーカイブ手順、バックアップ連携の責務分界。
- **権限ガード**: role=system_admin/管理者以外が触れない設定項目の棚卸しとフロント/バック双方でのブロック方法、承認フローとの整合性確認。
- **ORCA 連携設定の反映手順**: 接続テスト→マスタ同期→送信ルール設定の順序や環境別設定の扱いを整理し、モダナイズ版 API の状態は `docs/server-modernization/phase2/operations/ORCA_API_STATUS.md` を参照して確認する。

## 5. 次アクション（RUN_ID=20251202T090000Z）

Reception から Patients へ遷移した際の戻り導線と、Administration で決めた ORCA エラー文言/送信ルールを Reception/Charts バナーに反映する手順を `ux/ux-documentation-plan.md` で管理する。

加えて、現行画面の形に合わせて「マスタ一覧の共通部品」を先に作る。最低限「検索（項目＋キーワード）」「総件数表示」「ページ送り」「列の並び順」を持つところまでを 1 つの部品として固める。

role/承認ルールの UI 表示（編集不可状態や承認待ちバッジ）と監査ログ出力の要件を Playwright ケース化し、設定変更後の配信タイミングを検証する。

## 6. テスト観点メモ

- 管理一覧で、検索（項目＋キーワード）→結果更新→総件数表示→ページ送りが一貫して動くか。
- 左メニューの折りたたみ、現在地の強調、戻ってきたときの状態保持ができるか。
- 患者編集と Administration 設定保存時の結果バナーが `aria-live` で読まれ、権限不足時は非活性/警告のいずれかで明示されるか。
- role/承認状態に応じて編集可能フィールドが正しく制御され、保存・失敗ともに監査ログが記録されること。
- メンテナンス/更新の通知が、業務画面でも確実に見え、必要なら再ログイン/再読み込みへ誘導できるか。
- 配信タイミング（即時/次回リロード/キャッシュクリア要求）が未決の場合は記録を残し、現行挙動を追跡できるようログリンクを張る。
