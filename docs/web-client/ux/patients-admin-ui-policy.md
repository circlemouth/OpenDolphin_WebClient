# 患者・管理 UX ポリシー（RUN_ID=20251202T090000Z）

- 参照元: [src/webclient_screens_plan/01_phase2/screens 3 文書の棚卸.md](../../../src/webclient_screens_plan/01_phase2/screens%203%20文書の棚卸.md)
- 証跡ログ: [docs/server-modernization/phase2/operations/logs/20251202T090000Z-screens.md](../../server-modernization/phase2/operations/logs/20251202T090000Z-screens.md)
- 目的: 患者基本情報メンテナンスとカルテ/受付の裏側設定（ロール・ステータス・ORCA/DICOM 連携・テンプレ/セットなど）を安全に管理する。

## 1. Patients 管理（基本情報メンテナンス）
- Reception の「基本情報編集」からディープリンクされる前提で、患者検索・新患登録・保険情報編集・患者メモ編集を提供。
- 変更後に Reception へ戻れるナビゲーションと、受付/カルテで参照中のデータとの整合を表示。戻り時は受付タブ/フィルタ/ソートを保持し、Reception に渡された保険/自費モードを維持したまま復帰する（ローカルストレージ＋クエリパラメータ併用）。権限不足で編集を弾いた場合も元のフィルタ状態で戻し、監査ログに拒否理由を残す。
- Patient/Insurance リソースを用いた CRUD と監査ログ（誰がいつどの項目を変更したか）を必須とする。

## 2. Administration（カルテ全般管理）
- 左メニュー＋右詳細フォームで設定するバックオフィス。role=system_admin/管理者のみアクセス。
- 管理メニュー: 施設・診療科・受付時間、ユーザー/ロール管理（権限・承認ルール）、受付/診療ステータス定義と遷移ルール。
- カルテ記載方式（SOAP/フリー）とテンプレ/サマリ/メモカテゴリ設定、セット管理（診療セット・処方/検査/接種セット・医師お気に入り・自動サジェスト閾値）、自費診療メニュー。
- ORCA 連携設定（接続テスト・マスタ同期・適用病名チェック・送信タイミング・エラー表示文言）、DICOM 接続・自動取得ルール。
- セキュリティ/パスワード/ロック/自動ログアウト、監査ログ/保存期間/バックアップ、表示カスタマイズ（受付列選択・カラー・初期タブ）。

## 3. データ・API 前提
- 管理 API: 施設/診療科/ユーザー/ロール/ステータス CRUD。設定変更は監査ログを記録しフロントへ配信。
- Chart 設定 API: 診療録方式・テンプレ・サマリ・メモ設定を返却。
- セット/自費メニュー管理 API、ORCA 連携設定 API（接続テスト結果・適用病名チェック設定を含む）。
- Config API: DICOM 接続情報・自動取得ルール。System/Log リソースでセキュリティ/ログ/バックアップ設定を保持。
- 表示カスタマイズ保存/配布 API。Patients 側は Patient/Insurance メンテナンス API を共通利用。

## 4. 遷移・権限制御
- Administration で定義した受付ステータスや ORCA 送信ルールを Reception/Chart Entry が参照する前提。更新即時反映か次回リロード反映かを明示する。
- role=system_admin/管理者のみ Administration に入れる。Patients 画面は role に応じて編集/閲覧権限を切り替え、受付ロールの範囲を安全側で制限。Patients 経由で Reception に戻る際も role チェックを再実施し、Reception 側で閲覧専用にフォールバックするガードを必須とする。
- テンプレ/セット/初期表示モードの更新は Chart Entry デフォルトへ波及し、ログ保存期間やパスワードポリシーは全画面の認証・監査に影響することを UI で周知。
- Administration で設定した ORCA 接続先/送信タイミング/自費メニュー/セッション初期化は Reception/Charts に配信される前提とし、反映遅延時は Reception/Charts 両方でバナー警告（遅延理由と直近適用版のバージョン表示）とリトライ導線（再取得＋再ログイン誘導）を提示する。

## 未決事項/要擦り合わせ
- 観測計画: 配信タイミング/権限制御/ORCA 反映手順の検証は `docs/web-client/ux/admin-delivery-validation.md` に従って実施し、結果を踏まえて確定する。
- 配信タイミング: Administration 変更の通知方式（即時配信/再読込/再ログイン）と Reception/Charts/Patients への反映順序をどこで保証するか。
- 監査ログ保持期間: 患者基本情報・ORCA 連携設定・権限変更などの監査ログ保持期間と削除/アーカイブ手順、バックアップ連携の責務分界。
- 権限ガード: role=system_admin/管理者以外が触れない設定項目の棚卸しとフロント/バック双方でのブロック方法、承認フローとの整合性確認。
- ORCA 連携設定の反映手順: 接続テスト→マスタ同期→送信ルール設定の順序や環境別設定の扱いを整理し、モダナイズ版 API の状態は `docs/server-modernization/phase2/operations/ORCA_API_STATUS.md` を参照して確認する。

## 5. 次アクション（RUN_ID=20251202T090000Z）
- Reception から Patients へ遷移した際の戻り導線と、Administration で決めた ORCA エラー文言/送信ルールを Reception/Charts バナーに反映する手順を `ux/ux-documentation-plan.md` で管理。
- role/承認ルールの UI 表示（編集不可状態や承認待ちバッジ）と監査ログ出力の要件を Playwright ケース化し、設定変更後の配信タイミングを検証する。

## 6. テスト観点メモ
- 患者編集と Administration 設定保存時の結果バナーが `aria-live` で読まれ、権限不足時は非活性/警告のいずれかで明示されるか。
- role/承認状態に応じて編集可能フィールドが正しく制御され、保存・失敗ともに監査ログが記録されること。
- 配信タイミング（即時/次回リロード/キャッシュクリア要求）が未決の場合は記録を残し、現行挙動を追跡できるようログリンクを張る。
