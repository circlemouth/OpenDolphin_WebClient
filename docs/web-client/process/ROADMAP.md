# Web クライアント開発ロードマップ総括

本ドキュメントはフェーズ 0 〜 2 の計画・到達点・フォローアップ課題を統合し、今後の意思決定に必要な情報を 1 つの資料にまとめたものです。詳細な API 一覧やセキュリティ改善はそれぞれ `architecture/REST_API_INVENTORY.md`、`process/SECURITY_AND_QUALITY_IMPROVEMENTS.md` を参照してください。

## フェーズ別サマリ

| フェーズ | 期間 | 主な成果 | 重要なフォローアップ |
|----------|------|-----------|------------------------|
| 0: 事前調査 | 2025-10-29 まで | 要件レビュー完了、REST API インベントリ整理、患者ジャーニーとワイヤーフレーム計画を確定。 | 患者登録運用の最終決定、CLAIM 自費判定の初期値確認、長輪講セッション設計の最終化。 |
| 1: 技術基盤 | 2025-10-29〜2025-11-05 | React/Vite/Query ベースの開発基盤、HTTP/認証 SDK、Storybook、CI パイプラインを整備。認証ラッパーのセキュリティレビューを完了。 | 長輪講監査ログの追加レビュー（フェーズ 2 着手時）、認証フロー図の最新化。 |
| 2: コア診療フロー β | 2026-01〜2026-05 | 認証〜患者検索〜カルテ閲覧/編集〜排他制御の一連フローを Web で再現。ロングポーリング連携と SOAP 保存の互換性確認。 | スタンプと ORCA 連携の本結合（フェーズ 3）、診療ステータス更新 UI の左カラム統合、長輪講監査ログの本番検証。 |

## フェーズ 0 詳細

- **要件レビュー**: `architecture/WEB_CLIENT_REQUIREMENTS.md` 全章の確認を完了。未決事項は患者登録の運用整理と CLAIM 自費判定 (`DocInfoModel.isSendClaim`) の初期値確認。
- **REST API インベントリ**: 主要 REST エンドポイントを用途・ガード条件・検討事項付きで整理（`architecture/REST_API_INVENTORY.md`）。フェーズ 1 以降の HTTP クライアント設計と SDK 化の基礎資料となる。
- **患者ジャーニー**: 初診・再診・自由診療の 3 パターンで受付→診療→会計までを洗い出し、カルテと ORCA の接続ポイントを明確化。
- **ワイヤーフレーム計画**: `ux/ONE_SCREEN_LAYOUT_GUIDE.md` の 22/56/22 レイアウト比率を基準に Figma でローファイ→ハイファイを進めるスケジュールを策定。患者安全アラートと右レール密度は後続フェーズで評価する。
- **リスク整理**: 患者登録の重複防止、ORCA API レイテンシの UX 対応、監査ログ抽出条件のドキュメント化を課題として継続管理。

## フェーズ 1 詳細

- **採用スタックとディレクトリ構成**: React 18 + TypeScript 5、Vite 6、TanStack Query 5、React Hook Form + Zod、Emotion、Vitest/MSW 等を正式採用。`web-client/src` の `app/`・`features/`・`libs/` 構成を確定し、Storybook と CI ワークフローを整備。
- **HTTP / 認証 SDK**: `auth-service` が MD5/UUID 生成と `/user/{fid:userId}` 認証呼び出しを一元化。`setHttpAuditLogger` により監査ログフックを提供。Web Storage 例外時はメモリ保持へ自動フォールバック。
- **AppShell 骨組み**: 固定ヘッダと左右カラムを備えた 3 カラム UI を実装し、`features` 単位でモジュールを追加できる骨格を確保。
- **セキュリティレビュー**: 認証ラッパーのコード・フロー図をレビューし、MD5 フォールバック、`clientUUID` 再利用、マルチタブ同期、監査ログ連携を承認。長輪講監査ログはフェーズ 2 着手時に再評価予定（`SEC-02`）。
- **チェックリスト完了**: スキャフォールド、HTTP クライアント、AuthProvider、Storybook、CI などフェーズ 1 の必須項目は全て完了。改善事項は `SECURITY_AND_QUALITY_IMPROVEMENTS.md` に統合済み。

## フェーズ 2 詳細

- **診療フローの再現**: ログイン→受付一覧→カルテ編集→保存→ ChartEvent 通知の一連フローを Web で動作させ、Swing 版と同じ REST 仕様で互換性を確認。`useChartLock` が `clientUUID` と排他ビットで編集中端末を管理。
- **患者検索と概要パネル**: 氏名／カナ／数字検索、当日受付一覧、アレルギー・警告メモ表示を実装。エラーメッセージは日本語で明示し、React Query でキャッシュ制御。
- **カルテタイムライン**: `DocInfoModel` をカード表示し、確定日／ステータス／注意フラグを視覚化。取得期間を UI から変更可能にし、CareMap や関連画像と連携。
- **ロングポーリング統合**: `/chartEvent/subscribe` のロングポーリングを React Query へ統合し、保存や受付状態の更新をリアルタイム反映。タイムアウトは 55 秒、リトライ 5 回を標準とする。
- **SOAP 保存互換性**: `progress-note-payload` テストで ProgressCourse モジュールの XML 生成と CLAIM 停止コード（950/960）を検証。`/karte/document/pvt/{pvtPk,state}` による状態更新と同時保存をサポート。
- **レイアウト調整**: `AppShell` のヘッダ／フッタ／サイドバーを `position: sticky` 化し、中央カラムのみスクロール。`TextArea` などアクセシビリティ対応コンポーネントを整備。
- **テスト状況**: Vitest + MSW で認証／患者／カルテ API のユニットテストを追加し、ProgressNote シリアライズを自動検証。手動検証はログインから診察完了までのシナリオで実施済み。
- **既存ユーザー配慮**: Swing と同じデータ構造を使用し、`clientUUID` 未入力時は自動採番で既存運用を継続。ロングポーリング導入に伴うサーバ設定変更は不要。

## 次のアクション

1. フェーズ 3 で予定するスタンプ／ORCA 連携の本統合と ORDER セット連携は `guides/CLINICAL_MODULES.md` の「スタンプと ORCA」の節を参照して計画を進める。
2. 長輪講監査ログ（`SEC-02`）とセキュリティトークン化検討は `SECURITY_AND_QUALITY_IMPROVEMENTS.md` と連携し、着手時期を決める。
3. 受付・カルテ連携 UI のガード条件や運用フローは `process/SWING_PARITY_CHECKLIST.md` に従い、オンプレ版との機能差分を定期的に見直す。
