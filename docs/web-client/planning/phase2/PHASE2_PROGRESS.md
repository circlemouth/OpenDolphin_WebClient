# フェーズ2 進捗メモ (更新: 2026-02-14)

## サマリ
- `/user/{fid:userId}` 認証フローを Web UI に実装し、MD5 ハッシュ・clientUUID 自動生成・ログアウト操作を一貫させた。
- `/patient/*` API を利用した患者検索と安全情報パネルを構築。警告メモ・アレルギーを常時可視化し、クリックで患者詳細を切り替え可能。
- `/karte/pid` を利用したカルテ履歴（DocInfo）取得を β 実装。取得開始日を UI で変更でき、注意フラグを強調表示するタイムラインを提供。
- `/karte/document` 保存と `/chartEvent/subscribe` ロングポーリングを組み合わせ、カルテ編集（SOAP）と排他制御を Web 版で再現した。
- アプリシェルの固定ヘッダ・フッタ・左右カラムを再レイアウトし、中央カラムのみスクロール可能な 3 カラム UI を最適化した。

## 実装ハイライト
### 認証とセッション管理
- ログインページで施設ID/ユーザーID/パスワード/任意のclientUUIDを入力。未入力時は UUID を自動生成してセッションに保存。
- 認証情報はセッションストレージへ保存し、`AuthProvider` が HTTP ヘッダーへ自動付与。ログアウトでストレージを確実に破棄。
- マルチタブでのログアウトを `storage` イベント経由で同期。

### 患者検索・安全情報
- 氏名（漢字/カナ）、患者ID、番号（digit）検索に対応。検索結果はテーブル表示、選択患者を右パネルで詳細表示。
- `appMemo` や `reserve*` の安全情報を警告バッジで表示。アレルギー・患者メモを `/karte/pid` から取得して同パネルに集約。
- 検索エラーや結果ゼロの際はユーザーへ日本語メッセージで通知。

### カルテ履歴タイムライン
- DocInfo をカード形式で表示。`hasMark` を検知して警告バッジを表示、確定日/診療科/ステータスを併記。
- 取得開始日を日付入力で切り替え可能。内部では `yyyy-MM-dd HH:mm:ss` 形式で API を呼び出す。
- 患者メモやアレルギーを同カードに表示し、安全情報の一元化を図る。

### カルテ編集・排他制御
- `features/charts` を新設し、受付リスト→診察開始→SOAP 編集→保存までを 1 画面で完結するフローを実装。
- `useChartLock` が `clientUUID` と `BIT_OPEN` を用いて `/chartEvent/event` を送信。自端末のみが編集可能な状態を維持し、終了時にロック解除。
- SOAP ノートは ProgressCourse モジュールとしてシリアライズし、`/karte/document/pvt/{pvtPk,state}` で保存と状態遷移を同時に実行。XML エンコードされた `beanBytes` を生成して既存サーバー形式を踏襲。
- `useChartEventSubscription` が `/chartEvent/subscribe` のロングポーリングをラップし、React Query キャッシュを更新。複数端末で受付/カルテ状態が即時反映される。

### レイアウト調整
- `AppShell` のナビゲーション/サイドバーを `position: sticky` に変更し、中央カラムのみスクロール。ヘッダ・フッタは常時固定。
- `TextArea` コンポーネントを追加し、SOAP 入力欄で統一したアクセシビリティとバリデーションを提供。

## 既存ユーザー影響と移行メモ
- 既存 Swing クライアントと同一資格情報を利用。clientUUID を未入力にすると自動採番されるため、新規 Web 端末の切替時も運用フローを変更せずに移行可能。
- 共有端末ではログアウト操作が必須。ログアウト時にセッションストレージを削除するため、追加のクリーニング作業は不要。
- フロントエンドでの安全情報表示は参照のみであり、サーバーデータ形式に変更なし。既存データ移行は不要。
- SOAP 保存に ProgressCourse モジュールの XML を採用しているため、既存サーバーは追加移行不要。Swing と Web の併用でもカルテデータ形式は互換。
- ロングポーリングは 60 秒タイムアウト＋即時再接続。クライアント側で指数バックオフを実装済みであり、既存サーバー設定変更は不要。

## テストと検証
- Vitest で認証/患者/カルテ API ラッパーの単体テストを追加し、リクエストパスと変換ロジックを検証。
- `features/charts/__tests__/progress-note-payload.test.ts` で ProgressCourse モジュールのシリアライズを検証。SOAP/Plan の XML が base64 で保存されることを確認。
- 手動動作確認: ログイン→受付リストから診察開始→SOAP 入力→保存→診察終了のシナリオを通し、他端末でのロック表示・解除がリアルタイムに同期されることを確認。

## 次のステップ
- SOAP テンプレート（定型文・スタンプ）やプラン編集 UI の拡張。`ProgressCourse` 以外の ModuleModel（処方・検査）の保存フロー設計。
- `/chartEvent/event` を用いた待合ステータス更新 UI を左カラムへ統合。看護師画面とのステータス整合性検証。
- ORCA 連携の準備として、患者詳細パネルに保険情報サマリ（健康保険 GUID）を表示する案を検討。
