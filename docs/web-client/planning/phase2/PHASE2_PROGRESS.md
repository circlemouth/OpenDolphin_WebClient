# フェーズ2 進捗メモ (更新: 2026-01-15)

## サマリ
- `/user/{fid:userId}` 認証フローを Web UI に実装し、MD5 ハッシュ・clientUUID 自動生成・ログアウト操作を一貫させた。
- `/patient/*` API を利用した患者検索と安全情報パネルを構築。警告メモ・アレルギーを常時可視化し、クリックで患者詳細を切り替え可能。
- `/karte/pid` を利用したカルテ履歴（DocInfo）取得を β 実装。取得開始日を UI で変更でき、注意フラグを強調表示するタイムラインを提供。

## 実装ハイライト
### 認証とセッション管理
- ログインページで施設ID/ユーザーID/パスワード/任意のclientUUIDを入力。未入力時は UUID を自動生成してセッションに保存。
- 認証情報はセッションストレージへ保存し、`AuthProvider` が HTTP ヘッダーへ自動付与。ログアウトでストレージを確実に破棄。
- マルチタブでのログアウトを `storage` イベント経由で同期。

### 患者検索・安全情報
- 氏名（漢字/カナ）、患者ID、番号（digit）検索に対応。検索結果はテーブル表示、選択患者を右パネルで詳細表示。
- `appMemo` や `reserve*` の安全情報を警告バッジで表示。アレルギー・患者メモを `/karte/pid` から取得して同パネルに集約。
- 検索エラーや結果ゼロの際はユーザーへ日本語メッセージで通知。

### カルテ履歴タイムライン
- DocInfo をカード形式で表示。`hasMark` を検知して警告バッジを表示、確定日/診療科/ステータスを併記。
- 取得開始日を日付入力で切り替え可能。内部では `yyyy-MM-dd HH:mm:ss` 形式で API を呼び出す。
- 患者メモやアレルギーを同カードに表示し、安全情報の一元化を図る。

## 既存ユーザー影響と移行メモ
- 既存 Swing クライアントと同一資格情報を利用。clientUUID を未入力にすると自動採番されるため、新規 Web 端末の切替時も運用フローを変更せずに移行可能。
- 共有端末ではログアウト操作が必須。ログアウト時にセッションストレージを削除するため、追加のクリーニング作業は不要。
- フロントエンドでの安全情報表示は参照のみであり、サーバーデータ形式に変更なし。既存データ移行は不要。

## テストと検証
- Vitest で認証/患者/カルテ API ラッパーの単体テストを追加し、リクエストパスと変換ロジックを検証。
- 手動動作確認: ログイン→患者検索→患者選択→カルテ履歴表示のシナリオで UI を確認。エラー時のユーザー通知も併せて確認。

## 次のステップ
- `/karte/*` での SOAP ノート分解とエディタ UI（右カラム）を整備し、編集/保存フローへ拡張。
- `/chartEvent/subscribe` をラップした長輪講クライアントを実装し、受付/カルテ状態を自動更新。
- ORCA 連携の準備として、患者詳細パネルに保険情報サマリ（健康保険 GUID）を表示する案を検討。
