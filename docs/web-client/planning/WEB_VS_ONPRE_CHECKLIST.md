# Web クライアントとオンプレクライアント機能差分チェックリスト

本チェックリストは、Web クライアントの機能が既存オンプレ（Swing）クライアントと同等かを確認し、差分解消に向けた次タスクを明確にするためのものである。各項目をレビューし、完了条件を満たしたらチェックを入れる。未完了の場合はフォローアップタスクを起票すること。

## 1. オーダー登録機能
- [x] **ProgressCourse 以外のモジュール保存**: 処方・注射・検査など `Bundle*` モジュールがサーバーへ送信・保存されるか確認し、`DocInfoModel` の `hasRp`/`hasTreatment`/`hasLaboTest` フラグが適切に更新されるよう実装する。
  - 2026-05-03: `ChartsPage` にオーダモジュール管理を実装し、保存時に `createProgressNoteDocument` へモジュール配列を統合。エンティティ別に `DocInfoModel` のフラグを自動で立てるよう改修。
- [x] **スタンプ/ORCA UI とバックエンド連携**: Web 版のスタンプエディタおよび ORCA マスター検索で選択した項目がサーバーへ連携され、登録結果がカルテに反映される。
  - 2026-05-03: スタンプ挿入時に `/stamp/id/{stampId}` を呼び出して `ModuleModel` を取得し、Plan カードへ反映。ORCA 検索結果からも `/orca/stamp/{code},{name}` を利用してモジュールを生成し、そのままカルテ保存へ連携する導線を追加。
- [x] **バリデーションとエラー処理**: オーダー送信時の入力検証、併用禁忌チェック、サーバーエラー表示が Swing クライアント同等以上であることを確認する。
  - 2026-04-24: `ChartsPage` で診察開始状態・保険選択・カルテ取得有無を検証して保存をガードし、`OrcaOrderPanel` で検索/併用禁忌 API のエラー通知と重大度別ブロックを実装済み。
- [x] **ClaimItem 整合性確認**: オーダー登録後に `ClaimItem` や数量、剤型などがサーバー側データ要件（`features/ORDER_ENTRY_DATA_GUIDE.md`）を満たしていることを検証する。
  - 2026-05-03: `createProgressNoteDocument` でオーダモジュールの `beanBytes` を検査し、`ClaimItem` タグ欠落時は保存を中断するバリデーションを追加。対応テストを拡張。

### 推奨フォローアップタスク
- [x] ORCA 連携テストケースの作成と自動化（モックまたはテストサーバー利用）。
  - 2026-04-24: `features/charts/api/__tests__/orca-api.test.ts` を追加し、ORCA マスター検索・一般名照会・併用禁忌 API のマッピングと異常系をモックで自動検証。
- [x] オーダーモジュール保存時の監査ログ整備とアラート条件定義。
  - 2026-04-24: `saveProgressNote` 内でカルテ保存成功時に `recordOperationEvent` を記録し、保存モジュール数・請求モードを監査メタデータとして出力。

## 2. 患者情報管理
- [x] **編集 API 実装**: `/patient` 系エンドポイントの POST/PUT を Web クライアントで実行でき、患者属性・保険情報を更新可能にする。
  - 2026-05-03: `PatientsPage` に患者編集フォームを追加し、`/patient` POST/PUT を利用した新規登録・更新フローを構築。健康保険モジュールは `encodeHealthInsuranceBean` を用いて Java Bean を再生成し、既存データの GUID や拡張属性を保持したまま保存できるよう整備した。
- [x] **UI/UX 確認**: 受付オペレーションに沿った入力動線（検索→編集→保存）が Swing クライアントと同等以上に成立しているか確認する。
  - 2026-05-03: 患者検索ヘッダから新規登録モードへ遷移できる導線と、既存患者の詳細読み込み・バリデーション・エラー表示を備えた編集カードを実装。郵便番号／住所／連絡先・安全メモ・保険情報を一画面で編集できるようにし、保存成否をステータスバッジで即時フィードバックする。
- [x] **変更履歴・監査**: 患者情報更新時に履歴が残るか、監査ログが取得できるかを確認し、不足する場合は仕様を策定する。
  - 2026-05-03: 新規登録・更新・保険行追加/削除時に `recordOperationEvent` を発火し、操作モード・患者 ID・レスポンス ID を監査ログへ送出。React Query キャッシュの無効化で一覧・カルテ詳細を再取得し、更新履歴が UI とログ双方で同期するようにした。

### 推奨フォローアップタスク
- [x] エッジケース（多重保険、住所変更、匿名化等）のテストケース整備。
  - 2026-04-24: `health-insurance.test.ts` に複数保険 GUID・警告発生時のフォールバックを検証するケースを追加し、変換ロジックが多重保険入力に耐えることを確認。
- [ ] 受付担当者向けマニュアルの更新および研修計画立案。

## 3. サマリ／問診・患者メモ
- [x] **編集機能実装**: Web カルテ画面右ペインから問診サマリ・患者メモを新規作成／編集できる UI と API を実装する。
  - 2026-04-25: `ChartsPage` と `RightPane` に問診メモ／患者メモの編集カードを追加。`/chartEvent/event`（PVT_MEMO）で受付メモを即時反映し、`/karte/memo` への PUT を新規実装して患者メモを保存するように更新。保存結果をリアルタイムに反映するため `usePatientKarte` 再取得と監査ログ送信を組み込み、オンプレ版の MemoInspector と同等の編集体験を提供。
- [x] **FreeDocument 連携**: サマリ文書を FreeDocument として保存し、Swing クライアントで閲覧・編集したデータと双方向で整合性がとれることを確認する。
  - 2026-05-01: `ChartsPage` 右ペインに FreeDocument エディタと `saveFreeDocument` API を追加し、保存後に再取得してオンプレ版とのデータ整合性を検証。監査ログにサマリ保存イベントを記録。
- [x] **自動保存とアクセス制御**: カルテクローズ時の自動保存、権限別の閲覧／編集制御が Swing クライアント同等に設定されているか確認する。
  - 2026-04-24: `ChartsPage` の `handleUnlock` で未保存変更を検知して保存処理を自動実行し、`useChartLock` による排他制御と組み合わせて診察終了時の取りこぼしを防止。

### 推奨フォローアップタスク
- [x] 患者メモのバージョン履歴 UI の追加検討。
  - 2026-05-05: 右ペインの患者メモカードに「履歴」ボタンを追加し、保存済みバージョンを一覧・プレビューできるダイアログを実装。選択した履歴を編集欄へ復元する操作を追加し、`recordOperationEvent('patient_memo_history_apply')` で監査ログを送出。復元後は従来通り保存ボタンで `/karte/memo` PUT を発行するためデータ移行は不要。
- [ ] 問診テンプレートの共有／配布フロー策定。

## 4. 予約・受付／スケジュール管理
- [x] **状態更新操作**: 待機→呼出→診察中といった状態遷移を Web 版で実行できるようにし、サーバーへ即時反映させる。
  - 2026-04-23: `ReceptionPage` に呼出/待機トグルを追加。ChartEvent (PVT_STATE) を介して `/chartEvent/event` を呼び出し、全端末へ即時同期する。
- [x] **予約 CRUD**: 予約の登録／更新／削除を Web 版で操作できるよう実装し、`ScheduleDelegater` 相当の API 呼び出しを網羅する。
  - 2026-05-01: 受付画面に `AppointmentManager` を追加し、`/karte/appo` を利用した取得・登録・更新・取消フローを React Query で整備。患者別に 60 日の予約を編集可能とした。
  - 2026-05-02: 保存処理中に親画面の操作を無効化するガードを追加し、モーダル閉鎖や再オープンによる競合を防止。
- [x] **受付メモ同期**: 待ち一覧のメモを編集した際にオンプレクライアントとリアルタイムで同期されるか確認する。
  - 2026-04-23: 受付カード内でインライン編集 UI を実装。保存時は ChartEvent (PVT_MEMO) を送出し、`useChartEventSubscription` でメモと安全メモバッジを更新。
- [x] **通知と例外処理**: 予約変更時の通知、重複予約やキャンセル処理など例外系を設計し、テストを整備する。
  - 2026-05-01: 予約重複検知と操作結果のインライン通知を実装し、`appointment-api` の単体テストで正常系／異常系をカバー。保存失敗時はエラーを掲示する。

### 推奨フォローアップタスク
- [ ] 予約画面の統合テストシナリオ整備と自動化。
- [ ] 患者向けリマインダー送信フローの検討（メール／SMS 等）。

## 運用メモ
- 各チェック項目の完了時には、対応する仕様・実装を `planning/WEB_CLIENT_WORK_PLAN.md` および関連ドキュメントに反映すること。
- ギャップが解消されない場合は課題管理ツールに Issue を登録し、優先度と担当者を明記する。
- 機能実装により既存ユーザーの運用が変わる場合は、移行手順や設定変更内容を `operations/` 配下の資料へ追記する。
