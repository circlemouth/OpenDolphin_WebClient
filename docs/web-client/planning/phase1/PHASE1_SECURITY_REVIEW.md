# フェーズ1 認証ラッパー セキュリティレビュー報告書 (実施日: 2025-11-05)

## 1. 概要
- **目的**: フェーズ1で実装した `auth-service` / `AuthProvider` を中心とした認証ラッパーが、既存サーバーのヘッダー仕様とセキュリティ要件に適合しているかを確認する。
- **対象範囲**:
  - `web-client/src/libs/auth/auth-service.ts`
  - `web-client/src/libs/auth/auth-storage.ts`
  - `web-client/src/libs/auth/AuthProvider.tsx`
  - Storybook/ドキュメントに掲載した認証関連の利用ガイドライン
- **参加者**:
  - セキュリティチーム: K. Nishimura
  - フロントエンド開発: Agent
- **参照資料**:
  - `docs/web-client/planning/phase1/PHASE1_FOUNDATION.md`
  - `docs/web-client/design-system/ALPHA_COMPONENTS.md`
  - 認証フロー図（内部共有 Figma, バージョン 2025-11-04）

## 2. 実施内容
1. 認証フロー図を元に、`/user/{fid:userId}` 認証 API 呼び出し手順とヘッダー生成（`userName`, `password(MD5)`, `clientUUID`）の整合性を確認。
2. コードレビューで以下の観点を検証。
   - MD5 ハッシュ生成を Web Crypto API → `crypto-js` フォールバックで行う実装がエラーハンドリング・監査ログ要件を満たすか。
   - `clientUUID` の生成と再利用がセッション固定化や多重ログイン抑止の要件に沿うか。
   - ストレージ例外（クォータ超過、プライベートモード）時のフォールバック方針。
   - 複数タブ間同期時の循環更新防止策と、ログアウト操作の伝播。
3. Storybook に掲載した `AuthProvider` 利用例とデザインシステム文書が、開発者向け運用ガイドとして十分かを確認。

## 3. 評価結果
| 区分 | 評価 | コメント |
| ---- | ---- | -------- |
| MD5 ハッシュ生成 | 承認 | Web Crypto API 非対応ブラウザでは `crypto-js` を利用し、フォールバック時は警告ログのみ出力。警告は 1 度に抑制されており、情報漏えいリスクは低いと判断。 |
| `clientUUID` 管理 | 承認 | UUID は初回ログイン時に生成し、セッション維持のためストレージへ永続化。認証時に差異が検出された場合は再発行し、監査ログフックにイベントを出力できる。 |
| ストレージ例外対応 | 改善確認済み | `auth-storage` で try/catch を実装済みで、例外発生時はフォールバックとしてメモリ保持へ切り替える。重複ログ抑制も実装済みであることをレビューで確認。 |
| 多タブ同期 | 承認 | `AuthProvider` が `storage` イベントを購読し、`originClientUUID` 比較で循環更新を防止。ログアウト操作も相互に伝播する設計。 |
| 監査ログ連携 | フォローアップ | 現行実装では HTTP 監査ログに `clientUUID`/ユーザー ID が含まれる。長輪講セッションの監査要件はフェーズ2で改めて確認する。 |

## 4. 指摘と対応
- **指摘 1**: フォールバックログが多重に出力される可能性 → `auth-storage` の `warnOnce` ガードを確認済み。追加対応不要。
- **指摘 2**: 認証フロー図に長輪講クライアント（`/chartEvent/subscribe`）のセッション延命条件を追記する必要あり → 2025-11-06 までに Figma 図へ追記する。ドキュメント反映はフェーズ2計画で追跡。

## 5. 決定事項
- 認証ラッパーの実装はフェーズ1完了条件を満たしており、セキュリティチームとして承認する。
- フェーズ2で実サービス接続試験を実施する際、長輪講クライアントの再接続戦略と監査ログの保持期間について追加レビューを行う。

## 6. アクションアイテム
| ID | 内容 | 担当 | 期限 | ステータス |
| -- | ---- | ---- | ---- | ---------- |
| SEC-01 | 認証フロー図へ長輪講セッション延命条件を追記 | Agent | 2025-11-06 | 対応中 |
| SEC-02 | フェーズ2開始時に長輪講監査ログ設計レビューを実施 | K. Nishimura | 2026-01-05 | 未着手 |

## 7. 参考リンク
- Storybook (local): `npm run storybook`
- GitHub Actions: `.github/workflows/web-client-ci.yml`
- 関連コード: `web-client/src/libs/auth/`
