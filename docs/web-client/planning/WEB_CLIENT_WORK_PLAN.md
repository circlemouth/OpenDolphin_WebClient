# Webクライアント開発 実装計画 (更新: 2025-10-29)

## 全体方針
- `../requirements/WEB_CLIENT_REQUIREMENTS.md` に定義された機能/非機能要件を満たしつつ、`../ux/ONE_SCREEN_LAYOUT_GUIDE.md` に記載の 1 画面完結 UI コンセプトを採用する。
- 既存の WildFly + Java EE サーバーと WEB ORCA との連携は改変せず、REST API と長輪講を安全に再利用する。
- 自費診療・保険カルテを同一 UI で切り替え可能にし、`ClaimConst.RECEIPT_CODE_JIHI` を含む請求データを正しく送信する。
- ロードマップは 2025 年 Q4 〜 2026 年 Q2 のローンチを想定。各フェーズ終了時にレビュー会議で承認を得る。

## マイルストーン概要
| フェーズ | 目安期間 | 主目的 |
| --- | --- | --- |
| フェーズ0: ディスカバリ & UX アラインメント | 2025-11-03〜2025-11-21 | 要件精査と 1 画面レイアウトの合意 |
| フェーズ1: プラットフォーム基盤 | 2025-11-24〜2025-12-19 | 認証・共通クライアント・レイアウト骨子 |
| フェーズ2: コア診療フロー | 2026-01-05〜2026-02-14 | ログイン〜カルテ編集〜保存の一連実装 |
| フェーズ3: ORCA/自費拡張 | 2026-02-17〜2026-03-27 | スタンプ・マスター連携・自費 UI 完備 |
| フェーズ4: 品質・安全性強化 | 2026-03-30〜2026-04-24 | 非機能最適化とセキュリティ検証 |
| フェーズ5: リリース準備 | 2026-04-27〜2026-05-22 | 並行運用・トレーニング・本番承認 |
| フェーズ6: 継続改善 | 2026-05-25 以降 | 運用モニタリングと将来拡張 |

---

## フェーズ0: ディスカバリ & UX アラインメント (2025-11-03〜2025-11-21)
- **ゴール**: 要件・API・UI コンセプトを整理し、フェーズ以降の設計判断材料を固める。
- **主要アウトプット**: 要件レビュー記録、API インベントリ、患者旅シナリオ、1 画面ワイヤーフレーム。
- **タスク**
  - [x] `../requirements/WEB_CLIENT_REQUIREMENTS.md` の承認取得と変更点ログ化。
    - 2025-10-29: フェーズ0レビュー完了。差戻し事項なし。議事は `planning/phase0/PHASE0_DELIVERABLES.md` に記載。
  - [x] `server/src/main/java/open/dolphin/rest` / `open/orca/rest` の REST エンドポイント一覧・利用可否を作成。
    - 2025-10-29: `planning/phase0/API_INVENTORY.md` を公開。リトライ/タイムアウト設計はフェーズ1で継続検討。
  - [x] 医師/看護師向け業務フロー資料を整理し、`../ux/ONE_SCREEN_LAYOUT_GUIDE.md` Appendix と整合した患者ジャーニー（再診/初診/自由診療）を作成。
    - 2025-10-29: 初診/再診/自費シナリオを `planning/phase0/PHASE0_DELIVERABLES.md` に反映。今後フィードバック待ち。
  - [ ] `../ux/ONE_SCREEN_LAYOUT_GUIDE.md` の 1 画面レイアウトをベースにロー/ハイレベルワイヤーフレームを制作し、主要ステークホルダーのサインオフを得る。
    - 2025-10-29: ローファイ/ハイファイ制作スケジュールと承認プロセスを策定。実制作は 2025-11-04 着手予定。
  - [x] 認証ヘッダー仕様（userName/password(MD5)/clientUUID）と長輪講運用方針の再確認。
    - 2025-10-29: 現行ヘッダー仕様と長輪講再接続方針を整理し、`planning/phase0/PHASE0_DELIVERABLES.md` に記録。
- **完了条件**
  - レビュー会議で全関係者がワイヤーフレームと優先度に合意し、承認議事録を保存。
  - API インベントリが CI 上で参照可能なドキュメントとして公開される。

## フェーズ1: プラットフォーム基盤 (2025-11-24〜2025-12-19)
- **ゴール**: 認証・HTTP クライアント・レイアウト骨子を実装し、開発者が共通基盤上で機能拡張できる状態を作る。
- **主要アウトプット**: 認証 SDK、共通 HTTP クライアント、アプリシェル、デザインシステム α 版。
- **タスク**
  - [x] TypeScript + React（想定）など採用スタックの決定と初期プロジェクトセットアップ。
    - 2025-10-29: React 18 + TypeScript + Vite 構成の `web-client/` プロジェクトを作成し、基本スクリプト（lint/typecheck/test）と環境変数サンプルを整備。
  - [x] MD5 ハッシュ生成・`clientUUID` 管理・ヘッダー付与をまとめた認証ラッパーを SDK 化。
    - 2025-11-04: `auth-service` で `/user/{fid:userId}` を呼び出し、MD5 ハッシュ/UUID 生成/セッション永続化/ストレージ復元を実装。`AuthProvider` は複数タブ同期と `httpClient` へのヘッダー提供を担保。
  - [x] `fetch`/`axios` ベースの HTTP クライアントにリトライ・タイムアウト・監査ログフックを実装。
    - 2025-11-04: `setHttpAuditLogger` を追加し、リクエスト・レスポンス・リトライ失敗をイベント化。指数バックオフの単体テストを整備。
  - [x] ルーティング・権限ガード・固定ヘッダ/フッタ/左右 3 カラムレイアウトのアプリシェルを構築。
    - 2025-10-29: `AppShell` コンポーネントで 1 画面 3 カラムレイアウトのスケルトンを実装し、ダッシュボード仮ページを配置。
  - [x] ワイヤーフレームを UI ライブラリ化し、フォーム/テーブル/通知/モーダル等の共通コンポーネントを用意。
    - 2025-11-04: `src/components/` に Button/TextField/SurfaceCard/StatusBadge/Stack 等を追加し、デザインシステム α 版を Storybook に登録。`docs/web-client/design-system/ALPHA_COMPONENTS.md` に仕様を整理。
  - [x] CI に lint・型チェック・単体テストを追加し、フェーズ2開発の足場を固める。
    - 2025-11-04: GitHub Actions ワークフロー `web-client-ci.yml` を作成し、`npm ci` → `lint` → `typecheck` → `test` → `build-storybook` を自動実行。
- **完了条件**
  - ダミー API でログイン〜ダッシュボード表示が動作し、デザインシステム α 版の Storybook あるいは同等ツールが公開されている。
    - 2025-11-04: `auth-service` の単体テストで `/user` 認証フローとヘッダー付与を検証。Storybook 8.6 で UI コンポーネントを公開。
  - セキュリティチームが認証ラッパーのダイアグラムとコードをレビュー済み。
    - 2025-11-05: セキュリティチーム（K. Nishimura）がレビューを完了し、重大指摘なしで承認。詳細は `planning/phase1/PHASE1_SECURITY_REVIEW.md` を参照。

## フェーズ2: コア診療フロー (2026-01-05〜2026-02-14)
- **ゴール**: ログイン、患者検索、カルテ閲覧/編集、排他制御を Web 上で再現し、1 画面完結の基本体験を成立させる。
- **主要アウトプット**: ログイン/ログアウト、患者リスト、カルテ主画面（閲覧/編集）、長輪講クライアント β。
- **タスク**
  - [x] `/user/{fid:userId}` 認証フローを実装し、セッションキー管理（localStorage など）とログアウトを整備。
    - 2026-01-15: Web ログイン画面を実装し、MD5 ハッシュ・clientUUID 自動生成・ストレージ復元・明示的ログアウトまでを React で再現。`AuthProvider` がヘッダーへ自動付与。
  - [x] `/patient/*` API を利用した検索・一覧 UI と安全情報（アレルギー/危険サイン）の常時表示を実装。
    - 2026-01-15: 患者検索フォーム（氏名/カナ/ID/番号）と一覧テーブルを追加。患者概要パネルに安全メモとアレルギーを常設し、警告バッジで強調。
  - [x] `/karte/*` API によるカルテ履歴取得、SOAP ノート構造、過去カルテスプリット表示を開発。
    - 2026-01-15: `/karte/pid` からアレルギー・患者メモ・DocInfo を取得するカルテタイムライン β を構築。取得開始日を UI で調整可能にし、注意フラグをハイライト表示。
  - [x] カルテ編集画面で `clientUUID` 排他制御を行い、診察開始/終了ワークフローを UI に組み込む。
  - [x] 固定ヘッダ・固定フッタ・左右カラムの動作を最適化し、主要シナリオ（再診/初診）のクリックパスを評価。
  - [x] ロングポーリング `/chartEvent/subscribe` をラップするクライアントを実装し、受付/カルテ状態のリアルタイム更新を実現。
- **完了条件**
  - 医師・看護師代表へのデモで再診シナリオが 5 分以内に完結し、フィードバックが文書化される。
  - 自動テストで主要ワークフロー（ログイン→患者検索→カルテ閲覧）が通過する。

## フェーズ3: ORCA/自費拡張 (2026-02-17〜2026-03-27)
- **ゴール**: スタンプ/オーダリング、ORCA マスター検索、自由診療 UI を統合し、請求データが正確に生成される状態を作る。
- **主要アウトプット**: スタンプ管理 UI、ORCA マスター検索、併用禁忌チェック、自費カルテモード、ORCA 連携エンドツーエンドテスト。
- **タスク**
  - [x] `/stamp` 系 API を利用したスタンプ閲覧・検索・挿入 UI とお気に入り機能を実装。
    - 2026-02-20: `StampLibraryPanel` をカルテ編集画面に追加し、スタンプツリー解析ユーティリティとお気に入り保存を実装。Plan への挿入は暫定的にテキスト追記で対応。
  - [x] `/orca/tensu/*`, `/orca/disease/*`, `/orca/general/*` 等のマスター検索 UI を中央/右カラムに統合し、1 クリック発注導線を構築。
    - 2026-02-20: `OrcaOrderPanel` で診療行為/傷病名/一般名検索を実装し、既存処方・追加予定リストへの登録導線を整備。
  - [x] `/orca/interaction` による併用禁忌チェックとアラート優先度設計（重大通知/インライン通知）を実装。
    - 2026-02-20: ORCA 併用禁忌 API ラッパーを追加し、候補コード間の相互作用を UI で可視化。結果に症状コード/概要を表示。
  - [x] 自費カルテモードの UI 配色・入力フォーム・「その他の自費」カテゴリ選択を実装し、`DocInfoModel.healthInsurance` と `DocInfoModel.isSendClaim` の制御を検証。
    - 2026-03-06: 請求モードカードを追加し、保険/自費切替・数量/実施者等の入力欄を提供。保存時に 950/960 コードと `sendClaim=false` を適用するロジックを実装。
  - [x] ORCA マスター 095/096 系コードを用いた自費オーダーの登録〜CLAIM 送信確認を自動テストでカバー。
    - 2026-03-06: `progress-note-payload.test.ts` に 095/096 コードと CLAIM 停止を検証するテストを追加。保険 Bean の XML デコードテストも整備。
  - [x] 患者向け文書/PDF（指導文/紹介状）のテンプレート呼び出しとダウンロード導線を整備。
    - 2026-03-06: `PatientDocumentsPanel` で指導文/紹介状テンプレートを提供し、ブラウザ印刷による PDF 保存を案内。患者情報を自動差し込み。
- **完了条件**
  - 医師・看護師モニターによる自由診療シナリオが問題なく完遂し、ORCA 連携ログでエラーが発生しない。
  - CLI/ブラウザ自動テストで自費/保険双方のカルテ保存が成功する。

## フェーズ4: 品質・安全性強化 (2026-03-30〜2026-04-24)
- **ゴール**: 非機能要件（性能/セキュリティ/アクセシビリティ）を満たし、安全な運用基盤を整える。
- **主要アウトプット**: 性能・負荷テスト結果、セキュリティ診断報告、アクセシビリティ監査、運用監視設計。
- **タスク**
  - [ ] HTTPS 証明書配備、CORS、CSP、CSRF 対策を適用し、認証ヘッダー保護方針を文書化。
  - [ ] フロントエンドのキャッシュ制御を設計し、患者情報がブラウザキャッシュやローカルストレージに残留しないよう HTTP ヘッダー／Storage ポリシーを適用。
  - [ ] 監査ログ/操作ログの設計と出力（診療履歴・請求操作）を実装、SIEM 連携計画をまとめる。
  - [ ] Lighthouse/axe 等によるアクセシビリティ評価を実施し、キーボード操作やスクリーンリーダ対応を修正。
  - [ ] ORCA マスター検索やカルテ描画のレスポンス測定を行い、目標 (3 秒/5 秒) を満たすよう最適化。
  - [ ] 30 クライアント同時接続を想定した負荷テストを自動化し、ボトルネック改善計画を策定。
  - [ ] シフト制オペレーション向けにアラート疲労対策のルール（重大通知のみに遮断を適用）を反映。
- **完了条件**
  - セキュリティレビュー会で重大指摘がクローズし、性能テストで SLA/SLO を達成。
  - アクセシビリティ評価が AA 相当を満たす。

## フェーズ5: リリース準備 (2026-04-27〜2026-05-22)
- **ゴール**: 並行運用計画・教育・サポートを整備し、安全に本番リリースできる状態にする。
- **主要アウトプット**: 並行運用ガイド、マニュアル草案、パイロット評価レポート、リリース承認記録。
- **タスク**
  - [ ] 既存 Swing クライアントとの並行運用フロー（患者選択排他、データ整合性）をドキュメント化。
  - [ ] 医師/看護師別トレーニング資料とクイックリファレンスを作成し、共有済みの画面構成サンプルと整合する新 UI を再現。
  - [ ] 初期導入施設を選定し、パイロット実施計画（観察ポイント/アンケート）を準備。
  - [ ] パイロット運用で収集した改善事項を整理し、リリース候補版に反映。
  - [ ] リリース判定会議で承認を取得し、ローンチ日・ロールアウト手順を確定。
- **完了条件**
  - パイロット期間の重大インシデントがゼロであることを確認。
  - トレーニング資料と FAQ が共有ストレージで公開され、サポートチームが引き継ぎ完了。

## フェーズ6: 継続改善 (2026-05-25 以降)
- **ゴール**: 運用データに基づく改善と将来拡張（トークン認証、SSE/WS、ブラウザネイティブ PDF）を計画的に進める。
- **主要アウトプット**: KPI ダッシュボード、改善バックログ、将来拡張ロードマップ。
- **タスク**
  - [ ] 稼働後 30/60/90 日レビューで KPI（操作時間、アラート数、エラー率）を計測し、改善 backlog に反映。
  - [ ] トークン認証方式・SSE/WS 置換の PoC を準備し、影響範囲とスケジュールを提案。
  - [ ] PDF/帳票のブラウザネイティブ化、患者ポータル連携などの将来テーマを優先順位付け。
  - [ ] 法令・ORCA マスター更新の定期チェック体制を整備し、半年ごとの要件見直し会議を開催。
- **完了条件**
  - 改善バックログが四半期ごとのスプリント計画に反映され、経営層に報告される。
  - 将来拡張ロードマップが `../overview/AGENT_OVERVIEW.md` と整合して更新される。

---

## 横断イニシアチブ
- **UX/デザイン**: フェーズ毎に `../ux/ONE_SCREEN_LAYOUT_GUIDE.md` を参照して視線移動・入力効率を検証し、NIST/PSNet 推奨ガイドラインをチェックリスト化。
- **ドキュメンテーション**: 各フェーズ終了時に成果物をリポジトリの `docs/` あるいは既存ドキュメントへ追記し、`../README.md` の「ストラクチャ概要」を更新。
- **品質管理**: CI での自動テスト、コードレビュー基準、リグレッションテスト手順を標準化し、フェーズ4以降は release branch 運用を開始。
- **リスク & コミュニケーション**: ロングポーリング障害、自費請求エラー、ORCA マスター齟齬といった高リスク項目に対する対応計画をリスクログで管理。

本計画は状況に応じて更新する。更新時は日付・責任者・主要変更点を冒頭に追記し、ステークホルダーへ共有すること。
