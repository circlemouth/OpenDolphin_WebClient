# 診断書エディタとシェーマエディタ仕様

本ドキュメントでは、Web クライアントに新設した診断書（MedicalCertificate）エディタとシェーマ（手描き画像）エディタの仕様・操作手順・移行上の注意点をまとめる。従来のオンプレ Swing クライアントに搭載されていた `MedicalCertificateViewer` および `SchemaEditorImpl` の主要機能を Web 上で再現し、診断書出力と手描き画像保存の運用差分を解消した。

## 1. 診断書エディタ

- 追加場所: `ChartsPage` の Supplement パネル内「診断書・医療文書」カード。
- 主な機能:
  - 患者情報をカルテから自動差し込み（氏名・生年月日・住所・電話等）。
  - 既存診断書の一覧取得（`GET /odletter/list/{karteId}`）と個別読み込み（`GET /odletter/letter/{letterId}`）。
  - オンプレ版と同じ `disease`／`informedContent` を持つ `LetterModule` を生成し、`PUT /odletter/letter` で保存。
    - 既存文書の更新時は `linkId` に旧 PK を渡し、履歴を置き換える互換仕様を踏襲。
  - ブラウザ上で HTML プレビュー→印刷（PDF 保存可）。プレビューが開けない環境では自動で HTML をダウンロードし、院内端末での PDF 出力手順にフォールバックする。
  - 保存・削除操作は `recordOperationEvent` により監査ログへ記録。
- 監査・整合:
  - 保存後は React Query の診断書一覧キャッシュを失効させ、一覧とカルテ右ペインでの文書参照が同期するようにした。
  - FreeDocument／カルテ保存と同様、`karteQuery.refetch()` を呼び出し、日次サマリ・CareMap にも反映される。

## 2. シェーマエディタ

- 追加場所: `ChartsPage` の Supplement パネル内「シェーマエディタ」カード。
- 主な機能:
  - HTML5 Canvas を用いた描画ツール（ペン／直線／矩形／楕円／消しゴム／テキスト）。Undo/Redo・全消去・塗りつぶし指定に対応。
  - 描画結果を JPEG Base64 としてエクスポートし、`POST /karte/document` に `SchemaModel` を含む `DocumentModel` を送信。`ExtRefModel` の `medicalRole`／`title` は UI 入力値を使用。
  - 保存時は `schemaSave` として監査ログを出力し、カルテ一覧再読込を促すメッセージを表示。
  - 医療機関名・担当医（表示名／共通名）・診療科コードはカルテ選択済みの受付情報から初期化。患者情報が未選択の場合は保存ボタンを自動的に無効化する。
- 描画仕様:
  - キャンバス解像度: 760x520px（Retina に対応するよう CSS サイズと内部解像度を分離）。
  - テキストツールは中央配置、フォントは Noto Sans 系で描画。線幅は 2〜12px を選択でき、テキストサイズは線幅に応じて換算。

## 3. 互換性と移行メモ

- オンプレ側と同じ REST API を利用するため追加のサーバ変更は不要。`LetterModule`／`SchemaModel` の JSON フォーマットは既存コンバータに合わせている。
- 既存ユーザーは Swing 版と同じ項目名称で編集できるよう、フィールドラベル・帳票タイトルを踏襲した。診断書保存時に `linkId` を設定することで旧版削除処理も互換動作する。
- 手描き画像は JPEG 化して保存する仕様のため、院内ファイルサーバへの書き出しフローは従来と変わらない。従業員トレーニングでは「シェーマ保存後はカルテを再読込し、CareMap に画像が表示されること」を確認する手順を追加すること。

## 4. 運用・教育

- 受付／診療スタッフ向け研修では、診断書の既存データ呼び出し→修正→PDF 出力、およびシェーマ描画→保存→カルテ確認までのシナリオを盛り込む。
- 本仕様追加に伴い、運用マニュアル (`operations/RECEPTION_WEB_CLIENT_MANUAL.md`) に研修メニューと連絡手順を追記済み。必ず最新改訂版を参照すること。
