# フェーズ3 スタンプ・ORCA 連携メモ (更新: 2026-03-06)

フェーズ3 前半で追加したスタンプライブラリと ORCA マスター検索・併用禁忌チェック UI の仕様と実装メモです。Web クライアントのカルテ編集画面（`ChartsPage`）に統合され、診療中にスタンプを呼び出して Plan へ追記したり、診療行為コードを検索して禁忌判定を行うことができます。

## 1. スタンプライブラリ UI
- `/stamp/tree/{userPK}` 応答の `treeBytes` を Base64 デコードし、スタンプツリー XML からカテゴリ／スタンプを抽出するユーティリティ（`utils/stamp-tree.ts`）を追加。
- React Query を用いてログインユーザーのスタンプを取得し、`StampLibraryPanel` でカテゴリ毎に表示。検索（名称・メモ・フォルダ名・エンティティ）、お気に入りフィルタ、再読込をサポート。
- お気に入りはローカルストレージ `opd.web.stampFavorites.v1` に保存し、同一ブラウザで維持。既存ユーザーのデータは存在しないため移行は不要。
- 「挿入」操作時は診察ロック中に限り、Plan テキスト末尾へ `スタンプ名 (entity) [サブフォルダ]` を追記し、即座にフィードバックを表示。今後 DocumentModel へのスタンプ展開に差し替える前提の暫定実装。

## 2. ORCA マスター検索
- `/orca/tensu/name/{keyword,date,partial}`、`/orca/disease/name/{keyword,date,partial}`、`/orca/general/{code}` に対応する検索ミューテーションを追加。フェーズ2までの UI に干渉せず、右カラムに `OrcaOrderPanel` を配置。
- 診療行為検索は部分一致（既定）/前方一致の切り替えを提供し、ヒットした行為を「既存処方」「追加予定」リストへ振り分け可能。
- 傷病名検索は参照専用（現状は表示のみ）。一般名コード照会は単一結果を表示し、将来的に医薬品スタンプ生成へ展開できるようにする。

## 3. 併用禁忌チェック
- `/orca/interaction` へ PUT するラッパーを実装。UI では既存処方と追加予定のコードリストを保持し、「併用禁忌を確認」ボタンで結果を表示。
- 応答には薬剤コード（srycd1/srycd2）と症状情報が含まれ、結果カードに症状概要と症状コードを明示。該当なしの場合は成功メッセージ、失敗時はエラーメッセージを表示。
- 既存コードリストはまだカルテ保存フローと連携していないため、フェーズ3後半でスタンプ挿入や Claim 制御に統合予定。

## 4. 自費カルテモード / CLAIM 制御
- `ChartsPage` に請求モードカードを追加。受付保険の選択と自費モード切替を 1 カードに集約し、`StatusBadge` で CLAIM 送信状態を可視化。
- `/pvt2/pvtList` の `healthInsurances[].beanBytes` を XML から復元するユーティリティ (`utils/health-insurance.ts`) を実装。`insuranceClass` や GUID を UI/保存両方で再利用できる形に整形。
- 保険 Bean の解析に警告ハンドラを追加し、未知のプロパティ構造を検出した場合でもフォールバック ID (`bean:{base64先頭}`) を生成して UI を破綻させないようにした。
- 自費モードでは `DocInfoModel.healthInsurance` に 950（非課税）/960（課税）コードを設定し、`sendClaim=false` とする。数量・実施者・ロット・備考を UI から記録し、`healthInsuranceDesc` にまとめて保存。
- 保険モードでは選択した保険コード/GUID を `docInfoModel` へ伝搬し、CLAIM 送信を維持。保険が取得できない受付では自動的に自費モードへ誘導し誤送信を抑止。
- `progress-note-payload.test.ts` に 095/096 系コードの生成と CLAIM 停止を検証するテストを追加。XML Bean デコードの単体テストも追加し、095/096 系コードのエッジケースを網羅。

## 5. 患者向け文書テンプレート
- 右カラムに `PatientDocumentsPanel` を追加し、生活指導文と紹介状の雛形を提供。ブラウザの印刷ダイアログから PDF 保存できるように HTML プレビューを生成。
- テンプレートは患者 ID/氏名/生年月日・施設名・担当医名を自動差し込み。任意の追記事項や備考を入力し、指導文や紹介状のドラフトを素早く作成できる。
- ポップアップブロックや未選択患者時は UI 上で明示的に警告し、既存ユーザーの操作フローを妨げない。
- 予防接種同意書テンプレートを追加し、プレビュー生成時にバックエンドへ渡せる `onPreviewGenerated` コールバックを公開。ポップアップが遮断された場合は HTML Blob のダウンロードに自動フォールバックし、案内メッセージで利用者を誘導する。

## 6. カルテオーダセット

- `ChartsPage` の補助ペインに `OrderSetPanel` を追加し、診察記録（SOAP テキスト）、Plan カード（処方・注射・指導料など）、患者向け文書テンプレートを一括で適用できるようにした。
- `useOrderSets` フックでブラウザローカルストレージ `opd.web.orderSets.v1` にユーザー定義セットを保存。初回利用時は高血圧再診・インフル予防接種のサンプルを自動登録する。
- 編集ダイアログでは種別（薬・注射・処置・検査・指導料・フォローアップ）毎にオーダ行を追加でき、カルテの Subjective/Objective/Assessment テキストと患者文書テンプレート（生活指導文・紹介状・予防接種同意書）を同時に下書き可能。
- 適用操作では `WorkSurface` の Plan カードへ必要な枚数を生成し、`PatientDocumentsPanel` に文書メモを差し込み、`ChartsPage` の SOAP フィールドへ追記する。診察ロックが解除されている場合のみ適用できるガードを設け、適用履歴はセットカードに最終日時として表示する。
- Plan カード種別に `injection`（注射）と `guidance`（指導料）を追加し、オーダセットや将来の Plan 操作からも分類できるようにした。
- 共有/配布フローとして「共有 / インポート」ダイアログを追加。施設名・担当者名を付与した JSON をダウンロード／コピーでき、受け取った JSON を統合（既存名の上書き + 新規追加）または全置換で取り込める。`order-set-sharing.ts` がバージョン付きパッケージの解析・重複解決を担う。

## 7. 既存ユーザーへの配慮
- お気に入りスタンプは従来通りブラウザ単位で保存し、既存利用者のデータを破壊しない。ブラウザを跨ぐ場合は再登録が必要である旨を運用ガイドに記載。
- Plan へのスタンプ挿入はテキスト追記のみで、既存の ProgressNote 保存ロジックに副作用を与えない。
- 自費モード導入に伴い、保険情報が欠落した受付では自動的に CLAIM 停止となる。既存ユーザーは従来通り保険モードで保存でき、送信条件が UI に明示されるため誤送信リスクが低減。
- 文書テンプレートはブラウザ機能で PDF 化する方式を採用し、追加プラグイン不要で Swing クライアント利用者の運用に合わせたダウンロード動線を確保した。

## 8. 今後の拡張メモ
- スタンプ挿入を DocumentModel 生成へ拡張し、診療行為・投薬スタンプの beanBytes を Plan に反映する。
- 傷病名検索の結果をカルテ病名登録フローへ連携し、スタンプや自費モードと一貫したオーダリング体験を実現する。
- 文書テンプレートの種類を段階的に増やし、サーバーサイド PDF 出力 API との連携を評価する。
