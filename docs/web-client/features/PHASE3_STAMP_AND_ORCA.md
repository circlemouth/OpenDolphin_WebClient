# フェーズ3 スタンプ・ORCA 連携メモ (更新: 2026-02-20)

フェーズ3 前半で追加したスタンプライブラリと ORCA マスター検索・併用禁忌チェック UI の仕様と実装メモです。Web クライアントのカルテ編集画面（`ChartsPage`）に統合され、診療中にスタンプを呼び出して Plan へ追記したり、診療行為コードを検索して禁忌判定を行うことができます。

## 1. スタンプライブラリ UI
- `/stamp/tree/{userPK}` 応答の `treeBytes` を Base64 デコードし、スタンプツリー XML からカテゴリ／スタンプを抽出するユーティリティ（`utils/stamp-tree.ts`）を追加。
- React Query を用いてログインユーザーのスタンプを取得し、`StampLibraryPanel` でカテゴリ毎に表示。検索（名称・メモ・フォルダ名・エンティティ）、お気に入りフィルタ、再読込をサポート。
- お気に入りはローカルストレージ `opd.web.stampFavorites.v1` に保存し、同一ブラウザで維持。既存ユーザーのデータは存在しないため移行は不要。
- 「挿入」操作時は診察ロック中に限り、Plan テキスト末尾へ `スタンプ名 (entity) [サブフォルダ]` を追記し、即座にフィードバックを表示。今後 DocumentModel へのスタンプ展開に差し替える前提の暫定実装。

## 2. ORCA マスター検索
- `/orca/tensu/name/{keyword,date,partial}`、`/orca/disease/name/{keyword,date,partial}`、`/orca/general/{code}` に対応する検索ミューテーションを追加。フェーズ2までの UI に干渉せず、右カラムに `OrcaOrderPanel` を配置。
- 診療行為検索は部分一致（既定）/前方一致の切り替えを提供し、ヒットした行為を「既存処方」「追加予定」リストへ振り分け可能。
- 傷病名検索は参照専用（現状は表示のみ）。一般名コード照会は単一結果を表示し、将来的に医薬品スタンプ生成へ展開できるようにする。

## 3. 併用禁忌チェック
- `/orca/interaction` へ PUT するラッパーを実装。UI では既存処方と追加予定のコードリストを保持し、「併用禁忌を確認」ボタンで結果を表示。
- 応答には薬剤コード（srycd1/srycd2）と症状情報が含まれ、結果カードに症状概要と症状コードを明示。該当なしの場合は成功メッセージ、失敗時はエラーメッセージを表示。
- 既存コードリストはまだカルテ保存フローと連携していないため、フェーズ3後半でスタンプ挿入や Claim 制御に統合予定。

## 4. 既存ユーザーへの配慮
- お気に入りはブラウザ単位で保存し、キー名を新設したため従来データの破壊は発生しない。ブラウザを跨ぐ場合は再登録が必要であることを運用ガイドに追記する。
- Plan への追記はテキストのみを追加し、既存の ProgressNote 保存ロジックには影響しない。保存前でも内容を自由に編集・削除可能。
- 自費モードや CLAIM 送信設定には未着手のため、既存利用者に対する請求フローの変更はこの段階では生じない。

## 5. 今後の拡張メモ
- スタンプ挿入を DocumentModel 生成へ拡張し、診療行為・投薬スタンプの beanBytes を Plan に反映する。
- ORCA 検索結果から保険/自費の選択、095/096 系コードの UI を実装し、CLAIM 送信判定へ接続する。
- 傷病名検索の結果をカルテ病名登録フローへ連携し、スタンプや自費モードと一貫したオーダリング体験を実現する。
