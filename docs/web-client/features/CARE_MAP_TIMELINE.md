# CareMap（治療履歴カレンダー）

Web クライアント版カルテ画面の補助パネルとして提供する CareMap カレンダーの仕様をまとめる。オンプレ版 `CareMapDocument` と同様に、
患者ごとの診療履歴（カルテ文書・予約・検査・画像メディア）を月単位で俯瞰し、日付別の詳細タイムラインへアクセスできるようにした。

## 1. 配置と対象ページ
- `web-client/src/features/charts/components/CareMapPanel.tsx`
- `ChartsPage` の `SupplementGrid` 内に追加。カルテ対象患者が選択されているときのみ表示される。
- 右ペインとは独立した補助エリアのため、カルテ編集ロックが自分にない場合でも閲覧可能。

## 2. データソース
| 区分 | 取得 API / ソース | 備考 |
|------|-------------------|------|
| 予約 | `/karte/appo/{karteId,from,to}` (`useAppointments`) | 表示月の開始〜終了までを対象。予約名・メモ・状態をイベントとして登録。 |
| カルテ文書 | `usePatientKarte` の `documents` | 確定日時 (`confirmDate`) を起点に「カルテ」イベントとして表示。科名・ステータスを概要に反映。 |
| 検査 | `/lab/module` (`useLaboModules`) | 最新 120 件を取得し、選択月に該当する検査モジュールを集計。異常件数と代表 3 項目をハイライト。 |
| 画像・添付 | `/karte/documents/{docIds}` (`useDocumentAttachments`) + `/karte/attachment/{attachmentId}` | DocInfo 経由で添付メタを取得し、必要時にバイナリを個別取得。画像は「画像」、PDF/その他は「添付」イベントとして扱う。 |

## 3. UI 構成
- **月次ナビゲーション**: 「前月」「翌月」ボタンで表示範囲を移動。ラベルは西暦＋月表示。
- **種別フィルタ**: 「カルテ」「予約」「検査」「画像」「添付」を個別に表示切替可能。全解除も許容。
- **カレンダーグリッド**: 日曜始まりで 6 週固定表示。イベントが存在する日は色付きドットと件数を表示。今日の日付は内側枠で強調。
- **日別タイムライン**: 選択日のイベントを時刻順にカード表示。種別バッジ／時刻／タイトル／概要／詳細を含む。
- **添付プレビュー**: 右ペインの『関連画像 / 検査』セクションと CareMap 詳細で添付の種別・ファイル名・サイズを表示し、画像はインライン表示、PDF/その他はダウンロード導線を提示する。
- **ローディング／エラー表示**: 各 API の取得状態をメッセージで示し、エラー発生時は再取得案内を表示。

## 4. イベント整形ロジック
- `buildCareMapEvents`（`features/charts/utils/care-map.ts`）で各ソースを正規化し `CareMapEvent` 配列へ統合。
- ラボ検査はモジュール内の異常件数と主要 3 項目（項目名＋値＋単位）を詳細欄に記載。
- 予約／カルテ文書は ID をメタ情報として保持し、将来的なドリルダウン操作に再利用できるようにした。
- 日付キーは `YYYY-MM-DD` に正規化し、カレンダー表示用に `groupCareMapEventsByDate` で集約。

## 5. 操作フローとユーザー影響
- 既存カルテ利用者は、右ペインのラボ結果ビューアと合わせて治療履歴を俯瞰できる。画像に加えて PDF やその他の添付ファイルも同一カレンダーで確認できるため、初回リリース時は「添付」フィルタとダウンロード導線の操作方法を周知する。
- 右ペインの「関連画像 / 検査」ギャラリーには直近 12 件の添付を表示し、ImageViewer オーバーレイからプレビューとダウンロードが可能。研修資料には、検査結果 PDF を開いてカルテへ引用する手順を追記する。
- データ取得は `/karte/appo` `/lab/module` に加えて `/karte/documents`・`/karte/attachment` を読み取り専用で利用する。追加の設定投入は不要だが、大容量添付を頻繁に扱う診療科ではネットワーク帯域を事前に確認する。
- 左レールのイベントタイムライン（`useTimelineEvents`）と連携し、カルテ／来院／検査／オーダの最新イベントから CareMap の日次ビューにドリルダウンできるよう統一したカテゴリとハイライトを維持する。

## 6. 既知の制約と今後の課題
- 添付バイナリは Base64 で受信するため、単一ファイルが 20 MB を超える場合はダウンロード待ち時間が発生する。将来的にストリーミング API やサムネイルキャッシュを検討する。
- `/karte/documents` は DocInfo 一覧に含まれる文書 ID のみを対象とするため、取得期間 (`fromDate`) の設定によっては古い添付が除外される。必要に応じて `usePatientKarte` の取得期間を延長する。
- `/lab/module` は最新順に最大 120 件しか取得しないため、長期的な履歴を俯瞰する場合は追加ページングを検討する。
- 予約イベントは表示月のみ取得している。年間俯瞰が必要な場合は範囲選択 UI や集計 API の追加を検討する。

## 7. テスト
- `features/charts/utils/__tests__/care-map.test.ts` でイベント統合・日付パース・グルーピングのユニットテストを実装。
- カルテ画面の統合テストには未着手。将来的に E2E テストでカレンダー操作と日別表示の検証を追加する。

## 8. 既存設定（image-browser.properties）の移行
- 旧クライアントの `image-browser.properties` から患者画像ベースディレクトリを確認し、サーバー側で同一パスもしくは共有ストレージへミラーリングする。
- `operations/CAREMAP_ATTACHMENT_MIGRATION.md` に従い、ミラーリングしたファイル群を `AttachmentModel` へ一括登録する。登録時は文書 ID とファイル名の対応表を出力し、監査ログを保存する。
- 移行後は Web クライアントの CareMap と右ペインで添付が表示されること、画像・PDF のダウンロードが成功することを運用テストで確認する。
