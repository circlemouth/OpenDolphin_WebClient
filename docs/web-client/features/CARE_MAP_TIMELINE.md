# CareMap（治療履歴カレンダー）

Web クライアント版カルテ画面の補助パネルとして提供する CareMap カレンダーの仕様をまとめる。オンプレ版 `CareMapDocument` と同様に、
患者ごとの診療履歴（カルテ文書・予約・検査・画像メディア）を月単位で俯瞰し、日付別の詳細タイムラインへアクセスできるようにした。

## 1. 配置と対象ページ
- `web-client/src/features/charts/components/CareMapPanel.tsx`
- `ChartsPage` の `SupplementGrid` 内に追加。カルテ対象患者が選択されているときのみ表示される。
- 右ペインとは独立した補助エリアのため、カルテ編集ロックが自分にない場合でも閲覧可能。

## 2. データソース
| 区分 | 取得 API / ソース | 備考 |
|------|-------------------|------|
| 予約 | `/karte/appo/{karteId,from,to}` (`useAppointments`) | 表示月の開始〜終了までを対象。予約名・メモ・状態をイベントとして登録。 |
| カルテ文書 | `usePatientKarte` の `documents` | 確定日時 (`confirmDate`) を起点に「カルテ」イベントとして表示。科名・ステータスを概要に反映。 |
| 検査 | `/lab/module` (`useLaboModules`) | 最新 120 件を取得し、選択月に該当する検査モジュールを集計。異常件数と代表 3 項目をハイライト。 |
| 画像 | `mediaItems`（カルテ過去サマリから生成） | 確認日時 (`capturedAt`) を起点に「画像」イベントとして表示。今後 PACS 連携を想定した差し替え可能な構造。 |

## 3. UI 構成
- **月次ナビゲーション**: 「前月」「翌月」ボタンで表示範囲を移動。ラベルは西暦＋月表示。
- **種別フィルタ**: 「カルテ」「予約」「検査」「画像」を個別に表示切替可能。全解除も許容。
- **カレンダーグリッド**: 日曜始まりで 6 週固定表示。イベントが存在する日は色付きドットと件数を表示。今日の日付は内側枠で強調。
- **日別タイムライン**: 選択日のイベントを時刻順にカード表示。種別バッジ／時刻／タイトル／概要／詳細を含む。
- **ローディング／エラー表示**: 各 API の取得状態をメッセージで示し、エラー発生時は再取得案内を表示。

## 4. イベント整形ロジック
- `buildCareMapEvents`（`features/charts/utils/care-map.ts`）で各ソースを正規化し `CareMapEvent` 配列へ統合。
- ラボ検査はモジュール内の異常件数と主要 3 項目（項目名＋値＋単位）を詳細欄に記載。
- 予約／カルテ文書は ID をメタ情報として保持し、将来的なドリルダウン操作に再利用できるようにした。
- 日付キーは `YYYY-MM-DD` に正規化し、カレンダー表示用に `groupCareMapEventsByDate` で集約。

## 5. 操作フローとユーザー影響
- 既存カルテ利用者は、右ペインのラボ結果ビューアと合わせて治療履歴の俯瞰が可能となる。操作体系はオンプレ版 CareMap に準拠し
  ているため追加研修は不要だが、初回リリース時に「フィルタで不要なイベントを絞り込める」旨を周知する。
- データ取得は既存 API のみを利用しており、新たな設定やマスタ移行は不要。カレンダー表示は読み取り専用のため、既存ワークフローに
  影響は与えない。

## 6. 既知の制約と今後の課題
- 画像イベントは現状カルテ過去サマリから生成したプレースホルダーを利用。正式な画像管理システムとの連携が整い次第、`mediaItems`
  の取得ロジックを差し替える。
- `/lab/module` は最新順に最大 120 件しか取得しないため、長期的な履歴を俯瞰する場合は追加ページングを検討する。
- 予約イベントは表示月のみ取得している。年間俯瞰が必要な場合は範囲選択 UI や集計 API の追加を検討する。

## 7. テスト
- `features/charts/utils/__tests__/care-map.test.ts` でイベント統合・日付パース・グルーピングのユニットテストを実装。
- カルテ画面の統合テストには未着手。将来的に E2E テストでカレンダー操作と日別表示の検証を追加する。
