# Lab 検査履歴ビューア（Web 版）

## 概要
- オンプレ版 `LaboTestPanel` の主要機能（検査モジュール一覧、項目閲覧、直近比較、グラフ表示、PDF 出力）を `LabResultsPanel` としてカルテ右側の補助エリアへ統合しました。
- `/lab/module/{patientId,first,max}` と `/lab/item/{patientId,first,max,itemCode}` を利用し、患者単位で最新 40 件の検査モジュールと選択項目の時系列データを取得します。
- 異常値（`abnormalFlg` が `H`/`L` 等）の強調表示、項目名・コード・結果値による検索、項目ごとの推移グラフを実装し、従来の Swing クライアントと同等の把握性を確保しました。

## UI/操作仕様
1. **モジュール一覧**
   - 採取日・件数を表示し、最新順に並び替えています（REST 取得後に ISO 時刻でソート）。
   - 選択したモジュールは強調表示され、初期状態では最初のモジュールを自動選択します。
2. **項目表**
   - 項目名、結果値、前回値、変化（数値差分 / 方向矢印）、単位、基準値、判定、コメント（`comment1/2` または `specimenName`）を表示します。
   - 直近のモジュールと 1 つ前のモジュールを突合し、差分を算出します。数値が取得できた場合は `↑/+` `↓/-` 表示で強調し、非数値は「同値」「更新」などの判定文を表示します。
- 検索欄で部分一致フィルタ（名称・コード・値・基準値）が可能です。
- 「推移」ボタンでトレンドダイアログが開き、SVG ラインチャートと履歴表が表示されます。グラフは `value` から数値を抽出できたデータのみ描画します。
3. **PDF 出力**
   - 「PDF 出力」ボタンで選択中モジュールを新規ウィンドウにレンダリングし、ブラウザの印刷ダイアログを起動します（院内 PDF 署名フローと互換）。出力内容は前回値と差分列も含むため、紙面でも直近比較が確認できます。
4. **アクセシビリティ**
   - ダイアログには `role="dialog" aria-modal` を付与し、キーボード操作のみで閉じられます。
   - 異常値は文字色で強調しつつ、表形式で併記しているためスクリーンリーダーでも読み上げ可能です。
5. **WorkSurface 参照パネルとの連携（2025-10-31）**
   - `ChartsPage` の WorkSurface に「参照パネルを表示」トグルを追加し、カルテ入力面の右側に最新検査結果のサマリをサイドバイサイド表示できるようにした。
   - 参照パネルでは検査モジュールを直近 4 件まで自動抽出し、各項目の値・単位・異常フラグを表示。行末の「Oに挿入」ボタンから Objective へ即時挿入できる。
   - 参照パネルのデータは `useLaboModules(patientId, 12)` を共有キャッシュで取得し、ラボ結果ビューアと同一 API を利用する。トグルを閉じると描画を停止し、不要な DOM を削減する。

## API と監査
- `fetchLaboModules` / `fetchLaboItemTrend` で `measureApiPerformance` をラップし、取得時間と件数を監査ログへ記録します。
- 異常系は React Query の `error` 状態経由で UI に表示し、再読み込みボタンで手動リトライ可能です。
- 取得済みデータは 60 秒間キャッシュし、同一患者での遷移時に無駄な再取得を抑制します。

## 運用・移行メモ
- 既存 Swing クライアントと同じ REST エンドポイントを利用するため、追加の DB マイグレーションは不要です。
- 画面遷移や印刷機能は標準ブラウザに依存するため、院内標準ブラウザ（Chromium 系）での動作確認をリリース前に実施してください。
- 検査センターコードやモジュールキーは API から返却された場合のみ表示されます。検査センター名が必要な場合は将来的に `facilityName` を追加取得する拡張を検討します。
